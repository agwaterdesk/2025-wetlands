var J3=Object.defineProperty;var Q3=(P,M,k)=>M in P?J3(P,M,{enumerable:!0,configurable:!0,writable:!0,value:k}):P[M]=k;var dn=(P,M,k)=>Q3(P,typeof M!="symbol"?M+"":M,k);(function(){const M=document.createElement("link").relList;if(M&&M.supports&&M.supports("modulepreload"))return;for(const $ of document.querySelectorAll('link[rel="modulepreload"]'))N($);new MutationObserver($=>{for(const Y of $)if(Y.type==="childList")for(const se of Y.addedNodes)se.tagName==="LINK"&&se.rel==="modulepreload"&&N(se)}).observe(document,{childList:!0,subtree:!0});function k($){const Y={};return $.integrity&&(Y.integrity=$.integrity),$.referrerPolicy&&(Y.referrerPolicy=$.referrerPolicy),$.crossOrigin==="use-credentials"?Y.credentials="include":$.crossOrigin==="anonymous"?Y.credentials="omit":Y.credentials="same-origin",Y}function N($){if($.ep)return;$.ep=!0;const Y=k($);fetch($.href,Y)}})();const pv=!1;var xy=Array.isArray,eT=Array.prototype.indexOf,vy=Array.from,tT=Object.defineProperty,$u=Object.getOwnPropertyDescriptor,Kv=Object.getOwnPropertyDescriptors,iT=Object.prototype,nT=Array.prototype,by=Object.getPrototypeOf;function rT(P){return P()}function Zg(P){for(var M=0;M<P.length;M++)P[M]()}const oo=2,Jv=4,gf=8,wy=16,Lo=32,Ku=64,fm=128,Ro=256,pm=512,Er=1024,_a=2048,Ac=4096,Po=8192,Ju=16384,sT=32768,Ty=65536,oT=1<<17,aT=1<<19,Qv=1<<20,bc=Symbol("$state"),lT=Symbol("legacy props"),cT=Symbol("");function eb(P){return P===this.v}function uT(P,M){return P!=P?M==M:P!==M||P!==null&&typeof P=="object"||typeof P=="function"}function Sy(P){return!uT(P,this.v)}function hT(P){throw new Error("https://svelte.dev/e/effect_in_teardown")}function dT(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function fT(P){throw new Error("https://svelte.dev/e/effect_orphan")}function pT(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function mT(P){throw new Error("https://svelte.dev/e/props_invalid_value")}function _T(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function gT(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function yT(){throw new Error("https://svelte.dev/e/state_unsafe_local_read")}function xT(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}let Qu=!1,vT=!1;function bT(){Qu=!0}const Ey=1,My=2,tb=4,wT=8,TT=16,ST=1,ET=2,MT=4,IT=8,AT=16,CT=1,PT=2,$r=Symbol();function zT(P){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}let En=null;function mv(P){En=P}function hl(P,M=!1,k){En={p:En,c:null,e:null,m:!1,s:P,x:null,l:null},Qu&&!M&&(En.l={s:null,u:null,r1:[],r2:Hr(!1)})}function dl(P){const M=En;if(M!==null){const se=M.e;if(se!==null){var k=en,N=xn;M.e=null;try{for(var $=0;$<se.length;$++){var Y=se[$];ks(Y.effect),Do(Y.reaction),Lm(Y.fn)}}finally{ks(k),Do(N)}}En=M.p,M.m=!0}return{}}function Hr(P,M){var k={f:0,v:P,reactions:null,equals:eb,rv:0,wv:0};return k}function am(P){return ib(Hr(P))}function Iy(P,M=!1){var N;const k=Hr(P);return M||(k.equals=Sy),Qu&&En!==null&&En.l!==null&&((N=En.l).s??(N.s=[])).push(k),k}function Zr(P,M=!1){return ib(Iy(P,M))}function ib(P){return xn!==null&&!fa&&xn.f&oo&&(zo===null?jT([P]):zo.push(P)),P}function Xi(P,M){return xn!==null&&!fa&&Fm()&&xn.f&(oo|wy)&&(zo===null||!zo.includes(P))&&xT(),Hg(P,M)}function Hg(P,M){return P.equals(M)||(P.v,P.v=M,P.wv=xb(),nb(P,_a),Fm()&&en!==null&&en.f&Er&&!(en.f&(Lo|Ku))&&(ha===null?GT([P]):ha.push(P))),M}function nb(P,M){var k=P.reactions;if(k!==null)for(var N=Fm(),$=k.length,Y=0;Y<$;Y++){var se=k[Y],s=se.f;s&_a||!N&&se===en||(Os(se,M),s&(Er|Ro)&&(s&oo?nb(se,Ac):Vm(se)))}}let rb=!1;function Cs(P,M=null,k){if(typeof P!="object"||P===null||bc in P)return P;const N=by(P);if(N!==iT&&N!==nT)return P;var $=new Map,Y=xy(P),se=Hr(0);Y&&$.set("length",Hr(P.length));var s;return new Proxy(P,{defineProperty(_e,ce,oe){(!("value"in oe)||oe.configurable===!1||oe.enumerable===!1||oe.writable===!1)&&_T();var Ie=$.get(ce);return Ie===void 0?(Ie=Hr(oe.value),$.set(ce,Ie)):Xi(Ie,Cs(oe.value,s)),!0},deleteProperty(_e,ce){var oe=$.get(ce);if(oe===void 0)ce in _e&&$.set(ce,Hr($r));else{if(Y&&typeof ce=="string"){var Ie=$.get("length"),Me=Number(ce);Number.isInteger(Me)&&Me<Ie.v&&Xi(Ie,Me)}Xi(oe,$r),_v(se)}return!0},get(_e,ce,oe){var Ve;if(ce===bc)return P;var Ie=$.get(ce),Me=ce in _e;if(Ie===void 0&&(!Me||(Ve=$u(_e,ce))!=null&&Ve.writable)&&(Ie=Hr(Cs(Me?_e[ce]:$r,s)),$.set(ce,Ie)),Ie!==void 0){var De=St(Ie);return De===$r?void 0:De}return Reflect.get(_e,ce,oe)},getOwnPropertyDescriptor(_e,ce){var oe=Reflect.getOwnPropertyDescriptor(_e,ce);if(oe&&"value"in oe){var Ie=$.get(ce);Ie&&(oe.value=St(Ie))}else if(oe===void 0){var Me=$.get(ce),De=Me==null?void 0:Me.v;if(Me!==void 0&&De!==$r)return{enumerable:!0,configurable:!0,value:De,writable:!0}}return oe},has(_e,ce){var De;if(ce===bc)return!0;var oe=$.get(ce),Ie=oe!==void 0&&oe.v!==$r||Reflect.has(_e,ce);if(oe!==void 0||en!==null&&(!Ie||(De=$u(_e,ce))!=null&&De.writable)){oe===void 0&&(oe=Hr(Ie?Cs(_e[ce],s):$r),$.set(ce,oe));var Me=St(oe);if(Me===$r)return!1}return Ie},set(_e,ce,oe,Ie){var At;var Me=$.get(ce),De=ce in _e;if(Y&&ce==="length")for(var Ve=oe;Ve<Me.v;Ve+=1){var We=$.get(Ve+"");We!==void 0?Xi(We,$r):Ve in _e&&(We=Hr($r),$.set(Ve+"",We))}Me===void 0?(!De||(At=$u(_e,ce))!=null&&At.writable)&&(Me=Hr(void 0),Xi(Me,Cs(oe,s)),$.set(ce,Me)):(De=Me.v!==$r,Xi(Me,Cs(oe,s)));var st=Reflect.getOwnPropertyDescriptor(_e,ce);if(st!=null&&st.set&&st.set.call(Ie,oe),!De){if(Y&&typeof ce=="string"){var ct=$.get("length"),gt=Number(ce);Number.isInteger(gt)&&gt>=ct.v&&Xi(ct,gt+1)}_v(se)}return!0},ownKeys(_e){St(se);var ce=Reflect.ownKeys(_e).filter(Me=>{var De=$.get(Me);return De===void 0||De.v!==$r});for(var[oe,Ie]of $)Ie.v!==$r&&!(oe in _e)&&ce.push(oe);return ce},setPrototypeOf(){gT()}})}function _v(P,M=1){Xi(P,P.v+M)}var gv,sb,ob;function RT(){if(gv===void 0){gv=window;var P=Element.prototype,M=Node.prototype;sb=$u(M,"firstChild").get,ob=$u(M,"nextSibling").get,P.__click=void 0,P.__className="",P.__attributes=null,P.__styles=null,P.__e=void 0,Text.prototype.__t=void 0}}function Ay(P=""){return document.createTextNode(P)}function wc(P){return sb.call(P)}function Dm(P){return ob.call(P)}function On(P,M){return wc(P)}function yc(P,M){{var k=wc(P);return k instanceof Comment&&k.data===""?Dm(k):k}}function ul(P,M=1,k=!1){let N=P;for(;M--;)N=Dm(N);return N}function DT(P){P.textContent=""}function Or(P){var M=oo|_a,k=xn!==null&&xn.f&oo?xn:null;return en===null||k!==null&&k.f&Ro?M|=Ro:en.f|=Qv,{ctx:En,deps:null,effects:null,equals:eb,f:M,fn:P,reactions:null,rv:0,v:null,wv:0,parent:k??en}}function ab(P){const M=Or(P);return M.equals=Sy,M}function Cy(P){var M=P.effects;if(M!==null){P.effects=null;for(var k=0;k<M.length;k+=1)pa(M[k])}}function LT(P){for(var M=P.parent;M!==null;){if(!(M.f&oo))return M;M=M.parent}return null}function lb(P){var M,k=en;ks(LT(P));try{Cy(P),M=bb(P)}finally{ks(k)}return M}function cb(P){var M=lb(P),k=(xc||P.f&Ro)&&P.deps!==null?Ac:Er;Os(P,k),P.equals(M)||(P.v=M,P.wv=xb())}function kT(P){Cy(P),hf(P,0),Os(P,Ju),P.v=P.deps=P.ctx=P.reactions=null}function ub(P){en===null&&xn===null&&fT(),xn!==null&&xn.f&Ro&&en===null&&dT(),zy&&hT()}function OT(P,M){var k=M.last;k===null?M.last=M.first=P:(k.next=P,P.prev=k,M.last=P)}function eh(P,M,k,N=!0){var $=(P&Ku)!==0,Y=en,se={ctx:En,deps:null,nodes_start:null,nodes_end:null,f:P|_a,first:null,fn:M,last:null,next:null,parent:$?null:Y,prev:null,teardown:null,transitions:null,wv:0};if(k){var s=Zu;try{yv(!0),Nm(se),se.f|=sT}catch(oe){throw pa(se),oe}finally{yv(s)}}else M!==null&&Vm(se);var _e=k&&se.deps===null&&se.first===null&&se.nodes_start===null&&se.teardown===null&&(se.f&(Qv|fm))===0;if(!_e&&!$&&N&&(Y!==null&&OT(se,Y),xn!==null&&xn.f&oo)){var ce=xn;(ce.effects??(ce.effects=[])).push(se)}return se}function FT(P){const M=eh(gf,null,!1);return Os(M,Er),M.teardown=P,M}function Wg(P){ub();var M=en!==null&&(en.f&Lo)!==0&&En!==null&&!En.m;if(M){var k=En;(k.e??(k.e=[])).push({fn:P,effect:en,reaction:xn})}else{var N=Lm(P);return N}}function BT(P){return ub(),km(P)}function NT(P){const M=eh(Ku,P,!0);return(k={})=>new Promise(N=>{k.outro?mm(M,()=>{pa(M),N(void 0)}):(pa(M),N(void 0))})}function Lm(P){return eh(Jv,P,!1)}function gc(P,M){var k=En,N={effect:null,ran:!1};k.l.r1.push(N),N.effect=km(()=>{P(),!N.ran&&(N.ran=!0,Xi(k.l.r2,!0),Tc(M))})}function hb(){var P=En;km(()=>{if(St(P.l.r2)){for(var M of P.l.r1){var k=M.effect;k.f&Er&&Os(k,Ac),th(k)&&Nm(k),M.ran=!1}P.l.r2.v=!1}})}function km(P){return eh(gf,P,!0)}function as(P,M=[],k=Or){const N=M.map(k);return Om(()=>P(...N.map(St)))}function Om(P,M=0){return eh(gf|wy|M,P,!0)}function Hu(P,M=!0){return eh(gf|Lo,P,!0,M)}function db(P){var M=P.teardown;if(M!==null){const k=zy,N=xn;xv(!0),Do(null);try{M.call(null)}finally{xv(k),Do(N)}}}function fb(P,M=!1){var k=P.first;for(P.first=P.last=null;k!==null;){var N=k.next;pa(k,M),k=N}}function VT(P){for(var M=P.first;M!==null;){var k=M.next;M.f&Lo||pa(M),M=k}}function pa(P,M=!0){var k=!1;if((M||P.f&aT)&&P.nodes_start!==null){for(var N=P.nodes_start,$=P.nodes_end;N!==null;){var Y=N===$?null:Dm(N);N.remove(),N=Y}k=!0}fb(P,M&&!k),hf(P,0),Os(P,Ju);var se=P.transitions;if(se!==null)for(const _e of se)_e.stop();db(P);var s=P.parent;s!==null&&s.first!==null&&pb(P),P.next=P.prev=P.teardown=P.ctx=P.deps=P.fn=P.nodes_start=P.nodes_end=null}function pb(P){var M=P.parent,k=P.prev,N=P.next;k!==null&&(k.next=N),N!==null&&(N.prev=k),M!==null&&(M.first===P&&(M.first=N),M.last===P&&(M.last=k))}function mm(P,M){var k=[];Py(P,k,!0),mb(k,()=>{pa(P),M&&M()})}function mb(P,M){var k=P.length;if(k>0){var N=()=>--k||M();for(var $ of P)$.out(N)}else M()}function Py(P,M,k){if(!(P.f&Po)){if(P.f^=Po,P.transitions!==null)for(const se of P.transitions)(se.is_global||k)&&M.push(se);for(var N=P.first;N!==null;){var $=N.next,Y=(N.f&Ty)!==0||(N.f&Lo)!==0;Py(N,M,Y?k:!1),N=$}}}function _m(P){_b(P,!0)}function _b(P,M){if(P.f&Po){P.f^=Po,P.f&Er||(P.f^=Er),th(P)&&(Os(P,_a),Vm(P));for(var k=P.first;k!==null;){var N=k.next,$=(k.f&Ty)!==0||(k.f&Lo)!==0;_b(k,$?M:!1),k=N}if(P.transitions!==null)for(const Y of P.transitions)(Y.is_global||M)&&Y.in()}}let Xg=!1,Yg=[];function UT(){Xg=!1;const P=Yg.slice();Yg=[],Zg(P)}function gb(P){Xg||(Xg=!0,queueMicrotask(UT)),Yg.push(P)}let lm=!1,gm=!1,ym=null,Zu=!1,zy=!1;function yv(P){Zu=P}function xv(P){zy=P}let Kg=[],lf=0;let xn=null,fa=!1;function Do(P){xn=P}let en=null;function ks(P){en=P}let zo=null;function jT(P){zo=P}let Wr=null,ss=0,ha=null;function GT(P){ha=P}let yb=1,xm=0,xc=!1;function xb(){return++yb}function Fm(){return!Qu||En!==null&&En.l===null}function th(P){var ce;var M=P.f;if(M&_a)return!0;if(M&Ac){var k=P.deps,N=(M&Ro)!==0;if(k!==null){var $,Y,se=(M&pm)!==0,s=N&&en!==null&&!xc,_e=k.length;if(se||s){for($=0;$<_e;$++)Y=k[$],(se||!((ce=Y==null?void 0:Y.reactions)!=null&&ce.includes(P)))&&(Y.reactions??(Y.reactions=[])).push(P);se&&(P.f^=pm)}for($=0;$<_e;$++)if(Y=k[$],th(Y)&&cb(Y),Y.wv>P.wv)return!0}(!N||en!==null&&!xc)&&Os(P,Er)}return!1}function qT(P,M){for(var k=M;k!==null;){if(k.f&fm)try{k.fn(P);return}catch{k.f^=fm}k=k.parent}throw lm=!1,P}function $T(P){return(P.f&Ju)===0&&(P.parent===null||(P.parent.f&fm)===0)}function Bm(P,M,k,N){if(lm){if(k===null&&(lm=!1),$T(M))throw P;return}k!==null&&(lm=!0);{qT(P,M);return}}function vb(P,M,k=0){var N=P.reactions;if(N!==null)for(var $=0;$<N.length;$++){var Y=N[$];Y.f&oo?vb(Y,M,k+1):M===Y&&(k===0?Os(Y,_a):Y.f&Er&&Os(Y,Ac),Vm(Y))}}function bb(P){var De;var M=Wr,k=ss,N=ha,$=xn,Y=xc,se=zo,s=En,_e=fa,ce=P.f;Wr=null,ss=0,ha=null,xn=ce&(Lo|Ku)?null:P,xc=(ce&Ro)!==0&&(!Zu||($===null||_e)&&P.parent!==null),zo=null,mv(P.ctx),fa=!1,xm++;try{var oe=(0,P.fn)(),Ie=P.deps;if(Wr!==null){var Me;if(hf(P,ss),Ie!==null&&ss>0)for(Ie.length=ss+Wr.length,Me=0;Me<Wr.length;Me++)Ie[ss+Me]=Wr[Me];else P.deps=Ie=Wr;if(!xc)for(Me=ss;Me<Ie.length;Me++)((De=Ie[Me]).reactions??(De.reactions=[])).push(P)}else Ie!==null&&ss<Ie.length&&(hf(P,ss),Ie.length=ss);if(Fm()&&ha!==null&&!(P.f&(oo|Ac|_a)))for(Me=0;Me<ha.length;Me++)vb(ha[Me],P);return $!==null&&xm++,oe}finally{Wr=M,ss=k,ha=N,xn=$,xc=Y,zo=se,mv(s),fa=_e}}function ZT(P,M){let k=M.reactions;if(k!==null){var N=eT.call(k,P);if(N!==-1){var $=k.length-1;$===0?k=M.reactions=null:(k[N]=k[$],k.pop())}}k===null&&M.f&oo&&(Wr===null||!Wr.includes(M))&&(Os(M,Ac),M.f&(Ro|pm)||(M.f^=pm),Cy(M),hf(M,0))}function hf(P,M){var k=P.deps;if(k!==null)for(var N=M;N<k.length;N++)ZT(P,k[N])}function Nm(P){var M=P.f;if(!(M&Ju)){Os(P,Er);var k=en,N=En;en=P;try{M&wy?VT(P):fb(P),db(P);var $=bb(P);P.teardown=typeof $=="function"?$:null,P.wv=yb;var Y=P.deps,se;pv&&vT&&P.f&_a}catch(s){Bm(s,P,k,N||P.ctx)}finally{en=k}}}function HT(){if(lf>1e3){lf=0;try{pT()}catch(P){if(ym!==null)Bm(P,ym,null);else throw P}}lf++}function WT(P){var M=P.length;if(M!==0){HT();var k=Zu;Zu=!0;try{for(var N=0;N<M;N++){var $=P[N];$.f&Er||($.f^=Er);var Y=[];wb($,Y),XT(Y)}}finally{Zu=k}}}function XT(P){var M=P.length;if(M!==0)for(var k=0;k<M;k++){var N=P[k];if(!(N.f&(Ju|Po)))try{th(N)&&(Nm(N),N.deps===null&&N.first===null&&N.nodes_start===null&&(N.teardown===null?pb(N):N.fn=null))}catch($){Bm($,N,null,N.ctx)}}}function YT(){if(gm=!1,lf>1001)return;const P=Kg;Kg=[],WT(P),gm||(lf=0,ym=null)}function Vm(P){gm||(gm=!0,queueMicrotask(YT)),ym=P;for(var M=P;M.parent!==null;){M=M.parent;var k=M.f;if(k&(Ku|Lo)){if(!(k&Er))return;M.f^=Er}}Kg.push(M)}function wb(P,M){var k=P.first,N=[];e:for(;k!==null;){var $=k.f,Y=($&Lo)!==0,se=Y&&($&Er)!==0,s=k.next;if(!se&&!($&Po))if($&gf){if(Y)k.f^=Er;else try{th(k)&&Nm(k)}catch(Ie){Bm(Ie,k,null,k.ctx)}var _e=k.first;if(_e!==null){k=_e;continue}}else $&Jv&&N.push(k);if(s===null){let Ie=k.parent;for(;Ie!==null;){if(P===Ie)break e;var ce=Ie.next;if(ce!==null){k=ce;continue e}Ie=Ie.parent}}k=s}for(var oe=0;oe<N.length;oe++)_e=N[oe],M.push(_e),wb(_e,M)}function St(P){var M=P.f,k=(M&oo)!==0;if(k&&M&Ju){var N=lb(P);return kT(P),N}if(xn!==null&&!fa){zo!==null&&zo.includes(P)&&yT();var $=xn.deps;P.rv<xm&&(P.rv=xm,Wr===null&&$!==null&&$[ss]===P?ss++:Wr===null?Wr=[P]:Wr.push(P))}else if(k&&P.deps===null&&P.effects===null){var Y=P,se=Y.parent;se!==null&&(se.f&Ro||(Y.f^=Ro))}return k&&(Y=P,th(Y)&&cb(Y)),P.v}function Tc(P){var M=fa;try{return fa=!0,P()}finally{fa=M}}const KT=-7169;function Os(P,M){P.f=P.f&KT|M}function ua(P){if(!(typeof P!="object"||!P||P instanceof EventTarget)){if(bc in P)Jg(P);else if(!Array.isArray(P))for(let M in P){const k=P[M];typeof k=="object"&&k&&bc in k&&Jg(k)}}}function Jg(P,M=new Set){if(typeof P=="object"&&P!==null&&!(P instanceof EventTarget)&&!M.has(P)){M.add(P),P instanceof Date&&P.getTime();for(let N in P)try{Jg(P[N],M)}catch{}const k=by(P);if(k!==Object.prototype&&k!==Array.prototype&&k!==Map.prototype&&k!==Set.prototype&&k!==Date.prototype){const N=Kv(k);for(let $ in N){const Y=N[$].get;if(Y)try{Y.call(P)}catch{}}}}}const JT=["touchstart","touchmove"];function QT(P){return JT.includes(P)}function e4(P,M,k,N=!0){N&&k();for(var $ of M)P.addEventListener($,k);FT(()=>{for(var Y of M)P.removeEventListener(Y,k)})}function t4(P){var M=xn,k=en;Do(null),ks(null);try{return P()}finally{Do(M),ks(k)}}const i4=new Set,vv=new Set;function Qp(P){var gt;var M=this,k=M.ownerDocument,N=P.type,$=((gt=P.composedPath)==null?void 0:gt.call(P))||[],Y=$[0]||P.target,se=0,s=P.__root;if(s){var _e=$.indexOf(s);if(_e!==-1&&(M===document||M===window)){P.__root=M;return}var ce=$.indexOf(M);if(ce===-1)return;_e<=ce&&(se=_e)}if(Y=$[se]||P.target,Y!==M){tT(P,"currentTarget",{configurable:!0,get(){return Y||k}});var oe=xn,Ie=en;Do(null),ks(null);try{for(var Me,De=[];Y!==null;){var Ve=Y.assignedSlot||Y.parentNode||Y.host||null;try{var We=Y["__"+N];if(We!==void 0&&!Y.disabled)if(xy(We)){var[st,...ct]=We;st.apply(Y,[P,...ct])}else We.call(Y,P)}catch(At){Me?De.push(At):Me=At}if(P.cancelBubble||Ve===M||Ve===null)break;Y=Ve}if(Me){for(let At of De)queueMicrotask(()=>{throw At});throw Me}}finally{P.__root=M,delete P.currentTarget,Do(oe),ks(Ie)}}}function Ry(P){var M=document.createElement("template");return M.innerHTML=P,M.content}function df(P,M){var k=en;k.nodes_start===null&&(k.nodes_start=P,k.nodes_end=M)}function ur(P,M){var k=(M&CT)!==0,N=(M&PT)!==0,$,Y=!P.startsWith("<!>");return()=>{$===void 0&&($=Ry(Y?P:"<!>"+P),k||($=wc($)));var se=N?document.importNode($,!0):$.cloneNode(!0);if(k){var s=wc(se),_e=se.lastChild;df(s,_e)}else df(se,se);return se}}function n4(P,M,k="svg"){var N=!P.startsWith("<!>"),$=`<${k}>${N?P:"<!>"+P}</${k}>`,Y;return()=>{if(!Y){var se=Ry($),s=wc(se);Y=wc(s)}var _e=Y.cloneNode(!0);return df(_e,_e),_e}}function vc(){var P=document.createDocumentFragment(),M=document.createComment(""),k=Ay();return P.append(M,k),df(M,k),P}function _n(P,M){P!==null&&P.before(M)}function vm(P,M){var k=M==null?"":typeof M=="object"?M+"":M;k!==(P.__t??(P.__t=P.nodeValue))&&(P.__t=k,P.nodeValue=k==null?"":k+"")}function Tb(P,M){return r4(P,M)}const ju=new Map;function r4(P,{target:M,anchor:k,props:N={},events:$,context:Y,intro:se=!0}){RT();var s=new Set,_e=Ie=>{for(var Me=0;Me<Ie.length;Me++){var De=Ie[Me];if(!s.has(De)){s.add(De);var Ve=QT(De);M.addEventListener(De,Qp,{passive:Ve});var We=ju.get(De);We===void 0?(document.addEventListener(De,Qp,{passive:Ve}),ju.set(De,1)):ju.set(De,We+1)}}};_e(vy(i4)),vv.add(_e);var ce=void 0,oe=NT(()=>{var Ie=k??M.appendChild(Ay());return Hu(()=>{if(Y){hl({});var Me=En;Me.c=Y}$&&(N.$$events=$),ce=P(Ie,N)||{},Y&&dl()}),()=>{var Ve;for(var Me of s){M.removeEventListener(Me,Qp);var De=ju.get(Me);--De===0?(document.removeEventListener(Me,Qp),ju.delete(Me)):ju.set(Me,De)}vv.delete(_e),Ie!==k&&((Ve=Ie.parentNode)==null||Ve.removeChild(Ie))}});return Qg.set(ce,oe),ce}let Qg=new WeakMap;function s4(P,M){const k=Qg.get(P);return k?(Qg.delete(P),k(M)):Promise.resolve()}function os(P,M,k=!1){var N=P,$=null,Y=null,se=$r,s=k?Ty:0,_e=!1;const ce=(Ie,Me=!0)=>{_e=!0,oe(Me,Ie)},oe=(Ie,Me)=>{se!==(se=Ie)&&(se?($?_m($):Me&&($=Hu(()=>Me(N))),Y&&mm(Y,()=>{Y=null})):(Y?_m(Y):Me&&(Y=Hu(()=>Me(N))),$&&mm($,()=>{$=null})))};Om(()=>{_e=!1,M(ce),_e||oe(null,null)},s)}function ff(P,M){return M}function o4(P,M,k,N){for(var $=[],Y=M.length,se=0;se<Y;se++)Py(M[se].e,$,!0);var s=Y>0&&$.length===0&&k!==null;if(s){var _e=k.parentNode;DT(_e),_e.append(k),N.clear(),cl(P,M[0].prev,M[Y-1].next)}mb($,()=>{for(var ce=0;ce<Y;ce++){var oe=M[ce];s||(N.delete(oe.k),cl(P,oe.prev,oe.next)),pa(oe.e,!s)}})}function pf(P,M,k,N,$,Y=null){var se=P,s={flags:M,items:new Map,first:null},_e=(M&tb)!==0;if(_e){var ce=P;se=ce.appendChild(Ay())}var oe=null,Ie=!1,Me=ab(()=>{var De=k();return xy(De)?De:De==null?[]:vy(De)});Om(()=>{var De=St(Me),Ve=De.length;if(!(Ie&&Ve===0)){Ie=Ve===0;{var We=xn;a4(De,s,se,$,M,(We.f&Po)!==0,N,k)}Y!==null&&(Ve===0?oe?_m(oe):oe=Hu(()=>Y(se)):oe!==null&&mm(oe,()=>{oe=null})),St(Me)}})}function a4(P,M,k,N,$,Y,se,s){var tt,ai,wi,Wi;var _e=($&wT)!==0,ce=($&(Ey|My))!==0,oe=P.length,Ie=M.items,Me=M.first,De=Me,Ve,We=null,st,ct=[],gt=[],At,ot,zt,Rt;if(_e)for(Rt=0;Rt<oe;Rt+=1)At=P[Rt],ot=se(At,Rt),zt=Ie.get(ot),zt!==void 0&&((tt=zt.a)==null||tt.measure(),(st??(st=new Set)).add(zt));for(Rt=0;Rt<oe;Rt+=1){if(At=P[Rt],ot=se(At,Rt),zt=Ie.get(ot),zt===void 0){var vt=De?De.e.nodes_start:k;We=c4(vt,M,We,We===null?M.first:We.next,At,ot,Rt,N,$,s),Ie.set(ot,We),ct=[],gt=[],De=We.next;continue}if(ce&&l4(zt,At,Rt,$),zt.e.f&Po&&(_m(zt.e),_e&&((ai=zt.a)==null||ai.unfix(),(st??(st=new Set)).delete(zt))),zt!==De){if(Ve!==void 0&&Ve.has(zt)){if(ct.length<gt.length){var Nt=gt[0],Jt;We=Nt.prev;var It=ct[0],xt=ct[ct.length-1];for(Jt=0;Jt<ct.length;Jt+=1)bv(ct[Jt],Nt,k);for(Jt=0;Jt<gt.length;Jt+=1)Ve.delete(gt[Jt]);cl(M,It.prev,xt.next),cl(M,We,It),cl(M,xt,Nt),De=Nt,We=xt,Rt-=1,ct=[],gt=[]}else Ve.delete(zt),bv(zt,De,k),cl(M,zt.prev,zt.next),cl(M,zt,We===null?M.first:We.next),cl(M,We,zt),We=zt;continue}for(ct=[],gt=[];De!==null&&De.k!==ot;)(Y||!(De.e.f&Po))&&(Ve??(Ve=new Set)).add(De),gt.push(De),De=De.next;if(De===null)continue;zt=De}ct.push(zt),We=zt,De=zt.next}if(De!==null||Ve!==void 0){for(var $i=Ve===void 0?[]:vy(Ve);De!==null;)(Y||!(De.e.f&Po))&&$i.push(De),De=De.next;var ki=$i.length;if(ki>0){var Oi=$&tb&&oe===0?k:null;if(_e){for(Rt=0;Rt<ki;Rt+=1)(wi=$i[Rt].a)==null||wi.measure();for(Rt=0;Rt<ki;Rt+=1)(Wi=$i[Rt].a)==null||Wi.fix()}o4(M,$i,Oi,Ie)}}_e&&gb(()=>{var Zt;if(st!==void 0)for(zt of st)(Zt=zt.a)==null||Zt.apply()}),en.first=M.first&&M.first.e,en.last=We&&We.e}function l4(P,M,k,N){N&Ey&&Hg(P.v,M),N&My?Hg(P.i,k):P.i=k}function c4(P,M,k,N,$,Y,se,s,_e,ce){var oe=(_e&Ey)!==0,Ie=(_e&TT)===0,Me=oe?Ie?Iy($):Hr($):$,De=_e&My?Hr(se):se,Ve={i:De,v:Me,k:Y,a:null,e:null,prev:k,next:N};try{return Ve.e=Hu(()=>s(P,Me,De,ce),rb),Ve.e.prev=k&&k.e,Ve.e.next=N&&N.e,k===null?M.first=Ve:(k.next=Ve,k.e.next=Ve.e),N!==null&&(N.prev=Ve,N.e.prev=Ve.e),Ve}finally{}}function bv(P,M,k){for(var N=P.next?P.next.e.nodes_start:k,$=M?M.e.nodes_start:k,Y=P.e.nodes_start;Y!==N;){var se=Dm(Y);$.before(Y),Y=se}}function cl(P,M,k){M===null?P.first=k:(M.next=k,M.e.next=k&&k.e),k!==null&&(k.prev=M,k.e.prev=M&&M.e)}function u4(P,M,k,N,$){var Y=P,se="",s;Om(()=>{se!==(se=M()??"")&&(s!==void 0&&(pa(s),s=void 0),se!==""&&(s=Hu(()=>{var _e=se+"",ce=Ry(_e);df(wc(ce),ce.lastChild),Y.before(ce)})))})}function ey(P,M,k,N,$){var s;var Y=(s=M.$$slots)==null?void 0:s[k],se=!1;Y===!0&&(Y=M[k==="default"?"children":k],se=!0),Y===void 0||Y(P,se?()=>N:N)}function Sb(P,M,k){Lm(()=>{var N=Tc(()=>M(P,k==null?void 0:k())||{});if(N!=null&&N.destroy)return()=>N.destroy()})}function Xn(P,M,k,N){var $=P.__attributes??(P.__attributes={});$[M]!==($[M]=k)&&(M==="style"&&"__styles"in P&&(P.__styles={}),M==="loading"&&(P[cT]=k),k==null?P.removeAttribute(M):typeof k!="string"&&Eb(P).includes(M)?P[M]=k:P.setAttribute(M,k))}function ef(P,M,k){var N=xn,$=en;Do(null),ks(null);try{(ty.has(P.nodeName)||!customElements||customElements.get(P.tagName.toLowerCase())?Eb(P).includes(M):k&&typeof k=="object")?P[M]=k:Xn(P,M,k==null?k:String(k))}finally{Do(N),ks($)}}var ty=new Map;function Eb(P){var M=ty.get(P.nodeName);if(M)return M;ty.set(P.nodeName,M=[]);for(var k,N=P,$=Element.prototype;$!==N;){k=Kv(N);for(var Y in k)k[Y].set&&M.push(Y);N=by(N)}return M}function Mb(P,M,k){var N=P.__className,$=h4(M);(N!==$||rb)&&(M==null?P.removeAttribute("class"):P.className=$,P.__className=$)}function h4(P,M){return(P??"")+""}function d4(P,M,k,N){var $=P.__styles??(P.__styles={});$[M]!==k&&($[M]=k,k==null?P.style.removeProperty(M):P.style.setProperty(M,k,""))}function wv(P,M){return P===M||(P==null?void 0:P[bc])===M}function cm(P={},M,k,N){return Lm(()=>{var $,Y;return km(()=>{$=Y,Y=[],Tc(()=>{P!==k(...Y)&&(M(P,...Y),$&&wv(k(...$),P)&&M(null,...$))})}),()=>{gb(()=>{Y&&wv(k(...Y),P)&&M(null,...Y)})}}),P}function Ib(P,M){e4(window,["resize"],()=>t4(()=>M(window[P])))}function Ab(P=!1){const M=En,k=M.l.u;if(!k)return;let N=()=>ua(M.s);if(P){let $=0,Y={};const se=Or(()=>{let s=!1;const _e=M.s;for(const ce in _e)_e[ce]!==Y[ce]&&(Y[ce]=_e[ce],s=!0);return s&&$++,$});N=()=>St(se)}k.b.length&&BT(()=>{Tv(M,N),Zg(k.b)}),Wg(()=>{const $=Tc(()=>k.m.map(rT));return()=>{for(const Y of $)typeof Y=="function"&&Y()}}),k.a.length&&Wg(()=>{Tv(M,N),Zg(k.a)})}function Tv(P,M){if(P.l.s)for(const k of P.l.s)St(k);M()}function f4(P){var M=Hr(0);return function(){return arguments.length===1?(Xi(M,St(M)+1),arguments[0]):(St(M),P())}}let em=!1;function p4(P){var M=em;try{return em=!1,[P(),em]}finally{em=M}}function Sv(P){for(var M=en,k=en;M!==null&&!(M.f&(Lo|Ku));)M=M.parent;try{return ks(M),P()}finally{ks(k)}}function yr(P,M,k,N){var vt;var $=(k&ST)!==0,Y=!Qu||(k&ET)!==0,se=(k&IT)!==0,s=(k&AT)!==0,_e=!1,ce;se?[ce,_e]=p4(()=>P[M]):ce=P[M];var oe=bc in P||lT in P,Ie=se&&(((vt=$u(P,M))==null?void 0:vt.set)??(oe&&M in P&&(Nt=>P[M]=Nt)))||void 0,Me=N,De=!0,Ve=!1,We=()=>(Ve=!0,De&&(De=!1,s?Me=Tc(N):Me=N),Me);ce===void 0&&N!==void 0&&(Ie&&Y&&mT(),ce=We(),Ie&&Ie(ce));var st;if(Y)st=()=>{var Nt=P[M];return Nt===void 0?We():(De=!0,Ve=!1,Nt)};else{var ct=Sv(()=>($?Or:ab)(()=>P[M]));ct.f|=oT,st=()=>{var Nt=St(ct);return Nt!==void 0&&(Me=void 0),Nt===void 0?Me:Nt}}if(!(k&MT))return st;if(Ie){var gt=P.$$legacy;return function(Nt,Jt){return arguments.length>0?((!Y||!Jt||gt||_e)&&Ie(Jt?st():Nt),Nt):st()}}var At=!1,ot=!1,zt=Iy(ce),Rt=Sv(()=>Or(()=>{var Nt=st(),Jt=St(zt);return At?(At=!1,ot=!0,Jt):(ot=!1,zt.v=Nt)}));return $||(Rt.equals=Sy),function(Nt,Jt){if(arguments.length>0){const It=Jt?St(Rt):Y&&se?Cs(Nt):Nt;return Rt.equals(It)||(At=!0,Xi(zt,It),Ve&&Me!==void 0&&(Me=It),Tc(()=>St(Rt))),Nt}return St(Rt)}}function Cb(P){En===null&&zT(),Qu&&En.l!==null?m4(En).m.push(P):Wg(()=>{const M=Tc(P);if(typeof M=="function")return M})}function m4(P){var M=P.l;return M.u??(M.u={a:[],b:[],m:[]})}const _4="5";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(_4);const g4={title:"TKTK",description:"TKTK"},y4=JSON.parse('[{"type":"text","value":"Before the American expansion west in the 19th century, the Mississippi River was a landscape of wetlands. Its northern tributaries coursed through prairie potholes and peatland bogs in the upper Midwest. Massive marshes and wet prairies sprawled from Ohio through Indiana, Illinois and Iowa. The confluence of the Ohio and Mississippi rivers marked the beginning of a swamp forest dominated by cypress, an estimated 25 million acres that spread out into Arkansas, Mississippi and Louisiana. The river split into a web of distributaries in Louisiana, creating a bayou and coastal marsh region of unparalleled biological productivity bordering the Gulf of Mexico.\\r\\n\\r\\n\\r\\nTwo centuries of alteration through logging, levee building, ditch digging, channelization and tile drains have converted many of those landscapes into the nation’s corn belt. By the time the value of wetlands had been recognized and some protections extended in the 20th century, states such as Iowa, Illinois, Missouri and Arkansas lost 80% or more of their wetlands. Flood control engineering of the lower Mississippi River has consumed Louisiana’s coast and threatens to take Cajun culture and the nation’s seafood supply with it. \\r\\n\\r\\n\\r\\nStarting in the early 1900s, duck hunters and nature lovers succeeded in changing attitudes about wetlands and promoted federal policies that have preserved and restored millions of acres in the basin. That’s crucial for the Mississippi Flyway, the nation’s largest migratory bird corridor. But a 2023 U.S. Supreme Court decision removed federal protection from a large number of the nation’s wetlands. That’s left their fate in the hands of the states, which have sharply varying policies. Some worry that a new era of wetland destruction awaits."},{"type":"scrolly","slides":[{"type":"text","text":"### Minnesota and Wisconsin\\r\\nSome of the largest areas of wetlands that have survived in the basin are peat bogs, mainly in Minnesota and Wisconsin. The drainage techniques that were so effective in the prairies did not succeed in the northernmost bogs, so farmers often forfeited those lands to the government. More recently, scientists have recognized their benefit in storing carbon and biodiversity. Minnesota alone has an estimated 6 million acres of peatlands.","component":{"id":"minnesota-bog","type":"image","src":"minnesota-bog.jpg","caption":"TKTK","credit":"TKTK","alt":"TKTK"},"controller":{"flyTo":"-98.206015,41.041815,-86.736288,49.464331"}},{"type":"text","text":"### Grand Kankakee Marsh, Indiana\\r\\nThe Grand Kankakee Marsh was so huge and productive that some called it the “Everglades of the North.” It covered a half million acres in northwest Indiana. Presidents and kings came to hunting lodges there and its bounty supplied Chicago restaurants. Then the Kankakee River was straightened and the state’s largest lake ditched. Today, there’s almost no trace amid the farm fields of the once famous wetland.\\r\\n\\r\\n\\r\\n<span data-inline-legend-id=kankakee-marsh>Approximate area of the former Kankakee Marsh</span>","component":{"type":"image","src":"grand-kankakee-historical.jpg","caption":"TKTK","credit":"TKTK","alt":"TKTK"},"controller":{"flyTo":"-88.221395,39.986492,-85.848348,42.391928","showLayer":"kankakee-marsh"}},{"type":"media","component":{"type":"image","src":"kankakee-bayou-1920.png","caption":"TKTK","credit":"TKTK","alt":"TKTK"},"controller":{"flyTo":"-88.221395,39.986492,-85.848348,42.391928","showLayer":"kankakee-marsh"}},{"type":"text","text":"### Prairie pothole region, northern Great Plains\\r\\nThe prairie pothole region that stretches from Iowa through Minnesota and the Dakotas into Canada has seen some of the most widespread conversion into farmland. In a part of north central Iowa once known as the “thousand-lake” region, Cairo Lake was drained in the early 20th century. Its outlines are still visible in what’s now a landscape of row crops.","component":{"type":"image","src":"cairo-lake.png","caption":"TKTK","credit":"TKTK","alt":"TKTK"},"controller":{"flyTo":"-93.72664076292155, 42.32091452022306, -93.6548181909316, 42.35999775250216"}},{"type":"text","text":"### The Grand Prairie\\r\\n\\r\\n\\r\\nAmerican migrants heading west found their wagons sinking into the muck of what we now call “wet prairies,” saturated grasslands that once covered millions of acres in the Midwest. One of those places, the Grand Prairie, covered most of 16 counties in eastern Illinois. A quarter of it was deemed too wet for farming. Its drainage created some of the most fertile farmland in America, but also contributed to Illinois losing at least 85% of its wetlands since the 18th century.\\r\\n\\r\\n\\r\\n<span data-inline-legend-id=grand-prairie-region>Extent of the Grand Prairie</span>","component":{"type":"image","src":"flightoftoadslobstermosquitosafterdrainage.jpg","caption":"TKTK","credit":"TKTK","alt":"TKTK"},"controller":{"flyTo":"grand-prairie-region","showLayer":"grand-prairie-region"}},{"type":"media","component":{"type":"image","src":"p16003coll4_1451_full.jpg","caption":"TKTK","credit":"TKTK","alt":"TKTK"},"controller":{"flyTo":"grand-prairie-region","showLayer":"grand-prairie-region"}},{"type":"text","text":"### Horicon Marsh, Wisconsin\\r\\nCovering 33,000 acres in Wisconsin farm country, Horicon Marsh is a remnant of the Ice Age and a landmark in the nation’s changing attitude about wetlands. The marsh was dammed and ditched for use in farming and milling, but in the 1920s became one of the first wetland restoration projects. The success of that project is evidenced by its importance for waterfowl and other wildlife and in the 1990s was recognized as a wetland of global significance.\\r\\n\\r\\n\\r\\n<span data-inline-legend-id=horicon-marsh>Extent of the Horicon Marsh</span>","component":{"type":"image","src":"horicon-duck-hunt.JPG","caption":"TKTK","credit":"TKTK","alt":"TKTK"},"controller":{"flyTo":"horicon-marsh","showLayer":"horicon-marsh"}},{"type":"media","layout":"wide","component":{"type":"array","images":[{"type":"image","src":"mjs-birders.JPG","caption":"TKTK","credit":"TKTK","alt":"TKTK"},{"type":"image","src":"horicon-goose-hunt.JPG","caption":"TKTK","credit":"TKTK","alt":"TKTK"}]},"controller":{"flyTo":"horicon-marsh","showLayer":"horicon-marsh"}},{"type":"text","text":"### Big Swamp, Missouri Bootheel\\r\\nBelow what’s now Cairo, Illinois, an immense forest of cypress and other bottomland trees spread out over 25 million acres. This wetland occupied the sweeping floodplain of the Mississippi River until 90 percent was wiped away by logging and the construction of levees and ditches. One part of that was Big Swamp in the Missouri Bootheel, now almost completely converted to farm fields by the Little River Drainage District.","component":{"type":"image","src":"missouri-bootheel-1857.jpg","caption":"TKTK","credit":"TKTK","alt":"TKTK"},"controller":{"flyTo":"-90.593262,35.913523,-89.252930,36.670622"}},{"type":"media","layout":"wide","component":{"type":"array","images":[{"type":"image","src":"ditch-digging-little-river-drainage-district-1930s.jpg","caption":"TKTK","credit":"TKTK","alt":"TKTK"},{"type":"image","src":"missouri-bootheel-man-with-stumps.jpg","caption":"TKTK","credit":"TKTK","alt":"TKTK"}]},"controller":{"flyTo":"-90.593262,35.913523,-89.252930,36.670622"}},{"type":"text","text":"### Singer Tract, Louisiana\\r\\n\\r\\n\\r\\nNo creature was more identified with the lower Mississippi River alluvial swamps than the ivory-billed woodpecker, a massive bird with an unmistakable head that depended on old-growth forests. By the 1930s, runaway logging had destroyed its habitat and the bird was only known to survive in one patch of woods, called the Singer Tract. The Chicago Mill and Lumber company proceeded to log that area. The last known sighting of the ivory-bill was there in 1944. It was declared extinct in 2022. The Singer Tract is now part of the Tensas River National Wildlife Refuge in northeast Louisiana..","component":{"type":"image","src":"ivory-bill-1950.jpg","caption":"TKTK","credit":"TKTK","alt":"TKTK"},"controller":{"flyTo":"-91.2893668832882, 32.40267474966649, -91.4394058890962, 32.30068874793997"}},{"type":"media","component":{"type":"image","src":"ivory-bill-specimen.jpg","caption":"TKTK","credit":"TKTK","alt":"TKTK"},"controller":{"flyTo":"-91.2893668832882, 32.40267474966649, -91.4394058890962, 32.30068874793997"}},{"type":"text","text":"### Atchafalaya River, Louisiana\\r\\n\\r\\n\\r\\nCovering more than a million acres of south Louisiana, the Atchafalaya River is the nation’s largest riverine swamp. It’s a distributary of the Mississippi River, protected by federal engineers as an outlet for Mississippi flooding, and its delta is one of the only areas of the state’s coast that’s growing. The Atchafalaya provides habitat for half of migratory waterfowl in the United States and is crucial to Louisiana’s seafood economy and Cajun culture.","component":{"type":"video","src":"atchafalaya-river.mp4","caption":"TKTK","credit":"TKTK","alt":"TKTK"},"controller":{"flyTo":"-92.063756,29.694749,-90.921178,30.768523"}},{"type":"text","text":"### Louisiana gulf coast\\r\\nThe wetlands of the Louisiana gulf coast are some of the world’s most productive, providing a bounty of oysters, shrimp and other seafood. Yet they are also the site of one of the world’s biggest environmental catastrophes. The cutoff of sediment from the Mississippi River, sea level rise and channels dug by oil companies have caused 2,000 square miles of the coast to wash away since the 1930s. Restore the Mississippi River Delta estimates the state loses the equivalent of a football field’s expanse of land every 100 minutes.","component":{"type":"image","src":"eroded-wetland-new-orleans.JPG","caption":"TKTK","credit":"TKTK","alt":"TKTK"},"controller":{"flyTo":"-94.982557,29.234161,-91.571302,30.366238"}},{"type":"media","layout":"wide","component":{"type":"array","images":[{"type":"image","src":"bayou-dupont-before.png","caption":"TKTK","credit":"TKTK","alt":"TKTK"},{"type":"image","src":"bayou-dupont-after.png","caption":"TKTK","credit":"TKTK","alt":"TKTK"}]},"controller":{"flyTo":"-94.982557,29.234161,-91.571302,30.366238"}}]}]'),x4={meta:g4,content:y4};var v4=ur('<div><div class="inner svelte-1jw4ppt"><!></div></div>');function Pb(P,M){let k=yr(M,"cls",3,"");var N=v4(),$=On(N),Y=On($);ey(Y,M,"default",{}),as(()=>Mb(N,`g-block ${k()??""} svelte-1jw4ppt`)),_n(P,N)}bT();const Mo=[];let bm;if(typeof window<"u"){const P=()=>Mo.forEach(M=>M());window.addEventListener("scroll",P),window.addEventListener("resize",P)}if(typeof IntersectionObserver<"u"){const P=new Map,M=new IntersectionObserver((k,N)=>{k.forEach($=>{const Y=P.get($.target),se=Mo.indexOf(Y);$.isIntersecting?se===-1&&Mo.push(Y):(Y(),se!==-1&&Mo.splice(se,1))})},{rootMargin:"400px 0px"});bm={add:({outer:k,update:N})=>{const{top:$,bottom:Y}=k.getBoundingClientRect();$<window.innerHeight&&Y>0&&Mo.push(N),P.set(k,N),M.observe(k)},remove:({outer:k,update:N})=>{const $=Mo.indexOf(N);$!==-1&&Mo.splice($,1),P.delete(k),M.unobserve(k)}}}else bm={add:({update:P})=>{Mo.push(P)},remove:({update:P})=>{const M=Mo.indexOf(P);M!==-1&&Mo.splice(M,1)}};var b4=ur("<svelte-scroller-outer><svelte-scroller-background-container><svelte-scroller-background><!></svelte-scroller-background></svelte-scroller-background-container> <svelte-scroller-foreground><!></svelte-scroller-foreground></svelte-scroller-outer>",2);function w4(P,M){hl(M,!1);const k=Zr(),N=Zr(),$=Zr(),Y=Zr(),se=Zr();let s=yr(M,"top",8,0),_e=yr(M,"bottom",8,1),ce=yr(M,"threshold",8,.5),oe=yr(M,"query",8,"section"),Ie=yr(M,"parallax",8,!1),Me=yr(M,"index",12,0),De=yr(M,"count",12,0),Ve=yr(M,"offset",12,0),We=yr(M,"progress",12,0),st=yr(M,"visible",12,!1),ct=Zr(),gt=Zr(),At=Zr(),ot,zt,Rt=Zr(0),vt=Zr(),Nt=Zr(0),Jt=Zr(1);Cb(()=>{zt=St(gt).querySelectorAll(oe()),De(zt.length),It();const wi={outer:St(ct),update:It};return bm.add(wi),()=>bm.remove(wi)});function It(){if(!St(gt))return;const wi=St(ct).getBoundingClientRect();ot=wi.left,Xi(Jt,wi.right-ot);const Wi=St(gt).getBoundingClientRect(),Zt=St(At).getBoundingClientRect();st(Wi.top<St(Rt)&&Wi.bottom>0);const Fn=Wi.bottom-Wi.top,Bn=Zt.bottom-Zt.top,Ln=St(N)-St(k);We((St(k)-Wi.top)/(Fn-Ln)),We()<=0?(Xi(Nt,0),Xi(vt,!1)):We()>=1?(Xi(Nt,Ie()?Fn-Bn:Fn-Ln),Xi(vt,!1)):(Xi(Nt,Ie()?Math.round(St(k)-We()*(Bn-Ln)):St(k)),Xi(vt,!0));for(let qt=0;qt<zt.length;qt++){const ls=zt[qt],{top:nr}=ls.getBoundingClientRect(),Bs=zt[qt+1],Ns=Bs?Bs.getBoundingClientRect().top:Wi.bottom;if(Ve((St($)-nr)/(Ns-nr)),Ns>=St($)){Me(qt);break}}}gc(()=>(ua(s()),St(Rt)),()=>{Xi(k,Math.round(s()*St(Rt)))}),gc(()=>(ua(_e()),St(Rt)),()=>{Xi(N,Math.round(_e()*St(Rt)))}),gc(()=>(ua(ce()),St(Rt)),()=>{Xi($,Math.round(ce()*St(Rt)))}),gc(()=>(ua(s()),ua(_e()),ua(ce()),ua(Ie())),()=>{s(),_e(),ce(),Ie(),It()}),gc(()=>(St(vt),St(Nt)),()=>{Xi(Y,`
		position: ${St(vt)?"fixed":"absolute"};
		top: 0;
		transform: translate(0, ${St(Nt)}px);
		z-index: 1;
	`)}),gc(()=>(St(vt),St(Jt)),()=>{Xi(se,St(vt)?`width:${St(Jt)}px;`:"")}),hb(),Ab();var xt=b4();ef(xt,"class","svelte-xdbafy");var $i=On(xt);ef($i,"class","background-container svelte-xdbafy"),as(()=>ef($i,"style",`${St(Y)??""}${St(se)??""}`));var ki=On($i);ef(ki,"class","svelte-xdbafy");var Oi=On(ki);ey(Oi,M,"background",{}),cm(ki,wi=>Xi(At,wi),()=>St(At));var tt=ul($i,2);ef(tt,"class","svelte-xdbafy");var ai=On(tt);ey(ai,M,"foreground",{}),cm(tt,wi=>Xi(gt,wi),()=>St(gt)),cm(xt,wi=>Xi(ct,wi),()=>St(ct)),Ib("innerHeight",wi=>Xi(Rt,wi)),_n(P,xt),dl()}function T4(P){return P&&P.__esModule&&Object.prototype.hasOwnProperty.call(P,"default")?P.default:P}var um={exports:{}},S4=um.exports,Ev;function E4(){return Ev||(Ev=1,function(P,M){(function(k,N){P.exports=N()})(S4,function(){var k,N,$;function Y(s,_e){if(!k)k=_e;else if(!N)N=_e;else{var ce="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+k+")(sharedChunk); ("+N+")(sharedChunk); self.onerror = null;",oe={};k(oe),$=_e(oe),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&($.workerUrl=window.URL.createObjectURL(new Blob([ce],{type:"text/javascript"})))}}Y(["exports"],function(s){function _e(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var ce,oe={},Ie={};function Me(){if(ce)return Ie;ce=1,Object.defineProperty(Ie,"__esModule",{value:!0}),Ie.setMatrixArrayType=function(u){Ie.ARRAY_TYPE=e=u},Ie.toRadian=function(u){return u*o},Ie.equals=function(u,a){return Math.abs(u-a)<=r*Math.max(1,Math.abs(u),Math.abs(a))},Ie.RANDOM=Ie.ARRAY_TYPE=Ie.EPSILON=void 0;var r=1e-6;Ie.EPSILON=r;var e=typeof Float32Array<"u"?Float32Array:Array;Ie.ARRAY_TYPE=e;var i=Math.random;Ie.RANDOM=i;var o=Math.PI/180;return Math.hypot||(Math.hypot=function(){for(var u=0,a=arguments.length;a--;)u+=arguments[a]*arguments[a];return Math.sqrt(u)}),Ie}var De,Ve={};function We(){if(De)return Ve;function r(a){return r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(h){return typeof h}:function(h){return h&&typeof Symbol=="function"&&h.constructor===Symbol&&h!==Symbol.prototype?"symbol":typeof h},r(a)}De=1,Object.defineProperty(Ve,"__esModule",{value:!0}),Ve.create=function(){var a=new e.ARRAY_TYPE(4);return e.ARRAY_TYPE!=Float32Array&&(a[1]=0,a[2]=0),a[0]=1,a[3]=1,a},Ve.clone=function(a){var h=new e.ARRAY_TYPE(4);return h[0]=a[0],h[1]=a[1],h[2]=a[2],h[3]=a[3],h},Ve.copy=function(a,h){return a[0]=h[0],a[1]=h[1],a[2]=h[2],a[3]=h[3],a},Ve.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a},Ve.fromValues=function(a,h,m,y){var T=new e.ARRAY_TYPE(4);return T[0]=a,T[1]=h,T[2]=m,T[3]=y,T},Ve.set=function(a,h,m,y,T){return a[0]=h,a[1]=m,a[2]=y,a[3]=T,a},Ve.transpose=function(a,h){if(a===h){var m=h[1];a[1]=h[2],a[2]=m}else a[0]=h[0],a[1]=h[2],a[2]=h[1],a[3]=h[3];return a},Ve.invert=function(a,h){var m=h[0],y=h[1],T=h[2],f=h[3],x=m*f-T*y;return x?(a[0]=f*(x=1/x),a[1]=-y*x,a[2]=-T*x,a[3]=m*x,a):null},Ve.adjoint=function(a,h){var m=h[0];return a[0]=h[3],a[1]=-h[1],a[2]=-h[2],a[3]=m,a},Ve.determinant=function(a){return a[0]*a[3]-a[2]*a[1]},Ve.multiply=o,Ve.rotate=function(a,h,m){var y=h[0],T=h[1],f=h[2],x=h[3],w=Math.sin(m),g=Math.cos(m);return a[0]=y*g+f*w,a[1]=T*g+x*w,a[2]=y*-w+f*g,a[3]=T*-w+x*g,a},Ve.scale=function(a,h,m){var y=h[1],T=h[2],f=h[3],x=m[0],w=m[1];return a[0]=h[0]*x,a[1]=y*x,a[2]=T*w,a[3]=f*w,a},Ve.fromRotation=function(a,h){var m=Math.sin(h),y=Math.cos(h);return a[0]=y,a[1]=m,a[2]=-m,a[3]=y,a},Ve.fromScaling=function(a,h){return a[0]=h[0],a[1]=0,a[2]=0,a[3]=h[1],a},Ve.str=function(a){return"mat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},Ve.frob=function(a){return Math.hypot(a[0],a[1],a[2],a[3])},Ve.LDU=function(a,h,m,y){return a[2]=y[2]/y[0],m[0]=y[0],m[1]=y[1],m[3]=y[3]-a[2]*m[1],[a,h,m]},Ve.add=function(a,h,m){return a[0]=h[0]+m[0],a[1]=h[1]+m[1],a[2]=h[2]+m[2],a[3]=h[3]+m[3],a},Ve.subtract=u,Ve.exactEquals=function(a,h){return a[0]===h[0]&&a[1]===h[1]&&a[2]===h[2]&&a[3]===h[3]},Ve.equals=function(a,h){var m=a[0],y=a[1],T=a[2],f=a[3],x=h[0],w=h[1],g=h[2],v=h[3];return Math.abs(m-x)<=e.EPSILON*Math.max(1,Math.abs(m),Math.abs(x))&&Math.abs(y-w)<=e.EPSILON*Math.max(1,Math.abs(y),Math.abs(w))&&Math.abs(T-g)<=e.EPSILON*Math.max(1,Math.abs(T),Math.abs(g))&&Math.abs(f-v)<=e.EPSILON*Math.max(1,Math.abs(f),Math.abs(v))},Ve.multiplyScalar=function(a,h,m){return a[0]=h[0]*m,a[1]=h[1]*m,a[2]=h[2]*m,a[3]=h[3]*m,a},Ve.multiplyScalarAndAdd=function(a,h,m,y){return a[0]=h[0]+m[0]*y,a[1]=h[1]+m[1]*y,a[2]=h[2]+m[2]*y,a[3]=h[3]+m[3]*y,a},Ve.sub=Ve.mul=void 0;var e=function(a,h){if(a&&a.__esModule)return a;if(a===null||r(a)!=="object"&&typeof a!="function")return{default:a};var m=i(void 0);if(m&&m.has(a))return m.get(a);var y={},T=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var f in a)if(f!=="default"&&Object.prototype.hasOwnProperty.call(a,f)){var x=T?Object.getOwnPropertyDescriptor(a,f):null;x&&(x.get||x.set)?Object.defineProperty(y,f,x):y[f]=a[f]}return y.default=a,m&&m.set(a,y),y}(Me());function i(a){if(typeof WeakMap!="function")return null;var h=new WeakMap,m=new WeakMap;return(i=function(y){return y?m:h})(a)}function o(a,h,m){var y=h[0],T=h[1],f=h[2],x=h[3],w=m[0],g=m[1],v=m[2],S=m[3];return a[0]=y*w+f*g,a[1]=T*w+x*g,a[2]=y*v+f*S,a[3]=T*v+x*S,a}function u(a,h,m){return a[0]=h[0]-m[0],a[1]=h[1]-m[1],a[2]=h[2]-m[2],a[3]=h[3]-m[3],a}return Ve.mul=o,Ve.sub=u,Ve}var st,ct={};function gt(){if(st)return ct;function r(a){return r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(h){return typeof h}:function(h){return h&&typeof Symbol=="function"&&h.constructor===Symbol&&h!==Symbol.prototype?"symbol":typeof h},r(a)}st=1,Object.defineProperty(ct,"__esModule",{value:!0}),ct.create=function(){var a=new e.ARRAY_TYPE(6);return e.ARRAY_TYPE!=Float32Array&&(a[1]=0,a[2]=0,a[4]=0,a[5]=0),a[0]=1,a[3]=1,a},ct.clone=function(a){var h=new e.ARRAY_TYPE(6);return h[0]=a[0],h[1]=a[1],h[2]=a[2],h[3]=a[3],h[4]=a[4],h[5]=a[5],h},ct.copy=function(a,h){return a[0]=h[0],a[1]=h[1],a[2]=h[2],a[3]=h[3],a[4]=h[4],a[5]=h[5],a},ct.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=0,a[5]=0,a},ct.fromValues=function(a,h,m,y,T,f){var x=new e.ARRAY_TYPE(6);return x[0]=a,x[1]=h,x[2]=m,x[3]=y,x[4]=T,x[5]=f,x},ct.set=function(a,h,m,y,T,f,x){return a[0]=h,a[1]=m,a[2]=y,a[3]=T,a[4]=f,a[5]=x,a},ct.invert=function(a,h){var m=h[0],y=h[1],T=h[2],f=h[3],x=h[4],w=h[5],g=m*f-y*T;return g?(a[0]=f*(g=1/g),a[1]=-y*g,a[2]=-T*g,a[3]=m*g,a[4]=(T*w-f*x)*g,a[5]=(y*x-m*w)*g,a):null},ct.determinant=function(a){return a[0]*a[3]-a[1]*a[2]},ct.multiply=o,ct.rotate=function(a,h,m){var y=h[0],T=h[1],f=h[2],x=h[3],w=h[4],g=h[5],v=Math.sin(m),S=Math.cos(m);return a[0]=y*S+f*v,a[1]=T*S+x*v,a[2]=y*-v+f*S,a[3]=T*-v+x*S,a[4]=w,a[5]=g,a},ct.scale=function(a,h,m){var y=h[1],T=h[2],f=h[3],x=h[4],w=h[5],g=m[0],v=m[1];return a[0]=h[0]*g,a[1]=y*g,a[2]=T*v,a[3]=f*v,a[4]=x,a[5]=w,a},ct.translate=function(a,h,m){var y=h[0],T=h[1],f=h[2],x=h[3],w=h[4],g=h[5],v=m[0],S=m[1];return a[0]=y,a[1]=T,a[2]=f,a[3]=x,a[4]=y*v+f*S+w,a[5]=T*v+x*S+g,a},ct.fromRotation=function(a,h){var m=Math.sin(h),y=Math.cos(h);return a[0]=y,a[1]=m,a[2]=-m,a[3]=y,a[4]=0,a[5]=0,a},ct.fromScaling=function(a,h){return a[0]=h[0],a[1]=0,a[2]=0,a[3]=h[1],a[4]=0,a[5]=0,a},ct.fromTranslation=function(a,h){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=h[0],a[5]=h[1],a},ct.str=function(a){return"mat2d("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+")"},ct.frob=function(a){return Math.hypot(a[0],a[1],a[2],a[3],a[4],a[5],1)},ct.add=function(a,h,m){return a[0]=h[0]+m[0],a[1]=h[1]+m[1],a[2]=h[2]+m[2],a[3]=h[3]+m[3],a[4]=h[4]+m[4],a[5]=h[5]+m[5],a},ct.subtract=u,ct.multiplyScalar=function(a,h,m){return a[0]=h[0]*m,a[1]=h[1]*m,a[2]=h[2]*m,a[3]=h[3]*m,a[4]=h[4]*m,a[5]=h[5]*m,a},ct.multiplyScalarAndAdd=function(a,h,m,y){return a[0]=h[0]+m[0]*y,a[1]=h[1]+m[1]*y,a[2]=h[2]+m[2]*y,a[3]=h[3]+m[3]*y,a[4]=h[4]+m[4]*y,a[5]=h[5]+m[5]*y,a},ct.exactEquals=function(a,h){return a[0]===h[0]&&a[1]===h[1]&&a[2]===h[2]&&a[3]===h[3]&&a[4]===h[4]&&a[5]===h[5]},ct.equals=function(a,h){var m=a[0],y=a[1],T=a[2],f=a[3],x=a[4],w=a[5],g=h[0],v=h[1],S=h[2],C=h[3],z=h[4],O=h[5];return Math.abs(m-g)<=e.EPSILON*Math.max(1,Math.abs(m),Math.abs(g))&&Math.abs(y-v)<=e.EPSILON*Math.max(1,Math.abs(y),Math.abs(v))&&Math.abs(T-S)<=e.EPSILON*Math.max(1,Math.abs(T),Math.abs(S))&&Math.abs(f-C)<=e.EPSILON*Math.max(1,Math.abs(f),Math.abs(C))&&Math.abs(x-z)<=e.EPSILON*Math.max(1,Math.abs(x),Math.abs(z))&&Math.abs(w-O)<=e.EPSILON*Math.max(1,Math.abs(w),Math.abs(O))},ct.sub=ct.mul=void 0;var e=function(a,h){if(a&&a.__esModule)return a;if(a===null||r(a)!=="object"&&typeof a!="function")return{default:a};var m=i(void 0);if(m&&m.has(a))return m.get(a);var y={},T=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var f in a)if(f!=="default"&&Object.prototype.hasOwnProperty.call(a,f)){var x=T?Object.getOwnPropertyDescriptor(a,f):null;x&&(x.get||x.set)?Object.defineProperty(y,f,x):y[f]=a[f]}return y.default=a,m&&m.set(a,y),y}(Me());function i(a){if(typeof WeakMap!="function")return null;var h=new WeakMap,m=new WeakMap;return(i=function(y){return y?m:h})(a)}function o(a,h,m){var y=h[0],T=h[1],f=h[2],x=h[3],w=h[4],g=h[5],v=m[0],S=m[1],C=m[2],z=m[3],O=m[4],B=m[5];return a[0]=y*v+f*S,a[1]=T*v+x*S,a[2]=y*C+f*z,a[3]=T*C+x*z,a[4]=y*O+f*B+w,a[5]=T*O+x*B+g,a}function u(a,h,m){return a[0]=h[0]-m[0],a[1]=h[1]-m[1],a[2]=h[2]-m[2],a[3]=h[3]-m[3],a[4]=h[4]-m[4],a[5]=h[5]-m[5],a}return ct.mul=o,ct.sub=u,ct}var At,ot={};function zt(){if(At)return ot;function r(a){return r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(h){return typeof h}:function(h){return h&&typeof Symbol=="function"&&h.constructor===Symbol&&h!==Symbol.prototype?"symbol":typeof h},r(a)}At=1,Object.defineProperty(ot,"__esModule",{value:!0}),ot.create=function(){var a=new e.ARRAY_TYPE(9);return e.ARRAY_TYPE!=Float32Array&&(a[1]=0,a[2]=0,a[3]=0,a[5]=0,a[6]=0,a[7]=0),a[0]=1,a[4]=1,a[8]=1,a},ot.fromMat4=function(a,h){return a[0]=h[0],a[1]=h[1],a[2]=h[2],a[3]=h[4],a[4]=h[5],a[5]=h[6],a[6]=h[8],a[7]=h[9],a[8]=h[10],a},ot.clone=function(a){var h=new e.ARRAY_TYPE(9);return h[0]=a[0],h[1]=a[1],h[2]=a[2],h[3]=a[3],h[4]=a[4],h[5]=a[5],h[6]=a[6],h[7]=a[7],h[8]=a[8],h},ot.copy=function(a,h){return a[0]=h[0],a[1]=h[1],a[2]=h[2],a[3]=h[3],a[4]=h[4],a[5]=h[5],a[6]=h[6],a[7]=h[7],a[8]=h[8],a},ot.fromValues=function(a,h,m,y,T,f,x,w,g){var v=new e.ARRAY_TYPE(9);return v[0]=a,v[1]=h,v[2]=m,v[3]=y,v[4]=T,v[5]=f,v[6]=x,v[7]=w,v[8]=g,v},ot.set=function(a,h,m,y,T,f,x,w,g,v){return a[0]=h,a[1]=m,a[2]=y,a[3]=T,a[4]=f,a[5]=x,a[6]=w,a[7]=g,a[8]=v,a},ot.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},ot.transpose=function(a,h){if(a===h){var m=h[1],y=h[2],T=h[5];a[1]=h[3],a[2]=h[6],a[3]=m,a[5]=h[7],a[6]=y,a[7]=T}else a[0]=h[0],a[1]=h[3],a[2]=h[6],a[3]=h[1],a[4]=h[4],a[5]=h[7],a[6]=h[2],a[7]=h[5],a[8]=h[8];return a},ot.invert=function(a,h){var m=h[0],y=h[1],T=h[2],f=h[3],x=h[4],w=h[5],g=h[6],v=h[7],S=h[8],C=S*x-w*v,z=-S*f+w*g,O=v*f-x*g,B=m*C+y*z+T*O;return B?(a[0]=C*(B=1/B),a[1]=(-S*y+T*v)*B,a[2]=(w*y-T*x)*B,a[3]=z*B,a[4]=(S*m-T*g)*B,a[5]=(-w*m+T*f)*B,a[6]=O*B,a[7]=(-v*m+y*g)*B,a[8]=(x*m-y*f)*B,a):null},ot.adjoint=function(a,h){var m=h[0],y=h[1],T=h[2],f=h[3],x=h[4],w=h[5],g=h[6],v=h[7],S=h[8];return a[0]=x*S-w*v,a[1]=T*v-y*S,a[2]=y*w-T*x,a[3]=w*g-f*S,a[4]=m*S-T*g,a[5]=T*f-m*w,a[6]=f*v-x*g,a[7]=y*g-m*v,a[8]=m*x-y*f,a},ot.determinant=function(a){var h=a[3],m=a[4],y=a[5],T=a[6],f=a[7],x=a[8];return a[0]*(x*m-y*f)+a[1]*(-x*h+y*T)+a[2]*(f*h-m*T)},ot.multiply=o,ot.translate=function(a,h,m){var y=h[0],T=h[1],f=h[2],x=h[3],w=h[4],g=h[5],v=h[6],S=h[7],C=h[8],z=m[0],O=m[1];return a[0]=y,a[1]=T,a[2]=f,a[3]=x,a[4]=w,a[5]=g,a[6]=z*y+O*x+v,a[7]=z*T+O*w+S,a[8]=z*f+O*g+C,a},ot.rotate=function(a,h,m){var y=h[0],T=h[1],f=h[2],x=h[3],w=h[4],g=h[5],v=h[6],S=h[7],C=h[8],z=Math.sin(m),O=Math.cos(m);return a[0]=O*y+z*x,a[1]=O*T+z*w,a[2]=O*f+z*g,a[3]=O*x-z*y,a[4]=O*w-z*T,a[5]=O*g-z*f,a[6]=v,a[7]=S,a[8]=C,a},ot.scale=function(a,h,m){var y=m[0],T=m[1];return a[0]=y*h[0],a[1]=y*h[1],a[2]=y*h[2],a[3]=T*h[3],a[4]=T*h[4],a[5]=T*h[5],a[6]=h[6],a[7]=h[7],a[8]=h[8],a},ot.fromTranslation=function(a,h){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=h[0],a[7]=h[1],a[8]=1,a},ot.fromRotation=function(a,h){var m=Math.sin(h),y=Math.cos(h);return a[0]=y,a[1]=m,a[2]=0,a[3]=-m,a[4]=y,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},ot.fromScaling=function(a,h){return a[0]=h[0],a[1]=0,a[2]=0,a[3]=0,a[4]=h[1],a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},ot.fromMat2d=function(a,h){return a[0]=h[0],a[1]=h[1],a[2]=0,a[3]=h[2],a[4]=h[3],a[5]=0,a[6]=h[4],a[7]=h[5],a[8]=1,a},ot.fromQuat=function(a,h){var m=h[0],y=h[1],T=h[2],f=h[3],x=m+m,w=y+y,g=T+T,v=m*x,S=y*x,C=y*w,z=T*x,O=T*w,B=T*g,L=f*x,V=f*w,j=f*g;return a[0]=1-C-B,a[3]=S-j,a[6]=z+V,a[1]=S+j,a[4]=1-v-B,a[7]=O-L,a[2]=z-V,a[5]=O+L,a[8]=1-v-C,a},ot.normalFromMat4=function(a,h){var m=h[0],y=h[1],T=h[2],f=h[3],x=h[4],w=h[5],g=h[6],v=h[7],S=h[8],C=h[9],z=h[10],O=h[11],B=h[12],L=h[13],V=h[14],j=h[15],W=m*w-y*x,te=m*g-T*x,ee=m*v-f*x,Q=y*g-T*w,pe=y*v-f*w,ie=T*v-f*g,me=S*L-C*B,xe=S*V-z*B,ye=S*j-O*B,we=C*V-z*L,Ae=C*j-O*L,Re=z*j-O*V,Ee=W*Re-te*Ae+ee*we+Q*ye-pe*xe+ie*me;return Ee?(a[0]=(w*Re-g*Ae+v*we)*(Ee=1/Ee),a[1]=(g*ye-x*Re-v*xe)*Ee,a[2]=(x*Ae-w*ye+v*me)*Ee,a[3]=(T*Ae-y*Re-f*we)*Ee,a[4]=(m*Re-T*ye+f*xe)*Ee,a[5]=(y*ye-m*Ae-f*me)*Ee,a[6]=(L*ie-V*pe+j*Q)*Ee,a[7]=(V*ee-B*ie-j*te)*Ee,a[8]=(B*pe-L*ee+j*W)*Ee,a):null},ot.projection=function(a,h,m){return a[0]=2/h,a[1]=0,a[2]=0,a[3]=0,a[4]=-2/m,a[5]=0,a[6]=-1,a[7]=1,a[8]=1,a},ot.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"},ot.frob=function(a){return Math.hypot(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])},ot.add=function(a,h,m){return a[0]=h[0]+m[0],a[1]=h[1]+m[1],a[2]=h[2]+m[2],a[3]=h[3]+m[3],a[4]=h[4]+m[4],a[5]=h[5]+m[5],a[6]=h[6]+m[6],a[7]=h[7]+m[7],a[8]=h[8]+m[8],a},ot.subtract=u,ot.multiplyScalar=function(a,h,m){return a[0]=h[0]*m,a[1]=h[1]*m,a[2]=h[2]*m,a[3]=h[3]*m,a[4]=h[4]*m,a[5]=h[5]*m,a[6]=h[6]*m,a[7]=h[7]*m,a[8]=h[8]*m,a},ot.multiplyScalarAndAdd=function(a,h,m,y){return a[0]=h[0]+m[0]*y,a[1]=h[1]+m[1]*y,a[2]=h[2]+m[2]*y,a[3]=h[3]+m[3]*y,a[4]=h[4]+m[4]*y,a[5]=h[5]+m[5]*y,a[6]=h[6]+m[6]*y,a[7]=h[7]+m[7]*y,a[8]=h[8]+m[8]*y,a},ot.exactEquals=function(a,h){return a[0]===h[0]&&a[1]===h[1]&&a[2]===h[2]&&a[3]===h[3]&&a[4]===h[4]&&a[5]===h[5]&&a[6]===h[6]&&a[7]===h[7]&&a[8]===h[8]},ot.equals=function(a,h){var m=a[0],y=a[1],T=a[2],f=a[3],x=a[4],w=a[5],g=a[6],v=a[7],S=a[8],C=h[0],z=h[1],O=h[2],B=h[3],L=h[4],V=h[5],j=h[6],W=h[7],te=h[8];return Math.abs(m-C)<=e.EPSILON*Math.max(1,Math.abs(m),Math.abs(C))&&Math.abs(y-z)<=e.EPSILON*Math.max(1,Math.abs(y),Math.abs(z))&&Math.abs(T-O)<=e.EPSILON*Math.max(1,Math.abs(T),Math.abs(O))&&Math.abs(f-B)<=e.EPSILON*Math.max(1,Math.abs(f),Math.abs(B))&&Math.abs(x-L)<=e.EPSILON*Math.max(1,Math.abs(x),Math.abs(L))&&Math.abs(w-V)<=e.EPSILON*Math.max(1,Math.abs(w),Math.abs(V))&&Math.abs(g-j)<=e.EPSILON*Math.max(1,Math.abs(g),Math.abs(j))&&Math.abs(v-W)<=e.EPSILON*Math.max(1,Math.abs(v),Math.abs(W))&&Math.abs(S-te)<=e.EPSILON*Math.max(1,Math.abs(S),Math.abs(te))},ot.sub=ot.mul=void 0;var e=function(a,h){if(a&&a.__esModule)return a;if(a===null||r(a)!=="object"&&typeof a!="function")return{default:a};var m=i(void 0);if(m&&m.has(a))return m.get(a);var y={},T=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var f in a)if(f!=="default"&&Object.prototype.hasOwnProperty.call(a,f)){var x=T?Object.getOwnPropertyDescriptor(a,f):null;x&&(x.get||x.set)?Object.defineProperty(y,f,x):y[f]=a[f]}return y.default=a,m&&m.set(a,y),y}(Me());function i(a){if(typeof WeakMap!="function")return null;var h=new WeakMap,m=new WeakMap;return(i=function(y){return y?m:h})(a)}function o(a,h,m){var y=h[0],T=h[1],f=h[2],x=h[3],w=h[4],g=h[5],v=h[6],S=h[7],C=h[8],z=m[0],O=m[1],B=m[2],L=m[3],V=m[4],j=m[5],W=m[6],te=m[7],ee=m[8];return a[0]=z*y+O*x+B*v,a[1]=z*T+O*w+B*S,a[2]=z*f+O*g+B*C,a[3]=L*y+V*x+j*v,a[4]=L*T+V*w+j*S,a[5]=L*f+V*g+j*C,a[6]=W*y+te*x+ee*v,a[7]=W*T+te*w+ee*S,a[8]=W*f+te*g+ee*C,a}function u(a,h,m){return a[0]=h[0]-m[0],a[1]=h[1]-m[1],a[2]=h[2]-m[2],a[3]=h[3]-m[3],a[4]=h[4]-m[4],a[5]=h[5]-m[5],a[6]=h[6]-m[6],a[7]=h[7]-m[7],a[8]=h[8]-m[8],a}return ot.mul=o,ot.sub=u,ot}var Rt,vt={};function Nt(){if(Rt)return vt;function r(f){return r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(x){return typeof x}:function(x){return x&&typeof Symbol=="function"&&x.constructor===Symbol&&x!==Symbol.prototype?"symbol":typeof x},r(f)}Rt=1,Object.defineProperty(vt,"__esModule",{value:!0}),vt.create=function(){var f=new e.ARRAY_TYPE(16);return e.ARRAY_TYPE!=Float32Array&&(f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[6]=0,f[7]=0,f[8]=0,f[9]=0,f[11]=0,f[12]=0,f[13]=0,f[14]=0),f[0]=1,f[5]=1,f[10]=1,f[15]=1,f},vt.clone=function(f){var x=new e.ARRAY_TYPE(16);return x[0]=f[0],x[1]=f[1],x[2]=f[2],x[3]=f[3],x[4]=f[4],x[5]=f[5],x[6]=f[6],x[7]=f[7],x[8]=f[8],x[9]=f[9],x[10]=f[10],x[11]=f[11],x[12]=f[12],x[13]=f[13],x[14]=f[14],x[15]=f[15],x},vt.copy=function(f,x){return f[0]=x[0],f[1]=x[1],f[2]=x[2],f[3]=x[3],f[4]=x[4],f[5]=x[5],f[6]=x[6],f[7]=x[7],f[8]=x[8],f[9]=x[9],f[10]=x[10],f[11]=x[11],f[12]=x[12],f[13]=x[13],f[14]=x[14],f[15]=x[15],f},vt.fromValues=function(f,x,w,g,v,S,C,z,O,B,L,V,j,W,te,ee){var Q=new e.ARRAY_TYPE(16);return Q[0]=f,Q[1]=x,Q[2]=w,Q[3]=g,Q[4]=v,Q[5]=S,Q[6]=C,Q[7]=z,Q[8]=O,Q[9]=B,Q[10]=L,Q[11]=V,Q[12]=j,Q[13]=W,Q[14]=te,Q[15]=ee,Q},vt.set=function(f,x,w,g,v,S,C,z,O,B,L,V,j,W,te,ee,Q){return f[0]=x,f[1]=w,f[2]=g,f[3]=v,f[4]=S,f[5]=C,f[6]=z,f[7]=O,f[8]=B,f[9]=L,f[10]=V,f[11]=j,f[12]=W,f[13]=te,f[14]=ee,f[15]=Q,f},vt.identity=o,vt.transpose=function(f,x){if(f===x){var w=x[1],g=x[2],v=x[3],S=x[6],C=x[7],z=x[11];f[1]=x[4],f[2]=x[8],f[3]=x[12],f[4]=w,f[6]=x[9],f[7]=x[13],f[8]=g,f[9]=S,f[11]=x[14],f[12]=v,f[13]=C,f[14]=z}else f[0]=x[0],f[1]=x[4],f[2]=x[8],f[3]=x[12],f[4]=x[1],f[5]=x[5],f[6]=x[9],f[7]=x[13],f[8]=x[2],f[9]=x[6],f[10]=x[10],f[11]=x[14],f[12]=x[3],f[13]=x[7],f[14]=x[11],f[15]=x[15];return f},vt.invert=function(f,x){var w=x[0],g=x[1],v=x[2],S=x[3],C=x[4],z=x[5],O=x[6],B=x[7],L=x[8],V=x[9],j=x[10],W=x[11],te=x[12],ee=x[13],Q=x[14],pe=x[15],ie=w*z-g*C,me=w*O-v*C,xe=w*B-S*C,ye=g*O-v*z,we=g*B-S*z,Ae=v*B-S*O,Re=L*ee-V*te,Ee=L*Q-j*te,$e=L*pe-W*te,Qe=V*Q-j*ee,qe=V*pe-W*ee,_t=j*pe-W*Q,pt=ie*_t-me*qe+xe*Qe+ye*$e-we*Ee+Ae*Re;return pt?(f[0]=(z*_t-O*qe+B*Qe)*(pt=1/pt),f[1]=(v*qe-g*_t-S*Qe)*pt,f[2]=(ee*Ae-Q*we+pe*ye)*pt,f[3]=(j*we-V*Ae-W*ye)*pt,f[4]=(O*$e-C*_t-B*Ee)*pt,f[5]=(w*_t-v*$e+S*Ee)*pt,f[6]=(Q*xe-te*Ae-pe*me)*pt,f[7]=(L*Ae-j*xe+W*me)*pt,f[8]=(C*qe-z*$e+B*Re)*pt,f[9]=(g*$e-w*qe-S*Re)*pt,f[10]=(te*we-ee*xe+pe*ie)*pt,f[11]=(V*xe-L*we-W*ie)*pt,f[12]=(z*Ee-C*Qe-O*Re)*pt,f[13]=(w*Qe-g*Ee+v*Re)*pt,f[14]=(ee*me-te*ye-Q*ie)*pt,f[15]=(L*ye-V*me+j*ie)*pt,f):null},vt.adjoint=function(f,x){var w=x[0],g=x[1],v=x[2],S=x[3],C=x[4],z=x[5],O=x[6],B=x[7],L=x[8],V=x[9],j=x[10],W=x[11],te=x[12],ee=x[13],Q=x[14],pe=x[15];return f[0]=z*(j*pe-W*Q)-V*(O*pe-B*Q)+ee*(O*W-B*j),f[1]=-(g*(j*pe-W*Q)-V*(v*pe-S*Q)+ee*(v*W-S*j)),f[2]=g*(O*pe-B*Q)-z*(v*pe-S*Q)+ee*(v*B-S*O),f[3]=-(g*(O*W-B*j)-z*(v*W-S*j)+V*(v*B-S*O)),f[4]=-(C*(j*pe-W*Q)-L*(O*pe-B*Q)+te*(O*W-B*j)),f[5]=w*(j*pe-W*Q)-L*(v*pe-S*Q)+te*(v*W-S*j),f[6]=-(w*(O*pe-B*Q)-C*(v*pe-S*Q)+te*(v*B-S*O)),f[7]=w*(O*W-B*j)-C*(v*W-S*j)+L*(v*B-S*O),f[8]=C*(V*pe-W*ee)-L*(z*pe-B*ee)+te*(z*W-B*V),f[9]=-(w*(V*pe-W*ee)-L*(g*pe-S*ee)+te*(g*W-S*V)),f[10]=w*(z*pe-B*ee)-C*(g*pe-S*ee)+te*(g*B-S*z),f[11]=-(w*(z*W-B*V)-C*(g*W-S*V)+L*(g*B-S*z)),f[12]=-(C*(V*Q-j*ee)-L*(z*Q-O*ee)+te*(z*j-O*V)),f[13]=w*(V*Q-j*ee)-L*(g*Q-v*ee)+te*(g*j-v*V),f[14]=-(w*(z*Q-O*ee)-C*(g*Q-v*ee)+te*(g*O-v*z)),f[15]=w*(z*j-O*V)-C*(g*j-v*V)+L*(g*O-v*z),f},vt.determinant=function(f){var x=f[0],w=f[1],g=f[2],v=f[3],S=f[4],C=f[5],z=f[6],O=f[7],B=f[8],L=f[9],V=f[10],j=f[11],W=f[12],te=f[13],ee=f[14],Q=f[15];return(x*C-w*S)*(V*Q-j*ee)-(x*z-g*S)*(L*Q-j*te)+(x*O-v*S)*(L*ee-V*te)+(w*z-g*C)*(B*Q-j*W)-(w*O-v*C)*(B*ee-V*W)+(g*O-v*z)*(B*te-L*W)},vt.multiply=u,vt.translate=function(f,x,w){var g,v,S,C,z,O,B,L,V,j,W,te,ee=w[0],Q=w[1],pe=w[2];return x===f?(f[12]=x[0]*ee+x[4]*Q+x[8]*pe+x[12],f[13]=x[1]*ee+x[5]*Q+x[9]*pe+x[13],f[14]=x[2]*ee+x[6]*Q+x[10]*pe+x[14],f[15]=x[3]*ee+x[7]*Q+x[11]*pe+x[15]):(v=x[1],S=x[2],C=x[3],z=x[4],O=x[5],B=x[6],L=x[7],V=x[8],j=x[9],W=x[10],te=x[11],f[0]=g=x[0],f[1]=v,f[2]=S,f[3]=C,f[4]=z,f[5]=O,f[6]=B,f[7]=L,f[8]=V,f[9]=j,f[10]=W,f[11]=te,f[12]=g*ee+z*Q+V*pe+x[12],f[13]=v*ee+O*Q+j*pe+x[13],f[14]=S*ee+B*Q+W*pe+x[14],f[15]=C*ee+L*Q+te*pe+x[15]),f},vt.scale=function(f,x,w){var g=w[0],v=w[1],S=w[2];return f[0]=x[0]*g,f[1]=x[1]*g,f[2]=x[2]*g,f[3]=x[3]*g,f[4]=x[4]*v,f[5]=x[5]*v,f[6]=x[6]*v,f[7]=x[7]*v,f[8]=x[8]*S,f[9]=x[9]*S,f[10]=x[10]*S,f[11]=x[11]*S,f[12]=x[12],f[13]=x[13],f[14]=x[14],f[15]=x[15],f},vt.rotate=function(f,x,w,g){var v,S,C,z,O,B,L,V,j,W,te,ee,Q,pe,ie,me,xe,ye,we,Ae,Re,Ee,$e,Qe,qe=g[0],_t=g[1],pt=g[2],rt=Math.hypot(qe,_t,pt);return rt<e.EPSILON?null:(qe*=rt=1/rt,_t*=rt,pt*=rt,v=Math.sin(w),S=Math.cos(w),O=x[1],B=x[2],L=x[3],j=x[5],W=x[6],te=x[7],Q=x[9],pe=x[10],ie=x[11],me=qe*qe*(C=1-S)+S,we=qe*_t*C-pt*v,Ae=_t*_t*C+S,Re=pt*_t*C+qe*v,Ee=qe*pt*C+_t*v,$e=_t*pt*C-qe*v,Qe=pt*pt*C+S,f[0]=(z=x[0])*me+(V=x[4])*(xe=_t*qe*C+pt*v)+(ee=x[8])*(ye=pt*qe*C-_t*v),f[1]=O*me+j*xe+Q*ye,f[2]=B*me+W*xe+pe*ye,f[3]=L*me+te*xe+ie*ye,f[4]=z*we+V*Ae+ee*Re,f[5]=O*we+j*Ae+Q*Re,f[6]=B*we+W*Ae+pe*Re,f[7]=L*we+te*Ae+ie*Re,f[8]=z*Ee+V*$e+ee*Qe,f[9]=O*Ee+j*$e+Q*Qe,f[10]=B*Ee+W*$e+pe*Qe,f[11]=L*Ee+te*$e+ie*Qe,x!==f&&(f[12]=x[12],f[13]=x[13],f[14]=x[14],f[15]=x[15]),f)},vt.rotateX=function(f,x,w){var g=Math.sin(w),v=Math.cos(w),S=x[4],C=x[5],z=x[6],O=x[7],B=x[8],L=x[9],V=x[10],j=x[11];return x!==f&&(f[0]=x[0],f[1]=x[1],f[2]=x[2],f[3]=x[3],f[12]=x[12],f[13]=x[13],f[14]=x[14],f[15]=x[15]),f[4]=S*v+B*g,f[5]=C*v+L*g,f[6]=z*v+V*g,f[7]=O*v+j*g,f[8]=B*v-S*g,f[9]=L*v-C*g,f[10]=V*v-z*g,f[11]=j*v-O*g,f},vt.rotateY=function(f,x,w){var g=Math.sin(w),v=Math.cos(w),S=x[0],C=x[1],z=x[2],O=x[3],B=x[8],L=x[9],V=x[10],j=x[11];return x!==f&&(f[4]=x[4],f[5]=x[5],f[6]=x[6],f[7]=x[7],f[12]=x[12],f[13]=x[13],f[14]=x[14],f[15]=x[15]),f[0]=S*v-B*g,f[1]=C*v-L*g,f[2]=z*v-V*g,f[3]=O*v-j*g,f[8]=S*g+B*v,f[9]=C*g+L*v,f[10]=z*g+V*v,f[11]=O*g+j*v,f},vt.rotateZ=function(f,x,w){var g=Math.sin(w),v=Math.cos(w),S=x[0],C=x[1],z=x[2],O=x[3],B=x[4],L=x[5],V=x[6],j=x[7];return x!==f&&(f[8]=x[8],f[9]=x[9],f[10]=x[10],f[11]=x[11],f[12]=x[12],f[13]=x[13],f[14]=x[14],f[15]=x[15]),f[0]=S*v+B*g,f[1]=C*v+L*g,f[2]=z*v+V*g,f[3]=O*v+j*g,f[4]=B*v-S*g,f[5]=L*v-C*g,f[6]=V*v-z*g,f[7]=j*v-O*g,f},vt.fromTranslation=function(f,x){return f[0]=1,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=1,f[6]=0,f[7]=0,f[8]=0,f[9]=0,f[10]=1,f[11]=0,f[12]=x[0],f[13]=x[1],f[14]=x[2],f[15]=1,f},vt.fromScaling=function(f,x){return f[0]=x[0],f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=x[1],f[6]=0,f[7]=0,f[8]=0,f[9]=0,f[10]=x[2],f[11]=0,f[12]=0,f[13]=0,f[14]=0,f[15]=1,f},vt.fromRotation=function(f,x,w){var g,v,S,C=w[0],z=w[1],O=w[2],B=Math.hypot(C,z,O);return B<e.EPSILON?null:(C*=B=1/B,z*=B,O*=B,g=Math.sin(x),v=Math.cos(x),f[0]=C*C*(S=1-v)+v,f[1]=z*C*S+O*g,f[2]=O*C*S-z*g,f[3]=0,f[4]=C*z*S-O*g,f[5]=z*z*S+v,f[6]=O*z*S+C*g,f[7]=0,f[8]=C*O*S+z*g,f[9]=z*O*S-C*g,f[10]=O*O*S+v,f[11]=0,f[12]=0,f[13]=0,f[14]=0,f[15]=1,f)},vt.fromXRotation=function(f,x){var w=Math.sin(x),g=Math.cos(x);return f[0]=1,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=g,f[6]=w,f[7]=0,f[8]=0,f[9]=-w,f[10]=g,f[11]=0,f[12]=0,f[13]=0,f[14]=0,f[15]=1,f},vt.fromYRotation=function(f,x){var w=Math.sin(x),g=Math.cos(x);return f[0]=g,f[1]=0,f[2]=-w,f[3]=0,f[4]=0,f[5]=1,f[6]=0,f[7]=0,f[8]=w,f[9]=0,f[10]=g,f[11]=0,f[12]=0,f[13]=0,f[14]=0,f[15]=1,f},vt.fromZRotation=function(f,x){var w=Math.sin(x),g=Math.cos(x);return f[0]=g,f[1]=w,f[2]=0,f[3]=0,f[4]=-w,f[5]=g,f[6]=0,f[7]=0,f[8]=0,f[9]=0,f[10]=1,f[11]=0,f[12]=0,f[13]=0,f[14]=0,f[15]=1,f},vt.fromRotationTranslation=a,vt.fromQuat2=function(f,x){var w=new e.ARRAY_TYPE(3),g=-x[0],v=-x[1],S=-x[2],C=x[3],z=x[4],O=x[5],B=x[6],L=x[7],V=g*g+v*v+S*S+C*C;return V>0?(w[0]=2*(z*C+L*g+O*S-B*v)/V,w[1]=2*(O*C+L*v+B*g-z*S)/V,w[2]=2*(B*C+L*S+z*v-O*g)/V):(w[0]=2*(z*C+L*g+O*S-B*v),w[1]=2*(O*C+L*v+B*g-z*S),w[2]=2*(B*C+L*S+z*v-O*g)),a(f,x,w),f},vt.getTranslation=function(f,x){return f[0]=x[12],f[1]=x[13],f[2]=x[14],f},vt.getScaling=h,vt.getRotation=function(f,x){var w=new e.ARRAY_TYPE(3);h(w,x);var g=1/w[0],v=1/w[1],S=1/w[2],C=x[0]*g,z=x[1]*v,O=x[2]*S,B=x[4]*g,L=x[5]*v,V=x[6]*S,j=x[8]*g,W=x[9]*v,te=x[10]*S,ee=C+L+te,Q=0;return ee>0?(Q=2*Math.sqrt(ee+1),f[3]=.25*Q,f[0]=(V-W)/Q,f[1]=(j-O)/Q,f[2]=(z-B)/Q):C>L&&C>te?(Q=2*Math.sqrt(1+C-L-te),f[3]=(V-W)/Q,f[0]=.25*Q,f[1]=(z+B)/Q,f[2]=(j+O)/Q):L>te?(Q=2*Math.sqrt(1+L-C-te),f[3]=(j-O)/Q,f[0]=(z+B)/Q,f[1]=.25*Q,f[2]=(V+W)/Q):(Q=2*Math.sqrt(1+te-C-L),f[3]=(z-B)/Q,f[0]=(j+O)/Q,f[1]=(V+W)/Q,f[2]=.25*Q),f},vt.fromRotationTranslationScale=function(f,x,w,g){var v=x[0],S=x[1],C=x[2],z=x[3],O=v+v,B=S+S,L=C+C,V=v*O,j=v*B,W=v*L,te=S*B,ee=S*L,Q=C*L,pe=z*O,ie=z*B,me=z*L,xe=g[0],ye=g[1],we=g[2];return f[0]=(1-(te+Q))*xe,f[1]=(j+me)*xe,f[2]=(W-ie)*xe,f[3]=0,f[4]=(j-me)*ye,f[5]=(1-(V+Q))*ye,f[6]=(ee+pe)*ye,f[7]=0,f[8]=(W+ie)*we,f[9]=(ee-pe)*we,f[10]=(1-(V+te))*we,f[11]=0,f[12]=w[0],f[13]=w[1],f[14]=w[2],f[15]=1,f},vt.fromRotationTranslationScaleOrigin=function(f,x,w,g,v){var S=x[0],C=x[1],z=x[2],O=x[3],B=S+S,L=C+C,V=z+z,j=S*B,W=S*L,te=S*V,ee=C*L,Q=C*V,pe=z*V,ie=O*B,me=O*L,xe=O*V,ye=g[0],we=g[1],Ae=g[2],Re=v[0],Ee=v[1],$e=v[2],Qe=(1-(ee+pe))*ye,qe=(W+xe)*ye,_t=(te-me)*ye,pt=(W-xe)*we,rt=(1-(j+pe))*we,et=(Q+ie)*we,Pt=(te+me)*Ae,yt=(Q-ie)*Ae,Tt=(1-(j+ee))*Ae;return f[0]=Qe,f[1]=qe,f[2]=_t,f[3]=0,f[4]=pt,f[5]=rt,f[6]=et,f[7]=0,f[8]=Pt,f[9]=yt,f[10]=Tt,f[11]=0,f[12]=w[0]+Re-(Qe*Re+pt*Ee+Pt*$e),f[13]=w[1]+Ee-(qe*Re+rt*Ee+yt*$e),f[14]=w[2]+$e-(_t*Re+et*Ee+Tt*$e),f[15]=1,f},vt.fromQuat=function(f,x){var w=x[0],g=x[1],v=x[2],S=x[3],C=w+w,z=g+g,O=v+v,B=w*C,L=g*C,V=g*z,j=v*C,W=v*z,te=v*O,ee=S*C,Q=S*z,pe=S*O;return f[0]=1-V-te,f[1]=L+pe,f[2]=j-Q,f[3]=0,f[4]=L-pe,f[5]=1-B-te,f[6]=W+ee,f[7]=0,f[8]=j+Q,f[9]=W-ee,f[10]=1-B-V,f[11]=0,f[12]=0,f[13]=0,f[14]=0,f[15]=1,f},vt.frustum=function(f,x,w,g,v,S,C){var z=1/(w-x),O=1/(v-g),B=1/(S-C);return f[0]=2*S*z,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=2*S*O,f[6]=0,f[7]=0,f[8]=(w+x)*z,f[9]=(v+g)*O,f[10]=(C+S)*B,f[11]=-1,f[12]=0,f[13]=0,f[14]=C*S*2*B,f[15]=0,f},vt.perspectiveNO=m,vt.perspectiveZO=function(f,x,w,g,v){var S,C=1/Math.tan(x/2);return f[0]=C/w,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=C,f[6]=0,f[7]=0,f[8]=0,f[9]=0,f[11]=-1,f[12]=0,f[13]=0,f[15]=0,v!=null&&v!==1/0?(f[10]=v*(S=1/(g-v)),f[14]=v*g*S):(f[10]=-1,f[14]=-g),f},vt.perspectiveFromFieldOfView=function(f,x,w,g){var v=Math.tan(x.upDegrees*Math.PI/180),S=Math.tan(x.downDegrees*Math.PI/180),C=Math.tan(x.leftDegrees*Math.PI/180),z=Math.tan(x.rightDegrees*Math.PI/180),O=2/(C+z),B=2/(v+S);return f[0]=O,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=B,f[6]=0,f[7]=0,f[8]=-(C-z)*O*.5,f[9]=(v-S)*B*.5,f[10]=g/(w-g),f[11]=-1,f[12]=0,f[13]=0,f[14]=g*w/(w-g),f[15]=0,f},vt.orthoNO=y,vt.orthoZO=function(f,x,w,g,v,S,C){var z=1/(x-w),O=1/(g-v),B=1/(S-C);return f[0]=-2*z,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=-2*O,f[6]=0,f[7]=0,f[8]=0,f[9]=0,f[10]=B,f[11]=0,f[12]=(x+w)*z,f[13]=(v+g)*O,f[14]=S*B,f[15]=1,f},vt.lookAt=function(f,x,w,g){var v,S,C,z,O,B,L,V,j,W,te=x[0],ee=x[1],Q=x[2],pe=g[0],ie=g[1],me=g[2],xe=w[0],ye=w[1],we=w[2];return Math.abs(te-xe)<e.EPSILON&&Math.abs(ee-ye)<e.EPSILON&&Math.abs(Q-we)<e.EPSILON?o(f):(L=te-xe,V=ee-ye,j=Q-we,v=ie*(j*=W=1/Math.hypot(L,V,j))-me*(V*=W),S=me*(L*=W)-pe*j,C=pe*V-ie*L,(W=Math.hypot(v,S,C))?(v*=W=1/W,S*=W,C*=W):(v=0,S=0,C=0),z=V*C-j*S,O=j*v-L*C,B=L*S-V*v,(W=Math.hypot(z,O,B))?(z*=W=1/W,O*=W,B*=W):(z=0,O=0,B=0),f[0]=v,f[1]=z,f[2]=L,f[3]=0,f[4]=S,f[5]=O,f[6]=V,f[7]=0,f[8]=C,f[9]=B,f[10]=j,f[11]=0,f[12]=-(v*te+S*ee+C*Q),f[13]=-(z*te+O*ee+B*Q),f[14]=-(L*te+V*ee+j*Q),f[15]=1,f)},vt.targetTo=function(f,x,w,g){var v=x[0],S=x[1],C=x[2],z=g[0],O=g[1],B=g[2],L=v-w[0],V=S-w[1],j=C-w[2],W=L*L+V*V+j*j;W>0&&(L*=W=1/Math.sqrt(W),V*=W,j*=W);var te=O*j-B*V,ee=B*L-z*j,Q=z*V-O*L;return(W=te*te+ee*ee+Q*Q)>0&&(te*=W=1/Math.sqrt(W),ee*=W,Q*=W),f[0]=te,f[1]=ee,f[2]=Q,f[3]=0,f[4]=V*Q-j*ee,f[5]=j*te-L*Q,f[6]=L*ee-V*te,f[7]=0,f[8]=L,f[9]=V,f[10]=j,f[11]=0,f[12]=v,f[13]=S,f[14]=C,f[15]=1,f},vt.str=function(f){return"mat4("+f[0]+", "+f[1]+", "+f[2]+", "+f[3]+", "+f[4]+", "+f[5]+", "+f[6]+", "+f[7]+", "+f[8]+", "+f[9]+", "+f[10]+", "+f[11]+", "+f[12]+", "+f[13]+", "+f[14]+", "+f[15]+")"},vt.frob=function(f){return Math.hypot(f[0],f[1],f[2],f[3],f[4],f[5],f[6],f[7],f[8],f[9],f[10],f[11],f[12],f[13],f[14],f[15])},vt.add=function(f,x,w){return f[0]=x[0]+w[0],f[1]=x[1]+w[1],f[2]=x[2]+w[2],f[3]=x[3]+w[3],f[4]=x[4]+w[4],f[5]=x[5]+w[5],f[6]=x[6]+w[6],f[7]=x[7]+w[7],f[8]=x[8]+w[8],f[9]=x[9]+w[9],f[10]=x[10]+w[10],f[11]=x[11]+w[11],f[12]=x[12]+w[12],f[13]=x[13]+w[13],f[14]=x[14]+w[14],f[15]=x[15]+w[15],f},vt.subtract=T,vt.multiplyScalar=function(f,x,w){return f[0]=x[0]*w,f[1]=x[1]*w,f[2]=x[2]*w,f[3]=x[3]*w,f[4]=x[4]*w,f[5]=x[5]*w,f[6]=x[6]*w,f[7]=x[7]*w,f[8]=x[8]*w,f[9]=x[9]*w,f[10]=x[10]*w,f[11]=x[11]*w,f[12]=x[12]*w,f[13]=x[13]*w,f[14]=x[14]*w,f[15]=x[15]*w,f},vt.multiplyScalarAndAdd=function(f,x,w,g){return f[0]=x[0]+w[0]*g,f[1]=x[1]+w[1]*g,f[2]=x[2]+w[2]*g,f[3]=x[3]+w[3]*g,f[4]=x[4]+w[4]*g,f[5]=x[5]+w[5]*g,f[6]=x[6]+w[6]*g,f[7]=x[7]+w[7]*g,f[8]=x[8]+w[8]*g,f[9]=x[9]+w[9]*g,f[10]=x[10]+w[10]*g,f[11]=x[11]+w[11]*g,f[12]=x[12]+w[12]*g,f[13]=x[13]+w[13]*g,f[14]=x[14]+w[14]*g,f[15]=x[15]+w[15]*g,f},vt.exactEquals=function(f,x){return f[0]===x[0]&&f[1]===x[1]&&f[2]===x[2]&&f[3]===x[3]&&f[4]===x[4]&&f[5]===x[5]&&f[6]===x[6]&&f[7]===x[7]&&f[8]===x[8]&&f[9]===x[9]&&f[10]===x[10]&&f[11]===x[11]&&f[12]===x[12]&&f[13]===x[13]&&f[14]===x[14]&&f[15]===x[15]},vt.equals=function(f,x){var w=f[0],g=f[1],v=f[2],S=f[3],C=f[4],z=f[5],O=f[6],B=f[7],L=f[8],V=f[9],j=f[10],W=f[11],te=f[12],ee=f[13],Q=f[14],pe=f[15],ie=x[0],me=x[1],xe=x[2],ye=x[3],we=x[4],Ae=x[5],Re=x[6],Ee=x[7],$e=x[8],Qe=x[9],qe=x[10],_t=x[11],pt=x[12],rt=x[13],et=x[14],Pt=x[15];return Math.abs(w-ie)<=e.EPSILON*Math.max(1,Math.abs(w),Math.abs(ie))&&Math.abs(g-me)<=e.EPSILON*Math.max(1,Math.abs(g),Math.abs(me))&&Math.abs(v-xe)<=e.EPSILON*Math.max(1,Math.abs(v),Math.abs(xe))&&Math.abs(S-ye)<=e.EPSILON*Math.max(1,Math.abs(S),Math.abs(ye))&&Math.abs(C-we)<=e.EPSILON*Math.max(1,Math.abs(C),Math.abs(we))&&Math.abs(z-Ae)<=e.EPSILON*Math.max(1,Math.abs(z),Math.abs(Ae))&&Math.abs(O-Re)<=e.EPSILON*Math.max(1,Math.abs(O),Math.abs(Re))&&Math.abs(B-Ee)<=e.EPSILON*Math.max(1,Math.abs(B),Math.abs(Ee))&&Math.abs(L-$e)<=e.EPSILON*Math.max(1,Math.abs(L),Math.abs($e))&&Math.abs(V-Qe)<=e.EPSILON*Math.max(1,Math.abs(V),Math.abs(Qe))&&Math.abs(j-qe)<=e.EPSILON*Math.max(1,Math.abs(j),Math.abs(qe))&&Math.abs(W-_t)<=e.EPSILON*Math.max(1,Math.abs(W),Math.abs(_t))&&Math.abs(te-pt)<=e.EPSILON*Math.max(1,Math.abs(te),Math.abs(pt))&&Math.abs(ee-rt)<=e.EPSILON*Math.max(1,Math.abs(ee),Math.abs(rt))&&Math.abs(Q-et)<=e.EPSILON*Math.max(1,Math.abs(Q),Math.abs(et))&&Math.abs(pe-Pt)<=e.EPSILON*Math.max(1,Math.abs(pe),Math.abs(Pt))},vt.sub=vt.mul=vt.ortho=vt.perspective=void 0;var e=function(f,x){if(f&&f.__esModule)return f;if(f===null||r(f)!=="object"&&typeof f!="function")return{default:f};var w=i(void 0);if(w&&w.has(f))return w.get(f);var g={},v=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var S in f)if(S!=="default"&&Object.prototype.hasOwnProperty.call(f,S)){var C=v?Object.getOwnPropertyDescriptor(f,S):null;C&&(C.get||C.set)?Object.defineProperty(g,S,C):g[S]=f[S]}return g.default=f,w&&w.set(f,g),g}(Me());function i(f){if(typeof WeakMap!="function")return null;var x=new WeakMap,w=new WeakMap;return(i=function(g){return g?w:x})(f)}function o(f){return f[0]=1,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=1,f[6]=0,f[7]=0,f[8]=0,f[9]=0,f[10]=1,f[11]=0,f[12]=0,f[13]=0,f[14]=0,f[15]=1,f}function u(f,x,w){var g=x[0],v=x[1],S=x[2],C=x[3],z=x[4],O=x[5],B=x[6],L=x[7],V=x[8],j=x[9],W=x[10],te=x[11],ee=x[12],Q=x[13],pe=x[14],ie=x[15],me=w[0],xe=w[1],ye=w[2],we=w[3];return f[0]=me*g+xe*z+ye*V+we*ee,f[1]=me*v+xe*O+ye*j+we*Q,f[2]=me*S+xe*B+ye*W+we*pe,f[3]=me*C+xe*L+ye*te+we*ie,f[4]=(me=w[4])*g+(xe=w[5])*z+(ye=w[6])*V+(we=w[7])*ee,f[5]=me*v+xe*O+ye*j+we*Q,f[6]=me*S+xe*B+ye*W+we*pe,f[7]=me*C+xe*L+ye*te+we*ie,f[8]=(me=w[8])*g+(xe=w[9])*z+(ye=w[10])*V+(we=w[11])*ee,f[9]=me*v+xe*O+ye*j+we*Q,f[10]=me*S+xe*B+ye*W+we*pe,f[11]=me*C+xe*L+ye*te+we*ie,f[12]=(me=w[12])*g+(xe=w[13])*z+(ye=w[14])*V+(we=w[15])*ee,f[13]=me*v+xe*O+ye*j+we*Q,f[14]=me*S+xe*B+ye*W+we*pe,f[15]=me*C+xe*L+ye*te+we*ie,f}function a(f,x,w){var g=x[0],v=x[1],S=x[2],C=x[3],z=g+g,O=v+v,B=S+S,L=g*z,V=g*O,j=g*B,W=v*O,te=v*B,ee=S*B,Q=C*z,pe=C*O,ie=C*B;return f[0]=1-(W+ee),f[1]=V+ie,f[2]=j-pe,f[3]=0,f[4]=V-ie,f[5]=1-(L+ee),f[6]=te+Q,f[7]=0,f[8]=j+pe,f[9]=te-Q,f[10]=1-(L+W),f[11]=0,f[12]=w[0],f[13]=w[1],f[14]=w[2],f[15]=1,f}function h(f,x){var w=x[4],g=x[5],v=x[6],S=x[8],C=x[9],z=x[10];return f[0]=Math.hypot(x[0],x[1],x[2]),f[1]=Math.hypot(w,g,v),f[2]=Math.hypot(S,C,z),f}function m(f,x,w,g,v){var S,C=1/Math.tan(x/2);return f[0]=C/w,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=C,f[6]=0,f[7]=0,f[8]=0,f[9]=0,f[11]=-1,f[12]=0,f[13]=0,f[15]=0,v!=null&&v!==1/0?(f[10]=(v+g)*(S=1/(g-v)),f[14]=2*v*g*S):(f[10]=-1,f[14]=-2*g),f}function y(f,x,w,g,v,S,C){var z=1/(x-w),O=1/(g-v),B=1/(S-C);return f[0]=-2*z,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=-2*O,f[6]=0,f[7]=0,f[8]=0,f[9]=0,f[10]=2*B,f[11]=0,f[12]=(x+w)*z,f[13]=(v+g)*O,f[14]=(C+S)*B,f[15]=1,f}function T(f,x,w){return f[0]=x[0]-w[0],f[1]=x[1]-w[1],f[2]=x[2]-w[2],f[3]=x[3]-w[3],f[4]=x[4]-w[4],f[5]=x[5]-w[5],f[6]=x[6]-w[6],f[7]=x[7]-w[7],f[8]=x[8]-w[8],f[9]=x[9]-w[9],f[10]=x[10]-w[10],f[11]=x[11]-w[11],f[12]=x[12]-w[12],f[13]=x[13]-w[13],f[14]=x[14]-w[14],f[15]=x[15]-w[15],f}return vt.perspective=m,vt.ortho=y,vt.mul=u,vt.sub=T,vt}var Jt,It={},xt={};function $i(){if(Jt)return xt;function r(v){return r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(S){return typeof S}:function(S){return S&&typeof Symbol=="function"&&S.constructor===Symbol&&S!==Symbol.prototype?"symbol":typeof S},r(v)}Jt=1,Object.defineProperty(xt,"__esModule",{value:!0}),xt.create=o,xt.clone=function(v){var S=new e.ARRAY_TYPE(3);return S[0]=v[0],S[1]=v[1],S[2]=v[2],S},xt.length=u,xt.fromValues=function(v,S,C){var z=new e.ARRAY_TYPE(3);return z[0]=v,z[1]=S,z[2]=C,z},xt.copy=function(v,S){return v[0]=S[0],v[1]=S[1],v[2]=S[2],v},xt.set=function(v,S,C,z){return v[0]=S,v[1]=C,v[2]=z,v},xt.add=function(v,S,C){return v[0]=S[0]+C[0],v[1]=S[1]+C[1],v[2]=S[2]+C[2],v},xt.subtract=a,xt.multiply=h,xt.divide=m,xt.ceil=function(v,S){return v[0]=Math.ceil(S[0]),v[1]=Math.ceil(S[1]),v[2]=Math.ceil(S[2]),v},xt.floor=function(v,S){return v[0]=Math.floor(S[0]),v[1]=Math.floor(S[1]),v[2]=Math.floor(S[2]),v},xt.min=function(v,S,C){return v[0]=Math.min(S[0],C[0]),v[1]=Math.min(S[1],C[1]),v[2]=Math.min(S[2],C[2]),v},xt.max=function(v,S,C){return v[0]=Math.max(S[0],C[0]),v[1]=Math.max(S[1],C[1]),v[2]=Math.max(S[2],C[2]),v},xt.round=function(v,S){return v[0]=Math.round(S[0]),v[1]=Math.round(S[1]),v[2]=Math.round(S[2]),v},xt.scale=function(v,S,C){return v[0]=S[0]*C,v[1]=S[1]*C,v[2]=S[2]*C,v},xt.scaleAndAdd=function(v,S,C,z){return v[0]=S[0]+C[0]*z,v[1]=S[1]+C[1]*z,v[2]=S[2]+C[2]*z,v},xt.distance=y,xt.squaredDistance=T,xt.squaredLength=f,xt.negate=function(v,S){return v[0]=-S[0],v[1]=-S[1],v[2]=-S[2],v},xt.inverse=function(v,S){return v[0]=1/S[0],v[1]=1/S[1],v[2]=1/S[2],v},xt.normalize=function(v,S){var C=S[0],z=S[1],O=S[2],B=C*C+z*z+O*O;return B>0&&(B=1/Math.sqrt(B)),v[0]=S[0]*B,v[1]=S[1]*B,v[2]=S[2]*B,v},xt.dot=x,xt.cross=function(v,S,C){var z=S[0],O=S[1],B=S[2],L=C[0],V=C[1],j=C[2];return v[0]=O*j-B*V,v[1]=B*L-z*j,v[2]=z*V-O*L,v},xt.lerp=function(v,S,C,z){var O=S[0],B=S[1],L=S[2];return v[0]=O+z*(C[0]-O),v[1]=B+z*(C[1]-B),v[2]=L+z*(C[2]-L),v},xt.hermite=function(v,S,C,z,O,B){var L=B*B,V=L*(2*B-3)+1,j=L*(B-2)+B,W=L*(B-1),te=L*(3-2*B);return v[0]=S[0]*V+C[0]*j+z[0]*W+O[0]*te,v[1]=S[1]*V+C[1]*j+z[1]*W+O[1]*te,v[2]=S[2]*V+C[2]*j+z[2]*W+O[2]*te,v},xt.bezier=function(v,S,C,z,O,B){var L=1-B,V=L*L,j=B*B,W=V*L,te=3*B*V,ee=3*j*L,Q=j*B;return v[0]=S[0]*W+C[0]*te+z[0]*ee+O[0]*Q,v[1]=S[1]*W+C[1]*te+z[1]*ee+O[1]*Q,v[2]=S[2]*W+C[2]*te+z[2]*ee+O[2]*Q,v},xt.random=function(v,S){S=S||1;var C=2*e.RANDOM()*Math.PI,z=2*e.RANDOM()-1,O=Math.sqrt(1-z*z)*S;return v[0]=Math.cos(C)*O,v[1]=Math.sin(C)*O,v[2]=z*S,v},xt.transformMat4=function(v,S,C){var z=S[0],O=S[1],B=S[2],L=C[3]*z+C[7]*O+C[11]*B+C[15];return v[0]=(C[0]*z+C[4]*O+C[8]*B+C[12])/(L=L||1),v[1]=(C[1]*z+C[5]*O+C[9]*B+C[13])/L,v[2]=(C[2]*z+C[6]*O+C[10]*B+C[14])/L,v},xt.transformMat3=function(v,S,C){var z=S[0],O=S[1],B=S[2];return v[0]=z*C[0]+O*C[3]+B*C[6],v[1]=z*C[1]+O*C[4]+B*C[7],v[2]=z*C[2]+O*C[5]+B*C[8],v},xt.transformQuat=function(v,S,C){var z=C[0],O=C[1],B=C[2],L=S[0],V=S[1],j=S[2],W=O*j-B*V,te=B*L-z*j,ee=z*V-O*L,Q=O*ee-B*te,pe=B*W-z*ee,ie=z*te-O*W,me=2*C[3];return te*=me,ee*=me,pe*=2,ie*=2,v[0]=L+(W*=me)+(Q*=2),v[1]=V+te+pe,v[2]=j+ee+ie,v},xt.rotateX=function(v,S,C,z){var O=[],B=[];return O[0]=S[0]-C[0],O[1]=S[1]-C[1],O[2]=S[2]-C[2],B[0]=O[0],B[1]=O[1]*Math.cos(z)-O[2]*Math.sin(z),B[2]=O[1]*Math.sin(z)+O[2]*Math.cos(z),v[0]=B[0]+C[0],v[1]=B[1]+C[1],v[2]=B[2]+C[2],v},xt.rotateY=function(v,S,C,z){var O=[],B=[];return O[0]=S[0]-C[0],O[1]=S[1]-C[1],O[2]=S[2]-C[2],B[0]=O[2]*Math.sin(z)+O[0]*Math.cos(z),B[1]=O[1],B[2]=O[2]*Math.cos(z)-O[0]*Math.sin(z),v[0]=B[0]+C[0],v[1]=B[1]+C[1],v[2]=B[2]+C[2],v},xt.rotateZ=function(v,S,C,z){var O=[],B=[];return O[0]=S[0]-C[0],O[1]=S[1]-C[1],O[2]=S[2]-C[2],B[0]=O[0]*Math.cos(z)-O[1]*Math.sin(z),B[1]=O[0]*Math.sin(z)+O[1]*Math.cos(z),B[2]=O[2],v[0]=B[0]+C[0],v[1]=B[1]+C[1],v[2]=B[2]+C[2],v},xt.angle=function(v,S){var C=v[0],z=v[1],O=v[2],B=S[0],L=S[1],V=S[2],j=Math.sqrt(C*C+z*z+O*O)*Math.sqrt(B*B+L*L+V*V),W=j&&x(v,S)/j;return Math.acos(Math.min(Math.max(W,-1),1))},xt.zero=function(v){return v[0]=0,v[1]=0,v[2]=0,v},xt.str=function(v){return"vec3("+v[0]+", "+v[1]+", "+v[2]+")"},xt.exactEquals=function(v,S){return v[0]===S[0]&&v[1]===S[1]&&v[2]===S[2]},xt.equals=function(v,S){var C=v[0],z=v[1],O=v[2],B=S[0],L=S[1],V=S[2];return Math.abs(C-B)<=e.EPSILON*Math.max(1,Math.abs(C),Math.abs(B))&&Math.abs(z-L)<=e.EPSILON*Math.max(1,Math.abs(z),Math.abs(L))&&Math.abs(O-V)<=e.EPSILON*Math.max(1,Math.abs(O),Math.abs(V))},xt.forEach=xt.sqrLen=xt.len=xt.sqrDist=xt.dist=xt.div=xt.mul=xt.sub=void 0;var e=function(v,S){if(v&&v.__esModule)return v;if(v===null||r(v)!=="object"&&typeof v!="function")return{default:v};var C=i(void 0);if(C&&C.has(v))return C.get(v);var z={},O=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var B in v)if(B!=="default"&&Object.prototype.hasOwnProperty.call(v,B)){var L=O?Object.getOwnPropertyDescriptor(v,B):null;L&&(L.get||L.set)?Object.defineProperty(z,B,L):z[B]=v[B]}return z.default=v,C&&C.set(v,z),z}(Me());function i(v){if(typeof WeakMap!="function")return null;var S=new WeakMap,C=new WeakMap;return(i=function(z){return z?C:S})(v)}function o(){var v=new e.ARRAY_TYPE(3);return e.ARRAY_TYPE!=Float32Array&&(v[0]=0,v[1]=0,v[2]=0),v}function u(v){return Math.hypot(v[0],v[1],v[2])}function a(v,S,C){return v[0]=S[0]-C[0],v[1]=S[1]-C[1],v[2]=S[2]-C[2],v}function h(v,S,C){return v[0]=S[0]*C[0],v[1]=S[1]*C[1],v[2]=S[2]*C[2],v}function m(v,S,C){return v[0]=S[0]/C[0],v[1]=S[1]/C[1],v[2]=S[2]/C[2],v}function y(v,S){return Math.hypot(S[0]-v[0],S[1]-v[1],S[2]-v[2])}function T(v,S){var C=S[0]-v[0],z=S[1]-v[1],O=S[2]-v[2];return C*C+z*z+O*O}function f(v){var S=v[0],C=v[1],z=v[2];return S*S+C*C+z*z}function x(v,S){return v[0]*S[0]+v[1]*S[1]+v[2]*S[2]}xt.sub=a,xt.mul=h,xt.div=m,xt.dist=y,xt.sqrDist=T,xt.len=u,xt.sqrLen=f;var w,g=(w=o(),function(v,S,C,z,O,B){var L,V;for(S||(S=3),C||(C=0),V=z?Math.min(z*S+C,v.length):v.length,L=C;L<V;L+=S)w[0]=v[L],w[1]=v[L+1],w[2]=v[L+2],O(w,w,B),v[L]=w[0],v[L+1]=w[1],v[L+2]=w[2];return v});return xt.forEach=g,xt}var ki,Oi,tt={};function ai(){if(ki)return tt;function r(g){return r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(v){return typeof v}:function(v){return v&&typeof Symbol=="function"&&v.constructor===Symbol&&v!==Symbol.prototype?"symbol":typeof v},r(g)}ki=1,Object.defineProperty(tt,"__esModule",{value:!0}),tt.create=o,tt.clone=function(g){var v=new e.ARRAY_TYPE(4);return v[0]=g[0],v[1]=g[1],v[2]=g[2],v[3]=g[3],v},tt.fromValues=function(g,v,S,C){var z=new e.ARRAY_TYPE(4);return z[0]=g,z[1]=v,z[2]=S,z[3]=C,z},tt.copy=function(g,v){return g[0]=v[0],g[1]=v[1],g[2]=v[2],g[3]=v[3],g},tt.set=function(g,v,S,C,z){return g[0]=v,g[1]=S,g[2]=C,g[3]=z,g},tt.add=function(g,v,S){return g[0]=v[0]+S[0],g[1]=v[1]+S[1],g[2]=v[2]+S[2],g[3]=v[3]+S[3],g},tt.subtract=u,tt.multiply=a,tt.divide=h,tt.ceil=function(g,v){return g[0]=Math.ceil(v[0]),g[1]=Math.ceil(v[1]),g[2]=Math.ceil(v[2]),g[3]=Math.ceil(v[3]),g},tt.floor=function(g,v){return g[0]=Math.floor(v[0]),g[1]=Math.floor(v[1]),g[2]=Math.floor(v[2]),g[3]=Math.floor(v[3]),g},tt.min=function(g,v,S){return g[0]=Math.min(v[0],S[0]),g[1]=Math.min(v[1],S[1]),g[2]=Math.min(v[2],S[2]),g[3]=Math.min(v[3],S[3]),g},tt.max=function(g,v,S){return g[0]=Math.max(v[0],S[0]),g[1]=Math.max(v[1],S[1]),g[2]=Math.max(v[2],S[2]),g[3]=Math.max(v[3],S[3]),g},tt.round=function(g,v){return g[0]=Math.round(v[0]),g[1]=Math.round(v[1]),g[2]=Math.round(v[2]),g[3]=Math.round(v[3]),g},tt.scale=function(g,v,S){return g[0]=v[0]*S,g[1]=v[1]*S,g[2]=v[2]*S,g[3]=v[3]*S,g},tt.scaleAndAdd=function(g,v,S,C){return g[0]=v[0]+S[0]*C,g[1]=v[1]+S[1]*C,g[2]=v[2]+S[2]*C,g[3]=v[3]+S[3]*C,g},tt.distance=m,tt.squaredDistance=y,tt.length=T,tt.squaredLength=f,tt.negate=function(g,v){return g[0]=-v[0],g[1]=-v[1],g[2]=-v[2],g[3]=-v[3],g},tt.inverse=function(g,v){return g[0]=1/v[0],g[1]=1/v[1],g[2]=1/v[2],g[3]=1/v[3],g},tt.normalize=function(g,v){var S=v[0],C=v[1],z=v[2],O=v[3],B=S*S+C*C+z*z+O*O;return B>0&&(B=1/Math.sqrt(B)),g[0]=S*B,g[1]=C*B,g[2]=z*B,g[3]=O*B,g},tt.dot=function(g,v){return g[0]*v[0]+g[1]*v[1]+g[2]*v[2]+g[3]*v[3]},tt.cross=function(g,v,S,C){var z=S[0]*C[1]-S[1]*C[0],O=S[0]*C[2]-S[2]*C[0],B=S[0]*C[3]-S[3]*C[0],L=S[1]*C[2]-S[2]*C[1],V=S[1]*C[3]-S[3]*C[1],j=S[2]*C[3]-S[3]*C[2],W=v[0],te=v[1],ee=v[2],Q=v[3];return g[0]=te*j-ee*V+Q*L,g[1]=-W*j+ee*B-Q*O,g[2]=W*V-te*B+Q*z,g[3]=-W*L+te*O-ee*z,g},tt.lerp=function(g,v,S,C){var z=v[0],O=v[1],B=v[2],L=v[3];return g[0]=z+C*(S[0]-z),g[1]=O+C*(S[1]-O),g[2]=B+C*(S[2]-B),g[3]=L+C*(S[3]-L),g},tt.random=function(g,v){var S,C,z,O,B,L;v=v||1;do B=(S=2*e.RANDOM()-1)*S+(C=2*e.RANDOM()-1)*C;while(B>=1);do L=(z=2*e.RANDOM()-1)*z+(O=2*e.RANDOM()-1)*O;while(L>=1);var V=Math.sqrt((1-B)/L);return g[0]=v*S,g[1]=v*C,g[2]=v*z*V,g[3]=v*O*V,g},tt.transformMat4=function(g,v,S){var C=v[0],z=v[1],O=v[2],B=v[3];return g[0]=S[0]*C+S[4]*z+S[8]*O+S[12]*B,g[1]=S[1]*C+S[5]*z+S[9]*O+S[13]*B,g[2]=S[2]*C+S[6]*z+S[10]*O+S[14]*B,g[3]=S[3]*C+S[7]*z+S[11]*O+S[15]*B,g},tt.transformQuat=function(g,v,S){var C=v[0],z=v[1],O=v[2],B=S[0],L=S[1],V=S[2],j=S[3],W=j*C+L*O-V*z,te=j*z+V*C-B*O,ee=j*O+B*z-L*C,Q=-B*C-L*z-V*O;return g[0]=W*j+Q*-B+te*-V-ee*-L,g[1]=te*j+Q*-L+ee*-B-W*-V,g[2]=ee*j+Q*-V+W*-L-te*-B,g[3]=v[3],g},tt.zero=function(g){return g[0]=0,g[1]=0,g[2]=0,g[3]=0,g},tt.str=function(g){return"vec4("+g[0]+", "+g[1]+", "+g[2]+", "+g[3]+")"},tt.exactEquals=function(g,v){return g[0]===v[0]&&g[1]===v[1]&&g[2]===v[2]&&g[3]===v[3]},tt.equals=function(g,v){var S=g[0],C=g[1],z=g[2],O=g[3],B=v[0],L=v[1],V=v[2],j=v[3];return Math.abs(S-B)<=e.EPSILON*Math.max(1,Math.abs(S),Math.abs(B))&&Math.abs(C-L)<=e.EPSILON*Math.max(1,Math.abs(C),Math.abs(L))&&Math.abs(z-V)<=e.EPSILON*Math.max(1,Math.abs(z),Math.abs(V))&&Math.abs(O-j)<=e.EPSILON*Math.max(1,Math.abs(O),Math.abs(j))},tt.forEach=tt.sqrLen=tt.len=tt.sqrDist=tt.dist=tt.div=tt.mul=tt.sub=void 0;var e=function(g,v){if(g&&g.__esModule)return g;if(g===null||r(g)!=="object"&&typeof g!="function")return{default:g};var S=i(void 0);if(S&&S.has(g))return S.get(g);var C={},z=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var O in g)if(O!=="default"&&Object.prototype.hasOwnProperty.call(g,O)){var B=z?Object.getOwnPropertyDescriptor(g,O):null;B&&(B.get||B.set)?Object.defineProperty(C,O,B):C[O]=g[O]}return C.default=g,S&&S.set(g,C),C}(Me());function i(g){if(typeof WeakMap!="function")return null;var v=new WeakMap,S=new WeakMap;return(i=function(C){return C?S:v})(g)}function o(){var g=new e.ARRAY_TYPE(4);return e.ARRAY_TYPE!=Float32Array&&(g[0]=0,g[1]=0,g[2]=0,g[3]=0),g}function u(g,v,S){return g[0]=v[0]-S[0],g[1]=v[1]-S[1],g[2]=v[2]-S[2],g[3]=v[3]-S[3],g}function a(g,v,S){return g[0]=v[0]*S[0],g[1]=v[1]*S[1],g[2]=v[2]*S[2],g[3]=v[3]*S[3],g}function h(g,v,S){return g[0]=v[0]/S[0],g[1]=v[1]/S[1],g[2]=v[2]/S[2],g[3]=v[3]/S[3],g}function m(g,v){return Math.hypot(v[0]-g[0],v[1]-g[1],v[2]-g[2],v[3]-g[3])}function y(g,v){var S=v[0]-g[0],C=v[1]-g[1],z=v[2]-g[2],O=v[3]-g[3];return S*S+C*C+z*z+O*O}function T(g){return Math.hypot(g[0],g[1],g[2],g[3])}function f(g){var v=g[0],S=g[1],C=g[2],z=g[3];return v*v+S*S+C*C+z*z}tt.sub=u,tt.mul=a,tt.div=h,tt.dist=m,tt.sqrDist=y,tt.len=T,tt.sqrLen=f;var x,w=(x=o(),function(g,v,S,C,z,O){var B,L;for(v||(v=4),S||(S=0),L=C?Math.min(C*v+S,g.length):g.length,B=S;B<L;B+=v)x[0]=g[B],x[1]=g[B+1],x[2]=g[B+2],x[3]=g[B+3],z(x,x,O),g[B]=x[0],g[B+1]=x[1],g[B+2]=x[2],g[B+3]=x[3];return g});return tt.forEach=w,tt}function wi(){if(Oi)return It;function r(ie){return r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(me){return typeof me}:function(me){return me&&typeof Symbol=="function"&&me.constructor===Symbol&&me!==Symbol.prototype?"symbol":typeof me},r(ie)}Oi=1,Object.defineProperty(It,"__esModule",{value:!0}),It.create=m,It.identity=function(ie){return ie[0]=0,ie[1]=0,ie[2]=0,ie[3]=1,ie},It.setAxisAngle=y,It.getAxisAngle=function(ie,me){var xe=2*Math.acos(me[3]),ye=Math.sin(xe/2);return ye>e.EPSILON?(ie[0]=me[0]/ye,ie[1]=me[1]/ye,ie[2]=me[2]/ye):(ie[0]=1,ie[1]=0,ie[2]=0),xe},It.getAngle=function(ie,me){var xe=S(ie,me);return Math.acos(2*xe*xe-1)},It.multiply=T,It.rotateX=function(ie,me,xe){xe*=.5;var ye=me[0],we=me[1],Ae=me[2],Re=me[3],Ee=Math.sin(xe),$e=Math.cos(xe);return ie[0]=ye*$e+Re*Ee,ie[1]=we*$e+Ae*Ee,ie[2]=Ae*$e-we*Ee,ie[3]=Re*$e-ye*Ee,ie},It.rotateY=function(ie,me,xe){xe*=.5;var ye=me[0],we=me[1],Ae=me[2],Re=me[3],Ee=Math.sin(xe),$e=Math.cos(xe);return ie[0]=ye*$e-Ae*Ee,ie[1]=we*$e+Re*Ee,ie[2]=Ae*$e+ye*Ee,ie[3]=Re*$e-we*Ee,ie},It.rotateZ=function(ie,me,xe){xe*=.5;var ye=me[0],we=me[1],Ae=me[2],Re=me[3],Ee=Math.sin(xe),$e=Math.cos(xe);return ie[0]=ye*$e+we*Ee,ie[1]=we*$e-ye*Ee,ie[2]=Ae*$e+Re*Ee,ie[3]=Re*$e-Ae*Ee,ie},It.calculateW=function(ie,me){var xe=me[0],ye=me[1],we=me[2];return ie[0]=xe,ie[1]=ye,ie[2]=we,ie[3]=Math.sqrt(Math.abs(1-xe*xe-ye*ye-we*we)),ie},It.exp=f,It.ln=x,It.pow=function(ie,me,xe){return x(ie,me),v(ie,ie,xe),f(ie,ie),ie},It.slerp=w,It.random=function(ie){var me=e.RANDOM(),xe=e.RANDOM(),ye=e.RANDOM(),we=Math.sqrt(1-me),Ae=Math.sqrt(me);return ie[0]=we*Math.sin(2*Math.PI*xe),ie[1]=we*Math.cos(2*Math.PI*xe),ie[2]=Ae*Math.sin(2*Math.PI*ye),ie[3]=Ae*Math.cos(2*Math.PI*ye),ie},It.invert=function(ie,me){var xe=me[0],ye=me[1],we=me[2],Ae=me[3],Re=xe*xe+ye*ye+we*we+Ae*Ae,Ee=Re?1/Re:0;return ie[0]=-xe*Ee,ie[1]=-ye*Ee,ie[2]=-we*Ee,ie[3]=Ae*Ee,ie},It.conjugate=function(ie,me){return ie[0]=-me[0],ie[1]=-me[1],ie[2]=-me[2],ie[3]=me[3],ie},It.fromMat3=g,It.fromEuler=function(ie,me,xe,ye){var we=.5*Math.PI/180;me*=we,xe*=we,ye*=we;var Ae=Math.sin(me),Re=Math.cos(me),Ee=Math.sin(xe),$e=Math.cos(xe),Qe=Math.sin(ye),qe=Math.cos(ye);return ie[0]=Ae*$e*qe-Re*Ee*Qe,ie[1]=Re*Ee*qe+Ae*$e*Qe,ie[2]=Re*$e*Qe-Ae*Ee*qe,ie[3]=Re*$e*qe+Ae*Ee*Qe,ie},It.str=function(ie){return"quat("+ie[0]+", "+ie[1]+", "+ie[2]+", "+ie[3]+")"},It.setAxes=It.sqlerp=It.rotationTo=It.equals=It.exactEquals=It.normalize=It.sqrLen=It.squaredLength=It.len=It.length=It.lerp=It.dot=It.scale=It.mul=It.add=It.set=It.copy=It.fromValues=It.clone=void 0;var e=h(Me()),i=h(zt()),o=h($i()),u=h(ai());function a(ie){if(typeof WeakMap!="function")return null;var me=new WeakMap,xe=new WeakMap;return(a=function(ye){return ye?xe:me})(ie)}function h(ie,me){if(ie&&ie.__esModule)return ie;if(ie===null||r(ie)!=="object"&&typeof ie!="function")return{default:ie};var xe=a(me);if(xe&&xe.has(ie))return xe.get(ie);var ye={},we=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Ae in ie)if(Ae!=="default"&&Object.prototype.hasOwnProperty.call(ie,Ae)){var Re=we?Object.getOwnPropertyDescriptor(ie,Ae):null;Re&&(Re.get||Re.set)?Object.defineProperty(ye,Ae,Re):ye[Ae]=ie[Ae]}return ye.default=ie,xe&&xe.set(ie,ye),ye}function m(){var ie=new e.ARRAY_TYPE(4);return e.ARRAY_TYPE!=Float32Array&&(ie[0]=0,ie[1]=0,ie[2]=0),ie[3]=1,ie}function y(ie,me,xe){xe*=.5;var ye=Math.sin(xe);return ie[0]=ye*me[0],ie[1]=ye*me[1],ie[2]=ye*me[2],ie[3]=Math.cos(xe),ie}function T(ie,me,xe){var ye=me[0],we=me[1],Ae=me[2],Re=me[3],Ee=xe[0],$e=xe[1],Qe=xe[2],qe=xe[3];return ie[0]=ye*qe+Re*Ee+we*Qe-Ae*$e,ie[1]=we*qe+Re*$e+Ae*Ee-ye*Qe,ie[2]=Ae*qe+Re*Qe+ye*$e-we*Ee,ie[3]=Re*qe-ye*Ee-we*$e-Ae*Qe,ie}function f(ie,me){var xe=me[0],ye=me[1],we=me[2],Ae=me[3],Re=Math.sqrt(xe*xe+ye*ye+we*we),Ee=Math.exp(Ae),$e=Re>0?Ee*Math.sin(Re)/Re:0;return ie[0]=xe*$e,ie[1]=ye*$e,ie[2]=we*$e,ie[3]=Ee*Math.cos(Re),ie}function x(ie,me){var xe=me[0],ye=me[1],we=me[2],Ae=me[3],Re=Math.sqrt(xe*xe+ye*ye+we*we),Ee=Re>0?Math.atan2(Re,Ae)/Re:0;return ie[0]=xe*Ee,ie[1]=ye*Ee,ie[2]=we*Ee,ie[3]=.5*Math.log(xe*xe+ye*ye+we*we+Ae*Ae),ie}function w(ie,me,xe,ye){var we,Ae,Re,Ee,$e,Qe=me[0],qe=me[1],_t=me[2],pt=me[3],rt=xe[0],et=xe[1],Pt=xe[2],yt=xe[3];return(Ae=Qe*rt+qe*et+_t*Pt+pt*yt)<0&&(Ae=-Ae,rt=-rt,et=-et,Pt=-Pt,yt=-yt),1-Ae>e.EPSILON?(we=Math.acos(Ae),Re=Math.sin(we),Ee=Math.sin((1-ye)*we)/Re,$e=Math.sin(ye*we)/Re):(Ee=1-ye,$e=ye),ie[0]=Ee*Qe+$e*rt,ie[1]=Ee*qe+$e*et,ie[2]=Ee*_t+$e*Pt,ie[3]=Ee*pt+$e*yt,ie}function g(ie,me){var xe,ye=me[0]+me[4]+me[8];if(ye>0)xe=Math.sqrt(ye+1),ie[3]=.5*xe,ie[0]=(me[5]-me[7])*(xe=.5/xe),ie[1]=(me[6]-me[2])*xe,ie[2]=(me[1]-me[3])*xe;else{var we=0;me[4]>me[0]&&(we=1),me[8]>me[3*we+we]&&(we=2);var Ae=(we+1)%3,Re=(we+2)%3;xe=Math.sqrt(me[3*we+we]-me[3*Ae+Ae]-me[3*Re+Re]+1),ie[we]=.5*xe,ie[3]=(me[3*Ae+Re]-me[3*Re+Ae])*(xe=.5/xe),ie[Ae]=(me[3*Ae+we]+me[3*we+Ae])*xe,ie[Re]=(me[3*Re+we]+me[3*we+Re])*xe}return ie}It.clone=u.clone,It.fromValues=u.fromValues,It.copy=u.copy,It.set=u.set,It.add=u.add,It.mul=T;var v=u.scale;It.scale=v;var S=u.dot;It.dot=S,It.lerp=u.lerp;var C=u.length;It.length=C,It.len=C;var z=u.squaredLength;It.squaredLength=z,It.sqrLen=z;var O=u.normalize;It.normalize=O,It.exactEquals=u.exactEquals,It.equals=u.equals;var B,L,V,j=(B=o.create(),L=o.fromValues(1,0,0),V=o.fromValues(0,1,0),function(ie,me,xe){var ye=o.dot(me,xe);return ye<-.999999?(o.cross(B,L,me),o.len(B)<1e-6&&o.cross(B,V,me),o.normalize(B,B),y(ie,B,Math.PI),ie):ye>.999999?(ie[0]=0,ie[1]=0,ie[2]=0,ie[3]=1,ie):(o.cross(B,me,xe),ie[0]=B[0],ie[1]=B[1],ie[2]=B[2],ie[3]=1+ye,O(ie,ie))});It.rotationTo=j;var W,te,ee=(W=m(),te=m(),function(ie,me,xe,ye,we,Ae){return w(W,me,we,Ae),w(te,xe,ye,Ae),w(ie,W,te,2*Ae*(1-Ae)),ie});It.sqlerp=ee;var Q,pe=(Q=i.create(),function(ie,me,xe,ye){return Q[0]=xe[0],Q[3]=xe[1],Q[6]=xe[2],Q[1]=ye[0],Q[4]=ye[1],Q[7]=ye[2],Q[2]=-me[0],Q[5]=-me[1],Q[8]=-me[2],O(ie,g(ie,Q))});return It.setAxes=pe,It}var Wi,Zt={};function Fn(){if(Wi)return Zt;function r(w){return r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(g){return typeof g}:function(g){return g&&typeof Symbol=="function"&&g.constructor===Symbol&&g!==Symbol.prototype?"symbol":typeof g},r(w)}Wi=1,Object.defineProperty(Zt,"__esModule",{value:!0}),Zt.create=function(){var w=new e.ARRAY_TYPE(8);return e.ARRAY_TYPE!=Float32Array&&(w[0]=0,w[1]=0,w[2]=0,w[4]=0,w[5]=0,w[6]=0,w[7]=0),w[3]=1,w},Zt.clone=function(w){var g=new e.ARRAY_TYPE(8);return g[0]=w[0],g[1]=w[1],g[2]=w[2],g[3]=w[3],g[4]=w[4],g[5]=w[5],g[6]=w[6],g[7]=w[7],g},Zt.fromValues=function(w,g,v,S,C,z,O,B){var L=new e.ARRAY_TYPE(8);return L[0]=w,L[1]=g,L[2]=v,L[3]=S,L[4]=C,L[5]=z,L[6]=O,L[7]=B,L},Zt.fromRotationTranslationValues=function(w,g,v,S,C,z,O){var B=new e.ARRAY_TYPE(8);B[0]=w,B[1]=g,B[2]=v,B[3]=S;var L=.5*C,V=.5*z,j=.5*O;return B[4]=L*S+V*v-j*g,B[5]=V*S+j*w-L*v,B[6]=j*S+L*g-V*w,B[7]=-L*w-V*g-j*v,B},Zt.fromRotationTranslation=h,Zt.fromTranslation=function(w,g){return w[0]=0,w[1]=0,w[2]=0,w[3]=1,w[4]=.5*g[0],w[5]=.5*g[1],w[6]=.5*g[2],w[7]=0,w},Zt.fromRotation=function(w,g){return w[0]=g[0],w[1]=g[1],w[2]=g[2],w[3]=g[3],w[4]=0,w[5]=0,w[6]=0,w[7]=0,w},Zt.fromMat4=function(w,g){var v=i.create();o.getRotation(v,g);var S=new e.ARRAY_TYPE(3);return o.getTranslation(S,g),h(w,v,S),w},Zt.copy=m,Zt.identity=function(w){return w[0]=0,w[1]=0,w[2]=0,w[3]=1,w[4]=0,w[5]=0,w[6]=0,w[7]=0,w},Zt.set=function(w,g,v,S,C,z,O,B,L){return w[0]=g,w[1]=v,w[2]=S,w[3]=C,w[4]=z,w[5]=O,w[6]=B,w[7]=L,w},Zt.getDual=function(w,g){return w[0]=g[4],w[1]=g[5],w[2]=g[6],w[3]=g[7],w},Zt.setDual=function(w,g){return w[4]=g[0],w[5]=g[1],w[6]=g[2],w[7]=g[3],w},Zt.getTranslation=function(w,g){var v=g[4],S=g[5],C=g[6],z=g[7],O=-g[0],B=-g[1],L=-g[2],V=g[3];return w[0]=2*(v*V+z*O+S*L-C*B),w[1]=2*(S*V+z*B+C*O-v*L),w[2]=2*(C*V+z*L+v*B-S*O),w},Zt.translate=function(w,g,v){var S=g[0],C=g[1],z=g[2],O=g[3],B=.5*v[0],L=.5*v[1],V=.5*v[2],j=g[4],W=g[5],te=g[6],ee=g[7];return w[0]=S,w[1]=C,w[2]=z,w[3]=O,w[4]=O*B+C*V-z*L+j,w[5]=O*L+z*B-S*V+W,w[6]=O*V+S*L-C*B+te,w[7]=-S*B-C*L-z*V+ee,w},Zt.rotateX=function(w,g,v){var S=-g[0],C=-g[1],z=-g[2],O=g[3],B=g[4],L=g[5],V=g[6],j=g[7],W=B*O+j*S+L*z-V*C,te=L*O+j*C+V*S-B*z,ee=V*O+j*z+B*C-L*S,Q=j*O-B*S-L*C-V*z;return i.rotateX(w,g,v),w[4]=W*(O=w[3])+Q*(S=w[0])+te*(z=w[2])-ee*(C=w[1]),w[5]=te*O+Q*C+ee*S-W*z,w[6]=ee*O+Q*z+W*C-te*S,w[7]=Q*O-W*S-te*C-ee*z,w},Zt.rotateY=function(w,g,v){var S=-g[0],C=-g[1],z=-g[2],O=g[3],B=g[4],L=g[5],V=g[6],j=g[7],W=B*O+j*S+L*z-V*C,te=L*O+j*C+V*S-B*z,ee=V*O+j*z+B*C-L*S,Q=j*O-B*S-L*C-V*z;return i.rotateY(w,g,v),w[4]=W*(O=w[3])+Q*(S=w[0])+te*(z=w[2])-ee*(C=w[1]),w[5]=te*O+Q*C+ee*S-W*z,w[6]=ee*O+Q*z+W*C-te*S,w[7]=Q*O-W*S-te*C-ee*z,w},Zt.rotateZ=function(w,g,v){var S=-g[0],C=-g[1],z=-g[2],O=g[3],B=g[4],L=g[5],V=g[6],j=g[7],W=B*O+j*S+L*z-V*C,te=L*O+j*C+V*S-B*z,ee=V*O+j*z+B*C-L*S,Q=j*O-B*S-L*C-V*z;return i.rotateZ(w,g,v),w[4]=W*(O=w[3])+Q*(S=w[0])+te*(z=w[2])-ee*(C=w[1]),w[5]=te*O+Q*C+ee*S-W*z,w[6]=ee*O+Q*z+W*C-te*S,w[7]=Q*O-W*S-te*C-ee*z,w},Zt.rotateByQuatAppend=function(w,g,v){var S=v[0],C=v[1],z=v[2],O=v[3],B=g[0],L=g[1],V=g[2],j=g[3];return w[0]=B*O+j*S+L*z-V*C,w[1]=L*O+j*C+V*S-B*z,w[2]=V*O+j*z+B*C-L*S,w[3]=j*O-B*S-L*C-V*z,w[4]=(B=g[4])*O+(j=g[7])*S+(L=g[5])*z-(V=g[6])*C,w[5]=L*O+j*C+V*S-B*z,w[6]=V*O+j*z+B*C-L*S,w[7]=j*O-B*S-L*C-V*z,w},Zt.rotateByQuatPrepend=function(w,g,v){var S=g[0],C=g[1],z=g[2],O=g[3],B=v[0],L=v[1],V=v[2],j=v[3];return w[0]=S*j+O*B+C*V-z*L,w[1]=C*j+O*L+z*B-S*V,w[2]=z*j+O*V+S*L-C*B,w[3]=O*j-S*B-C*L-z*V,w[4]=S*(j=v[7])+O*(B=v[4])+C*(V=v[6])-z*(L=v[5]),w[5]=C*j+O*L+z*B-S*V,w[6]=z*j+O*V+S*L-C*B,w[7]=O*j-S*B-C*L-z*V,w},Zt.rotateAroundAxis=function(w,g,v,S){if(Math.abs(S)<e.EPSILON)return m(w,g);var C=Math.hypot(v[0],v[1],v[2]);S*=.5;var z=Math.sin(S),O=z*v[0]/C,B=z*v[1]/C,L=z*v[2]/C,V=Math.cos(S),j=g[0],W=g[1],te=g[2],ee=g[3];w[0]=j*V+ee*O+W*L-te*B,w[1]=W*V+ee*B+te*O-j*L,w[2]=te*V+ee*L+j*B-W*O,w[3]=ee*V-j*O-W*B-te*L;var Q=g[4],pe=g[5],ie=g[6],me=g[7];return w[4]=Q*V+me*O+pe*L-ie*B,w[5]=pe*V+me*B+ie*O-Q*L,w[6]=ie*V+me*L+Q*B-pe*O,w[7]=me*V-Q*O-pe*B-ie*L,w},Zt.add=function(w,g,v){return w[0]=g[0]+v[0],w[1]=g[1]+v[1],w[2]=g[2]+v[2],w[3]=g[3]+v[3],w[4]=g[4]+v[4],w[5]=g[5]+v[5],w[6]=g[6]+v[6],w[7]=g[7]+v[7],w},Zt.multiply=y,Zt.scale=function(w,g,v){return w[0]=g[0]*v,w[1]=g[1]*v,w[2]=g[2]*v,w[3]=g[3]*v,w[4]=g[4]*v,w[5]=g[5]*v,w[6]=g[6]*v,w[7]=g[7]*v,w},Zt.lerp=function(w,g,v,S){var C=1-S;return T(g,v)<0&&(S=-S),w[0]=g[0]*C+v[0]*S,w[1]=g[1]*C+v[1]*S,w[2]=g[2]*C+v[2]*S,w[3]=g[3]*C+v[3]*S,w[4]=g[4]*C+v[4]*S,w[5]=g[5]*C+v[5]*S,w[6]=g[6]*C+v[6]*S,w[7]=g[7]*C+v[7]*S,w},Zt.invert=function(w,g){var v=x(g);return w[0]=-g[0]/v,w[1]=-g[1]/v,w[2]=-g[2]/v,w[3]=g[3]/v,w[4]=-g[4]/v,w[5]=-g[5]/v,w[6]=-g[6]/v,w[7]=g[7]/v,w},Zt.conjugate=function(w,g){return w[0]=-g[0],w[1]=-g[1],w[2]=-g[2],w[3]=g[3],w[4]=-g[4],w[5]=-g[5],w[6]=-g[6],w[7]=g[7],w},Zt.normalize=function(w,g){var v=x(g);if(v>0){v=Math.sqrt(v);var S=g[0]/v,C=g[1]/v,z=g[2]/v,O=g[3]/v,B=g[4],L=g[5],V=g[6],j=g[7],W=S*B+C*L+z*V+O*j;w[0]=S,w[1]=C,w[2]=z,w[3]=O,w[4]=(B-S*W)/v,w[5]=(L-C*W)/v,w[6]=(V-z*W)/v,w[7]=(j-O*W)/v}return w},Zt.str=function(w){return"quat2("+w[0]+", "+w[1]+", "+w[2]+", "+w[3]+", "+w[4]+", "+w[5]+", "+w[6]+", "+w[7]+")"},Zt.exactEquals=function(w,g){return w[0]===g[0]&&w[1]===g[1]&&w[2]===g[2]&&w[3]===g[3]&&w[4]===g[4]&&w[5]===g[5]&&w[6]===g[6]&&w[7]===g[7]},Zt.equals=function(w,g){var v=w[0],S=w[1],C=w[2],z=w[3],O=w[4],B=w[5],L=w[6],V=w[7],j=g[0],W=g[1],te=g[2],ee=g[3],Q=g[4],pe=g[5],ie=g[6],me=g[7];return Math.abs(v-j)<=e.EPSILON*Math.max(1,Math.abs(v),Math.abs(j))&&Math.abs(S-W)<=e.EPSILON*Math.max(1,Math.abs(S),Math.abs(W))&&Math.abs(C-te)<=e.EPSILON*Math.max(1,Math.abs(C),Math.abs(te))&&Math.abs(z-ee)<=e.EPSILON*Math.max(1,Math.abs(z),Math.abs(ee))&&Math.abs(O-Q)<=e.EPSILON*Math.max(1,Math.abs(O),Math.abs(Q))&&Math.abs(B-pe)<=e.EPSILON*Math.max(1,Math.abs(B),Math.abs(pe))&&Math.abs(L-ie)<=e.EPSILON*Math.max(1,Math.abs(L),Math.abs(ie))&&Math.abs(V-me)<=e.EPSILON*Math.max(1,Math.abs(V),Math.abs(me))},Zt.sqrLen=Zt.squaredLength=Zt.len=Zt.length=Zt.dot=Zt.mul=Zt.setReal=Zt.getReal=void 0;var e=a(Me()),i=a(wi()),o=a(Nt());function u(w){if(typeof WeakMap!="function")return null;var g=new WeakMap,v=new WeakMap;return(u=function(S){return S?v:g})(w)}function a(w,g){if(w&&w.__esModule)return w;if(w===null||r(w)!=="object"&&typeof w!="function")return{default:w};var v=u(g);if(v&&v.has(w))return v.get(w);var S={},C=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var z in w)if(z!=="default"&&Object.prototype.hasOwnProperty.call(w,z)){var O=C?Object.getOwnPropertyDescriptor(w,z):null;O&&(O.get||O.set)?Object.defineProperty(S,z,O):S[z]=w[z]}return S.default=w,v&&v.set(w,S),S}function h(w,g,v){var S=.5*v[0],C=.5*v[1],z=.5*v[2],O=g[0],B=g[1],L=g[2],V=g[3];return w[0]=O,w[1]=B,w[2]=L,w[3]=V,w[4]=S*V+C*L-z*B,w[5]=C*V+z*O-S*L,w[6]=z*V+S*B-C*O,w[7]=-S*O-C*B-z*L,w}function m(w,g){return w[0]=g[0],w[1]=g[1],w[2]=g[2],w[3]=g[3],w[4]=g[4],w[5]=g[5],w[6]=g[6],w[7]=g[7],w}function y(w,g,v){var S=g[0],C=g[1],z=g[2],O=g[3],B=v[4],L=v[5],V=v[6],j=v[7],W=g[4],te=g[5],ee=g[6],Q=g[7],pe=v[0],ie=v[1],me=v[2],xe=v[3];return w[0]=S*xe+O*pe+C*me-z*ie,w[1]=C*xe+O*ie+z*pe-S*me,w[2]=z*xe+O*me+S*ie-C*pe,w[3]=O*xe-S*pe-C*ie-z*me,w[4]=S*j+O*B+C*V-z*L+W*xe+Q*pe+te*me-ee*ie,w[5]=C*j+O*L+z*B-S*V+te*xe+Q*ie+ee*pe-W*me,w[6]=z*j+O*V+S*L-C*B+ee*xe+Q*me+W*ie-te*pe,w[7]=O*j-S*B-C*L-z*V+Q*xe-W*pe-te*ie-ee*me,w}Zt.getReal=i.copy,Zt.setReal=i.copy,Zt.mul=y;var T=i.dot;Zt.dot=T;var f=i.length;Zt.length=f,Zt.len=f;var x=i.squaredLength;return Zt.squaredLength=x,Zt.sqrLen=x,Zt}var Bn,Ln,qt={};function ls(){if(Bn)return qt;function r(g){return r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(v){return typeof v}:function(v){return v&&typeof Symbol=="function"&&v.constructor===Symbol&&v!==Symbol.prototype?"symbol":typeof v},r(g)}Bn=1,Object.defineProperty(qt,"__esModule",{value:!0}),qt.create=o,qt.clone=function(g){var v=new e.ARRAY_TYPE(2);return v[0]=g[0],v[1]=g[1],v},qt.fromValues=function(g,v){var S=new e.ARRAY_TYPE(2);return S[0]=g,S[1]=v,S},qt.copy=function(g,v){return g[0]=v[0],g[1]=v[1],g},qt.set=function(g,v,S){return g[0]=v,g[1]=S,g},qt.add=function(g,v,S){return g[0]=v[0]+S[0],g[1]=v[1]+S[1],g},qt.subtract=u,qt.multiply=a,qt.divide=h,qt.ceil=function(g,v){return g[0]=Math.ceil(v[0]),g[1]=Math.ceil(v[1]),g},qt.floor=function(g,v){return g[0]=Math.floor(v[0]),g[1]=Math.floor(v[1]),g},qt.min=function(g,v,S){return g[0]=Math.min(v[0],S[0]),g[1]=Math.min(v[1],S[1]),g},qt.max=function(g,v,S){return g[0]=Math.max(v[0],S[0]),g[1]=Math.max(v[1],S[1]),g},qt.round=function(g,v){return g[0]=Math.round(v[0]),g[1]=Math.round(v[1]),g},qt.scale=function(g,v,S){return g[0]=v[0]*S,g[1]=v[1]*S,g},qt.scaleAndAdd=function(g,v,S,C){return g[0]=v[0]+S[0]*C,g[1]=v[1]+S[1]*C,g},qt.distance=m,qt.squaredDistance=y,qt.length=T,qt.squaredLength=f,qt.negate=function(g,v){return g[0]=-v[0],g[1]=-v[1],g},qt.inverse=function(g,v){return g[0]=1/v[0],g[1]=1/v[1],g},qt.normalize=function(g,v){var S=v[0],C=v[1],z=S*S+C*C;return z>0&&(z=1/Math.sqrt(z)),g[0]=v[0]*z,g[1]=v[1]*z,g},qt.dot=function(g,v){return g[0]*v[0]+g[1]*v[1]},qt.cross=function(g,v,S){var C=v[0]*S[1]-v[1]*S[0];return g[0]=g[1]=0,g[2]=C,g},qt.lerp=function(g,v,S,C){var z=v[0],O=v[1];return g[0]=z+C*(S[0]-z),g[1]=O+C*(S[1]-O),g},qt.random=function(g,v){v=v||1;var S=2*e.RANDOM()*Math.PI;return g[0]=Math.cos(S)*v,g[1]=Math.sin(S)*v,g},qt.transformMat2=function(g,v,S){var C=v[0],z=v[1];return g[0]=S[0]*C+S[2]*z,g[1]=S[1]*C+S[3]*z,g},qt.transformMat2d=function(g,v,S){var C=v[0],z=v[1];return g[0]=S[0]*C+S[2]*z+S[4],g[1]=S[1]*C+S[3]*z+S[5],g},qt.transformMat3=function(g,v,S){var C=v[0],z=v[1];return g[0]=S[0]*C+S[3]*z+S[6],g[1]=S[1]*C+S[4]*z+S[7],g},qt.transformMat4=function(g,v,S){var C=v[0],z=v[1];return g[0]=S[0]*C+S[4]*z+S[12],g[1]=S[1]*C+S[5]*z+S[13],g},qt.rotate=function(g,v,S,C){var z=v[0]-S[0],O=v[1]-S[1],B=Math.sin(C),L=Math.cos(C);return g[0]=z*L-O*B+S[0],g[1]=z*B+O*L+S[1],g},qt.angle=function(g,v){var S=g[0],C=g[1],z=v[0],O=v[1],B=Math.sqrt(S*S+C*C)*Math.sqrt(z*z+O*O);return Math.acos(Math.min(Math.max(B&&(S*z+C*O)/B,-1),1))},qt.zero=function(g){return g[0]=0,g[1]=0,g},qt.str=function(g){return"vec2("+g[0]+", "+g[1]+")"},qt.exactEquals=function(g,v){return g[0]===v[0]&&g[1]===v[1]},qt.equals=function(g,v){var S=g[0],C=g[1],z=v[0],O=v[1];return Math.abs(S-z)<=e.EPSILON*Math.max(1,Math.abs(S),Math.abs(z))&&Math.abs(C-O)<=e.EPSILON*Math.max(1,Math.abs(C),Math.abs(O))},qt.forEach=qt.sqrLen=qt.sqrDist=qt.dist=qt.div=qt.mul=qt.sub=qt.len=void 0;var e=function(g,v){if(g&&g.__esModule)return g;if(g===null||r(g)!=="object"&&typeof g!="function")return{default:g};var S=i(void 0);if(S&&S.has(g))return S.get(g);var C={},z=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var O in g)if(O!=="default"&&Object.prototype.hasOwnProperty.call(g,O)){var B=z?Object.getOwnPropertyDescriptor(g,O):null;B&&(B.get||B.set)?Object.defineProperty(C,O,B):C[O]=g[O]}return C.default=g,S&&S.set(g,C),C}(Me());function i(g){if(typeof WeakMap!="function")return null;var v=new WeakMap,S=new WeakMap;return(i=function(C){return C?S:v})(g)}function o(){var g=new e.ARRAY_TYPE(2);return e.ARRAY_TYPE!=Float32Array&&(g[0]=0,g[1]=0),g}function u(g,v,S){return g[0]=v[0]-S[0],g[1]=v[1]-S[1],g}function a(g,v,S){return g[0]=v[0]*S[0],g[1]=v[1]*S[1],g}function h(g,v,S){return g[0]=v[0]/S[0],g[1]=v[1]/S[1],g}function m(g,v){return Math.hypot(v[0]-g[0],v[1]-g[1])}function y(g,v){var S=v[0]-g[0],C=v[1]-g[1];return S*S+C*C}function T(g){return Math.hypot(g[0],g[1])}function f(g){var v=g[0],S=g[1];return v*v+S*S}qt.len=T,qt.sub=u,qt.mul=a,qt.div=h,qt.dist=m,qt.sqrDist=y,qt.sqrLen=f;var x,w=(x=o(),function(g,v,S,C,z,O){var B,L;for(v||(v=2),S||(S=0),L=C?Math.min(C*v+S,g.length):g.length,B=S;B<L;B+=v)x[0]=g[B],x[1]=g[B+1],z(x,x,O),g[B]=x[0],g[B+1]=x[1];return g});return qt.forEach=w,qt}function nr(){if(Ln)return oe;function r(g){return r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(v){return typeof v}:function(v){return v&&typeof Symbol=="function"&&v.constructor===Symbol&&v!==Symbol.prototype?"symbol":typeof v},r(g)}Ln=1,Object.defineProperty(oe,"__esModule",{value:!0}),oe.vec4=oe.vec3=oe.vec2=oe.quat2=oe.quat=oe.mat4=oe.mat3=oe.mat2d=oe.mat2=oe.glMatrix=void 0;var e=w(Me());oe.glMatrix=e;var i=w(We());oe.mat2=i;var o=w(gt());oe.mat2d=o;var u=w(zt());oe.mat3=u;var a=w(Nt());oe.mat4=a;var h=w(wi());oe.quat=h;var m=w(Fn());oe.quat2=m;var y=w(ls());oe.vec2=y;var T=w($i());oe.vec3=T;var f=w(ai());function x(g){if(typeof WeakMap!="function")return null;var v=new WeakMap,S=new WeakMap;return(x=function(C){return C?S:v})(g)}function w(g,v){if(g&&g.__esModule)return g;if(g===null||r(g)!=="object"&&typeof g!="function")return{default:g};var S=x(v);if(S&&S.has(g))return S.get(g);var C={},z=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var O in g)if(O!=="default"&&Object.prototype.hasOwnProperty.call(g,O)){var B=z?Object.getOwnPropertyDescriptor(g,O):null;B&&(B.get||B.set)?Object.defineProperty(C,O,B):C[O]=g[O]}return C.default=g,S&&S.set(g,C),C}return oe.vec4=f,oe}var Bs,Ns,cs,ga,Se=nr(),ya=function(){if(Ns)return Bs;function r(e,i,o,u){this.cx=3*e,this.bx=3*(o-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*i,this.by=3*(u-i)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=i,this.p2x=o,this.p2y=u}return Ns=1,Bs=r,r.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,i){if(i===void 0&&(i=1e-6),e<0)return 0;if(e>1)return 1;for(var o=e,u=0;u<8;u++){var a=this.sampleCurveX(o)-e;if(Math.abs(a)<i)return o;var h=this.sampleCurveDerivativeX(o);if(Math.abs(h)<1e-6)break;o-=a/h}var m=0,y=1;for(o=e,u=0;u<20&&(a=this.sampleCurveX(o),!(Math.abs(a-e)<i));u++)e>a?m=o:y=o,o=.5*(y-m)+m;return o},solve:function(e,i){return this.sampleCurveY(this.solveCurveX(e,i))}},Bs}(),xa=_e(ya);function ko(){if(ga)return cs;function r(e,i){this.x=e,this.y=i}return ga=1,cs=r,r.prototype={clone:function(){return new r(this.x,this.y)},add:function(e){return this.clone()._add(e)},sub:function(e){return this.clone()._sub(e)},multByPoint:function(e){return this.clone()._multByPoint(e)},divByPoint:function(e){return this.clone()._divByPoint(e)},mult:function(e){return this.clone()._mult(e)},div:function(e){return this.clone()._div(e)},rotate:function(e){return this.clone()._rotate(e)},rotateAround:function(e,i){return this.clone()._rotateAround(e,i)},matMult:function(e){return this.clone()._matMult(e)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(e){return this.x===e.x&&this.y===e.y},dist:function(e){return Math.sqrt(this.distSqr(e))},distSqr:function(e){var i=e.x-this.x,o=e.y-this.y;return i*i+o*o},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith:function(e){return this.angleWithSep(e.x,e.y)},angleWithSep:function(e,i){return Math.atan2(this.x*i-this.y*e,this.x*e+this.y*i)},_matMult:function(e){var i=e[2]*this.x+e[3]*this.y;return this.x=e[0]*this.x+e[1]*this.y,this.y=i,this},_add:function(e){return this.x+=e.x,this.y+=e.y,this},_sub:function(e){return this.x-=e.x,this.y-=e.y,this},_mult:function(e){return this.x*=e,this.y*=e,this},_div:function(e){return this.x/=e,this.y/=e,this},_multByPoint:function(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint:function(e){return this.x/=e.x,this.y/=e.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var e=this.y;return this.y=this.x,this.x=-e,this},_rotate:function(e){var i=Math.cos(e),o=Math.sin(e),u=o*this.x+i*this.y;return this.x=i*this.x-o*this.y,this.y=u,this},_rotateAround:function(e,i){var o=Math.cos(e),u=Math.sin(e),a=i.y+u*(this.x-i.x)+o*(this.y-i.y);return this.x=i.x+o*(this.x-i.x)-u*(this.y-i.y),this.y=a,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},r.convert=function(e){return e instanceof r?e:Array.isArray(e)?new r(e[0],e[1]):e},cs}var ft=_e(ko());function rr(r,e){if(Array.isArray(r)){if(!Array.isArray(e)||r.length!==e.length)return!1;for(let i=0;i<r.length;i++)if(!rr(r[i],e[i]))return!1;return!0}if(typeof r=="object"&&r!==null&&e!==null){if(typeof e!="object"||Object.keys(r).length!==Object.keys(e).length)return!1;for(const i in r)if(!rr(r[i],e[i]))return!1;return!0}return r===e}const hr=Math.PI/180,va=180/Math.PI;function pi(r){return r*hr}function Nn(r){return r*va}const Br=[[0,0],[1,0],[1,1],[0,1]];function ao(r){if(r<=0)return 0;if(r>=1)return 1;const e=r*r,i=e*r;return 4*(r<.5?i:3*(r-e)+i-.75)}function Oo(r,e,i,o){const u=new xa(r,e,i,o);return function(a){return u.solve(a)}}const Fo=Oo(.25,.1,.25,1);function ri(r,e,i){return Math.min(i,Math.max(e,r))}function us(r,e,i){return(i=ri((i-r)/(e-r),0,1))*i*(3-2*i)}function Xr(r,e,i){const o=i-e,u=((r-e)%o+o)%o+e;return u===e?i:u}function lo(r,e,i){if(!r.length)return i(null,[]);let o=r.length;const u=new Array(r.length);let a=null;r.forEach((h,m)=>{e(h,(y,T)=>{y&&(a=y),u[m]=T,--o==0&&i(a,u)})})}function sr(r,...e){for(const i of e)for(const o in i)r[o]=i[o];return r}let Vs=1;function Bo(){return Vs++}function ba(r){return r<=1?1:Math.pow(2,Math.ceil(Math.log(r)/Math.LN2))}function wa(r,e){r.forEach(i=>{e[i]&&(e[i]=e[i].bind(e))})}function dr(r,e){return r.indexOf(e,r.length-e.length)!==-1}function Ta(r,e,i){const o={};for(const u in r)o[u]=e.call(this,r[u],u,r);return o}function Sa(r,e,i){const o={};for(const u in r)e.call(this,r[u],u,r)&&(o[u]=r[u]);return o}function Mr(r){return Array.isArray(r)?r.map(Mr):typeof r=="object"&&r?Ta(r,Mr):r}const No={};function ti(r){No[r]||(typeof console<"u"&&console.warn(r),No[r]=!0)}function hs(r,e,i){return(i.y-r.y)*(e.x-r.x)>(e.y-r.y)*(i.x-r.x)}function Pc(r){let e=0;for(let i,o,u=0,a=r.length,h=a-1;u<a;h=u++)i=r[u],o=r[h],e+=(o.x-i.x)*(i.y+o.y);return e}function xr([r,e,i]){const o=pi(e+90),u=pi(i);return{x:r*Math.cos(o)*Math.sin(u),y:r*Math.sin(o)*Math.sin(u),z:r*Math.cos(u),azimuthal:e,polar:i}}function Us(){return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope}function Ea(r){const e={};if(r.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(i,o,u,a)=>{const h=u||a;return e[o]=!h||h.toLowerCase(),""}),e["max-age"]){const i=parseInt(e["max-age"],10);isNaN(i)?delete e["max-age"]:e["max-age"]=i}return e}let Ma=null;function Ia(r,e){return[r[4*e],r[4*e+1],r[4*e+2],r[4*e+3]]}function zc(r,e,i,o){for(;e<i;){const u=e+i>>1;r[u]<o?e=u+1:i=u}return e}function Aa(r,e,i,o){for(;e<i;){const u=e+i>>1;r[u]<=o?e=u+1:i=u}return e}function Rc(r){return r>0?1/(1.001-r):1+r}function Dc(r){return r>0?1-1/(1.001-r):-r}const Mn={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!Mn.API_URL)return null;try{const r=new URL(Mn.API_URL);return r.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":r.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function fl(r){return Mn.API_URL_REGEX.test(r)}function Lc(r){return Mn.API_SPRITE_REGEX.test(r)}let pl,$n,ds,Ne,G,X;function K(){return pl==null&&(pl=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),pl}const ue={now:()=>Ne!==void 0?Ne:performance.now(),setNow(r){Ne=r},restoreNow(){Ne=void 0},frame(r){const e=requestAnimationFrame(r);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(r,e=0){const{width:i,height:o}=r;G||(G=document.createElement("canvas"));const u=G.getContext("2d",{willReadFrequently:!0});if(!u)throw new Error("failed to create canvas 2d context");return(i>G.width||o>G.height)&&(G.width=i,G.height=o),u.clearRect(-e,-e,i+2*e,o+2*e),u.drawImage(r,0,0,i,o),u.getImageData(-e,-e,i+2*e,o+2*e)},resolveURL:r=>($n||($n=document.createElement("a")),$n.href=r,$n.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(ds==null&&(ds=window.matchMedia("(prefers-reduced-motion: reduce)")),ds.matches)},hasCanvasFingerprintNoise(){if(X!==void 0)return X;if(!K())return X=!1,!1;const r=new OffscreenCanvas(85,1),e=r.getContext("2d",{willReadFrequently:!0});let i=0;for(let u=0;u<r.width;++u)e.fillStyle=`rgba(${i++},${i++},${i++}, 255)`,e.fillRect(u,0,1,1);const o=e.getImageData(0,0,r.width,r.height);i=0;for(let u=0;u<o.data.length;++u)if(u%4!=3&&i++!==o.data[u])return X=!0,!0;return X=!1,!1}};function fe(r,e){const i=r.indexOf("?");if(i<0)return`${r}?${new URLSearchParams(e).toString()}`;const o=new URLSearchParams(r.slice(i));for(const u in e)o.set(u,e[u]);return`${r.slice(0,i)}?${o.toString()}`}function ve(r,e={persistentParams:[]}){const i=r.indexOf("?");if(i<0)return r;const o=new URLSearchParams,u=new URLSearchParams(r.slice(i));for(const h of e.persistentParams){const m=u.get(h);m&&o.set(h,m)}const a=o.toString();return`${r.slice(0,i)}${a.length>0?`?${a}`:""}`}const Pe="mapbox-tiles";let be=500,Fe=50;const Oe=["language","worldview","jobid"];let Be,Ke;function ht(){try{return caches}catch{}}function dt(){const r=ht();r&&Be==null&&(Be=r.open(Pe))}let Ot=1/0;const Ut={supported:!1,testSupport:function(r){!di&&Vt&&(gi?vi(r):jt=r)}};let jt,Vt,di=!1,gi=!1;const si=typeof self<"u"?self:{};function vi(r){const e=r.createTexture();r.bindTexture(r.TEXTURE_2D,e);try{if(r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,Vt),r.isContextLost())return;Ut.supported=!0}catch{}r.deleteTexture(e),di=!0}si.document&&(Vt=si.document.createElement("img"),Vt.onload=function(){jt&&vi(jt),jt=null,gi=!0},Vt.onerror=function(){di=!0,jt=null},Vt.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Si={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(Si);class fn extends Error{constructor(e,i,o){i===401&&fl(o)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=i,this.url=o}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const fs=Us()?()=>self.worker&&self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,In=function(r,e){if(!(/^file:/.test(i=r.url)||/^file:/.test(fs())&&!/^\w+:/.test(i))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(o,u){const a=new AbortController,h=new Request(o.url,{method:o.method||"GET",body:o.body,credentials:o.credentials,headers:o.headers,referrer:fs(),referrerPolicy:o.referrerPolicy,signal:a.signal});let m=!1,y=!1;const T=(f=h.url).indexOf("sku=")>0&&fl(f);var f;o.type==="json"&&h.headers.set("Accept","application/json");const x=(g,v,S)=>{if(y)return;if(g&&g.message!=="SecurityError"&&ti(g.toString()),v&&S)return w(v);const C=Date.now();fetch(h).then(z=>{if(z.ok){const O=T?z.clone():null;return w(z,O,C)}return u(new fn(z.statusText,z.status,o.url))}).catch(z=>{z.name!=="AbortError"&&u(new Error(`${z.message} ${o.url}`))})},w=(g,v,S)=>{(o.type==="arrayBuffer"?g.arrayBuffer():o.type==="json"?g.json():g.text()).then(C=>{y||(v&&S&&function(z,O,B){if(dt(),Be==null)return;const L=Ea(O.headers.get("Cache-Control")||"");if(L["no-store"])return;const V={status:O.status,statusText:O.statusText,headers:new Headers};O.headers.forEach((te,ee)=>V.headers.set(ee,te)),L["max-age"]&&V.headers.set("Expires",new Date(B+1e3*L["max-age"]).toUTCString());const j=V.headers.get("Expires");if(!j||new Date(j).getTime()-B<42e4)return;let W=ve(z.url,{persistentParams:Oe});if(O.status===206){const te=z.headers.get("Range");if(!te)return;V.status=200,W=fe(W,{range:te})}(function(te,ee){if(Ke===void 0)try{new Response(new ReadableStream),Ke=!0}catch{Ke=!1}Ke?ee(te.body):te.blob().then(ee)})(O,te=>{const ee=new Response((Q=O.status)!==200&&Q!==404&&[101,103,204,205,304].includes(Q)?null:te,V);var Q;dt(),Be!=null&&Be.then(pe=>pe.put(W,ee)).catch(pe=>ti(pe.message))})}(h,v,S),m=!0,u(null,C,g.headers.get("Cache-Control"),g.headers.get("Expires")))}).catch(C=>{y||u(new Error(C.message))})};return T?function(g,v){if(dt(),Be==null)return v(null);Be.then(S=>{let C=ve(g.url,{persistentParams:Oe});const z=g.headers.get("Range");z&&(C=fe(C,{range:z})),S.match(C).then(O=>{const B=function(L){if(!L)return!1;const V=new Date(L.headers.get("Expires")||0),j=Ea(L.headers.get("Cache-Control")||"");return V>Date.now()&&!j["no-cache"]}(O);S.delete(C),B&&S.put(C,O.clone()),v(null,O,B)}).catch(v)}).catch(v)}(h,x):x(null,null),{cancel:()=>{y=!0,m||a.abort()}}}(r,e);if(Us()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",r,e,void 0,!0)}var i;return function(o,u){const a=new XMLHttpRequest;a.open(o.method||"GET",o.url,!0),o.type==="arrayBuffer"&&(a.responseType="arraybuffer");for(const h in o.headers)a.setRequestHeader(h,o.headers[h]);return o.type==="json"&&(a.responseType="text",a.setRequestHeader("Accept","application/json")),a.withCredentials=o.credentials==="include",a.onerror=()=>{u(new Error(a.statusText))},a.onload=()=>{if((a.status>=200&&a.status<300||a.status===0)&&a.response!==null){let h=a.response;if(o.type==="json")try{h=JSON.parse(a.response)}catch(m){return u(m)}u(null,h,a.getResponseHeader("Cache-Control"),a.getResponseHeader("Expires"))}else u(new fn(a.statusText,a.status,o.url))},a.send(o.body),{cancel:()=>a.abort()}}(r,e)},Cn=function(r,e){return In(sr(r,{type:"arrayBuffer"}),e)};function or(r){const e=document.createElement("a");return e.href=r,e.protocol===location.protocol&&e.host===location.host}const ml="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let js,_l;js=[],_l=0;const ih=function(r,e){if(Ut.supported&&(r.headers||(r.headers={}),r.headers.accept="image/webp,*/*"),_l>=Mn.MAX_PARALLEL_IMAGE_REQUESTS){const a={requestParameters:r,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return js.push(a),a}_l++;let i=!1;const o=()=>{if(!i)for(i=!0,_l--;js.length&&_l<Mn.MAX_PARALLEL_IMAGE_REQUESTS;){const a=js.shift(),{requestParameters:h,callback:m,cancelled:y}=a;y||(a.cancel=ih(h,m).cancel)}},u=Cn(r,(a,h,m,y)=>{o(),a?e(a):h&&(self.createImageBitmap?function(T,f){const x=new Blob([new Uint8Array(T)],{type:"image/png"});createImageBitmap(x).then(w=>{f(null,w)}).catch(w=>{f(new Error(`Could not load image because of ${w.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(h,(T,f)=>e(T,f,m,y)):function(T,f){const x=new Image;x.onload=()=>{f(null,x),URL.revokeObjectURL(x.src),x.onload=null,requestAnimationFrame(()=>{x.src=ml})},x.onerror=()=>f(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const w=new Blob([new Uint8Array(T)],{type:"image/png"});x.src=T.byteLength?URL.createObjectURL(w):ml}(h,(T,f)=>e(T,f,m,y)))});return{cancel:()=>{u.cancel(),o()}}};var xf,nh,rh,ar={exports:{}},Yr={exports:{}},Gs={exports:{}},ps=function(){if(rh)return ar.exports;rh=1;var r=(xf||(xf=1,Yr.exports=function(i,o){var u,a,h,m,y,T,f,x;for(a=i.length-(u=3&i.length),h=o,y=3432918353,T=461845907,x=0;x<a;)f=255&i.charCodeAt(x)|(255&i.charCodeAt(++x))<<8|(255&i.charCodeAt(++x))<<16|(255&i.charCodeAt(++x))<<24,++x,h=27492+(65535&(m=5*(65535&(h=(h^=f=(65535&(f=(f=(65535&f)*y+(((f>>>16)*y&65535)<<16)&4294967295)<<15|f>>>17))*T+(((f>>>16)*T&65535)<<16)&4294967295)<<13|h>>>19))+((5*(h>>>16)&65535)<<16)&4294967295))+((58964+(m>>>16)&65535)<<16);switch(f=0,u){case 3:f^=(255&i.charCodeAt(x+2))<<16;case 2:f^=(255&i.charCodeAt(x+1))<<8;case 1:h^=f=(65535&(f=(f=(65535&(f^=255&i.charCodeAt(x)))*y+(((f>>>16)*y&65535)<<16)&4294967295)<<15|f>>>17))*T+(((f>>>16)*T&65535)<<16)&4294967295}return h^=i.length,h=2246822507*(65535&(h^=h>>>16))+((2246822507*(h>>>16)&65535)<<16)&4294967295,h=3266489909*(65535&(h^=h>>>13))+((3266489909*(h>>>16)&65535)<<16)&4294967295,(h^=h>>>16)>>>0}),Yr.exports),e=(nh||(nh=1,Gs.exports=function(i,o){for(var u,a=i.length,h=o^a,m=0;a>=4;)u=1540483477*(65535&(u=255&i.charCodeAt(m)|(255&i.charCodeAt(++m))<<8|(255&i.charCodeAt(++m))<<16|(255&i.charCodeAt(++m))<<24))+((1540483477*(u>>>16)&65535)<<16),h=1540483477*(65535&h)+((1540483477*(h>>>16)&65535)<<16)^(u=1540483477*(65535&(u^=u>>>24))+((1540483477*(u>>>16)&65535)<<16)),a-=4,++m;switch(a){case 3:h^=(255&i.charCodeAt(m+2))<<16;case 2:h^=(255&i.charCodeAt(m+1))<<8;case 1:h=1540483477*(65535&(h^=255&i.charCodeAt(m)))+((1540483477*(h>>>16)&65535)<<16)}return h=1540483477*(65535&(h^=h>>>13))+((1540483477*(h>>>16)&65535)<<16),(h^=h>>>15)>>>0}),Gs.exports);return ar.exports=r,ar.exports.murmur3=r,ar.exports.murmur2=e,ar.exports}(),Kr=_e(ps);class ms{constructor(e,...i){sr(this,i[0]||{}),this.type=e}}class kc extends ms{constructor(e,i={}){super("error",sr({error:e},i))}}function sh(r,e,i){i[r]&&i[r].indexOf(e)!==-1||(i[r]=i[r]||[],i[r].push(e))}function co(r,e,i){if(i&&i[r]){const o=i[r].indexOf(e);o!==-1&&i[r].splice(o,1)}}class uo{on(e,i){return this._listeners=this._listeners||{},sh(e,i,this._listeners),this}off(e,i){return co(e,i,this._listeners),co(e,i,this._oneTimeListeners),this}once(e,i){return i?(this._oneTimeListeners=this._oneTimeListeners||{},sh(e,i,this._oneTimeListeners),this):new Promise(o=>this.once(e,o))}fire(e,i){const o=typeof e=="string"?new ms(e,i):e,u=o.type;if(this.listens(u)){o.target=this;const a=this._listeners&&this._listeners[u]?this._listeners[u].slice():[];for(const y of a)y.call(this,o);const h=this._oneTimeListeners&&this._oneTimeListeners[u]?this._oneTimeListeners[u].slice():[];for(const y of h)co(u,y,this._oneTimeListeners),y.call(this,o);const m=this._eventedParent;m&&(sr(o,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),m.fire(o))}else o instanceof kc&&console.error(o.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,i){return this._eventedParent=e,this._eventedParentData=i,this}}var vf,oh={},Nr=function(){if(vf)return oh;vf=1;var r={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(a){return(a=Math.round(a))<0?0:a>255?255:a}function i(a){return e(a[a.length-1]==="%"?parseFloat(a)/100*255:parseInt(a))}function o(a){return(h=a[a.length-1]==="%"?parseFloat(a)/100:parseFloat(a))<0?0:h>1?1:h;var h}function u(a,h,m){return m<0?m+=1:m>1&&(m-=1),6*m<1?a+(h-a)*m*6:2*m<1?h:3*m<2?a+(h-a)*(2/3-m)*6:a}try{oh.parseCSSColor=function(a){var h,m=a.replace(/ /g,"").toLowerCase();if(m in r)return r[m].slice();if(m[0]==="#")return m.length===4?(h=parseInt(m.substr(1),16))>=0&&h<=4095?[(3840&h)>>4|(3840&h)>>8,240&h|(240&h)>>4,15&h|(15&h)<<4,1]:null:m.length===7&&(h=parseInt(m.substr(1),16))>=0&&h<=16777215?[(16711680&h)>>16,(65280&h)>>8,255&h,1]:null;var y=m.indexOf("("),T=m.indexOf(")");if(y!==-1&&T+1===m.length){var f=m.substr(0,y),x=m.substr(y+1,T-(y+1)).split(","),w=1;switch(f){case"rgba":if(x.length!==4)return null;w=o(x.pop());case"rgb":return x.length!==3?null:[i(x[0]),i(x[1]),i(x[2]),w];case"hsla":if(x.length!==4)return null;w=o(x.pop());case"hsl":if(x.length!==3)return null;var g=(parseFloat(x[0])%360+360)%360/360,v=o(x[1]),S=o(x[2]),C=S<=.5?S*(v+1):S+v-S*v,z=2*S-C;return[e(255*u(z,C,g+1/3)),e(255*u(z,C,g)),e(255*u(z,C,g-1/3)),w];default:return null}}return null}}catch{}return oh}();class Mi{constructor(e,i,o,u=1){this.r=e,this.g=i,this.b=o,this.a=u}static parse(e){if(!e)return;if(e instanceof Mi)return e;if(typeof e!="string")return;const i=Nr.parseCSSColor(e);return i?new Mi(i[0]/255*i[3],i[1]/255*i[3],i[2]/255*i[3],i[3]):void 0}toStringPremultipliedAlpha(){const[e,i,o,u]=this.a===0?[0,0,0,0]:[255*this.r/this.a,255*this.g/this.a,255*this.b/this.a,this.a];return`rgba(${Math.round(e)},${Math.round(i)},${Math.round(o)},${u})`}toString(){const[e,i,o,u]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*e)},${Math.round(255*i)},${Math.round(255*o)},${u})`}toRenderColor(e){const{r:i,g:o,b:u,a}=this;return new ah(e,i,o,u,a)}clone(){return new Mi(this.r,this.g,this.b,this.a)}}class ah{constructor(e,i,o,u,a){if(e){const h=e.image.height,m=h*h;i=a===0?0:i/a*(h-1),o=a===0?0:o/a*(h-1),u=a===0?0:u/a*(h-1);const y=Math.floor(i),T=Math.floor(o),f=Math.floor(u),x=Math.ceil(i),w=Math.ceil(o),g=Math.ceil(u),v=i-y,S=o-T,C=u-f,z=e.image.data,O=4*(y+T*m+f*h),B=4*(y+T*m+g*h),L=4*(y+w*m+f*h),V=4*(y+w*m+g*h),j=4*(x+T*m+f*h),W=4*(x+T*m+g*h),te=4*(x+w*m+f*h),ee=4*(x+w*m+g*h);if(O<0||ee>=z.length)throw new Error("out of range");this.r=Gt(Gt(Gt(z[O],z[B],C),Gt(z[L],z[V],C),S),Gt(Gt(z[j],z[W],C),Gt(z[te],z[ee],C),S),v)/255*a,this.g=Gt(Gt(Gt(z[O+1],z[B+1],C),Gt(z[L+1],z[V+1],C),S),Gt(Gt(z[j+1],z[W+1],C),Gt(z[te+1],z[ee+1],C),S),v)/255*a,this.b=Gt(Gt(Gt(z[O+2],z[B+2],C),Gt(z[L+2],z[V+2],C),S),Gt(Gt(z[j+2],z[W+2],C),Gt(z[te+2],z[ee+2],C),S),v)/255*a,this.a=a}else this.r=i,this.g=o,this.b=u,this.a=a}toArray(){const{r:e,g:i,b:o,a:u}=this;return u===0?[0,0,0,0]:[255*e/u,255*i/u,255*o/u,u]}toHslaArray(){if(this.a===0)return[0,0,0,0];const{r:e,g:i,b:o,a:u}=this,a=Math.min(Math.max(e/u,0),1),h=Math.min(Math.max(i/u,0),1),m=Math.min(Math.max(o/u,0),1),y=Math.min(a,h,m),T=Math.max(a,h,m),f=(y+T)/2;if(y===T)return[0,0,100*f,u];const x=T-y,w=f>.5?x/(2-T-y):x/(T+y);let g=0;return T===a?g=(h-m)/x+(h<m?6:0):T===h?g=(m-a)/x+2:T===m&&(g=(a-h)/x+4),g*=60,[Math.min(Math.max(g,0),360),Math.min(Math.max(100*w,0),100),Math.min(Math.max(100*f,0),100),u]}toArray01(){const{r:e,g:i,b:o,a:u}=this;return u===0?[0,0,0,0]:[e/u,i/u,o/u,u]}toArray01Scaled(e){const{r:i,g:o,b:u,a}=this;return a===0?[0,0,0]:[i/a*e,o/a*e,u/a*e]}toArray01PremultipliedAlpha(){const{r:e,g:i,b:o,a:u}=this;return[e,i,o,u]}toArray01Linear(){const{r:e,g:i,b:o,a:u}=this;return u===0?[0,0,0,0]:[Math.pow(e/u,2.2),Math.pow(i/u,2.2),Math.pow(o/u,2.2),u]}}function Gt(r,e,i){return r*(1-i)+e*i}function bf(r,e,i){return r.map((o,u)=>Gt(o,e[u],i))}Mi.black=new Mi(0,0,0,1),Mi.white=new Mi(1,1,1,1),Mi.transparent=new Mi(0,0,0,0),Mi.red=new Mi(1,0,0,1),Mi.blue=new Mi(0,0,1,1);var Oc=Object.freeze({__proto__:null,array:bf,color:function(r,e,i){return new Mi(Gt(r.r,e.r,i),Gt(r.g,e.g,i),Gt(r.b,e.b,i),Gt(r.a,e.a,i))},number:Gt});function Fc(r,...e){for(const i of e)for(const o in i)r[o]=i[o];return r}class li extends Error{constructor(e,i){super(i),this.message=i,this.key=e}}class Bc{constructor(e,i=[]){this.parent=e,this.bindings={};for(const[o,u]of i)this.bindings[o]=u}concat(e){return new Bc(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const Vo={kind:"null"},Ct={kind:"number"},Ci={kind:"string"},yi={kind:"boolean"},Yn={kind:"color"},qs={kind:"object"},Ti={kind:"value"},gl={kind:"collator"},_s={kind:"formatted"},yl={kind:"resolvedImage"};function Vn(r,e){return{kind:"array",itemType:r,N:e}}function on(r){if(r.kind==="array"){const e=on(r.itemType);return typeof r.N=="number"?`array<${e}, ${r.N}>`:r.itemType.kind==="value"?"array":`array<${e}>`}return r.kind}const lh=[Vo,Ct,Ci,yi,Yn,_s,qs,Vn(Ti),yl];function fr(r,e){if(e.kind==="error")return null;if(r.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!fr(r.itemType,e.itemType))&&(typeof r.N!="number"||r.N===e.N))return null}else{if(r.kind===e.kind)return null;if(r.kind==="value"){for(const i of lh)if(!fr(i,e))return null}}return`Expected ${on(r)} but found ${on(e)} instead.`}function Nc(r,e){return e.some(i=>i.kind===r.kind)}function xl(r,e){return e.some(i=>i==="null"?r===null:i==="array"?Array.isArray(r):i==="object"?r&&!Array.isArray(r)&&typeof r=="object":i===typeof r)}class Vc{constructor(e,i,o){this.sensitivity=e?i?"variant":"case":i?"accent":"base",this.locale=o,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,i){return this.collator.compare(e,i)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class vl{constructor(e,i,o,u,a){this.text=e.normalize?e.normalize():e,this.image=i,this.scale=o,this.fontStack=u,this.textColor=a}}class Kn{constructor(e){this.sections=e}static fromString(e){return new Kn([new vl(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||e.image&&e.image.namePrimary)}static factory(e){return e instanceof Kn?e:Kn.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}serialize(){const e=["format"];for(const i of this.sections){if(i.image){e.push(["image",i.image.namePrimary]);continue}e.push(i.text);const o={};i.fontStack&&(o["text-font"]=["literal",i.fontStack.split(",")]),i.scale&&(o["font-scale"]=i.scale),i.textColor&&(o["text-color"]=["rgba"].concat(i.textColor.toRenderColor(null).toArray())),e.push(o)}return e}}class gs{constructor(e,i){if(this.id=e,this.options=i||{params:{}},this.options.transform){const{a:o,b:u,c:a,d:h,e:m,f:y}=this.options.transform;this.options.transform=new DOMMatrix([o,u,a,h,m,y])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}static deserializeId(e){return JSON.parse(e).id}static deserializeFromString(e){const i=JSON.parse(e),{a:o,b:u,c:a,d:h,e:m,f:y}=i.options.transform;return new DOMMatrix([o,u,a,h,m,y]),new gs(i.id,i.options)}scaleSelf(e){return this.options.transform=this.options.transform.scale(e),this}serialize(){const e={id:this.id};this.options&&(e.options=this.options);const{a:i,b:o,c:u,d:a,e:h,f:m}=this.options.transform;return e.options.transform={a:i,b:o,c:u,d:a,e:h,f:m},JSON.stringify(e)}}class Zn{constructor(e){this.namePrimary=e.namePrimary,e.nameSecondary&&(this.nameSecondary=e.nameSecondary),e.optionsPrimary&&(this.optionsPrimary=e.optionsPrimary),e.optionsSecondary&&(this.optionsSecondary=e.optionsSecondary),this.available=e.available}toString(){return this.namePrimary&&this.nameSecondary?`[${this.namePrimary},${this.nameSecondary}]`:this.namePrimary}getPrimary(){return new gs(this.namePrimary,{params:this.optionsPrimary&&this.optionsPrimary.params||{}})}getSerializedPrimary(){return this.getPrimary().serialize()}getSecondary(){return this.nameSecondary?new gs(this.nameSecondary,{params:this.optionsSecondary&&this.optionsSecondary.params||{}}):null}static from(e){return typeof e=="string"?Zn.build(e):e}static build(e,i,o,u){return e?new Zn({namePrimary:e,nameSecondary:i,optionsPrimary:o,optionsSecondary:u,available:!1}):null}}function ch(r,e,i,o){return typeof r=="number"&&r>=0&&r<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof i=="number"&&i>=0&&i<=255?o===void 0||typeof o=="number"&&o>=0&&o<=1?null:`Invalid rgba value [${[r,e,i,o].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof o=="number"?[r,e,i,o]:[r,e,i]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function $s(r){if(r===null||typeof r=="string"||typeof r=="boolean"||typeof r=="number"||r instanceof Mi||r instanceof Vc||r instanceof Kn||r instanceof Zn)return!0;if(Array.isArray(r)){for(const e of r)if(!$s(e))return!1;return!0}if(typeof r=="object"){for(const e in r)if(!$s(r[e]))return!1;return!0}return!1}function nn(r){if(r===null)return Vo;if(typeof r=="string")return Ci;if(typeof r=="boolean")return yi;if(typeof r=="number")return Ct;if(r instanceof Mi)return Yn;if(r instanceof Vc)return gl;if(r instanceof Kn)return _s;if(r instanceof Zn)return yl;if(Array.isArray(r)){const e=r.length;let i;for(const o of r){const u=nn(o);if(i){if(i===u)continue;i=Ti;break}i=u}return Vn(i||Ti,e)}return qs}function Vr(r){const e=typeof r;return r===null?"":e==="string"||e==="number"||e==="boolean"?String(r):r instanceof Mi?r.toStringPremultipliedAlpha():r instanceof Kn||r instanceof Zn?r.toString():JSON.stringify(r)}class Un{constructor(e,i){this.type=e,this.value=i}static parse(e,i){if(e.length!==2)return i.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!$s(e[1]))return i.error("invalid value");const o=e[1];let u=nn(o);const a=i.expectedType;return u.kind!=="array"||u.N!==0||!a||a.kind!=="array"||typeof a.N=="number"&&a.N!==0||(u=a),new Un(u,o)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Mi?["rgba"].concat(this.value.toRenderColor(null).toArray()):this.value instanceof Kn?this.value.serialize():this.value}}class pn{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const bl={string:Ci,number:Ct,boolean:yi,object:qs};class Jr{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");let o,u=1;const a=e[0];if(a==="array"){let m,y;if(e.length>2){const T=e[1];if(typeof T!="string"||!(T in bl)||T==="object")return i.error('The item type argument of "array" must be one of string, number, boolean',1);m=bl[T],u++}else m=Ti;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return i.error('The length argument to "array" must be a positive integer literal',2);y=e[2],u++}o=Vn(m,y)}else o=bl[a];const h=[];for(;u<e.length;u++){const m=i.parse(e[u],u,Ti);if(!m)return null;h.push(m)}return new Jr(o,h)}evaluate(e){for(let i=0;i<this.args.length;i++){const o=this.args[i].evaluate(e);if(!fr(this.type,nn(o)))return o;if(i===this.args.length-1)throw new pn(`The expression ${JSON.stringify(this.args[i].serialize())} evaluated to ${on(nn(o))} but was expected to be of type ${on(this.type)}.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=this.type,i=[e.kind];if(e.kind==="array"){const o=e.itemType;if(o.kind==="string"||o.kind==="number"||o.kind==="boolean"){i.push(o.kind);const u=e.N;(typeof u=="number"||this.args.length>1)&&i.push(u)}}return i.concat(this.args.map(o=>o.serialize()))}}class Uo{constructor(e){this.type=_s,this.sections=e}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const o=e[1];if(!Array.isArray(o)&&typeof o=="object")return i.error("First argument must be an image or text section.");const u=[];let a=!1;for(let h=1;h<=e.length-1;++h){const m=e[h];if(a&&typeof m=="object"&&!Array.isArray(m)){a=!1;let y=null;if(m["font-scale"]&&(y=i.parseObjectValue(m["font-scale"],h,"font-scale",Ct),!y))return null;let T=null;if(m["text-font"]&&(T=i.parseObjectValue(m["text-font"],h,"text-font",Vn(Ci)),!T))return null;let f=null;if(m["text-color"]&&(f=i.parseObjectValue(m["text-color"],h,"text-color",Yn),!f))return null;const x=u[u.length-1];x.scale=y,x.font=T,x.textColor=f}else{const y=i.parse(e[h],h,Ti);if(!y)return null;const T=y.type.kind;if(T!=="string"&&T!=="value"&&T!=="null"&&T!=="resolvedImage")return i.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");a=!0,u.push({content:y,scale:null,font:null,textColor:null})}}return new Uo(u)}evaluate(e){return new Kn(this.sections.map(i=>{const o=i.content.evaluate(e);return nn(o)===yl?new vl("",o,null,null,null):new vl(Vr(o),null,i.scale?i.scale.evaluate(e):null,i.font?i.font.evaluate(e).join(","):null,i.textColor?i.textColor.evaluate(e):null)}))}eachChild(e){for(const i of this.sections)e(i.content),i.scale&&e(i.scale),i.font&&e(i.font),i.textColor&&e(i.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const i of this.sections){e.push(i.content.serialize());const o={};i.scale&&(o["font-scale"]=i.scale.serialize()),i.font&&(o["text-font"]=i.font.serialize()),i.textColor&&(o["text-color"]=i.textColor.serialize()),e.push(o)}return e}}class wl{constructor(e,i,o,u){this._imageWarnHistory={},this.type=yl,this.inputPrimary=e,this.inputSecondary=i,this.inputPrimaryParams=o,this.inputSecondaryParams=u}static parse(e,i){if(e.length<2)return i.error("Expected two or more arguments.");let o=1;const u=[];function a(){if(o<e.length){const m=i.parse(e[o],o++,Ci);return m?(u.push({image:m,options:void 0}),!0):(i.error(u.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function h(){if(o<e.length){if((m=e[o])===null||typeof m!="object"||Array.isArray(m))return!0;const y=e[o].params,T=i.concat(o);if(!y)return o++,!0;if(typeof y!="object"||y.constructor!==Object)return T.error('Image options "params" should be an object'),!1;const f={},x=T.concat(void 0,"params");for(const w in y){if(!w)return x.error("Image parameter name should be non-empty"),!1;const g=x.concat(void 0,w).parse(y[w],void 0,Yn,void 0,{typeAnnotation:"coerce"});if(!g)return!1;f[w]=g}return u[u.length-1].options=f,o++,!0}var m;return!0}for(let m=0;m<2;m++)if(!a()||!h())return;return new wl(u[0].image,u[1]?u[1].image:void 0,u[0].options,u[1]?u[1].options:void 0)}evaluateParams(e,i){const o={};if(i){for(const u in i)if(i[u])try{const a=i[u].evaluate(e),h=`Ignoring image parameter "${u}" with semi-transparent color ${a.toString()}`;if(a.a!==1){this._imageWarnHistory[h]||(console.warn(h),this._imageWarnHistory[h]=!0);continue}o[u]=a}catch{continue}if(Object.keys(o).length!==0)return{params:o}}}evaluate(e){const i=Zn.build(this.inputPrimary.evaluate(e),this.inputSecondary?this.inputSecondary.evaluate(e):void 0,this.inputPrimaryParams?this.evaluateParams(e,this.inputPrimaryParams):void 0,this.inputSecondaryParams?this.evaluateParams(e,this.inputSecondaryParams):void 0);return i&&e.availableImages&&(i.available=e.availableImages.indexOf(i.namePrimary)>-1,i.nameSecondary&&i.available&&e.availableImages&&(i.available=e.availableImages.indexOf(i.nameSecondary)>-1)),i}eachChild(e){if(e(this.inputPrimary),this.inputPrimaryParams)for(const i in this.inputPrimaryParams)this.inputPrimaryParams[i]&&e(this.inputPrimaryParams[i]);if(this.inputSecondary&&(e(this.inputSecondary),this.inputSecondaryParams))for(const i in this.inputSecondaryParams)this.inputSecondaryParams[i]&&e(this.inputSecondaryParams[i])}outputDefined(){return!1}serializeParams(e){const i={};if(e){for(const o in e)e[o]&&(i[o]=e[o].serialize());return{params:i}}}serialize(){const e=["image",this.inputPrimary.serialize()];return this.inputPrimaryParams&&e.push(this.serializeParams(this.inputPrimaryParams)),this.inputSecondary&&(e.push(this.inputSecondary.serialize()),this.inputSecondaryParams&&e.push(this.serializeParams(this.inputSecondaryParams))),e}}function Qr(r){return r instanceof Number?"number":r instanceof String?"string":r instanceof Boolean?"boolean":Array.isArray(r)?"array":r===null?"null":typeof r}const uh={"to-boolean":yi,"to-color":Yn,"to-number":Ct,"to-string":Ci};class Zs{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const o=e[0],u=[];let a=Vo;if(o==="to-array"){if(!Array.isArray(e[1]))return null;const h=e[1].length;if(i.expectedType){if(i.expectedType.kind!=="array")return i.error(`Expected ${i.expectedType.kind} but found array.`);a=Vn(i.expectedType.itemType,h)}else{if(!(h>0&&$s(e[1][0])))return null;a=Vn(nn(e[1][0]),h)}for(let m=0;m<h;m++){const y=e[1][m];let T;if(Qr(y)==="array")T=i.parse(y,void 0,a.itemType);else{const f=Qr(y);if(f!==a.itemType.kind)return i.error(`Expected ${a.itemType.kind} but found ${f}.`);T=i.registry.literal.parse(["literal",y===void 0?null:y],i)}if(!T)return null;u.push(T)}}else{if((o==="to-boolean"||o==="to-string")&&e.length!==2)return i.error("Expected one argument.");a=uh[o];for(let h=1;h<e.length;h++){const m=i.parse(e[h],h,Ti);if(!m)return null;u.push(m)}}return new Zs(a,u)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let i,o;for(const u of this.args){if(i=u.evaluate(e),o=null,i instanceof Mi)return i;if(typeof i=="string"){const a=e.parseColor(i);if(a)return a}else if(Array.isArray(i)&&(o=i.length<3||i.length>4?`Invalid rbga value ${JSON.stringify(i)}: expected an array containing either three or four numeric values.`:ch(i[0],i[1],i[2],i[3]),!o))return new Mi(i[0]/255,i[1]/255,i[2]/255,i[3])}throw new pn(o||`Could not parse color from value '${typeof i=="string"?i:String(JSON.stringify(i))}'`)}if(this.type.kind==="number"){let i=null;for(const o of this.args){if(i=o.evaluate(e),i===null)return 0;const u=Number(i);if(!isNaN(u))return u}throw new pn(`Could not convert ${JSON.stringify(i)} to number.`)}return this.type.kind==="formatted"?Kn.fromString(Vr(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?Zn.build(Vr(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map(i=>i.evaluate(e)):Vr(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if(this.type.kind==="formatted")return new Uo([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new wl(this.args[0]).serialize();const e=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(i=>{e.push(i.serialize())}),e}}const Gm=["Unknown","Point","LineString","Polygon"];class hh{constructor(e,i){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=i}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Gm[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,i=this.featureDistanceData.scale,{x:o,y:u}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(o*i-e[0])+this.featureDistanceData.bearing[1]*(u*i-e[1])}return 0}parseColor(e){let i=this._parseColorCache[e];return i||(i=this._parseColorCache[e]=Mi.parse(e)),i}getConfig(e){return this.options?this.options.get(e):null}}class pr{constructor(e,i,o,u,a){this.name=e,this.type=i,this._evaluate=o,this.args=u,this._overloadIndex=a}evaluate(e){if(!this._evaluate){const i=pr.definitions[this.name];this._evaluate=Array.isArray(i)?i[2]:i.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,i){const o=e[0],u=pr.definitions[o];if(!u)return i.error(`Unknown expression "${o}". If you wanted a literal array, use ["literal", [...]].`,0);const a=Array.isArray(u)?u[0]:u.type,h=Array.isArray(u)?[[u[1],u[2]]]:u.overloads,m=[];let y=null,T=-1;for(const[f,x]of h){if(Array.isArray(f)&&f.length!==e.length-1)continue;m.push(f),T++,y=new Rl(i.registry,i.path,null,i.scope,void 0,i._scope,i.options);const w=[];let g=!1;for(let v=1;v<e.length;v++){const S=e[v],C=Array.isArray(f)?f[v-1]:f.type,z=y.parse(S,1+w.length,C);if(!z){g=!0;break}w.push(z)}if(!g)if(Array.isArray(f)&&f.length!==w.length)y.error(`Expected ${f.length} arguments, but found ${w.length} instead.`);else{for(let v=0;v<w.length;v++){const S=Array.isArray(f)?f[v]:f.type,C=w[v];y.concat(v+1).checkSubtype(S,C.type)}if(y.errors.length===0)return new pr(o,a,x,w,T)}}if(m.length===1)i.errors.push(...y.errors);else{const f=(m.length?m:h.map(([w])=>w)).map(dh).join(" | "),x=[];for(let w=1;w<e.length;w++){const g=i.parse(e[w],1+x.length);if(!g)return null;x.push(on(g.type))}i.error(`Expected arguments of type ${f}, but found (${x.join(", ")}) instead.`)}return null}static register(e,i){pr.definitions=i;for(const o in i)e[o]=pr}}function dh(r){return Array.isArray(r)?`(${r.map(on).join(", ")})`:`(${on(r.type)}...)`}class Uc{constructor(e,i,o){this.type=gl,this.locale=o,this.caseSensitive=e,this.diacriticSensitive=i}static parse(e,i){if(e.length!==2)return i.error("Expected one argument.");const o=e[1];if(typeof o!="object"||Array.isArray(o))return i.error("Collator options argument must be an object.");const u=o["case-sensitive"]===void 0?i.parse(!1,1,yi):i.parseObjectValue(o["case-sensitive"],1,"case-sensitive",yi);if(!u)return null;const a=o["diacritic-sensitive"]===void 0?i.parse(!1,1,yi):i.parseObjectValue(o["diacritic-sensitive"],1,"diacritic-sensitive",yi);if(!a)return null;let h=null;return o.locale&&(h=i.parseObjectValue(o.locale,1,"locale",Ci),!h)?null:new Uc(u,a,h)}evaluate(e){return new Vc(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function Tl(r,e,i=0,o=r.length-1,u=qm){for(;o>i;){if(o-i>600){const y=o-i+1,T=e-i+1,f=Math.log(y),x=.5*Math.exp(2*f/3),w=.5*Math.sqrt(f*x*(y-x)/y)*(T-y/2<0?-1:1);Tl(r,e,Math.max(i,Math.floor(e-T*x/y+w)),Math.min(o,Math.floor(e+(y-T)*x/y+w)),u)}const a=r[e];let h=i,m=o;for(Sl(r,i,e),u(r[o],a)>0&&Sl(r,i,o);h<m;){for(Sl(r,h,m),h++,m--;u(r[h],a)<0;)h++;for(;u(r[m],a)>0;)m--}u(r[i],a)===0?Sl(r,i,m):(m++,Sl(r,m,o)),m<=e&&(i=m+1),e<=m&&(o=m-1)}}function Sl(r,e,i){const o=r[e];r[e]=r[i],r[i]=o}function qm(r,e){return r<e?-1:r>e?1:0}function $m(r){let e=0;for(let i,o,u=0,a=r.length,h=a-1;u<a;h=u++)i=r[u],o=r[h],e+=(o.x-i.x)*(i.y+o.y);return e}function El(r,e){r[0]=Math.min(r[0],e[0]),r[1]=Math.min(r[1],e[1]),r[2]=Math.max(r[2],e[0]),r[3]=Math.max(r[3],e[1])}function Ml(r,e){return!(r[0]<=e[0]||r[2]>=e[2]||r[1]<=e[1]||r[3]>=e[3])}function Zm(r,e,i){const o=r[0]-e[0],u=r[1]-e[1],a=r[0]-i[0],h=r[1]-i[1];return o*h-a*u==0&&o*a<=0&&u*h<=0}function Ca(r,e,i=!1){let o=!1;for(let m=0,y=e.length;m<y;m++){const T=e[m];for(let f=0,x=T.length,w=x-1;f<x;w=f++){const g=T[w],v=T[f];if(Zm(r,g,v))return i;(a=g)[1]>(u=r)[1]!=(h=v)[1]>u[1]&&u[0]<(h[0]-a[0])*(u[1]-a[1])/(h[1]-a[1])+a[0]&&(o=!o)}}var u,a,h;return o}function fh(r,e,i,o){const u=o[0]-i[0],a=o[1]-i[1],h=(r[0]-i[0])*a-u*(r[1]-i[1]),m=(e[0]-i[0])*a-u*(e[1]-i[1]);return h>0&&m<0||h<0&&m>0}function Hs(r,e,i,o){return(u=[o[0]-i[0],o[1]-i[1]])[0]*(a=[e[0]-r[0],e[1]-r[1]])[1]-u[1]*a[0]!=0&&!(!fh(r,e,i,o)||!fh(i,o,r,e));var u,a}const ho=8192;function Hm(r,e){const i=(180+r[0])/360,o=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r[1]*Math.PI/360)))/360,u=Math.pow(2,e.z);return[Math.round(i*u*ho),Math.round(o*u*ho)]}function ph(r,e){for(let i=0;i<e.length;i++)if(Ca(r,e[i]))return!0;return!1}function Wm(r,e,i){for(const o of i)for(let u=0,a=o.length,h=a-1;u<a;h=u++)if(Hs(r,e,o[h],o[u]))return!0;return!1}function wf(r,e){for(let i=0;i<r.length;++i)if(!Ca(r[i],e))return!1;for(let i=0;i<r.length-1;++i)if(Wm(r[i],r[i+1],e))return!1;return!0}function Xm(r,e){for(let i=0;i<e.length;i++)if(wf(r,e[i]))return!0;return!1}function mh(r,e,i){const o=[];for(let u=0;u<r.length;u++){const a=[];for(let h=0;h<r[u].length;h++){const m=Hm(r[u][h],i);El(e,m),a.push(m)}o.push(a)}return o}function jo(r,e,i){const o=[];for(let u=0;u<r.length;u++){const a=mh(r[u],e,i);o.push(a)}return o}function oi(r,e,i,o){if(r[0]<i[0]||r[0]>i[2]){const u=.5*o;let a=r[0]-i[0]>u?-o:i[0]-r[0]>u?o:0;a===0&&(a=r[0]-i[2]>u?-o:i[2]-r[0]>u?o:0),r[0]+=a}El(e,r)}function Ft(r,e,i,o){const u=Math.pow(2,o.z)*ho,a=[o.x*ho,o.y*ho],h=[];if(!r)return h;for(const m of r)for(const y of m){const T=[y.x+a[0],y.y+a[1]];oi(T,e,i,u),h.push(T)}return h}function jc(r,e,i,o){const u=Math.pow(2,o.z)*ho,a=[o.x*ho,o.y*ho],h=[];if(!r)return h;for(const y of r){const T=[];for(const f of y){const x=[f.x+a[0],f.y+a[1]];El(e,x),T.push(x)}h.push(T)}if(e[2]-e[0]<=u/2){(m=e)[0]=m[1]=1/0,m[2]=m[3]=-1/0;for(const y of h)for(const T of y)oi(T,e,i,u)}var m;return h}class Ht{constructor(e,i){this.type=yi,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if($s(e[1])){const o=e[1];if(o.type==="FeatureCollection")for(let u=0;u<o.features.length;++u){const a=o.features[u].geometry.type;if(a==="Polygon"||a==="MultiPolygon")return new Ht(o,o.features[u].geometry)}else if(o.type==="Feature"){const u=o.geometry.type;if(u==="Polygon"||u==="MultiPolygon")return new Ht(o,o.geometry)}else if(o.type==="Polygon"||o.type==="MultiPolygon")return new Ht(o,o)}return i.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(i,o){const u=[1/0,1/0,-1/0,-1/0],a=[1/0,1/0,-1/0,-1/0],h=i.canonicalID();if(!h)return!1;if(o.type==="Polygon"){const m=mh(o.coordinates,a,h),y=Ft(i.geometry(),u,a,h);if(!Ml(u,a))return!1;for(const T of y)if(!Ca(T,m))return!1}if(o.type==="MultiPolygon"){const m=jo(o.coordinates,a,h),y=Ft(i.geometry(),u,a,h);if(!Ml(u,a))return!1;for(const T of y)if(!ph(T,m))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(i,o){const u=[1/0,1/0,-1/0,-1/0],a=[1/0,1/0,-1/0,-1/0],h=i.canonicalID();if(!h)return!1;if(o.type==="Polygon"){const m=mh(o.coordinates,a,h),y=jc(i.geometry(),u,a,h);if(!Ml(u,a))return!1;for(const T of y)if(!wf(T,m))return!1}if(o.type==="MultiPolygon"){const m=jo(o.coordinates,a,h),y=jc(i.geometry(),u,a,h);if(!Ml(u,a))return!1;for(const T of y)if(!Xm(T,m))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const Pa={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},Gc=1/298.257223563,Xt=Gc*(2-Gc),za=Math.PI/180;class Go{static fromTile(e,i,o){const u=Math.PI*(1-2*(e+.5)/Math.pow(2,i)),a=Math.atan(.5*(Math.exp(u)-Math.exp(-u)))/za;return new Go(a,o)}static get units(){return Pa}constructor(e,i){if(e===void 0)throw new Error("No latitude given.");if(i&&!Pa[i])throw new Error(`Unknown unit ${i}. Use one of: ${Object.keys(Pa).join(", ")}`);const o=6378.137*za*(i?Pa[i]:1),u=Math.cos(e*za),a=1/(1-Xt*(1-u*u)),h=Math.sqrt(a);this.kx=o*h*u,this.ky=o*h*a*(1-Xt)}distance(e,i){const o=mr(e[0]-i[0])*this.kx,u=(e[1]-i[1])*this.ky;return Math.sqrt(o*o+u*u)}bearing(e,i){const o=mr(i[0]-e[0])*this.kx;return Math.atan2(o,(i[1]-e[1])*this.ky)/za}destination(e,i,o){const u=o*za;return this.offset(e,Math.sin(u)*i,Math.cos(u)*i)}offset(e,i,o){return[e[0]+i/this.kx,e[1]+o/this.ky]}lineDistance(e){let i=0;for(let o=0;o<e.length-1;o++)i+=this.distance(e[o],e[o+1]);return i}area(e){let i=0;for(let o=0;o<e.length;o++){const u=e[o];for(let a=0,h=u.length,m=h-1;a<h;m=a++)i+=mr(u[a][0]-u[m][0])*(u[a][1]+u[m][1])*(o?-1:1)}return Math.abs(i)/2*this.kx*this.ky}along(e,i){let o=0;if(i<=0)return e[0];for(let u=0;u<e.length-1;u++){const a=e[u],h=e[u+1],m=this.distance(a,h);if(o+=m,o>i)return qc(a,h,(i-(o-m))/m)}return e[e.length-1]}pointToSegmentDistance(e,i,o){let[u,a]=i,h=mr(o[0]-u)*this.kx,m=(o[1]-a)*this.ky;if(h!==0||m!==0){const y=(mr(e[0]-u)*this.kx*h+(e[1]-a)*this.ky*m)/(h*h+m*m);y>1?(u=o[0],a=o[1]):y>0&&(u+=h/this.kx*y,a+=m/this.ky*y)}return h=mr(e[0]-u)*this.kx,m=(e[1]-a)*this.ky,Math.sqrt(h*h+m*m)}pointOnLine(e,i){let o=1/0,u=e[0][0],a=e[0][1],h=0,m=0;for(let y=0;y<e.length-1;y++){let T=e[y][0],f=e[y][1],x=mr(e[y+1][0]-T)*this.kx,w=(e[y+1][1]-f)*this.ky,g=0;x===0&&w===0||(g=(mr(i[0]-T)*this.kx*x+(i[1]-f)*this.ky*w)/(x*x+w*w),g>1?(T=e[y+1][0],f=e[y+1][1]):g>0&&(T+=x/this.kx*g,f+=w/this.ky*g)),x=mr(i[0]-T)*this.kx,w=(i[1]-f)*this.ky;const v=x*x+w*w;v<o&&(o=v,u=T,a=f,h=y,m=g)}return{point:[u,a],index:h,t:Math.max(0,Math.min(1,m))}}lineSlice(e,i,o){let u=this.pointOnLine(o,e),a=this.pointOnLine(o,i);if(u.index>a.index||u.index===a.index&&u.t>a.t){const T=u;u=a,a=T}const h=[u.point],m=u.index+1,y=a.index;!_h(o[m],h[0])&&m<=y&&h.push(o[m]);for(let T=m+1;T<=y;T++)h.push(o[T]);return _h(o[y],a.point)||h.push(a.point),h}lineSliceAlong(e,i,o){let u=0;const a=[];for(let h=0;h<o.length-1;h++){const m=o[h],y=o[h+1],T=this.distance(m,y);if(u+=T,u>e&&a.length===0&&a.push(qc(m,y,(e-(u-T))/T)),u>=i)return a.push(qc(m,y,(i-(u-T))/T)),a;u>e&&a.push(y)}return a}bufferPoint(e,i){const o=i/this.ky,u=i/this.kx;return[e[0]-u,e[1]-o,e[0]+u,e[1]+o]}bufferBBox(e,i){const o=i/this.ky,u=i/this.kx;return[e[0]-u,e[1]-o,e[2]+u,e[3]+o]}insideBBox(e,i){return mr(e[0]-i[0])>=0&&mr(e[0]-i[2])<=0&&e[1]>=i[1]&&e[1]<=i[3]}}function _h(r,e){return r[0]===e[0]&&r[1]===e[1]}function qc(r,e,i){const o=mr(e[0]-r[0]);return[r[0]+o*i,r[1]+(e[1]-r[1])*i]}function mr(r){for(;r<-180;)r+=360;for(;r>180;)r-=360;return r}class Hn{constructor(e=[],i=(o,u)=>o<u?-1:o>u?1:0){if(this.data=e,this.length=this.data.length,this.compare=i,this.length>0)for(let o=(this.length>>1)-1;o>=0;o--)this._down(o)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;const e=this.data[0],i=this.data.pop();return--this.length>0&&(this.data[0]=i,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:i,compare:o}=this,u=i[e];for(;e>0;){const a=e-1>>1,h=i[a];if(o(u,h)>=0)break;i[e]=h,e=a}i[e]=u}_down(e){const{data:i,compare:o}=this,u=this.length>>1,a=i[e];for(;e<u;){let h=1+(e<<1);const m=h+1;if(m<this.length&&o(i[m],i[h])<0&&(h=m),o(i[h],a)>=0)break;i[e]=i[h],e=h}i[e]=a}}var mt=8192;function gh(r,e){return e.dist-r.dist}const $c=100,Il=50;function fo(r){const e=[1/0,1/0,-1/0,-1/0];if(e.length!==r.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==r[i])return!1;return!0}function jn(r){return r[1]-r[0]+1}function Ws(r,e){const i=r[1]>=r[0]&&r[1]<e;return i||console.warn("Distance Expression: Index is out of range"),i}function yh(r,e){if(r[0]>r[1])return[null,null];const i=jn(r);if(e){if(i===2)return[r,null];const o=Math.floor(i/2);return[[r[0],r[0]+o],[r[0]+o,r[1]]]}{if(i===1)return[r,null];const o=Math.floor(i/2)-1;return[[r[0],r[0]+o],[r[0]+o+1,r[1]]]}}function qo(r,e){const i=[1/0,1/0,-1/0,-1/0];if(!Ws(e,r.length))return i;for(let o=e[0];o<=e[1];++o)El(i,r[o]);return i}function $o(r){const e=[1/0,1/0,-1/0,-1/0];for(let i=0;i<r.length;++i)for(let o=0;o<r[i].length;++o)El(e,r[i][o]);return e}function Zo(r,e,i){if(fo(r)||fo(e))return NaN;let o=0,u=0;return r[2]<e[0]&&(o=e[0]-r[2]),r[0]>e[2]&&(o=r[0]-e[2]),r[1]>e[3]&&(u=r[1]-e[3]),r[3]<e[1]&&(u=e[1]-r[3]),i.distance([0,0],[o,u])}function xh(r){return 360*r-180}function Ym(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function vh(r,e){const i=Math.pow(2,e.z),o=(r.y/mt+e.y)/i;return[xh((r.x/mt+e.x)/i),Ym(o)]}function Km(r,e){const i=[];for(let o=0;o<r.length;++o)i.push(vh(r[o],e));return i}function Tf(r,e,i){const o=i.pointOnLine(e,r).point;return i.distance(r,o)}function bh(r,e,i,o,u){const a=i.slice(o[0],o[1]+1);let h=1/0;for(let m=e[0];m<=e[1];++m)if((h=Math.min(h,Tf(r[m],a,u)))===0)return 0;return h}function wh(r,e,i,o,u){const a=Math.min(u.pointToSegmentDistance(r,i,o),u.pointToSegmentDistance(e,i,o)),h=Math.min(u.pointToSegmentDistance(i,r,e),u.pointToSegmentDistance(o,r,e));return Math.min(a,h)}function Jm(r,e,i,o,u){if(!Ws(e,r.length)||!Ws(o,i.length))return NaN;let a=1/0;for(let h=e[0];h<e[1];++h)for(let m=o[0];m<o[1];++m){if(Hs(r[h],r[h+1],i[m],i[m+1]))return 0;a=Math.min(a,wh(r[h],r[h+1],i[m],i[m+1],u))}return a}function Sf(r,e,i,o,u){if(!Ws(e,r.length)||!Ws(o,i.length))return NaN;let a=1/0;for(let h=e[0];h<=e[1];++h)for(let m=o[0];m<=o[1];++m)if((a=Math.min(a,u.distance(r[h],i[m])))===0)return a;return a}function Ho(r,e,i){if(Ca(r,e,!0))return 0;let o=1/0;for(const u of e){const a=u.length;if(a<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(u[0]!==u[a-1]&&(o=Math.min(o,i.pointToSegmentDistance(r,u[a-1],u[0])))===0||(o=Math.min(o,Tf(r,u,i)))===0)return o}return o}function Qm(r,e,i,o){if(!Ws(e,r.length))return NaN;for(let a=e[0];a<=e[1];++a)if(Ca(r[a],i,!0))return 0;let u=1/0;for(let a=e[0];a<e[1];++a)for(const h of i)for(let m=0,y=h.length,T=y-1;m<y;T=m++){if(Hs(r[a],r[a+1],h[T],h[m]))return 0;u=Math.min(u,wh(r[a],r[a+1],h[T],h[m],o))}return u}function Ef(r,e){for(const i of r)for(let o=0;o<=i.length-1;++o)if(Ca(i[o],e,!0))return!0;return!1}function Th(r,e,i,o=1/0){const u=$o(r),a=$o(e);if(o!==1/0&&Zo(u,a,i)>=o)return o;if(Ml(u,a)){if(Ef(r,e))return 0}else if(Ef(e,r))return 0;let h=o;for(const m of r)for(let y=0,T=m.length,f=T-1;y<T;f=y++)for(const x of e)for(let w=0,g=x.length,v=g-1;w<g;v=w++){if(Hs(m[f],m[y],x[v],x[w]))return 0;h=Math.min(h,wh(m[f],m[y],x[v],x[w],i))}return h}function Al(r,e,i,o,u,a,h){if(a===null||h===null)return;const m=Zo(qo(o,a),qo(u,h),i);m<e&&r.push({dist:m,range1:a,range2:h})}function Mf(r,e,i,o,u=1/0){let a=Math.min(o.distance(r[0],i[0][0]),u);if(a===0)return a;const h=new Hn([{dist:0,range1:[0,r.length-1],range2:[0,0]}],gh),m=e?Il:$c,y=$o(i);for(;h.length;){const T=h.pop();if(T.dist>=a)continue;const f=T.range1;if(jn(f)<=m){if(!Ws(f,r.length))return NaN;if(e){const x=Qm(r,f,i,o);if((a=Math.min(a,x))===0)return a}else for(let x=f[0];x<=f[1];++x){const w=Ho(r[x],i,o);if((a=Math.min(a,w))===0)return a}}else{const x=yh(f,e);if(x[0]!==null){const w=Zo(qo(r,x[0]),y,o);w<a&&h.push({dist:w,range1:x[0],range2:[0,0]})}if(x[1]!==null){const w=Zo(qo(r,x[1]),y,o);w<a&&h.push({dist:w,range1:x[1],range2:[0,0]})}}}return a}function Ur(r,e,i,o,u,a=1/0){let h=Math.min(a,u.distance(r[0],i[0]));if(h===0)return h;const m=new Hn([{dist:0,range1:[0,r.length-1],range2:[0,i.length-1]}],gh),y=e?Il:$c,T=o?Il:$c;for(;m.length;){const f=m.pop();if(f.dist>=h)continue;const x=f.range1,w=f.range2;if(jn(x)<=y&&jn(w)<=T){if(!Ws(x,r.length)||!Ws(w,i.length))return NaN;if(e&&o?h=Math.min(h,Jm(r,x,i,w,u)):e||o?e&&!o?h=Math.min(h,bh(i,w,r,x,u)):!e&&o&&(h=Math.min(h,bh(r,x,i,w,u))):h=Math.min(h,Sf(r,x,i,w,u)),h===0)return h}else{const g=yh(x,e),v=yh(w,o);Al(m,h,u,r,i,g[0],v[0]),Al(m,h,u,r,i,g[0],v[1]),Al(m,h,u,r,i,g[1],v[0]),Al(m,h,u,r,i,g[1],v[1])}}return h}function Zc(r,e,i,o,u=1/0){let a=u;const h=qo(r,[0,r.length-1]);for(const m of i)if(!(a!==1/0&&Zo(h,qo(m,[0,m.length-1]),o)>=a)&&(a=Math.min(a,Ur(r,e,m,!0,o,a)),a===0))return a;return a}function Cl(r,e,i,o,u=1/0){let a=u;const h=qo(r,[0,r.length-1]);for(const m of i){if(a!==1/0&&Zo(h,$o(m),o)>=a)continue;const y=Mf(r,e,m,o,a);if(isNaN(y))return y;if((a=Math.min(a,y))===0)return a}return a}function Hc(r){return r==="Point"||r==="MultiPoint"||r==="LineString"||r==="MultiLineString"||r==="Polygon"||r==="MultiPolygon"}class po{constructor(e,i){this.type=Ct,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if($s(e[1])){const o=e[1];if(o.type==="FeatureCollection"){for(let u=0;u<o.features.length;++u)if(Hc(o.features[u].geometry.type))return new po(o,o.features[u].geometry)}else if(o.type==="Feature"){if(Hc(o.geometry.type))return new po(o,o.geometry)}else if(Hc(o.type))return new po(o,o)}return i.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){const i=e.geometry(),o=e.canonicalID();if(i!=null&&o!=null){if(e.geometryType()==="Point")return function(u,a,h){const m=[];for(const T of u)for(const f of T)m.push(vh(f,a));const y=new Go(m[0][1],"meters");return h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString"?Ur(m,!1,h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",y):h.type==="MultiLineString"?Zc(m,!1,h.coordinates,y):h.type==="Polygon"||h.type==="MultiPolygon"?Cl(m,!1,h.type==="Polygon"?[h.coordinates]:h.coordinates,y):null}(i,o,this.geometries);if(e.geometryType()==="LineString")return function(u,a,h){const m=[];for(const T of u){const f=[];for(const x of T)f.push(vh(x,a));m.push(f)}const y=new Go(m[0][0][1],"meters");if(h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString")return Zc(h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",m,y);if(h.type==="MultiLineString"){let T=1/0;for(let f=0;f<h.coordinates.length;f++){const x=Zc(h.coordinates[f],!0,m,y,T);if(isNaN(x))return x;if((T=Math.min(T,x))===0)return T}return T}if(h.type==="Polygon"||h.type==="MultiPolygon"){let T=1/0;for(let f=0;f<m.length;f++){const x=Cl(m[f],!0,h.type==="Polygon"?[h.coordinates]:h.coordinates,y,T);if(isNaN(x))return x;if((T=Math.min(T,x))===0)return T}return T}return null}(i,o,this.geometries);if(e.geometryType()==="Polygon")return function(u,a,h){const m=[];for(const T of function(f,x){const w=f.length;if(w<=1)return[f];const g=[];let v,S;for(let C=0;C<w;C++){const z=$m(f[C]);z!==0&&(f[C].area=Math.abs(z),S===void 0&&(S=z<0),S===z<0?(v&&g.push(v),v=[f[C]]):v.push(f[C]))}return v&&g.push(v),g}(u)){const f=[];for(let x=0;x<T.length;++x)f.push(Km(T[x],a));m.push(f)}const y=new Go(m[0][0][0][1],"meters");if(h.type==="Point"||h.type==="MultiPoint"||h.type==="LineString")return Cl(h.type==="Point"?[h.coordinates]:h.coordinates,h.type==="LineString",m,y);if(h.type==="MultiLineString"){let T=1/0;for(let f=0;f<h.coordinates.length;f++){const x=Cl(h.coordinates[f],!0,m,y,T);if(isNaN(x))return x;if((T=Math.min(T,x))===0)return T}return T}return h.type==="Polygon"||h.type==="MultiPolygon"?function(T,f,x){let w=1/0;for(const g of T)for(const v of f){const S=Th(g,v,x,w);if(isNaN(S))return S;if((w=Math.min(w,S))===0)return w}return w}(h.type==="Polygon"?[h.coordinates]:h.coordinates,m,y):null}(i,o,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function Wc(r,e){switch(r){case"string":return Vr(e);case"number":return+e;case"boolean":return!!e;case"color":return Mi.parse(e);case"formatted":return Kn.fromString(Vr(e));case"resolvedImage":return Zn.build(Vr(e))}return e}function Sh(r,e,i,o){return o!==void 0&&(r=o*Math.round(r/o)),e!==void 0&&r<e&&(r=e),i!==void 0&&r>i&&(r=i),r}class Wo{constructor(e,i,o){this.type=e,this.key=i,this.scope=o}static parse(e,i){let o=i.expectedType;if(o==null&&(o=Ti),e.length<2||e.length>3)return i.error("Invalid number of arguments for 'config' expression.");const u=i.parse(e[1],1);if(!(u instanceof Un))return i.error("Key name of 'config' expression must be a string literal.");if(e.length>=3){const a=i.parse(e[2],2);return a instanceof Un?new Wo(o,Vr(u.value),Vr(a.value)):i.error("Scope of 'config' expression must be a string literal.")}return new Wo(o,Vr(u.value))}evaluate(e){const i=[this.key,this.scope,e.scope].filter(Boolean).join(""),o=e.getConfig(i);if(!o)return null;const{type:u,value:a,values:h,minValue:m,maxValue:y,stepValue:T}=o,f=o.default.evaluate(e);let x=f;if(a){const w=e.scope;e.scope=(w||"").split("").slice(1).join(""),x=a.evaluate(e),e.scope=w}return u&&(x=Wc(u,x)),x===void 0||m===void 0&&y===void 0&&T===void 0||(typeof x=="number"?x=Sh(x,m,y,T):Array.isArray(x)&&(x=x.map(w=>typeof w=="number"?Sh(w,m,y,T):w))),a!==void 0&&x!==void 0&&h&&!h.includes(x)&&(x=f,u&&(x=Wc(u,x))),(u&&u!==this.type||x!==void 0&&nn(x)!==this.type)&&(x=Wc(this.type.kind,x)),x}eachChild(){}outputDefined(){return!1}serialize(){const e=["config",this.key];return this.scope&&e.concat(this.key),e}}function Ra(r){if(r instanceof pr&&(r.name==="get"&&r.args.length===1||r.name==="feature-state"||r.name==="has"&&r.args.length===1||r.name==="properties"||r.name==="geometry-type"||r.name==="id"||/^filter-/.test(r.name))||r instanceof Ht||r instanceof po)return!1;let e=!0;return r.eachChild(i=>{e&&!Ra(i)&&(e=!1)}),e}function Pl(r){if(r instanceof pr&&r.name==="feature-state")return!1;let e=!0;return r.eachChild(i=>{e&&!Pl(i)&&(e=!1)}),e}function zl(r){if(r instanceof Wo)return new Set([r.key]);let e=new Set;return r.eachChild(i=>{e=new Set([...e,...zl(i)])}),e}function Xo(r,e){if(r instanceof pr&&e.indexOf(r.name)>=0)return!1;let i=!0;return r.eachChild(o=>{i&&!Xo(o,e)&&(i=!1)}),i}class Yo{constructor(e,i){this.type=i.type,this.name=e,this.boundExpression=i}static parse(e,i){if(e.length!==2||typeof e[1]!="string")return i.error("'var' expression requires exactly one string literal argument.");const o=e[1];return i.scope.has(o)?new Yo(o,i.scope.get(o)):i.error(`Unknown variable "${o}". Make sure "${o}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Da{constructor(e,i=[],o,u=new Bc,a=[],h,m){this.registry=e,this.path=i,this.key=i.map(y=>typeof y=="string"?`['${y}']`:`[${y}]`).join(""),this.scope=u,this.errors=a,this.expectedType=o,this._scope=h,this.options=m}parse(e,i,o,u,a={}){return i||o?this.concat(i,null,o,u)._parse(e,a):this._parse(e,a)}parseObjectValue(e,i,o,u,a,h={}){return this.concat(i,o,u,a)._parse(e,h)}_parse(e,i){function o(u,a,h){return h==="assert"?new Jr(a,[u]):h==="coerce"?new Zs(a,[u]):u}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const u=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(u){let a=u.parse(e,this);if(!a)return null;if(this.expectedType){const h=this.expectedType,m=a.type;if(h.kind!=="string"&&h.kind!=="number"&&h.kind!=="boolean"&&h.kind!=="object"&&h.kind!=="array"||m.kind!=="value")if(h.kind!=="color"&&h.kind!=="formatted"&&h.kind!=="resolvedImage"||m.kind!=="value"&&m.kind!=="string"){if(this.checkSubtype(h,m))return null}else a=o(a,h,i.typeAnnotation||"coerce");else a=o(a,h,i.typeAnnotation||"assert")}if(!(a instanceof Un)&&a.type.kind!=="resolvedImage"&&Xc(a)){const h=new hh(this._scope,this.options);try{a=new Un(a.type,a.evaluate(h))}catch(m){return this.error(m.message),null}}return a}return Zs.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,i,o,u){let a=typeof e=="number"?this.path.concat(e):this.path;a=typeof i=="string"?a.concat(i):a;const h=u?this.scope.concat(u):this.scope;return new Da(this.registry,a,o||null,h,this.errors,this._scope,this.options)}error(e,...i){const o=`${this.key}${i.map(u=>`[${u}]`).join("")}`;this.errors.push(new li(o,e))}checkSubtype(e,i){const o=fr(e,i);return o&&this.error(o),o}}var Rl=Da;function Xc(r){if(r instanceof Yo)return Xc(r.boundExpression);if(r instanceof pr&&r.name==="error"||r instanceof Uc||r instanceof Ht||r instanceof po||r instanceof Wo)return!1;const e=r instanceof Zs||r instanceof Jr;let i=!0;return r.eachChild(o=>{i=e?i&&Xc(o):i&&o instanceof Un}),!!i&&Ra(r)&&Xo(r,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Dl(r,e){const i=r.length-1;let o,u,a=0,h=i,m=0;for(;a<=h;)if(m=Math.floor((a+h)/2),o=r[m],u=r[m+1],o<=e){if(m===i||e<u)return m;a=m+1}else{if(!(o>e))throw new pn("Input is not a number.");h=m-1}return 0}class La{constructor(e,i,o){this.type=e,this.input=i,this.labels=[],this.outputs=[];for(const[u,a]of o)this.labels.push(u),this.outputs.push(a)}static parse(e,i){if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return i.error("Expected an even number of arguments.");const o=i.parse(e[1],1,Ct);if(!o)return null;const u=[];let a=null;i.expectedType&&i.expectedType.kind!=="value"&&(a=i.expectedType);for(let h=1;h<e.length;h+=2){const m=h===1?-1/0:e[h],y=e[h+1],T=h,f=h+1;if(typeof m!="number")return i.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',T);if(u.length&&u[u.length-1][0]>=m)return i.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',T);const x=i.parse(y,f,a);if(!x)return null;a=a||x.type,u.push([m,x])}return new La(a,o,u)}evaluate(e){const i=this.labels,o=this.outputs;if(i.length===1)return o[0].evaluate(e);const u=this.input.evaluate(e);if(u<=i[0])return o[0].evaluate(e);const a=i.length;return u>=i[a-1]?o[a-1].evaluate(e):o[Dl(i,u)].evaluate(e)}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){const e=["step",this.input.serialize()];for(let i=0;i<this.labels.length;i++)i>0&&e.push(this.labels[i]),e.push(this.outputs[i].serialize());return e}}const Ko=.95047,mi=1.08883,If=4/29,ka=6/29,Af=3*ka*ka,Cf=ka*ka*ka,e_=Math.PI/180,Zi=180/Math.PI;function Eh(r){return r>Cf?Math.pow(r,1/3):r/Af+If}function Mh(r){return r>ka?r*r*r:Af*(r-If)}function Ih(r){return 255*(r<=.0031308?12.92*r:1.055*Math.pow(r,1/2.4)-.055)}function Ah(r){return(r/=255)<=.04045?r/12.92:Math.pow((r+.055)/1.055,2.4)}function Pf(r){const e=Ah(r.r),i=Ah(r.g),o=Ah(r.b),u=Eh((.4124564*e+.3575761*i+.1804375*o)/Ko),a=Eh((.2126729*e+.7151522*i+.072175*o)/1);return{l:116*a-16,a:500*(u-a),b:200*(a-Eh((.0193339*e+.119192*i+.9503041*o)/mi)),alpha:r.a}}function zf(r){let e=(r.l+16)/116,i=isNaN(r.a)?e:e+r.a/500,o=isNaN(r.b)?e:e-r.b/200;return e=1*Mh(e),i=Ko*Mh(i),o=mi*Mh(o),new Mi(Ih(3.2404542*i-1.5371385*e-.4985314*o),Ih(-.969266*i+1.8760108*e+.041556*o),Ih(.0556434*i-.2040259*e+1.0572252*o),r.alpha)}function t_(r,e,i){const o=e-r;return r+i*(o>180||o<-180?o-360*Math.round(o/360):o)}const Ll={forward:Pf,reverse:zf,interpolate:function(r,e,i){return{l:Gt(r.l,e.l,i),a:Gt(r.a,e.a,i),b:Gt(r.b,e.b,i),alpha:Gt(r.alpha,e.alpha,i)}}},kl={forward:function(r){const{l:e,a:i,b:o}=Pf(r),u=Math.atan2(o,i)*Zi;return{h:u<0?u+360:u,c:Math.sqrt(i*i+o*o),l:e,alpha:r.a}},reverse:function(r){const e=r.h*e_,i=r.c;return zf({l:r.l,a:Math.cos(e)*i,b:Math.sin(e)*i,alpha:r.alpha})},interpolate:function(r,e,i){return{h:t_(r.h,e.h,i),c:Gt(r.c,e.c,i),l:Gt(r.l,e.l,i),alpha:Gt(r.alpha,e.alpha,i)}}};var Rf=Object.freeze({__proto__:null,hcl:kl,lab:Ll});class vr{constructor(e,i,o,u,a,h){this.type=e,this.operator=i,this.interpolation=o,this.input=u,this.dynamicStops=a,this.labels=[],this.outputs=[];for(const[m,y]of h)this.labels.push(m),this.outputs.push(y)}static interpolationFactor(e,i,o,u){let a=0;if(e.name==="exponential")a=Ch(i,e.base,o,u);else if(e.name==="linear")a=Ch(i,1,o,u);else if(e.name==="cubic-bezier"){const h=e.controlPoints;a=new xa(h[0],h[1],h[2],h[3]).solve(Ch(i,1,o,u))}return a}static parse(e,i){let[o,u,a,...h]=e;if(!Array.isArray(u)||u.length===0)return i.error("Expected an interpolation type expression.",1);if(u[0]==="linear")u={name:"linear"};else if(u[0]==="exponential"){const T=u[1];if(typeof T!="number")return i.error("Exponential interpolation requires a numeric base.",1,1);u={name:"exponential",base:T}}else{if(u[0]!=="cubic-bezier")return i.error(`Unknown interpolation type ${String(u[0])}`,1,0);{const T=u.slice(1);if(T.length!==4||T.some(f=>typeof f!="number"||f<0||f>1))return i.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);u={name:"cubic-bezier",controlPoints:T}}}if(e.length-1<3)return i.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length-1>3&&(e.length-1)%2!=0)return i.error("Expected an even number of arguments.");if(a=i.parse(a,2,Ct),!a)return null;const m=[];let y=null;if(o==="interpolate-hcl"||o==="interpolate-lab"?y=Yn:i.expectedType&&i.expectedType.kind!=="value"&&(y=i.expectedType),e.length-1==3){const T=i.parse(h[0],3,Ti);return T?new vr(y,o,u,a,T,m):null}for(let T=0;T<h.length;T+=2){const f=h[T],x=h[T+1],w=T+3,g=T+4;if(typeof f!="number")return i.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',w);if(m.length&&m[m.length-1][0]>=f)return i.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',w);const v=i.parse(x,g,y);if(!v)return null;y=y||v.type,m.push([f,v])}return y.kind==="number"||y.kind==="color"||y.kind==="array"&&y.itemType.kind==="number"&&typeof y.N=="number"?new vr(y,o,u,a,null,m):i.error(`Type ${on(y)} is not interpolatable.`)}evaluate(e){let i=this.labels,o=this.outputs;if(this.dynamicStops){const f=this.dynamicStops.evaluate(e);if(f.length%2!=0)throw new pn("Expected an even number of arguments.");i=[],o=[];for(let x=0;x<f.length;x+=2){const w=f[x],g=new Un(Ct,f[x+1]);if(typeof w!="number")throw new pn('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.');if(i.length&&i[i.length-1]>=w)throw new pn('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.');i.push(w),o.push(g)}if(i.length===0)throw new pn("Expected at least one input/output pair.")}if(i.length===1)return o[0].evaluate(e);const u=this.input.evaluate(e);if(u<=i[0])return o[0].evaluate(e);const a=i.length;if(u>=i[a-1])return o[a-1].evaluate(e);const h=Dl(i,u),m=vr.interpolationFactor(this.interpolation,u,i[h],i[h+1]),y=o[h].evaluate(e),T=o[h+1].evaluate(e);return this.operator==="interpolate"?Oc[this.type.kind.toLowerCase()](y,T,m):this.operator==="interpolate-hcl"?kl.reverse(kl.interpolate(kl.forward(y),kl.forward(T),m)):Ll.reverse(Ll.interpolate(Ll.forward(y),Ll.forward(T),m))}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const i=[this.operator,e,this.input.serialize()];if(this.dynamicStops)i.push(this.dynamicStops.serialize());else for(let o=0;o<this.labels.length;o++)i.push(this.labels[o],this.outputs[o].serialize());return i}}function Ch(r,e,i,o){const u=o-i,a=r-i;return u===0?0:e===1?a/u:(Math.pow(e,a)-1)/(Math.pow(e,u)-1)}class Yc{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expectected at least one argument.");let o=null;const u=i.expectedType;u&&u.kind!=="value"&&(o=u);const a=[];for(const m of e.slice(1)){const y=i.parse(m,1+a.length,o,void 0,{typeAnnotation:"omit"});if(!y)return null;o=o||y.type,a.push(y)}const h=u&&a.some(m=>fr(u,m.type));return new Yc(h?Ti:o,a)}evaluate(e){let i,o=null,u=0;for(const a of this.args){if(u++,o=a.evaluate(e),o&&o instanceof Zn&&!o.available&&(i||(i=o),o=null,u===this.args.length))return i;if(o!==null)break}return o}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=["coalesce"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class Kc{constructor(e,i){this.type=i.type,this.bindings=[].concat(e),this.result=i}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const i of this.bindings)e(i[1]);e(this.result)}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const o=[];for(let a=1;a<e.length-1;a+=2){const h=e[a];if(typeof h!="string")return i.error(`Expected string, but found ${typeof h} instead.`,a);if(/[^a-zA-Z0-9_]/.test(h))return i.error("Variable names must contain only alphanumeric characters or '_'.",a);const m=i.parse(e[a+1],a+1);if(!m)return null;o.push([h,m])}const u=i.parse(e[e.length-1],e.length-1,i.expectedType,o);return u?new Kc(o,u):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[i,o]of this.bindings)e.push(i,o.serialize());return e.push(this.result.serialize()),e}}class Ph{constructor(e,i,o){this.type=e,this.index=i,this.input=o}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,Ct),u=i.parse(e[2],2,Vn(i.expectedType||Ti));return o&&u?new Ph(u.type.itemType,o,u):null}evaluate(e){const i=this.index.evaluate(e),o=this.input.evaluate(e);if(i<0)throw new pn(`Array index out of bounds: ${i} < 0.`);if(i>o.length-1)throw new pn(`Array index out of bounds: ${i} > ${o.length-1}.`);if(i===Math.floor(i))return o[i];const u=Math.floor(i),a=Math.ceil(i),h=o[u],m=o[a];if(typeof h!="number"||typeof m!="number")throw new pn(`Cannot interpolate between non-number values at index ${i}.`);const y=i-u;return h*(1-y)+m*y}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class zh{constructor(e,i){this.type=yi,this.needle=e,this.haystack=i}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,Ti),u=i.parse(e[2],2,Ti);return o&&u?Nc(o.type,[yi,Ci,Ct,Vo,Ti])?new zh(o,u):i.error(`Expected first argument to be of type boolean, string, number or null, but found ${on(o.type)} instead`):null}evaluate(e){const i=this.needle.evaluate(e),o=this.haystack.evaluate(e);if(o==null)return!1;if(!xl(i,["boolean","string","number","null"]))throw new pn(`Expected first argument to be of type boolean, string, number or null, but found ${on(nn(i))} instead.`);if(!xl(o,["string","array"]))throw new pn(`Expected second argument to be of type array or string, but found ${on(nn(o))} instead.`);return o.indexOf(i)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class Jc{constructor(e,i,o){this.type=Ct,this.needle=e,this.haystack=i,this.fromIndex=o}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,Ti),u=i.parse(e[2],2,Ti);if(!o||!u)return null;if(!Nc(o.type,[yi,Ci,Ct,Vo,Ti]))return i.error(`Expected first argument to be of type boolean, string, number or null, but found ${on(o.type)} instead`);if(e.length===4){const a=i.parse(e[3],3,Ct);return a?new Jc(o,u,a):null}return new Jc(o,u)}evaluate(e){const i=this.needle.evaluate(e),o=this.haystack.evaluate(e);if(!xl(i,["boolean","string","number","null"]))throw new pn(`Expected first argument to be of type boolean, string, number or null, but found ${on(nn(i))} instead.`);if(!xl(o,["string","array"]))throw new pn(`Expected second argument to be of type array or string, but found ${on(nn(o))} instead.`);if(this.fromIndex){const u=this.fromIndex.evaluate(e);return o.indexOf(i,u)}return o.indexOf(i)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Rh{constructor(e,i,o,u,a,h){this.inputType=e,this.type=i,this.input=o,this.cases=u,this.outputs=a,this.otherwise=h}static parse(e,i){if(e.length<5)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return i.error("Expected an even number of arguments.");let o,u;i.expectedType&&i.expectedType.kind!=="value"&&(u=i.expectedType);const a={},h=[];for(let T=2;T<e.length-1;T+=2){let f=e[T];const x=e[T+1];Array.isArray(f)||(f=[f]);const w=i.concat(T);if(f.length===0)return w.error("Expected at least one branch label.");for(const v of f){if(typeof v!="number"&&typeof v!="string")return w.error("Branch labels must be numbers or strings.");if(typeof v=="number"&&Math.abs(v)>Number.MAX_SAFE_INTEGER)return w.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof v=="number"&&Math.floor(v)!==v)return w.error("Numeric branch labels must be integer values.");if(o){if(w.checkSubtype(o,nn(v)))return null}else o=nn(v);if(a[String(v)]!==void 0)return w.error("Branch labels must be unique.");a[String(v)]=h.length}const g=i.parse(x,T,u);if(!g)return null;u=u||g.type,h.push(g)}const m=i.parse(e[1],1,Ti);if(!m)return null;const y=i.parse(e[e.length-1],e.length-1,u);return y?m.type.kind!=="value"&&i.concat(1).checkSubtype(o,m.type)?null:new Rh(o,u,m,a,h,y):null}evaluate(e){const i=this.input.evaluate(e);return(nn(i)===this.inputType&&this.outputs[this.cases[i]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],i=Object.keys(this.cases).sort(),o=[],u={};for(const h of i){const m=u[this.cases[h]];m===void 0?(u[this.cases[h]]=o.length,o.push([this.cases[h],[h]])):o[m][1].push(h)}const a=h=>this.inputType.kind==="number"?Number(h):h;for(const[h,m]of o)e.push(m.length===1?a(m[0]):m.map(a)),e.push(this.outputs[h].serialize());return e.push(this.otherwise.serialize()),e}}class Dh{constructor(e,i,o){this.type=e,this.branches=i,this.otherwise=o}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return i.error("Expected an odd number of arguments.");let o;i.expectedType&&i.expectedType.kind!=="value"&&(o=i.expectedType);const u=[];for(let h=1;h<e.length-1;h+=2){const m=i.parse(e[h],h,yi);if(!m)return null;const y=i.parse(e[h+1],h+1,o);if(!y)return null;u.push([m,y]),o=o||y.type}const a=i.parse(e[e.length-1],e.length-1,o);return a?new Dh(o,u,a):null}evaluate(e){for(const[i,o]of this.branches)if(i.evaluate(e))return o.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[i,o]of this.branches)e(i),e(o);e(this.otherwise)}outputDefined(){return this.branches.every(([e,i])=>i.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class Qc{constructor(e,i,o,u){this.type=e,this.input=i,this.beginIndex=o,this.endIndex=u}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,Ti),u=i.parse(e[2],2,Ct);if(!o||!u)return null;if(!Nc(o.type,[Vn(Ti),Ci,Ti]))return i.error(`Expected first argument to be of type array or string, but found ${on(o.type)} instead`);if(e.length===4){const a=i.parse(e[3],3,Ct);return a?new Qc(o.type,o,u,a):null}return new Qc(o.type,o,u)}evaluate(e){const i=this.input.evaluate(e),o=this.beginIndex.evaluate(e);if(!xl(i,["string","array"]))throw new pn(`Expected first argument to be of type array or string, but found ${on(nn(i))} instead.`);if(this.endIndex){const u=this.endIndex.evaluate(e);return i.slice(o,u)}return i.slice(o)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function Df(r,e){return r==="=="||r==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function Lf(r,e,i,o){return o.compare(e,i)===0}function Oa(r,e,i){const o=r!=="=="&&r!=="!=";return class zb{constructor(a,h,m){this.type=yi,this.lhs=a,this.rhs=h,this.collator=m,this.hasUntypedArgument=a.type.kind==="value"||h.type.kind==="value"}static parse(a,h){if(a.length!==3&&a.length!==4)return h.error("Expected two or three arguments.");const m=a[0];let y=h.parse(a[1],1,Ti);if(!y)return null;if(!Df(m,y.type))return h.concat(1).error(`"${m}" comparisons are not supported for type '${on(y.type)}'.`);let T=h.parse(a[2],2,Ti);if(!T)return null;if(!Df(m,T.type))return h.concat(2).error(`"${m}" comparisons are not supported for type '${on(T.type)}'.`);if(y.type.kind!==T.type.kind&&y.type.kind!=="value"&&T.type.kind!=="value")return h.error(`Cannot compare types '${on(y.type)}' and '${on(T.type)}'.`);o&&(y.type.kind==="value"&&T.type.kind!=="value"?y=new Jr(T.type,[y]):y.type.kind!=="value"&&T.type.kind==="value"&&(T=new Jr(y.type,[T])));let f=null;if(a.length===4){if(y.type.kind!=="string"&&T.type.kind!=="string"&&y.type.kind!=="value"&&T.type.kind!=="value")return h.error("Cannot use collator to compare non-string types.");if(f=h.parse(a[3],3,gl),!f)return null}return new zb(y,T,f)}evaluate(a){const h=this.lhs.evaluate(a),m=this.rhs.evaluate(a);if(o&&this.hasUntypedArgument){const y=nn(h),T=nn(m);if(y.kind!==T.kind||y.kind!=="string"&&y.kind!=="number")throw new pn(`Expected arguments for "${r}" to be (string, string) or (number, number), but found (${y.kind}, ${T.kind}) instead.`)}if(this.collator&&!o&&this.hasUntypedArgument){const y=nn(h),T=nn(m);if(y.kind!=="string"||T.kind!=="string")return e(a,h,m)}return this.collator?i(a,h,m,this.collator.evaluate(a)):e(a,h,m)}eachChild(a){a(this.lhs),a(this.rhs),this.collator&&a(this.collator)}outputDefined(){return!0}serialize(){const a=[r];return this.eachChild(h=>{a.push(h.serialize())}),a}}}const i_=Oa("==",function(r,e,i){return e===i},Lf),n_=Oa("!=",function(r,e,i){return e!==i},function(r,e,i,o){return!Lf(0,e,i,o)}),r_=Oa("<",function(r,e,i){return e<i},function(r,e,i,o){return o.compare(e,i)<0}),s_=Oa(">",function(r,e,i){return e>i},function(r,e,i,o){return o.compare(e,i)>0}),o_=Oa("<=",function(r,e,i){return e<=i},function(r,e,i,o){return o.compare(e,i)<=0}),a_=Oa(">=",function(r,e,i){return e>=i},function(r,e,i,o){return o.compare(e,i)>=0});class Lh{constructor(e,i,o,u,a,h){this.type=Ci,this.number=e,this.locale=i,this.currency=o,this.unit=u,this.minFractionDigits=a,this.maxFractionDigits=h}static parse(e,i){if(e.length!==3)return i.error("Expected two arguments.");const o=i.parse(e[1],1,Ct);if(!o)return null;const u=e[2];if(typeof u!="object"||Array.isArray(u))return i.error("NumberFormat options argument must be an object.");let a=null;if(u.locale&&(a=i.parseObjectValue(u.locale,2,"locale",Ci),!a))return null;let h=null;if(u.currency&&(h=i.parseObjectValue(u.currency,2,"currency",Ci),!h))return null;let m=null;if(u.unit&&(m=i.parseObjectValue(u.unit,2,"unit",Ci),!m))return null;let y=null;if(u["min-fraction-digits"]&&(y=i.parseObjectValue(u["min-fraction-digits"],2,"min-fraction-digits",Ct),!y))return null;let T=null;return u["max-fraction-digits"]&&(T=i.parseObjectValue(u["max-fraction-digits"],2,"max-fraction-digits",Ct),!T)?null:new Lh(o,a,h,m,y,T)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class kh{constructor(e){this.type=Ct,this.input=e}static parse(e,i){if(e.length!==2)return i.error(`Expected 1 argument, but found ${e.length-1} instead.`);const o=i.parse(e[1],1);return o?o.type.kind!=="array"&&o.type.kind!=="string"&&o.type.kind!=="value"?i.error(`Expected argument of type string or array, but found ${on(o.type)} instead.`):new kh(o):null}evaluate(e){const i=this.input.evaluate(e);if(typeof i=="string"||Array.isArray(i))return i.length;throw new pn(`Expected value to be of type string or array, but found ${on(nn(i))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild(i=>{e.push(i.serialize())}),e}}function eu(r){return function(){r=1831565813+(r|=0)|0;let e=Math.imul(r^r>>>15,1|r);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}const Fa={"==":i_,"!=":n_,">":s_,"<":r_,">=":a_,"<=":o_,array:Jr,at:Ph,boolean:Jr,case:Dh,coalesce:Yc,collator:Uc,format:Uo,image:wl,in:zh,"index-of":Jc,interpolate:vr,"interpolate-hcl":vr,"interpolate-lab":vr,length:kh,let:Kc,literal:Un,match:Rh,number:Jr,"number-format":Lh,object:Jr,slice:Qc,step:La,string:Jr,"to-boolean":Zs,"to-color":Zs,"to-number":Zs,"to-string":Zs,var:Yo,within:Ht,distance:po,config:Wo};function Oh(r,[e,i,o,u]){e=e.evaluate(r),i=i.evaluate(r),o=o.evaluate(r);const a=u?u.evaluate(r):1,h=ch(e,i,o,a);if(h)throw new pn(h);return new Mi(e/255*a,i/255*a,o/255*a,a)}function kf(r,[e,i,o,u]){e=e.evaluate(r),i=i.evaluate(r),o=o.evaluate(r);const a=u?u.evaluate(r):1,h=function(T,f,x,w){return typeof T=="number"&&T>=0&&T<=360?typeof f=="number"&&f>=0&&f<=100&&typeof x=="number"&&x>=0&&x<=100?w===void 0||typeof w=="number"&&w>=0&&w<=1?null:`Invalid hsla value [${[T,f,x,w].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof w=="number"?[T,f,x,w]:[T,f,x]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof w=="number"?[T,f,x,w]:[T,f,x]).join(", ")}]: 'h' must be between 0 and 360.`}(e,i,o,a);if(h)throw new pn(h);const m=`hsla(${e}, ${i}%, ${o}%, ${a})`,y=Mi.parse(m);if(!y)throw new pn(`Failed to parse HSLA color: ${m}`);return y}function Of(r,e){return r in e}function Fh(r,e){const i=e[r];return i===void 0?null:i}function mo(r){return{type:r}}function Bh(r){return{result:"success",value:r}}function Ir(r){return{result:"error",value:r}}function tu(r,e){return!!r&&!!r.parameters&&r.parameters.indexOf(e)>-1}function Ol(r){return r["property-type"]==="data-driven"}function Ff(r){return tu(r.expression,"measure-light")}function iu(r){return tu(r.expression,"zoom")}function Fl(r){return!!r.expression&&r.expression.interpolated}function Nh(r){return typeof r=="object"&&r!==null&&!Array.isArray(r)}function l_(r){return r}function Vh(r,e){const i=e.type==="color",o=r.stops&&typeof r.stops[0][0]=="object",u=o||!(o||r.property!==void 0),a=r.type||(Fl(e)?"exponential":"interval");if(i&&((r=Fc({},r)).stops&&(r.stops=r.stops.map(T=>[T[0],Mi.parse(T[1])])),r.default=Mi.parse(r.default?r.default:e.default)),r.colorSpace&&r.colorSpace!=="rgb"&&!Rf[r.colorSpace])throw new Error(`Unknown color space: ${r.colorSpace}`);let h,m,y;if(a==="exponential")h=Bf;else if(a==="interval")h=u_;else if(a==="categorical"){h=c_,m=Object.create(null);for(const T of r.stops)m[T[0]]=T[1];y=typeof r.stops[0][0]}else{if(a!=="identity")throw new Error(`Unknown function type "${a}"`);h=Nf}if(o){const T={},f=[];for(let g=0;g<r.stops.length;g++){const v=r.stops[g],S=v[0].zoom;T[S]===void 0&&(T[S]={zoom:S,type:r.type,property:r.property,default:r.default,stops:[]},f.push(S)),T[S].stops.push([v[0].value,v[1]])}const x=[];for(const g of f)x.push([T[g].zoom,Vh(T[g],e)]);const w={name:"linear"};return{kind:"composite",interpolationType:w,interpolationFactor:vr.interpolationFactor.bind(void 0,w),zoomStops:x.map(g=>g[0]),evaluate:({zoom:g},v)=>Bf({stops:x,base:r.base},e,g).evaluate(g,v)}}if(u){const T=a==="exponential"?{name:"exponential",base:r.base!==void 0?r.base:1}:null;return{kind:"camera",interpolationType:T,interpolationFactor:vr.interpolationFactor.bind(void 0,T),zoomStops:r.stops.map(f=>f[0]),evaluate:({zoom:f})=>h(r,e,f,m,y)}}return{kind:"source",evaluate(T,f){const x=f&&f.properties?f.properties[r.property]:void 0;return x===void 0?Ba(r.default,e.default):h(r,e,x,m,y)}}}function Ba(r,e,i){return r!==void 0?r:e!==void 0?e:i!==void 0?i:void 0}function c_(r,e,i,o,u){return Ba(typeof i===u?o[i]:void 0,r.default,e.default)}function u_(r,e,i){if(Qr(i)!=="number")return Ba(r.default,e.default);const o=r.stops.length;if(o===1||i<=r.stops[0][0])return r.stops[0][1];if(i>=r.stops[o-1][0])return r.stops[o-1][1];const u=Dl(r.stops.map(a=>a[0]),i);return r.stops[u][1]}function Bf(r,e,i){const o=r.base!==void 0?r.base:1;if(Qr(i)!=="number")return Ba(r.default,e.default);const u=r.stops.length;if(u===1||i<=r.stops[0][0])return r.stops[0][1];if(i>=r.stops[u-1][0])return r.stops[u-1][1];const a=Dl(r.stops.map(f=>f[0]),i),h=function(f,x,w,g){const v=g-w,S=f-w;return v===0?0:x===1?S/v:(Math.pow(x,S)-1)/(Math.pow(x,v)-1)}(i,o,r.stops[a][0],r.stops[a+1][0]),m=r.stops[a][1],y=r.stops[a+1][1];let T=Oc[e.type]||l_;if(r.colorSpace&&r.colorSpace!=="rgb"){const f=Rf[r.colorSpace];T=(x,w)=>f.reverse(f.interpolate(f.forward(x),f.forward(w),h))}return typeof m.evaluate=="function"?{evaluate(...f){const x=m.evaluate.apply(void 0,f),w=y.evaluate.apply(void 0,f);if(x!==void 0&&w!==void 0)return T(x,w,h)}}:T(m,y,h)}function Nf(r,e,i){return e.type==="color"?i=Mi.parse(i):e.type==="formatted"?i=Kn.fromString(i.toString()):e.type==="resolvedImage"?i=Zn.build(i.toString()):Qr(i)===e.type||e.type==="enum"&&e.values[i]||(i=void 0),Ba(i,r.default,e.default)}pr.register(Fa,{error:[{kind:"error"},[Ci],(r,[e])=>{throw new pn(e.evaluate(r))}],typeof:[Ci,[Ti],(r,[e])=>on(nn(e.evaluate(r)))],"to-rgba":[Vn(Ct,4),[Yn],(r,[e])=>e.evaluate(r).toRenderColor(null).toArray()],"to-hsla":[Vn(Ct,4),[Yn],(r,[e])=>e.evaluate(r).toRenderColor(null).toHslaArray()],rgb:[Yn,[Ct,Ct,Ct],Oh],rgba:[Yn,[Ct,Ct,Ct,Ct],Oh],hsl:[Yn,[Ct,Ct,Ct],kf],hsla:[Yn,[Ct,Ct,Ct,Ct],kf],has:{type:yi,overloads:[[[Ci],(r,[e])=>Of(e.evaluate(r),r.properties())],[[Ci,qs],(r,[e,i])=>Of(e.evaluate(r),i.evaluate(r))]]},get:{type:Ti,overloads:[[[Ci],(r,[e])=>Fh(e.evaluate(r),r.properties())],[[Ci,qs],(r,[e,i])=>Fh(e.evaluate(r),i.evaluate(r))]]},"feature-state":[Ti,[Ci],(r,[e])=>Fh(e.evaluate(r),r.featureState||{})],properties:[qs,[],r=>r.properties()],"geometry-type":[Ci,[],r=>r.geometryType()],id:[Ti,[],r=>r.id()],zoom:[Ct,[],r=>r.globals.zoom],pitch:[Ct,[],r=>r.globals.pitch||0],"distance-from-center":[Ct,[],r=>r.distanceFromCenter()],"measure-light":[Ct,[Ci],(r,[e])=>r.measureLight(e.evaluate(r))],"heatmap-density":[Ct,[],r=>r.globals.heatmapDensity||0],"line-progress":[Ct,[],r=>r.globals.lineProgress||0],"raster-value":[Ct,[],r=>r.globals.rasterValue||0],"raster-particle-speed":[Ct,[],r=>r.globals.rasterParticleSpeed||0],"sky-radial-progress":[Ct,[],r=>r.globals.skyRadialProgress||0],accumulated:[Ti,[],r=>r.globals.accumulated===void 0?null:r.globals.accumulated],"+":[Ct,mo(Ct),(r,e)=>{let i=0;for(const o of e)i+=o.evaluate(r);return i}],"*":[Ct,mo(Ct),(r,e)=>{let i=1;for(const o of e)i*=o.evaluate(r);return i}],"-":{type:Ct,overloads:[[[Ct,Ct],(r,[e,i])=>e.evaluate(r)-i.evaluate(r)],[[Ct],(r,[e])=>-e.evaluate(r)]]},"/":[Ct,[Ct,Ct],(r,[e,i])=>e.evaluate(r)/i.evaluate(r)],"%":[Ct,[Ct,Ct],(r,[e,i])=>e.evaluate(r)%i.evaluate(r)],ln2:[Ct,[],()=>Math.LN2],pi:[Ct,[],()=>Math.PI],e:[Ct,[],()=>Math.E],"^":[Ct,[Ct,Ct],(r,[e,i])=>Math.pow(e.evaluate(r),i.evaluate(r))],sqrt:[Ct,[Ct],(r,[e])=>Math.sqrt(e.evaluate(r))],log10:[Ct,[Ct],(r,[e])=>Math.log(e.evaluate(r))/Math.LN10],ln:[Ct,[Ct],(r,[e])=>Math.log(e.evaluate(r))],log2:[Ct,[Ct],(r,[e])=>Math.log(e.evaluate(r))/Math.LN2],sin:[Ct,[Ct],(r,[e])=>Math.sin(e.evaluate(r))],cos:[Ct,[Ct],(r,[e])=>Math.cos(e.evaluate(r))],tan:[Ct,[Ct],(r,[e])=>Math.tan(e.evaluate(r))],asin:[Ct,[Ct],(r,[e])=>Math.asin(e.evaluate(r))],acos:[Ct,[Ct],(r,[e])=>Math.acos(e.evaluate(r))],atan:[Ct,[Ct],(r,[e])=>Math.atan(e.evaluate(r))],min:[Ct,mo(Ct),(r,e)=>Math.min(...e.map(i=>i.evaluate(r)))],max:[Ct,mo(Ct),(r,e)=>Math.max(...e.map(i=>i.evaluate(r)))],abs:[Ct,[Ct],(r,[e])=>Math.abs(e.evaluate(r))],round:[Ct,[Ct],(r,[e])=>{const i=e.evaluate(r);return i<0?-Math.round(-i):Math.round(i)}],floor:[Ct,[Ct],(r,[e])=>Math.floor(e.evaluate(r))],ceil:[Ct,[Ct],(r,[e])=>Math.ceil(e.evaluate(r))],"filter-==":[yi,[Ci,Ti],(r,[e,i])=>r.properties()[e.value]===i.value],"filter-id-==":[yi,[Ti],(r,[e])=>r.id()===e.value],"filter-type-==":[yi,[Ci],(r,[e])=>r.geometryType()===e.value],"filter-<":[yi,[Ci,Ti],(r,[e,i])=>{const o=r.properties()[e.value],u=i.value;return typeof o==typeof u&&o<u}],"filter-id-<":[yi,[Ti],(r,[e])=>{const i=r.id(),o=e.value;return typeof i==typeof o&&i<o}],"filter->":[yi,[Ci,Ti],(r,[e,i])=>{const o=r.properties()[e.value],u=i.value;return typeof o==typeof u&&o>u}],"filter-id->":[yi,[Ti],(r,[e])=>{const i=r.id(),o=e.value;return typeof i==typeof o&&i>o}],"filter-<=":[yi,[Ci,Ti],(r,[e,i])=>{const o=r.properties()[e.value],u=i.value;return typeof o==typeof u&&o<=u}],"filter-id-<=":[yi,[Ti],(r,[e])=>{const i=r.id(),o=e.value;return typeof i==typeof o&&i<=o}],"filter->=":[yi,[Ci,Ti],(r,[e,i])=>{const o=r.properties()[e.value],u=i.value;return typeof o==typeof u&&o>=u}],"filter-id->=":[yi,[Ti],(r,[e])=>{const i=r.id(),o=e.value;return typeof i==typeof o&&i>=o}],"filter-has":[yi,[Ti],(r,[e])=>e.value in r.properties()],"filter-has-id":[yi,[],r=>r.id()!==null&&r.id()!==void 0],"filter-type-in":[yi,[Vn(Ci)],(r,[e])=>e.value.indexOf(r.geometryType())>=0],"filter-id-in":[yi,[Vn(Ti)],(r,[e])=>e.value.indexOf(r.id())>=0],"filter-in-small":[yi,[Ci,Vn(Ti)],(r,[e,i])=>i.value.indexOf(r.properties()[e.value])>=0],"filter-in-large":[yi,[Ci,Vn(Ti)],(r,[e,i])=>function(o,u,a,h){for(;a<=h;){const m=a+h>>1;if(u[m]===o)return!0;u[m]>o?h=m-1:a=m+1}return!1}(r.properties()[e.value],i.value,0,i.value.length-1)],all:{type:yi,overloads:[[[yi,yi],(r,[e,i])=>e.evaluate(r)&&i.evaluate(r)],[mo(yi),(r,e)=>{for(const i of e)if(!i.evaluate(r))return!1;return!0}]]},any:{type:yi,overloads:[[[yi,yi],(r,[e,i])=>e.evaluate(r)||i.evaluate(r)],[mo(yi),(r,e)=>{for(const i of e)if(i.evaluate(r))return!0;return!1}]]},"!":[yi,[yi],(r,[e])=>!e.evaluate(r)],"is-supported-script":[yi,[Ci],(r,[e])=>{const i=r.globals&&r.globals.isSupportedScript;return!i||i(e.evaluate(r))}],upcase:[Ci,[Ci],(r,[e])=>e.evaluate(r).toUpperCase()],downcase:[Ci,[Ci],(r,[e])=>e.evaluate(r).toLowerCase()],concat:[Ci,mo(Ti),(r,e)=>e.map(i=>Vr(i.evaluate(r))).join("")],"resolved-locale":[Ci,[gl],(r,[e])=>e.evaluate(r).resolvedLocale()],random:[Ct,[Ct,Ct,Ti],(r,e)=>{const[i,o,u]=e.map(h=>h.evaluate(r));if(i>o||i===o)return i;let a;if(typeof u=="string")a=function(h){let m=0;if(h.length===0)return m;for(let y=0;y<h.length;y++)m=(m<<5)-m+h.charCodeAt(y),m|=0;return m}(u);else{if(typeof u!="number")throw new pn(`Invalid seed input: ${u}`);a=u}return i+eu(a)()*(o-i)}]});class nu{constructor(e,i,o,u){this.expression=e,this._warningHistory={},this._evaluator=new hh(o,u),this._defaultValue=i?function(a){return a.type==="color"&&(Nh(a.default)||Array.isArray(a.default))?new Mi(0,0,0,0):a.type==="color"?Mi.parse(a.default)||null:a.default===void 0?null:a.default}(i):null,this._enumValues=i&&i.type==="enum"?i.values:null,this.configDependencies=zl(e)}evaluateWithoutErrorHandling(e,i,o,u,a,h,m,y){return this._evaluator.globals=e,this._evaluator.feature=i,this._evaluator.featureState=o,this._evaluator.canonical=u||null,this._evaluator.availableImages=a||null,this._evaluator.formattedSection=h,this._evaluator.featureTileCoord=m||null,this._evaluator.featureDistanceData=y||null,this.expression.evaluate(this._evaluator)}evaluate(e,i,o,u,a,h,m,y){this._evaluator.globals=e,this._evaluator.feature=i||null,this._evaluator.featureState=o||null,this._evaluator.canonical=u||null,this._evaluator.availableImages=a||null,this._evaluator.formattedSection=h||null,this._evaluator.featureTileCoord=m||null,this._evaluator.featureDistanceData=y||null;try{const T=this.expression.evaluate(this._evaluator);if(T==null||typeof T=="number"&&T!=T)return this._defaultValue;if(this._enumValues&&!(T in this._enumValues))throw new pn(`Expected value to be one of ${Object.keys(this._enumValues).map(f=>JSON.stringify(f)).join(", ")}, but found ${JSON.stringify(T)} instead.`);return T}catch(T){return this._warningHistory[T.message]||(this._warningHistory[T.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${T.message}`)),this._defaultValue}}}function Na(r){return Array.isArray(r)&&r.length>0&&typeof r[0]=="string"&&r[0]in Fa}function Va(r,e,i,o){const u=new Rl(Fa,[],e?function(h){const m={color:Yn,string:Ci,number:Ct,enum:Ci,boolean:yi,formatted:_s,resolvedImage:yl};return h.type==="array"?Vn(m[h.value]||Ti,h.length):m[h.type]}(e):void 0,void 0,void 0,i,o),a=u.parse(r,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return a?Bh(new nu(a,e,i,o)):Ir(u.errors)}class ru{constructor(e,i,o,u){this.kind=e,this._styleExpression=i,this.isLightConstant=o,this.isLineProgressConstant=u,this.isStateDependent=e!=="constant"&&!Pl(i.expression),this.configDependencies=zl(i.expression)}evaluateWithoutErrorHandling(e,i,o,u,a,h){return this._styleExpression.evaluateWithoutErrorHandling(e,i,o,u,a,h)}evaluate(e,i,o,u,a,h){return this._styleExpression.evaluate(e,i,o,u,a,h)}}class Bl{constructor(e,i,o,u,a,h){this.kind=e,this.zoomStops=o,this._styleExpression=i,this.isStateDependent=e!=="camera"&&!Pl(i.expression),this.isLightConstant=a,this.isLineProgressConstant=h,this.configDependencies=zl(i.expression),this.interpolationType=u}evaluateWithoutErrorHandling(e,i,o,u,a,h){return this._styleExpression.evaluateWithoutErrorHandling(e,i,o,u,a,h)}evaluate(e,i,o,u,a,h){return this._styleExpression.evaluate(e,i,o,u,a,h)}interpolationFactor(e,i,o){return this.interpolationType?vr.interpolationFactor(this.interpolationType,e,i,o):0}}function Vf(r,e,i,o){if((r=Va(r,e,i,o)).result==="error")return r;const u=r.value.expression,a=Ra(u);if(!a&&!Ol(e))return Ir([new li("","data expressions not supported")]);const h=Xo(u,["zoom","pitch","distance-from-center"]);if(!h&&!iu(e))return Ir([new li("","zoom expressions not supported")]);const m=Xo(u,["measure-light"]);if(!m&&!Ff(e))return Ir([new li("","measure-light expression not supported")]);const y=Xo(u,["line-progress"]);if(!y&&!function(x){return tu(x.expression,"line-progress")}(e))return Ir([new li("","line-progress expression not supported")]);const T=e.expression&&e.expression.relaxZoomRestriction,f=Vl(u);return f||h||T?f instanceof li?Ir([f]):f instanceof vr&&!Fl(e)?Ir([new li("",'"interpolate" expressions cannot be used with this property')]):Bh(f?new Bl(a&&y?"camera":"composite",r.value,f.labels,f instanceof vr?f.interpolation:void 0,m,y):new ru(a&&y?"constant":"source",r.value,m,y)):Ir([new li("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class Nl{constructor(e,i){this._parameters=e,this._specification=i,Fc(this,Vh(this._parameters,this._specification))}static deserialize(e){return new Nl(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Vl(r){let e=null;if(r instanceof Kc)e=Vl(r.result);else if(r instanceof Yc){for(const i of r.args)if(e=Vl(i),e)break}else(r instanceof La||r instanceof vr)&&r.input instanceof pr&&r.input.name==="zoom"&&(e=r);return e instanceof li||r.eachChild(i=>{const o=Vl(i);o instanceof li?e=o:e&&o&&e!==o&&(e=new li("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}var Uh,Uf,h_=function(){if(Uf)return Uh;Uf=1,Uh=e;var r=3;function e(i,o,u){var a=this.cells=[];if(i instanceof ArrayBuffer){this.arrayBuffer=i;var h=new Int32Array(this.arrayBuffer);i=h[0],this.d=(o=h[1])+2*(u=h[2]);for(var m=0;m<this.d*this.d;m++){var y=h[r+m],T=h[r+m+1];a.push(y===T?null:h.subarray(y,T))}var f=h[r+a.length+1];this.keys=h.subarray(h[r+a.length],f),this.bboxes=h.subarray(f),this.insert=this._insertReadonly}else{this.d=o+2*u;for(var x=0;x<this.d*this.d;x++)a.push([]);this.keys=[],this.bboxes=[]}this.n=o,this.extent=i,this.padding=u,this.scale=o/i,this.uid=0;var w=u/o*i;this.min=-w,this.max=i+w}return e.prototype.insert=function(i,o,u,a,h){this._forEachCell(o,u,a,h,this._insertCell,this.uid++),this.keys.push(i),this.bboxes.push(o),this.bboxes.push(u),this.bboxes.push(a),this.bboxes.push(h)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(i,o,u,a,h,m){this.cells[h].push(m)},e.prototype.query=function(i,o,u,a,h){var m=this.min,y=this.max;if(i<=m&&o<=m&&y<=u&&y<=a&&!h)return Array.prototype.slice.call(this.keys);var T=[];return this._forEachCell(i,o,u,a,this._queryCell,T,{},h),T},e.prototype._queryCell=function(i,o,u,a,h,m,y,T){var f=this.cells[h];if(f!==null)for(var x=this.keys,w=this.bboxes,g=0;g<f.length;g++){var v=f[g];if(y[v]===void 0){var S=4*v;(T?T(w[S+0],w[S+1],w[S+2],w[S+3]):i<=w[S+2]&&o<=w[S+3]&&u>=w[S+0]&&a>=w[S+1])?(y[v]=!0,m.push(x[v])):y[v]=!1}}},e.prototype._forEachCell=function(i,o,u,a,h,m,y,T){for(var f=this._convertToCellCoord(i),x=this._convertToCellCoord(o),w=this._convertToCellCoord(u),g=this._convertToCellCoord(a),v=f;v<=w;v++)for(var S=x;S<=g;S++){var C=this.d*S+v;if((!T||T(this._convertFromCellCoord(v),this._convertFromCellCoord(S),this._convertFromCellCoord(v+1),this._convertFromCellCoord(S+1)))&&h.call(this,i,o,u,a,C,m,y,T))return}},e.prototype._convertFromCellCoord=function(i){return(i-this.padding)/this.scale},e.prototype._convertToCellCoord=function(i){return Math.max(0,Math.min(this.d-1,Math.floor(i*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var i=this.cells,o=r+this.cells.length+1+1,u=0,a=0;a<this.cells.length;a++)u+=this.cells[a].length;var h=new Int32Array(o+u+this.keys.length+this.bboxes.length);h[0]=this.extent,h[1]=this.n,h[2]=this.padding;for(var m=o,y=0;y<i.length;y++){var T=i[y];h[r+y]=m,h.set(T,m),m+=T.length}return h[r+i.length]=m,h.set(this.keys,m),h[r+i.length+1]=m+=this.keys.length,h.set(this.bboxes,m),m+=this.bboxes.length,h.buffer},Uh}(),Jo=_e(h_);const su={};function Mt(r,e,i={}){Object.defineProperty(r,"_classRegistryKey",{value:e,writable:!1}),su[e]={klass:r,omit:i.omit||[]}}Mt(Object,"Object"),Jo.serialize=function(r,e){const i=r.toArrayBuffer();return e&&e.add(i),{buffer:i}},Jo.deserialize=function(r){return new Jo(r.buffer)},Object.defineProperty(Jo,"name",{value:"Grid"}),Mt(Jo,"Grid"),typeof DOMMatrix<"u"&&Mt(DOMMatrix,"DOMMatrix"),Mt(Mi,"Color"),Mt(Error,"Error"),Mt(Kn,"Formatted"),Mt(vl,"FormattedSection"),Mt(fn,"AJAXError"),Mt(Zn,"ResolvedImage"),Mt(Nl,"StylePropertyFunction"),Mt(nu,"StyleExpression",{omit:["_evaluator"]}),Mt(gs,"ImageIdWithOptions"),Mt(Bl,"ZoomDependentExpression"),Mt(ru,"ZoomConstantExpression"),Mt(pr,"CompoundExpression",{omit:["_evaluate"]});for(const r in Fa)su[Fa[r]._classRegistryKey]||Mt(Fa[r],`Expression${r}`);function jh(r){return r&&typeof ArrayBuffer<"u"&&(r instanceof ArrayBuffer||r.constructor&&r.constructor.name==="ArrayBuffer")}function Gh(r){return self.ImageBitmap&&r instanceof ImageBitmap}function _o(r,e){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp)return r;if(jh(r)||Gh(r))return e&&e.add(r),r;if(ArrayBuffer.isView(r))return e&&e.add(r.buffer),r;if(r instanceof ImageData)return e&&e.add(r.data.buffer),r;if(Array.isArray(r)){const i=[];for(const o of r)i.push(_o(o,e));return i}if(r instanceof Map){const i={$name:"Map"};for(const[o,u]of r.entries())i[o]=_o(u);return i}if(r instanceof Set){const i={$name:"Set"};let o=0;for(const u of r.values())i[++o]=_o(u);return i}if(typeof r=="object"){const i=r.constructor,o=i._classRegistryKey;if(!o)throw new Error(`Can't serialize object of unregistered class "${o}".`);const u=i.serialize?i.serialize(r,e):{};if(!i.serialize){for(const a in r)r.hasOwnProperty(a)&&(su[o].omit.indexOf(a)>=0||(u[a]=_o(r[a],e)));r instanceof Error&&(u.message=r.message)}if(u.$name)throw new Error("$name property is reserved for worker serialization logic.");return o!=="Object"&&(u.$name=o),u}throw new Error("can't serialize object of type "+typeof r)}function Qo(r){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp||jh(r)||Gh(r)||ArrayBuffer.isView(r)||r instanceof ImageData)return r;if(Array.isArray(r))return r.map(Qo);if(typeof r=="object"){const e=r.$name||"Object";if(e==="Map"){const u=new Map;for(const a of Object.keys(r))a!=="$name"&&u.set(a,Qo(r[a]));return u}if(e==="Set"){const u=new Set;for(const a of Object.keys(r))a!=="$name"&&u.add(Qo(r[a]));return u}const{klass:i}=su[e];if(!i)throw new Error(`Can't deserialize unregistered class "${e}".`);if(i.deserialize)return i.deserialize(r);const o=Object.create(i.prototype);for(const u of Object.keys(r))u!=="$name"&&(o[u]=Qo(r[u]));return o}throw new Error("can't deserialize object of type "+typeof r)}const Dt={"Latin-1 Supplement":r=>r>=128&&r<=255,Arabic:r=>r>=1536&&r<=1791,"Arabic Supplement":r=>r>=1872&&r<=1919,"Arabic Extended-A":r=>r>=2208&&r<=2303,"Hangul Jamo":r=>r>=4352&&r<=4607,"Unified Canadian Aboriginal Syllabics":r=>r>=5120&&r<=5759,Khmer:r=>r>=6016&&r<=6143,"Unified Canadian Aboriginal Syllabics Extended":r=>r>=6320&&r<=6399,"General Punctuation":r=>r>=8192&&r<=8303,"Letterlike Symbols":r=>r>=8448&&r<=8527,"Number Forms":r=>r>=8528&&r<=8591,"Miscellaneous Technical":r=>r>=8960&&r<=9215,"Control Pictures":r=>r>=9216&&r<=9279,"Optical Character Recognition":r=>r>=9280&&r<=9311,"Enclosed Alphanumerics":r=>r>=9312&&r<=9471,"Geometric Shapes":r=>r>=9632&&r<=9727,"Miscellaneous Symbols":r=>r>=9728&&r<=9983,"Miscellaneous Symbols and Arrows":r=>r>=11008&&r<=11263,"CJK Radicals Supplement":r=>r>=11904&&r<=12031,"Kangxi Radicals":r=>r>=12032&&r<=12255,"Ideographic Description Characters":r=>r>=12272&&r<=12287,"CJK Symbols and Punctuation":r=>r>=12288&&r<=12351,Hiragana:r=>r>=12352&&r<=12447,Katakana:r=>r>=12448&&r<=12543,Bopomofo:r=>r>=12544&&r<=12591,"Hangul Compatibility Jamo":r=>r>=12592&&r<=12687,Kanbun:r=>r>=12688&&r<=12703,"Bopomofo Extended":r=>r>=12704&&r<=12735,"CJK Strokes":r=>r>=12736&&r<=12783,"Katakana Phonetic Extensions":r=>r>=12784&&r<=12799,"Enclosed CJK Letters and Months":r=>r>=12800&&r<=13055,"CJK Compatibility":r=>r>=13056&&r<=13311,"CJK Unified Ideographs Extension A":r=>r>=13312&&r<=19903,"Yijing Hexagram Symbols":r=>r>=19904&&r<=19967,"CJK Unified Ideographs":r=>r>=19968&&r<=40959,"Yi Syllables":r=>r>=40960&&r<=42127,"Yi Radicals":r=>r>=42128&&r<=42191,"Hangul Jamo Extended-A":r=>r>=43360&&r<=43391,"Hangul Syllables":r=>r>=44032&&r<=55215,"Hangul Jamo Extended-B":r=>r>=55216&&r<=55295,"Private Use Area":r=>r>=57344&&r<=63743,"CJK Compatibility Ideographs":r=>r>=63744&&r<=64255,"Arabic Presentation Forms-A":r=>r>=64336&&r<=65023,"Vertical Forms":r=>r>=65040&&r<=65055,"CJK Compatibility Forms":r=>r>=65072&&r<=65103,"Small Form Variants":r=>r>=65104&&r<=65135,"Arabic Presentation Forms-B":r=>r>=65136&&r<=65279,"Halfwidth and Fullwidth Forms":r=>r>=65280&&r<=65519,Osage:r=>r>=66736&&r<=66815,"CJK Unified Ideographs Extension B":r=>r>=131072&&r<=173791};function qh(r){for(const e of r)if(ou(e.charCodeAt(0)))return!0;return!1}function d_(r){for(const e of r)if(!f_(e.charCodeAt(0)))return!1;return!0}function f_(r){return!(Dt.Arabic(r)||Dt["Arabic Supplement"](r)||Dt["Arabic Extended-A"](r)||Dt["Arabic Presentation Forms-A"](r)||Dt["Arabic Presentation Forms-B"](r))}function ou(r){return!(r!==746&&r!==747&&(r<4352||!(Dt["Bopomofo Extended"](r)||Dt.Bopomofo(r)||Dt["CJK Compatibility Forms"](r)&&!(r>=65097&&r<=65103)||Dt["CJK Compatibility Ideographs"](r)||Dt["CJK Compatibility"](r)||Dt["CJK Radicals Supplement"](r)||Dt["CJK Strokes"](r)||!(!Dt["CJK Symbols and Punctuation"](r)||r>=12296&&r<=12305||r>=12308&&r<=12319||r===12336)||Dt["CJK Unified Ideographs Extension A"](r)||Dt["CJK Unified Ideographs"](r)||Dt["Enclosed CJK Letters and Months"](r)||Dt["Hangul Compatibility Jamo"](r)||Dt["Hangul Jamo Extended-A"](r)||Dt["Hangul Jamo Extended-B"](r)||Dt["Hangul Jamo"](r)||Dt["Hangul Syllables"](r)||Dt.Hiragana(r)||Dt["Ideographic Description Characters"](r)||Dt.Kanbun(r)||Dt["Kangxi Radicals"](r)||Dt["Katakana Phonetic Extensions"](r)||Dt.Katakana(r)&&r!==12540||!(!Dt["Halfwidth and Fullwidth Forms"](r)||r===65288||r===65289||r===65293||r>=65306&&r<=65310||r===65339||r===65341||r===65343||r>=65371&&r<=65503||r===65507||r>=65512&&r<=65519)||!(!Dt["Small Form Variants"](r)||r>=65112&&r<=65118||r>=65123&&r<=65126)||Dt["Unified Canadian Aboriginal Syllabics"](r)||Dt["Unified Canadian Aboriginal Syllabics Extended"](r)||Dt["Vertical Forms"](r)||Dt["Yijing Hexagram Symbols"](r)||Dt["Yi Syllables"](r)||Dt["Yi Radicals"](r))))}function $h(r){return!(ou(r)||function(e){return!!(Dt["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||Dt["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||Dt["Letterlike Symbols"](e)||Dt["Number Forms"](e)||Dt["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||Dt["Control Pictures"](e)&&e!==9251||Dt["Optical Character Recognition"](e)||Dt["Enclosed Alphanumerics"](e)||Dt["Geometric Shapes"](e)||Dt["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Dt["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Dt["CJK Symbols and Punctuation"](e)||Dt.Katakana(e)||Dt["Private Use Area"](e)||Dt["CJK Compatibility Forms"](e)||Dt["Small Form Variants"](e)||Dt["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(r))}function Zh(r){return r>=1424&&r<=2303||Dt["Arabic Presentation Forms-A"](r)||Dt["Arabic Presentation Forms-B"](r)}function jf(r,e){return!(!e&&Zh(r)||r>=2304&&r<=3583||r>=3840&&r<=4255||Dt.Khmer(r))}function Hh(r){for(const e of r)if(Zh(e.charCodeAt(0)))return!0;return!1}const Ul="deferred",au="loading",Wh="loaded";let ys=null,br="unavailable",go=null;const Xh=function(r){r&&typeof r=="string"&&r.indexOf("NetworkError")>-1&&(br="error"),ys&&ys(r)};function Yh(){Ua.fire(new ms("pluginStateChange",{pluginStatus:br,pluginURL:go}))}const Ua=new uo,lu=function(){return br},jl=function(){if(br!==Ul||!go)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");br=au,Yh(),go&&Cn({url:go},r=>{r?Xh(r):(br=Wh,Yh())})},Ar={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>br===Wh||Ar.applyArabicShaping!=null,isLoading:()=>br===au,setState(r){br=r.pluginStatus,go=r.pluginURL},isParsed:()=>Ar.applyArabicShaping!=null&&Ar.processBidirectionalText!=null&&Ar.processStyledBidirectionalText!=null,getPluginURL:()=>go};class Vi{constructor(e,i){this.zoom=e,i?(this.now=i.now,this.fadeDuration=i.fadeDuration,this.transition=i.transition,this.pitch=i.pitch,this.brightness=i.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return function(i,o){for(const u of i)if(!jf(u.charCodeAt(0),o))return!1;return!0}(e,Ar.isLoaded())}}class cu{constructor(e,i,o,u){this.property=e,this.value=i,this.expression=function(a,h,m,y){if(Nh(a))return new Nl(a,h);if(Na(a)||Array.isArray(a)&&a.length>0){const T=Vf(a,h,m,y);if(T.result==="error")throw new Error(T.value.map(f=>`${f.key}: ${f.message}`).join(", "));return T.value}{let T=a;return typeof a=="string"&&h.type==="color"&&(T=Mi.parse(a)),{kind:"constant",configDependencies:new Set,evaluate:()=>T}}}(i===void 0?e.specification.default:i,e.specification,o,u)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,i,o){return this.property.possiblyEvaluate(this,e,i,o)}}class Gl{constructor(e,i,o){this.property=e,this.value=new cu(e,void 0,i,o)}transitioned(e,i){return new Kh(this.property,this.value,i,sr({},e.transition,this.transition),e.now)}untransitioned(){return new Kh(this.property,this.value,null,{},0)}}class uu{constructor(e,i,o){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=i,this._options=o,this.configDependencies=new Set}getValue(e){return Mr(this._values[e].value.value)}setValue(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new Gl(this._values[e].property,this._scope,this._options)),this._values[e].value=new cu(this._values[e].property,i===null?void 0:Mr(i),this._scope,this._options),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]))}setTransitionOrValue(e,i){i&&(this._options=i);const o=this._properties.properties;if(e)for(const u in e){const a=e[u];if(dr(u,"-transition")){const h=u.slice(0,-11);o[h]&&this.setTransition(h,a)}else o.hasOwnProperty(u)&&this.setValue(u,a)}}getTransition(e){return Mr(this._values[e].transition)}setTransition(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new Gl(this._values[e].property)),this._values[e].transition=Mr(i)||void 0}serialize(){const e={};for(const i of Object.keys(this._values)){const o=this.getValue(i);o!==void 0&&(e[i]=o);const u=this.getTransition(i);u!==void 0&&(e[`${i}-transition`]=u)}return e}transitioned(e,i){const o=new ql(this._properties);for(const u of Object.keys(this._values))o._values[u]=this._values[u].transitioned(e,i._values[u]);return o}untransitioned(){const e=new ql(this._properties);for(const i of Object.keys(this._values))e._values[i]=this._values[i].untransitioned();return e}}class Kh{constructor(e,i,o,u,a){const h=u.delay||0,m=u.duration||0;a=a||0,this.property=e,this.value=i,this.begin=a+h,this.end=this.begin+m,e.specification.transition&&(u.delay||u.duration)&&(this.prior=o)}possiblyEvaluate(e,i,o){const u=e.now||0,a=this.value.possiblyEvaluate(e,i,o),h=this.prior;if(h){if(u>this.end)return this.prior=null,a;if(this.value.isDataDriven())return this.prior=null,a;if(u<this.begin)return h.possiblyEvaluate(e,i,o);{const m=(u-this.begin)/(this.end-this.begin);return this.property.interpolate(h.possiblyEvaluate(e,i,o),a,ao(m))}}return a}}class ql{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,i,o){const u=new qa(this._properties);for(const a of Object.keys(this._values))u._values[a]=this._values[a].possiblyEvaluate(e,i,o);return u}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class ja{constructor(e,i,o){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=i,this._options=o,this.configDependencies=new Set}getValue(e){return Mr(this._values[e].value)}setValue(e,i){this._values[e]=new cu(this._values[e].property,i===null?void 0:Mr(i),this._scope,this._options),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]))}serialize(){const e={};for(const i of Object.keys(this._values)){const o=this.getValue(i);o!==void 0&&(e[i]=o)}return e}possiblyEvaluate(e,i,o){const u=new qa(this._properties);for(const a of Object.keys(this._values))u._values[a]=this._values[a].possiblyEvaluate(e,i,o);return u}}class Ga{constructor(e,i,o){this.property=e,this.value=i,this.parameters=o}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,i,o,u){return this.property.evaluate(this.value,this.parameters,e,i,o,u)}}class qa{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class at{constructor(e){this.specification=e}possiblyEvaluate(e,i){return e.expression.evaluate(i)}interpolate(e,i,o){const u=Oc[this.specification.type];return u?u(e,i,o):e}}class wt{constructor(e,i){this.specification=e,this.overrides=i}possiblyEvaluate(e,i,o,u){return new Ga(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(i,null,{},o,u)}:e.expression,i)}interpolate(e,i,o){if(e.value.kind!=="constant"||i.value.kind!=="constant")return e;if(e.value.value===void 0||i.value.value===void 0)return new Ga(this,{kind:"constant",value:void 0},e.parameters);const u=Oc[this.specification.type];return u?new Ga(this,{kind:"constant",value:u(e.value.value,i.value.value,o)},e.parameters):e}evaluate(e,i,o,u,a,h){return e.kind==="constant"?e.value:e.evaluate(i,o,u,a,h)}}class $a{constructor(e){this.specification=e}possiblyEvaluate(e,i,o,u){return!!e.expression.evaluate(i,null,{},o,u)}interpolate(){return!1}}class Yi{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const i=new Vi(0,{});for(const o in e){const u=e[o];u.specification.overridable&&this.overridableProperties.push(o);const a=this.defaultPropertyValues[o]=new cu(u,void 0),h=this.defaultTransitionablePropertyValues[o]=new Gl(u);this.defaultTransitioningPropertyValues[o]=h.untransitioned(),this.defaultPossiblyEvaluatedValues[o]=a.possiblyEvaluate(i)}}}Mt(wt,"DataDrivenProperty"),Mt(at,"DataConstantProperty"),Mt($a,"ColorRampProperty");var ke=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow","experimental":true},"rain":{"type":"rain","experimental":true},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor","experimental":true},"imports":{"type":"array","value":"import"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"experimental":true,"type":"featuresets"}},"featuresets":{"experimental":true,"*":{"type":"featureset"}},"featureset":{"experimental":true,"metadata":{"experimental":true,"type":"*"},"selectors":{"experimental":true,"type":"array","value":"selector"}},"selector":{"experimental":true,"layer":{"experimental":true,"type":"string","required":true},"properties":{"experimental":true,"type":"selectorProperty","required":false},"featureNamespace":{"experimental":true,"type":"string","required":false},"_uniqueFeatureID":{"experimental":true,"type":"boolean","private":true,"required":false}},"selectorProperty":{"experimental":true,"*":{"experimental":true,"type":"*"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","property-type":"data-constant","expression":{},"required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"property-type":"data-constant"},"shadow-quality":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]},"experimental":true},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"experimental":true,"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"raster-particle":{"experimental":true},"hillshade":{},"model":{"experimental":true},"background":{},"sky":{},"slot":{},"clip":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{},"property-type":"data-constant"},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{},"property-type":"data-constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","experimental":true,"private":true,"expression":{},"property-type":"data-constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","experimental":true,"expression":{},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","experimental":true,"default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","experimental":true,"expression":{},"property-type":"data-constant"},"line-cross-slope":{"type":"number","experimental":true,"expression":{},"property-type":"constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","experimental":true,"private":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","experimental":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","property-type":"data-constant","default":"#ffffff","experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","property-type":"data-constant","default":0.4,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","property-type":"data-constant","default":0.71,"minimum":0,"maximum":5,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","property-type":"data-constant","default":0.57,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","property-type":"data-constant","default":0.7,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"colorTheme":{"data":{"type":"string","property-type":"data-constant","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","experimental":true,"property-type":"data-constant","expression":{}},"buildingFeaturesetId":{"type":"string","experimental":true,"property-type":"data-constant","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","experimental":true,"values":{"terrain":1,"flat":1},"default":"flat","property-type":"data-constant"},"fill-extrusion-base-alignment":{"type":"enum","experimental":true,"values":{"terrain":1,"flat":1},"default":"terrain","property-type":"data-constant"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","experimental":true,"default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","experimental":true,"default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"experimental":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-trim-fade-range":{"type":"array","value":"number","experimental":true,"length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-trim-color":{"type":"color","experimental":true,"default":"transparent","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"property-type":"data-constant"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"experimental":true,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-particle-count":{"type":"number","default":512,"minimum":1,"property-type":"data-constant"},"raster-particle-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-particle-speed"]},"property-type":"color-ramp"},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1,"property-type":"data-constant"},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1,"property-type":"data-constant"},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]},"experimental":true,"property-type":"data-constant"},"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"model-front-cutoff":{"type":"array","private":true,"value":"number","property-type":"data-constant","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"*"}}}');function Gf(r){return r instanceof Number||r instanceof String||r instanceof Boolean?r.valueOf():r}function hu(r){if(Array.isArray(r))return r.map(hu);if(r instanceof Object&&!(r instanceof Number||r instanceof String||r instanceof Boolean)){const e={};for(const i in r)e[i]=hu(r[i]);return e}return Gf(r)}function Jh(r){if(r===!0||r===!1)return!0;if(!Array.isArray(r)||r.length===0)return!1;switch(r[0]){case"has":return r.length>=2&&r[1]!=="$id"&&r[1]!=="$type";case"in":return r.length>=3&&(typeof r[1]!="string"||Array.isArray(r[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return r.length!==3||Array.isArray(r[1])||Array.isArray(r[2]);case"any":case"all":for(const e of r.slice(1))if(!Jh(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function qf(r,e="",i=null,o="fill"){if(r==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Jh(r)||(r=du(r));const u=r;let a=!0;try{a=function(f){if(!Za(f))return f;let x=hu(f);return Zf(x),x=$f(x),x}(u)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(u,null,2)}
        `)}let h=null,m=null;if(o!=="background"&&o!=="sky"&&o!=="slot"){m=ke[`filter_${o}`];const f=Va(a,m,e,i);if(f.result==="error")throw new Error(f.value.map(x=>`${x.key}: ${x.message}`).join(", "));h=(x,w,g)=>f.value.evaluate(x,w,{},g)}let y=null,T=null;if(a!==u){const f=Va(u,m,e,i);if(f.result==="error")throw new Error(f.value.map(x=>`${x.key}: ${x.message}`).join(", "));y=(x,w,g,v,S)=>f.value.evaluate(x,w,{},g,void 0,void 0,v,S),T=!Ra(f.value.expression)}return{filter:h,dynamicFilter:y||void 0,needGeometry:Hf(a),needFeature:!!T}}function $f(r){if(!Array.isArray(r))return r;const e=function(i){if(p_.has(i[0])){for(let o=1;o<i.length;o++)if(Za(i[o]))return!0}return i}(r);return e===!0?e:e.map(i=>$f(i))}function Zf(r){let e=!1;const i=[];if(r[0]==="case"){for(let o=1;o<r.length-1;o+=2)e=e||Za(r[o]),i.push(r[o+1]);i.push(r[r.length-1])}else if(r[0]==="match"){e=e||Za(r[1]);for(let o=2;o<r.length-1;o+=2)i.push(r[o+1]);i.push(r[r.length-1])}else if(r[0]==="step"){e=e||Za(r[1]);for(let o=1;o<r.length-1;o+=2)i.push(r[o+1])}e&&(r.length=0,r.push("any",...i));for(let o=1;o<r.length;o++)Zf(r[o])}function Za(r){if(!Array.isArray(r))return!1;if((e=r[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let i=1;i<r.length;i++)if(Za(r[i]))return!0;return!1}const p_=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function m_(r,e){return r<e?-1:r>e?1:0}function Hf(r){if(!Array.isArray(r))return!1;if(r[0]==="within"||r[0]==="distance")return!0;for(let e=1;e<r.length;e++)if(Hf(r[e]))return!0;return!1}function du(r){if(!r)return!0;const e=r[0];return r.length<=1?e!=="any":e==="=="?yo(r[1],r[2],"=="):e==="!="?ea(yo(r[1],r[2],"==")):e==="<"||e===">"||e==="<="||e===">="?yo(r[1],r[2],e):e==="any"?(i=r.slice(1),["any"].concat(i.map(du))):e==="all"?["all"].concat(r.slice(1).map(du)):e==="none"?["all"].concat(r.slice(1).map(du).map(ea)):e==="in"?Qh(r[1],r.slice(2)):e==="!in"?ea(Qh(r[1],r.slice(2))):e==="has"?ed(r[1]):e!=="!has"||ea(ed(r[1]));var i}function yo(r,e,i){switch(r){case"$type":return[`filter-type-${i}`,e];case"$id":return[`filter-id-${i}`,e];default:return[`filter-${i}`,r,e]}}function Qh(r,e){if(e.length===0)return!1;switch(r){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(i=>typeof i!=typeof e[0])?["filter-in-large",r,["literal",e.sort(m_)]]:["filter-in-small",r,["literal",e]]}}function ed(r){switch(r){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",r]}}function ea(r){return["!",r]}const fu="";function xs(r,e){return e?`${r}${fu}${e}`:r}const Xs="-transition",Wf=new Set(["fill","line","background","hillshade","raster"]);class kn extends uo{constructor(e,i,o,u,a){if(super(),this.id=e.id,this.fqid=xs(this.id,o),this.type=e.type,this.scope=o,this.lut=u,this.options=a,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,e.type!=="custom"){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;const h=Va(this.filter,ke[`filter_${e.type}`]);h.result!=="error"&&(this.configDependencies=new Set([...this.configDependencies,...h.value.configDependencies]))}if(e.slot&&(this.slot=e.slot),i.layout&&(this._unevaluatedLayout=new ja(i.layout,this.scope,a),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),i.paint){this._transitionablePaint=new uu(i.paint,this.scope,a);for(const h in e.paint)this.setPaintProperty(h,e.paint[h]);for(const h in e.layout)this.setLayoutProperty(h,e.layout[h]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new qa(i.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D()&&Wf.has(this.type)}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,i){if(this.type==="custom"&&e==="visibility")return void(this.visibility=i);const o=this._unevaluatedLayout;o._properties.properties[e]&&(o.setValue(e,i),this.configDependencies=new Set([...this.configDependencies,...o.configDependencies]),e==="visibility"&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return dr(e,Xs)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,i){const o=this._transitionablePaint,u=o._properties.properties;if(dr(e,Xs)){const x=e.slice(0,-11);return u[x]&&o.setTransition(x,i||void 0),!1}if(!u[e])return!1;const a=o._values[e],h=a.value.isDataDriven(),m=a.value;o.setValue(e,i),this.configDependencies=new Set([...this.configDependencies,...o.configDependencies]),this._handleSpecialPaintPropertyUpdate(e);const y=o._values[e].value,T=y.isDataDriven(),f=dr(e,"pattern")||e==="line-dasharray";return T||h||f||this._handleOverridablePaintPropertyUpdate(e,m,y)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,i,o){return null}_handleOverridablePaintPropertyUpdate(e,i,o){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,i){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,i)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,i)}serialize(){return Sa({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(e,i)=>!(e===void 0||i==="layout"&&!Object.keys(e).length||i==="paint"&&!Object.keys(e).length))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(const e in this.paint._values){const i=this.paint.get(e);if(i instanceof Ga&&Ol(i.property.specification)&&(i.value.kind==="source"||i.value.kind==="composite")&&i.value.isStateDependent)return!0}return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=qf(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(e){}queryIntersectsFeature(e,i,o,u,a,h,m,y,T){}}const __={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class $l{constructor(e,i){this._structArray=e,this._pos1=i*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Ui{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(e,i){return e._trim(),i&&(e.isTransferred=!0,i.add(e.arrayBuffer)),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const i=Object.create(this.prototype);return i.arrayBuffer=e.arrayBuffer,i.length=e.length,i.capacity=e.arrayBuffer.byteLength/i.bytesPerElement,i._refreshViews(),i}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const i=this.uint8;this._refreshViews(),i&&this.uint8.set(i)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Ii(r,e=1){let i=0,o=0;return{members:r.map(u=>{const a=__[u.type].BYTES_PER_ELEMENT,h=i=Xf(i,Math.max(e,a)),m=u.components||1;return o=Math.max(o,a),i+=a*m,{name:u.name,type:u.type,components:m,offset:h}}),size:Xf(i,Math.max(o,e)),alignment:e}}function Xf(r,e){return Math.ceil(r/e)*e}class Ys extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i){const o=this.length;return this.resize(o+1),this.emplace(o,e,i)}emplace(e,i,o){const u=2*e;return this.int16[u+0]=i,this.int16[u+1]=o,e}}Ys.prototype.bytesPerElement=4,Mt(Ys,"StructArrayLayout2i4");class Ha extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,o)}emplace(e,i,o,u){const a=3*e;return this.int16[a+0]=i,this.int16[a+1]=o,this.int16[a+2]=u,e}}Ha.prototype.bytesPerElement=6,Mt(Ha,"StructArrayLayout3i6");class Ks extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,u){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,o,u)}emplace(e,i,o,u,a){const h=4*e;return this.int16[h+0]=i,this.int16[h+1]=o,this.int16[h+2]=u,this.int16[h+3]=a,e}}Ks.prototype.bytesPerElement=8,Mt(Ks,"StructArrayLayout4i8");class pu extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,u,a){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,o,u,a)}emplace(e,i,o,u,a,h){const m=5*e;return this.int16[m+0]=i,this.int16[m+1]=o,this.int16[m+2]=u,this.int16[m+3]=a,this.int16[m+4]=h,e}}pu.prototype.bytesPerElement=10,Mt(pu,"StructArrayLayout5i10");class Zl extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,u,a,h,m){const y=this.length;return this.resize(y+1),this.emplace(y,e,i,o,u,a,h,m)}emplace(e,i,o,u,a,h,m,y){const T=6*e,f=12*e,x=3*e;return this.int16[T+0]=i,this.int16[T+1]=o,this.uint8[f+4]=u,this.uint8[f+5]=a,this.uint8[f+6]=h,this.uint8[f+7]=m,this.float32[x+2]=y,e}}Zl.prototype.bytesPerElement=12,Mt(Zl,"StructArrayLayout2i4ub1f12");class vs extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,o)}emplace(e,i,o,u){const a=3*e;return this.float32[a+0]=i,this.float32[a+1]=o,this.float32[a+2]=u,e}}vs.prototype.bytesPerElement=12,Mt(vs,"StructArrayLayout3f12");class Jn extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,u,a){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,o,u,a)}emplace(e,i,o,u,a,h){const m=6*e,y=3*e;return this.uint16[m+0]=i,this.uint16[m+1]=o,this.uint16[m+2]=u,this.uint16[m+3]=a,this.float32[y+2]=h,e}}Jn.prototype.bytesPerElement=12,Mt(Jn,"StructArrayLayout4ui1f12");class mu extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,u){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,o,u)}emplace(e,i,o,u,a){const h=4*e;return this.uint16[h+0]=i,this.uint16[h+1]=o,this.uint16[h+2]=u,this.uint16[h+3]=a,e}}mu.prototype.bytesPerElement=8,Mt(mu,"StructArrayLayout4ui8");class Hl extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,u,a,h){const m=this.length;return this.resize(m+1),this.emplace(m,e,i,o,u,a,h)}emplace(e,i,o,u,a,h,m){const y=6*e;return this.int16[y+0]=i,this.int16[y+1]=o,this.int16[y+2]=u,this.int16[y+3]=a,this.int16[y+4]=h,this.int16[y+5]=m,e}}Hl.prototype.bytesPerElement=12,Mt(Hl,"StructArrayLayout6i12");class td extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,u,a,h,m,y,T,f,x,w){const g=this.length;return this.resize(g+1),this.emplace(g,e,i,o,u,a,h,m,y,T,f,x,w)}emplace(e,i,o,u,a,h,m,y,T,f,x,w,g){const v=12*e;return this.int16[v+0]=i,this.int16[v+1]=o,this.int16[v+2]=u,this.int16[v+3]=a,this.uint16[v+4]=h,this.uint16[v+5]=m,this.uint16[v+6]=y,this.uint16[v+7]=T,this.int16[v+8]=f,this.int16[v+9]=x,this.int16[v+10]=w,this.int16[v+11]=g,e}}td.prototype.bytesPerElement=24,Mt(td,"StructArrayLayout4i4ui4i24");class id extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,u,a,h){const m=this.length;return this.resize(m+1),this.emplace(m,e,i,o,u,a,h)}emplace(e,i,o,u,a,h,m){const y=10*e,T=5*e;return this.int16[y+0]=i,this.int16[y+1]=o,this.int16[y+2]=u,this.float32[T+2]=a,this.float32[T+3]=h,this.float32[T+4]=m,e}}id.prototype.bytesPerElement=20,Mt(id,"StructArrayLayout3i3f20");class ta extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,u){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,o,u)}emplace(e,i,o,u,a){const h=4*e;return this.float32[h+0]=i,this.float32[h+1]=o,this.float32[h+2]=u,this.float32[h+3]=a,e}}ta.prototype.bytesPerElement=16,Mt(ta,"StructArrayLayout4f16");class nd extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint32[1*e+0]=i,e}}nd.prototype.bytesPerElement=4,Mt(nd,"StructArrayLayout1ul4");class xo extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i){const o=this.length;return this.resize(o+1),this.emplace(o,e,i)}emplace(e,i,o){const u=2*e;return this.uint16[u+0]=i,this.uint16[u+1]=o,e}}xo.prototype.bytesPerElement=4,Mt(xo,"StructArrayLayout2ui4");class rd extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,u,a,h,m,y,T,f,x,w,g){const v=this.length;return this.resize(v+1),this.emplace(v,e,i,o,u,a,h,m,y,T,f,x,w,g)}emplace(e,i,o,u,a,h,m,y,T,f,x,w,g,v){const S=20*e,C=10*e;return this.int16[S+0]=i,this.int16[S+1]=o,this.int16[S+2]=u,this.int16[S+3]=a,this.int16[S+4]=h,this.float32[C+3]=m,this.float32[C+4]=y,this.float32[C+5]=T,this.float32[C+6]=f,this.int16[S+14]=x,this.uint32[C+8]=w,this.uint16[S+18]=g,this.uint16[S+19]=v,e}}rd.prototype.bytesPerElement=40,Mt(rd,"StructArrayLayout5i4f1i1ul2ui40");class _u extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,u,a,h,m){const y=this.length;return this.resize(y+1),this.emplace(y,e,i,o,u,a,h,m)}emplace(e,i,o,u,a,h,m,y){const T=8*e;return this.int16[T+0]=i,this.int16[T+1]=o,this.int16[T+2]=u,this.int16[T+4]=a,this.int16[T+5]=h,this.int16[T+6]=m,this.int16[T+7]=y,e}}_u.prototype.bytesPerElement=16,Mt(_u,"StructArrayLayout3i2i2i16");class sd extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,u,a){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,o,u,a)}emplace(e,i,o,u,a,h){const m=4*e,y=8*e;return this.float32[m+0]=i,this.float32[m+1]=o,this.float32[m+2]=u,this.int16[y+6]=a,this.int16[y+7]=h,e}}sd.prototype.bytesPerElement=16,Mt(sd,"StructArrayLayout2f1f2i16");class od extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,u,a,h){const m=this.length;return this.resize(m+1),this.emplace(m,e,i,o,u,a,h)}emplace(e,i,o,u,a,h,m){const y=20*e,T=5*e;return this.uint8[y+0]=i,this.uint8[y+1]=o,this.float32[T+1]=u,this.float32[T+2]=a,this.float32[T+3]=h,this.float32[T+4]=m,e}}od.prototype.bytesPerElement=20,Mt(od,"StructArrayLayout2ub4f20");class Gn extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,o)}emplace(e,i,o,u){const a=3*e;return this.uint16[a+0]=i,this.uint16[a+1]=o,this.uint16[a+2]=u,e}}Gn.prototype.bytesPerElement=6,Mt(Gn,"StructArrayLayout3ui6");class ad extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,o,u,a,h,m,y,T,f,x,w,g,v,S,C,z,O,B,L,V){const j=this.length;return this.resize(j+1),this.emplace(j,e,i,o,u,a,h,m,y,T,f,x,w,g,v,S,C,z,O,B,L,V)}emplace(e,i,o,u,a,h,m,y,T,f,x,w,g,v,S,C,z,O,B,L,V,j){const W=30*e,te=15*e,ee=60*e;return this.int16[W+0]=i,this.int16[W+1]=o,this.int16[W+2]=u,this.float32[te+2]=a,this.float32[te+3]=h,this.uint16[W+8]=m,this.uint16[W+9]=y,this.uint32[te+5]=T,this.uint32[te+6]=f,this.uint32[te+7]=x,this.uint16[W+16]=w,this.uint16[W+17]=g,this.uint16[W+18]=v,this.float32[te+10]=S,this.float32[te+11]=C,this.uint8[ee+48]=z,this.uint8[ee+49]=O,this.uint8[ee+50]=B,this.uint32[te+13]=L,this.int16[W+28]=V,this.uint8[ee+58]=j,e}}ad.prototype.bytesPerElement=60,Mt(ad,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class ld extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,o,u,a,h,m,y,T,f,x,w,g,v,S,C,z,O,B,L,V,j,W,te,ee,Q,pe,ie,me,xe,ye,we){const Ae=this.length;return this.resize(Ae+1),this.emplace(Ae,e,i,o,u,a,h,m,y,T,f,x,w,g,v,S,C,z,O,B,L,V,j,W,te,ee,Q,pe,ie,me,xe,ye,we)}emplace(e,i,o,u,a,h,m,y,T,f,x,w,g,v,S,C,z,O,B,L,V,j,W,te,ee,Q,pe,ie,me,xe,ye,we,Ae){const Re=20*e,Ee=40*e,$e=80*e;return this.float32[Re+0]=i,this.float32[Re+1]=o,this.int16[Ee+4]=u,this.int16[Ee+5]=a,this.int16[Ee+6]=h,this.int16[Ee+7]=m,this.int16[Ee+8]=y,this.int16[Ee+9]=T,this.int16[Ee+10]=f,this.int16[Ee+11]=x,this.int16[Ee+12]=w,this.uint16[Ee+13]=g,this.uint16[Ee+14]=v,this.uint16[Ee+15]=S,this.uint16[Ee+16]=C,this.uint16[Ee+17]=z,this.uint16[Ee+18]=O,this.uint16[Ee+19]=B,this.uint16[Ee+20]=L,this.uint16[Ee+21]=V,this.uint16[Ee+22]=j,this.uint16[Ee+23]=W,this.uint16[Ee+24]=te,this.uint16[Ee+25]=ee,this.uint16[Ee+26]=Q,this.uint16[Ee+27]=pe,this.uint32[Re+14]=ie,this.float32[Re+15]=me,this.float32[Re+16]=xe,this.float32[Re+17]=ye,this.float32[Re+18]=we,this.uint8[$e+76]=Ae,e}}ld.prototype.bytesPerElement=80,Mt(ld,"StructArrayLayout2f9i15ui1ul4f1ub80");class Wl extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.float32[1*e+0]=i,e}}Wl.prototype.bytesPerElement=4,Mt(Wl,"StructArrayLayout1f4");class vo extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,u,a){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,o,u,a)}emplace(e,i,o,u,a,h){const m=5*e;return this.float32[m+0]=i,this.float32[m+1]=o,this.float32[m+2]=u,this.float32[m+3]=a,this.float32[m+4]=h,e}}vo.prototype.bytesPerElement=20,Mt(vo,"StructArrayLayout5f20");class gu extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,u,a,h,m){const y=this.length;return this.resize(y+1),this.emplace(y,e,i,o,u,a,h,m)}emplace(e,i,o,u,a,h,m,y){const T=7*e;return this.float32[T+0]=i,this.float32[T+1]=o,this.float32[T+2]=u,this.float32[T+3]=a,this.float32[T+4]=h,this.float32[T+5]=m,this.float32[T+6]=y,e}}gu.prototype.bytesPerElement=28,Mt(gu,"StructArrayLayout7f28");class bs extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,u,a,h,m,y,T,f,x){const w=this.length;return this.resize(w+1),this.emplace(w,e,i,o,u,a,h,m,y,T,f,x)}emplace(e,i,o,u,a,h,m,y,T,f,x,w){const g=11*e;return this.float32[g+0]=i,this.float32[g+1]=o,this.float32[g+2]=u,this.float32[g+3]=a,this.float32[g+4]=h,this.float32[g+5]=m,this.float32[g+6]=y,this.float32[g+7]=T,this.float32[g+8]=f,this.float32[g+9]=x,this.float32[g+10]=w,e}}bs.prototype.bytesPerElement=44,Mt(bs,"StructArrayLayout11f44");class yu extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,u,a,h,m,y,T){const f=this.length;return this.resize(f+1),this.emplace(f,e,i,o,u,a,h,m,y,T)}emplace(e,i,o,u,a,h,m,y,T,f){const x=9*e;return this.float32[x+0]=i,this.float32[x+1]=o,this.float32[x+2]=u,this.float32[x+3]=a,this.float32[x+4]=h,this.float32[x+5]=m,this.float32[x+6]=y,this.float32[x+7]=T,this.float32[x+8]=f,e}}yu.prototype.bytesPerElement=36,Mt(yu,"StructArrayLayout9f36");class Wa extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i){const o=this.length;return this.resize(o+1),this.emplace(o,e,i)}emplace(e,i,o){const u=2*e;return this.float32[u+0]=i,this.float32[u+1]=o,e}}Wa.prototype.bytesPerElement=8,Mt(Wa,"StructArrayLayout2f8");class cd extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,u){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,o,u)}emplace(e,i,o,u,a){const h=6*e;return this.uint32[3*e+0]=i,this.uint16[h+2]=o,this.uint16[h+3]=u,this.uint16[h+4]=a,e}}cd.prototype.bytesPerElement=12,Mt(cd,"StructArrayLayout1ul3ui12");class ud extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint16[1*e+0]=i,e}}ud.prototype.bytesPerElement=2,Mt(ud,"StructArrayLayout1ui2");class Xl extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,u,a,h,m,y,T,f,x,w,g,v,S,C){const z=this.length;return this.resize(z+1),this.emplace(z,e,i,o,u,a,h,m,y,T,f,x,w,g,v,S,C)}emplace(e,i,o,u,a,h,m,y,T,f,x,w,g,v,S,C,z){const O=16*e;return this.float32[O+0]=i,this.float32[O+1]=o,this.float32[O+2]=u,this.float32[O+3]=a,this.float32[O+4]=h,this.float32[O+5]=m,this.float32[O+6]=y,this.float32[O+7]=T,this.float32[O+8]=f,this.float32[O+9]=x,this.float32[O+10]=w,this.float32[O+11]=g,this.float32[O+12]=v,this.float32[O+13]=S,this.float32[O+14]=C,this.float32[O+15]=z,e}}Xl.prototype.bytesPerElement=64,Mt(Xl,"StructArrayLayout16f64");class Yl extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,u,a,h,m){const y=this.length;return this.resize(y+1),this.emplace(y,e,i,o,u,a,h,m)}emplace(e,i,o,u,a,h,m,y){const T=10*e,f=5*e;return this.uint16[T+0]=i,this.uint16[T+1]=o,this.uint16[T+2]=u,this.uint16[T+3]=a,this.float32[f+2]=h,this.float32[f+3]=m,this.float32[f+4]=y,e}}Yl.prototype.bytesPerElement=20,Mt(Yl,"StructArrayLayout4ui3f20");class hd extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.int16[1*e+0]=i,e}}hd.prototype.bytesPerElement=2,Mt(hd,"StructArrayLayout1i2");class xu extends Ui{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint8[1*e+0]=i,e}}xu.prototype.bytesPerElement=1,Mt(xu,"StructArrayLayout1ub1");class Yf extends $l{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}Yf.prototype.size=40;class dd extends rd{get(e){return new Yf(this,e)}}Mt(dd,"CollisionBoxArray");class Kl extends $l{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}Kl.prototype.size=60;class Kf extends ad{get(e){return new Kl(this,e)}}Mt(Kf,"PlacedSymbolArray");class Jf extends $l{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}}Jf.prototype.size=80;class Qf extends ld{get(e){return new Jf(this,e)}}Mt(Qf,"SymbolInstanceArray");class ep extends Wl{getoffsetX(e){return this.float32[1*e+0]}}Mt(ep,"GlyphOffsetArray");class tp extends Ys{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}Mt(tp,"SymbolLineVertexArray");class Jl extends $l{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Jl.prototype.size=12;class Ql extends cd{get(e){return new Jl(this,e)}}Mt(Ql,"FeatureIndexArray");class wr extends xo{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}Mt(wr,"FillExtrusionCentroidArray");class ec extends $l{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}ec.prototype.size=6;class ip extends Ha{get(e){return new ec(this,e)}}Mt(ip,"FillExtrusionWallArray");const g_=Ii([{name:"a_pos",components:2,type:"Int16"}],4),y_=Ii([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class an{constructor(e=[]){this.segments=e}_prepareSegment(e,i,o,u){let a=this.segments[this.segments.length-1];return e>an.MAX_VERTEX_ARRAY_LENGTH&&ti(`Max vertices per segment is ${an.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!a||a.vertexLength+e>an.MAX_VERTEX_ARRAY_LENGTH||a.sortKey!==u)&&(a={vertexOffset:i,primitiveOffset:o,vertexLength:0,primitiveLength:0},u!==void 0&&(a.sortKey=u),this.segments.push(a)),a}prepareSegment(e,i,o,u){return this._prepareSegment(e,i.length,o.length,u)}get(){return this.segments}destroy(){for(const e of this.segments)for(const i in e.vaos)e.vaos[i].destroy()}static simpleSegment(e,i,o,u){return new an([{vertexOffset:e,primitiveOffset:i,vertexLength:o,primitiveLength:u,vaos:{},sortKey:0}])}}function vu(r,e){return 256*(r=ri(Math.floor(r),0,255))+ri(Math.floor(e),0,255)}an.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Mt(an,"SegmentVector");const x_=Ii([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),fd=Ii([{name:"a_dash",components:4,type:"Uint16"}]);class tc{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,i,o,u){this.ids.push(np(e)),this.positions.push(i,o,u)}eachPosition(e,i){const o=np(e);let u=0,a=this.ids.length-1;for(;u<a;){const h=u+a>>1;this.ids[h]>=o?a=h:u=h+1}for(;this.ids[u]===o;)i(this.positions[3*u],this.positions[3*u+1],this.positions[3*u+2]),u++}static serialize(e,i){const o=new Float64Array(e.ids),u=new Uint32Array(e.positions);return ic(o,u,0,o.length-1),i&&(i.add(o.buffer),i.add(u.buffer)),{ids:o,positions:u}}static deserialize(e){const i=new tc;let o;i.ids=e.ids,i.positions=e.positions;for(const u of i.ids)u!==o&&i.uniqueIds.push(u),o=u;return i.indexed=!0,i}}function np(r){const e=+r;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:Kr(String(r))}function ic(r,e,i,o){for(;i<o;){const u=r[i+o>>1];let a=i-1,h=o+1;for(;;){do a++;while(r[a]<u);do h--;while(r[h]>u);if(a>=h)break;bu(r,a,h),bu(e,3*a,3*h),bu(e,3*a+1,3*h+1),bu(e,3*a+2,3*h+2)}h-i<o-h?(ic(r,e,i,h),i=h+1):(ic(r,e,h+1,o),o=h)}}function bu(r,e,i){const o=r[e];r[e]=r[i],r[i]=o}Mt(tc,"FeaturePositionMap");class ws{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,i){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,i),this.initialized=!0),!!this.location}set(e,i,o){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class nc extends ws{constructor(e){super(e),this.current=0}set(e,i,o){this.fetchUniformLocation(e,i)&&this.current!==o&&(this.current=o,this.gl.uniform1i(this.location,o))}}class ln extends ws{constructor(e){super(e),this.current=0}set(e,i,o){this.fetchUniformLocation(e,i)&&this.current!==o&&(this.current=o,this.gl.uniform1f(this.location,o))}}class jr extends ws{constructor(e){super(e),this.current=[0,0]}set(e,i,o){this.fetchUniformLocation(e,i)&&(o[0]===this.current[0]&&o[1]===this.current[1]||(this.current=o,this.gl.uniform2f(this.location,o[0],o[1])))}}class Xa extends ws{constructor(e){super(e),this.current=[0,0,0]}set(e,i,o){this.fetchUniformLocation(e,i)&&(o[0]===this.current[0]&&o[1]===this.current[1]&&o[2]===this.current[2]||(this.current=o,this.gl.uniform3f(this.location,o[0],o[1],o[2])))}}class rc extends ws{constructor(e){super(e),this.current=[0,0,0,0]}set(e,i,o){this.fetchUniformLocation(e,i)&&(o[0]===this.current[0]&&o[1]===this.current[1]&&o[2]===this.current[2]&&o[3]===this.current[3]||(this.current=o,this.gl.uniform4f(this.location,o[0],o[1],o[2],o[3])))}}class rp extends ws{constructor(e){super(e),this.current=Mi.transparent.toRenderColor(null)}set(e,i,o){this.fetchUniformLocation(e,i)&&(o.r===this.current.r&&o.g===this.current.g&&o.b===this.current.b&&o.a===this.current.a||(this.current=o,this.gl.uniform4f(this.location,o.r,o.g,o.b,o.a)))}}const sp=new Float32Array(16);class sc extends ws{constructor(e){super(e),this.current=sp}set(e,i,o){if(this.fetchUniformLocation(e,i)){if(o[12]!==this.current[12]||o[0]!==this.current[0])return this.current=o,void this.gl.uniformMatrix4fv(this.location,!1,o);for(let u=1;u<16;u++)if(o[u]!==this.current[u]){this.current=o,this.gl.uniformMatrix4fv(this.location,!1,o);break}}}}const pd=new Float32Array(9),v_=new Float32Array(4);class md extends ws{constructor(e){super(e),this.current=v_}set(e,i,o){if(this.fetchUniformLocation(e,i)){for(let u=0;u<4;u++)if(o[u]!==this.current[u]){this.current=o,this.gl.uniformMatrix2fv(this.location,!1,o);break}}}}function _d(r){return[vu(255*r.r,255*r.g),vu(255*r.b,255*r.a)]}class ia{constructor(e,i,o,u){this.value=e,this.uniformNames=i.map(a=>`u_${a}`),this.type=o,this.context=u}setUniform(e,i,o,u,a){const h=u.constantOr(this.value);i.set(e,a,h instanceof Mi?h.toRenderColor(this.ignoreLut?null:this.context.lut):h)}getBinding(e,i){return this.type==="color"?new rp(e):new ln(e)}}class na{constructor(e,i){this.uniformNames=i.map(o=>`u_${o}`),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(e){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br)}setUniform(e,i,o,u,a){const h=a==="u_pattern"||a==="u_dash"?this.pattern:a==="u_pixel_ratio"?this.pixelRatio:null;h&&i.set(e,a,h)}getBinding(e,i){return i==="u_pattern"||i==="u_dash"?new rc(e):new ln(e)}}class Js{constructor(e,i,o,u){this.expression=e,this.type=o,this.maxValue=0,this.paintVertexAttributes=i.map(a=>({name:`a_${a}`,type:"Float32",components:o==="color"?2:1,offset:0})),this.paintVertexArray=new u}populatePaintArray(e,i,o,u,a,h,m){const y=this.paintVertexArray.length,T=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new Vi(0,{brightness:h}),i,{},a,u,m):this.expression.kind==="constant"&&this.expression.value;!this.lutExpression||this.lutExpression.kind!=="composite"&&this.lutExpression.kind!=="source"||(this.ignoreLut=this.lutExpression.evaluate(new Vi(0,{brightness:h}),i,{},a,u,m)==="none"),this.paintVertexArray.resize(e),this._setPaintValue(y,e,T,this.context)}updatePaintArray(e,i,o,u,a,h,m){const y=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:m},o,u,void 0,a):this.expression.kind==="constant"&&this.expression.value;!this.lutExpression||this.lutExpression.kind!=="composite"&&this.lutExpression.kind!=="source"||(this.ignoreLut=this.lutExpression.evaluate({zoom:0,brightness:m},o,u,void 0,a)==="none"),this._setPaintValue(e,i,y,this.context)}_setPaintValue(e,i,o,u){if(this.type==="color"){const a=_d(o.toRenderColor(this.ignoreLut?null:u.lut));for(let h=e;h<i;h++)this.paintVertexArray.emplace(h,a[0],a[1])}else{for(let a=e;a<i;a++)this.paintVertexArray.emplace(a,o);this.maxValue=Math.max(this.maxValue,Math.abs(o))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class es{constructor(e,i,o,u,a,h){this.expression=e,this.uniformNames=i.map(m=>`u_${m}_t`),this.type=o,this.useIntegerZoom=u,this.context=a,this.maxValue=0,this.paintVertexAttributes=i.map(m=>({name:`a_${m}`,type:"Float32",components:o==="color"?4:2,offset:0})),this.paintVertexArray=new h}populatePaintArray(e,i,o,u,a,h,m){const y=this.expression.evaluate(new Vi(this.context.zoom,{brightness:h}),i,{},a,u,m),T=this.expression.evaluate(new Vi(this.context.zoom+1,{brightness:h}),i,{},a,u,m);!this.lutExpression||this.lutExpression.kind!=="composite"&&this.lutExpression.kind!=="source"||(this.ignoreLut=this.lutExpression.evaluate(new Vi(this.context.zoom,{brightness:h}),i,{},a,u,m)==="none");const f=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(f,e,y,T,this.context)}updatePaintArray(e,i,o,u,a,h,m){const y=this.expression.evaluate({zoom:this.context.zoom,brightness:m},o,u,void 0,a),T=this.expression.evaluate({zoom:this.context.zoom+1,brightness:m},o,u,void 0,a);!this.lutExpression||this.lutExpression.kind!=="composite"&&this.lutExpression.kind!=="source"||(this.ignoreLut=this.lutExpression.evaluate({zoom:this.context.zoom,brightness:m},o,u,void 0,a)==="none"),this._setPaintValue(e,i,y,T,this.context)}_setPaintValue(e,i,o,u,a){if(this.type==="color"){const h=_d(o.toRenderColor(this.ignoreLut?null:a.lut)),m=_d(o.toRenderColor(this.ignoreLut?null:a.lut));for(let y=e;y<i;y++)this.paintVertexArray.emplace(y,h[0],h[1],m[0],m[1])}else{for(let h=e;h<i;h++)this.paintVertexArray.emplace(h,o,u);this.maxValue=Math.max(this.maxValue,Math.abs(o),Math.abs(u))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,i,o,u,a){const h=this.useIntegerZoom?Math.floor(o.zoom):o.zoom,m=ri(this.expression.interpolationFactor(h,this.context.zoom,this.context.zoom+1),0,1);i.set(e,a,m)}getBinding(e,i){return new ln(e)}}class bo{constructor(e,i,o,u,a){this.expression=e,this.layerId=a,this.paintVertexAttributes=(o==="array"?fd:x_).members;for(let h=0;h<i.length;++h);this.paintVertexArray=new u}populatePaintArray(e,i,o,u){const a=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(a,e,i.patterns&&i.patterns[this.layerId],o)}updatePaintArray(e,i,o,u,a,h,m){this._setPaintValues(e,i,o.patterns&&o.patterns[this.layerId],h)}_setPaintValues(e,i,o,u){if(!u||!o)return;const a=u[o];if(!a)return;const{tl:h,br:m,pixelRatio:y}=a;for(let T=e;T<i;T++)this.paintVertexArray.emplace(T,h[0],h[1],m[0],m[1],y)}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class ra{constructor(e,i,o=()=>!0){this.binders={},this._buffers=[],this.context=i;const u=[];for(const a in e.paint._values){const h=e.paint.get(a),m=e.paint.get(`${a}-use-theme`);if(a.endsWith("-use-theme")||!o(a)||!(h instanceof Ga&&Ol(h.property.specification)))continue;const y=w_(a,e.type),T=h.value,f=h.property.specification.type,x=!!h.property.useIntegerZoom,w=a==="line-dasharray"||a.endsWith("pattern"),g=a==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant"||m&&m.value.kind!=="constant";if(T.kind!=="constant"||g)if(T.kind==="source"||g||w){const v=op(a,f,"source");this.binders[a]=w?new bo(T,y,f,v,e.id):new Js(T,y,f,v),u.push(`/a_${a}`)}else{const v=op(a,f,"composite");this.binders[a]=new es(T,y,f,x,i,v),u.push(`/z_${a}`)}else this.binders[a]=w?new na(T.value,y):new ia(T.value,y,f,i),u.push(`/u_${a}`);m&&(this.binders[a].ignoreLut=m.constantOr("default")==="none",this.binders[a].lutExpression=m.value,this.binders[a].checkUseTheme=!0)}this.cacheKey=u.sort().join("")}getMaxValue(e){const i=this.binders[e];return i instanceof Js||i instanceof es?i.maxValue:0}populatePaintArrays(e,i,o,u,a,h,m){for(const y in this.binders){const T=this.binders[y];T.context=this.context,T instanceof Js||T instanceof es||T instanceof bo?T.populatePaintArray(e,i,o,u,a,h,m):T.lutExpression&&T instanceof ia&&T.lutExpression&&(T.lutExpression.kind==="composite"||T.lutExpression.kind==="source")&&(T.ignoreLut=T.lutExpression.evaluate(new Vi(0,{brightness:h}),i,{},a,u,m)==="none")}}setConstantPatternPositions(e){for(const i in this.binders){const o=this.binders[i];o instanceof na&&o.setConstantPatternPositions(e)}}updatePaintArrays(e,i,o,u,a,h,m,y,T){let f=!1;const x=Object.keys(e),w=x.length!==0&&!y,g=w?x:i.uniqueIds;this.context.lut=a.lut;for(const v in this.binders){const S=this.binders[v];if(S.context=this.context,(S instanceof Js||S instanceof es||S instanceof bo)&&S.expression&&S.expression.kind&&S.expression.kind!=="constant"&&(S.expression.isStateDependent===!0||S.expression.isLightConstant===!1)){const C=a.paint.get(v);S.expression=C.value;for(const z of g){const O=e[z.toString()];i.eachPosition(z,(B,L,V)=>{const j=u.feature(B);S.updatePaintArray(L,V,j,O,h,m,T)})}if(!w)for(const z of o.uniqueIds){const O=e[z.toString()];o.eachPosition(z,(B,L,V)=>{const j=u.feature(B);S.updatePaintArray(L,V,j,O,h,m,T)})}f=!0}}return f}defines(){const e=[];for(const i in this.binders){const o=this.binders[i];(o instanceof ia||o instanceof na)&&e.push(...o.uniformNames.map(u=>`#define HAS_UNIFORM_${u}`))}return e}getBinderAttributes(){const e=[];for(const i in this.binders){const o=this.binders[i];if(o instanceof Js||o instanceof es||o instanceof bo)for(let u=0;u<o.paintVertexAttributes.length;u++)e.push(o.paintVertexAttributes[u].name)}return e}getBinderUniforms(){const e=[];for(const i in this.binders){const o=this.binders[i];if(o instanceof ia||o instanceof na||o instanceof es)for(const u of o.uniformNames)e.push(u)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){const i=[];for(const o in this.binders){const u=this.binders[o];if(u instanceof ia||u instanceof na||u instanceof es)for(const a of u.uniformNames)i.push({name:a,property:o,binding:u.getBinding(e,a)})}return i}setUniforms(e,i,o,u,a){for(const{name:h,property:m,binding:y}of o){if(this.binders[m].checkUseTheme&&this.binders[m]instanceof ia){const T=u.get(`${m}-use-theme`);T.isConstant()&&(this.binders[m].ignoreLut=T.constantOr("default")==="none")}this.binders[m].setUniform(e,y,a,u.get(m),h)}}updatePaintBuffers(){this._buffers=[];for(const e in this.binders){const i=this.binders[e];(i instanceof Js||i instanceof es||i instanceof bo)&&i.paintVertexBuffer&&this._buffers.push(i.paintVertexBuffer)}}upload(e){for(const i in this.binders){const o=this.binders[i];(o instanceof Js||o instanceof es||o instanceof bo)&&o.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const i=this.binders[e];(i instanceof Js||i instanceof es||i instanceof bo)&&i.destroy()}}}class wo{constructor(e,i,o=()=>!0){this.programConfigurations={};for(const u of e)this.programConfigurations[u.id]=new ra(u,i,o);this.needsUpload=!1,this._featureMap=new tc,this._featureMapWithoutIds=new tc,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,i,o,u,a,h,m,y){for(const T in this.programConfigurations)this.programConfigurations[T].populatePaintArrays(e,i,u,a,h,m,y);i.id!==void 0?this._featureMap.add(i.id,o,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,o,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,i,o,u,a,h,m){for(const y of o)this.needsUpload=this.programConfigurations[y.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,i,y,u,a,h,m||0)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const i in this.programConfigurations)this.programConfigurations[i].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const b_={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function w_(r,e){return b_[r]||[r.replace(`${e}-`,"").replace(/-/g,"_")]}const T_={"line-pattern":{source:Jn,composite:Jn},"fill-pattern":{source:Jn,composite:Jn},"fill-extrusion-pattern":{source:Jn,composite:Jn},"line-dasharray":{source:mu,composite:mu}},wu={color:{source:Wa,composite:ta},number:{source:Wl,composite:Wa}};function op(r,e,i){const o=T_[r];return o&&o[i]||wu[e][i]}Mt(ia,"ConstantBinder"),Mt(na,"PatternConstantBinder"),Mt(Js,"SourceExpressionBinder"),Mt(bo,"PatternCompositeBinder"),Mt(es,"CompositeExpressionBinder"),Mt(ra,"ProgramConfiguration",{omit:["_buffers"]}),Mt(wo,"ProgramConfigurationSet");const lr=mt/Math.PI/2,Ya=5,ap=6,lp=16383,Ka=64,Tu=[Ka,32,16],Cr=-lr,Pr=lr;function Ja(r,e,i,o=lr){return i=pi(i),[r*Math.sin(i)*o,-e*o,r*Math.cos(i)*o]}function sa(r,e,i){return Ja(Math.cos(pi(r)),Math.sin(pi(r)),e,i)}const oa=63710088e-1,gd=2*Math.PI*oa;class bi{constructor(e,i){if(isNaN(e)||isNaN(i))throw new Error(`Invalid LngLat object: (${e}, ${i})`);if(this.lng=+e,this.lat=+i,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new bi(Xr(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const i=Math.PI/180,o=this.lat*i,u=e.lat*i,a=Math.sin(o)*Math.sin(u)+Math.cos(o)*Math.cos(u)*Math.cos((e.lng-this.lng)*i);return oa*Math.acos(Math.min(a,1))}toBounds(e=0){const i=360*e/40075017,o=i/Math.cos(Math.PI/180*this.lat);return new To({lng:this.lng-o,lat:this.lat-i},{lng:this.lng+o,lat:this.lat+i})}toEcef(e){return sa(this.lat,this.lng,lr+e*lr/oa)}static convert(e){if(e instanceof bi)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new bi(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new bi(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class To{constructor(e,i){if(e)if(i)this.setSouthWest(e).setNorthEast(i);else if(e.length===4){const o=e;this.setSouthWest([o[0],o[1]]).setNorthEast([o[2],o[3]])}else{const o=e;this.setSouthWest(o[0]).setNorthEast(o[1])}}setNorthEast(e){return this._ne=e instanceof bi?new bi(e.lng,e.lat):bi.convert(e),this}setSouthWest(e){return this._sw=e instanceof bi?new bi(e.lng,e.lat):bi.convert(e),this}extend(e){const i=this._sw,o=this._ne;let u,a;if(e instanceof bi)u=e,a=e;else{if(!(e instanceof To))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(To.convert(e)):this.extend(bi.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(bi.convert(e)):this;if(u=e._sw,a=e._ne,!u||!a)return this}return i||o?(i.lng=Math.min(u.lng,i.lng),i.lat=Math.min(u.lat,i.lat),o.lng=Math.max(a.lng,o.lng),o.lat=Math.max(a.lat,o.lat)):(this._sw=new bi(u.lng,u.lat),this._ne=new bi(a.lng,a.lat)),this}getCenter(){return new bi((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new bi(this.getWest(),this.getNorth())}getSouthEast(){return new bi(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:i,lat:o}=bi.convert(e);let u=this._sw.lng<=i&&i<=this._ne.lng;return this._sw.lng>this._ne.lng&&(u=this._sw.lng>=i&&i>=this._ne.lng),this._sw.lat<=o&&o<=this._ne.lat&&u}static convert(e){if(e)return e instanceof To?e:new To(e)}}const S_=0,E_=25.5;function Su(r){return gd*Math.cos(r*Math.PI/180)}function Ts(r){return(180+r)/360}function ts(r){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r*Math.PI/360)))/360}function cr(r,e){return r/Su(e)}function Tr(r){return 360*r-180}function qn(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function cp(r,e){return r*Su(qn(e))}const _r=85.051129;function yd(r){return Math.cos(pi(ri(r,-85.051129,_r)))}function Qa(r,e){const i=ri(e,S_,E_),o=Math.pow(2,i);return yd(r)*gd/(512*o)}function l(r){return 1/Math.cos(r*Math.PI/180)}function t(r,e=0){const i=Math.exp(Math.PI*(1-(r.y+e/mt)/(1<<r.z)*2));return 80150034*i/(i*i+1)/mt/(1<<r.z)}class n{constructor(e,i,o=0){this.x=+e,this.y=+i,this.z=+o}static fromLngLat(e,i=0){const o=bi.convert(e);return new n(Ts(o.lng),ts(o.lat),cr(i,o.lat))}toLngLat(){return new bi(Tr(this.x),qn(this.y))}toAltitude(){return cp(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/gd*l(qn(this.y))}}function c(r,e,i,o,u,a,h,m,y){const T=(e+o)/2,f=(i+u)/2,x=new ft(T,f);m(x),function(w,g,v,S,C,z){const O=v-C,B=S-z;return Math.abs((S-g)*O-(v-w)*B)/Math.hypot(O,B)}(x.x,x.y,a.x,a.y,h.x,h.y)>=y?(c(r,e,i,T,f,a,x,m,y),c(r,T,f,o,u,x,h,m,y)):r.push(h)}function d(r,e,i){let o=r[0],u=o.x,a=o.y;e(o);const h=[o];for(let m=1;m<r.length;m++){const y=r[m],{x:T,y:f}=y;e(y),c(h,u,a,T,f,o,y,e,i),u=T,a=f,o=y}return h}function p(r,e,i,o){if(o(e,i)){const u=e.add(i)._mult(.5);p(r,e,u,o),p(r,u,i,o)}else r.push(i)}function _(r,e){let i=r[0];const o=[i];for(let u=1;u<r.length;u++){const a=r[u];p(o,i,a,e),i=a}return o}const b=Math.pow(2,14)-1,E=-b-1;function I(r,e){const i=Math.round(r.x*e),o=Math.round(r.y*e);return r.x=ri(i,E,b),r.y=ri(o,E,b),(i<r.x||i>r.x+1||o<r.y||o>r.y+1)&&ti("Geometry exceeds allowed extent, reduce your vector tile buffer size"),r}function A(r,e,i){const o=r.loadGeometry(),u=r.extent,a=mt/u;if(e&&i&&i.projection.isReprojectedInTileSpace){const h=1<<e.z,{scale:m,x:y,y:T,projection:f}=i,x=w=>{const g=Tr((e.x+w.x/u)/h),v=qn((e.y+w.y/u)/h),S=f.project(g,v);w.x=(S.x*m-y)*u,w.y=(S.y*m-T)*u};for(let w=0;w<o.length;w++)if(r.type!==1)o[w]=d(o[w],x,1);else{const g=[];for(const v of o[w])v.x<0||v.x>=u||v.y<0||v.y>=u||(x(v),g.push(v));o[w]=g}}for(const h of o)for(const m of h)I(m,a);return o}function R(r,e){return{type:r.type,id:r.id,properties:r.properties,geometry:e?A(r):[]}}function D(r,e,i,o,u){r.emplaceBack(2*e+(o+1)/2,2*i+(u+1)/2)}function F(r,e,i){r.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}class q{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new Ys,this.indexArray=new Gn,this.segments=new an,this.programConfigurations=new wo(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id)}updateFootprints(e,i){}populate(e,i,o,u){const a=this.layers[0],h=[];let m=null;a.type==="circle"&&(m=a.layout.get("circle-sort-key"));for(const{feature:T,id:f,index:x,sourceLayerIndex:w}of e){const g=this.layers[0]._featureFilter.needGeometry,v=R(T,g);if(!this.layers[0]._featureFilter.filter(new Vi(this.zoom),v,o))continue;const S=m?m.evaluate(v,{},o):void 0,C={id:f,properties:T.properties,type:T.type,sourceLayerIndex:w,index:x,geometry:g?v.geometry:A(T,o,u),patterns:{},sortKey:S};h.push(C)}m&&h.sort((T,f)=>T.sortKey-f.sortKey);let y=null;u.projection.name==="globe"&&(this.globeExtVertexArray=new Hl,y=u.projection);for(const T of h){const{geometry:f,index:x,sourceLayerIndex:w}=T,g=e[x].feature;this.addFeature(T,f,x,i.availableImages,o,y,i.brightness),i.featureIndex.insert(g,f,x,w,this.index)}}update(e,i,o,u,a,h,m){this.programConfigurations.updatePaintArrays(e,i,a,o,u,h,m)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,g_.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,y_.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(e,i,o,u,a,h,m){for(const y of i)for(const T of y){const f=T.x,x=T.y;if(f<0||f>=mt||x<0||x>=mt)continue;if(h){const v=h.projectTilePoint(f,x,a),S=h.upVector(a,f,x),C=this.globeExtVertexArray;F(C,v,S),F(C,v,S),F(C,v,S),F(C,v,S)}const w=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),g=w.vertexLength;D(this.layoutVertexArray,f,x,-1,-1),D(this.layoutVertexArray,f,x,1,-1),D(this.layoutVertexArray,f,x,1,1),D(this.layoutVertexArray,f,x,-1,1),this.indexArray.emplaceBack(g,g+1,g+2),this.indexArray.emplaceBack(g,g+2,g+3),w.vertexLength+=4,w.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,{},u,a,m)}}function U(r,e){for(let i=0;i<r.length;i++)if(ae(e,r[i]))return!0;for(let i=0;i<e.length;i++)if(ae(r,e[i]))return!0;return!!re(r,e)}function H(r,e,i){return!!ae(r,e)||!!de(e,r,i)}function Z(r,e){if(r.length===1)return he(e,r[0]);for(let i=0;i<e.length;i++){const o=e[i];for(let u=0;u<o.length;u++)if(ae(r,o[u]))return!0}for(let i=0;i<r.length;i++)if(he(e,r[i]))return!0;for(let i=0;i<e.length;i++)if(re(r,e[i]))return!0;return!1}function J(r,e,i){if(r.length>1){if(re(r,e))return!0;for(let o=0;o<e.length;o++)if(de(e[o],r,i))return!0}for(let o=0;o<r.length;o++)if(de(r[o],e,i))return!0;return!1}function re(r,e){if(r.length===0||e.length===0)return!1;for(let i=0;i<r.length-1;i++){const o=r[i],u=r[i+1];for(let a=0;a<e.length-1;a++)if(ne(o,u,e[a],e[a+1]))return!0}return!1}function ne(r,e,i,o){return hs(r,i,o)!==hs(e,i,o)&&hs(r,e,i)!==hs(r,e,o)}function de(r,e,i){const o=i*i;if(e.length===1)return r.distSqr(e[0])<o;for(let u=1;u<e.length;u++)if(le(r,e[u-1],e[u])<o)return!0;return!1}function le(r,e,i){const o=e.distSqr(i);if(o===0)return r.distSqr(e);const u=((r.x-e.x)*(i.x-e.x)+(r.y-e.y)*(i.y-e.y))/o;return r.distSqr(u<0?e:u>1?i:i.sub(e)._mult(u)._add(e))}function he(r,e){let i,o,u,a=!1;for(let h=0;h<r.length;h++){i=r[h];for(let m=0,y=i.length-1;m<i.length;y=m++)o=i[m],u=i[y],o.y>e.y!=u.y>e.y&&e.x<(u.x-o.x)*(e.y-o.y)/(u.y-o.y)+o.x&&(a=!a)}return a}function ae(r,e){let i=!1;for(let o=0,u=r.length-1;o<r.length;u=o++){const a=r[o],h=r[u];a.y>e.y!=h.y>e.y&&e.x<(h.x-a.x)*(e.y-a.y)/(h.y-a.y)+a.x&&(i=!i)}return i}function ge(r,e,i,o,u){for(const h of r)if(e<=h.x&&i<=h.y&&o>=h.x&&u>=h.y)return!0;const a=[new ft(e,i),new ft(e,u),new ft(o,u),new ft(o,i)];if(r.length>2){for(const h of a)if(ae(r,h))return!0}for(let h=0;h<r.length-1;h++)if(Te(r[h],r[h+1],a))return!0;return!1}function Te(r,e,i){const o=i[0],u=i[2];if(r.x<o.x&&e.x<o.x||r.x>u.x&&e.x>u.x||r.y<o.y&&e.y<o.y||r.y>u.y&&e.y>u.y)return!1;const a=hs(r,e,i[0]);return a!==hs(r,e,i[1])||a!==hs(r,e,i[2])||a!==hs(r,e,i[3])}function Ue(r,e,i,o,u,a){let h=e.y-r.y,m=r.x-e.x;if(a=a||0){const y=h*h+m*m;if(y===0)return!0;const T=Math.sqrt(y);h/=T,m/=T}return!((i.x-r.x)*h+(i.y-r.y)*m-a<0||(o.x-r.x)*h+(o.y-r.y)*m-a<0||(u.x-r.x)*h+(u.y-r.y)*m-a<0)}function Le(r,e,i,o,u,a,h){return!(Ue(r,e,o,u,a,h)||Ue(e,i,o,u,a,h)||Ue(i,r,o,u,a,h)||Ue(o,u,r,e,i,h)||Ue(u,a,r,e,i,h)||Ue(a,o,r,e,i,h))}function He(r,e,i){const o=e.paint.get(r).value;return o.kind==="constant"?o.value:i.programConfigurations.get(e.id).getMaxValue(r)}function Ze(r){return Math.sqrt(r[0]*r[0]+r[1]*r[1])}function ze(r,e,i,o,u){if(!e[0]&&!e[1])return r;const a=ft.convert(e)._mult(u);i==="viewport"&&a._rotate(-o);const h=[];for(let m=0;m<r.length;m++)h.push(r[m].sub(a));return h}function je(r,e,i,o){const u=ft.convert(r)._mult(o);return e==="viewport"&&u._rotate(-i),u}let it,Ce;Mt(q,"CircleBucket",{omit:["layers"]});var Ye,Ge={exports:{}},ut=(Ye||(Ye=1,function(r,e){(function(i){function o(a,h,m){var y=u(256*a,256*(h=Math.pow(2,m)-h-1),m),T=u(256*(a+1),256*(h+1),m);return y[0]+","+y[1]+","+T[0]+","+T[1]}function u(a,h,m){var y=2*Math.PI*6378137/256/Math.pow(2,m);return[a*y-2*Math.PI*6378137/2,h*y-2*Math.PI*6378137/2]}i.getURL=function(a,h,m,y,T,f){return f=f||{},a+"?"+["bbox="+o(m,y,T),"format="+(f.format||"image/png"),"service="+(f.service||"WMS"),"version="+(f.version||"1.1.1"),"request="+(f.request||"GetMap"),"srs="+(f.srs||"EPSG:3857"),"width="+(f.width||256),"height="+(f.height||256),"layers="+h].join("&")},i.getTileBBox=o,i.getMercCoords=u,Object.defineProperty(i,"__esModule",{value:!0})})(e)}(0,Ge.exports)),Ge.exports);class Je{constructor(e,i,o){this.z=e,this.x=i,this.y=o,this.key=lt(0,e,e,i,o)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}url(e,i){const o=ut.getTileBBox(this.x,this.y,this.z),u=function(a,h,m){let y,T="";for(let f=a;f>0;f--)y=1<<f-1,T+=(h&y?1:0)+(m&y?2:0);return T}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(i==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",u).replace("{bbox-epsg-3857}",o)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Xe{constructor(e,i){this.wrap=e,this.canonical=i,this.key=lt(e,i.z,i.z,i.x,i.y)}}class nt{constructor(e,i,o,u,a){this.overscaledZ=e,this.wrap=i,this.canonical=new Je(o,+u,+a),this.key=i===0&&e===o?this.canonical.key:lt(i,e,o,u,a)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const i=this.canonical.z-e;return e>this.canonical.z?new nt(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new nt(e,this.wrap,e,this.canonical.x>>i,this.canonical.y>>i)}calculateScaledKey(e,i=!0){if(this.overscaledZ===e&&i)return this.key;if(e>this.canonical.z)return lt(this.wrap*+i,e,this.canonical.z,this.canonical.x,this.canonical.y);{const o=this.canonical.z-e;return lt(this.wrap*+i,e,e,this.canonical.x>>o,this.canonical.y>>o)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const i=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>i&&e.canonical.y===this.canonical.y>>i}children(e){if(this.overscaledZ>=e)return[new nt(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const i=this.canonical.z+1,o=2*this.canonical.x,u=2*this.canonical.y;return[new nt(i,this.wrap,i,o,u),new nt(i,this.wrap,i,o+1,u),new nt(i,this.wrap,i,o,u+1),new nt(i,this.wrap,i,o+1,u+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new nt(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new nt(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Xe(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function lt(r,e,i,o,u){const a=1<<Math.min(i,22);let h=a*(u%a)+o%a;return r&&i<22&&(h+=a*a*((r<0?-2*r-1:2*r)%(1<<2*(22-i)))),16*(32*h+i)+(e-i)}const bt=[r=>{let e=r.canonical.x-1,i=r.wrap;return e<0&&(e=(1<<r.canonical.z)-1,i--),new nt(r.overscaledZ,i,r.canonical.z,e,r.canonical.y)},r=>{let e=r.canonical.x+1,i=r.wrap;return e===1<<r.canonical.z&&(e=0,i++),new nt(r.overscaledZ,i,r.canonical.z,e,r.canonical.y)},r=>new nt(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,(r.canonical.y===0?1<<r.canonical.z:r.canonical.y)-1),r=>new nt(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,r.canonical.y===(1<<r.canonical.z)-1?0:r.canonical.y+1)];Mt(Je,"CanonicalTileID"),Mt(nt,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const Et=Ii([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:$t}=Et,kt=Ii([{name:"a_pos_3",components:3,type:"Int16"}]);var Bt=Ii([{name:"a_pos",type:"Int16",components:2}]);class Yt{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,o){const u=Se.vec3.dot(i,this.dir);if(Math.abs(u)<1e-6)return!1;const a=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1]+(e[2]-this.pos[2])*i[2])/u;return o[0]=this.pos[0]+this.dir[0]*a,o[1]=this.pos[1]+this.dir[1]*a,o[2]=this.pos[2]+this.dir[2]*a,!0}closestPointOnSphere(e,i,o){if(Se.vec3.equals(this.pos,e)||i===0)return o[0]=o[1]=o[2]=0,!1;const[u,a,h]=this.dir,m=this.pos[0]-e[0],y=this.pos[1]-e[1],T=this.pos[2]-e[2],f=u*u+a*a+h*h,x=2*(m*u+y*a+T*h),w=x*x-4*f*(m*m+y*y+T*T-i*i);if(w<0){const g=Math.max(-x/2,0),v=m+u*g,S=y+a*g,C=T+h*g,z=Math.hypot(v,S,C);return o[0]=v*i/z,o[1]=S*i/z,o[2]=C*i/z,!1}{const g=(-x-Math.sqrt(w))/(2*f);if(g<0){const v=Math.hypot(m,y,T);return o[0]=m*i/v,o[1]=y*i/v,o[2]=T*i/v,!1}return o[0]=m+u*g,o[1]=y+a*g,o[2]=T+h*g,!0}}}class fi{constructor(e,i,o,u,a){this.TL=e,this.TR=i,this.BR=o,this.BL=u,this.horizon=a}static fromInvProjectionMatrix(e,i,o){const u=[-1,1,1],a=[1,1,1],h=[1,-1,1],m=[-1,-1,1],y=Se.vec3.transformMat4(u,u,e),T=Se.vec3.transformMat4(a,a,e),f=Se.vec3.transformMat4(h,h,e),x=Se.vec3.transformMat4(m,m,e);return new fi(y,T,f,x,i/o)}}function zi(r,e,i){let o=1/0,u=-1/0;const a=[];for(const h of r){Se.vec3.sub(a,h,e);const m=Se.vec3.dot(a,i);o=Math.min(o,m),u=Math.max(u,m)}return[o,u]}function Qi(r,e){let i=!0;for(let o=0;o<r.planes.length;o++){const u=r.planes[o];let a=0;for(let h=0;h<e.length;h++)a+=Se.vec3.dot(u,e[h])+u[3]>=0;if(a===0)return 0;a!==e.length&&(i=!1)}return i?2:1}function ji(r,e){for(const i of r.projections){const o=zi(e,r.points[0],i.axis);if(i.projection[1]<o[0]||i.projection[0]>o[1])return 0}return 1}function Qt(r,e){let i=0;const o=[0,0,0,0];for(let u=0;u<r.length;u++)o[0]=r[u][0],o[1]=r[u][1],o[2]=r[u][2],o[3]=1,Se.vec4.dot(o,e)>=0&&i++;return i}class xi{constructor(e,i){this.points=e||new Array(8).fill([0,0,0]),this.planes=i||new Array(6).fill([0,0,0,0]),this.bounds=Lt.fromPoints(this.points),this.projections=[],this.frustumEdges=[Se.vec3.sub([],this.points[2],this.points[3]),Se.vec3.sub([],this.points[0],this.points[3]),Se.vec3.sub([],this.points[4],this.points[0]),Se.vec3.sub([],this.points[5],this.points[1]),Se.vec3.sub([],this.points[6],this.points[2]),Se.vec3.sub([],this.points[7],this.points[3])];for(const o of this.frustumEdges){const u=[0,-o[2],o[1]],a=[o[2],0,-o[0]];this.projections.push({axis:u,projection:zi(this.points,this.points[0],u)}),this.projections.push({axis:a,projection:zi(this.points,this.points[0],a)})}}static fromInvProjectionMatrix(e,i,o,u){const a=Math.pow(2,o),h=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(T=>{const f=Se.vec4.transformMat4([],T,e),x=1/f[3]/i*a;return Se.vec4.mul(f,f,[x,x,u?1/f[3]:x,x])}),m=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(T=>{const f=Se.vec3.sub([],h[T[0]],h[T[1]]),x=Se.vec3.sub([],h[T[2]],h[T[1]]),w=Se.vec3.normalize([],Se.vec3.cross([],f,x)),g=-Se.vec3.dot(w,h[T[1]]);return w.concat(g)}),y=[];for(let T=0;T<h.length;T++)y.push([h[T][0],h[T][1],h[T][2]]);return new xi(y,m)}intersectsPrecise(e,i,o){for(let u=0;u<i.length;u++)if(!Qt(e,i[u]))return 0;for(let u=0;u<this.planes.length;u++)if(!Qt(e,this.planes[u]))return 0;for(const u of o)for(const a of this.frustumEdges){const h=Se.vec3.cross([],u,a),m=Se.vec3.length(h);if(m===0)continue;Se.vec3.scale(h,h,1/m);const y=zi(this.points,this.points[0],h),T=zi(e,this.points[0],h);if(y[0]>T[1]||T[0]>y[1])return 0}return 1}containsPoint(e){for(const i of this.planes){const o=i[3];if(Se.vec3.dot([i[0],i[1],i[2]],e)+o<0)return!1}return!0}}class Lt{static fromPoints(e){const i=[1/0,1/0,1/0],o=[-1/0,-1/0,-1/0];for(const u of e)Se.vec3.min(i,i,u),Se.vec3.max(o,o,u);return new Lt(i,o)}static fromTileIdAndHeight(e,i,o){const u=1<<e.canonical.z,a=e.canonical.x,h=e.canonical.y;return new Lt([a/u,h/u,i],[(a+1)/u,(h+1)/u,o])}static applyTransform(e,i){const o=e.getCorners();for(let u=0;u<o.length;++u)Se.vec3.transformMat4(o[u],o[u],i);return Lt.fromPoints(o)}static applyTransformFast(e,i){const o=[i[12],i[13],i[14]],u=[...o];for(let a=0;a<3;a++)for(let h=0;h<3;h++){const m=i[4*h+a],y=m*e.min[h],T=m*e.max[h];o[a]+=Math.min(y,T),u[a]+=Math.max(y,T)}return new Lt(o,u)}static projectAabbCorners(e,i){const o=e.getCorners();for(let u=0;u<o.length;++u)Se.vec3.transformMat4(o[u],o[u],i);return o}constructor(e,i){this.min=e,this.max=i,this.center=Se.vec3.scale([],Se.vec3.add([],this.min,this.max),.5)}quadrant(e){const i=[e%2==0,e<2],o=Se.vec3.clone(this.min),u=Se.vec3.clone(this.max);for(let a=0;a<i.length;a++)o[a]=i[a]?this.min[a]:this.center[a],u[a]=i[a]?this.center[a]:this.max[a];return u[2]=this.max[2],new Lt(o,u)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,i=this.max;return[[e[0],e[1],e[2]],[i[0],e[1],e[2]],[i[0],i[1],e[2]],[e[0],i[1],e[2]],[e[0],e[1],i[2]],[i[0],e[1],i[2]],[i[0],i[1],i[2]],[e[0],i[1],i[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?Qi(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?Qi(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,i){return i||this.intersects(e)?ji(e,this.getCorners()):0}intersectsPreciseFlat(e,i){return i||this.intersectsFlat(e)?ji(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let i=0;i<3;++i)if(this.min[i]>e.max[i]||e.min[i]>this.max[i])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e.min[i]),this.max[i]=Math.max(this.max[i],e.max[i])}encapsulatePoint(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e[i]),this.max[i]=Math.max(this.max[i],e[i])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}function hi(r){return r*lr/oa}Mt(Lt,"Aabb");const Ei=[new Lt([Cr,Cr,Cr],[Pr,Pr,Pr]),new Lt([Cr,Cr,Cr],[0,0,Pr]),new Lt([0,Cr,Cr],[Pr,0,Pr]),new Lt([Cr,0,Cr],[0,Pr,Pr]),new Lt([0,0,Cr],[Pr,Pr,Pr])];function Ai(r,e,i,o=!0){const u=Se.vec3.scale([],r._camera.position,r.worldSize),a=[e,i,1,1];Se.vec4.transformMat4(a,a,r.pixelMatrixInverse),Se.vec4.scale(a,a,1/a[3]);const h=Se.vec3.sub([],a,u),m=Se.vec3.normalize([],h),y=r.globeMatrix,T=[y[12],y[13],y[14]],f=Se.vec3.sub([],T,u),x=Se.vec3.length(f),w=Se.vec3.normalize([],f),g=r.worldSize/(2*Math.PI),v=Se.vec3.dot(w,m),S=Math.asin(g/x);if(S<Math.acos(v)){if(!o)return null;const pe=[],ie=[];Se.vec3.scale(pe,m,x/v),Se.vec3.normalize(ie,Se.vec3.sub(ie,pe,f)),Se.vec3.normalize(m,Se.vec3.add(m,f,Se.vec3.scale(m,ie,Math.tan(S)*x)))}const C=[];new Yt(u,m).closestPointOnSphere(T,g,C);const z=Se.vec3.normalize([],Ia(y,0)),O=Se.vec3.normalize([],Ia(y,1)),B=Se.vec3.normalize([],Ia(y,2)),L=Se.vec3.dot(z,C),V=Se.vec3.dot(O,C),j=Se.vec3.dot(B,C),W=Nn(Math.asin(-V/g));let te=Nn(Math.atan2(L,j));te=r.center.lng+function(pe,ie){const me=(ie-pe+180)%360-180;return me<-180?me+360:me}(r.center.lng,te);const ee=Ts(te),Q=ri(ts(W),0,1);return new n(ee,Q)}class Ki{constructor(e,i,o){this.a=Se.vec3.sub([],e,o),this.b=Se.vec3.sub([],i,o),this.center=o;const u=Se.vec3.normalize([],this.a),a=Se.vec3.normalize([],this.b);this.angle=Math.acos(Se.vec3.dot(u,a))}}function Pn(r,e){if(r.angle===0)return null;let i;return i=r.a[e]===0?1/r.angle*.5*Math.PI:1/r.angle*Math.atan(r.b[e]/r.a[e]/Math.sin(r.angle)-1/Math.tan(r.angle)),i<0||i>1?null:function(o,u,a,h){const m=Math.sin(a);return o*(Math.sin((1-h)*a)/m)+u*(Math.sin(h*a)/m)}(r.a[e],r.b[e],r.angle,ri(i,0,1))+r.center[e]}function vn(r){if(r.z<=1)return Ei[r.z+2*r.y+r.x];const e=Bi(Ji(r));return Lt.fromPoints(e)}function bn(r,e,i){return Se.vec3.scale(r,r,1-i),Se.vec3.scaleAndAdd(r,r,e,i)}function zr(r,e,i){for(const o of r)Se.vec3.transformMat4(o,o,e),Se.vec3.scale(o,o,i)}function Qn(r,e,i,o){const u=e/r.worldSize,a=r.globeMatrix;if(i.z<=1){const ee=vn(i).getCorners();return zr(ee,a,u),Lt.fromPoints(ee)}const h=Ji(i,o),m=Bi(h,lr+hi(r._tileCoverLift));zr(m,a,u);const y=Number.MAX_VALUE,T=[-y,-y,-y],f=[y,y,y];if(h.contains(r.center)){for(const pe of m)Se.vec3.min(f,f,pe),Se.vec3.max(T,T,pe);T[2]=0;const ee=r.point,Q=[ee.x*u,ee.y*u,0];return Se.vec3.min(f,f,Q),Se.vec3.max(T,T,Q),new Lt(f,T)}if(r._tileCoverLift>0){for(const ee of m)Se.vec3.min(f,f,ee),Se.vec3.max(T,T,ee);return new Lt(f,T)}const x=[a[12]*u,a[13]*u,a[14]*u],w=h.getCenter(),g=ri(r.center.lat,-85.051129,_r),v=ri(w.lat,-85.051129,_r),S=Ts(r.center.lng),C=ts(g);let z=S-Ts(w.lng);const O=C-ts(v);z>.5?z-=1:z<-.5&&(z+=1);let B=0;if(Math.abs(z)>Math.abs(O))B=z>=0?1:3;else{B=O>=0?0:2;const ee=[a[4]*u,a[5]*u,a[6]*u],Q=-Math.sin(pi(O>=0?h.getSouth():h.getNorth()))*lr;Se.vec3.scaleAndAdd(x,x,ee,Q)}const L=m[B],V=m[(B+1)%4],j=new Ki(L,V,x),W=[Pn(j,0)||L[0],Pn(j,1)||L[1],Pn(j,2)||L[2]],te=gr(r.zoom);if(te>0){const ee=function({x:pe,y:ie,z:me},xe,ye,we,Ae){const Re=1/(1<<me);let Ee=pe*Re,$e=Ee+Re,Qe=ie*Re,qe=Qe+Re,_t=0;const pt=(Ee+$e)/2-we;return pt>.5?_t=-1:pt<-.5&&(_t=1),Ee=((Ee+_t)*xe-(we*=xe))*ye+we,$e=(($e+_t)*xe-we)*ye+we,Qe=(Qe*xe-(Ae*=xe))*ye+Ae,qe=(qe*xe-Ae)*ye+Ae,[[Ee,qe,0],[$e,qe,0],[$e,Qe,0],[Ee,Qe,0]]}(i,e,r._pixelsPerMercatorPixel,S,C);for(let pe=0;pe<m.length;pe++)bn(m[pe],ee[pe],te);const Q=Se.vec3.add([],ee[B],ee[(B+1)%4]);Se.vec3.scale(Q,Q,.5),bn(W,Q,te)}for(const ee of m)Se.vec3.min(f,f,ee),Se.vec3.max(T,T,ee);return f[2]=Math.min(L[2],V[2]),Se.vec3.min(f,f,W),Se.vec3.max(T,T,W),new Lt(f,T)}function Ji({x:r,y:e,z:i},o=!1){const u=1/(1<<i),a=new bi(Tr(r*u),e===(1<<i)-1&&o?-90:qn((e+1)*u)),h=new bi(Tr((r+1)*u),e===0&&o?90:qn(e*u));return new To(a,h)}function Bi(r,e=lr){const i=pi(r.getNorth()),o=pi(r.getSouth()),u=Math.cos(i),a=Math.cos(o),h=Math.sin(i),m=Math.sin(o),y=r.getWest(),T=r.getEast();return[Ja(a,m,y,e),Ja(a,m,T,e),Ja(u,h,T,e),Ja(u,h,y,e)]}function Li(r,e,i,o){const u=1<<i.z,a=(r/mt+i.x)/u;return sa(qn((e/mt+i.y)/u),Tr(a),o)}function _i({min:r,max:e}){return lp/Math.max(e[0]-r[0],e[1]-r[1],e[2]-r[2])}const cn=new Float64Array(16);function zn(r){const e=_i(r),i=Se.mat4.fromScaling(cn,[e,e,e]);return Se.mat4.translate(i,i,Se.vec3.negate([],r.min))}function Fi(r){const e=Se.mat4.fromTranslation(cn,r.min),i=1/_i(r);return Se.mat4.scale(e,e,[i,i,i])}function er(r){const e=mt/(2*Math.PI);return r/(2*Math.PI)/e}function Gr(r,e){return mt/(512*Math.pow(2,r))*_i(vn(e))}function Sr(r,e,i,o,u){const a=er(i),h=[r,e,-i/(2*Math.PI)],m=Se.mat4.identity(new Float64Array(16));return Se.mat4.translate(m,m,h),Se.mat4.scale(m,m,[a,a,a]),Se.mat4.rotateX(m,m,pi(-u)),Se.mat4.rotateY(m,m,pi(-o)),m}function gr(r){return us(Ya,ap,r)}function Ss(r,e){const i=sa(e.lat,e.lng),o=function(a){const h=sa(a._center.lat,a._center.lng),m=Se.vec3.fromValues(0,1,0);let y=Se.vec3.cross([],m,h);const T=Se.mat4.fromRotation([],-a.angle,h);y=Se.vec3.transformMat4(y,y,T),Se.mat4.fromRotation(T,-a._pitch,y);const f=Se.vec3.normalize([],h);return Se.vec3.scale(f,f,hi(a.cameraToCenterDistance/a.pixelsPerMeter)),Se.vec3.transformMat4(f,f,T),Se.vec3.add([],h,f)}(r),u=Se.vec3.subtract([],o,i);return Se.vec3.angle(u,i)}function qr(r,e){return Ss(r,e)>Math.PI/2*1.01}const Rr=pi(85),aa=Math.cos(Rr),Es=Math.sin(Rr),la=Se.mat4.create(),el=r=>{const e=[];return r.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),r.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function Eu(r,e,i,o,u,a,h,m,y){if(a&&r.queryGeometry.isAboveHorizon)return!1;a&&(y*=r.pixelToTileUnitsFactor);const T=r.tileID.canonical,f=i.projection.upVectorScale(T,i.center.lat,i.worldSize).metersToTile;for(const x of e)for(const w of x){const g=w.add(m),v=u&&i.elevation?i.elevation.exaggeration()*u.getElevationAt(g.x,g.y,!0):0,S=i.projection.projectTilePoint(g.x,g.y,T);if(v>0){const B=i.projection.upVector(T,g.x,g.y);S.x+=B[0]*f*v,S.y+=B[1]*f*v,S.z+=B[2]*f*v}const C=a?g:xd(S.x,S.y,S.z,o),z=a?r.tilespaceRays.map(B=>ow(B,v)):r.queryGeometry.screenGeometry,O=Se.vec4.transformMat4([],[S.x,S.y,S.z,1],o);if(!h&&a?y*=O[3]/i.cameraToCenterDistance:h&&!a&&(y*=i.cameraToCenterDistance/O[3]),a){const B=qn((w.y/mt+T.y)/(1<<T.z));y/=i.projection.pixelsPerMeter(B,1)/cr(1,B)}if(H(z,C,y))return!0}return!1}function xd(r,e,i,o){const u=Se.vec4.transformMat4([],[r,e,i,1],o);return new ft(u[0]/u[3],u[1]/u[3])}const $y=Se.vec3.fromValues(0,0,0),sw=Se.vec3.fromValues(0,0,1);function ow(r,e){const i=Se.vec3.create();return $y[2]=e,r.intersectsPlane($y,sw,i),new ft(i[0],i[1])}class Zy extends q{}let Hy,Wy,Xy,Yy;function Ky(r,{width:e,height:i},o,u){if(u){if(u instanceof Uint8ClampedArray)u=new Uint8Array(u.buffer);else if(u.length!==e*i*o)throw new RangeError("mismatched image size")}else u=new Uint8Array(e*i*o);return r.width=e,r.height=i,r.data=u,r}function Jy(r,e,i){const{width:o,height:u}=e;o===r.width&&u===r.height||(M_(r,e,{x:0,y:0},{x:0,y:0},{width:Math.min(r.width,o),height:Math.min(r.height,u)},i,null),r.width=o,r.height=u,r.data=e.data)}function M_(r,e,i,o,u,a,h,m){if(u.width===0||u.height===0)return e;if(u.width>r.width||u.height>r.height||i.x>r.width-u.width||i.y>r.height-u.height)throw new RangeError("out of range source coordinates for image copy");if(u.width>e.width||u.height>e.height||o.x>e.width-u.width||o.y>e.height-u.height)throw new RangeError("out of range destination coordinates for image copy");const y=r.data,T=e.data,f=a===4&&m;for(let x=0;x<u.height;x++){const w=((i.y+x)*r.width+i.x)*a,g=((o.y+x)*e.width+o.x)*a;if(f)for(let v=0;v<u.width;v++){const S=w+v*a+3,C=g+v*a;T[C+0]=255,T[C+1]=255,T[C+2]=255,T[C+3]=y[S]}else if(h)for(let v=0;v<u.width;v++){const S=w+v*a,C=g+v*a,z=y[S+3],O=new Mi(y[S+0]/255*z,y[S+1]/255*z,y[S+2]/255*z,z).toRenderColor(h).toArray();T[C+0]=O[0],T[C+1]=O[1],T[C+2]=O[2],T[C+3]=O[3]}else for(let v=0;v<u.width*a;v++)T[g+v]=y[w+v]}return e}Mt(Zy,"HeatmapBucket",{omit:["layers"]});class tl{constructor(e,i){Ky(this,e,1,i)}resize(e){Jy(this,new tl(e),1)}clone(){return new tl({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,o,u,a){M_(e,i,o,u,a,1,null)}}class Wn{constructor(e,i){Ky(this,e,4,i)}resize(e){Jy(this,new Wn(e),4)}replace(e,i){i?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new Wn({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,o,u,a,h,m){M_(e,i,o,u,a,4,h,m)}}class Qy{constructor(e,i){this.width=e.width,this.height=e.height,this.data=i instanceof Uint8Array?new Float32Array(i.buffer):i}}function vd(r){const e={},i=r.resolution||256,o=r.clips?r.clips.length:1,u=r.image||new Wn({width:i,height:o}),a=(h,m,y)=>{e[r.evaluationKey]=y;const T=r.expression.evaluate(e);T&&(u.data[h+m+0]=Math.floor(255*T.r/T.a),u.data[h+m+1]=Math.floor(255*T.g/T.a),u.data[h+m+2]=Math.floor(255*T.b/T.a),u.data[h+m+3]=Math.floor(255*T.a))};if(r.clips)for(let h=0,m=0;h<o;++h,m+=4*i)for(let y=0,T=0;y<i;y++,T+=4){const f=y/(i-1),{start:x,end:w}=r.clips[h];a(m,T,x*(1-f)+w*f)}else for(let h=0,m=0;h<i;h++,m+=4)a(0,m,h/(i-1));return u}Mt(tl,"AlphaImage"),Mt(Wn,"RGBAImage");const aw=Ii([{name:"a_pos",components:2,type:"Int16"}],4),{members:lw}=aw;function bd(r,e,i=2){const o=e&&e.length,u=o?e[0]*i:r.length;let a=e0(r,0,u,i,!0);const h=[];if(!a||a.next===a.prev)return h;let m,y,T;if(o&&(a=function(f,x,w,g){const v=[];for(let S=0,C=x.length;S<C;S++){const z=e0(f,x[S]*g,S<C-1?x[S+1]*g:f.length,g,!1);z===z.next&&(z.steiner=!0),v.push(_w(z))}v.sort(fw);for(let S=0;S<v.length;S++)w=pw(v[S],w);return w}(r,e,a,i)),r.length>80*i){m=1/0,y=1/0;let f=-1/0,x=-1/0;for(let w=i;w<u;w+=i){const g=r[w],v=r[w+1];g<m&&(m=g),v<y&&(y=v),g>f&&(f=g),v>x&&(x=v)}T=Math.max(f-m,x-y),T=T!==0?32767/T:0}return wd(a,h,i,m,y,T,0),h}function e0(r,e,i,o,u){let a;if(u===function(h,m,y,T){let f=0;for(let x=m,w=y-T;x<y;x+=T)f+=(h[w]-h[x])*(h[x+1]+h[w+1]),w=x;return f}(r,e,i,o)>0)for(let h=e;h<i;h+=o)a=n0(h/o|0,r[h],r[h+1],a);else for(let h=i-o;h>=e;h-=o)a=n0(h/o|0,r[h],r[h+1],a);return a&&up(a,a.next)&&(Sd(a),a=a.next),a}function oc(r,e){if(!r)return r;e||(e=r);let i,o=r;do if(i=!1,o.steiner||!up(o,o.next)&&Rn(o.prev,o,o.next)!==0)o=o.next;else{if(Sd(o),o=e=o.prev,o===o.next)break;i=!0}while(i||o!==e);return e}function wd(r,e,i,o,u,a,h){if(!r)return;!h&&a&&function(y,T,f,x){let w=y;do w.z===0&&(w.z=I_(w.x,w.y,T,f,x)),w.prevZ=w.prev,w.nextZ=w.next,w=w.next;while(w!==y);w.prevZ.nextZ=null,w.prevZ=null,function(g){let v,S=1;do{let C,z=g;g=null;let O=null;for(v=0;z;){v++;let B=z,L=0;for(let j=0;j<S&&(L++,B=B.nextZ,B);j++);let V=S;for(;L>0||V>0&&B;)L!==0&&(V===0||!B||z.z<=B.z)?(C=z,z=z.nextZ,L--):(C=B,B=B.nextZ,V--),O?O.nextZ=C:g=C,C.prevZ=O,O=C;z=B}O.nextZ=null,S*=2}while(v>1)}(w)}(r,o,u,a);let m=r;for(;r.prev!==r.next;){const y=r.prev,T=r.next;if(a?uw(r,o,u,a):cw(r))e.push(y.i,r.i,T.i),Sd(r),r=T.next,m=T.next;else if((r=T)===m){h?h===1?wd(r=hw(oc(r),e),e,i,o,u,a,2):h===2&&dw(r,e,i,o,u,a):wd(oc(r),e,i,o,u,a,1);break}}}function cw(r){const e=r.prev,i=r,o=r.next;if(Rn(e,i,o)>=0)return!1;const u=e.x,a=i.x,h=o.x,m=e.y,y=i.y,T=o.y,f=u<a?u<h?u:h:a<h?a:h,x=m<y?m<T?m:T:y<T?y:T,w=u>a?u>h?u:h:a>h?a:h,g=m>y?m>T?m:T:y>T?y:T;let v=o.next;for(;v!==e;){if(v.x>=f&&v.x<=w&&v.y>=x&&v.y<=g&&Mu(u,m,a,y,h,T,v.x,v.y)&&Rn(v.prev,v,v.next)>=0)return!1;v=v.next}return!0}function uw(r,e,i,o){const u=r.prev,a=r,h=r.next;if(Rn(u,a,h)>=0)return!1;const m=u.x,y=a.x,T=h.x,f=u.y,x=a.y,w=h.y,g=m<y?m<T?m:T:y<T?y:T,v=f<x?f<w?f:w:x<w?x:w,S=m>y?m>T?m:T:y>T?y:T,C=f>x?f>w?f:w:x>w?x:w,z=I_(g,v,e,i,o),O=I_(S,C,e,i,o);let B=r.prevZ,L=r.nextZ;for(;B&&B.z>=z&&L&&L.z<=O;){if(B.x>=g&&B.x<=S&&B.y>=v&&B.y<=C&&B!==u&&B!==h&&Mu(m,f,y,x,T,w,B.x,B.y)&&Rn(B.prev,B,B.next)>=0||(B=B.prevZ,L.x>=g&&L.x<=S&&L.y>=v&&L.y<=C&&L!==u&&L!==h&&Mu(m,f,y,x,T,w,L.x,L.y)&&Rn(L.prev,L,L.next)>=0))return!1;L=L.nextZ}for(;B&&B.z>=z;){if(B.x>=g&&B.x<=S&&B.y>=v&&B.y<=C&&B!==u&&B!==h&&Mu(m,f,y,x,T,w,B.x,B.y)&&Rn(B.prev,B,B.next)>=0)return!1;B=B.prevZ}for(;L&&L.z<=O;){if(L.x>=g&&L.x<=S&&L.y>=v&&L.y<=C&&L!==u&&L!==h&&Mu(m,f,y,x,T,w,L.x,L.y)&&Rn(L.prev,L,L.next)>=0)return!1;L=L.nextZ}return!0}function hw(r,e){let i=r;do{const o=i.prev,u=i.next.next;!up(o,u)&&t0(o,i,i.next,u)&&Td(o,u)&&Td(u,o)&&(e.push(o.i,i.i,u.i),Sd(i),Sd(i.next),i=r=u),i=i.next}while(i!==r);return oc(i)}function dw(r,e,i,o,u,a){let h=r;do{let m=h.next.next;for(;m!==h.prev;){if(h.i!==m.i&&gw(h,m)){let y=i0(h,m);return h=oc(h,h.next),y=oc(y,y.next),wd(h,e,i,o,u,a,0),void wd(y,e,i,o,u,a,0)}m=m.next}h=h.next}while(h!==r)}function fw(r,e){return r.x-e.x}function pw(r,e){const i=function(u,a){let h=a;const m=u.x,y=u.y;let T,f=-1/0;do{if(y<=h.y&&y>=h.next.y&&h.next.y!==h.y){const S=h.x+(y-h.y)*(h.next.x-h.x)/(h.next.y-h.y);if(S<=m&&S>f&&(f=S,T=h.x<h.next.x?h:h.next,S===m))return T}h=h.next}while(h!==a);if(!T)return null;const x=T,w=T.x,g=T.y;let v=1/0;h=T;do{if(m>=h.x&&h.x>=w&&m!==h.x&&Mu(y<g?m:f,y,w,g,y<g?f:m,y,h.x,h.y)){const S=Math.abs(y-h.y)/(m-h.x);Td(h,u)&&(S<v||S===v&&(h.x>T.x||h.x===T.x&&mw(T,h)))&&(T=h,v=S)}h=h.next}while(h!==x);return T}(r,e);if(!i)return e;const o=i0(i,r);return oc(o,o.next),oc(i,i.next)}function mw(r,e){return Rn(r.prev,r,e.prev)<0&&Rn(e.next,r,r.next)<0}function I_(r,e,i,o,u){return(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=(r-i)*u|0)|r<<8))|r<<4))|r<<2))|r<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-o)*u|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function _w(r){let e=r,i=r;do(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next;while(e!==r);return i}function Mu(r,e,i,o,u,a,h,m){return(u-h)*(e-m)>=(r-h)*(a-m)&&(r-h)*(o-m)>=(i-h)*(e-m)&&(i-h)*(a-m)>=(u-h)*(o-m)}function gw(r,e){return r.next.i!==e.i&&r.prev.i!==e.i&&!function(i,o){let u=i;do{if(u.i!==i.i&&u.next.i!==i.i&&u.i!==o.i&&u.next.i!==o.i&&t0(u,u.next,i,o))return!0;u=u.next}while(u!==i);return!1}(r,e)&&(Td(r,e)&&Td(e,r)&&function(i,o){let u=i,a=!1;const h=(i.x+o.x)/2,m=(i.y+o.y)/2;do u.y>m!=u.next.y>m&&u.next.y!==u.y&&h<(u.next.x-u.x)*(m-u.y)/(u.next.y-u.y)+u.x&&(a=!a),u=u.next;while(u!==i);return a}(r,e)&&(Rn(r.prev,r,e.prev)||Rn(r,e.prev,e))||up(r,e)&&Rn(r.prev,r,r.next)>0&&Rn(e.prev,e,e.next)>0)}function Rn(r,e,i){return(e.y-r.y)*(i.x-e.x)-(e.x-r.x)*(i.y-e.y)}function up(r,e){return r.x===e.x&&r.y===e.y}function t0(r,e,i,o){const u=dp(Rn(r,e,i)),a=dp(Rn(r,e,o)),h=dp(Rn(i,o,r)),m=dp(Rn(i,o,e));return u!==a&&h!==m||!(u!==0||!hp(r,i,e))||!(a!==0||!hp(r,o,e))||!(h!==0||!hp(i,r,o))||!(m!==0||!hp(i,e,o))}function hp(r,e,i){return e.x<=Math.max(r.x,i.x)&&e.x>=Math.min(r.x,i.x)&&e.y<=Math.max(r.y,i.y)&&e.y>=Math.min(r.y,i.y)}function dp(r){return r>0?1:r<0?-1:0}function Td(r,e){return Rn(r.prev,r,r.next)<0?Rn(r,e,r.next)>=0&&Rn(r,r.prev,e)>=0:Rn(r,e,r.prev)<0||Rn(r,r.next,e)<0}function i0(r,e){const i=A_(r.i,r.x,r.y),o=A_(e.i,e.x,e.y),u=r.next,a=e.prev;return r.next=e,e.prev=r,i.next=u,u.prev=i,o.next=i,i.prev=o,a.next=o,o.prev=a,o}function n0(r,e,i,o){const u=A_(r,e,i);return o?(u.next=o.next,u.prev=o,o.next.prev=u,o.next=u):(u.prev=u,u.next=u),u}function Sd(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function A_(r,e,i){return{i:r,x:e,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function fp(r,e){const i=r.length;if(i<=1)return[r];const o=[];let u,a;for(let h=0;h<i;h++){const m=Pc(r[h]);m!==0&&(r[h].area=Math.abs(m),a===void 0&&(a=m<0),a===m<0?(u&&o.push(u),u=[r[h]]):u.push(r[h]))}if(u&&o.push(u),e>1)for(let h=0;h<o.length;h++)o[h].length<=e||(Tl(o[h],e,1,o[h].length-1,yw),o[h]=o[h].slice(0,e));return o}function yw(r,e){return e.area-r.area}function r0(r,e,i=1){if(!r)return null;const o=typeof r=="string"?r:r.getPrimary().id;e[o]||(e[o]=[]);const u=Zn.from(o).getPrimary().scaleSelf(i);return e[o].push(u),u.serialize()}function C_(r,e,i,o){const u=o.patternDependencies;let a=!1;for(const h of e){const m=h.paint.get(`${r}-pattern`);m.isConstant()||(a=!0),r0(m.constantOr(null),u,i)&&(a=!0)}return a}function P_(r,e,i,o,u,a){const h=a.patternDependencies;for(const m of e){const y=m.paint.get(`${r}-pattern`).value;if(y.kind!=="constant"){let T=y.evaluate({zoom:o},i,{},a.availableImages);T=T&&T.name?T.name:T;const f=r0(T,h,u);f&&(i.patterns[m.id]=f)}}return i}class z_{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Ys,this.indexArray=new Gn,this.indexArray2=new xo,this.programConfigurations=new wo(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new an,this.segments2=new an,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.projection=e.projection}updateFootprints(e,i){}populate(e,i,o,u){this.hasPattern=C_("fill",this.layers,this.pixelRatio,i);const a=this.layers[0].layout.get("fill-sort-key"),h=[];for(const{feature:m,id:y,index:T,sourceLayerIndex:f}of e){const x=this.layers[0]._featureFilter.needGeometry,w=R(m,x);if(!this.layers[0]._featureFilter.filter(new Vi(this.zoom),w,o))continue;const g=a?a.evaluate(w,{},o,i.availableImages):void 0,v={id:y,properties:m.properties,type:m.type,sourceLayerIndex:f,index:T,geometry:x?w.geometry:A(m,o,u),patterns:{},sortKey:g};h.push(v)}a&&h.sort((m,y)=>m.sortKey-y.sortKey);for(const m of h){const{geometry:y,index:T,sourceLayerIndex:f}=m;if(this.hasPattern){const x=P_("fill",this.layers,m,this.zoom,this.pixelRatio,i);this.patternFeatures.push(x)}else this.addFeature(m,y,T,o,{},i.availableImages,i.brightness,i.elevationFeatures);i.featureIndex.insert(e[T].feature,y,T,f,this.index)}}update(e,i,o,u,a,h,m){this.programConfigurations.updatePaintArrays(e,i,a,o,u,h,m)}addFeatures(e,i,o,u,a,h){for(const m of this.patternFeatures)this.addFeature(m,m.geometry,m.index,i,o,u,h,e.elevationFeatures)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,lw),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.indexBuffer2=e.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(e,i,o,u,a,h=[],m,y){for(const T of fp(i,500)){let f=0;for(const C of T)f+=C.length;const x=this.segments.prepareSegment(f,this.layoutVertexArray,this.indexArray),w=x.vertexLength,g=[],v=[];for(const C of T){if(C.length===0)continue;C!==T[0]&&v.push(g.length/2);const z=this.segments2.prepareSegment(C.length,this.layoutVertexArray,this.indexArray2),O=z.vertexLength;this.layoutVertexArray.emplaceBack(C[0].x,C[0].y),this.indexArray2.emplaceBack(O+C.length-1,O),g.push(C[0].x),g.push(C[0].y);for(let B=1;B<C.length;B++)this.layoutVertexArray.emplaceBack(C[B].x,C[B].y),this.indexArray2.emplaceBack(O+B-1,O+B),g.push(C[B].x),g.push(C[B].y);z.vertexLength+=C.length,z.primitiveLength+=C.length}const S=bd(g,v);for(let C=0;C<S.length;C+=3)this.indexArray.emplaceBack(w+S[C],w+S[C+1],w+S[C+2]);x.vertexLength+=f,x.primitiveLength+=S.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,a,h,u,m)}}let s0,o0,a0,l0;Mt(z_,"FillBucket",{omit:["layers","patternFeatures"]});class R_{constructor(e,i,o,u){if(this.triangleCount=i.length/3,this.min=new ft(0,0),this.max=new ft(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0)return;const[a,h]=[e[0].clone(),e[0].clone()];for(let x=1;x<e.length;++x){const w=e[x];a.x=Math.min(a.x,w.x),a.y=Math.min(a.y,w.y),h.x=Math.max(h.x,w.x),h.y=Math.max(h.y,w.y)}if(u){const x=Math.ceil(Math.max(h.x-a.x,h.y-a.y)/u);o=Math.max(o,x)}if(o===0)return;this.min=a,this.max=h;const m=this.max.sub(this.min);m.x=Math.max(m.x,1),m.y=Math.max(m.y,1);const y=Math.max(m.x,m.y)/o;this.cellsX=Math.max(1,Math.ceil(m.x/y)),this.cellsY=Math.max(1,Math.ceil(m.y/y)),this.xScale=1/y,this.yScale=1/y;const T=[];for(let x=0;x<this.triangleCount;x++){const w=e[i[3*x+0]].sub(this.min),g=e[i[3*x+1]].sub(this.min),v=e[i[3*x+2]].sub(this.min),S=So(Math.floor(Math.min(w.x,g.x,v.x)),this.xScale,this.cellsX),C=So(Math.floor(Math.max(w.x,g.x,v.x)),this.xScale,this.cellsX),z=So(Math.floor(Math.min(w.y,g.y,v.y)),this.yScale,this.cellsY),O=So(Math.floor(Math.max(w.y,g.y,v.y)),this.yScale,this.cellsY),B=new ft(0,0),L=new ft(0,0),V=new ft(0,0),j=new ft(0,0);for(let W=z;W<=O;++W){B.y=L.y=W*y,V.y=j.y=(W+1)*y;for(let te=S;te<=C;++te)B.x=V.x=te*y,L.x=j.x=(te+1)*y,(Le(w,g,v,B,L,j)||Le(w,g,v,B,j,V))&&T.push({cellIdx:W*this.cellsX+te,triIdx:x})}}if(T.length===0)return;T.sort((x,w)=>x.cellIdx-w.cellIdx||x.triIdx-w.triIdx);let f=0;for(;f<T.length;){const x=T[f].cellIdx,w={start:this.payload.length,len:0};for(;f<T.length&&T[f].cellIdx===x;)++w.len,this.payload.push(T[f++].triIdx);this.cells[x]=w}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,i){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;const o=So(e.x-this.min.x,this.xScale,this.cellsX),u=So(e.y-this.min.y,this.yScale,this.cellsY),a=this.cells[u*this.cellsX+o];if(a){this._lazyInitLookup();for(let h=0;h<a.len;h++){const m=this.payload[a.start+h],y=Math.floor(m/8),T=1<<m%8;if(!(this.lookup[y]&T)&&(this.lookup[y]|=T,i.push(m),i.length===this.triangleCount))return}}}query(e,i,o){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>i.x||e.y>this.max.y||this.min.y>i.y)return;this._lazyInitLookup();const u=So(e.x-this.min.x,this.xScale,this.cellsX),a=So(i.x-this.min.x,this.xScale,this.cellsX),h=So(e.y-this.min.y,this.yScale,this.cellsY),m=So(i.y-this.min.y,this.yScale,this.cellsY);for(let y=h;y<=m;y++)for(let T=u;T<=a;T++){const f=this.cells[y*this.cellsX+T];if(f)for(let x=0;x<f.len;x++){const w=this.payload[f.start+x],g=Math.floor(w/8),v=1<<w%8;if(!(this.lookup[g]&v)&&(this.lookup[g]|=v,o.push(w),o.length===this.triangleCount))return}}}}function So(r,e,i){return Math.max(0,Math.min(i-1,Math.floor(r*e)))}Mt(R_,"TriangleGridIndex");class c0{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.footprints=[]}updateFootprints(e,i){for(const o of this.footprints)i.push({footprint:o,id:e})}populate(e,i,o,u){const a=[];for(const{feature:h,id:m,index:y,sourceLayerIndex:T}of e){const f=this.layers[0]._featureFilter.needGeometry,x=R(h,f);if(!this.layers[0]._featureFilter.filter(new Vi(this.zoom),x,o))continue;const w={id:m,properties:h.properties,type:h.type,sourceLayerIndex:T,index:y,geometry:f?x.geometry:A(h,o,u),patterns:{}};a.push(w)}for(const h of a){const{geometry:m,index:y,sourceLayerIndex:T}=h;this.addFeature(h,m,y,o,{},i.availableImages,i.brightness),i.featureIndex.insert(e[y].feature,m,y,T,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(e){}update(e,i,o,u,a,h,m){}destroy(){}addFeature(e,i,o,u,a,h=[],m){for(const y of fp(i,2)){const T=[],f=[],x=[],w=new ft(1/0,1/0),g=new ft(-1/0,-1/0);for(const C of y)if(C.length!==0){C!==y[0]&&x.push(f.length/2);for(let z=0;z<C.length;z++)f.push(C[z].x),f.push(C[z].y),T.push(C[z]),w.x=Math.min(w.x,C[z].x),w.y=Math.min(w.y,C[z].y),g.x=Math.max(g.x,C[z].x),g.y=Math.max(g.y,C[z].y)}const v=bd(f,x),S=new R_(T,v,8,256);this.footprints.push({vertices:T,indices:v,grid:S,min:w,max:g})}}}Mt(c0,"ClipBucket",{omit:["layers"]});const xw=Ii([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),vw=Ii([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),bw=Ii([{name:"a_centroid_pos",components:2,type:"Uint16"}]),ww=Ii([{name:"a_join_normal_inside",components:3,type:"Int16"}]),Tw=Ii([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),Sw=Ii([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:Ew}=xw;var D_,u0,L_,h0,k_,d0,f0,pp={};function p0(){if(u0)return D_;u0=1;var r=ko();function e(u,a,h,m,y){this.properties={},this.extent=h,this.type=0,this._pbf=u,this._geometry=-1,this._keys=m,this._values=y,u.readFields(i,this,a)}function i(u,a,h){u==1?a.id=h.readVarint():u==2?function(m,y){for(var T=m.readVarint()+m.pos;m.pos<T;){var f=y._keys[m.readVarint()],x=y._values[m.readVarint()];y.properties[f]=x}}(h,a):u==3?a.type=h.readVarint():u==4&&(a._geometry=h.pos)}function o(u){for(var a,h,m=0,y=0,T=u.length,f=T-1;y<T;f=y++)m+=((h=u[f]).x-(a=u[y]).x)*(a.y+h.y);return m}return D_=e,e.types=["Unknown","Point","LineString","Polygon"],e.prototype.loadGeometry=function(){var u=this._pbf;u.pos=this._geometry;for(var a,h=u.readVarint()+u.pos,m=1,y=0,T=0,f=0,x=[];u.pos<h;){if(y<=0){var w=u.readVarint();m=7&w,y=w>>3}if(y--,m===1||m===2)T+=u.readSVarint(),f+=u.readSVarint(),m===1&&(a&&x.push(a),a=[]),a.push(new r(T,f));else{if(m!==7)throw new Error("unknown command "+m);a&&a.push(a[0].clone())}}return a&&x.push(a),x},e.prototype.bbox=function(){var u=this._pbf;u.pos=this._geometry;for(var a=u.readVarint()+u.pos,h=1,m=0,y=0,T=0,f=1/0,x=-1/0,w=1/0,g=-1/0;u.pos<a;){if(m<=0){var v=u.readVarint();h=7&v,m=v>>3}if(m--,h===1||h===2)(y+=u.readSVarint())<f&&(f=y),y>x&&(x=y),(T+=u.readSVarint())<w&&(w=T),T>g&&(g=T);else if(h!==7)throw new Error("unknown command "+h)}return[f,w,x,g]},e.prototype.toGeoJSON=function(u,a,h){var m,y,T=this.extent*Math.pow(2,h),f=this.extent*u,x=this.extent*a,w=this.loadGeometry(),g=e.types[this.type];function v(z){for(var O=0;O<z.length;O++){var B=z[O];z[O]=[360*(B.x+f)/T-180,360/Math.PI*Math.atan(Math.exp((180-360*(B.y+x)/T)*Math.PI/180))-90]}}switch(this.type){case 1:var S=[];for(m=0;m<w.length;m++)S[m]=w[m][0];v(w=S);break;case 2:for(m=0;m<w.length;m++)v(w[m]);break;case 3:for(w=function(z){var O=z.length;if(O<=1)return[z];for(var B,L,V=[],j=0;j<O;j++){var W=o(z[j]);W!==0&&(L===void 0&&(L=W<0),L===W<0?(B&&V.push(B),B=[z[j]]):B.push(z[j]))}return B&&V.push(B),V}(w),m=0;m<w.length;m++)for(y=0;y<w[m].length;y++)v(w[m][y])}w.length===1?w=w[0]:g="Multi"+g;var C={type:"Feature",geometry:{type:g,coordinates:w},properties:this.properties};return"id"in this&&(C.id=this.id),C},D_}function m0(){if(h0)return L_;h0=1;var r=p0();function e(o,u){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=o,this._keys=[],this._values=[],this._features=[],o.readFields(i,this,u),this.length=this._features.length}function i(o,u,a){o===15?u.version=a.readVarint():o===1?u.name=a.readString():o===5?u.extent=a.readVarint():o===2?u._features.push(a.pos):o===3?u._keys.push(a.readString()):o===4&&u._values.push(function(h){for(var m=null,y=h.readVarint()+h.pos;h.pos<y;){var T=h.readVarint()>>3;m=T===1?h.readString():T===2?h.readFloat():T===3?h.readDouble():T===4?h.readVarint64():T===5?h.readVarint():T===6?h.readSVarint():T===7?h.readBoolean():null}return m}(a))}return L_=e,e.prototype.feature=function(o){if(o<0||o>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[o];var u=this._pbf.readVarint()+this._pbf.pos;return new r(this._pbf,u,this.extent,this._keys,this._values)},L_}function _0(){return f0||(f0=1,pp.VectorTile=function(){if(d0)return k_;d0=1;var r=m0();function e(i,o,u){if(i===3){var a=new r(u,u.readVarint()+u.pos);a.length&&(o[a.name]=a)}}return k_=function(i,o){this.layers=i.readFields(e,{},o)},k_}(),pp.VectorTileFeature=p0(),pp.VectorTileLayer=m0()),pp}var Iu=_0();class ac extends ft{constructor(e,i,o){super(e,i),this.z=o}}class g0 extends ac{constructor(e,i,o,u){super(e,i,o),this.w=u}}function mp(r,e,i,o){const u=[],a=o===0?(h,m,y,T,f,x)=>{h.push(new ft(x,y+(x-m)/(T-m)*(f-y)))}:(h,m,y,T,f,x)=>{h.push(new ft(m+(x-y)/(f-y)*(T-m),x))};for(const h of r){const m=[];for(const y of h){if(y.length<=2)continue;const T=[];for(let w=0;w<y.length-1;w++){const g=y[w].x,v=y[w].y,S=y[w+1].x,C=y[w+1].y,z=o===0?g:v,O=o===0?S:C;z<e?O>e&&a(T,g,v,S,C,e):z>i?O<i&&a(T,g,v,S,C,i):T.push(y[w]),O<e&&z>=e&&a(T,g,v,S,C,e),O>i&&z<=i&&a(T,g,v,S,C,i)}let f=y[y.length-1];const x=o===0?f.x:f.y;x>=e&&x<=i&&T.push(f),T.length&&(f=T[T.length-1],T[0].x===f.x&&T[0].y===f.y||T.push(T[0]),m.push(T))}m.length&&u.push(m)}return u}function y0(r,e,i,o){const u=i==="x"?"y":"x",a=(o-r[i])/(e[i]-r[i]);r[u]=r[u]+(e[u]-r[u])*a,r[i]=o,r.hasOwnProperty("z")&&(r.z=Gt(r.z,e.z,a)),r.hasOwnProperty("w")&&(r.w=Gt(r.w,e.w,a))}function x0(r,e,i,o){const u=i,a=o;for(const h of["x","y"]){let m=r,y=e;m[h]>=y[h]&&(m=e,y=r),m[h]<u&&y[h]>u&&y0(m,y,h,u),m[h]<a&&y[h]>a&&y0(y,m,h,a)}}const _p=Number.MAX_SAFE_INTEGER;function v0(r,e,i,o){return r.order<e||r.order===_p||!(r.clipMask&i)||function(u,a){return a.length!==0&&a.find(h=>h===u)===void 0}(o,r.clipScope)}function gp(r,e){return r.x-e.x||r.y-e.y}function b0(r,e){return gp(r.min,e.min)===0&&gp(r.max,e.max)===0}function O_(r,e){return!(r.min.x>e.max.x||r.max.x<e.min.x||r.min.y>e.max.y||r.max.y<e.min.y)}function F_(r,e){if(r.length!==e.length)return!1;for(let i=0;i<r.length;i++)if(r[i].sourceId!==e[i].sourceId||!b0(r[i],e[i])||r[i].order!==e[i].order||r[i].clipMask!==e[i].clipMask||!rr(r[i].clipScope,e[i].clipScope))return!1;return!0}function w0(r,e,i){const o=1/mt,u=1/(1<<i.canonical.z),a=(e.x*o+i.canonical.x)*u+i.wrap,h=(e.y*o+i.canonical.y)*u;return{min:new ft((r.x*o+i.canonical.x)*u+i.wrap,(r.y*o+i.canonical.y)*u),max:new ft(a,h)}}function Mw(r,e,i){const o=1<<i.canonical.z,u=((e.x-i.wrap)*o-i.canonical.x)*mt,a=(e.y*o-i.canonical.y)*mt;return{min:new ft(((r.x-i.wrap)*o-i.canonical.x)*mt,(r.y*o-i.canonical.y)*mt),max:new ft(u,a)}}function T0(r,e,i,o,u,a,h){const m=r.indices,y=r.vertices,T=[];for(let f=o;f<o+u;f+=3){const x=e[i[f+0]+a],w=e[i[f+1]+a],g=e[i[f+2]+a],v=Math.min(x.x,w.x,g.x),S=Math.max(x.x,w.x,g.x),C=Math.min(x.y,w.y,g.y),z=Math.max(x.y,w.y,g.y);T.length=0,r.grid.query(new ft(v,C),new ft(S,z),T);for(let O=0;O<T.length;O++){const B=T[O];if(Le(y[m[3*B+0]],y[m[3*B+1]],y[m[3*B+2]],x,w,g,h))return!0}}return!1}function S0(r,e,i,o){if(!r||!i)return!1;let u=r.vertices;if(!e.canonical.equals(o.canonical)||e.wrap!==o.wrap){if(i.vertices.length<r.vertices.length)return S0(i,o,r,e);const a=e.canonical,h=o.canonical,m=Math.pow(2,h.z-a.z);u=r.vertices.map(y=>new ft((y.x+a.x*mt)*m-h.x*mt,(y.y+a.y*mt)*m-h.y*mt))}return T0(i,u,r.indices,0,r.indices.length,0,0)}function E0(r,e,i,o){const u=Math.pow(2,o.z-i.z);return new ft((r+i.x*mt)*u-o.x*mt,(e+i.y*mt)*u-o.y*mt)}function M0(r,e){const i=[];e.grid.queryPoint(r,i);const o=e.indices,u=e.vertices;for(let a=0;a<i.length;a++){const h=i[a];if(ae([u[o[3*h+0]],u[o[3*h+1]],u[o[3*h+2]]],r))return!0}return!1}const B_=[new ft(0,0),new ft(mt,0),new ft(mt,mt),new ft(0,mt)];function I0(r,e){const i=[];let o=[];if(!e||r.length<2)return[r];if(r.length===2)return Te(r[0],r[1],B_)?[r]:[];for(let u=0;u<r.length+2;u++){const a=r[u%r.length],h=r[(u+1)%r.length],m=Te(u===0?r[r.length-1]:r[(u-1)%r.length],a,B_),y=Te(a,h,B_),T=m||y;T&&o.push(a),T&&y||o.length>0&&(o.length>1&&i.push(o),o=[])}return o.length>1&&i.push(o),i}const N_=Iu.VectorTileFeature.types,Iw=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],Aw=["fill-extrusion-flood-light-ground-radius"],Cw=Math.pow(2,13),Pw=Math.pow(2,15)-1,A0=new ft(0,1),il=2147483648;function Ed(r,e,i,o,u,a,h,m){r.emplaceBack((e<<1)+h,(i<<1)+a,(Math.floor(o*Cw)<<1)+u,Math.round(m))}function Md(r,e,i){r.emplaceBack(e.x*mt,e.y*mt,i?1:0)}function yp(r,e,i,o,u,a){r.emplaceBack(e.x,e.y,(i.x<<1)+o,(i.y<<1)+u,a)}function Id(r,e,i){r.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}class C0{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class P0{constructor(){this.centroidXY=new ft(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new ft(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new ft(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new ft(this.max.x-this.min.x,this.max.y-this.min.y)}}class z0{constructor(){this.acc=new ft(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,i){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=i.x,e.min.y=e.max.y=i.y)}appendEdge(e,i,o){this.accCount++,this.acc._add(i);let u=!!this.borders;i.x<e.min.x?(e.min.x=i.x,u=!0):i.x>e.max.x&&(e.max.x=i.x,u=!0),i.y<e.min.y?(e.min.y=i.y,u=!0):i.y>e.max.y&&(e.max.y=i.y,u=!0),((i.x===0||i.x===mt)&&i.x===o.x)!=((i.y===0||i.y===mt)&&i.y===o.y)&&this.processBorderOverlap(i,o),u&&this.checkBorderIntersection(i,o)}checkBorderIntersection(e,i){i.x<0!=e.x<0&&this.addBorderIntersection(0,Gt(i.y,e.y,(0-i.x)/(e.x-i.x))),i.x>mt!=e.x>mt&&this.addBorderIntersection(1,Gt(i.y,e.y,(mt-i.x)/(e.x-i.x))),i.y<0!=e.y<0&&this.addBorderIntersection(2,Gt(i.x,e.x,(0-i.y)/(e.y-i.y))),i.y>mt!=e.y>mt&&this.addBorderIntersection(3,Gt(i.x,e.x,(mt-i.y)/(e.y-i.y)))}addBorderIntersection(e,i){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const o=this.borders[e];i<o[0]&&(o[0]=i),i>o[1]&&(o[1]=i)}processBorderOverlap(e,i){if(e.x===i.x){if(e.y===i.y)return;const o=e.x===0?0:1;this.addBorderIntersection(o,i.y),this.addBorderIntersection(o,e.y)}else{const o=e.y===0?2:3;this.addBorderIntersection(o,i.x),this.addBorderIntersection(o,e.x)}}centroid(){return this.accCount===0?new ft(0,0):new ft(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((e,i)=>e+ +(i[0]!==Number.MAX_VALUE),0):0}}function R0(r,e){const i=r.add(e)._unit(),o=ri(r.x*i.x+r.y*i.y,-1,1);var u,a,h;return h=Math.acos(o),Math.min(4,Math.max(-4,Math.tan(h)))/4*Pw*((u=r).x*(a=e).y-u.y*a.x<0?-1:1)}const zw=[r=>r.x<0,r=>r.x>mt,r=>r.y<0,r=>r.y>mt];function Rw(r,e,i,o){const u=[4];if(o===0)return u;i._mult(o);const a=r.sub(i),h=e.sub(i),m=[r,e,a,h];for(let y=0;y<4;y++)for(const T of m)if(zw[y](T)){u.push(y);break}return u}class D0{constructor(e){this.vertexArray=new pu,this.indexArray=new Gn,this.programConfigurations=new wo(e.layers,{zoom:e.zoom,lut:e.lut},i=>Aw.includes(i)),this._segments=new an,this.hiddenByLandmarkVertexArray=new xu,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new an}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,i,o,u=!1){const a=e.length;if(a>2){let h=Math.max(0,this._segments.get().length-1);const m=this._segments._prepareSegment(4*a,this.vertexArray.length,2*this._segmentToGroundQuads[h].length);let y;h!==this._segments.get().length-1&&(h++,this._segmentToGroundQuads[h]=[],this._segmentToRegionTriCounts[h]=[0,0,0,0,0]);{const T=e[0],f=e[1];y=R0(T.sub(e[a-1])._perp()._unit(),f.sub(T)._perp()._unit())}for(let T=0;T<a;T++){const f=T===a-1?0:T+1,x=e[T],w=e[f],g=e[f===a-1?0:f+1],v=w.sub(x)._perp()._unit(),S=R0(v,g.sub(w)._perp()._unit()),C=y,z=S;if(V_(x,w,i)||u&&O0(x,i)&&O0(w,i)){y=S;continue}const O=m.vertexLength;yp(this.vertexArray,x,w,1,1,C),yp(this.vertexArray,x,w,1,0,C),yp(this.vertexArray,x,w,0,1,z),yp(this.vertexArray,x,w,0,0,z),m.vertexLength+=4;const B=Rw(x,w,v,o);for(const L of B)this._segmentToGroundQuads[h].push({id:O,region:L}),this._segmentToRegionTriCounts[h][L]+=2,m.primitiveLength+=2;y=S}}}prepareBorderSegments(){if(!this.hasData())return;const e=this._segments.get(),i=e.length;for(let o=0;o<i;o++)this._segmentToGroundQuads[o].sort((u,a)=>u.region-a.region);for(let o=0;o<i;o++){const u=this._segmentToGroundQuads[o],a=e[o],h=this._segmentToRegionTriCounts[o];h.reduce((y,T)=>y+T,0);let m=0;for(let y=0;y<=4;y++){const T=h[y];if(T!==0){let f=this.regionSegments[y];f||(f=this.regionSegments[y]=new an);const x={vertexOffset:a.vertexOffset,primitiveOffset:a.primitiveOffset+m,vertexLength:a.vertexLength,primitiveLength:T};f.get().push(x)}m+=T}for(let y=0;y<u.length;y++){const T=u[y].id;this.indexArray.emplaceBack(T,T+1,T+3),this.indexArray.emplaceBack(T,T+3,T+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,i,o,u,a,h){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,i,o,u,a,h)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,vw.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,i,o,u,a,h,m){this.hasData()&&this.programConfigurations.updatePaintArrays(e,i,o,u,a,h,m)}updateHiddenByLandmark(e){if(!this.hasData())return;const i=e.groundVertexCount+e.groundVertexArrayOffset;if(e.groundVertexCount===0)return;const o=e.flags&il?1:0;for(let u=e.groundVertexArrayOffset;u<i;++u)this.hiddenByLandmarkVertexArray.emplace(u,o);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,Tw.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){const i=this.regionSegments[e];i&&i.destroy()}}}}class xp{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new Gn,this.footprintVertices=new Ys,this.footprintSegments=[],this.layoutVertexArray=new Ks,this.centroidVertexArray=new wr,this.wallVertexArray=new ip,this.indexArray=new Gn,this.programConfigurations=new wo(e.layers,{zoom:e.zoom,lut:e.lut},i=>Iw.includes(i)),this.segments=new an,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.groundEffect=new D0(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}updateFootprints(e,i){}populate(e,i,o,u){this.features=[],this.hasPattern=C_("fill-extrusion",this.layers,this.pixelRatio,i),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=t(o),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(const{feature:a,id:h,index:m,sourceLayerIndex:y}of e){const T=this.layers[0]._featureFilter.needGeometry,f=R(a,T);if(!this.layers[0]._featureFilter.filter(new Vi(this.zoom),f,o))continue;const x={id:h,sourceLayerIndex:y,index:m,geometry:T?f.geometry:A(a,o,u),properties:a.properties,type:a.type,patterns:{}},w=this.layoutVertexArray.length,g=N_[x.type]==="Polygon";if(this.hasPattern)this.features.push(P_("fill-extrusion",this.layers,x,this.zoom,this.pixelRatio,i));else if(this.wallMode)for(const v of x.geometry)for(const S of I0(v,g))this.addFeature(x,[S],m,o,{},i.availableImages,u,i.brightness);else this.addFeature(x,x.geometry,m,o,{},i.availableImages,u,i.brightness);i.featureIndex.insert(a,x.geometry,m,y,this.index,w)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,i,o,u,a,h){for(const m of this.features){const y=N_[m.type]==="Polygon",{geometry:T}=m;if(this.wallMode)for(const f of T)for(const x of I0(f,y))this.addFeature(m,[x],m.index,i,o,u,a,h);else this.addFeature(m,T,m.index,i,o,u,a,h)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,i,o,u,a,h,m){this.programConfigurations.updatePaintArrays(e,i,a,o,u,h,m),this.groundEffect.update(e,i,a,o,u,h,m)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Ew),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,ww.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,Sw.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,bw.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,i,o,u,a,h,m,y){const T=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(e,{})/this.tileToMeter,f=[new ft(0,0),new ft(mt,mt)],x=m.projection,w=x.name==="globe",g=this.wallMode||N_[e.type]==="Polygon",v=new z0;v.centroidDataIndex=this.centroidData.length;const S=new P0,C=this.layers[0].paint.get("fill-extrusion-base").evaluate(e,{},u)<=0,z=this.layers[0].paint.get("fill-extrusion-height").evaluate(e,{},u);let O;if(S.height=z,S.vertexArrayOffset=this.layoutVertexArray.length,S.groundVertexArrayOffset=this.groundEffect.vertexArray.length,w&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Hl),this.wallMode){if(w)return void ti("Non zero fill-extrusion-line-width is not yet supported on globe.");if(i.length!==1)return;O=function(Q){const pe=Q[0].x===Q[Q.length-1].x&&Q[0].y===Q[Q.length-1].y;(function(rt){let et=0;const Pt=rt.length;for(let yt=0;yt<Pt;yt++)et+=(rt[(yt+1)%Pt].x-rt[yt].x)*(rt[(yt+1)%Pt].y+rt[yt].y);return et>=0})(Q)||(Q=Q.reverse());const me={geometry:[],joinNormals:[],indices:[]},xe=[],ye=[],we=[];let Ae=Q.length;for(;Ae>=2&&Q[Ae-1].equals(Q[Ae-2]);)Ae--;if(Ae<(pe?3:2))return me;let Re,Ee,$e,Qe,qe,_t=0;for(;_t<Ae-1&&Q[_t].equals(Q[_t+1]);)_t++;pe&&(Re=Q[Ae-2],qe=Q[_t].sub(Re)._unit()._perp());for(let rt=_t;rt<Ae;rt++){if($e=rt===Ae-1?pe?Q[_t+1]:void 0:Q[rt+1],$e&&Q[rt].equals($e))continue;qe&&(Qe=qe),Re&&(Ee=Re),Re=Q[rt],qe=$e?$e.sub(Re)._unit()._perp():Qe,Qe=Qe||qe;let et=Qe.add(qe);et.x===0&&et.y===0||et._unit();const Pt=et.x*qe.x+et.y*qe.y,yt=Pt!==0?1/Pt:1/0,Tt=Qe.x*qe.y-Qe.y*qe.x>0;let Wt="miter";const ei=2;Wt==="miter"&&yt>ei&&(Wt="bevel"),Wt==="bevel"&&(yt>100&&(Wt="flipbevel"),yt<ei&&(Wt="miter"));const ii=(ni,ci,ui,Ni)=>{const Di=new ft(ni.x,ni.y),Kt=new ft(ni.x,ni.y);Di.x+=ci.x*Ni,Di.y+=ci.y*Ni,Kt.x-=ci.x*Math.max(ui,1),Kt.y-=ci.y*Math.max(ui,1),we.push(ci),xe.push(Di),ye.push(Kt)};if(Wt==="miter")et._mult(yt),ii(Re,et,0,0);else if(Wt==="flipbevel")et=qe.mult(-1),ii(Re,et,0,0),ii(Re,et.mult(-1),0,0);else{const ni=-Math.sqrt(yt*yt-1),ci=Tt?ni:0,ui=Tt?0:ni;Ee&&ii(Re,Qe,ci,ui),$e&&ii(Re,qe,ci,ui)}}me.geometry=[...xe,...ye.reverse(),xe[0]],me.joinNormals=[...we,...we.reverse(),we[we.length-1]];const pt=me.geometry.length-1;for(let rt=0;rt<pt/2;rt++)if(rt+1<pt/2){let et=rt,Pt=rt+1,yt=pt-1-rt,Tt=pt-2-rt;et=et===0?pt-1:et-1,Pt=Pt===0?pt-1:Pt-1,yt=yt===0?pt-1:yt-1,Tt=Tt===0?pt-1:Tt-1,me.indices.push(yt),me.indices.push(Pt),me.indices.push(et),me.indices.push(yt),me.indices.push(Tt),me.indices.push(Pt)}return me}(i[0]),i=[O.geometry]}const B=(Q,pe)=>Q<(pe.length-1)/2||Q===pe.length-1,L=this.wallMode?[i]:fp(i,500);for(let Q=L.length-1;Q>=0;Q--){const pe=L[Q];(pe.length===0||(V=pe[0]).every(ie=>ie.x<=0)||V.every(ie=>ie.x>=mt)||V.every(ie=>ie.y<=0)||V.every(ie=>ie.y>=mt))&&L.splice(Q,1)}var V;let j;if(w)j=V0(L,f,u);else{j=[];for(const Q of L)j.push({polygon:Q,bounds:f})}const W=g?this.edgeRadius:0,te=W>0&&this.zoom<17,ee=(Q,pe)=>{if(Q.length===0)return!1;const ie=Q[Q.length-1];return pe.x===ie.x&&pe.y===ie.y};for(const{polygon:Q,bounds:pe}of j){let ie=0,me=0;for(const Ae of Q)g&&!Ae[0].equals(Ae[Ae.length-1])&&Ae.push(Ae[0]),me+=g?Ae.length-1:Ae.length;const xe=this.segments.prepareSegment((g?5:4)*me,this.layoutVertexArray,this.indexArray);S.footprintSegIdx<0&&(S.footprintSegIdx=this.footprintSegments.length),S.polygonSegIdx<0&&(S.polygonSegIdx=this.polygonSegments.length);const ye={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},we=new C0;if(we.vertexOffset=this.footprintVertices.length,we.indexOffset=3*this.footprintIndices.length,we.ringIndices=[],g){const Ae=[],Re=[];ie=xe.vertexLength;for(let $e=0;$e<Q.length;$e++){const Qe=Q[$e];Qe.length&&$e!==0&&Re.push(Ae.length/2);const qe=[];let _t,pt;_t=Qe[1].sub(Qe[0])._perp()._unit(),we.ringIndices.push(Qe.length-1);for(let rt=1;rt<Qe.length;rt++){const et=Qe[rt],Pt=Qe[rt===Qe.length-1?1:rt+1],yt=et.clone();if(W){pt=Pt.sub(et)._perp()._unit();const Tt=_t.add(pt)._unit(),Wt=W*Math.min(4,1/(_t.x*Tt.x+_t.y*Tt.y));yt.x+=Wt*Tt.x,yt.y+=Wt*Tt.y,yt.x=Math.round(yt.x),yt.y=Math.round(yt.y),_t=pt}if(!C||W!==0&&!te||ee(qe,yt)||qe.push(yt),Ed(this.layoutVertexArray,yt.x,yt.y,0,0,1,1,0),this.wallMode){const Tt=B(rt,Qe);Md(this.wallVertexArray,O.joinNormals[rt],!Tt)}xe.vertexLength++,this.footprintVertices.emplaceBack(et.x,et.y),Ae.push(et.x,et.y),w&&Id(this.layoutVertexExtArray,x.projectTilePoint(yt.x,yt.y,u),x.upVector(u,yt.x,yt.y))}C&&(W===0||te)&&(qe.length!==0&&ee(qe,qe[0])&&qe.pop(),this.groundEffect.addData(qe,pe,T))}const Ee=this.wallMode?O.indices:bd(Ae,Re);for(let $e=0;$e<Ee.length;$e+=3)this.footprintIndices.emplaceBack(we.vertexOffset+Ee[$e+0],we.vertexOffset+Ee[$e+1],we.vertexOffset+Ee[$e+2]),this.indexArray.emplaceBack(ie+Ee[$e],ie+Ee[$e+2],ie+Ee[$e+1]),xe.primitiveLength++;we.indexCount+=Ee.length,we.vertexCount+=this.footprintVertices.length-we.vertexOffset}for(let Ae=0;Ae<Q.length;Ae++){const Re=Q[Ae];v.startRing(S,Re[0]);let Ee=Re.length>4&&F0(Re[Re.length-2],Re[0],Re[1]),$e=W?Dw(Re[Re.length-2],Re[0],Re[1],W):0;const Qe=[];let qe,_t,pt;_t=Re[1].sub(Re[0])._perp()._unit();let rt=!0;for(let et=1,Pt=0;et<Re.length;et++){let yt=Re[et-1],Tt=Re[et];const Wt=Re[et===Re.length-1?1:et+1];if(v.appendEdge(S,Tt,yt),V_(Tt,yt,pe)){W&&(_t=Wt.sub(Tt)._perp()._unit(),rt=!rt);continue}const ei=Tt.sub(yt)._perp(),ii=ei.x/(Math.abs(ei.x)+Math.abs(ei.y)),ni=ei.y>0?1:0,ci=yt.dist(Tt);if(Pt+ci>32768&&(Pt=0),W){pt=Wt.sub(Tt)._perp()._unit();let Kt=k0(yt,Tt,Wt,L0(_t,pt),W);isNaN(Kt)&&(Kt=0);const Pi=Tt.sub(yt)._unit();yt=yt.add(Pi.mult($e))._round(),Tt=Tt.add(Pi.mult(-Kt))._round(),$e=Kt,_t=pt,C&&this.zoom>=17&&(ee(Qe,yt)||Qe.push(yt),ee(Qe,Tt)||Qe.push(Tt))}const ui=xe.vertexLength,Ni=Re.length>4&&F0(yt,Tt,Wt);let Di=B0(Pt,Ee,rt);if(Ed(this.layoutVertexArray,yt.x,yt.y,ii,ni,0,0,Di),Ed(this.layoutVertexArray,yt.x,yt.y,ii,ni,0,1,Di),this.wallMode){const Kt=B(et-1,Re),Pi=O.joinNormals[et-1];Md(this.wallVertexArray,Pi,Kt),Md(this.wallVertexArray,Pi,Kt)}if(Pt+=ci,Di=B0(Pt,Ni,!rt),Ee=Ni,Ed(this.layoutVertexArray,Tt.x,Tt.y,ii,ni,0,0,Di),Ed(this.layoutVertexArray,Tt.x,Tt.y,ii,ni,0,1,Di),this.wallMode){const Kt=B(et,Re),Pi=O.joinNormals[et];Md(this.wallVertexArray,Pi,Kt),Md(this.wallVertexArray,Pi,Kt)}if(xe.vertexLength+=4,this.indexArray.emplaceBack(ui+0,ui+1,ui+2),this.indexArray.emplaceBack(ui+1,ui+3,ui+2),xe.primitiveLength+=2,W){const Kt=ie+(et===1?Re.length-2:et-2),Pi=et===1?ie:Kt+1;if(this.indexArray.emplaceBack(ui+1,Kt,ui+3),this.indexArray.emplaceBack(Kt,Pi,ui+3),xe.primitiveLength+=2,qe===void 0&&(qe=ui),!V_(Wt,Re[et],pe)){const Ri=et===Re.length-1?qe:xe.vertexLength;this.indexArray.emplaceBack(ui+2,ui+3,Ri),this.indexArray.emplaceBack(ui+3,Ri+1,Ri),this.indexArray.emplaceBack(ui+3,Pi,Ri+1),xe.primitiveLength+=3}rt=!rt}if(w){const Kt=this.layoutVertexExtArray,Pi=x.projectTilePoint(yt.x,yt.y,u),Ri=x.projectTilePoint(Tt.x,Tt.y,u),Hi=x.upVector(u,yt.x,yt.y),un=x.upVector(u,Tt.x,Tt.y);Id(Kt,Pi,Hi),Id(Kt,Pi,Hi),Id(Kt,Ri,un),Id(Kt,Ri,un)}}g&&(ie+=Re.length-1),C&&W&&this.zoom>=17&&(Qe.length!==0&&ee(Qe,Qe[0])&&Qe.pop(),this.groundEffect.addData(Qe,pe,T,W>0))}this.footprintSegments.push(we),ye.triangleCount=this.indexArray.length-ye.triangleArrayOffset,this.polygonSegments.push(ye),++S.footprintSegLen,++S.polygonSegLen}if(S.vertexCount=this.layoutVertexArray.length-S.vertexArrayOffset,S.groundVertexCount=this.groundEffect.vertexArray.length-S.groundVertexArrayOffset,S.vertexCount!==0){if(S.centroidXY=v.borders?A0:this.encodeCentroid(v,S),this.centroidData.push(S),v.borders){this.featuresOnBorder.push(v);const Q=this.featuresOnBorder.length-1;for(let pe=0;pe<v.borders.length;pe++)v.borders[pe][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[pe].push(Q)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,a,h,u,y),this.groundEffect.addPaintPropertiesData(e,o,a,h,u,y),this.maxHeight=Math.max(this.maxHeight,z)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort((i,o)=>this.featuresOnBorder[i].borders[e][0]-this.featuresOnBorder[o].borders[e][0])}splitToSubtiles(){const e=[];for(let m=0;m<this.centroidData.length;m++){const y=this.centroidData[m],T=+(y.min.y+y.max.y>mt),f=2*T+(+(y.min.x+y.max.x>mt)^T);for(let x=0;x<y.polygonSegLen;x++){const w=y.polygonSegIdx+x;e.push({centroidIdx:m,subtile:f,polygonSegmentIdx:w,triangleSegmentIdx:this.polygonSegments[w].triangleSegIdx})}}const i=new Gn;e.sort((m,y)=>m.triangleSegmentIdx===y.triangleSegmentIdx?m.subtile-y.subtile:m.triangleSegmentIdx-y.triangleSegmentIdx);let o=0,u=0,a=0;for(const m of e){if(m.triangleSegmentIdx!==o)break;a++}const h=e.length;for(;u!==e.length;){o=e[u].triangleSegmentIdx;let m=0,y=u,T=u;for(let f=y;f<a&&e[f].subtile===m;f++)T++;for(;y!==a;){const f=e[y];m=f.subtile;const x=this.centroidData[f.centroidIdx].min.clone(),w=this.centroidData[f.centroidIdx].max.clone(),g={vertexOffset:this.segments.segments[o].vertexOffset,primitiveOffset:i.length,vertexLength:this.segments.segments[o].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let v=y;v<T;v++){const S=e[v],C=this.polygonSegments[S.polygonSegmentIdx],z=this.centroidData[S.centroidIdx].min,O=this.centroidData[S.centroidIdx].max,B=this.indexArray.uint16;for(let L=C.triangleArrayOffset;L<C.triangleArrayOffset+C.triangleCount;L++)i.emplaceBack(B[3*L],B[3*L+1],B[3*L+2]);g.primitiveLength+=C.triangleCount,x.x=Math.min(x.x,z.x),x.y=Math.min(x.y,z.y),w.x=Math.max(w.x,O.x),w.y=Math.max(w.y,O.y)}g.primitiveLength>0&&this.triangleSubSegments.push({segment:g,min:x,max:w}),y=T;for(let v=y;v<a&&e[v].subtile===e[y].subtile;v++)T++}u=a;for(let f=u;f<h&&e[f].triangleSegmentIdx===e[u].triangleSegmentIdx;f++)a++}i._trim(),this.indexArray=i}getVisibleSegments(e,i,o){const u=new an;if(this.wallMode){for(const S of this.triangleSubSegments)u.segments.push(S.segment);return u}let a=0,h=0;const m=1<<e.canonical.z;if(i){const S=i.getMinMaxForTile(e);S&&(a=S.min,h=S.max)}h+=this.maxHeight;const y=e.toUnwrapped();let T;const f=[y.canonical.x/m+y.wrap,y.canonical.y/m],x=[(y.canonical.x+1)/m+y.wrap,(y.canonical.y+1)/m],w=(S,C,z)=>[S[0]*(1-z[0])+C[0]*z[0],S[1]*(1-z[1])+C[1]*z[1]],g=[],v=[];for(const S of this.triangleSubSegments){g[0]=S.min.x/mt,g[1]=S.min.y/mt,v[0]=S.max.x/mt,v[1]=S.max.y/mt;const C=w(f,x,g),z=w(f,x,v);if(new Lt([C[0],C[1],a],[z[0],z[1],h]).intersectsPrecise(o)===0){T&&(u.segments.push(T),T=void 0);continue}const O=S.segment;T&&T.vertexOffset!==O.vertexOffset&&(u.segments.push(T),T=void 0),T?(T.vertexLength+=O.vertexLength,T.primitiveLength+=O.primitiveLength):T={vertexOffset:O.vertexOffset,primitiveLength:O.primitiveLength,vertexLength:O.vertexLength,primitiveOffset:O.primitiveOffset,sortKey:void 0,vaos:{}}}return T&&u.segments.push(T),u}encodeCentroid(e,i){const o=e.centroid(),u=i.span(),a=Math.min(7,Math.round(u.x*this.tileToMeter/10)),h=Math.min(7,Math.round(u.y*this.tileToMeter/10));return new ft(ri(o.x,1,mt-1)<<3|a,ri(o.y,1,mt-1)<<3|h)}encodeBorderCentroid(e){if(!e.borders)return new ft(0,0);const i=e.borders,o=Number.MAX_VALUE;if(i[0][0]!==o||i[1][0]!==o){const u=i[0][0]!==o?0:1;return new ft(6|(i[0][0]!==o?0:65528),(i[u][0]+i[u][1])/2<<3|6)}{const u=i[2][0]!==o?2:3;return new ft((i[u][0]+i[u][1])/2<<3|6,6|(i[2][0]!==o?0:65528))}}showCentroid(e){const i=this.centroidData[e.centroidDataIndex];i.flags&=il,i.centroidXY.x=0,i.centroidXY.y=0,this.writeCentroidToBuffer(i)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);const i=e.vertexArrayOffset,o=e.vertexCount+e.vertexArrayOffset,u=e.flags&il?A0:e.centroidXY,a=this.centroidVertexArray.geta_centroid_pos0(i);if(this.centroidVertexArray.geta_centroid_pos1(i)!==u.y||a!==u.x){for(let h=i;h<o;++h)this.centroidVertexArray.emplace(h,u.x,u.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,i,o){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const u=i.getReplacementRegionsForTile(e.toUnwrapped());if(F_(this.activeReplacements,u))return;if(this.activeReplacements=u,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const h of this.centroidData)h.flags&=2147483647;const a=[];for(const h of this.activeReplacements){if(h.order<o)continue;const m=Math.max(1,Math.pow(2,h.footprintTileId.canonical.z-e.canonical.z));for(const y of this.centroidData)if(!(y.flags&il||h.min.x>y.max.x||y.min.x>h.max.x||h.min.y>y.max.y||y.min.y>h.max.y))for(let T=0;T<y.footprintSegLen;T++){const f=this.footprintSegments[y.footprintSegIdx+T];if(a.length=0,Lw(this.footprintVertices,f.vertexOffset,f.vertexCount,h.footprintTileId.canonical,e.canonical,a),T0(h.footprint,a,this.footprintIndices.uint16,f.indexOffset,f.indexCount,-f.vertexOffset,-m)){y.flags|=il;break}}}for(const h of this.centroidData)this.writeCentroidToBuffer(h);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,i,o){let u=!1;for(let a=0;a<o.footprintSegLen;a++){const h=this.footprintSegments[o.footprintSegIdx+a];let m=0;for(const y of h.ringIndices){for(let T=m,f=y+m-1;T<y+m;f=T++){const x=this.footprintVertices.int16[2*(T+h.vertexOffset)+0],w=this.footprintVertices.int16[2*(T+h.vertexOffset)+1],g=this.footprintVertices.int16[2*(f+h.vertexOffset)+1];w>i!=g>i&&e<(this.footprintVertices.int16[2*(f+h.vertexOffset)+0]-x)*(i-w)/(g-w)+x&&(u=!u)}m=y}}return u}getHeightAtTileCoord(e,i){let o=Number.NEGATIVE_INFINITY,u=!0;const a=4*(e+mt)*mt+(i+mt);if(this.partLookup.hasOwnProperty(a)){const h=this.partLookup[a];return h?{height:h.height,hidden:!!(h.flags&il)}:void 0}for(const h of this.centroidData)e>h.max.x||h.min.x>e||i>h.max.y||h.min.y>i||this.footprintContainsPoint(e,i,h)&&h&&h.height>o&&(o=h.height,this.partLookup[a]=h,u=!!(h.flags&il));if(o!==Number.NEGATIVE_INFINITY)return{height:o,hidden:u};this.partLookup[a]=void 0}}function L0(r,e){const i=r.add(e)._unit();return r.x*i.x+r.y*i.y}function Dw(r,e,i,o){const u=e.sub(r)._perp()._unit(),a=i.sub(e)._perp()._unit();return k0(r,e,i,L0(u,a),o)}function k0(r,e,i,o,u){const a=Math.sqrt(1-o*o);return Math.min(r.dist(e)/3,e.dist(i)/3,u*a/o)}function V_(r,e,i){return r.x<i[0].x&&e.x<i[0].x||r.x>i[1].x&&e.x>i[1].x||r.y<i[0].y&&e.y<i[0].y||r.y>i[1].y&&e.y>i[1].y}function O0(r,e){return r.x<e[0].x||r.x>e[1].x||r.y<e[0].y||r.y>e[1].y}function F0(r,e,i){if(r.x<0||r.x>=mt||e.x<0||e.x>=mt||i.x<0||i.x>=mt)return!1;const o=i.sub(e),u=o.perp(),a=r.sub(e);return(o.x*a.x+o.y*a.y)/Math.sqrt((o.x*o.x+o.y*o.y)*(a.x*a.x+a.y*a.y))>-.866&&u.x*a.x+u.y*a.y<0}function B0(r,e,i){const o=e?2|r:-3&r;return i?1|o:-2&o}function N0(){const r=Math.PI/32,e=Math.tan(r),i=oa;return i*Math.sqrt(1+2*e*e)-i}function V0(r,e,i){const o=1<<i.z,u=Tr(i.x/o),a=Tr((i.x+1)/o),h=qn(i.y/o),m=qn((i.y+1)/o);return function(y,T,f,x,w=0,g){const v=[];if(!y.length||!f||!x)return v;const S=(j,W)=>{for(const te of j)v.push({polygon:te,bounds:W})},C=Math.ceil(Math.log2(f)),z=Math.ceil(Math.log2(x)),O=C-z,B=[];for(let j=0;j<Math.abs(O);j++)B.push(O>0?0:1);for(let j=0;j<Math.min(C,z);j++)B.push(0),B.push(1);let L=y;if(L=mp(L,T[0].y-w,T[1].y+w,1),L=mp(L,T[0].x-w,T[1].x+w,0),!L.length)return v;const V=[];for(B.length?V.push({polygons:L,bounds:T,depth:0}):S(L,T);V.length;){const j=V.pop(),W=j.depth,te=B[W],ee=j.bounds[0],Q=j.bounds[1],pe=te===0?ee.x:ee.y,ie=te===0?Q.x:Q.y,me=g(te,pe,ie),xe=mp(j.polygons,pe-w,me+w,te),ye=mp(j.polygons,me-w,ie+w,te);if(xe.length){const we=[ee,new ft(te===0?me:Q.x,te===1?me:Q.y)];B.length>W+1?V.push({polygons:xe,bounds:we,depth:W+1}):S(xe,we)}if(ye.length){const we=[new ft(te===0?me:ee.x,te===1?me:ee.y),Q];B.length>W+1?V.push({polygons:ye,bounds:we,depth:W+1}):S(ye,we)}}return v}(r,e,Math.ceil((a-u)/11.25),Math.ceil((h-m)/11.25),1,(y,T,f)=>{if(y===0)return .5*(T+f);{const x=qn((i.y+T/mt)/o);return(ts(.5*(qn((i.y+f/mt)/o)+x))*o-i.y)*mt}})}function Lw(r,e,i,o,u,a){const h=Math.pow(2,o.z-u.z);for(let m=0;m<i;m++){let y=r.int16[2*(m+e)+0],T=r.int16[2*(m+e)+1];y=(y+u.x*mt)*h-o.x*mt,T=(T+u.y*mt)*h-o.y*mt,a.push(new ft(y,T))}}let U0,j0;function Ad(r,e){return r.x*e.x+r.y*e.y}function G0(r,e){if(r.length===1){let i=0;const o=e[i++];let u;for(;!u||o.equals(u);)if(u=e[i++],!u)return 1/0;for(;i<e.length;i++){const a=e[i],h=r[0],m=u.sub(o),y=a.sub(o),T=h.sub(o),f=Ad(m,m),x=Ad(m,y),w=Ad(y,y),g=Ad(T,m),v=Ad(T,y),S=f*w-x*x,C=(w*g-x*v)/S,z=(f*v-x*g)/S,O=o.z*(1-C-z)+u.z*C+a.z*z;if(isFinite(O))return O}return 1/0}{let i=1/0;for(const o of e)i=Math.min(i,o.z);return i}}function q0(r,e,i,o,u,a,h,m){const y=h*u.getElevationAt(r,e,!0,!0),T=a[0]!==0,f=T?a[1]===0?h*(a[0]/7-450):h*function(x,w,g){const v=Math.floor(w[0]/8),S=Math.floor(w[1]/8),C=10*(w[0]-8*v),z=10*(w[1]-8*S),O=x.getElevationAt(v,S,!0,!0),B=x.getMeterToDEM(g),L=Math.floor(.5*(C*B-1)),V=Math.floor(.5*(z*B-1)),j=x.tileCoordToPixel(v,S),W=2*L+1,te=2*V+1,ee=function(ye,we,Ae,Re,Ee){return[ye.getElevationAtPixel(we,Ae,!0),ye.getElevationAtPixel(we+Ee,Ae,!0),ye.getElevationAtPixel(we,Ae+Ee,!0),ye.getElevationAtPixel(we+Re,Ae+Ee,!0)]}(x,j.x-L,j.y-V,W,te),Q=Math.abs(ee[0]-ee[1]),pe=Math.abs(ee[2]-ee[3]),ie=Math.abs(ee[0]-ee[2])+Math.abs(ee[1]-ee[3]),me=Math.min(.25,.5*B*(Q+pe)/W),xe=Math.min(.25,.5*B*ie/te);return O+Math.max(me*C,xe*z)}(u,a,m):y;return{base:y+(i===0?-1:i),top:T?Math.max(f+o,y+i+2):y+o}}Mt(xp,"FillExtrusionBucket",{omit:["layers","features"]}),Mt(P0,"PartData"),Mt(C0,"FootprintSegment"),Mt(z0,"BorderCentroidData"),Mt(D0,"GroundEffect");const kw=Ii([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),Ow=Ii([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:Fw}=kw,Bw=Ii([{name:"a_packed",components:3,type:"Float32"}]),{members:Nw}=Bw,Vw=Ii([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:Uw}=Vw;class $0{constructor(e,i){this.width=e,this.height=i,this.nextRow=0,this.image=new tl({width:e,height:i}),this.positions={},this.uploaded=!1}getDash(e,i){const o=this.getKey(e,i);return this.positions[o]}trim(){const e=this.width,i=this.height=ba(this.nextRow);this.image.resize({width:e,height:i})}getKey(e,i){return e.join(",")+i}getDashRanges(e,i,o){const u=[];let a=e.length%2==1?-e[e.length-1]*o:0,h=e[0]*o,m=!0;u.push({left:a,right:h,isDash:m,zeroLength:e[0]===0});let y=e[0];for(let T=1;T<e.length;T++){m=!m;const f=e[T];a=y*o,y+=f,h=y*o,u.push({left:a,right:h,isDash:m,zeroLength:f===0})}return u}addRoundDash(e,i,o){const u=i/2;for(let a=-o;a<=o;a++){const h=this.width*(this.nextRow+o+a);let m=0,y=e[m];for(let T=0;T<this.width;T++){T/y.right>1&&(y=e[++m]);const f=Math.abs(T-y.left),x=Math.abs(T-y.right),w=Math.min(f,x);let g;const v=a/o*(u+1);if(y.isDash){const S=u-Math.abs(v);g=Math.sqrt(w*w+S*S)}else g=u-Math.sqrt(w*w+v*v);this.image.data[h+T]=Math.max(0,Math.min(255,g+128))}}}addRegularDash(e,i){for(let y=e.length-1;y>=0;--y){const T=e[y],f=e[y+1];T.zeroLength?e.splice(y,1):f&&f.isDash===T.isDash&&(f.left=T.left,e.splice(y,1))}const o=e[0],u=e[e.length-1];o.isDash===u.isDash&&(o.left=u.left-this.width,u.right=o.right+this.width);const a=this.width*this.nextRow;let h=0,m=e[h];for(let y=0;y<this.width;y++){y/m.right>1&&(m=e[++h]);const T=Math.abs(y-m.left),f=Math.abs(y-m.right),x=Math.min(T,f);this.image.data[a+y]=Math.max(0,Math.min(255,(m.isDash?x:-x)+i+128))}}addDash(e,i){const o=this.getKey(e,i);if(this.positions[o])return this.positions[o];const u=i==="round",a=u?7:0,h=2*a+1;if(this.nextRow+h>this.height)return ti("LineAtlas out of space"),null;e.length===0&&e.push(1);let m=0;for(let f=0;f<e.length;f++)e[f]<0&&(ti("Negative value is found in line dasharray, replacing values with 0"),e[f]=0),m+=e[f];if(m!==0){const f=this.width/m,x=this.getDashRanges(e,this.width,f);u?this.addRoundDash(x,f,a):this.addRegularDash(x,i==="square"?.5*f:0)}const y=this.nextRow+a;this.nextRow+=h;const T={tl:[y,a],br:[m,0]};return this.positions[o]=T,T}}Mt($0,"LineAtlas");const jw=Iu.VectorTileFeature.types,Gw=Math.cos(Math.PI/180*37.5),qw=Math.cos(Math.PI/180*5);class U_{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasZOffset=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(i=>{this.gradients[i.id]={}}),this.layoutVertexArray=new Zl,this.layoutVertexArray2=new vs,this.patternVertexArray=new vs,this.indexArray=new Gn,this.programConfigurations=new wo(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new an,this.maxLineLength=0,this.zOffsetVertexArray=new vs,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.tessellationStep=e.tessellationStep?e.tessellationStep:mt/64}updateFootprints(e,i){}populate(e,i,o,u){this.hasPattern=C_("line",this.layers,this.pixelRatio,i);const a=this.layers[0].layout.get("line-sort-key");this.tileToMeter=t(o);const h=this.layers[0].layout.get("line-z-offset"),m=h.isConstant()&&!h.constantOr(0),y=this.layers[0].layout.get("line-elevation-reference");this.hasZOffset=y==="sea"||y==="ground"||!m&&y==="none",this.hasZOffset&&y==="none"&&ti(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`);const T=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.hasZOffset&&T!==void 0;const f=[];for(const{feature:v,id:S,index:C,sourceLayerIndex:z}of e){const O=this.layers[0]._featureFilter.needGeometry,B=R(v,O);if(!this.layers[0]._featureFilter.filter(new Vi(this.zoom),B,o))continue;const L=a?a.evaluate(B,{},o):void 0,V={id:S,properties:v.properties,type:v.type,sourceLayerIndex:z,index:C,geometry:O?B.geometry:A(v,o,u),patterns:{},sortKey:L};f.push(V)}a&&f.sort((v,S)=>v.sortKey-S.sortKey);const{lineAtlas:x,featureIndex:w}=i,g=this.addConstantDashes(x);for(const v of f){const{geometry:S,index:C,sourceLayerIndex:z}=v;if(g&&this.addFeatureDashes(v,x),this.hasPattern){const O=P_("line",this.layers,v,this.zoom,this.pixelRatio,i);this.patternFeatures.push(O)}else this.addFeature(v,S,C,o,x.positions,i.availableImages,i.brightness);w.insert(e[C].feature,S,C,z,this.index)}}addConstantDashes(e){let i=!1;for(const o of this.layers){const u=o.paint.get("line-dasharray").value,a=o.layout.get("line-cap").value;if(u.kind!=="constant"||a.kind!=="constant")i=!0;else{const h=a.value,m=u.value;if(!m)continue;e.addDash(m,h)}}return i}addFeatureDashes(e,i){const o=this.zoom;for(const u of this.layers){const a=u.paint.get("line-dasharray").value,h=u.layout.get("line-cap").value;if(a.kind==="constant"&&h.kind==="constant")continue;let m,y;if(a.kind==="constant"){if(m=a.value,!m)continue}else m=a.evaluate({zoom:o},e);y=h.kind==="constant"?h.value:h.evaluate({zoom:o},e),i.addDash(m,y),e.patterns[u.id]=i.getKey(m,y)}}update(e,i,o,u,a,h,m){this.programConfigurations.updatePaintArrays(e,i,a,o,u,h,m)}addFeatures(e,i,o,u,a,h){for(const m of this.patternFeatures)this.addFeature(m,m.geometry,m.index,i,o,u,h)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,Nw)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,Uw)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,Ow.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Fw),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,i,o,u,a,h,m){const y=this.layers[0].layout,T=y.get("line-join").evaluate(e,{}),f=y.get("line-cap").evaluate(e,{}),x=y.get("line-miter-limit"),w=y.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e,this.zOffsetValue=y.get("line-z-offset").value;const g=this.layers[0].paint.get("line-width").value;g.kind!=="constant"&&g.isLineProgressConstant===!1&&(this.variableWidthValue=g);for(const v of i)this.addLine(v,e,u,T,f,x,w);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,a,h,u,m)}addLine(e,i,o,u,a,h,m){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;const y=u==="none";if(this.patternJoinNone=this.hasPattern&&y,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[],this.lineClips){this.lineClipsArray.push(this.lineClips);for(let B=0;B<e.length-1;B++)this.totalDistance+=e[B].dist(e[B+1]);this.totalFeatureLength=this.totalDistance/(this.lineClips.end-this.lineClips.start),this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const T=jw[i.type]==="Polygon";let f=e.length;for(;f>=2&&e[f-1].equals(e[f-2]);)f--;let x=0;for(;x<f-1&&e[x].equals(e[x+1]);)x++;if(f<(T?3:2))return;u==="bevel"&&(h=1.05);const w=this.segments.prepareSegment(10*f,this.layoutVertexArray,this.indexArray);let g,v,S,C,z,O;this.e1=this.e2=-1,T&&(g=e[f-2],z=e[x].sub(g)._unit()._perp());for(let B=x;B<f;B++){if(S=B===f-1?T?e[x+1]:void 0:e[B+1],S&&e[B].equals(S))continue;z&&(C=z),g&&(v=g),g=e[B],O=this.evaluateLineProgressFeatures(v?v.dist(g):0),z=S?S.sub(g)._unit()._perp():C,C=C||z;const L=v&&S;let V=L?u:T||y?"butt":a;const j=C.x*z.x+C.y*z.y;if(y){const xe=function(ye){if(ye.patternJoinNone){const we=ye.segmentPoints.length/2,Ae=ye.lineSoFar-ye.segmentStart;for(let Re=0;Re<we;++Re){const Ee=ye.segmentPoints[2*Re+1],$e=Math.round(ye.segmentPoints[2*Re])+.5+.25*Ee;ye.patternVertexArray.emplaceBack($e,Ae,ye.segmentStart),ye.patternVertexArray.emplaceBack($e,Ae,ye.segmentStart)}ye.segmentPoints.length=0}ye.e1=ye.e2=-1};if(L&&j<qw){this.updateDistance(v,g),this.addCurrentVertex(g,C,1,1,w,O),xe(this),this.addCurrentVertex(g,z,-1,-1,w,O);continue}if(v){if(!S){this.updateDistance(v,g),this.addCurrentVertex(g,C,1,1,w,O),xe(this);continue}V="miter"}}let W=C.add(z);W.x===0&&W.y===0||W._unit();const te=W.x*z.x+W.y*z.y,ee=te!==0?1/te:1/0,Q=2*Math.sqrt(2-2*te),pe=te<Gw&&v&&S,ie=C.x*z.y-C.y*z.x>0,me=this.overscaling<=16?15*mt/(512*this.overscaling):0;if(L&&V==="round"){if(ee<m)V="miter";else if(ee<=2){const xe=j_(g,-10,mt+10);V=this.hasZOffset&&(xe||this.hasCrossSlope)?"miter":"fakeround"}}if(V==="miter"&&ee>h&&(V="bevel"),V==="bevel"&&(ee>2&&(V="flipbevel"),ee<h&&(V="miter")),v&&!(V==="miter"&&pe)&&this.updateDistance(v,g),V==="miter")if(pe){const xe=g.dist(v);if(xe>2*me){const we=g.sub(g.sub(v)._mult(me/xe)._round());this.updateDistance(v,we),this.addCurrentVertex(we,C,0,0,w,O),v=we}this.updateDistance(v,g),W._mult(ee),this.addCurrentVertex(g,W,0,0,w,O);const ye=g.dist(S);if(ye>2*me){const we=g.add(S.sub(g)._mult(me/ye)._round());this.updateDistance(g,we),this.addCurrentVertex(we,z,0,0,w,O),g=we}}else W._mult(ee),this.addCurrentVertex(g,W,0,0,w,O);else if(V==="flipbevel"){if(ee>100)W=z.mult(-1);else{const xe=ee*C.add(z).mag()/C.sub(z).mag();W._perp()._mult(xe*(ie?-1:1))}this.addCurrentVertex(g,W,0,0,w,O),this.addCurrentVertex(g,W.mult(-1),0,0,w,O)}else if(V==="bevel"||V==="fakeround"){O!=null&&v&&this.addCurrentVertex(g,C,-1,-1,w,O);const xe=g.dist(v)<=2*me&&V!=="bevel",ye=W.mult(ie?1:-1);ye._mult(ee);const we=z.mult(ie?-1:1),Ae=C.mult(ie?-1:1),Re=this.evaluateLineProgressFeatures(this.distance);if(O==null&&(this.addHalfVertex(g,ye.x,ye.y,!1,!ie,0,w,Re),xe||this.addHalfVertex(g,ye.x+2*Ae.x,ye.y+2*Ae.y,!1,ie,0,w,Re)),V==="fakeround"){const Ee=Math.round(180*Q/Math.PI/20);this.addHalfVertex(g,Ae.x,Ae.y,!1,ie,0,w,Re);for(let $e=0;$e<Ee;$e++){let Qe=$e/Ee;if(Qe!==.5){const _t=Qe-.5;Qe+=Qe*_t*(Qe-1)*((1.0904+j*(j*(3.55645-1.43519*j)-3.2452))*_t*_t+(.848013+j*(.215638*j-1.06021)))}const qe=we.sub(Ae)._mult(Qe)._add(Ae)._unit();this.addHalfVertex(g,qe.x,qe.y,!1,ie,0,w,Re)}this.addHalfVertex(g,we.x,we.y,!1,ie,0,w,Re)}xe||O!=null||this.addHalfVertex(g,ye.x+2*we.x,ye.y+2*we.y,!1,ie,0,w,Re),O!=null&&S&&this.addCurrentVertex(g,z,1,1,w,O)}else V==="butt"?this.addCurrentVertex(g,W,0,0,w,O):V==="square"?(v||this.addCurrentVertex(g,W,-1,-1,w,O),this.addCurrentVertex(g,W,0,0,w,O),v&&this.addCurrentVertex(g,W,1,1,w,O)):V==="round"&&(v&&(this.addCurrentVertex(g,C,0,0,w,O),this.addCurrentVertex(g,C,1,1,w,O,!0)),S&&(this.addCurrentVertex(g,z,-1,-1,w,O,!0),this.addCurrentVertex(g,z,0,0,w,O)))}}addVerticesTo(e,i,o,u,a,h,m,y,T,f){const x=(i.w-e.w)/this.tessellationStep|0;let w=0;const g=this.scaledDistance;if(x>1){this.lineSoFar=e.w;const S=(i.x-e.x)/x,C=(i.y-e.y)/x,z=(i.z-e.z)/x,O=(i.w-e.w)/x;for(let B=1;B<x;++B){e.x+=S,e.y+=C,e.z+=z,this.lineSoFar+=O,w+=O;const L=this.evaluateLineProgressFeatures(this.prevDistance+w);this.scaledDistance=(this.prevDistance+w)/this.totalDistance,this.addHalfVertex(e,o,u,f,!1,m,T,L),this.addHalfVertex(e,a,h,f,!0,-y,T,L)}}this.lineSoFar=i.w,this.scaledDistance=g;const v=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(i,o,u,f,!1,m,T,v),this.addHalfVertex(i,a,h,f,!0,-y,T,v)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&!this.hasZOffset)return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):ti(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let i=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(i=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.hasZOffset?this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:i}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:i}:{zOffset:0,variableWidth:i}}addCurrentVertex(e,i,o,u,a,h,m=!1){const y=i.x+i.y*o,T=i.y-i.x*o,f=i.y*u-i.x,x=-i.y-i.x*u;if(h!=null){const w=this.hasZOffset,g=-10,v=mt+10,S=h.zOffset,C=new g0(e.x,e.y,S,this.lineSoFar),z=!!w&&j_(e,g,v),O=this.lineSoFar,B=this.distance;if(this.currentVertex)if(z){const L=this.currentVertexIsOutside,V=this.currentVertex,j=new g0(e.x,e.y,S,this.lineSoFar);if(x0(V,j,g,v),!j_(j,g,v)){if(L){this.e1=this.e2=-1,this.distance-=V.dist(C),this.lineSoFar=V.w;const W=this.evaluateLineProgressFeatures(V.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(V,y,T,m,!1,o,a,W),this.addHalfVertex(V,f,x,m,!0,-u,a,W),this.prevDistance=this.distance}this.distance=this.prevDistance+V.dist(j),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(V,j,y,T,f,x,o,u,a,m),this.distance=B,this.scaledDistance=this.distance/this.totalDistance}}else{const L=this.currentVertex;if(this.currentVertexIsOutside){x0(L,C,g,v),this.e1=this.e2=-1,this.distance-=L.dist(C),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=L.w;const V=this.evaluateLineProgressFeatures(L.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(L,y,T,m,!1,o,a,V),this.addHalfVertex(L,f,x,m,!0,-u,a,V),this.prevDistance=this.distance,this.distance=B,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(L,C,y,T,f,x,o,u,a,m)}else z||(this.addHalfVertex(e,y,T,m,!1,o,a,h),this.addHalfVertex(e,f,x,m,!0,-u,a,h));this.currentVertex=C,this.currentVertexIsOutside=z,this.lineSoFar=O}else this.addHalfVertex(e,y,T,m,!1,o,a,h),this.addHalfVertex(e,f,x,m,!0,-u,a,h)}addHalfVertex({x:e,y:i},o,u,a,h,m,y,T){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),h||this.segmentPoints.push(this.lineSoFar-this.segmentStart,m)),this.layoutVertexArray.emplaceBack((e<<1)+(a?1:0),(i<<1)+(h?1:0),Math.round(63*o)+128,Math.round(63*u)+128,1+(m===0?0:m<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const x=Gt(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,x)}const f=y.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,f),y.primitiveLength++),h?this.e2=f:this.e1=f,T!=null&&this.zOffsetVertexArray.emplaceBack(T.zOffset,T.variableWidth,T.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,i){this.prevDistance=this.distance,this.distance+=e.dist(i),this.updateScaledDistance()}}function j_(r,e,i){return r.x<e||r.x>i||r.y<e||r.y>i}let Z0,H0;function W0(r,e,i){return e*(mt/(r.tileSize*Math.pow(2,i-r.tileID.overscaledZ)))}Mt(U_,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const X0=(r,e,i)=>(1-i)*r+i*e;function Y0(r,e){return 1/W0(r,1,e.tileZoom)}function K0(r,e,i,o){return r.translatePosMatrix(o||e.tileID.projMatrix,e,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}const J0=r=>{const e=[];Q0(r)&&e.push("RENDER_LINE_DASH"),r.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");const i=r.paint.get("line-trim-offset");i[0]===0&&i[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),r.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER");const o=r.layout.get("line-join").constantOr("miter")==="none",u=!!r.paint.get("line-pattern").constantOr(1);return o&&u&&e.push("LINE_JOIN_NONE"),e};function Q0(r){const e=r.paint.get("line-dasharray").value;return e.value||e.kind!=="constant"}let G_;const e1=()=>G_||(G_={layout:Z0||(Z0=new Yi({"line-cap":new wt(ke.layout_line["line-cap"]),"line-join":new wt(ke.layout_line["line-join"]),"line-miter-limit":new at(ke.layout_line["line-miter-limit"]),"line-round-limit":new at(ke.layout_line["line-round-limit"]),"line-sort-key":new wt(ke.layout_line["line-sort-key"]),"line-z-offset":new wt(ke.layout_line["line-z-offset"]),"line-elevation-reference":new at(ke.layout_line["line-elevation-reference"]),"line-cross-slope":new at(ke.layout_line["line-cross-slope"]),visibility:new at(ke.layout_line.visibility),"line-width-unit":new at(ke.layout_line["line-width-unit"])})),paint:H0||(H0=new Yi({"line-opacity":new wt(ke.paint_line["line-opacity"]),"line-color":new wt(ke.paint_line["line-color"]),"line-translate":new at(ke.paint_line["line-translate"]),"line-translate-anchor":new at(ke.paint_line["line-translate-anchor"]),"line-width":new wt(ke.paint_line["line-width"]),"line-gap-width":new wt(ke.paint_line["line-gap-width"]),"line-offset":new wt(ke.paint_line["line-offset"]),"line-blur":new wt(ke.paint_line["line-blur"]),"line-dasharray":new wt(ke.paint_line["line-dasharray"]),"line-pattern":new wt(ke.paint_line["line-pattern"]),"line-gradient":new $a(ke.paint_line["line-gradient"]),"line-trim-offset":new at(ke.paint_line["line-trim-offset"]),"line-trim-fade-range":new at(ke.paint_line["line-trim-fade-range"]),"line-trim-color":new at(ke.paint_line["line-trim-color"]),"line-emissive-strength":new at(ke.paint_line["line-emissive-strength"]),"line-border-width":new wt(ke.paint_line["line-border-width"]),"line-border-color":new wt(ke.paint_line["line-border-color"]),"line-occlusion-opacity":new at(ke.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"})}))},G_);class $w extends wt{possiblyEvaluate(e,i){return i=new Vi(Math.floor(i.zoom),{now:i.now,fadeDuration:i.fadeDuration,transition:i.transition}),super.possiblyEvaluate(e,i)}evaluate(e,i,o,u){return i=sr({},i,{zoom:Math.floor(i.zoom)}),super.evaluate(e,i,o,u)}}let Cd;function t1(r,e){return e>0?e+2*r:r}const Zw=Ii([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Hw=Ii([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),Ww=Ii([{name:"a_projected_pos",components:4,type:"Float32"}],4);Ii([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const Xw=Ii([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),Yw=Ii([{name:"a_texb",components:2,type:"Uint16"}]),Kw=Ii([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),Jw=Ii([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);Ii([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const i1=Ii([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Qw=Ii([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Ii([{name:"triangle",components:3,type:"Uint16"}]),Ii([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Ii([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"}]),Ii([{type:"Float32",name:"offsetX"}]),Ii([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var tr=24;const Qs=128;function q_(r,e,i,o,u){if(r.kind==="camera")return r.maxSize;if(r.kind==="composite"){const a=e.possiblyEvaluate(new Vi(r.maxZoom),i).evaluate(u,{},i),h=e.possiblyEvaluate(new Vi(r.minZoom),i).evaluate(u,{},i);return Math.max(a,h)}return e.possiblyEvaluate(new Vi(o)).evaluate(u,{},i)}function $_(r,e){const{expression:i}=e;if(i.kind==="constant")return{kind:"constant",layoutSize:i.evaluate(new Vi(r+1))};if(i.kind==="source")return{kind:"source"};{const{zoomStops:o,interpolationType:u}=i;let a=0;for(;a<o.length&&o[a]<=r;)a++;a=Math.max(0,a-1);let h=a;for(;h<o.length&&o[h]<r+1;)h++;h=Math.min(o.length-1,h);const m=o[a],y=o[h];return i.kind==="composite"?{kind:"composite",minZoom:m,maxZoom:y,interpolationType:u}:{kind:"camera",minZoom:m,maxZoom:y,minSize:i.evaluate(new Vi(m)),maxSize:i.evaluate(new Vi(y)),interpolationType:u}}}function vp(r,{uSize:e,uSizeT:i},{lowerSize:o,upperSize:u}){return r.kind==="source"?o/Qs:r.kind==="composite"?Gt(o/Qs,u/Qs,i):e}function Au(r,e,i=1){let o=0,u=0;if(r.kind==="constant")u=r.layoutSize*i;else if(r.kind!=="source"){const{interpolationType:a,minZoom:h,maxZoom:m}=r,y=a?ri(vr.interpolationFactor(a,e,h,m),0,1):0;r.kind==="camera"?u=Gt(r.minSize,r.maxSize,y)*i:o=y*i}return{uSizeT:o,uSize:u}}var e2=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:Qs,evaluateSizeForFeature:vp,evaluateSizeForZoom:Au,getRasterizedIconSize:q_,getSizeData:$_});function t2(r,e,i){return r.sections.forEach(o=>{o.text=function(u,a,h){const m=a.layout.get("text-transform").evaluate(h,{});return m==="uppercase"?u=u.toLocaleUpperCase():m==="lowercase"&&(u=u.toLocaleLowerCase()),Ar.applyArabicShaping&&(u=Ar.applyArabicShaping(u)),u}(o.text,e,i)}),r}const Pd={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂","←":"↑","→":"↓"};function i2(r){return r==="︶"||r==="﹈"||r==="︸"||r==="﹄"||r==="﹂"||r==="︾"||r==="︼"||r==="︺"||r==="︘"||r==="﹀"||r==="︐"||r==="︓"||r==="︔"||r==="｀"||r==="￣"||r==="︑"||r==="︒"}function n2(r){return r==="︵"||r==="﹇"||r==="︷"||r==="﹃"||r==="﹁"||r==="︽"||r==="︻"||r==="︹"||r==="︗"||r==="︿"}var n1,Z_,r1,H_={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */function r2(){return n1||(n1=1,H_.read=function(r,e,i,o,u){var a,h,m=8*u-o-1,y=(1<<m)-1,T=y>>1,f=-7,x=i?u-1:0,w=i?-1:1,g=r[e+x];for(x+=w,a=g&(1<<-f)-1,g>>=-f,f+=m;f>0;a=256*a+r[e+x],x+=w,f-=8);for(h=a&(1<<-f)-1,a>>=-f,f+=o;f>0;h=256*h+r[e+x],x+=w,f-=8);if(a===0)a=1-T;else{if(a===y)return h?NaN:1/0*(g?-1:1);h+=Math.pow(2,o),a-=T}return(g?-1:1)*h*Math.pow(2,a-o)},H_.write=function(r,e,i,o,u,a){var h,m,y,T=8*a-u-1,f=(1<<T)-1,x=f>>1,w=u===23?Math.pow(2,-24)-Math.pow(2,-77):0,g=o?0:a-1,v=o?1:-1,S=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(m=isNaN(e)?1:0,h=f):(h=Math.floor(Math.log(e)/Math.LN2),e*(y=Math.pow(2,-h))<1&&(h--,y*=2),(e+=h+x>=1?w/y:w*Math.pow(2,1-x))*y>=2&&(h++,y/=2),h+x>=f?(m=0,h=f):h+x>=1?(m=(e*y-1)*Math.pow(2,u),h+=x):(m=e*Math.pow(2,x-1)*Math.pow(2,u),h=0));u>=8;r[i+g]=255&m,g+=v,m/=256,u-=8);for(h=h<<u|m,T+=u;T>0;r[i+g]=255&h,g+=v,h/=256,T-=8);r[i+g-v]|=128*S}),H_}function s1(){if(r1)return Z_;r1=1,Z_=e;var r=r2();function e(L){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(L)?L:new Uint8Array(L||0),this.pos=0,this.type=0,this.length=this.buf.length}e.Varint=0,e.Fixed64=1,e.Bytes=2,e.Fixed32=5;var i=4294967296,o=1/i,u=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function a(L){return L.type===e.Bytes?L.readVarint()+L.pos:L.pos+1}function h(L,V,j){return j?4294967296*V+(L>>>0):4294967296*(V>>>0)+(L>>>0)}function m(L,V,j){var W=V<=16383?1:V<=2097151?2:V<=268435455?3:Math.floor(Math.log(V)/(7*Math.LN2));j.realloc(W);for(var te=j.pos-1;te>=L;te--)j.buf[te+W]=j.buf[te]}function y(L,V){for(var j=0;j<L.length;j++)V.writeVarint(L[j])}function T(L,V){for(var j=0;j<L.length;j++)V.writeSVarint(L[j])}function f(L,V){for(var j=0;j<L.length;j++)V.writeFloat(L[j])}function x(L,V){for(var j=0;j<L.length;j++)V.writeDouble(L[j])}function w(L,V){for(var j=0;j<L.length;j++)V.writeBoolean(L[j])}function g(L,V){for(var j=0;j<L.length;j++)V.writeFixed32(L[j])}function v(L,V){for(var j=0;j<L.length;j++)V.writeSFixed32(L[j])}function S(L,V){for(var j=0;j<L.length;j++)V.writeFixed64(L[j])}function C(L,V){for(var j=0;j<L.length;j++)V.writeSFixed64(L[j])}function z(L,V){return(L[V]|L[V+1]<<8|L[V+2]<<16)+16777216*L[V+3]}function O(L,V,j){L[j]=V,L[j+1]=V>>>8,L[j+2]=V>>>16,L[j+3]=V>>>24}function B(L,V){return(L[V]|L[V+1]<<8|L[V+2]<<16)+(L[V+3]<<24)}return e.prototype={destroy:function(){this.buf=null},readFields:function(L,V,j){for(j=j||this.length;this.pos<j;){var W=this.readVarint(),te=W>>3,ee=this.pos;this.type=7&W,L(te,V,this),this.pos===ee&&this.skip(W)}return V},readMessage:function(L,V){return this.readFields(L,V,this.readVarint()+this.pos)},readFixed32:function(){var L=z(this.buf,this.pos);return this.pos+=4,L},readSFixed32:function(){var L=B(this.buf,this.pos);return this.pos+=4,L},readFixed64:function(){var L=z(this.buf,this.pos)+z(this.buf,this.pos+4)*i;return this.pos+=8,L},readSFixed64:function(){var L=z(this.buf,this.pos)+B(this.buf,this.pos+4)*i;return this.pos+=8,L},readFloat:function(){var L=r.read(this.buf,this.pos,!0,23,4);return this.pos+=4,L},readDouble:function(){var L=r.read(this.buf,this.pos,!0,52,8);return this.pos+=8,L},readVarint:function(L){var V,j,W=this.buf;return V=127&(j=W[this.pos++]),j<128?V:(V|=(127&(j=W[this.pos++]))<<7,j<128?V:(V|=(127&(j=W[this.pos++]))<<14,j<128?V:(V|=(127&(j=W[this.pos++]))<<21,j<128?V:function(te,ee,Q){var pe,ie,me=Q.buf;if(pe=(112&(ie=me[Q.pos++]))>>4,ie<128||(pe|=(127&(ie=me[Q.pos++]))<<3,ie<128)||(pe|=(127&(ie=me[Q.pos++]))<<10,ie<128)||(pe|=(127&(ie=me[Q.pos++]))<<17,ie<128)||(pe|=(127&(ie=me[Q.pos++]))<<24,ie<128)||(pe|=(1&(ie=me[Q.pos++]))<<31,ie<128))return h(te,pe,ee);throw new Error("Expected varint not more than 10 bytes")}(V|=(15&(j=W[this.pos]))<<28,L,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var L=this.readVarint();return L%2==1?(L+1)/-2:L/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var L=this.readVarint()+this.pos,V=this.pos;return this.pos=L,L-V>=12&&u?function(j,W,te){return u.decode(j.subarray(W,te))}(this.buf,V,L):function(j,W,te){for(var ee="",Q=W;Q<te;){var pe,ie,me,xe=j[Q],ye=null,we=xe>239?4:xe>223?3:xe>191?2:1;if(Q+we>te)break;we===1?xe<128&&(ye=xe):we===2?(192&(pe=j[Q+1]))==128&&(ye=(31&xe)<<6|63&pe)<=127&&(ye=null):we===3?(ie=j[Q+2],(192&(pe=j[Q+1]))==128&&(192&ie)==128&&((ye=(15&xe)<<12|(63&pe)<<6|63&ie)<=2047||ye>=55296&&ye<=57343)&&(ye=null)):we===4&&(ie=j[Q+2],me=j[Q+3],(192&(pe=j[Q+1]))==128&&(192&ie)==128&&(192&me)==128&&((ye=(15&xe)<<18|(63&pe)<<12|(63&ie)<<6|63&me)<=65535||ye>=1114112)&&(ye=null)),ye===null?(ye=65533,we=1):ye>65535&&(ye-=65536,ee+=String.fromCharCode(ye>>>10&1023|55296),ye=56320|1023&ye),ee+=String.fromCharCode(ye),Q+=we}return ee}(this.buf,V,L)},readBytes:function(){var L=this.readVarint()+this.pos,V=this.buf.subarray(this.pos,L);return this.pos=L,V},readPackedVarint:function(L,V){if(this.type!==e.Bytes)return L.push(this.readVarint(V));var j=a(this);for(L=L||[];this.pos<j;)L.push(this.readVarint(V));return L},readPackedSVarint:function(L){if(this.type!==e.Bytes)return L.push(this.readSVarint());var V=a(this);for(L=L||[];this.pos<V;)L.push(this.readSVarint());return L},readPackedBoolean:function(L){if(this.type!==e.Bytes)return L.push(this.readBoolean());var V=a(this);for(L=L||[];this.pos<V;)L.push(this.readBoolean());return L},readPackedFloat:function(L){if(this.type!==e.Bytes)return L.push(this.readFloat());var V=a(this);for(L=L||[];this.pos<V;)L.push(this.readFloat());return L},readPackedDouble:function(L){if(this.type!==e.Bytes)return L.push(this.readDouble());var V=a(this);for(L=L||[];this.pos<V;)L.push(this.readDouble());return L},readPackedFixed32:function(L){if(this.type!==e.Bytes)return L.push(this.readFixed32());var V=a(this);for(L=L||[];this.pos<V;)L.push(this.readFixed32());return L},readPackedSFixed32:function(L){if(this.type!==e.Bytes)return L.push(this.readSFixed32());var V=a(this);for(L=L||[];this.pos<V;)L.push(this.readSFixed32());return L},readPackedFixed64:function(L){if(this.type!==e.Bytes)return L.push(this.readFixed64());var V=a(this);for(L=L||[];this.pos<V;)L.push(this.readFixed64());return L},readPackedSFixed64:function(L){if(this.type!==e.Bytes)return L.push(this.readSFixed64());var V=a(this);for(L=L||[];this.pos<V;)L.push(this.readSFixed64());return L},skip:function(L){var V=7&L;if(V===e.Varint)for(;this.buf[this.pos++]>127;);else if(V===e.Bytes)this.pos=this.readVarint()+this.pos;else if(V===e.Fixed32)this.pos+=4;else{if(V!==e.Fixed64)throw new Error("Unimplemented type: "+V);this.pos+=8}},writeTag:function(L,V){this.writeVarint(L<<3|V)},realloc:function(L){for(var V=this.length||16;V<this.pos+L;)V*=2;if(V!==this.length){var j=new Uint8Array(V);j.set(this.buf),this.buf=j,this.length=V}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(L){this.realloc(4),O(this.buf,L,this.pos),this.pos+=4},writeSFixed32:function(L){this.realloc(4),O(this.buf,L,this.pos),this.pos+=4},writeFixed64:function(L){this.realloc(8),O(this.buf,-1&L,this.pos),O(this.buf,Math.floor(L*o),this.pos+4),this.pos+=8},writeSFixed64:function(L){this.realloc(8),O(this.buf,-1&L,this.pos),O(this.buf,Math.floor(L*o),this.pos+4),this.pos+=8},writeVarint:function(L){(L=+L||0)>268435455||L<0?function(V,j){var W,te;if(V>=0?(W=V%4294967296|0,te=V/4294967296|0):(te=~(-V/4294967296),4294967295^(W=~(-V%4294967296))?W=W+1|0:(W=0,te=te+1|0)),V>=18446744073709552e3||V<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");j.realloc(10),function(ee,Q,pe){pe.buf[pe.pos++]=127&ee|128,ee>>>=7,pe.buf[pe.pos++]=127&ee|128,ee>>>=7,pe.buf[pe.pos++]=127&ee|128,ee>>>=7,pe.buf[pe.pos++]=127&ee|128,pe.buf[pe.pos]=127&(ee>>>=7)}(W,0,j),function(ee,Q){var pe=(7&ee)<<4;Q.buf[Q.pos++]|=pe|((ee>>>=3)?128:0),ee&&(Q.buf[Q.pos++]=127&ee|((ee>>>=7)?128:0),ee&&(Q.buf[Q.pos++]=127&ee|((ee>>>=7)?128:0),ee&&(Q.buf[Q.pos++]=127&ee|((ee>>>=7)?128:0),ee&&(Q.buf[Q.pos++]=127&ee|((ee>>>=7)?128:0),ee&&(Q.buf[Q.pos++]=127&ee)))))}(te,j)}(L,this):(this.realloc(4),this.buf[this.pos++]=127&L|(L>127?128:0),L<=127||(this.buf[this.pos++]=127&(L>>>=7)|(L>127?128:0),L<=127||(this.buf[this.pos++]=127&(L>>>=7)|(L>127?128:0),L<=127||(this.buf[this.pos++]=L>>>7&127))))},writeSVarint:function(L){this.writeVarint(L<0?2*-L-1:2*L)},writeBoolean:function(L){this.writeVarint(!!L)},writeString:function(L){L=String(L),this.realloc(4*L.length),this.pos++;var V=this.pos;this.pos=function(W,te,ee){for(var Q,pe,ie=0;ie<te.length;ie++){if((Q=te.charCodeAt(ie))>55295&&Q<57344){if(!pe){Q>56319||ie+1===te.length?(W[ee++]=239,W[ee++]=191,W[ee++]=189):pe=Q;continue}if(Q<56320){W[ee++]=239,W[ee++]=191,W[ee++]=189,pe=Q;continue}Q=pe-55296<<10|Q-56320|65536,pe=null}else pe&&(W[ee++]=239,W[ee++]=191,W[ee++]=189,pe=null);Q<128?W[ee++]=Q:(Q<2048?W[ee++]=Q>>6|192:(Q<65536?W[ee++]=Q>>12|224:(W[ee++]=Q>>18|240,W[ee++]=Q>>12&63|128),W[ee++]=Q>>6&63|128),W[ee++]=63&Q|128)}return ee}(this.buf,L,this.pos);var j=this.pos-V;j>=128&&m(V,j,this),this.pos=V-1,this.writeVarint(j),this.pos+=j},writeFloat:function(L){this.realloc(4),r.write(this.buf,L,this.pos,!0,23,4),this.pos+=4},writeDouble:function(L){this.realloc(8),r.write(this.buf,L,this.pos,!0,52,8),this.pos+=8},writeBytes:function(L){var V=L.length;this.writeVarint(V),this.realloc(V);for(var j=0;j<V;j++)this.buf[this.pos++]=L[j]},writeRawMessage:function(L,V){this.pos++;var j=this.pos;L(V,this);var W=this.pos-j;W>=128&&m(j,W,this),this.pos=j-1,this.writeVarint(W),this.pos+=W},writeMessage:function(L,V,j){this.writeTag(L,e.Bytes),this.writeRawMessage(V,j)},writePackedVarint:function(L,V){V.length&&this.writeMessage(L,y,V)},writePackedSVarint:function(L,V){V.length&&this.writeMessage(L,T,V)},writePackedBoolean:function(L,V){V.length&&this.writeMessage(L,w,V)},writePackedFloat:function(L,V){V.length&&this.writeMessage(L,f,V)},writePackedDouble:function(L,V){V.length&&this.writeMessage(L,x,V)},writePackedFixed32:function(L,V){V.length&&this.writeMessage(L,g,V)},writePackedSFixed32:function(L,V){V.length&&this.writeMessage(L,v,V)},writePackedFixed64:function(L,V){V.length&&this.writeMessage(L,S,V)},writePackedSFixed64:function(L,V){V.length&&this.writeMessage(L,C,V)},writeBytesField:function(L,V){this.writeTag(L,e.Bytes),this.writeBytes(V)},writeFixed32Field:function(L,V){this.writeTag(L,e.Fixed32),this.writeFixed32(V)},writeSFixed32Field:function(L,V){this.writeTag(L,e.Fixed32),this.writeSFixed32(V)},writeFixed64Field:function(L,V){this.writeTag(L,e.Fixed64),this.writeFixed64(V)},writeSFixed64Field:function(L,V){this.writeTag(L,e.Fixed64),this.writeSFixed64(V)},writeVarintField:function(L,V){this.writeTag(L,e.Varint),this.writeVarint(V)},writeSVarintField:function(L,V){this.writeTag(L,e.Varint),this.writeSVarint(V)},writeStringField:function(L,V){this.writeTag(L,e.Bytes),this.writeString(V)},writeFloatField:function(L,V){this.writeTag(L,e.Fixed32),this.writeFloat(V)},writeDoubleField:function(L,V){this.writeTag(L,e.Fixed64),this.writeDouble(V)},writeBooleanField:function(L,V){this.writeVarintField(L,!!V)}},Z_}var bp=_e(s1());const W_=3;function s2(r,e,i){e.glyphs=[],r===1&&i.readMessage(o2,e)}function o2(r,e,i){if(r===3){const{id:o,bitmap:u,width:a,height:h,left:m,top:y,advance:T}=i.readMessage(a2,{});e.glyphs.push({id:o,bitmap:new tl({width:a+2*W_,height:h+2*W_},u),metrics:{width:a,height:h,left:m,top:y,advance:T}})}else r===4?e.ascender=i.readSVarint():r===5&&(e.descender=i.readSVarint())}function a2(r,e,i){r===1?e.id=i.readVarint():r===2?e.bitmap=i.readBytes():r===3?e.width=i.readVarint():r===4?e.height=i.readVarint():r===5?e.left=i.readSVarint():r===6?e.top=i.readSVarint():r===7&&(e.advance=i.readVarint())}const l2=W_,is={horizontal:1,vertical:2,horizontalOnly:3};class zd{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,i){const o=new zd;return o.scale=e||1,o.fontStack=i,o}static forImage(e){const i=new zd;return i.image=e,i}}class Cu{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,i){const o=new Cu;for(let u=0;u<e.sections.length;u++){const a=e.sections[u];a.image?o.addImageSection(a):o.addTextSection(a,i)}return o}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=function(i,o){let u="";for(let a=0;a<i.length;a++){const h=i.charCodeAt(a+1)||null,m=i.charCodeAt(a-1)||null;u+=!o&&(h&&$h(h)&&!Pd[i[a+1]]||m&&$h(m)&&!Pd[i[a-1]])||!Pd[i[a]]?i[a]:Pd[i[a]]}return u}(this.text,e)}trim(){let e=0;for(let o=0;o<this.text.length&&wp[this.text.charCodeAt(o)];o++)e++;let i=this.text.length;for(let o=this.text.length-1;o>=0&&o>=e&&wp[this.text.charCodeAt(o)];o--)i--;this.text=this.text.substring(e,i),this.sectionIndex=this.sectionIndex.slice(e,i)}substring(e,i){const o=new Cu;return o.text=this.text.substring(e,i),o.sectionIndex=this.sectionIndex.slice(e,i),o.sections=this.sections,o}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,i)=>Math.max(e,this.sections[i].scale),0)}addTextSection(e,i){this.text+=e.text,this.sections.push(zd.forText(e.scale,e.fontStack||i));const o=this.sections.length-1;for(let u=0;u<e.text.length;++u)this.sectionIndex.push(o)}addImageSection(e){const i=e.image&&e.image.namePrimary?e.image.getPrimary():null;if(!i)return void ti("Can't add FormattedSection with an empty image.");const o=this.getNextImageSectionCharCode();o?(this.text+=String.fromCodePoint(o),this.sections.push(zd.forImage(i)),this.sectionIndex.push(this.sections.length-1)):ti("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function X_(r,e,i,o,u,a,h,m,y,T,f,x,w,g,v){const S=Cu.fromFeature(r,u);x===is.vertical&&S.verticalizePunctuation(w);let C=[];const z=function(j,W,te,ee,Q,pe){if(!j)return[];const ie=[],me=function(Ae,Re,Ee,$e,Qe,qe){let _t=0;for(let pt=0;pt<Ae.length();pt++){const rt=Ae.getSection(pt);_t+=o1(Ae.getCodePoint(pt),rt,$e,Qe,Re,qe)}return _t/Math.max(1,Math.ceil(_t/Ee))}(j,W,te,ee,Q,pe),xe=j.text.indexOf("​")>=0;let ye=0;for(let Ae=0;Ae<j.length();Ae++){const Re=j.getSection(Ae),Ee=j.getCodePoint(Ae);if(wp[Ee]||(ye+=o1(Ee,Re,ee,Q,W,pe)),Ae<j.length()-1){const $e=!((we=Ee)<11904||!(Dt["Bopomofo Extended"](we)||Dt.Bopomofo(we)||Dt["CJK Compatibility Forms"](we)||Dt["CJK Compatibility Ideographs"](we)||Dt["CJK Compatibility"](we)||Dt["CJK Radicals Supplement"](we)||Dt["CJK Strokes"](we)||Dt["CJK Symbols and Punctuation"](we)||Dt["CJK Unified Ideographs Extension A"](we)||Dt["CJK Unified Ideographs"](we)||Dt["Enclosed CJK Letters and Months"](we)||Dt["Halfwidth and Fullwidth Forms"](we)||Dt.Hiragana(we)||Dt["Ideographic Description Characters"](we)||Dt["Kangxi Radicals"](we)||Dt["Katakana Phonetic Extensions"](we)||Dt.Katakana(we)||Dt["Vertical Forms"](we)||Dt["Yi Radicals"](we)||Dt["Yi Syllables"](we)));(c2[Ee]||$e||Re.image)&&ie.push(l1(Ae+1,ye,me,ie,u2(Ee,j.getCodePoint(Ae+1),$e&&xe),!1))}}var we;return c1(l1(j.length(),ye,me,ie,0,!0))}(S,T,a,e,o,g),{processBidirectionalText:O,processStyledBidirectionalText:B}=Ar;if(O&&S.sections.length===1){const j=O(S.toString(),z);for(const W of j){const te=new Cu;te.text=W,te.sections=S.sections;for(let ee=0;ee<W.length;ee++)te.sectionIndex.push(0);C.push(te)}}else if(B){const j=B(S.text,S.sectionIndex,z);for(const W of j){const te=new Cu;te.text=W[0],te.sectionIndex=W[1],te.sections=S.sections,C.push(te)}}else C=function(j,W){const te=[],ee=j.text;let Q=0;for(const pe of W)te.push(j.substring(Q,pe)),Q=pe;return Q<ee.length&&te.push(j.substring(Q,ee.length)),te}(S,z);const L=[],V={positionedLines:L,text:S.toString(),top:f[1],bottom:f[1],left:f[0],right:f[0],writingMode:x,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(j,W,te,ee,Q,pe,ie,me,xe,ye,we,Ae){let Re=0,Ee=0,$e=0;const Qe=me==="right"?1:me==="left"?0:.5;let qe=!1;for(const yt of Q){const Tt=yt.getSections();for(const Wt of Tt){if(Wt.image)continue;const ei=W[Wt.fontStack];if(ei&&(qe=ei.ascender!==void 0&&ei.descender!==void 0,!qe))break}if(!qe)break}let _t=0;for(const yt of Q){yt.trim();const Tt=yt.getMaxScale(),Wt=(Tt-1)*tr,ei={positionedGlyphs:[],lineOffset:0};j.positionedLines[_t]=ei;const ii=ei.positionedGlyphs;let ni=0;if(!yt.length()){Ee+=pe,++_t;continue}let ci=0,ui=0;for(let Di=0;Di<yt.length();Di++){const Kt=yt.getSection(Di),Pi=yt.getSectionIndex(Di),Ri=yt.getCodePoint(Di);let Hi=Kt.scale,un=null,Tn=null,hn=null,rn=tr,mn=0;const An=!(xe===is.horizontal||!we&&!ou(Ri)||we&&(wp[Ri]||(pt=Ri,Dt.Arabic(pt)||Dt["Arabic Supplement"](pt)||Dt["Arabic Extended-A"](pt)||Dt["Arabic Presentation Forms-A"](pt)||Dt["Arabic Presentation Forms-B"](pt))));if(Kt.image){const ir=ee[Kt.image.serialize()];if(!ir)continue;hn=Kt.image.id,j.iconsInText=j.iconsInText||!0,Tn=ir.paddedRect;const Gi=ir.displaySize;Hi=Hi*tr/Ae,un={width:Gi[0],height:Gi[1],left:0,top:-3,advance:An?Gi[1]:Gi[0],localGlyph:!1},mn=qe?-un.height*Hi:Tt*tr-17-Gi[1]*Hi,rn=un.advance;const Dr=(An?Gi[0]:Gi[1])*Hi-tr*Tt;Dr>0&&Dr>ni&&(ni=Dr)}else{const ir=te[Kt.fontStack];if(!ir)continue;ir[Ri]&&(Tn=ir[Ri]);const Gi=W[Kt.fontStack];if(!Gi)continue;const Dr=Gi.glyphs[Ri];if(!Dr)continue;if(un=Dr.metrics,rn=Ri!==8203?tr:0,qe){const ro=Gi.ascender!==void 0?Math.abs(Gi.ascender):0,Is=Gi.descender!==void 0?Math.abs(Gi.descender):0,As=(ro+Is)*Hi;ci<As&&(ci=As,ui=(ro-Is)/2*Hi),mn=-ro*Hi}else mn=(Tt-Hi)*tr-17}An?(j.verticalizable=!0,ii.push({glyph:Ri,imageName:hn,x:Re,y:Ee+mn,vertical:An,scale:Hi,localGlyph:un.localGlyph,fontStack:Kt.fontStack,sectionIndex:Pi,metrics:un,rect:Tn}),Re+=rn*Hi+ye):(ii.push({glyph:Ri,imageName:hn,x:Re,y:Ee+mn,vertical:An,scale:Hi,localGlyph:un.localGlyph,fontStack:Kt.fontStack,sectionIndex:Pi,metrics:un,rect:Tn}),Re+=un.advance*Hi+ye)}ii.length!==0&&($e=Math.max(Re-ye,$e),qe?u1(ii,Qe,ni,ui,pe*Tt/2):u1(ii,Qe,ni,0,pe/2)),Re=0;const Ni=pe*Tt+ni;ei.lineOffset=Math.max(ni,Wt),Ee+=Ni,++_t}var pt;const rt=Ee,{horizontalAlign:et,verticalAlign:Pt}=Y_(ie);(function(yt,Tt,Wt,ei,ii,ni){const ci=(Tt-Wt)*ii,ui=-ni*ei;for(const Ni of yt)for(const Di of Ni.positionedGlyphs)Di.x+=ci,Di.y+=ui})(j.positionedLines,Qe,et,Pt,$e,rt),j.top+=-Pt*rt,j.bottom=j.top+rt,j.left+=-et*$e,j.right=j.left+$e,j.hasBaseline=qe}(V,e,i,o,C,h,m,y,x,T,w,v),!function(j){for(const W of j)if(W.positionedGlyphs.length!==0)return!1;return!0}(L)&&V}const wp={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},c2={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function o1(r,e,i,o,u,a){if(e.image){const h=o[e.image.serialize()];return h?h.displaySize[0]*e.scale*tr/a+u:0}{const h=i[e.fontStack],m=h&&h.glyphs[r];return m?m.metrics.advance*e.scale+u:0}}function a1(r,e,i,o){const u=Math.pow(r-e,2);return o?r<e?u/2:2*u:u+Math.abs(i)*i}function u2(r,e,i){let o=0;return r===10&&(o-=1e4),i&&(o+=150),r!==40&&r!==65288||(o+=50),e!==41&&e!==65289||(o+=50),o}function l1(r,e,i,o,u,a){let h=null,m=a1(e,i,u,a);for(const y of o){const T=a1(e-y.x,i,u,a)+y.badness;T<=m&&(h=y,m=T)}return{index:r,x:e,priorBreak:h,badness:m}}function c1(r){return r?c1(r.priorBreak).concat(r.index):[]}function Y_(r){let e=.5,i=.5;switch(r){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(r){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0}return{horizontalAlign:e,verticalAlign:i}}function u1(r,e,i,o,u){if(!(e||i||o||u))return;const a=r.length-1,h=r[a],m=(h.x+h.metrics.advance*h.scale)*e;for(let y=0;y<=a;y++)r[y].x-=m,r[y].y+=i+o+u}function h2(r,e,i,o){const{horizontalAlign:u,verticalAlign:a}=Y_(o),h=i[0]-r.displaySize[0]*u,m=i[1]-r.displaySize[1]*a;return{imagePrimary:r,imageSecondary:e,top:m,bottom:m+r.displaySize[1],left:h,right:h+r.displaySize[0]}}function h1(r,e,i,o,u,a){const h=r.imagePrimary;let m;if(h.content){const C=h.content,z=h.pixelRatio||1;m=[C[0]/z,C[1]/z,h.displaySize[0]-C[2]/z,h.displaySize[1]-C[3]/z]}const y=e.left*a,T=e.right*a;let f,x,w,g;i==="width"||i==="both"?(g=u[0]+y-o[3],x=u[0]+T+o[1]):(g=u[0]+(y+T-h.displaySize[0])/2,x=g+h.displaySize[0]);const v=e.top*a,S=e.bottom*a;return i==="height"||i==="both"?(f=u[1]+v-o[0],w=u[1]+S+o[2]):(f=u[1]+(v+S-h.displaySize[1])/2,w=f+h.displaySize[1]),{imagePrimary:h,imageSecondary:void 0,top:f,right:x,bottom:w,left:g,collisionPadding:m}}class ca extends ft{constructor(e,i,o,u,a){super(e,i),this.angle=u,this.z=o,a!==void 0&&(this.segment=a)}clone(){return new ca(this.x,this.y,this.z,this.angle,this.segment)}}function d1(r,e,i,o,u){if(e.segment===void 0)return!0;let a=e,h=e.segment+1,m=0;for(;m>-i/2;){if(h--,h<0)return!1;m-=r[h].dist(a),a=r[h]}m+=r[h].dist(r[h+1]),h++;const y=[];let T=0;for(;m<i/2;){const f=r[h],x=r[h+1];if(!x)return!1;let w=r[h-1].angleTo(f)-f.angleTo(x);for(w=Math.abs((w+3*Math.PI)%(2*Math.PI)-Math.PI),y.push({distance:m,angleDelta:w}),T+=w;m-y[0].distance>o;)T-=y.shift().angleDelta;if(T>u)return!1;h++,m+=f.dist(x)}return!0}function f1(r){let e=0;for(let i=0;i<r.length-1;i++)e+=r[i].dist(r[i+1]);return e}function p1(r,e,i){return r?.6*e*i:0}function m1(r,e){return Math.max(r?r.right-r.left:0,e?e.right-e.left:0)}function d2(r,e,i,o,u,a){const h=p1(i,u,a),m=m1(i,o)*a;let y=0;const T=f1(r)/2;for(let f=0;f<r.length-1;f++){const x=r[f],w=r[f+1],g=x.dist(w);if(y+g>T){const v=(T-y)/g,S=Gt(x.x,w.x,v),C=Gt(x.y,w.y,v),z=new ca(S,C,0,w.angleTo(x),f);return!h||d1(r,z,m,h,e)?z:void 0}y+=g}}function f2(r,e,i,o,u,a,h,m,y){const T=p1(o,a,h),f=m1(o,u),x=f*h,w=r[0].x===0||r[0].x===y||r[0].y===0||r[0].y===y;return e-x<e/4&&(e=x+e/4),_1(r,w?e/2*m%e:(f/2+2*a)*h*m%e,e,T,i,x,w,!1,y)}function _1(r,e,i,o,u,a,h,m,y){const T=a/2,f=f1(r);let x=0,w=e-i,g=[];for(let v=0;v<r.length-1;v++){const S=r[v],C=r[v+1],z=S.dist(C),O=C.angleTo(S);for(;w+i<x+z;){w+=i;const B=(w-x)/z,L=Gt(S.x,C.x,B),V=Gt(S.y,C.y,B);if(L>=0&&L<y&&V>=0&&V<y&&w-T>=0&&w+T<=f){const j=new ca(L,V,0,O,v);o&&!d1(r,j,a,o,u)||g.push(j)}}x+=z}return m||g.length||h||(g=_1(r,x/2,i,o,u,a,h,!0,y)),g}function g1(r,e,i,o,u){const a=[];for(let h=0;h<r.length;h++){const m=r[h];let y;for(let T=0;T<m.length-1;T++){let f=m[T],x=m[T+1];f.x<e&&x.x<e||(f.x<e?f=new ft(e,f.y+(e-f.x)/(x.x-f.x)*(x.y-f.y))._round():x.x<e&&(x=new ft(e,f.y+(e-f.x)/(x.x-f.x)*(x.y-f.y))._round()),f.y<i&&x.y<i||(f.y<i?f=new ft(f.x+(i-f.y)/(x.y-f.y)*(x.x-f.x),i)._round():x.y<i&&(x=new ft(f.x+(i-f.y)/(x.y-f.y)*(x.x-f.x),i)._round()),f.x>=o&&x.x>=o||(f.x>=o?f=new ft(o,f.y+(o-f.x)/(x.x-f.x)*(x.y-f.y))._round():x.x>=o&&(x=new ft(o,f.y+(o-f.x)/(x.x-f.x)*(x.y-f.y))._round()),f.y>=u&&x.y>=u||(f.y>=u?f=new ft(f.x+(u-f.y)/(x.y-f.y)*(x.x-f.x),u)._round():x.y>=u&&(x=new ft(f.x+(u-f.y)/(x.y-f.y)*(x.x-f.x),u)._round()),y&&f.equals(y[y.length-1])||(y=[f],a.push(y)),y.push(x)))))}}return a}function y1(r){let e=0,i=0;for(const h of r)e+=h.w*h.h,i=Math.max(i,h.w);r.sort((h,m)=>m.h-h.h);const o=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),i),h:1/0}];let u=0,a=0;for(const h of r)for(let m=o.length-1;m>=0;m--){const y=o[m];if(!(h.w>y.w||h.h>y.h)){if(h.x=y.x,h.y=y.y,a=Math.max(a,h.y+h.h),u=Math.max(u,h.x+h.w),h.w===y.w&&h.h===y.h){const T=o.pop();m<o.length&&(o[m]=T)}else h.h===y.h?(y.x+=h.w,y.w-=h.w):h.w===y.w?(y.y+=h.h,y.h-=h.h):(o.push({x:y.x+h.w,y:y.y,w:y.w-h.w,h:h.h}),y.y+=h.h,y.h-=h.h);break}}return{w:u,h:a,fill:e/(u*a)||0}}Mt(ca,"Anchor");const Rd=1;class Dd{static getImagePositionScale(e,i,o){return i&&e&&e.options&&e.options.transform?{x:e.options.transform.a,y:e.options.transform.d}:{x:o,y:o}}constructor(e,{pixelRatio:i,version:o,stretchX:u,stretchY:a,content:h,sdf:m,usvg:y},T,f){this.paddedRect=e,this.pixelRatio=i,this.stretchX=u,this.stretchY=a,this.content=h,this.version=o,this.padding=T,this.sdf=m,this.scale=Dd.getImagePositionScale(f,y,i)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}class x1{constructor(e,i,o){const u={},a={};this.haveRenderCallbacks=[];const h=[];this.addImages(e,u,Rd,h),this.addImages(i,a,2,h);const{w:m,h:y}=y1(h),T=new Wn({width:m||1,height:y||1});for(const f in e){const x=e[f],w=u[f].paddedRect;Wn.copy(x.data,T,{x:0,y:0},{x:w.x+Rd,y:w.y+Rd},x.data,o,x.sdf)}for(const f in i){const x=i[f],w=a[f].paddedRect;let g=a[f].padding;const v=w.x+g,S=w.y+g,C=x.data.width,z=x.data.height;g=g>1?g-1:g,Wn.copy(x.data,T,{x:0,y:0},{x:v,y:S},x.data,o),Wn.copy(x.data,T,{x:0,y:z-g},{x:v,y:S-g},{width:C,height:g},o),Wn.copy(x.data,T,{x:0,y:0},{x:v,y:S+z},{width:C,height:g},o),Wn.copy(x.data,T,{x:C-g,y:0},{x:v-g,y:S},{width:g,height:z},o),Wn.copy(x.data,T,{x:0,y:0},{x:v+C,y:S},{width:g,height:z},o),Wn.copy(x.data,T,{x:C-g,y:z-g},{x:v-g,y:S-g},{width:g,height:g},o),Wn.copy(x.data,T,{x:0,y:z-g},{x:v+C,y:S-g},{width:g,height:g},o),Wn.copy(x.data,T,{x:0,y:0},{x:v+C,y:S+z},{width:g,height:g},o),Wn.copy(x.data,T,{x:C-g,y:0},{x:v-g,y:S+z},{width:g,height:g},o)}this.lut=o,this.image=T,this.iconPositions=u,this.patternPositions=a}addImages(e,i,o,u){for(const a in e){const h=e[a],m={x:0,y:0,w:h.data.width+2*o,h:h.data.height+2*o};u.push(m);const y=gs.deserializeFromString(a);i[a]=new Dd(m,h,o,y),h.hasRenderCallback&&this.haveRenderCallbacks.push(y.id)}}patchUpdatedImages(e,i,o){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(u=>e.hasImage(u,o)),e.dispatchRenderCallbacks(this.haveRenderCallbacks,o);for(const u in e.getUpdatedImages(o)){for(const a of Object.keys(this.iconPositions))gs.deserializeId(a)===u&&this.patchUpdatedImage(this.iconPositions[a],e.getImage(u,o),i);for(const a of Object.keys(this.patternPositions))gs.deserializeId(a)===u&&this.patchUpdatedImage(this.patternPositions[a],e.getImage(u,o),i)}}patchUpdatedImage(e,i,o){if(!e||!i||e.version===i.version)return;e.version=i.version;const[u,a]=e.tl,h=e.sdf;if(this.lut||h){const m={width:i.data.width,height:i.data.height},y=new Wn(m);Wn.copy(i.data,y,{x:0,y:0},{x:0,y:0},m,this.lut,h),o.update(y,{position:{x:u,y:a}})}else o.update(i.data,{position:{x:u,y:a}})}}Mt(Dd,"ImagePosition"),Mt(x1,"ImageAtlas");const Tp=1e20;function v1(r,e,i,o,u,a,h,m,y){for(let T=e;T<e+o;T++)b1(r,i*a+T,a,u,h,m,y);for(let T=i;T<i+u;T++)b1(r,T*a+e,1,o,h,m,y)}function b1(r,e,i,o,u,a,h){a[0]=0,h[0]=-1e20,h[1]=Tp,u[0]=r[e];for(let m=1,y=0,T=0;m<o;m++){u[m]=r[e+m*i];const f=m*m;do{const x=a[y];T=(u[m]-u[x]+f-x*x)/(m-x)/2}while(T<=h[y]&&--y>-1);y++,a[y]=m,h[y]=T,h[y+1]=Tp}for(let m=0,y=0;m<o;m++){for(;h[y+1]<m;)y++;const T=a[y],f=m-T;r[e+m*i]=u[T]+f*f}}const eo=2,K_={none:0,ideographs:1,all:2};class Pu{constructor(e,i,o){this.requestManager=e,this.localGlyphMode=i,this.localFontFamily=o,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e,i){this.urls[i]=e}getGlyphs(e,i,o){const u=[],a=this.urls[i]||Mn.GLYPHS_URL;for(const h in e)for(const m of e[h])u.push({stack:h,id:m});lo(u,({stack:h,id:m},y)=>{let T=this.entries[h];T||(T=this.entries[h]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let f=T.glyphs[m];if(f!==void 0)return void y(null,{stack:h,id:m,glyph:f});if(f=this._tinySDF(T,h,m),f)return T.glyphs[m]=f,void y(null,{stack:h,id:m,glyph:f});const x=Math.floor(m/256);if(256*x>65535)return ti("glyphs > 65535 not supported"),void y(null,{stack:h,id:m,glyph:f});if(T.ranges[x])return void y(null,{stack:h,id:m,glyph:f});let w=T.requests[x];w||(w=T.requests[x]=[],Pu.loadGlyphRange(h,x,a,this.requestManager,(g,v)=>{if(v){T.ascender=v.ascender,T.descender=v.descender;for(const S in v.glyphs)this._doesCharSupportLocalGlyph(+S)||(T.glyphs[+S]=v.glyphs[+S]);T.ranges[x]=!0}for(const S of w)S(g,v);delete T.requests[x]})),w.push((g,v)=>{g?y(g):v&&y(null,{stack:h,id:m,glyph:v.glyphs[m]||null})})},(h,m)=>{if(h)o(h);else if(m){const y={};for(const{stack:T,id:f,glyph:x}of m)y[T]===void 0&&(y[T]={}),y[T].glyphs===void 0&&(y[T].glyphs={}),y[T].glyphs[f]=x&&{id:x.id,bitmap:x.bitmap.clone(),metrics:x.metrics},y[T].ascender=this.entries[T].ascender,y[T].descender=this.entries[T].descender;o(null,y)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==K_.none&&(this.localGlyphMode===K_.all?!!this.localFontFamily:!!this.localFontFamily&&(Dt["CJK Unified Ideographs"](e)||Dt["Hangul Syllables"](e)||Dt.Hiragana(e)||Dt.Katakana(e)||Dt["CJK Symbols and Punctuation"](e)||Dt["CJK Unified Ideographs Extension A"](e)||Dt["CJK Unified Ideographs Extension B"](e)||Dt.Osage(e)))}_tinySDF(e,i,o){const u=this.localFontFamily;if(!u||!this._doesCharSupportLocalGlyph(o))return;let a=e.tinySDF;if(!a){let S="400";/bold/i.test(i)?S="900":/medium/i.test(i)?S="500":/light/i.test(i)&&(S="200"),a=e.tinySDF=new Pu.TinySDF({fontFamily:u,fontWeight:S,fontSize:24*eo,buffer:3*eo,radius:8*eo}),a.fontWeight=S}if(this.localGlyphs[a.fontWeight][o])return this.localGlyphs[a.fontWeight][o];const h=String.fromCodePoint(o),{data:m,width:y,height:T,glyphWidth:f,glyphHeight:x,glyphLeft:w,glyphTop:g,glyphAdvance:v}=a.draw(h);return this.localGlyphs[a.fontWeight][o]={id:o,bitmap:new tl({width:y,height:T},m),metrics:{width:f/eo,height:x/eo,left:w/eo,top:g/eo-27,advance:v/eo,localGlyph:!0}}}}Pu.loadGlyphRange=function(r,e,i,o,u){const a=256*e,h=a+255,m=o.transformRequest(o.normalizeGlyphsURL(i).replace("{fontstack}",r).replace("{range}",`${a}-${h}`),Si.Glyphs);Cn(m,(y,T)=>{if(y)u(y);else if(T){const f={},x=function(w){return new bp(w).readFields(s2,{})}(T);for(const w of x.glyphs)f[w.id]=w;u(null,{glyphs:f,ascender:x.ascender,descender:x.descender})}})},Pu.TinySDF=class{constructor({fontSize:r=24,buffer:e=3,radius:i=8,cutoff:o=.25,fontFamily:u="sans-serif",fontWeight:a="normal",fontStyle:h="normal"}={}){this.buffer=e,this.cutoff=o,this.radius=i;const m=this.size=r+4*e,y=this._createCanvas(m),T=this.ctx=y.getContext("2d",{willReadFrequently:!0});T.font=`${h} ${a} ${r}px ${u}`,T.textBaseline="alphabetic",T.textAlign="left",T.fillStyle="black",this.gridOuter=new Float64Array(m*m),this.gridInner=new Float64Array(m*m),this.f=new Float64Array(m),this.z=new Float64Array(m+1),this.v=new Uint16Array(m)}_createCanvas(r){const e=document.createElement("canvas");return e.width=e.height=r,e}draw(r){const{width:e,actualBoundingBoxAscent:i,actualBoundingBoxDescent:o,actualBoundingBoxLeft:u,actualBoundingBoxRight:a}=this.ctx.measureText(r),h=Math.ceil(i),m=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(a-u))),y=Math.min(this.size-this.buffer,h+Math.ceil(o)),T=m+2*this.buffer,f=y+2*this.buffer,x=Math.max(T*f,0),w=new Uint8ClampedArray(x),g={data:w,width:T,height:f,glyphWidth:m,glyphHeight:y,glyphTop:h,glyphLeft:0,glyphAdvance:e};if(m===0||y===0)return g;const{ctx:v,buffer:S,gridInner:C,gridOuter:z}=this;v.clearRect(S,S,m,y),v.fillText(r,S,S+h);const O=v.getImageData(S,S,m,y);z.fill(Tp,0,x),C.fill(0,0,x);for(let B=0;B<y;B++)for(let L=0;L<m;L++){const V=O.data[4*(B*m+L)+3]/255;if(V===0)continue;const j=(B+S)*T+L+S;if(V===1)z[j]=0,C[j]=Tp;else{const W=.5-V;z[j]=W>0?W*W:0,C[j]=W<0?W*W:0}}v1(z,0,0,T,f,T,this.f,this.v,this.z),v1(C,S,S,m,y,T,this.f,this.v,this.z);for(let B=0;B<x;B++){const L=Math.sqrt(z[B])-Math.sqrt(C[B]);w[B]=Math.round(255-255*(L/this.radius+this.cutoff))}return g}};const lc=Rd;function w1(r,e){return r+e[1]-e[0]}function T1(r,e,i,o,u=1){const a=[],h=r.imagePrimary,m=h.pixelRatio,y=h.paddedRect.w-2*lc,T=h.paddedRect.h-2*lc,f=(r.right-r.left)*u,x=(r.bottom-r.top)*u,w=h.stretchX||[[0,y]],g=h.stretchY||[[0,T]],v=w.reduce(w1,0),S=g.reduce(w1,0),C=y-v,z=T-S;let O=0,B=v,L=0,V=S,j=0,W=C,te=0,ee=z;if(h.content&&o){const pe=h.content;O=Sp(w,0,pe[0]),L=Sp(g,0,pe[1]),B=Sp(w,pe[0],pe[2]),V=Sp(g,pe[1],pe[3]),j=pe[0]-O,te=pe[1]-L,W=pe[2]-pe[0]-B,ee=pe[3]-pe[1]-V}const Q=(pe,ie,me,xe)=>{const ye=Ep(pe.stretch-O,B,f,r.left*u),we=Mp(pe.fixed-j,W,pe.stretch,v),Ae=Ep(ie.stretch-L,V,x,r.top*u),Re=Mp(ie.fixed-te,ee,ie.stretch,S),Ee=Ep(me.stretch-O,B,f,r.left*u),$e=Mp(me.fixed-j,W,me.stretch,v),Qe=Ep(xe.stretch-L,V,x,r.top*u),qe=Mp(xe.fixed-te,ee,xe.stretch,S),_t=new ft(ye,Ae),pt=new ft(Ee,Ae),rt=new ft(Ee,Qe),et=new ft(ye,Qe),Pt=new ft(we/m,Re/m),yt=new ft($e/m,qe/m),Tt=e*Math.PI/180;if(Tt){const ui=Math.sin(Tt),Ni=Math.cos(Tt),Di=[Ni,-ui,ui,Ni];_t._matMult(Di),pt._matMult(Di),et._matMult(Di),rt._matMult(Di)}const Wt=pe.stretch+pe.fixed,ei=me.stretch+me.fixed,ii=ie.stretch+ie.fixed,ni=xe.stretch+xe.fixed,ci=r.imageSecondary;return{tl:_t,tr:pt,bl:et,br:rt,texPrimary:{x:h.paddedRect.x+lc+Wt,y:h.paddedRect.y+lc+ii,w:ei-Wt,h:ni-ii},texSecondary:ci?{x:ci.paddedRect.x+lc+Wt,y:ci.paddedRect.y+lc+ii,w:ei-Wt,h:ni-ii}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Pt,pixelOffsetBR:yt,minFontScaleX:W/m/f,minFontScaleY:ee/m/x,isSDF:i}};if(o&&(h.stretchX||h.stretchY)){const pe=S1(w,C,v),ie=S1(g,z,S);for(let me=0;me<pe.length-1;me++){const xe=pe[me],ye=pe[me+1];for(let we=0;we<ie.length-1;we++)a.push(Q(xe,ie[we],ye,ie[we+1]))}}else a.push(Q({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:y+1},{fixed:0,stretch:T+1}));return a}function Sp(r,e,i){let o=0;for(const u of r)o+=Math.max(e,Math.min(i,u[1]))-Math.max(e,Math.min(i,u[0]));return o}function S1(r,e,i){const o=[{fixed:-1,stretch:0}];for(const[u,a]of r){const h=o[o.length-1];o.push({fixed:u-h.stretch,stretch:h.stretch}),o.push({fixed:u-h.stretch,stretch:h.stretch+(a-u)})}return o.push({fixed:e+lc,stretch:i}),o}function Ep(r,e,i,o){return r/e*i+o}function Mp(r,e,i,o){return r-e*i/o}function p2(r,e,i,o){const u=e+r.positionedLines[o].lineOffset;return o===0?i+u/2:i+(u+(e+r.positionedLines[o-1].lineOffset))/2}function m2(r,e=1,i=!1){let o=1/0,u=1/0,a=-1/0,h=-1/0;const m=r[0];for(let g=0;g<m.length;g++){const v=m[g];(!g||v.x<o)&&(o=v.x),(!g||v.y<u)&&(u=v.y),(!g||v.x>a)&&(a=v.x),(!g||v.y>h)&&(h=v.y)}const y=Math.min(a-o,h-u);let T=y/2;const f=new Hn([],_2);if(y===0)return new ft(o,u);for(let g=o;g<a;g+=y)for(let v=u;v<h;v+=y)f.push(new zu(g+T,v+T,T,r));let x=function(g){let v=0,S=0,C=0;const z=g[0];for(let O=0,B=z.length,L=B-1;O<B;L=O++){const V=z[O],j=z[L],W=V.x*j.y-j.x*V.y;S+=(V.x+j.x)*W,C+=(V.y+j.y)*W,v+=3*W}return new zu(S/v,C/v,0,g)}(r),w=f.length;for(;f.length;){const g=f.pop();(g.d>x.d||!x.d)&&(x=g,i&&console.log("found best %d after %d probes",Math.round(1e4*g.d)/1e4,w)),g.max-x.d<=e||(T=g.h/2,f.push(new zu(g.p.x-T,g.p.y-T,T,r)),f.push(new zu(g.p.x+T,g.p.y-T,T,r)),f.push(new zu(g.p.x-T,g.p.y+T,T,r)),f.push(new zu(g.p.x+T,g.p.y+T,T,r)),w+=4)}return i&&(console.log(`num probes: ${w}`),console.log(`best distance: ${x.d}`)),x.p}function _2(r,e){return e.max-r.max}class zu{constructor(e,i,o,u){this.p=new ft(e,i),this.h=o,this.d=function(a,h){let m=!1,y=1/0;for(let T=0;T<h.length;T++){const f=h[T];for(let x=0,w=f.length,g=w-1;x<w;g=x++){const v=f[x],S=f[g];v.y>a.y!=S.y>a.y&&a.x<(S.x-v.x)*(a.y-v.y)/(S.y-v.y)+v.x&&(m=!m),y=Math.min(y,le(a,v,S))}}return(m?1:-1)*Math.sqrt(y)}(this.p,u),this.max=this.d+this.h*Math.SQRT2}}const J_=Number.POSITIVE_INFINITY,g2=Math.sqrt(2);function E1(r,[e,i]){let o=0,u=0;if(i===J_){e<0&&(e=0);const a=e/g2;switch(r){case"top-right":case"top-left":u=a-7;break;case"bottom-right":case"bottom-left":u=7-a;break;case"bottom":u=7-e;break;case"top":u=e-7}switch(r){case"top-right":case"bottom-right":o=-a;break;case"top-left":case"bottom-left":o=a;break;case"left":o=e;break;case"right":o=-e}}else{switch(e=Math.abs(e),i=Math.abs(i),r){case"top-right":case"top-left":case"top":u=i-7;break;case"bottom-right":case"bottom-left":case"bottom":u=7-i}switch(r){case"top-right":case"bottom-right":case"right":o=-e;break;case"top-left":case"bottom-left":case"left":o=e}}return[o,u]}function Q_(r){switch(r){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function y2(r,e,i,o,u,a,h,m,y,T,f,x,w,g,v){let S=a.textMaxSize.evaluate(e,{},x);S===void 0?S=h*a.textScaleFactor:S*=a.textScaleFactor;const C=r.layers[0].layout,z=C.get("icon-offset").evaluate(e,{},x),O=I1(i.horizontal)||i.vertical,B=w.name==="globe",L=tr,V=h*a.textScaleFactor/L,j=r.tilePixelRatio*S/L,W=(ye=r.overscaling,r.zoom>18&&ye>2&&(ye>>=1),Math.max(mt/(512*ye),1)*C.get("symbol-spacing")),te=C.get("text-padding")*r.tilePixelRatio,ee=C.get("icon-padding")*r.tilePixelRatio,Q=pi(C.get("text-max-angle")),pe=C.get("text-rotation-alignment")==="map"&&C.get("symbol-placement")!=="point",ie=C.get("icon-rotation-alignment")==="map"&&C.get("symbol-placement")!=="point",me=C.get("symbol-placement"),xe=W/2;var ye;const we=C.get("icon-text-fit").evaluate(e,{},x),Ae=C.get("icon-text-fit-padding").evaluate(e,{},x),Re=we!=="none";let Ee;r.hasAnyIconTextFit===!1&&Re&&(r.hasAnyIconTextFit=!0),o&&Re&&(r.allowVerticalPlacement&&i.vertical&&(Ee=h1(o,i.vertical,we,Ae,z,V)),O&&(o=h1(o,O,we,Ae,z,V)));const $e=(Qe,qe,_t)=>{if(qe.x<0||qe.x>=mt||qe.y<0||qe.y>=mt)return;let pt=null;if(B){const{x:rt,y:et,z:Pt}=w.projectTilePoint(qe.x,qe.y,_t);pt={anchor:new ca(rt,et,Pt,0,void 0),up:w.upVector(_t,qe.x,qe.y)}}(function(rt,et,Pt,yt,Tt,Wt,ei,ii,ni,ci,ui,Ni,Di,Kt,Pi,Ri,Hi,un,Tn,hn,rn,mn,An,ir,Gi,Dr,ro){const Is=rt.addToLineVertexArray(et,yt);let As,fc,al,pc,Jd,av,lv,cv=0,uv=0,hv=0,dv=0,Lg=-1,kg=-1;const Eo={};let fv=Kr("");const mc=Pt?Pt.anchor:et,Og=ni.layout.get("icon-text-fit").evaluate(rn,{},Gi)!=="none";let Fg=0,Bg=0;if(ni._unevaluatedLayout.getValue("text-radial-offset")===void 0?[Fg,Bg]=ni.layout.get("text-offset").evaluate(rn,{},Gi).map(rs=>rs*tr):(Fg=ni.layout.get("text-radial-offset").evaluate(rn,{},Gi)*tr,Bg=J_),rt.allowVerticalPlacement&&Tt.vertical){const rs=Tt.vertical;if(Pi)av=eg(rs),ii&&(lv=eg(ii));else{const Lr=ni.layout.get("text-rotate").evaluate(rn,{},Gi)+90;al=Ip(ci,mc,et,ui,Ni,Di,rs,Kt,Lr,Ri),ii&&(pc=Ip(ci,mc,et,ui,Ni,Di,ii,un,Lr))}}if(Wt){const rs=rt.iconSizeData,Lr=ni.layout.get("icon-rotate").evaluate(rn,{},Gi),Qd=T1(Wt,Lr,An,Og,mn.iconScaleFactor),Vg=ii?T1(ii,Lr,An,Og,mn.iconScaleFactor):void 0;fc=Ip(ci,mc,et,ui,Ni,Di,Wt,un,Lr,null),cv=4*Qd.length;let _c=null;rs.kind==="source"?(_c=[Qs*ni.layout.get("icon-size").evaluate(rn,{},Gi)*mn.iconScaleFactor],_c[0]>nl&&ti(`${rt.layerIds[0]}: Value for "icon-size" is >= ${Ld}. Reduce your "icon-size".`)):rs.kind==="composite"&&(_c=[Qs*mn.compositeIconSizes[0].evaluate(rn,{},Gi)*mn.iconScaleFactor,Qs*mn.compositeIconSizes[1].evaluate(rn,{},Gi)*mn.iconScaleFactor],(_c[0]>nl||_c[1]>nl)&&ti(`${rt.layerIds[0]}: Value for "icon-size" is >= ${Ld}. Reduce your "icon-size".`)),rt.addSymbols(rt.icon,Qd,_c,hn,Tn,rn,!1,Pt,et,Is.lineStartIndex,Is.lineLength,-1,ir,Gi,Dr,ro),Lg=rt.icon.placedSymbolArray.length-1,Vg&&(uv=4*Vg.length,rt.addSymbols(rt.icon,Vg,_c,hn,Tn,rn,is.vertical,Pt,et,Is.lineStartIndex,Is.lineLength,-1,ir,Gi,Dr,ro),kg=rt.icon.placedSymbolArray.length-1)}for(const rs in Tt.horizontal){const Lr=Tt.horizontal[rs];As||(fv=Kr(Lr.text),Pi?Jd=eg(Lr):As=Ip(ci,mc,et,ui,Ni,Di,Lr,Kt,ni.layout.get("text-rotate").evaluate(rn,{},Gi),Ri));const Qd=Lr.positionedLines.length===1;if(hv+=M1(rt,Pt,et,Lr,ei,ni,Pi,rn,Ri,Is,Tt.vertical?is.horizontal:is.horizontalOnly,Qd?Object.keys(Tt.horizontal):[rs],Eo,Lg,mn,ir,Gi,Dr),Qd)break}Tt.vertical&&(dv+=M1(rt,Pt,et,Tt.vertical,ei,ni,Pi,rn,Ri,Is,is.vertical,["vertical"],Eo,kg,mn,ir,Gi,Dr));let ll=-1;const Ng=(rs,Lr)=>rs?Math.max(rs,Lr):Lr;ll=Ng(Jd,ll),ll=Ng(av,ll),ll=Ng(lv,ll);const K3=ll>-1?1:0;rt.glyphOffsetArray.length>=65535&&ti("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),rn.sortKey!==void 0&&rt.addToSortKeyRanges(rt.symbolInstances.length,rn.sortKey),rt.symbolInstances.emplaceBack(et.x,et.y,mc.x,mc.y,mc.z,Eo.right>=0?Eo.right:-1,Eo.center>=0?Eo.center:-1,Eo.left>=0?Eo.left:-1,Eo.vertical>=0?Eo.vertical:-1,Lg,kg,fv,As!==void 0?As:rt.collisionBoxArray.length,As!==void 0?As+1:rt.collisionBoxArray.length,al!==void 0?al:rt.collisionBoxArray.length,al!==void 0?al+1:rt.collisionBoxArray.length,fc!==void 0?fc:rt.collisionBoxArray.length,fc!==void 0?fc+1:rt.collisionBoxArray.length,pc||rt.collisionBoxArray.length,pc?pc+1:rt.collisionBoxArray.length,ui,hv,dv,cv,uv,K3,0,Fg,Bg,ll,0,Og?1:0)})(r,qe,pt,Qe,i,o,u,Ee,r.layers[0],r.collisionBoxArray,e.index,e.sourceLayerIndex,r.index,te,pe,y,0,ee,ie,z,e,a,T,f,x,g,v)};if(me==="line")for(const Qe of g1(e.geometry,0,0,mt,mt)){const qe=f2(Qe,W,Q,i.vertical||O,o,L,j,r.overscaling,mt);for(const _t of qe)O&&x2(r,O.text,xe,_t)||$e(Qe,_t,x)}else if(me==="line-center"){for(const Qe of e.geometry)if(Qe.length>1){const qe=d2(Qe,Q,i.vertical||O,o,L,j);qe&&$e(Qe,qe,x)}}else if(e.type==="Polygon")for(const Qe of fp(e.geometry,0)){const qe=m2(Qe,16);$e(Qe[0],new ca(qe.x,qe.y,0,0,void 0),x)}else if(e.type==="LineString")for(const Qe of e.geometry)$e(Qe,new ca(Qe[0].x,Qe[0].y,0,0,void 0),x);else if(e.type==="Point")for(const Qe of e.geometry)for(const qe of Qe)$e([qe],new ca(qe.x,qe.y,0,0,void 0),x)}const Ld=255,nl=Ld*Qs;function M1(r,e,i,o,u,a,h,m,y,T,f,x,w,g,v,S,C,z){const O=function(V,j,W,te,ee,Q,pe,ie){const me=[];if(j.positionedLines.length===0)return me;const xe=te.layout.get("text-rotate").evaluate(Q,{})*Math.PI/180,ye=function($e){const Qe=$e[0],qe=$e[1],_t=Qe*qe;return _t>0?[Qe,-qe]:_t<0?[-Qe,qe]:Qe===0?[qe,Qe]:[qe,-Qe]}(W);let we=Math.abs(j.top-j.bottom);for(const $e of j.positionedLines)we-=$e.lineOffset;const Ae=j.positionedLines.length,Re=we/Ae;let Ee=j.top-W[1];for(let $e=0;$e<Ae;++$e){const Qe=j.positionedLines[$e];Ee=p2(j,Re,Ee,$e);for(const qe of Qe.positionedGlyphs){if(!qe.rect)continue;const _t=qe.rect||{};let pt=l2+1,rt=!0,et=1,Pt=0;if(qe.imageName){const hn=pe[Zn.build(qe.imageName).getSerializedPrimary()];if(!hn)continue;if(hn.sdf){ti("SDF images are not supported in formatted text and will be ignored.");continue}rt=!1,et=hn.pixelRatio,pt=Rd/et}const yt=(ee||ie)&&qe.vertical,Tt=qe.metrics.advance*qe.scale/2,Wt=qe.metrics,ei=qe.rect;if(ei===null)continue;ie&&j.verticalizable&&(Pt=qe.imageName?Tt-qe.metrics.width*qe.scale/2:0);const ii=ee?[qe.x+Tt,qe.y]:[0,0];let ni=[0,0],ci=[0,0],ui=!1;ee||(yt?(ci=[qe.x+Tt+ye[0],qe.y+ye[1]-Pt],ui=!0):ni=[qe.x+Tt+W[0],qe.y+W[1]-Pt]);const Ni=ei.w*qe.scale/(et*(qe.localGlyph?eo:1)),Di=ei.h*qe.scale/(et*(qe.localGlyph?eo:1));let Kt,Pi,Ri,Hi;if(yt){const hn=qe.y-Ee,rn=new ft(-Tt,Tt-hn),mn=-Math.PI/2,An=new ft(...ci);Kt=new ft(-Tt+ni[0],ni[1]),Kt._rotateAround(mn,rn)._add(An),Kt.x+=-hn+Tt,Kt.y-=(Wt.left-pt)*qe.scale;const ir=qe.imageName?Wt.advance*qe.scale:tr*qe.scale,Gi=String.fromCodePoint(qe.glyph);i2(Gi)?Kt.x+=(1-pt)*qe.scale:n2(Gi)?Kt.x+=ir-Wt.height*qe.scale+(-pt-1)*qe.scale:Kt.x+=qe.imageName||Wt.width+2*pt===ei.w&&Wt.height+2*pt===ei.h?(ir-Di)/2:(ir-(Wt.height+2*pt)*qe.scale)/2,Pi=new ft(Kt.x,Kt.y-Ni),Ri=new ft(Kt.x+Di,Kt.y),Hi=new ft(Kt.x+Di,Kt.y-Ni)}else{const hn=(Wt.left-pt)*qe.scale-Tt+ni[0],rn=(-Wt.top-pt)*qe.scale+ni[1],mn=hn+Ni,An=rn+Di;Kt=new ft(hn,rn),Pi=new ft(mn,rn),Ri=new ft(hn,An),Hi=new ft(mn,An)}if(xe){let hn;hn=ee?new ft(0,0):ui?new ft(ye[0],ye[1]):new ft(W[0],W[1]),Kt._rotateAround(xe,hn),Pi._rotateAround(xe,hn),Ri._rotateAround(xe,hn),Hi._rotateAround(xe,hn)}const un=new ft(0,0),Tn=new ft(0,0);me.push({tl:Kt,tr:Pi,bl:Ri,br:Hi,texPrimary:_t,texSecondary:void 0,writingMode:j.writingMode,glyphOffset:ii,sectionIndex:qe.sectionIndex,isSDF:rt,pixelOffsetTL:un,pixelOffsetBR:Tn,minFontScaleX:0,minFontScaleY:0})}}return me}(0,o,y,a,h,m,u,r.allowVerticalPlacement),B=r.textSizeData;let L=null;B.kind==="source"?(L=[Qs*a.layout.get("text-size").evaluate(m,{},C)*v.textScaleFactor],L[0]>nl&&ti(`${r.layerIds[0]}: Value for "text-size" is >= ${Ld}. Reduce your "text-size".`)):B.kind==="composite"&&(L=[Qs*v.compositeTextSizes[0].evaluate(m,{},C)*v.textScaleFactor,Qs*v.compositeTextSizes[1].evaluate(m,{},C)*v.textScaleFactor],(L[0]>nl||L[1]>nl)&&ti(`${r.layerIds[0]}: Value for "text-size" is >= ${Ld}. Reduce your "text-size".`)),r.addSymbols(r.text,O,L,y,h,m,f,e,i,T.lineStartIndex,T.lineLength,g,S,C,z,!1);for(const V of x)w[V]=r.text.placedSymbolArray.length-1;return 4*O.length}function I1(r){for(const e in r)return r[e];return null}function Ip(r,e,i,o,u,a,h,m,y,T){let f=h.top,x=h.bottom,w=h.left,g=h.right;const v=h.collisionPadding;if(v&&(w-=v[0],f-=v[1],g+=v[2],x+=v[3]),y){const S=new ft(w,f),C=new ft(g,f),z=new ft(w,x),O=new ft(g,x),B=pi(y);let L=new ft(0,0);T&&(L=new ft(T[0],T[1])),S._rotateAround(B,L),C._rotateAround(B,L),z._rotateAround(B,L),O._rotateAround(B,L),w=Math.min(S.x,C.x,z.x,O.x),g=Math.max(S.x,C.x,z.x,O.x),f=Math.min(S.y,C.y,z.y,O.y),x=Math.max(S.y,C.y,z.y,O.y)}return r.emplaceBack(e.x,e.y,e.z,i.x,i.y,w,f,g,x,m,o,u,a),r.length-1}function eg(r){r.collisionPadding&&(r.top-=r.collisionPadding[1],r.bottom+=r.collisionPadding[3]);const e=r.bottom-r.top;return e>0?Math.max(10,e):null}function x2(r,e,i,o){const u=r.compareText;if(e in u){const a=u[e];for(let h=a.length-1;h>=0;h--)if(o.dist(a[h])<i)return!0}else u[e]=[];return u[e].push(o),!1}function A1(r,e){const i=r.fovAboveCenter,o=r.elevation?r.elevation.getMinElevationBelowMSL()*e:0,u=(r._camera.position[2]*r.worldSize-o)/Math.cos(r._pitch),a=Math.sin(i)*u/Math.sin(Math.max(Math.PI/2-r._pitch-i,.01));let h=Math.sin(r._pitch)*a+u;const m=u*(1/r._horizonShift);if(!r.elevation||r.elevation.exaggeration()===0){let y=Math.max(r.zoom-17,0);r.isOrthographic&&(y/=10),h*=1+y}return Math.min(1.01*h,m)}function kd(r,e){if(!e.isReprojectedInTileSpace)return{scale:1<<r.z,x:r.x,y:r.y,x2:r.x+1,y2:r.y+1,projection:e};const i=Math.pow(2,-r.z),o=r.x*i,u=(r.x+1)*i,a=r.y*i,h=(r.y+1)*i,m=Tr(o),y=Tr(u),T=qn(a),f=qn(h),x=e.project(m,T),w=e.project(y,T),g=e.project(y,f),v=e.project(m,f);let S=Math.min(x.x,w.x,g.x,v.x),C=Math.min(x.y,w.y,g.y,v.y),z=Math.max(x.x,w.x,g.x,v.x),O=Math.max(x.y,w.y,g.y,v.y);const B=i/16;function L(j,W,te,ee,Q,pe){const ie=(te+Q)/2,me=(ee+pe)/2,xe=e.project(Tr(ie),qn(me)),ye=Math.max(0,S-xe.x,C-xe.y,xe.x-z,xe.y-O);S=Math.min(S,xe.x),z=Math.max(z,xe.x),C=Math.min(C,xe.y),O=Math.max(O,xe.y),ye>B&&(L(j,xe,te,ee,ie,me),L(xe,W,ie,me,Q,pe))}L(x,w,o,a,u,a),L(w,g,u,a,u,h),L(g,v,u,h,o,h),L(v,x,o,h,o,a),S-=B,C-=B,z+=B,O+=B;const V=1/Math.max(z-S,O-C);return{scale:V,x:S*V,y:C*V,x2:z*V,y2:O*V,projection:e}}function C1(r,{x:e,y:i},o=0){return new ft(((e-o)*r.scale-r.x)*mt,(i*r.scale-r.y)*mt)}const v2=Se.mat4.identity(new Float32Array(16));class rl{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,i){return{x:0,y:0,z:0}}unproject(e,i){return new bi(0,0)}projectTilePoint(e,i,o){return{x:e,y:i,z:0}}locationPoint(e,i,o=!0){return e._coordinatePoint(e.locationCoordinate(i),o)}pixelsPerMeter(e,i){return cr(1,e)*i}pixelSpaceConversion(e,i,o){return 1}farthestPixelDistance(e){return A1(e,e.pixelsPerMeter)}pointCoordinate(e,i,o,u){const a=e.horizonLineFromTop(!1),h=new ft(i,Math.max(a,o));return e.rayIntersectionCoordinate(e.pointRayIntersection(h,u))}pointCoordinate3D(e,i,o){const u=new ft(i,o);if(e.elevation)return e.elevation.pointCoordinate(u);{const a=this.pointCoordinate(e,u.x,u.y,0);return[a.x,a.y,a.z]}}isPointAboveHorizon(e,i){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,i.x,i.y);const o=e.horizonLineFromTop();return i.y<o}createInversionMatrix(e,i){return v2}createTileMatrix(e,i,o){let u,a,h;const m=o.canonical,y=Se.mat4.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const T=kd(m,this);u=1,a=T.x+o.wrap*T.scale,h=T.y,Se.mat4.scale(y,y,[u/T.scale,u/T.scale,e.pixelsPerMeter/i])}else u=i/e.zoomScale(m.z),a=(m.x+Math.pow(2,m.z)*o.wrap)*u,h=m.y*u;return Se.mat4.translate(y,y,[a,h,0]),Se.mat4.scale(y,y,[u/mt,u/mt,1]),y}upVector(e,i,o){return[0,0,1]}upVectorScale(e,i,o){return{metersToTile:1}}}class b2 extends rl{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];const[i,o]=this.parallels=e.parallels||[29.5,45.5],u=Math.sin(pi(i));this.n=(u+Math.sin(pi(o)))/2,this.c=1+u*(2*this.n-u),this.r0=Math.sqrt(this.c)/this.n}project(e,i){const{n:o,c:u,r0:a}=this,h=pi(e-this.center[0]),m=pi(i),y=Math.sqrt(u-2*o*Math.sin(m))/o;return{x:y*Math.sin(h*o),y:y*Math.cos(h*o)-a,z:0}}unproject(e,i){const{n:o,c:u,r0:a}=this,h=a+i;let m=Math.atan2(e,Math.abs(h))*Math.sign(h);h*o<0&&(m-=Math.PI*Math.sign(e)*Math.sign(h));const y=pi(this.center[0])*o;m=Xr(m,-Math.PI-y,Math.PI-y);const T=ri(Nn(m/o)+this.center[0],-180,180),f=Math.asin(ri((u-(e*e+h*h)*o*o)/(2*o),-1,1)),x=ri(Nn(f),-85.051129,_r);return new bi(T,x)}}const Od=1.340264,Fd=-.081106,Bd=893e-6,Nd=.003796,Ap=Math.sqrt(3)/2;class w2 extends rl{project(e,i){i=i/180*Math.PI,e=e/180*Math.PI;const o=Math.asin(Ap*Math.sin(i)),u=o*o,a=u*u*u;return{x:.5*(e*Math.cos(o)/(Ap*(Od+3*Fd*u+a*(7*Bd+9*Nd*u)))/Math.PI+.5),y:1-.5*(o*(Od+Fd*u+a*(Bd+Nd*u))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let o=i=(2*(1-i)-1)*Math.PI,u=o*o,a=u*u*u;for(let f,x,w,g=0;g<12&&(x=o*(Od+Fd*u+a*(Bd+Nd*u))-i,w=Od+3*Fd*u+a*(7*Bd+9*Nd*u),f=x/w,o=ri(o-f,-Math.PI/3,Math.PI/3),u=o*o,a=u*u*u,!(Math.abs(f)<1e-12));++g);const h=Ap*e*(Od+3*Fd*u+a*(7*Bd+9*Nd*u))/Math.cos(o),m=Math.asin(Math.sin(o)/Ap),y=ri(180*h/Math.PI,-180,180),T=ri(180*m/Math.PI,-85.051129,_r);return new bi(y,T)}}class T2 extends rl{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){return{x:.5+e/360,y:.5-i/360,z:0}}unproject(e,i){const o=360*(e-.5),u=ri(360*(.5-i),-85.051129,_r);return new bi(o,u)}}const Ru=Math.PI/2;function Cp(r){return Math.tan((Ru+r)/2)}class S2 extends rl{constructor(e){super(e),this.center=e.center||[0,30];const[i,o]=this.parallels=e.parallels||[30,30];let u=pi(i),a=pi(o);this.southernCenter=u+a<0,this.southernCenter&&(u=-u,a=-a);const h=Math.cos(u),m=Cp(u);this.n=u===a?Math.sin(u):Math.log(h/Math.cos(a))/Math.log(Cp(a)/m),this.f=h*Math.pow(Cp(u),this.n)/this.n}project(e,i){i=pi(i),this.southernCenter&&(i=-i),e=pi(e-this.center[0]);const o=1e-6,{n:u,f:a}=this;a>0?i<-Ru+o&&(i=-Ru+o):i>Ru-o&&(i=Ru-o);const h=a/Math.pow(Cp(i),u);let m=h*Math.sin(u*e),y=a-h*Math.cos(u*e);return m=.5*(m/Math.PI+.5),y=.5*(y/Math.PI+.5),{x:m,y:this.southernCenter?y:1-y,z:0}}unproject(e,i){e=(2*e-.5)*Math.PI,this.southernCenter&&(i=1-i),i=(2*(1-i)-.5)*Math.PI;const{n:o,f:u}=this,a=u-i,h=Math.sign(a),m=Math.sign(o)*Math.sqrt(e*e+a*a);let y=Math.atan2(e,Math.abs(a))*h;a*o<0&&(y-=Math.PI*Math.sign(e)*h);const T=ri(Nn(y/o)+this.center[0],-180,180),f=ri(Nn(2*Math.atan(Math.pow(u/m,1/o))-Ru),-85.051129,_r);return new bi(T,this.southernCenter?-f:f)}}class P1 extends rl{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,i){return{x:Ts(e),y:ts(i),z:0}}unproject(e,i){const o=Tr(e),u=qn(i);return new bi(o,u)}}const z1=pi(_r);class E2 extends rl{project(e,i){const o=(i=pi(i))*i,u=o*o;return{x:.5*((e=pi(e))*(.8707-.131979*o+u*(u*(.003971*o-.001529*u)-.013791))/Math.PI+.5),y:1-.5*(i*(1.007226+o*(.015085+u*(.028874*o-.044475-.005916*u)))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let o=i=(2*(1-i)-1)*Math.PI,u=25,a=0,h=o*o;do{h=o*o;const T=h*h;a=(o*(1.007226+h*(.015085+T*(.028874*h-.044475-.005916*T)))-i)/(1.007226+h*(.045255+T*(.259866*h-.311325-.005916*11*T))),o=ri(o-a,-z1,z1)}while(Math.abs(a)>1e-6&&--u>0);h=o*o;const m=ri(Nn(e/(.8707+h*(h*(h*h*h*(.003971-.001529*h)-.013791)-.131979))),-180,180),y=Nn(o);return new bi(m,y)}}const R1=pi(_r);class M2 extends rl{project(e,i){i=pi(i),e=pi(e);const o=Math.cos(i),u=2/Math.PI,a=Math.acos(o*Math.cos(e/2)),h=Math.sin(a)/a,m=.5*(e*u+2*o*Math.sin(e/2)/h)||0,y=.5*(i+Math.sin(i)/h)||0;return{x:.5*(m/Math.PI+.5),y:1-.5*(y/Math.PI+1),z:0}}unproject(e,i){let o=e=(2*e-.5)*Math.PI,u=i=(2*(1-i)-1)*Math.PI,a=25;const h=1e-6;let m=0,y=0;do{const T=Math.cos(u),f=Math.sin(u),x=2*f*T,w=f*f,g=T*T,v=Math.cos(o/2),S=Math.sin(o/2),C=2*v*S,z=S*S,O=1-g*v*v,B=O?1/O:0,L=O?Math.acos(T*v)*Math.sqrt(1/O):0,V=.5*(2*L*T*S+2*o/Math.PI)-e,j=.5*(L*f+u)-i,W=.5*B*(g*z+L*T*v*w)+1/Math.PI,te=B*(C*x/4-L*f*S),ee=.125*B*(x*S-L*f*g*C),Q=.5*B*(w*v+L*z*T)+.5,pe=te*ee-Q*W;m=(j*te-V*Q)/pe,y=(V*ee-j*W)/pe,o=ri(o-m,-Math.PI,Math.PI),u=ri(u-y,-R1,R1)}while((Math.abs(m)>h||Math.abs(y)>h)&&--a>0);return new bi(Nn(o),Nn(u))}}class D1 extends rl{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(pi(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){const{scale:o,cosPhi:u}=this;return{x:pi(e)*u*o+.5,y:-Math.sin(pi(i))/u*o+.5,z:0}}unproject(e,i){const{scale:o,cosPhi:u}=this,a=-(i-.5)/o,h=ri(Nn((e-.5)/o)/u,-180,180),m=Math.asin(ri(a*u,-1,1)),y=ri(Nn(m),-85.051129,_r);return new bi(h,y)}}class I2 extends P1{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,i,o){const u=Li(e,i,o),a=zn(vn(o));return Se.vec3.transformMat4(u,u,a),{x:u[0],y:u[1],z:u[2]}}locationPoint(e,i){const o=sa(i.lat,i.lng),u=Se.vec3.normalize([],o),a=e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(i),e._centerAltitude):e._centerAltitude,h=cr(1,0)*mt*a;Se.vec3.scaleAndAdd(o,o,u,h);const m=Se.mat4.identity(new Float64Array(16));return Se.mat4.multiply(m,e.pixelMatrix,e.globeMatrix),Se.vec3.transformMat4(o,o,m),new ft(o[0],o[1])}pixelsPerMeter(e,i){return cr(1,0)*i}pixelSpaceConversion(e,i,o){const u=cr(1,e)*i,a=Gt(cr(1,45)*i,u,o);return this.pixelsPerMeter(e,i)/a}createTileMatrix(e,i,o){const u=Fi(vn(o.canonical));return Se.mat4.multiply(new Float64Array(16),e.globeMatrix,u)}createInversionMatrix(e,i){const{center:o}=e,u=zn(vn(i));return Se.mat4.rotateY(u,u,pi(o.lng)),Se.mat4.rotateX(u,u,pi(o.lat)),Se.mat4.scale(u,u,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(u)}pointCoordinate(e,i,o,u){return Ai(e,i,o,!0)||new n(0,0)}pointCoordinate3D(e,i,o){const u=this.pointCoordinate(e,i,o,0);return[u.x,u.y,u.z]}isPointAboveHorizon(e,i){return!Ai(e,i.x,i.y,!1)}farthestPixelDistance(e){const i=function(u,a){const h=u.cameraToCenterDistance,m=u._centerAltitude*a,y=u._camera,T=u._camera.forward(),f=Se.vec3.add([],Se.vec3.scale([],T,-h),[0,0,m]),x=u.worldSize/(2*Math.PI),w=[0,0,-x],g=u.width/u.height,v=Math.tan(u.fovAboveCenter),S=Se.vec3.scale([],y.up(),v),C=Se.vec3.scale([],y.right(),v*g),z=Se.vec3.normalize([],Se.vec3.add([],Se.vec3.add([],T,S),C)),O=[];let B;if(new Yt(f,z).closestPointOnSphere(w,x,O)){const L=Se.vec3.add([],O,w),V=Se.vec3.sub([],L,f);B=Math.cos(u.fovAboveCenter)*Se.vec3.length(V)}else{const L=Se.vec3.sub([],f,w),V=Se.vec3.sub([],w,f);Se.vec3.normalize(V,V);const j=Se.vec3.length(L)-x;B=Math.sqrt(j*(j+2*x));const W=Math.acos(B/(x+j))-Math.acos(Se.vec3.dot(T,V));B*=Math.cos(W)}return 1.01*B}(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),o=gr(e.zoom);if(o>0){const u=A1(e,cr(1,e.center.lat)*e.worldSize),a=e.worldSize/(2*Math.PI),h=Math.max(e.width,e.height)/e.worldSize*Math.PI;return Gt(i,u+a*(1-Math.cos(h)),Math.pow(o,10))}return i}upVector(e,i,o){return Li(i,o,e,1)}upVectorScale(e){return{metersToTile:hi(_i(vn(e)))}}}function L1(r){const e=r.parallels,i=!!e&&Math.abs(e[0]+e[1])<.01;switch(r.name){case"mercator":return new P1(r);case"equirectangular":return new T2(r);case"naturalEarth":return new E2(r);case"equalEarth":return new w2(r);case"winkelTripel":return new M2(r);case"albers":return i?new D1(r):new b2(r);case"lambertConformalConic":return i?new D1(r):new S2(r);case"globe":return new I2(r)}throw new Error(`Invalid projection name: ${r.name}`)}const A2=Iu.VectorTileFeature.types,C2=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Pp(r,e,i,o,u,a,h,m,y,T,f,x,w){const g=m?Math.min(nl,Math.round(m[0])):0,v=m?Math.min(nl,Math.round(m[1])):0;r.emplaceBack(e,i,Math.round(32*o),Math.round(32*u),a,h,(g<<1)+(y?1:0),v,16*T,16*f,256*x,256*w)}function zp(r,e,i){r.emplaceBack(e,i)}function Rp(r,e,i,o,u,a,h){r.emplaceBack(e,i,o,u,a,h)}function Dp(r,e,i,o,u){r.emplaceBack(e,i,o,u),r.emplaceBack(e,i,o,u),r.emplaceBack(e,i,o,u),r.emplaceBack(e,i,o,u)}function P2(r){for(const e of r.sections)if(Hh(e.text))return!0;return!1}class tg{constructor(e){this.layoutVertexArray=new td,this.indexArray=new Gn,this.programConfigurations=e,this.segments=new an,this.dynamicLayoutVertexArray=new ta,this.opacityVertexArray=new nd,this.placedSymbolArray=new Kf,this.iconTransitioningVertexArray=new xo,this.globeExtVertexArray=new id,this.zOffsetVertexArray=new Wl}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(e,i,o,u,a){this.isEmpty()||(o&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Zw.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,i),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,Ww.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,C2,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,Yw.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,Hw.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||a)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,Xw.members,!0)),this.opacityVertexBuffer.itemSize=1),(o||u)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}Mt(tg,"SymbolBuffers");class ig{constructor(e,i,o){this.layoutVertexArray=new e,this.layoutAttributes=i,this.indexArray=new o,this.segments=new an,this.collisionVertexArray=new od,this.collisionVertexArrayExt=new ta}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,Kw.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,Jw.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Mt(ig,"CollisionBuffers");class Lp{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.lut=e.lut,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(h=>h.fqid),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Se.mat4.identity([]),this.placementViewportMatrix=Se.mat4.identity([]);const i=this.layers[0]._unevaluatedLayout._values;this.textSizeData=$_(this.zoom,i["text-size"]),this.iconSizeData=$_(this.zoom,i["icon-size"]);const o=this.layers[0].layout,u=o.get("symbol-sort-key"),a=o.get("symbol-z-order");this.canOverlap=o.get("text-allow-overlap")||o.get("icon-allow-overlap")||o.get("text-ignore-placement")||o.get("icon-ignore-placement"),this.sortFeaturesByKey=a!=="viewport-y"&&u.constantOr(1)!==void 0,this.sortFeaturesByY=(a==="viewport-y"||a==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=o.get("text-writing-mode").map(h=>is[h]),this.stateDependentLayerIds=this.layers.filter(h=>h.isStateDependent()).map(h=>h.id),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=o.get("symbol-z-elevate"),this.activeReplacements=[],this.replacementUpdateTime=0}createArrays(){this.text=new tg(new wo(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("text")||e.startsWith("symbol"))),this.icon=new tg(new wo(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("icon")||e.startsWith("symbol"))),this.glyphOffsetArray=new ep,this.lineVertexArray=new tp,this.symbolInstances=new Qf}calculateGlyphDependencies(e,i,o,u,a){for(const h of e){const m=h.codePointAt(0);if(m===void 0)break;if(i[m]=!0,u&&a&&m<=65535){const y=Pd[h];y&&(i[y.charCodeAt(0)]=!0)}}}updateFootprints(e,i){}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const o=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!F_(this.activeReplacements,o)&&(this.activeReplacements=o,!0)}populate(e,i,o,u){const a=this.layers[0],h=a.layout,m=this.projection.name==="globe",y=h.get("text-font"),T=h.get("text-field"),f=h.get("icon-image"),[x,w]=h.get("icon-size-scale-range"),g=ri(i.scaleFactor||1,x,w),v=(T.value.kind!=="constant"||T.value.value instanceof Kn&&!T.value.value.isEmpty()||T.value.value.toString().length>0)&&(y.value.kind!=="constant"||y.value.value.length>0),S=f.value.kind!=="constant"||!!f.value.value||Object.keys(f.parameters).length>0,C=h.get("symbol-sort-key");if(this.features=[],!v&&!S)return;const z=i.iconDependencies,O=i.glyphDependencies,B=i.availableImages,L=new Vi(this.zoom);for(const{feature:V,id:j,index:W,sourceLayerIndex:te}of e){const ee=a._featureFilter.needGeometry,Q=R(V,ee);if(!a._featureFilter.filter(L,Q,o))continue;if(ee||(Q.geometry=A(V,o,u)),m&&V.type!==1&&o.z<=5){const ye=Q.geometry,we=.98078528056,Ae=(Re,Ee)=>{const $e=Li(Re.x,Re.y,o,1),Qe=Li(Ee.x,Ee.y,o,1);return Se.vec3.dot($e,Qe)<we};for(let Re=0;Re<ye.length;Re++)ye[Re]=_(ye[Re],Ae)}let pe,ie;if(v){const ye=a.getValueAndResolveTokens("text-field",Q,o,B),we=Kn.factory(ye);P2(we)&&(this.hasRTLText=!0),(!this.hasRTLText||lu()==="unavailable"||this.hasRTLText&&Ar.isParsed())&&(pe=t2(we,a,Q))}if(S){const ye=a.getValueAndResolveTokens("icon-image",Q,o,B);ie=ye instanceof Zn?ye:Zn.build(ye)}if(!pe&&!ie)continue;const me=this.sortFeaturesByKey?C.evaluate(Q,{},o):void 0,xe={id:j,text:pe,icon:ie,index:W,sourceLayerIndex:te,geometry:Q.geometry,properties:V.properties,type:A2[V.type],sortKey:me};if(this.features.push(xe),ie){const ye=q_(this.iconSizeData,this.layers[0]._unevaluatedLayout._values["icon-size"],o,this.zoom,xe)*g*this.pixelRatio,we=ie.getPrimary().scaleSelf(ye);if(z[we.id]=z[we.id]||[],z[we.id].push(we),ie.nameSecondary){const Ae=ie.getSecondary().scaleSelf(ye);z[Ae.id]=z[Ae.id]||[],z[Ae.id].push(Ae)}}if(pe){const ye=y.evaluate(Q,{},o).join(","),we=h.get("text-rotation-alignment")==="map"&&h.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(is.vertical)>=0;for(const Ae of pe.sections)if(Ae.image){const Re=Ae.image.getPrimary().scaleSelf(this.pixelRatio);z[Re.id]=z[Re.id]||[],z[Re.id].push(Re)}else{const Re=qh(pe.toString()),Ee=Ae.fontStack||ye,$e=O[Ee]=O[Ee]||{};this.calculateGlyphDependencies(Ae.text,$e,we,this.allowVerticalPlacement,Re)}}}h.get("symbol-placement")==="line"&&(this.features=function(V){const j={},W={},te=[];let ee=0;function Q(xe){te.push(V[xe]),ee++}function pe(xe,ye,we){const Ae=W[xe];return delete W[xe],W[ye]=Ae,te[Ae].geometry[0].pop(),te[Ae].geometry[0]=te[Ae].geometry[0].concat(we[0]),Ae}function ie(xe,ye,we){const Ae=j[ye];return delete j[ye],j[xe]=Ae,te[Ae].geometry[0].shift(),te[Ae].geometry[0]=we[0].concat(te[Ae].geometry[0]),Ae}function me(xe,ye,we){const Ae=we?ye[0][ye[0].length-1]:ye[0][0];return`${xe}:${Ae.x}:${Ae.y}`}for(let xe=0;xe<V.length;xe++){const ye=V[xe],we=ye.geometry,Ae=ye.text?ye.text.toString():null;if(!Ae){Q(xe);continue}const Re=me(Ae,we),Ee=me(Ae,we,!0);if(Re in W&&Ee in j&&W[Re]!==j[Ee]){const $e=ie(Re,Ee,we),Qe=pe(Re,Ee,te[$e].geometry);delete j[Re],delete W[Ee],W[me(Ae,te[Qe].geometry,!0)]=Qe,te[$e].geometry=null}else Re in W?pe(Re,Ee,we):Ee in j?ie(Re,Ee,we):(Q(xe),j[Re]=ee-1,W[Ee]=ee-1)}return te.filter(xe=>xe.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((V,j)=>V.sortKey-j.sortKey)}update(e,i,o,u,a,h,m){this.text.programConfigurations.updatePaintArrays(e,i,a,o,u,h,m),this.icon.programConfigurations.updatePaintArrays(e,i,a,o,u,h,m)}updateZOffset(){const e=(a,h,m)=>{o+=h,o>a.length&&a.resize(o);for(let y=-h;y<0;y++)a.emplace(y+o,m)},i=(a,h,m)=>{u+=h,u>a.length&&a.resize(u);for(let y=-h;y<0;y++)a.emplace(y+u,m)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let o=0,u=0;for(let a=0;a<this.symbolInstances.length;a++){const h=this.symbolInstances.get(a),{numHorizontalGlyphVertices:m,numVerticalGlyphVertices:y,numIconVertices:T}=h,f=h.zOffset,x=T>0;if((m>0||y>0)&&(e(this.text.zOffsetVertexArray,m,f),e(this.text.zOffsetVertexArray,y,f)),x){const{placedIconSymbolIndex:w,verticalPlacedIconSymbolIndex:g}=h;w>=0&&i(this.icon.zOffsetVertexArray,T,f),g>=0&&i(this.icon.zOffsetVertexArray,h.numVerticalIconVertices,f)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=L1(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,i){const o=this.lineVertexArray.length;if(e.segment!==void 0)for(const{x:u,y:a}of i)this.lineVertexArray.emplaceBack(u,a);return{lineStartIndex:o,lineLength:this.lineVertexArray.length-o}}addSymbols(e,i,o,u,a,h,m,y,T,f,x,w,g,v,S,C){const z=e.indexArray,O=e.layoutVertexArray,B=e.globeExtVertexArray,L=e.segments.prepareSegment(4*i.length,O,z,this.canOverlap?h.sortKey:void 0),V=this.glyphOffsetArray.length,j=L.vertexLength,W=this.allowVerticalPlacement&&m===is.vertical?Math.PI/2:0,te=h.text&&h.text.sections;for(let Q=0;Q<i.length;Q++){const{tl:pe,tr:ie,bl:me,br:xe,texPrimary:ye,texSecondary:we,pixelOffsetTL:Ae,pixelOffsetBR:Re,minFontScaleX:Ee,minFontScaleY:$e,glyphOffset:Qe,isSDF:qe,sectionIndex:_t}=i[Q],pt=L.vertexLength,rt=Qe[1];if(Pp(O,T.x,T.y,pe.x,rt+pe.y,ye.x,ye.y,o,qe,Ae.x,Ae.y,Ee,$e),Pp(O,T.x,T.y,ie.x,rt+ie.y,ye.x+ye.w,ye.y,o,qe,Re.x,Ae.y,Ee,$e),Pp(O,T.x,T.y,me.x,rt+me.y,ye.x,ye.y+ye.h,o,qe,Ae.x,Re.y,Ee,$e),Pp(O,T.x,T.y,xe.x,rt+xe.y,ye.x+ye.w,ye.y+ye.h,o,qe,Re.x,Re.y,Ee,$e),y){const{x:et,y:Pt,z:yt}=y.anchor,[Tt,Wt,ei]=y.up;Rp(B,et,Pt,yt,Tt,Wt,ei),Rp(B,et,Pt,yt,Tt,Wt,ei),Rp(B,et,Pt,yt,Tt,Wt,ei),Rp(B,et,Pt,yt,Tt,Wt,ei),Dp(e.dynamicLayoutVertexArray,et,Pt,yt,W)}else Dp(e.dynamicLayoutVertexArray,T.x,T.y,T.z,W);if(C){const et=we||ye;zp(e.iconTransitioningVertexArray,et.x,et.y),zp(e.iconTransitioningVertexArray,et.x+et.w,et.y),zp(e.iconTransitioningVertexArray,et.x,et.y+et.h),zp(e.iconTransitioningVertexArray,et.x+et.w,et.y+et.h)}z.emplaceBack(pt,pt+1,pt+2),z.emplaceBack(pt+1,pt+2,pt+3),L.vertexLength+=4,L.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(Qe[0]),Q!==i.length-1&&_t===i[Q+1].sectionIndex||e.programConfigurations.populatePaintArrays(O.length,h,h.index,{},g,v,S,te&&te[_t])}const ee=y?y.anchor:T;e.placedSymbolArray.emplaceBack(ee.x,ee.y,ee.z,T.x,T.y,V,this.glyphOffsetArray.length-V,j,f,x,T.segment,o?o[0]:0,o?o[1]:0,u[0],u[1],m,0,!1,0,w,0)}_commitLayoutVertex(e,i,o,u,a,h,m){e.emplaceBack(i,o,u,a,h,Math.round(m.x),Math.round(m.y))}_addCollisionDebugVertices(e,i,o,u,a,h,m){const y=o.segments.prepareSegment(4,o.layoutVertexArray,o.indexArray),T=y.vertexLength,f=m.tileAnchorX,x=m.tileAnchorY;for(let g=0;g<4;g++)o.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(o.collisionVertexArrayExt,i,e.padding,m.zOffset),this._commitLayoutVertex(o.layoutVertexArray,u,a,h,f,x,new ft(e.x1,e.y1)),this._commitLayoutVertex(o.layoutVertexArray,u,a,h,f,x,new ft(e.x2,e.y1)),this._commitLayoutVertex(o.layoutVertexArray,u,a,h,f,x,new ft(e.x2,e.y2)),this._commitLayoutVertex(o.layoutVertexArray,u,a,h,f,x,new ft(e.x1,e.y2)),y.vertexLength+=4;const w=o.indexArray;w.emplaceBack(T,T+1),w.emplaceBack(T+1,T+2),w.emplaceBack(T+2,T+3),w.emplaceBack(T+3,T),y.primitiveLength+=4}_addTextDebugCollisionBoxes(e,i,o,u,a,h){for(let m=u;m<a;m++){const y=o.get(m),T=this.getSymbolInstanceTextSize(e,h,i,m);this._addCollisionDebugVertices(y,T,this.textCollisionBox,y.projectedAnchorX,y.projectedAnchorY,y.projectedAnchorZ,h)}}_addIconDebugCollisionBoxes(e,i,o,u,a,h){for(let m=u;m<a;m++){const y=o.get(m),T=this.getSymbolInstanceIconSize(e,i,h.placedIconSymbolIndex);this._addCollisionDebugVertices(y,T,this.iconCollisionBox,y.projectedAnchorX,y.projectedAnchorY,y.projectedAnchorZ,h)}}generateCollisionDebugBuffers(e,i,o){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new ig(_u,i1.members,xo),this.iconCollisionBox=new ig(_u,i1.members,xo);const u=Au(this.iconSizeData,e),a=Au(this.textSizeData,e,o);for(let h=0;h<this.symbolInstances.length;h++){const m=this.symbolInstances.get(h);this._addTextDebugCollisionBoxes(a,e,i,m.textBoxStartIndex,m.textBoxEndIndex,m),this._addTextDebugCollisionBoxes(a,e,i,m.verticalTextBoxStartIndex,m.verticalTextBoxEndIndex,m),this._addIconDebugCollisionBoxes(u,e,i,m.iconBoxStartIndex,m.iconBoxEndIndex,m),this._addIconDebugCollisionBoxes(u,e,i,m.verticalIconBoxStartIndex,m.verticalIconBoxEndIndex,m)}}getSymbolInstanceTextSize(e,i,o,u){const a=this.text.placedSymbolArray.get(i.rightJustifiedTextSymbolIndex>=0?i.rightJustifiedTextSymbolIndex:i.centerJustifiedTextSymbolIndex>=0?i.centerJustifiedTextSymbolIndex:i.leftJustifiedTextSymbolIndex>=0?i.leftJustifiedTextSymbolIndex:i.verticalPlacedTextSymbolIndex>=0?i.verticalPlacedTextSymbolIndex:u),h=vp(this.textSizeData,e,a)/tr;return this.tilePixelRatio*h}getSymbolInstanceIconSize(e,i,o){const u=this.icon.placedSymbolArray.get(o),a=vp(this.iconSizeData,e,u);return this.tilePixelRatio*a}_commitDebugCollisionVertexUpdate(e,i,o,u){e.emplaceBack(i,-o,-o,u),e.emplaceBack(i,o,-o,u),e.emplaceBack(i,o,o,u),e.emplaceBack(i,-o,o,u)}_updateTextDebugCollisionBoxes(e,i,o,u,a,h,m){for(let y=u;y<a;y++){const T=o.get(y),f=this.getSymbolInstanceTextSize(e,h,i,y);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,f,T.padding,h.zOffset)}}_updateIconDebugCollisionBoxes(e,i,o,u,a,h,m){for(let y=u;y<a;y++){const T=o.get(y),f=this.getSymbolInstanceIconSize(e,i,h.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,f,T.padding,h.zOffset)}}updateCollisionDebugBuffers(e,i,o,u){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const a=Au(this.iconSizeData,e,u),h=Au(this.textSizeData,e,o);for(let m=0;m<this.symbolInstances.length;m++){const y=this.symbolInstances.get(m);this._updateTextDebugCollisionBoxes(h,e,i,y.textBoxStartIndex,y.textBoxEndIndex,y,o),this._updateTextDebugCollisionBoxes(h,e,i,y.verticalTextBoxStartIndex,y.verticalTextBoxEndIndex,y,o),this._updateIconDebugCollisionBoxes(a,e,i,y.iconBoxStartIndex,y.iconBoxEndIndex,y,u),this._updateIconDebugCollisionBoxes(a,e,i,y.verticalIconBoxStartIndex,y.verticalIconBoxEndIndex,y,u)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,i,o,u,a,h,m,y,T){const f={};if(i<o){const{x1:x,y1:w,x2:g,y2:v,padding:S,projectedAnchorX:C,projectedAnchorY:z,projectedAnchorZ:O,tileAnchorX:B,tileAnchorY:L,featureIndex:V}=e.get(i);f.textBox={x1:x,y1:w,x2:g,y2:v,padding:S,projectedAnchorX:C,projectedAnchorY:z,projectedAnchorZ:O,tileAnchorX:B,tileAnchorY:L},f.textFeatureIndex=V}if(u<a){const{x1:x,y1:w,x2:g,y2:v,padding:S,projectedAnchorX:C,projectedAnchorY:z,projectedAnchorZ:O,tileAnchorX:B,tileAnchorY:L,featureIndex:V}=e.get(u);f.verticalTextBox={x1:x,y1:w,x2:g,y2:v,padding:S,projectedAnchorX:C,projectedAnchorY:z,projectedAnchorZ:O,tileAnchorX:B,tileAnchorY:L},f.verticalTextFeatureIndex=V}if(h<m){const{x1:x,y1:w,x2:g,y2:v,padding:S,projectedAnchorX:C,projectedAnchorY:z,projectedAnchorZ:O,tileAnchorX:B,tileAnchorY:L,featureIndex:V}=e.get(h);f.iconBox={x1:x,y1:w,x2:g,y2:v,padding:S,projectedAnchorX:C,projectedAnchorY:z,projectedAnchorZ:O,tileAnchorX:B,tileAnchorY:L},f.iconFeatureIndex=V}if(y<T){const{x1:x,y1:w,x2:g,y2:v,padding:S,projectedAnchorX:C,projectedAnchorY:z,projectedAnchorZ:O,tileAnchorX:B,tileAnchorY:L,featureIndex:V}=e.get(y);f.verticalIconBox={x1:x,y1:w,x2:g,y2:v,padding:S,projectedAnchorX:C,projectedAnchorY:z,projectedAnchorZ:O,tileAnchorX:B,tileAnchorY:L},f.verticalIconFeatureIndex=V}return f}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let i=0;i<this.symbolInstances.length;i++){const o=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,o.textBoxStartIndex,o.textBoxEndIndex,o.verticalTextBoxStartIndex,o.verticalTextBoxEndIndex,o.iconBoxStartIndex,o.iconBoxEndIndex,o.verticalIconBoxStartIndex,o.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,i){const o=e.placedSymbolArray.get(i),u=o.vertexStartIndex+4*o.numGlyphs;for(let a=o.vertexStartIndex;a<u;a+=4)e.indexArray.emplaceBack(a,a+1,a+2),e.indexArray.emplaceBack(a+1,a+2,a+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const i=Math.sin(e),o=Math.cos(e),u=[],a=[],h=[];for(let m=0;m<this.symbolInstances.length;++m){h.push(m);const y=this.symbolInstances.get(m);u.push(0|Math.round(i*y.tileAnchorX+o*y.tileAnchorY)),a.push(y.featureIndex)}return h.sort((m,y)=>u[m]-u[y]||a[y]-a[m]),h}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((e,i)=>this.symbolInstances.get(i).zOffset-this.symbolInstances.get(e).zOffset)}addToSortKeyRanges(e,i){const o=this.sortKeyRanges[this.sortKeyRanges.length-1];o&&o.sortKey===i?o.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:i,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const i of this.symbolInstanceIndexes){const o=this.symbolInstances.get(i);this.featureSortOrder.push(o.featureIndex);const{rightJustifiedTextSymbolIndex:u,centerJustifiedTextSymbolIndex:a,leftJustifiedTextSymbolIndex:h,verticalPlacedTextSymbolIndex:m,placedIconSymbolIndex:y,verticalPlacedIconSymbolIndex:T}=o;u>=0&&this.addIndicesForPlacedSymbol(this.text,u),a>=0&&a!==u&&this.addIndicesForPlacedSymbol(this.text,a),h>=0&&h!==a&&h!==u&&this.addIndicesForPlacedSymbol(this.text,h),m>=0&&this.addIndicesForPlacedSymbol(this.text,m),y>=0&&this.addIndicesForPlacedSymbol(this.icon,y),T>=0&&this.addIndicesForPlacedSymbol(this.icon,T)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let k1,O1,ng;Mt(Lp,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),Lp.addDynamicAttributes=Dp;class F1{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:Vo,this.defaultValue=e}evaluate(e){if(e.formattedSection){const i=this.defaultValue.property.overrides;if(i&&i.hasOverride(e.formattedSection))return i.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Mt(F1,"FormatSectionOverride",{omit:["defaultValue"]});const rg=()=>ng||(ng={layout:k1||(k1=new Yi({"symbol-placement":new at(ke.layout_symbol["symbol-placement"]),"symbol-spacing":new at(ke.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new at(ke.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new wt(ke.layout_symbol["symbol-sort-key"]),"symbol-z-order":new at(ke.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new at(ke.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new at(ke.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new at(ke.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new at(ke.layout_symbol["icon-ignore-placement"]),"icon-optional":new at(ke.layout_symbol["icon-optional"]),"icon-rotation-alignment":new at(ke.layout_symbol["icon-rotation-alignment"]),"icon-size":new wt(ke.layout_symbol["icon-size"]),"icon-size-scale-range":new at(ke.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new wt(ke.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new wt(ke.layout_symbol["icon-text-fit-padding"]),"icon-image":new wt(ke.layout_symbol["icon-image"]),"icon-rotate":new wt(ke.layout_symbol["icon-rotate"]),"icon-padding":new at(ke.layout_symbol["icon-padding"]),"icon-keep-upright":new at(ke.layout_symbol["icon-keep-upright"]),"icon-offset":new wt(ke.layout_symbol["icon-offset"]),"icon-anchor":new wt(ke.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new at(ke.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new at(ke.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new at(ke.layout_symbol["text-rotation-alignment"]),"text-field":new wt(ke.layout_symbol["text-field"]),"text-font":new wt(ke.layout_symbol["text-font"]),"text-size":new wt(ke.layout_symbol["text-size"]),"text-size-scale-range":new at(ke.layout_symbol["text-size-scale-range"]),"text-max-width":new wt(ke.layout_symbol["text-max-width"]),"text-line-height":new wt(ke.layout_symbol["text-line-height"]),"text-letter-spacing":new wt(ke.layout_symbol["text-letter-spacing"]),"text-justify":new wt(ke.layout_symbol["text-justify"]),"text-radial-offset":new wt(ke.layout_symbol["text-radial-offset"]),"text-variable-anchor":new at(ke.layout_symbol["text-variable-anchor"]),"text-anchor":new wt(ke.layout_symbol["text-anchor"]),"text-max-angle":new at(ke.layout_symbol["text-max-angle"]),"text-writing-mode":new at(ke.layout_symbol["text-writing-mode"]),"text-rotate":new wt(ke.layout_symbol["text-rotate"]),"text-padding":new at(ke.layout_symbol["text-padding"]),"text-keep-upright":new at(ke.layout_symbol["text-keep-upright"]),"text-transform":new wt(ke.layout_symbol["text-transform"]),"text-offset":new wt(ke.layout_symbol["text-offset"]),"text-allow-overlap":new at(ke.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new at(ke.layout_symbol["text-ignore-placement"]),"text-optional":new at(ke.layout_symbol["text-optional"]),visibility:new at(ke.layout_symbol.visibility)})),paint:O1||(O1=new Yi({"icon-opacity":new wt(ke.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new wt(ke.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new wt(ke.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new wt(ke.paint_symbol["text-emissive-strength"]),"icon-color":new wt(ke.paint_symbol["icon-color"]),"icon-halo-color":new wt(ke.paint_symbol["icon-halo-color"]),"icon-halo-width":new wt(ke.paint_symbol["icon-halo-width"]),"icon-halo-blur":new wt(ke.paint_symbol["icon-halo-blur"]),"icon-translate":new at(ke.paint_symbol["icon-translate"]),"icon-translate-anchor":new at(ke.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new wt(ke.paint_symbol["icon-image-cross-fade"]),"text-opacity":new wt(ke.paint_symbol["text-opacity"]),"text-occlusion-opacity":new wt(ke.paint_symbol["text-occlusion-opacity"]),"text-color":new wt(ke.paint_symbol["text-color"],{runtimeType:Yn,getOverride:r=>r.textColor,hasOverride:r=>!!r.textColor}),"text-halo-color":new wt(ke.paint_symbol["text-halo-color"]),"text-halo-width":new wt(ke.paint_symbol["text-halo-width"]),"text-halo-blur":new wt(ke.paint_symbol["text-halo-blur"]),"text-translate":new at(ke.paint_symbol["text-translate"]),"text-translate-anchor":new at(ke.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new at(ke.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new at(ke.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new at(ke.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new at(ke.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new wt(ke.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"})}))},ng);class kp extends kn{constructor(e,i,o,u){super(e,rg(),i,o,u),this._colorAdjustmentMatrix=Se.mat4.identity([]),this.hasInitialOcclusionOpacityProperties=e.paint!==void 0&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}recalculate(e,i){super.recalculate(e,i),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const o=this.layout.get("text-writing-mode");if(o){const u=[];for(const a of o)u.indexOf(a)<0&&u.push(a);this.layout._values["text-writing-mode"]=u}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,i,o,u){return this._saturation===e&&this._contrast===i&&this._brightnessMin===o&&this._brightnessMax===u||(this._colorAdjustmentMatrix=function(a,h,m,y){a=Dc(a),h=Rc(h);const T=Se.mat4.create(),f=a/3,x=1-2*f,w=[x,f,f,0,f,x,f,0,f,f,x,0,0,0,0,1],g=.5-.5*h,v=y-m;return Se.mat4.multiply(T,[v,0,0,0,0,v,0,0,0,0,v,0,m,m,m,1],[h,0,0,0,0,h,0,0,0,0,h,0,g,g,g,1]),Se.mat4.multiply(T,T,w),T}(e,i,o,u),this._saturation=e,this._contrast=i,this._brightnessMin=o,this._brightnessMax=u),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,i,o,u){const a=this.layout.get(e).evaluate(i,{},o,u),h=this._unevaluatedLayout._values[e];return h.isDataDriven()||Na(h.value)||!a?a:function(m,y){return y.replace(/{([^{}]+)}/g,(T,f)=>f in m?String(m[f]):"")}(i.properties,a)}createBucket(e){return new Lp(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of rg().paint.overridableProperties){if(!kp.hasPaintOverride(this.layout,e))continue;const i=this.paint.get(e),o=new F1(i),u=new nu(o,i.property.specification,this.scope,this.options);let a=null;a=i.value.kind==="constant"||i.value.kind==="source"?new ru("source",u):new Bl("composite",u,i.value.zoomStops,i.value._interpolationType),this.paint._values[e]=new Ga(i.property,a,i.parameters)}}_handleOverridablePaintPropertyUpdate(e,i,o){return!(!this.layout||i.isDataDriven()||o.isDataDriven())&&kp.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,i){const o=e.get("text-field"),u=rg().paint.properties[i];let a=!1;const h=m=>{for(const y of m)if(u.overrides&&u.overrides.hasOverride(y))return void(a=!0)};if(o.value.kind==="constant"&&o.value.value instanceof Kn)h(o.value.value.sections);else if(o.value.kind==="source"){const m=T=>{a||(T instanceof Un&&nn(T.value)===_s?h(T.value.sections):T instanceof Uo?h(T.sections):T.eachChild(m))},y=o.value;y._styleExpression&&m(y._styleExpression.expression)}return a}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,i,o){return{config:new ra(this,{zoom:i,lut:o}),overrideFog:!1}}}let B1,N1,V1,U1;var sg=Ii([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function og(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function ag(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class lg{constructor(e,i,o,u){this.context=e,this.format=o,this.useMipmap=u&&u.useMipmap,this.texture=e.gl.createTexture(),this.update(i,{premultiply:u&&u.premultiply})}update(e,i){const o=e&&e instanceof HTMLVideoElement&&e.width===0?e.videoWidth:e.width,u=e&&e instanceof HTMLVideoElement&&e.height===0?e.videoHeight:e.height,{context:a}=this,{gl:h}=a,{x:m,y}=i&&i.position?i.position:{x:0,y:0},T=m+o,f=y+u;!this.size||this.size[0]===T&&this.size[1]===f||(h.bindTexture(h.TEXTURE_2D,null),h.deleteTexture(this.texture),this.texture=h.createTexture(),this.size=null),h.bindTexture(h.TEXTURE_2D,this.texture),a.pixelStoreUnpackFlipY.set(!1),a.pixelStoreUnpack.set(1),a.pixelStoreUnpackPremultiplyAlpha.set(this.format===h.RGBA8&&(!i||i.premultiply!==!1));const x=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&T>0&&f>0){const w=this.useMipmap?Math.floor(Math.log2(Math.max(T,f)))+1:1;h.texStorage2D(h.TEXTURE_2D,w,this.format,T,f),this.size=[T,f]}if(this.size)if(x)h.texSubImage2D(h.TEXTURE_2D,0,m,y,og(this.format),ag(this.format),e);else{const w=e.data;w&&h.texSubImage2D(h.TEXTURE_2D,0,m,y,o,u,og(this.format),ag(this.format),w)}this.useMipmap&&h.generateMipmap(h.TEXTURE_2D)}bind(e,i,o=!1){const{context:u}=this,{gl:a}=u;a.bindTexture(a.TEXTURE_2D,this.texture),e!==this.minFilter&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,this.useMipmap&&!o?e===a.NEAREST?a.NEAREST_MIPMAP_NEAREST:a.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),i!==this.wrapS&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,i),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,i),this.wrapS=i)}bindExtraParam(e,i,o,u){const{context:a}=this,{gl:h}=a;h.bindTexture(h.TEXTURE_2D,this.texture),i!==this.magFilter&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,i),this.magFilter=i),e!==this.minFilter&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,this.useMipmap?e===h.NEAREST?h.NEAREST_MIPMAP_NEAREST:h.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),o!==this.wrapS&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,o),this.wrapS=o),u!==this.wrapT&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,u),this.wrapT=u)}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class Op{constructor(e,i){this.context=e,this.texture=i}bind(e,i){const{context:o}=this,{gl:u}=o;u.bindTexture(u.TEXTURE_2D,this.texture),e!==this.minFilter&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,e),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,e),this.minFilter=e),i!==this.wrapS&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,i),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,i),this.wrapS=i)}}function Fp(r,e,i,o,u,a,h,m){const y=[r,e,1,i,o,1,u,a,1],T=[h,m,1],f=Se.mat3.adjoint([],y),[x,w,g]=Se.vec3.transformMat3(T,T,f);return Se.mat3.multiply(y,y,[x,0,0,0,w,0,0,0,g])}function j1(r,e,i,o,u,a,h,m){const y=function(T,f,x,w,g,v,S,C){const z=Fp(0,0,1,0,1,1,0,1),O=Fp(T,f,x,w,g,v,S,C),B=Se.mat3.adjoint([],z);return Se.mat3.multiply(O,O,B)}(r,e,i,o,u,a,h,m);return[y[2]/y[8]/mt,y[5]/y[8]/mt]}function Bp(r){return[r[0],Math.min(Math.max(r[1],-85.051129),_r)]}class G1 extends uo{constructor(e,i,o,u){super(),this.id=e,this.dispatcher=o,this.coordinates=i.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(u),this.options=i,this._dirty=!1}load(e,i){if(this._loaded=i||!1,this.fire(new ms("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=ih(this.map._requestManager.transformRequest(this.url,Si.Image),(o,u)=>{this._imageRequest=null,this._loaded=!0,o?this.fire(new kc(o)):u&&(this.image=u instanceof HTMLImageElement?ue.getImageData(u):u,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())})}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Op(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new ms("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Op||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let i=e[0][1],o=e[0][1];for(const a of e)a[1]>o&&(o=a[1]),a[1]<i&&(i=a[1]);const u=(o+i)/2;if(u>_r?this.onNorthPole=!0:u<-85.051129&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const a=e.map(n.fromLngLat);this.tileID=function(h){let m=1/0,y=1/0,T=-1/0,f=-1/0;for(const S of h)m=Math.min(m,S.x),y=Math.min(y,S.y),T=Math.max(T,S.x),f=Math.max(f,S.y);const x=Math.max(T-m,f-y),w=Math.max(0,Math.floor(-Math.log(x)/Math.LN2)),g=Math.pow(2,w);let v=Math.floor((m+T)/2*g);return v>1&&(v-=1),new Je(w,v,Math.floor((y+f)/2*g))}(a),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new ms("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(const z in this.tiles){const O=this.tiles[z];O.state!=="loaded"&&(O.state="loaded",O.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const i=kd(new Je(0,0,0),this.map.transform.projection),o=[i.projection.project(this.coordinates[0][0],this.coordinates[0][1]),i.projection.project(this.coordinates[1][0],this.coordinates[1][1]),i.projection.project(this.coordinates[2][0],this.coordinates[2][1]),i.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(z){const O=z[1].x-z[0].x,B=z[1].y-z[0].y,L=z[2].x-z[1].x,V=z[2].y-z[1].y,j=z[3].x-z[2].x,W=z[3].y-z[2].y,te=z[0].x-z[3].x,ee=z[0].y-z[3].y,Q=O*V-L*B,pe=L*W-j*V,ie=j*ee-te*W,me=te*B-O*ee;return Q>0&&pe>0&&ie>0&&me>0||Q<0&&pe<0&&ie<0&&me<0}(o))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const u=kd(this.tileID,this.map.transform.projection),[a,h,m,y]=this.coordinates.map(z=>{const O=u.projection.project(z[0],z[1]);return C1(u,O)._round()});this.perspectiveTransform=j1(a.x,a.y,h.x,h.y,m.x,m.y,y.x,y.y);const T=this._boundsArray=new Ks;T.emplaceBack(a.x,a.y,0,0),T.emplaceBack(h.x,h.y,mt,0),T.emplaceBack(y.x,y.y,0,mt),T.emplaceBack(m.x,m.y,mt,mt),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(T,sg.members),this.boundsSegments=an.simpleSegment(0,0,4,2);const f=[],x=[Bp((w=this.coordinates)[0]),Bp(w[1]),Bp(w[2]),Bp(w[3])];var w;const[g,v,S,C]=function(z){let O=z[0][0],B=O,L=z[0][1],V=L;for(let j=1;j<z.length;j++)z[j][0]<O?O=z[j][0]:z[j][0]>B&&(B=z[j][0]),z[j][1]<L?L=z[j][1]:z[j][1]>V&&(V=z[j][1]);return[O,L,B-O,V-L]}(x);{const z=new Ks,[O,B,L,V]=function(Ae){let Re=Ae[0].x,Ee=Re,$e=Ae[0].y,Qe=$e;for(let qe=1;qe<Ae.length;qe++)Ae[qe].x<Re?Re=Ae[qe].x:Ae[qe].x>Ee&&(Ee=Ae[qe].x),Ae[qe].y<$e?$e=Ae[qe].y:Ae[qe].y>Qe&&(Qe=Ae[qe].y);return[Re,$e,Ee-Re,Qe-$e]}(o),j=Ae=>[(Ae.x-O)/L,(Ae.y-B)/V],[W,te,ee,Q]=o.map(j),pe=function(Ae,Re,Ee,$e,Qe,qe,_t,pt){const rt=Fp(0,0,1,0,1,1,0,1),et=Fp(Ae,Re,Ee,$e,Qe,qe,_t,pt),Pt=Se.mat3.adjoint([],et);return Se.mat3.multiply(rt,rt,Pt)}(W[0],W[1],te[0],te[1],ee[0],ee[1],Q[0],Q[1]);this.elevatedGlobePerspectiveTransform=j1(W[0],W[1],te[0],te[1],ee[0],ee[1],Q[0],Q[1]);const ie=(Ae,Re)=>{f.push(Ae.lng);const Ee=Math.round((Ae.lng-g)/S*mt),$e=Math.round((Ae.lat-v)/C*mt),Qe=j(Re),qe=Se.vec3.transformMat3([],[Qe[0],Qe[1],1],pe),_t=Math.round(qe[0]/qe[2]*mt),pt=Math.round(qe[1]/qe[2]*mt);z.emplaceBack(Ee,$e,_t,pt)},me=o[3].x-o[0].x,xe=o[3].y-o[0].y,ye=o[2].x-o[1].x,we=o[2].y-o[1].y;for(let Ae=0;Ae<65;Ae++){const Re=Ae/64,Ee=[o[0].x+Re*me,o[0].y+Re*xe],$e=[o[1].x+Re*ye,o[1].y+Re*we],Qe=$e[0]-Ee[0],qe=$e[1]-Ee[1];for(let _t=0;_t<65;_t++){const pt=_t/64,rt={x:Ee[0]+Qe*pt,y:Ee[1]+qe*pt,z:0};ie(i.projection.unproject(rt.x,rt.y),rt)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(z,sg.members)}{this.maxLongitudeTriangleSize=0;let z=[],O=new Gn;const B=(L,V,j)=>{O.emplaceBack(L,V,j);const W=f[L],te=f[V],ee=f[j],Q=Math.min(Math.min(W,te),ee),pe=Math.max(Math.max(W,te),ee)-Q;pe>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=pe),z.push(Q+pe/2)};for(let L=0;L<64;L++)for(let V=0;V<64;V++){const j=65*L+V,W=j+1,te=j+65,ee=te+1;B(j,te,W),B(W,te,ee)}[z,O]=function(L,V){const j=Array.from({length:L.length},(ee,Q)=>Q);j.sort((ee,Q)=>L[ee]-L[Q]);const W=[],te=new Gn;for(let ee=0;ee<j.length;ee++){const Q=j[ee];W.push(L[Q]);const pe=3*Q,ie=pe+1;te.emplaceBack(V.uint16[pe],V.uint16[ie],V.uint16[ie+1])}return[W,te]}(z,O),this.elevatedGlobeTrianglesCenterLongitudes=z,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(O)}this.elevatedGlobeSegments=an.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,S/mt,0,C/mt,0,0,v,g,0])}prepare(){const e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;const i=this.map.painter.context,o=i.gl;!this._dirty||this.texture instanceof Op||(this.texture?this.texture.update(this.image):(this.texture=new lg(i,this.image,o.RGBA8),this.texture.bind(o.LINEAR,o.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(i)}loadTile(e,i){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},i(null)):(e.state="errored",i(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){const i=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!i)return null;const o=this.elevatedGlobeTrianglesCenterLongitudes;let u=(a=e+180)+360*Math.round((o[0]-a)/360);var a;const h=new an,m=(x,w)=>{h.segments.push({vertexOffset:0,primitiveOffset:x,vertexLength:i.segments[0].vertexLength,primitiveLength:w,sortKey:void 0,vaos:{}})},y=.51*this.maxLongitudeTriangleSize;if(Math.abs(o[0]-u)<=y){const x=Aa(o,0,o.length,u+y);return x===o.length||m(x,zc(o,x+1,o.length,u+360-y)-x),h}u<o[0]&&(u+=360);const T=zc(o,0,o.length,u-y);if(T===o.length)return m(0,o.length),h;m(0,T-0);const f=Aa(o,T+1,o.length,u+y);return f!==o.length&&m(f,o.length-f),h}}const z2=(Math.pow(256,2)-1)/16907520;class q1 extends kn{constructor(e,i,o,u){super(e,{layout:V1||(V1=new Yi({visibility:new at(ke.layout_raster.visibility)})),paint:U1||(U1=new Yi({"raster-opacity":new at(ke.paint_raster["raster-opacity"]),"raster-color":new $a(ke.paint_raster["raster-color"]),"raster-color-mix":new at(ke.paint_raster["raster-color-mix"]),"raster-color-range":new at(ke.paint_raster["raster-color-range"]),"raster-hue-rotate":new at(ke.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new at(ke.paint_raster["raster-brightness-min"]),"raster-brightness-max":new at(ke.paint_raster["raster-brightness-max"]),"raster-saturation":new at(ke.paint_raster["raster-saturation"]),"raster-contrast":new at(ke.paint_raster["raster-contrast"]),"raster-resampling":new at(ke.paint_raster["raster-resampling"]),"raster-fade-duration":new at(ke.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new at(ke.paint_raster["raster-emissive-strength"]),"raster-array-band":new at(ke.paint_raster["raster-array-band"]),"raster-elevation":new at(ke.paint_raster["raster-elevation"]),"raster-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"})}))},i,o,u),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof G1&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;const i=this._transitionablePaint._values["raster-color"].value.expression,[o,u]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(o)&&isNaN(u)||o===this._curRampRange[0]&&u===this._curRampRange[1]||(this.colorRamp=vd({expression:i,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:o,end:u}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[o,u])}}let $1,Z1,H1,W1,X1;class Y1 extends kn{constructor(e,i,o,u){super(e,{layout:$1||($1=new Yi({visibility:new at(ke["layout_raster-particle"].visibility)})),paint:Z1||(Z1=new Yi({"raster-particle-array-band":new at(ke["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new at(ke["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new $a(ke["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new at(ke["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new at(ke["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new at(ke["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new at(ke["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new at(ke["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"})}))},i,o,u),this._updateColorRamp(),this.lastInvalidatedAt=ue.now()}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-particle-color"].value.expression,i=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=vd({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:i}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=ue.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class R2 extends kn{constructor(e,i){super(e,{},i,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function cg(r,e,i){const o=[0,0,1],u=Se.quat.identity([]);return Se.quat.rotateY(u,u,i?-pi(r)+Math.PI:pi(r)),Se.quat.rotateX(u,u,-pi(e)),Se.vec3.transformQuat(o,o,u),Se.vec3.normalize(o,o)}function K1(r,e){const i=Np(r.projection,r.zoom,r.width,r.height),o=function(a,h,m,y,T){const f=new bi(m.lng-180*sl,m.lat),x=new bi(m.lng+180*sl,m.lat),w=a.project(f.lng,f.lat),g=a.project(x.lng,x.lat),v=-Math.atan2(g.y-w.y,g.x-w.x),S=n.fromLngLat(m);S.y=ri(S.y,-1+sl,1-sl);const C=S.toLngLat(),z=a.project(C.lng,C.lat),O=n.fromLngLat(C);O.x+=sl;const B=O.toLngLat(),L=a.project(B.lng,B.lat),V=Q1(L.x-z.x,L.y-z.y,v),j=n.fromLngLat(C);j.y+=sl;const W=j.toLngLat(),te=a.project(W.lng,W.lat),ee=Q1(te.x-z.x,te.y-z.y,v),Q=Math.abs(V.x)/Math.abs(ee.y),pe=Se.mat4.identity([]);Se.mat4.rotateZ(pe,pe,-v*(1-(T?0:y)));const ie=Se.mat4.identity([]);return Se.mat4.scale(ie,ie,[1,1-(1-Q)*y,1]),ie[4]=-ee.x/ee.y*y,Se.mat4.rotateZ(ie,ie,v),Se.mat4.multiply(ie,pe,ie),ie}(r.projection,0,r.center,i,e),u=J1(r);return Se.mat4.scale(o,o,[u,u,1]),o}function J1(r){const e=r.projection,i=Np(r.projection,r.zoom,r.width,r.height),o=ug(e,r.center),u=ug(e,bi.convert(e.center));return Math.pow(2,o*i+(1-i)*u)}function Np(r,e,i,o,u=1/0){const a=r.range;if(!a)return 0;const h=Math.min(u,Math.max(i,o)),m=Math.log(h/1024)/Math.LN2;return us(a[0]+m,a[1]+m,e)}const sl=1/4e4;function ug(r,e){const i=ri(e.lat,-85.051129,_r),o=new bi(e.lng-180*sl,i),u=new bi(e.lng+180*sl,i),a=r.project(o.lng,i),h=r.project(u.lng,i),m=n.fromLngLat(o),y=n.fromLngLat(u),T=h.x-a.x,f=h.y-a.y,x=y.x-m.x,w=y.y-m.y,g=Math.sqrt((x*x+w*w)/(T*T+f*f));return Math.log(g)/Math.LN2}function Q1(r,e,i){const o=Math.cos(i),u=Math.sin(i);return{x:r*o-e*u,y:r*u+e*o}}function ex(r,e,i){Se.mat4.identity(r),Se.mat4.rotateZ(r,r,pi(e[2])),Se.mat4.rotateX(r,r,pi(e[0])),Se.mat4.rotateY(r,r,pi(e[1])),Se.mat4.scale(r,r,i),Se.mat4.multiply(r,r,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function Vp(r,e,i,o,u,a,h,m){const y=[i[0]-e[0],i[1]-e[1],0],T=[o[0]-e[0],o[1]-e[1],0];if(Se.vec3.length(y)<1e-12||Se.vec3.length(T)<1e-12)return Se.quat.identity(r);const f=Se.vec3.cross([],y,T);Se.vec3.normalize(f,f),Se.vec3.subtract(T,o,e),y[2]=(a-u)*m,T[2]=(h-u)*m;const x=y;return Se.vec3.cross(x,y,T),Se.vec3.normalize(x,x),Se.quat.rotationTo(r,f,x)}function hg(r,e,i=!1){const o=gr(e.zoom),u=function(a,h,m){const y=h.worldSize,T=[a[12],a[13],a[14]],f=qn(T[1]/y),x=Tr(T[0]/y),w=Se.mat4.identity([]),g=cr(1,f)*y,v=cr(1,0)*y*Qa(f,h.zoom),S=1/er(y);let C=v*S;if(m){const L=Np(h.projection,h.zoom,h.width,h.height,1024);C=S*h.projection.pixelSpaceConversion(h.center.lat,y,L)}const z=sa(f,x);Se.vec3.add(z,z,Se.vec3.scale([],Se.vec3.normalize([],z),g*C*T[2]));const O=function(L){const V=[L[0],L[1],L[2]];let j=[0,1,0];const W=Se.vec3.cross([],j,V);return Se.vec3.cross(j,V,W),Se.vec3.squaredLength(j)===0&&(j=[0,1,0],Se.vec3.cross(W,V,j)),Se.vec3.normalize(W,W),Se.vec3.normalize(j,j),Se.vec3.normalize(V,V),[W[0],W[1],W[2],0,j[0],j[1],j[2],0,V[0],V[1],V[2],0,L[0],L[1],L[2],1]}(z);Se.mat4.scale(w,w,[C,C,C*g]),Se.mat4.translate(w,w,[-T[0],-T[1],-T[2]]);const B=Se.mat4.multiply([],h.globeMatrix,O);return Se.mat4.multiply(B,B,w),Se.mat4.multiply(B,B,a),B}(r,e,i);if(o>0){const a=function(h,m){const y=m.worldSize,T=cr(1,0)*y*Qa(m.center.lat,m.zoom)/er(y),f=cr(1,m.center.lat)*y,x=Se.mat4.identity([]);return Se.mat4.rotateY(x,x,pi(m.center.lng)),Se.mat4.rotateX(x,x,pi(m.center.lat)),Se.mat4.translate(x,x,[0,0,lr]),Se.mat4.scale(x,x,[T,T,T*f]),Se.mat4.translate(x,x,[m.point.x-.5*y,m.point.y-.5*y,0]),Se.mat4.multiply(x,x,h),Se.mat4.multiply(x,m.globeMatrix,x)}(r,e);return function(h,m,y){const T=(v,S,C)=>{const z=Se.vec3.length(v),O=Se.vec3.length(S),B=bn(v,S,C);return Se.vec3.scale(B,B,1/Se.vec3.length(B)*Gt(z,O,C))},f=T([h[0],h[1],h[2]],[m[0],m[1],m[2]],y),x=T([h[4],h[5],h[6]],[m[4],m[5],m[6]],y),w=T([h[8],h[9],h[10]],[m[8],m[9],m[10]],y),g=bn([h[12],h[13],h[14]],[m[12],m[13],m[14]],y);return[f[0],f[1],f[2],0,x[0],x[1],x[2],0,w[0],w[1],w[2],0,g[0],g[1],g[2],1]}(u,a,o)}return u}function tx(r,e,i,o){const u=Lt.projectAabbCorners(o,i);let a=Number.MAX_VALUE,h=-1;for(let T=0;T<u.length;++T){const f=u[T];f[0]=(.5*f[0]+.5)*e.width,f[1]=(.5-.5*f[1])*e.height,f[2]<a&&(h=T,a=f[2])}const m=T=>new ft(u[T][0],u[T][1]);let y;switch(h){case 0:case 6:y=[m(1),m(5),m(4),m(7),m(3),m(2),m(1)];break;case 1:case 7:y=[m(0),m(4),m(5),m(6),m(2),m(3),m(0)];break;case 3:case 5:y=[m(1),m(0),m(4),m(7),m(6),m(2),m(1)];break;default:y=[m(1),m(5),m(6),m(7),m(3),m(0),m(1)]}if(U(r,y))return a}const D2=Ii([{name:"a_pos_3f",components:3,type:"Float32"}]),L2=Ii([{name:"a_color_3f",components:3,type:"Float32"}]),k2=Ii([{name:"a_color_4f",components:4,type:"Float32"}]),O2=Ii([{name:"a_uv_2f",components:2,type:"Float32"}]),F2=Ii([{name:"a_normal_3f",components:3,type:"Float32"}]),B2=Ii([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),N2=Ii([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]),ix={None:0,Model:1,Symbol:2,FillExtrusion:4,All:7};class Up{constructor(e,i,o,u){this.message=(e?`${e}: `:"")+o,u&&(this.identifier=u),i!=null&&i.__line__&&(this.line=i.__line__)}}function nx(r,e){const i=r.indexOf("://")===-1;try{return new URL(r,i&&e?"http://example.com":void 0),!0}catch{return!1}}class rx{constructor(e,i){this.feature=e,this.instancedDataOffset=i,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class sx{constructor(){this.instancedDataArray=new Xl,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class dg{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.projection=e.projection,this.index=e.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0}updateFootprints(e,i){}populate(e,i,o,u){this.tileToMeter=t(o);const a=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:h,id:m,index:y,sourceLayerIndex:T}of e){const f=m??(h.properties&&h.properties.hasOwnProperty("id")?h.properties.id:void 0),x=R(h,a);if(!this.layers[0]._featureFilter.filter(new Vi(this.zoom),x,o))continue;const w={id:f,sourceLayerIndex:T,index:y,geometry:a?x.geometry:A(h,o,u),properties:h.properties,type:h.type,patterns:{}},g=this.addFeature(w,w.geometry,x);g&&i.featureIndex.insert(h,w.geometry,y,T,this.index,this.instancesPerModel[g].instancedDataArray.length,mt/32)}this.lookup=null}update(e,i,o,u){for(const a in this.instancesPerModel){const h=this.instancesPerModel[a];for(const m in e)h.idToFeaturesIndex.hasOwnProperty(m)&&(this.evaluate(h.features[h.idToFeaturesIndex[m]],e[m],h,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(const i in this.instancesPerModel){const o=this.instancesPerModel[i];for(const u of o.features){const a=this.layers[0],h=u.feature,m=this.canonical,y=a.paint.get("model-rotation").evaluate(h,{},m),T=a.paint.get("model-scale").evaluate(h,{},m),f=a.paint.get("model-translation").evaluate(h,{},m);Se.vec3.exactEquals(u.rotation,y)&&Se.vec3.exactEquals(u.scale,T)&&Se.vec3.exactEquals(u.translation,f)||(this.evaluate(u,u.featureStates,o,!0),e=!0)}}return e}updateReplacement(e,i,o,u){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const a=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(F_(this.activeReplacements,a))return!1;this.activeReplacements=a;let h=!1;for(const m in this.instancesPerModel){const y=this.instancesPerModel[m],T=y.instancedDataArray;for(const f of y.features){const x=f.instancedDataOffset,w=f.instancedDataCount;for(let g=0;g<w;g++){const v=16*(g+x);let S=T.float32[v+0];const C=S>mt;S=C?S-mt:S;const z=Math.floor(S),O=T.float32[v+1];let B=!1;for(const L of this.activeReplacements)if(!v0(L,o,ix.Model,u)&&!(L.min.x>z||z>L.max.x||L.min.y>O||O>L.max.y)&&(B=M0(E0(z,O,e.canonical,L.footprintTileId.canonical),L.footprint),B))break;T.float32[v]=B?S+mt:S,h=h||B!==C}}}return h}isEmpty(){for(const e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(const i in this.instancesPerModel){const o=this.instancesPerModel[i];o.instancedDataArray.length<0||o.instancedDataArray.length===0||(o.instancedDataBuffer?o.instancedDataBuffer.updateData(o.instancedDataArray):o.instancedDataBuffer=e.createVertexBuffer(o.instancedDataArray,B2.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const i in this.instancesPerModel){const o=this.instancesPerModel[i];o.instancedDataArray.length!==0&&o.instancedDataBuffer&&o.instancedDataBuffer.destroy()}const e=this.layers[0].modelManager;if(e&&this.modelUris)for(const i of this.modelUris)e.removeModel(i,"")}addFeature(e,i,o){const u=this.layers[0],a=u.layout.get("model-id").evaluate(o,{},this.canonical);if(!a)return ti(`modelId is not evaluated for layer ${u.id} and it is not going to get rendered.`),a;nx(a,!1)&&(this.modelUris.includes(a)||this.modelUris.push(a)),this.instancesPerModel[a]||(this.instancesPerModel[a]=new sx);const h=this.instancesPerModel[a],m=h.instancedDataArray,y=new rx(o,m.length);for(const T of i)for(const f of T){if(f.x<0||f.x>=mt||f.y<0||f.y>=mt)continue;const x=(this.lookupDim-1)/mt,w=this.lookupDim*(f.y*x|0)+f.x*x|0;if(this.lookup){if(this.lookup[w]!==0)continue;this.lookup[w]=1}this.instanceCount++;const g=m.length;m.resize(g+1),h.instancesEvaluatedElevation.push(0),m.float32[16*g]=f.x,m.float32[16*g+1]=f.y}return y.instancedDataCount=h.instancedDataArray.length-y.instancedDataOffset,y.instancedDataCount>0&&(e.id&&(h.idToFeaturesIndex[e.id]=h.features.length),h.features.push(y),this.evaluate(y,{},h,!1)),a}getModelUris(){return this.modelUris}evaluate(e,i,o,u){const a=this.layers[0],h=e.feature,m=this.canonical,y=e.rotation=a.paint.get("model-rotation").evaluate(h,i,m),T=e.scale=a.paint.get("model-scale").evaluate(h,i,m),f=e.translation=a.paint.get("model-translation").evaluate(h,i,m),x=a.paint.get("model-color").evaluate(h,i,m);x.a=a.paint.get("model-color-mix-intensity").evaluate(h,i,m);const w=[];this.maxVerticalOffset<f[2]&&(this.maxVerticalOffset=f[2]),this.maxScale=Math.max(Math.max(this.maxScale,T[0]),Math.max(T[1],T[2])),ex(w,y,T);const g=Math.round(100*x.a)+x.b/1.05;for(let v=0;v<e.instancedDataCount;++v){const S=e.instancedDataOffset+v,C=16*S,z=o.instancedDataArray.float32;let O=0;u&&(O=z[C+6]-o.instancesEvaluatedElevation[S]);const B=0|z[C+1];z[C]=(0|z[C])+x.r/1.05,z[C+1]=B+x.g/1.05,z[C+2]=g,z[C+3]=1/(m.z>10?this.tileToMeter:t(m,B)),z[C+4]=f[0],z[C+5]=f[1],z[C+6]=f[2]+O,z[C+7]=w[0],z[C+8]=w[1],z[C+9]=w[2],z[C+10]=w[4],z[C+11]=w[5],z[C+12]=w[6],z[C+13]=w[8],z[C+14]=w[9],z[C+15]=w[10],o.instancesEvaluatedElevation[S]=f[2]}}}let ox,ax;Mt(dg,"ModelBucket",{omit:["layers"]}),Mt(sx,"PerModelAttributes"),Mt(rx,"ModelFeature");const cc=64,Du={CoordinateSpaceTile:1,CoordinateSpaceYUp:2,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function lx(r,e,i,o,u,a,h,m,y,T=!1){const f=i.zoom,x=i.project(o),w=Qa(o.lat,f),g=1/w;Se.mat4.identity(r),Se.mat4.translate(r,r,[x.x+h[0]*g,x.y+h[1]*g,h[2]]);let v=1,S=1;const C=i.worldSize;if(T){if(i.projection.name==="mercator"){let L=0;i.elevation&&(L=i.elevation.getAtPointOrZero(new n(x.x/C,x.y/C),0));const V=Se.vec4.transformMat4([],[x.x,x.y,L,1],i.projMatrix)[3]/i.cameraToCenterDistance;v=V,S=V*Qa(i.center.lat,f)}else if(i.projection.name==="globe"){const L=hg(r,i),V=Se.mat4.multiply([],i.projMatrix,L),j=[0,0,0,1];Se.vec4.transformMat4(j,j,V);const W=j[3]/i.cameraToCenterDistance,te=gr(f),ee=i.projection.pixelsPerMeter(o.lat,C)*Qa(o.lat,f),Q=i.projection.pixelsPerMeter(i.center.lat,C)*Qa(i.center.lat,f);v=W/Gt(ee,yd(i.center.lat),te),S=W*w/ee,v*=Q,S*=Q}}else v=g;Se.mat4.scale(r,r,[v,v,S]);const z=[...r],O=e.orientation,B=[];if(ex(B,[O[0]+u[0],O[1]+u[1],O[2]+u[2]],a),Se.mat4.multiply(r,z,B),m&&i.elevation){let L=0;const V=[];if(y&&i.elevation){L=function(te,ee,Q,pe,ie){const me=ee.elevation;if(!me)return 0;const xe=Lt.projectAabbCorners(Q,pe),ye=cr(1,ie.lat)*ee.worldSize,we=function(Pt,yt){const Tt=[0,0,1],Wt=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const ei of Wt){const ii=Pt[ei.corners[0]],ni=Pt[ei.corners[1]],ci=Pt[ei.corners[2]],ui=[ni[0]-ii[0],ni[1]-ii[1],yt*(ni[2]-ii[2])],Ni=Se.vec3.cross(ui,ui,[ci[0]-ii[0],ci[1]-ii[1],yt*(ci[2]-ii[2])]);Se.vec3.normalize(Ni,Ni),ei.dotProductWithUp=Se.vec3.dot(Ni,Tt)}return Wt.sort((ei,ii)=>ei.dotProductWithUp-ii.dotProductWithUp),Wt[0].corners}(xe,ye),Ae=xe[we[0]],Re=xe[we[1]],Ee=xe[we[2]],$e=xe[we[3]],Qe=me.getAtPointOrZero(new n(Ae[0]/ee.worldSize,Ae[1]/ee.worldSize),0),qe=me.getAtPointOrZero(new n(Re[0]/ee.worldSize,Re[1]/ee.worldSize),0),_t=me.getAtPointOrZero(new n(Ee[0]/ee.worldSize,Ee[1]/ee.worldSize),0),pt=me.getAtPointOrZero(new n($e[0]/ee.worldSize,$e[1]/ee.worldSize),0),rt=(Qe+pt)/2,et=(qe+_t)/2;return rt>et?qe<_t?Vp(te,Re,$e,Ae,qe,pt,Qe,ye):Vp(te,Ee,Ae,$e,_t,Qe,pt,ye):Qe<pt?Vp(te,Ae,Re,Ee,Qe,qe,_t,ye):Vp(te,$e,Ee,Re,pt,_t,qe,ye),Math.max(rt,et)}(V,i,e.aabb,r,o);const j=Se.mat4.fromQuat([],V),W=Se.mat4.multiply([],j,B);Se.mat4.multiply(r,z,W)}else L=i.elevation.getAtPointOrZero(new n(x.x/C,x.y/C),0);L!==0&&(r[14]+=L)}}function Vd(r,e,i=!1){r.uploaded||(r.gfxTexture=new lg(e,r.image,i?e.gl.R8:e.gl.RGBA8,{useMipmap:r.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),r.uploaded=!0,r.image=null)}function V2(r,e,i){r.indexBuffer=e.createIndexBuffer(r.indexArray,!1,!0),r.vertexBuffer=e.createVertexBuffer(r.vertexArray,D2.members,!1,!0),r.normalArray&&(r.normalBuffer=e.createVertexBuffer(r.normalArray,F2.members,!1,!0)),r.texcoordArray&&(r.texcoordBuffer=e.createVertexBuffer(r.texcoordArray,O2.members,!1,!0)),r.colorArray&&(r.colorBuffer=e.createVertexBuffer(r.colorArray,(r.colorArray.bytesPerElement===12?L2:k2).members,!1,!0)),r.featureArray&&(r.pbrBuffer=e.createVertexBuffer(r.featureArray,N2.members,!0)),r.segments=an.simpleSegment(0,0,r.vertexArray.length,r.indexArray.length);const o=r.material;o.pbrMetallicRoughness.baseColorTexture&&Vd(o.pbrMetallicRoughness.baseColorTexture,e),o.pbrMetallicRoughness.metallicRoughnessTexture&&Vd(o.pbrMetallicRoughness.metallicRoughnessTexture,e),o.normalTexture&&Vd(o.normalTexture,e),o.occlusionTexture&&Vd(o.occlusionTexture,e,i),o.emissionTexture&&Vd(o.emissionTexture,e)}function fg(r,e,i){if(r.meshes)for(const o of r.meshes)V2(o,e,i);if(r.children)for(const o of r.children)fg(o,e,i)}function jp(r){if(r.meshes)for(const e of r.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(r.children)for(const e of r.children)jp(e)}function pg(r){if(r.meshes)for(const i of r.meshes)i.vertexBuffer&&(i.vertexBuffer.destroy(),i.indexBuffer.destroy(),i.normalBuffer&&i.normalBuffer.destroy(),i.texcoordBuffer&&i.texcoordBuffer.destroy(),i.colorBuffer&&i.colorBuffer.destroy(),i.pbrBuffer&&i.pbrBuffer.destroy(),i.segments.destroy(),i.material&&((e=i.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(r.children)for(const i of r.children)pg(i)}class Lu{constructor(e,i,o){this._demTile=e,this._dem=this._demTile.dem,this._scale=i,this._offset=o}static create(e,i,o){const u=o||e.findDEMTileFor(i);if(!u||!u.dem)return;const a=u.dem,h=u.tileID,m=1<<i.canonical.z-h.canonical.z;return new Lu(u,a.dim/mt/m,[(i.canonical.x/m-h.canonical.x)*a.dim,(i.canonical.y/m-h.canonical.y)*a.dim])}tileCoordToPixel(e,i){const o=i*this._scale+this._offset[1],u=Math.floor(e*this._scale+this._offset[0]),a=Math.floor(o);return new ft(u,a)}getElevationAt(e,i,o,u){const a=e*this._scale+this._offset[0],h=i*this._scale+this._offset[1],m=Math.floor(a),y=Math.floor(h),T=this._dem;return u=!!u,o?Gt(Gt(T.get(m,y,u),T.get(m,y+1,u),h-y),Gt(T.get(m+1,y,u),T.get(m+1,y+1,u),h-y),a-m):T.get(m,y,u)}getElevationAtPixel(e,i,o){return this._dem.get(e,i,!!o)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*cr(1,e)*this._dem.stride}}const mg=new Float32Array(262144),uc=new Uint8Array(262144);function cx(r){let e=0;if(r.meshes)for(const i of r.meshes)e=Math.max(e,i.aabb.max[2]);if(r.children)for(const i of r.children)e=Math.max(e,cx(i));return e}function ux(r,e,i){if(r.meshes)for(const o of r.meshes){if(o.aabb.min[0]===1/0)continue;const u=Lt.applyTransform(o.aabb,r.matrix);i.insert(e,u.min[0],u.min[1],u.max[0],u.max[1])}if(r.children)for(const o of r.children)ux(o,e,i)}const hx=["","wall","door","roof","window","lamp","logo"];class dx{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:cx(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new Lt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0;const i=new Lt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const o of this.node.meshes)this.node.lightMeshIndex!==e&&(o.transformedAabb=Lt.applyTransformFast(o.aabb,this.node.matrix),i.encapsulate(o.transformedAabb)),e++;this.aabb=i}return this.aabb}}class Gp{constructor(e,i,o,u,a,h,m){this.id=o,this.layers=e,this.layerIds=this.layers.map(y=>y.fqid),this.stateDependentLayerIds=this.layers.filter(y=>y.isStateDependent()).map(y=>y.id),this.modelTraits|=Du.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,u&&(this.modelTraits|=Du.HasMapboxMeshFeatures),a&&(this.modelTraits|=Du.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=h,this.dirty=!0,this.needsUpload=!1,this.nodesInfo=[];for(const y of i)this.nodesInfo.push(new dx(y)),ux(y,m.featureIndexArray.length,m.grid),m.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,m.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(e,i){for(const o of this.getNodesInfo()){const u=o.node;u.footprint&&i.push({footprint:u.footprint,id:e})}}update(e){const i=Object.keys(e).length!==0;if(i&&!this.stateDependentLayers.length)return;const o=i?this.stateDependentLayers:this.layers;if(!rr(e,this.states))for(const u of o)this.evaluate(u,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;const i=this.getNodesInfo();for(const o of i){const u=o.node;this.uploaded?this.updatePbrBuffer(u):fg(u,e,!0)}for(const o of i)jp(o.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let i=!1;if(!e.meshes)return i;for(const o of e.meshes)o.pbrBuffer&&(o.pbrBuffer.updateData(o.featureArray),i=!0);return i}needsReEvaluation(e,i,o){const u=e.transform.projectionOptions,a=e.style.getBrightness(),h=this.brightness!==a;if(!this.uploaded||this.dirty||u.name!==this.projection.name||Ud(o.paint.get("model-color").value,h)||Ud(o.paint.get("model-color-mix-intensity").value,h)||Ud(o.paint.get("model-roughness").value,h)||Ud(o.paint.get("model-emissive-strength").value,h)||Ud(o.paint.get("model-height-based-emissive-strength-multiplier").value,h)){this.projection=u,this.brightness=a;const m=this.getNodesInfo();for(const y of m)y.state=null;return!0}return!1}evaluateScale(e,i){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;const o=this.getNodesInfo(),u=this.id.canonical;for(const a of o){const h=a.feature;a.evaluatedScale=i.paint.get("model-scale").evaluate(h,{},u)}}evaluate(e,i){const o=this.getNodesInfo();for(const u of o){if(!u.node.meshes)continue;const a=u.feature,h=i&&i[a.id];if(rr(h,u.state))continue;u.state=structuredClone(h);const m=u.node.meshes&&u.node.meshes[0].featureData,y=u.evaluatedColor[2],T=u.evaluatedRMEA[2],f=this.id.canonical;if(u.hasTranslucentParts=!1,m){for(let x=0;x<hx.length;x++){const w=hx[x];w.length&&(a.properties.part=w);const g=e.paint.get("model-color").evaluate(a,h,f).toRenderColor(null),v=e.paint.get("model-color-mix-intensity").evaluate(a,h,f);u.evaluatedColor[x]=[g.r,g.g,g.b,v],u.evaluatedRMEA[x][0]=e.paint.get("model-roughness").evaluate(a,h,f),u.evaluatedRMEA[x][2]=e.paint.get("model-emissive-strength").evaluate(a,h,f),u.evaluatedRMEA[x][3]=g.a,u.emissionHeightBasedParams[x]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(a,h,f),!u.hasTranslucentParts&&g.a<1&&(u.hasTranslucentParts=!0)}delete a.properties.part,j2(u,y!==u.evaluatedColor[2]||T!==u.evaluatedRMEA[2],this.modelTraits)}else u.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(a,h,f);u.evaluatedScale=e.paint.get("model-scale").evaluate(a,h,f),this.updatePbrBuffer(u.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,i,o,u){const a=e.findDEMTileFor(o);if(a&&(a.tileID.canonical!==this.terrainTile||i!==this.terrainExaggeration)){if(a.dem&&a.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=a.tileID.overscaledZ;const h=Lu.create(e,o,a);if(!h)return;this.modelTraits&Du.HasMapboxMeshFeatures&&this.updateDEM(e,h,o,u);for(const m of this.getNodesInfo()){const y=m.node;if(!y.footprint||!y.footprint.vertices||!y.footprint.vertices.length)continue;const T=y.footprint.vertices;let f=h.getElevationAt(T[0].x,T[0].y,!0,!0);for(let x=1;x<T.length;x++)f=Math.min(f,h.getElevationAt(T[x].x,T[x].y,!0,!0));y.elevation=f}}this.terrainTile=a.tileID.canonical,this.terrainExaggeration=i}}updateDEM(e,i,o,u){let a=i._dem._modifiedForSources[u];if(a===void 0&&(i._dem._modifiedForSources[u]=[],a=i._dem._modifiedForSources[u]),a.includes(o.canonical))return;const h=i._dem.dim;a.push(o.canonical);let m=!1;for(const y of this.getNodesInfo()){const T=y.node;if(!T.footprint||!T.footprint.grid)continue;const f=T.footprint.grid,x=i.tileCoordToPixel(f.min.x,f.min.y),w=i.tileCoordToPixel(f.max.x,f.max.y),g=Math.min(Math.min(h-w.y,x.x),Math.min(x.y,h-w.x));if(g<0)continue;const v=ri(g,2,5);let S=Math.max(0,x.x-v),C=Math.max(0,x.y-v),z=Math.min(w.x+v,h-1),O=Math.min(w.y+v,h-1);for(let j=C;j<=O;++j)for(let W=S;W<=z;++W)uc[j*h+W]=255;let B=0,L=0;for(let j=0;j<f.cellsY;++j)for(let W=0;W<f.cellsX;++W){if(!f.cells[j*f.cellsX+W])continue;const te=i.tileCoordToPixel(f.min.x+W/f.xScale,f.min.y+j/f.yScale),ee=i.tileCoordToPixel(f.min.x+(W+1)/f.xScale,f.min.y+(j+1)/f.yScale);for(let Q=te.y;Q<=Math.min(ee.y+1,h-1);++Q)for(let pe=te.x;pe<=Math.min(ee.x+1,h-1);++pe)uc[Q*h+pe]===255&&(uc[Q*h+pe]=0,B+=i.getElevationAtPixel(pe,Q),L++)}const V=B/L;S=Math.max(1,x.x-v),C=Math.max(1,x.y-v),z=Math.min(w.x+v,h-2),O=Math.min(w.y+v,h-2),m=!0;for(let j=C;j<=O;++j)for(let W=S;W<=z;++W)uc[j*h+W]===0&&(mg[j*h+W]=i._dem.set(W,j,V));for(let j=1;j<v;++j){S=Math.max(1,x.x-j),C=Math.max(1,x.y-j),z=Math.min(w.x+j,h-2),O=Math.min(w.y+j,h-2);for(let W=C;W<=O;++W)for(let te=S;te<=z;++te){const ee=W*h+te;if(uc[ee]===255){let Q=0,pe=0,ie=-1,me=-1;for(let xe=-1;xe<=1;++xe)for(let ye=-1;ye<=1;++ye){const we=(W+xe)*h+te+ye;if(uc[we]>=j)continue;const Ae=mg[we],Re=Math.abs(Ae);Re>pe&&(Q=Ae,pe=Re,ie=ye,me=xe)}if(pe>.1){const xe=1-(j+.5*Math.abs(ie*me))/v;let ye=i._dem.get(te,W)+Q*xe;const we=i._dem.get(te+ie,W+me),Ae=i._dem.get(te-ie,W-me,!0);(ye-we)*(ye-Ae)>0&&(ye=(we+Ae)/2),mg[ee]=i._dem.set(te,W,ye),uc[ee]=j}}}}}m&&(i._demTile.needsDEMTextureUpload=!0,i._dem._timestamp=ue.now())}getNodesInfo(){return this.nodesInfo}destroy(){const e=this.getNodesInfo();for(const i of e)jp(i.node),pg(i.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const o=i.getReplacementRegionsForTile(e.toUnwrapped()),u=this.getNodesInfo();for(let a=0;a<this.nodesInfo.length;a++){const h=u[a].node;u[a].hiddenByReplacement=!!h.footprint&&!o.find(m=>m.footprint===h.footprint)}}getHeightAtTileCoord(e,i){const o=this.getNodesInfo(),u=[],a=[0,0,0],h=Se.mat4.identity([]);for(let m=0;m<this.nodesInfo.length;m++){const y=o[m],T=y.node.meshes[0],f=T.transformedAabb;if(e<f.min[0]||i<f.min[1]||e>f.max[0]||i>f.max[1])continue;if(y.node.hidden===!0)return{height:1/0,maxHeight:y.feature.properties.height,hidden:!1,verticalScale:y.evaluatedScale[2]};Se.mat4.invert(h,y.node.matrix),a[0]=e,a[1]=i,Se.vec3.transformMat4(a,a,h);const x=(a[0]-T.aabb.min[0])/(T.aabb.max[0]-T.aabb.min[0])*cc|0,w=Math.min(63,(a[1]-T.aabb.min[1])/(T.aabb.max[1]-T.aabb.min[1])*cc|0)*cc+Math.min(63,x),g=T.heightmap[w];if(!(g<0&&y.node.footprint))return y.hiddenByReplacement?void 0:{height:g,maxHeight:y.feature.properties.height,hidden:!1,verticalScale:y.evaluatedScale[2]};if(y.node.footprint.grid.query(new ft(e,i),new ft(e,i),u),u.length>0)return{height:void 0,maxHeight:y.feature.properties.height,hidden:y.hiddenByReplacement,verticalScale:y.evaluatedScale[2]}}}}function Ud(r,e){return!r.isLightConstant&&e}function U2(r,e,i,o,u,a,h,m){let y=(61440&e|(61440&e)>>4)>>8,T=(3840&e|(3840&e)>>4)>>4,f=240&e|(240&e)>>4;i[3]>0&&(y=Gt(y,255*i[0],i[3]),T=Gt(T,255*i[1],i[3]),f=Gt(f,255*i[2],i[3]));const x=y<<8|T,w=f<<8|Math.floor(255*o[3]),g=function(j){const W=ri(j,0,2);return Math.min(Math.round(.5*W*255),255)}(o[2])<<8|15*o[0]<<4|15*o[1],v=ri(u[0],0,1),S=ri(u[1],0,1),C=ri(u[2],0,1),z=ri(u[3],0,1);let O,B,L,V;if(v!==S&&h!==a&&S!==v){const j=h-a;B=1/(j*(S-v)),L=-(a+j*v)/(j*(S-v));const W=ri(u[4],-1,1);V=Math.pow(10,W),O=255*C<<8|255*z}else O=65535,B=0,L=1,V=1;if(r.emplaceBack(x,w,g,O,B,L,V),m){const j=m.length;m.clear();for(let W=0;W<j;W++)m.emplaceBack(x,w,g,O,B,L,V)}}function j2(r,e,i){const o=r.node;let u=0;const a=i&Du.HasMeshoptCompression;for(const h of o.meshes){if(o.lights&&o.lightMeshIndex===u||!h.featureData)continue;h.featureArray=new Yl,h.featureArray.reserve(h.featureData.length);let m=e;for(const y of h.featureData){const T=a?65535&y:y>>16&65535,f=a?y>>16&65535:65535&y,x=(15&f)<8?15&f:0,w=r.evaluatedRMEA[x],g=r.evaluatedColor[x],v=r.emissionHeightBasedParams[x];let S;if(m&&x===2&&o.lights&&(S=new Yl,S.resize(10*o.lights.length)),U2(h.featureArray,T,g,w,v,h.aabb.min[2],h.aabb.max[2],S),S&&m){m=!1;const C=o.meshes[o.lightMeshIndex];C.featureArray=S,C.featureArray._trim()}}h.featureArray._trim(),u++}}function fx(r,e,i,o){const u=1<<r.z;e.lat=qn((o/mt+r.y)/u),e.lng=Tr((i/mt+r.x)/u)}Mt(Gp,"Tiled3dModelBucket",{omit:["layers"]}),Mt(dx,"Tiled3dModelFeature");const G2={circle:class extends kn{constructor(r,e,i,o){super(r,{layout:it||(it=new Yi({"circle-sort-key":new wt(ke.layout_circle["circle-sort-key"]),"circle-elevation-reference":new at(ke.layout_circle["circle-elevation-reference"]),visibility:new at(ke.layout_circle.visibility)})),paint:Ce||(Ce=new Yi({"circle-radius":new wt(ke.paint_circle["circle-radius"]),"circle-color":new wt(ke.paint_circle["circle-color"]),"circle-blur":new wt(ke.paint_circle["circle-blur"]),"circle-opacity":new wt(ke.paint_circle["circle-opacity"]),"circle-translate":new at(ke.paint_circle["circle-translate"]),"circle-translate-anchor":new at(ke.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new at(ke.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new at(ke.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new wt(ke.paint_circle["circle-stroke-width"]),"circle-stroke-color":new wt(ke.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new wt(ke.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new at(ke.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}createBucket(r){return new q(r)}queryRadius(r){const e=r;return He("circle-radius",this,e)+He("circle-stroke-width",this,e)+Ze(this.paint.get("circle-translate"))}queryIntersectsFeature(r,e,i,o,u,a,h,m){const y=je(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),a.angle,r.pixelToTileUnitsFactor),T=this.paint.get("circle-radius").evaluate(e,i)+this.paint.get("circle-stroke-width").evaluate(e,i);return Eu(r,o,a,h,m,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",y,T)}getProgramIds(){return["circle"]}getDefaultProgramParams(r,e,i){const o=el(this);return{config:new ra(this,{zoom:e,lut:i}),defines:o,overrideFog:!1}}},heatmap:class extends kn{createBucket(r){return new Zy(r)}constructor(r,e,i,o){super(r,{layout:Hy||(Hy=new Yi({visibility:new at(ke.layout_heatmap.visibility)})),paint:Wy||(Wy=new Yi({"heatmap-radius":new wt(ke.paint_heatmap["heatmap-radius"]),"heatmap-weight":new wt(ke.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new at(ke.paint_heatmap["heatmap-intensity"]),"heatmap-color":new $a(ke.paint_heatmap["heatmap-color"]),"heatmap-opacity":new at(ke.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(r){r==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=vd({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(r){return He("heatmap-radius",this,r)}queryIntersectsFeature(r,e,i,o,u,a,h,m){const y=this.paint.get("heatmap-radius").evaluate(e,i);return Eu(r,o,a,h,m,!0,!0,new ft(0,0),y)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(r,e,i){return r==="heatmap"?{config:new ra(this,{zoom:e,lut:i}),overrideFog:!1}:{}}},hillshade:class extends kn{constructor(r,e,i,o){super(r,{layout:Xy||(Xy=new Yi({visibility:new at(ke.layout_hillshade.visibility)})),paint:Yy||(Yy=new Yi({"hillshade-illumination-direction":new at(ke.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new at(ke.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new at(ke.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new at(ke.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new at(ke.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new at(ke.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new at(ke.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(r,e,i){return{overrideFog:!1}}},fill:class extends kn{constructor(r,e,i,o){super(r,{layout:s0||(s0=new Yi({"fill-sort-key":new wt(ke.layout_fill["fill-sort-key"]),visibility:new at(ke.layout_fill.visibility),"fill-elevation-reference":new at(ke.layout_fill["fill-elevation-reference"])})),paint:o0||(o0=new Yi({"fill-antialias":new at(ke.paint_fill["fill-antialias"]),"fill-opacity":new wt(ke.paint_fill["fill-opacity"]),"fill-color":new wt(ke.paint_fill["fill-color"]),"fill-outline-color":new wt(ke.paint_fill["fill-outline-color"]),"fill-translate":new at(ke.paint_fill["fill-translate"]),"fill-translate-anchor":new at(ke.paint_fill["fill-translate-anchor"]),"fill-pattern":new wt(ke.paint_fill["fill-pattern"]),"fill-emissive-strength":new at(ke.paint_fill["fill-emissive-strength"]),"fill-z-offset":new wt(ke.paint_fill["fill-z-offset"]),"fill-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}getProgramIds(){const r=this.paint.get("fill-pattern"),e=r&&r.constantOr(1),i=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i}getDefaultProgramParams(r,e,i){return{config:new ra(this,{zoom:e,lut:i}),overrideFog:!1}}recalculate(r,e){super.recalculate(r,e);const i=this.paint._values["fill-outline-color"];i.value.kind==="constant"&&i.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(r){return new z_(r)}queryRadius(){return Ze(this.paint.get("fill-translate"))}queryIntersectsFeature(r,e,i,o,u,a){return!r.queryGeometry.isAboveHorizon&&Z(ze(r.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),a.angle,r.pixelToTileUnitsFactor),o)}isTileClipped(){return!0}is3D(){return this.paint.get("fill-z-offset").constantOr(1)!==0}},"fill-extrusion":class extends kn{constructor(r,e,i,o){super(r,{layout:U0||(U0=new Yi({visibility:new at(ke["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new at(ke["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:j0||(j0=new Yi({"fill-extrusion-opacity":new at(ke["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new wt(ke["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new at(ke["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new at(ke["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new wt(ke["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new wt(ke["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new wt(ke["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new at(ke["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new at(ke["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new at(ke["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new at(ke["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new at(ke["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new at(ke["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new at(ke["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new at(ke["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new at(ke["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new at(ke["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new wt(ke["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new wt(ke["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new at(ke["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new at(ke["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new at(ke["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new at(ke["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new wt(ke["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new wt(ke["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new at(ke["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new xp(r)}queryRadius(){return Ze(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(r,e,i,o,u,a,h,m,y){const T=je(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),a.angle,r.pixelToTileUnitsFactor),f=this.paint.get("fill-extrusion-height").evaluate(e,i),x=this.paint.get("fill-extrusion-base").evaluate(e,i),w=[0,0],g=m&&a.elevation,v=a.elevation?a.elevation.exaggeration():1,S=r.tile.getBucket(this);if(g&&S instanceof xp){const L=S.centroidVertexArray,V=y+1;V<L.length&&(w[0]=L.geta_centroid_pos0(V),w[1]=L.geta_centroid_pos1(V))}if(w[0]===0&&w[1]===1)return!1;a.projection.name==="globe"&&(o=V0([o],[new ft(0,0),new ft(mt,mt)],r.tileID.canonical).map(L=>L.polygon).flat());const C=g?m:null,[z,O]=function(L,V,j,W,te,ee,Q,pe,ie,me,xe){return L.projection.name==="globe"?function(ye,we,Ae,Re,Ee,$e,Qe,qe,_t,pt,rt){const et=[],Pt=[],yt=ye.projection.upVectorScale(rt,ye.center.lat,ye.worldSize).metersToTile,Tt=[0,0,0,1],Wt=[0,0,0,1],ei=(ni,ci,ui,Ni)=>{ni[0]=ci,ni[1]=ui,ni[2]=Ni,ni[3]=1},ii=N0();Ae>0&&(Ae+=ii),Re+=ii;for(const ni of we){const ci=[],ui=[];for(const Ni of ni){const Di=Ni.x+Ee.x,Kt=Ni.y+Ee.y,Pi=ye.projection.projectTilePoint(Di,Kt,rt),Ri=ye.projection.upVector(rt,Ni.x,Ni.y);let Hi=Ae,un=Re;if(Qe){const Tn=q0(Di,Kt,Ae,Re,Qe,qe,_t,pt);Hi+=Tn.base,un+=Tn.top}Ae!==0?ei(Tt,Pi.x+Ri[0]*yt*Hi,Pi.y+Ri[1]*yt*Hi,Pi.z+Ri[2]*yt*Hi):ei(Tt,Pi.x,Pi.y,Pi.z),ei(Wt,Pi.x+Ri[0]*yt*un,Pi.y+Ri[1]*yt*un,Pi.z+Ri[2]*yt*un),Se.vec3.transformMat4(Tt,Tt,$e),Se.vec3.transformMat4(Wt,Wt,$e),ci.push(new ac(Tt[0],Tt[1],Tt[2])),ui.push(new ac(Wt[0],Wt[1],Wt[2]))}et.push(ci),Pt.push(ui)}return[et,Pt]}(L,V,j,W,te,ee,Q,pe,ie,me,xe):Q?function(ye,we,Ae,Re,Ee,$e,Qe,qe,_t){const pt=[],rt=[],et=[0,0,0,1];for(const Pt of ye){const yt=[],Tt=[];for(const Wt of Pt){const ei=Wt.x+Re.x,ii=Wt.y+Re.y,ni=q0(ei,ii,we,Ae,$e,Qe,qe,_t);et[0]=ei,et[1]=ii,et[2]=ni.base,et[3]=1,Se.vec4.transformMat4(et,et,Ee),et[3]=Math.max(et[3],1e-5);const ci=new ac(et[0]/et[3],et[1]/et[3],et[2]/et[3]);et[0]=ei,et[1]=ii,et[2]=ni.top,et[3]=1,Se.vec4.transformMat4(et,et,Ee),et[3]=Math.max(et[3],1e-5);const ui=new ac(et[0]/et[3],et[1]/et[3],et[2]/et[3]);yt.push(ci),Tt.push(ui)}pt.push(yt),rt.push(Tt)}return[pt,rt]}(V,j,W,te,ee,Q,pe,ie,me):function(ye,we,Ae,Re,Ee){const $e=[],Qe=[],qe=Ee[8]*we,_t=Ee[9]*we,pt=Ee[10]*we,rt=Ee[11]*we,et=Ee[8]*Ae,Pt=Ee[9]*Ae,yt=Ee[10]*Ae,Tt=Ee[11]*Ae;for(const Wt of ye){const ei=[],ii=[];for(const ni of Wt){const ci=ni.x+Re.x,ui=ni.y+Re.y,Ni=Ee[0]*ci+Ee[4]*ui+Ee[12],Di=Ee[1]*ci+Ee[5]*ui+Ee[13],Kt=Ee[2]*ci+Ee[6]*ui+Ee[14],Pi=Ee[3]*ci+Ee[7]*ui+Ee[15],Ri=Ni+qe,Hi=Di+_t,un=Kt+pt,Tn=Math.max(Pi+rt,1e-5),hn=Ni+et,rn=Di+Pt,mn=Kt+yt,An=Math.max(Pi+Tt,1e-5);ei.push(new ac(Ri/Tn,Hi/Tn,un/Tn)),ii.push(new ac(hn/An,rn/An,mn/An))}$e.push(ei),Qe.push(ii)}return[$e,Qe]}(V,j,W,te,ee)}(a,o,x,f,T,h,C,w,v,a.center.lat,r.tileID.canonical),B=r.queryGeometry;return function(L,V,j){let W=1/0;Z(j,V)&&(W=G0(j,V[0]));for(let te=0;te<V.length;te++){const ee=V[te],Q=L[te];for(let pe=0;pe<ee.length-1;pe++){const ie=ee[pe],me=[ie,ee[pe+1],Q[pe+1],Q[pe],ie];U(j,me)&&(W=Math.min(W,G0(j,me)))}}return W!==1/0&&W}(z,O,B.isPointQuery()?B.screenBounds:B.screenGeometry)}},line:class extends kn{constructor(r,e,i,o){const u=e1();super(r,u,e,i,o),u.layout&&(this.layout=new qa(u.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(r){if(r==="line-gradient"){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof La,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(r,e){super.recalculate(r,e),this.paint._values["line-floorwidth"]=(()=>{if(Cd)return Cd;const i=e1();return Cd=new $w(i.paint.properties["line-width"].specification),Cd.useIntegerZoom=!0,Cd})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,r)}createBucket(r){return new U_(r)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(r,e,i){const o=J0(this);return{config:new ra(this,{zoom:e,lut:i}),defines:o,overrideFog:!1}}queryRadius(r){const e=r,i=t1(He("line-width",this,e),He("line-gap-width",this,e)),o=He("line-offset",this,e);return i/2+Math.abs(o)+Ze(this.paint.get("line-translate"))}queryIntersectsFeature(r,e,i,o,u,a){if(r.queryGeometry.isAboveHorizon)return!1;const h=ze(r.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),a.angle,r.pixelToTileUnitsFactor),m=r.pixelToTileUnitsFactor/2*t1(this.paint.get("line-width").evaluate(e,i),this.paint.get("line-gap-width").evaluate(e,i)),y=this.paint.get("line-offset").evaluate(e,i);return y&&(o=function(T,f){const x=[],w=new ft(0,0);for(let g=0;g<T.length;g++){const v=T[g],S=[];for(let C=0;C<v.length;C++){const z=v[C],O=v[C+1],B=C===0?w:z.sub(v[C-1])._unit()._perp(),L=C===v.length-1?w:O.sub(z)._unit()._perp(),V=B._add(L)._unit();V._mult(1/(V.x*L.x+V.y*L.y)),S.push(V._mult(f)._add(z))}x.push(S)}return x}(o,y*r.pixelToTileUnitsFactor)),function(T,f,x){for(let w=0;w<f.length;w++){const g=f[w];if(T.length>=3){for(let v=0;v<g.length;v++)if(ae(T,g[v]))return!0}if(J(T,g,x))return!0}return!1}(h,o,m)}isTileClipped(){return!0}isDraped(r){return!this.hasElevatedBuckets}},symbol:kp,background:class extends kn{constructor(r,e,i,o){super(r,{layout:B1||(B1=new Yi({visibility:new at(ke.layout_background.visibility)})),paint:N1||(N1=new Yi({"background-pitch-alignment":new at(ke.paint_background["background-pitch-alignment"]),"background-color":new at(ke.paint_background["background-color"]),"background-pattern":new at(ke.paint_background["background-pattern"]),"background-opacity":new at(ke.paint_background["background-opacity"]),"background-emissive-strength":new at(ke.paint_background["background-emissive-strength"]),"background-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(r,e,i){return{overrideFog:!1}}is3D(){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:q1,"raster-particle":Y1,sky:class extends kn{constructor(r,e,i,o){super(r,{layout:H1||(H1=new Yi({visibility:new at(ke.layout_sky.visibility)})),paint:W1||(W1=new Yi({"sky-type":new at(ke.paint_sky["sky-type"]),"sky-atmosphere-sun":new at(ke.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new at(ke.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new at(ke.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new at(ke.paint_sky["sky-gradient-radius"]),"sky-gradient":new $a(ke.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new at(ke.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new at(ke.paint_sky["sky-atmosphere-color"]),"sky-opacity":new at(ke.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(r){r==="sky-gradient"?this._updateColorRamp():r!=="sky-atmosphere-sun"&&r!=="sky-atmosphere-halo-color"&&r!=="sky-atmosphere-color"&&r!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=vd({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(r){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=r.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(r,e){if(this.paint.get("sky-type")==="atmosphere"){const o=this.paint.get("sky-atmosphere-sun"),u=!o,a=r.style.light,h=a.properties.get("position");return u&&a.properties.get("anchor")==="viewport"&&ti("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),u?cg(h.azimuthal,90-h.polar,e):cg(o[0],90-o[1],e)}const i=this.paint.get("sky-gradient-center");return cg(i[0],90-i[1],e)}isSky(){return!0}markSkyboxValid(r){this._skyboxInvalidated=!1,this._lightPosition=r.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const r=this.paint.get("sky-type");return r==="atmosphere"?["skyboxCapture","skybox"]:r==="gradient"?["skyboxGradient"]:null}},slot:class extends kn{constructor(r,e,i,o){super(r,{paint:X1||(X1=new Yi({}))},e,null)}},model:class extends kn{constructor(r,e,i,o){super(r,{layout:ox||(ox=new Yi({visibility:new at(ke.layout_model.visibility),"model-id":new wt(ke.layout_model["model-id"])})),paint:ax||(ax=new Yi({"model-opacity":new wt(ke.paint_model["model-opacity"]),"model-rotation":new wt(ke.paint_model["model-rotation"]),"model-scale":new wt(ke.paint_model["model-scale"]),"model-translation":new wt(ke.paint_model["model-translation"]),"model-color":new wt(ke.paint_model["model-color"]),"model-color-mix-intensity":new wt(ke.paint_model["model-color-mix-intensity"]),"model-type":new at(ke.paint_model["model-type"]),"model-cast-shadows":new at(ke.paint_model["model-cast-shadows"]),"model-receive-shadows":new at(ke.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new at(ke.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new wt(ke.paint_model["model-emissive-strength"]),"model-roughness":new wt(ke.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new wt(ke.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new at(ke.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new at(ke.paint_model["model-front-cutoff"]),"model-color-use-theme":new wt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new dg(r)}getProgramIds(){return["model"]}is3D(){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(r){return r instanceof Gp?mt-1:0}queryIntersectsFeature(r,e,i,o,u,a){if(!this.modelManager)return!1;const h=this.modelManager,m=r.tile.getBucket(this);if(!(m&&m instanceof dg))return!1;for(const y in m.instancesPerModel){const T=m.instancesPerModel[y],f=e.id!==void 0?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(T.idToFeaturesIndex.hasOwnProperty(f)){const x=T.features[T.idToFeaturesIndex[f]],w=h.getModel(y,this.scope);if(!w)return!1;let g=Se.mat4.create();const v=new bi(0,0),S=m.canonical;let C=Number.MAX_VALUE;for(let z=0;z<x.instancedDataCount;++z){const O=16*(x.instancedDataOffset+z),B=T.instancedDataArray.float32,L=[B[O+4],B[O+5],B[O+6]];fx(S,v,B[O],0|B[O+1]),lx(g,w,a,v,x.rotation,x.scale,L,!1,!1,!1),a.projection.name==="globe"&&(g=hg(g,a));const V=Se.mat4.multiply([],a.projMatrix,g),j=r.queryGeometry,W=tx(j.isPointQuery()?j.screenBounds:j.screenGeometry,a,V,w.aabb);W!=null&&(C=Math.min(W,C))}return C!==Number.MAX_VALUE&&C}}return!1}_handleOverridablePaintPropertyUpdate(r,e,i){return!(!this.layout||e.isDataDriven()||i.isDataDriven()||r!=="model-color"&&r!=="model-color-mix-intensity"&&r!=="model-rotation"&&r!=="model-scale"&&r!=="model-translation"&&r!=="model-emissive-strength")}_isPropertyZoomDependent(r){const e=this._transitionablePaint._values[r];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof Bl}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends kn{constructor(r,e,i,o){super(r,{layout:a0||(a0=new Yi({"clip-layer-types":new at(ke.layout_clip["clip-layer-types"]),"clip-layer-scope":new at(ke.layout_clip["clip-layer-scope"])})),paint:l0||(l0=new Yi({}))},e,i,o)}recalculate(r,e){super.recalculate(r,e)}createBucket(r){return new c0(r)}isTileClipped(){return!0}is3D(){return!0}}};class q2{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class $2{constructor(){this.tasks={},this.taskQueue=[],wa(["process"],this),this.invoker=new q2(this.process),this.nextId=0}add(e,i){const o=this.nextId++,u=function({type:a,isSymbolTile:h,zoom:m}){return m=m||0,a==="message"?0:a!=="maybePrepare"||h?a!=="parseTile"||h?a==="parseTile"&&h?300-m:a==="maybePrepare"&&h?400-m:500:200-m:100-m}(i);if(u===0){try{e()}finally{}return null}return this.tasks[o]={fn:e,metadata:i,priority:u,id:o},this.taskQueue.push(o),this.invoker.trigger(),{cancel:()=>{delete this.tasks[o]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(o=>!!this.tasks[o]),!this.taskQueue.length)return;const e=this.pick();if(e===null)return;const i=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!i)return;i.fn()}finally{}}pick(){let e=null,i=1/0;for(let u=0;u<this.taskQueue.length;u++){const a=this.tasks[this.taskQueue[u]];a.priority<i&&(i=a.priority,e=u)}if(e===null)return null;const o=this.taskQueue[e];return this.taskQueue.splice(e,1),o}remove(){this.invoker.remove()}}class px{constructor(e,i,o){this.target=e,this.parent=i,this.mapId=o,this.callbacks={},this.cancelCallbacks={},wa(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new $2}send(e,i,o,u,a=!1,h){const m=Math.round(1e18*Math.random()).toString(36).substring(0,10);o&&(o.metadata=h,this.callbacks[m]=o);const y=new Set;return this.target.postMessage({id:m,type:e,hasCallback:!!o,targetMapId:u,mustQueue:a,sourceMapId:this.mapId,data:_o(i,y)},y),{cancel:()=>{o&&delete this.callbacks[m],this.target.postMessage({id:m,type:"<cancel>",targetMapId:u,sourceMapId:this.mapId})}}}receive(e){const i=e.data,o=i.id;if(o&&(!i.targetMapId||this.mapId===i.targetMapId))if(i.type==="<cancel>"){const u=this.cancelCallbacks[o];delete this.cancelCallbacks[o],u&&u.cancel()}else if(i.mustQueue||Us()){const u=this.callbacks[o],a=this.scheduler.add(()=>this.processTask(o,i),u&&u.metadata||{type:"message"});a&&(this.cancelCallbacks[o]=a)}else this.processTask(o,i)}processTask(e,i){if(delete this.cancelCallbacks[e],i.type==="<response>"){const o=this.callbacks[e];delete this.callbacks[e],o&&(i.error?o(Qo(i.error)):o(null,Qo(i.data)))}else{const o=new Set,u=i.hasCallback?(h,m)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:h?_o(h):null,data:_o(m,o)},o)}:()=>{},a=Qo(i.data);if(this.parent[i.type])this.parent[i.type](i.sourceMapId,a,u);else if(this.parent.getWorkerSource){const h=i.type.split(".");this.parent.getWorkerSource(i.sourceMapId,h[0],a.source,a.scope)[h[1]](a,u)}else u(new Error(`Could not find function ${i.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var jd={workerUrl:"",workerClass:null,workerParams:void 0};const _g="mapboxgl_preloaded_worker_pool";class hc{constructor(){this.active={}}acquire(e,i=hc.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<i;)this.workers.push(jd.workerClass!=null?new jd.workerClass:new self.Worker(jd.workerUrl,jd.workerParams));return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.workers&&this.numActive()===0&&(this.workers.forEach(i=>{i.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[_g]}numActive(){return Object.keys(this.active).length}}hc.workerCount=2;class ku{constructor(e,i,o="Worker",u=hc.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=Bo();const a=this.workerPool.acquire(this.id,u);for(let h=0;h<a.length;h++){const m=new ku.Actor(a[h],i,this.id);m.name=`${o} ${h}`,this.actors.push(m)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(e,i,o){lo(this.actors,(u,a)=>{u.send(e,i,a)},o=o||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(e=>{e.remove()}),this.actors=[],this.workerPool.release(this.id)}}let Gd,gg;function qp(){return Gd||(Gd=new hc),Gd}ku.Actor=px;const yg=new Mi(0,0,0);var xg=(r=>(r[r.PATH_RULE_UNSPECIFIED=0]="PATH_RULE_UNSPECIFIED",r[r.PATH_RULE_NON_ZERO=1]="PATH_RULE_NON_ZERO",r[r.PATH_RULE_EVEN_ODD=2]="PATH_RULE_EVEN_ODD",r))(xg||{}),$p=(r=>(r[r.LINE_CAP_UNSPECIFIED=0]="LINE_CAP_UNSPECIFIED",r[r.LINE_CAP_BUTT=1]="LINE_CAP_BUTT",r[r.LINE_CAP_ROUND=2]="LINE_CAP_ROUND",r[r.LINE_CAP_SQUARE=3]="LINE_CAP_SQUARE",r))($p||{}),qd=(r=>(r[r.LINE_JOIN_UNSPECIFIED=0]="LINE_JOIN_UNSPECIFIED",r[r.LINE_JOIN_MITER=1]="LINE_JOIN_MITER",r[r.LINE_JOIN_MITER_CLIP=2]="LINE_JOIN_MITER_CLIP",r[r.LINE_JOIN_ROUND=3]="LINE_JOIN_ROUND",r[r.LINE_JOIN_BEVEL=4]="LINE_JOIN_BEVEL",r))(qd||{}),mx=(r=>(r[r.PAINT_ORDER_UNSPECIFIED=0]="PAINT_ORDER_UNSPECIFIED",r[r.PAINT_ORDER_FILL_AND_STROKE=1]="PAINT_ORDER_FILL_AND_STROKE",r[r.PAINT_ORDER_STROKE_AND_FILL=2]="PAINT_ORDER_STROKE_AND_FILL",r))(mx||{}),Ou=(r=>(r[r.PATH_COMMAND_UNSPECIFIED=0]="PATH_COMMAND_UNSPECIFIED",r[r.PATH_COMMAND_MOVE=1]="PATH_COMMAND_MOVE",r[r.PATH_COMMAND_LINE=2]="PATH_COMMAND_LINE",r[r.PATH_COMMAND_QUAD=3]="PATH_COMMAND_QUAD",r[r.PATH_COMMAND_CUBIC=4]="PATH_COMMAND_CUBIC",r[r.PATH_COMMAND_CLOSE=5]="PATH_COMMAND_CLOSE",r))(Ou||{}),_x=(r=>(r[r.MASK_TYPE_UNSPECIFIED=0]="MASK_TYPE_UNSPECIFIED",r[r.MASK_TYPE_LUMINANCE=1]="MASK_TYPE_LUMINANCE",r[r.MASK_TYPE_ALPHA=2]="MASK_TYPE_ALPHA",r))(_x||{});function Z2(r,e,i){r===1&&e.icons.push(function(o,u){return function(a){if(a.usvg_tree.height||(a.usvg_tree.height=a.usvg_tree.width),!a.metadata)return a;const{metadata:h}=a;if(h.content_area){const{content_area:m}=h;m.top==null&&(m.top=m.left),m.width==null&&(m.width=a.usvg_tree.width),m.height==null&&(m.height=m.width)}return h.stretch_x&&h.stretch_x.length&&gx(h,"x"),h.stretch_y&&h.stretch_y.length&&gx(h,"y"),a}(o.readFields(H2,{name:void 0},u))}(i,i.readVarint()+i.pos))}function gx(r,e){const i=[],o=r[`stretch_${e}`];let u=null;for(let a=0;a<o.length;a++)u===null?u=i.length===0?o[0]:i[i.length-1][1]+o[a]:(i.push([u,u+o[a]]),u=null);r[`stretch_${e}_areas`]=i}function H2(r,e,i){r===1?e.name=i.readString():r===2?e.metadata=function(o,u){return o.readFields(W2,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},u)}(i,i.readVarint()+i.pos):r===3&&(e.usvg_tree=function(o,u){return o.readFields(K2,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},u)}(i,i.readVarint()+i.pos),e.data="usvg_tree")}function W2(r,e,i){r===1?e.stretch_x=i.readPackedVarint():r===2?e.stretch_y=i.readPackedVarint():r===3?e.content_area=function(o,u){return o.readFields(X2,{left:0},u)}(i,i.readVarint()+i.pos):r===4&&e.variables.push(function(o,u){return o.readFields(Y2,{name:void 0},u)}(i,i.readVarint()+i.pos))}function X2(r,e,i){r===1?e.left=i.readVarint():r===2?e.width=i.readVarint():r===3?e.top=i.readVarint():r===4&&(e.height=i.readVarint())}function Y2(r,e,i){r===1?e.name=i.readString():r===2&&(e.rgb_color=Wp(i.readVarint()),e.value="rgb_color")}function K2(r,e,i){r===1?e.width=e.height=i.readVarint():r===2?e.height=i.readVarint():r===3?e.children.push(Zp(i,i.readVarint()+i.pos)):r===4?e.linear_gradients.push(function(o,u){return o.readFields(r3,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},u)}(i,i.readVarint()+i.pos)):r===5?e.radial_gradients.push(function(o,u){return o.readFields(o3,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},u)}(i,i.readVarint()+i.pos)):r===7?e.clip_paths.push(function(o,u){return o.readFields(a3,{children:[]},u)}(i,i.readVarint()+i.pos)):r===8&&e.masks.push(function(o,u){const a=o.readFields(l3,{left:0,width:20,mask_type:1,children:[]},u);return a.height==null&&(a.height=a.width),a.top==null&&(a.top=a.left),a}(i,i.readVarint()+i.pos))}function Zp(r,e){return r.readFields(J2,{},e)}function J2(r,e,i){r===1?(e.group=function(o,u){return o.readFields(Q2,{opacity:255,children:[]},u)}(i,i.readVarint()+i.pos),e.node="group"):r===2&&(e.path=function(o,u){return o.readFields(t3,{paint_order:1,commands:[],step:1,diffs:[],rule:1},u)}(i,i.readVarint()+i.pos),e.node="path")}function Q2(r,e,i){r===1?e.transform=Hp(i,i.readVarint()+i.pos):r===2?e.opacity=i.readVarint():r===5?e.clip_path_idx=i.readVarint():r===6?e.mask_idx=i.readVarint():r===7&&e.children.push(Zp(i,i.readVarint()+i.pos))}function Hp(r,e){return r.readFields(e3,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},e)}function e3(r,e,i){r===1?e.sx=i.readFloat():r===2?e.ky=i.readFloat():r===3?e.kx=i.readFloat():r===4?e.sy=i.readFloat():r===5?e.tx=i.readFloat():r===6&&(e.ty=i.readFloat())}function t3(r,e,i){r===1?e.fill=function(o,u){return o.readFields(i3,{rgb_color:yg,paint:"rgb_color",opacity:255},u)}(i,i.readVarint()+i.pos):r===2?e.stroke=function(o,u){return o.readFields(n3,{rgb_color:yg,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},u)}(i,i.readVarint()+i.pos):r===3?e.paint_order=i.readVarint():r===5?i.readPackedVarint(e.commands):r===6?e.step=i.readFloat():r===7?i.readPackedSVarint(e.diffs):r===8&&(e.rule=i.readVarint())}function i3(r,e,i){r===1?(e.rgb_color=Wp(i.readVarint()),e.paint="rgb_color"):r===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):r===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):r===5&&(e.opacity=i.readVarint())}function Wp(r){return new Mi((r>>16&255)/255,(r>>8&255)/255,(255&r)/255,1)}function n3(r,e,i){r===1?(e.rgb_color=Wp(i.readVarint()),e.paint="rgb_color"):r===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):r===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):r===5?i.readPackedFloat(e.dasharray):r===6?e.dashoffset=i.readFloat():r===7?e.miterlimit=i.readFloat():r===8?e.opacity=i.readVarint():r===9?e.width=i.readFloat():r===10?e.linecap=i.readVarint():r===11&&(e.linejoin=i.readVarint())}function r3(r,e,i){r===1?e.transform=Hp(i,i.readVarint()+i.pos):r===2?e.spread_method=i.readVarint():r===3?e.stops.push(yx(i,i.readVarint()+i.pos)):r===4?e.x1=i.readFloat():r===5?e.y1=i.readFloat():r===6?e.x2=i.readFloat():r===7&&(e.y2=i.readFloat())}function yx(r,e){return r.readFields(s3,{offset:0,opacity:255,rgb_color:yg},e)}function s3(r,e,i){r===1?e.offset=i.readFloat():r===2?e.opacity=i.readVarint():r===3&&(e.rgb_color=Wp(i.readVarint()))}function o3(r,e,i){r===1?e.transform=Hp(i,i.readVarint()+i.pos):r===2?e.spread_method=i.readVarint():r===3?e.stops.push(yx(i,i.readVarint()+i.pos)):r===4?e.cx=i.readFloat():r===5?e.cy=i.readFloat():r===6?e.r=i.readFloat():r===7?e.fx=i.readFloat():r===8?e.fy=i.readFloat():r===9&&(e.fr=i.readFloat())}function a3(r,e,i){r===1?e.transform=Hp(i,i.readVarint()+i.pos):r===2?e.clip_path_idx=i.readVarint():r===3&&e.children.push(Zp(i,i.readVarint()+i.pos))}function l3(r,e,i){r===1?e.left=e.top=i.readFloat():r===2?e.width=e.height=i.readFloat():r===3?e.top=i.readFloat():r===4?e.height=i.readFloat():r===5?e.mask_type=i.readVarint():r===6?e.mask_idx=i.readVarint():r===7&&e.children.push(Zp(i,i.readVarint()+i.pos))}class c3{static calculate(e,i){const o=new Map,u=new Map;if(Object.keys(e).length===0)return o;i.forEach(a=>{u.set(a.name,a.rgb_color||new Mi(0,0,0))});for(const[a,h]of Object.entries(e))u.has(a)?o.set(u.get(a).toStringPremultipliedAlpha(),h):console.warn(`Ignoring unknown image variable "${a}"`);return o}}function Fu(r,e=255,i){const o=e/255,u=r.toStringPremultipliedAlpha(),a=i.has(u)?i.get(u).clone():r.clone();return a.a=o,a.toString()}function $d(r,e){if(!K()){const i=document.createElement("canvas");return i.width=r,i.height=e,i}return new OffscreenCanvas(r,e)}function u3(r,e){const i=c3.calculate(e.params,r.metadata?r.metadata.variables:[]),o=r.usvg_tree,u=o.width,a=o.height,h=e.transform?e.transform:new DOMMatrix,m=Math.max(1,Math.round(u*h.a)),y=Math.max(1,Math.round(a*h.d)),T=new DOMMatrix([m/u,0,0,y/a,0,0]),f=$d(m,y).getContext("2d");return vg(f,T,o,o,i),f.getImageData(0,0,m,y)}function vg(r,e,i,o,u){for(const a of o.children)xx(r,e,i,a,u)}function xx(r,e,i,o,u){o.group?(r.save(),function(a,h,m,y,T){const f=y.mask_idx!=null?m.masks[y.mask_idx]:null,x=y.clip_path_idx!=null?m.clip_paths[y.clip_path_idx]:null;if(y.transform&&(h=Xp(y.transform).preMultiplySelf(h)),!function(v,S,C){return v.opacity!==255||S||C}(y,x!=null,f!=null))return void vg(a,h,m,y,T);const w=$d(a.canvas.width,a.canvas.height),g=w.getContext("2d");vg(g,h,m,y,T),x&&Mx(g,h,m,x),f&&Ix(g,h,m,f,T),a.globalAlpha=y.opacity/255,a.drawImage(w,0,0)}(r,e,i,o.group,u),r.restore()):o.path&&(r.save(),function(a,h,m,y,T){const f=Ax(y);a.setTransform(h),y.paint_order===mx.PAINT_ORDER_FILL_AND_STROKE?(vx(a,m,y,f,T),wx(a,m,y,f,T)):(wx(a,m,y,f,T),vx(a,m,y,f,T))}(r,e,i,o.path,u),r.restore())}function vx(r,e,i,o,u){const a=i.fill;if(!a)return;const h=a.opacity/255;switch(a.paint){case"rgb_color":r.fillStyle=Fu(a.rgb_color,a.opacity,u);break;case"linear_gradient_idx":r.fillStyle=Tx(r,e.linear_gradients[a.linear_gradient_idx],h,u);break;case"radial_gradient_idx":r.fillStyle=Sx(r,e.radial_gradients[a.radial_gradient_idx],h,u)}r.fill(o,bx(i))}function bx(r){return r.rule===xg.PATH_RULE_NON_ZERO?"nonzero":r.rule===xg.PATH_RULE_EVEN_ODD?"evenodd":void 0}function wx(r,e,i,o,u){const a=i.stroke;if(!a)return;r.lineWidth=a.width,r.miterLimit=a.miterlimit,r.setLineDash(a.dasharray),r.lineDashOffset=a.dashoffset;const h=a.opacity/255;switch(a.paint){case"rgb_color":r.strokeStyle=Fu(a.rgb_color,a.opacity,u);break;case"linear_gradient_idx":r.strokeStyle=Tx(r,e.linear_gradients[a.linear_gradient_idx],h,u);break;case"radial_gradient_idx":r.strokeStyle=Sx(r,e.radial_gradients[a.radial_gradient_idx],h,u)}switch(a.linejoin){case qd.LINE_JOIN_MITER_CLIP:case qd.LINE_JOIN_MITER:r.lineJoin="miter";break;case qd.LINE_JOIN_ROUND:r.lineJoin="round";break;case qd.LINE_JOIN_BEVEL:r.lineJoin="bevel"}switch(a.linecap){case $p.LINE_CAP_BUTT:r.lineCap="butt";break;case $p.LINE_CAP_ROUND:r.lineCap="round";break;case $p.LINE_CAP_SQUARE:r.lineCap="square"}r.stroke(o)}function Tx(r,e,i,o){if(e.stops.length===1){const w=e.stops[0];return Fu(w.rgb_color,w.opacity*i,o)}const u=Xp(e.transform),{x1:a,y1:h,x2:m,y2:y}=e,T=u.transformPoint(new DOMPoint(a,h)),f=u.transformPoint(new DOMPoint(m,y)),x=r.createLinearGradient(T.x,T.y,f.x,f.y);for(const w of e.stops)x.addColorStop(w.offset,Fu(w.rgb_color,w.opacity*i,o));return x}function Sx(r,e,i,o){if(e.stops.length===1){const w=e.stops[0];return Fu(w.rgb_color,w.opacity*i,o)}const u=Xp(e.transform),{fx:a,fy:h,cx:m,cy:y}=e,T=u.transformPoint(new DOMPoint(a,h)),f=u.transformPoint(new DOMPoint(m,y)),x=r.createRadialGradient(T.x,T.y,0,f.x,f.y,e.r*((u.a+u.d)/2));for(const w of e.stops)x.addColorStop(w.offset,Fu(w.rgb_color,w.opacity*i,o));return x}function Ex(r,e,i,o){const u=o.transform?Xp(o.transform).preMultiplySelf(e):e,a=$d(r.canvas.width,r.canvas.height),h=a.getContext("2d");for(const y of o.children)if(y.group)Ex(h,u,i,y.group);else if(y.path){const T=y.path,f=new Path2D;f.addPath(Ax(T),u),h.fill(f,bx(T))}const m=o.clip_path_idx!=null?i.clip_paths[o.clip_path_idx]:null;m&&Mx(h,u,i,m),r.globalCompositeOperation="source-over",r.drawImage(a,0,0)}function Mx(r,e,i,o){const u=$d(r.canvas.width,r.canvas.height);Ex(u.getContext("2d"),e,i,o),r.globalCompositeOperation="destination-in",r.drawImage(u,0,0)}function Ix(r,e,i,o,u){if(o.children.length===0)return;const a=o.mask_idx!=null?i.masks[o.mask_idx]:null;a&&Ix(r,e,i,a,u);const h=r.canvas.width,m=r.canvas.height,y=$d(h,m),T=y.getContext("2d"),f=o.width,x=o.height,w=o.left,g=o.top,v=new Path2D,S=new Path2D;S.rect(w,g,f,x),v.addPath(S,e),T.clip(v);for(const O of o.children)xx(T,e,i,O,u);const C=T.getImageData(0,0,h,m),z=C.data;if(o.mask_type===_x.MASK_TYPE_LUMINANCE)for(let O=0;O<z.length;O+=4)z[O+3]=z[O+3]/255*(.2126*z[O]+.7152*z[O+1]+.0722*z[O+2]);T.putImageData(C,0,0),r.globalCompositeOperation="destination-in",r.drawImage(y,0,0)}function Xp(r){return r?new DOMMatrix([r.sx,r.ky,r.kx,r.sy,r.tx,r.ty]):new DOMMatrix}function Ax(r){const e=new Path2D,i=r.step;let o=r.diffs[0]*i,u=r.diffs[1]*i;e.moveTo(o,u);for(let a=0,h=2;a<r.commands.length;a++)switch(r.commands[a]){case Ou.PATH_COMMAND_MOVE:o+=r.diffs[h++]*i,u+=r.diffs[h++]*i,e.moveTo(o,u);break;case Ou.PATH_COMMAND_LINE:o+=r.diffs[h++]*i,u+=r.diffs[h++]*i,e.lineTo(o,u);break;case Ou.PATH_COMMAND_QUAD:{const m=o+r.diffs[h++]*i,y=u+r.diffs[h++]*i;o=m+r.diffs[h++]*i,u=y+r.diffs[h++]*i,e.quadraticCurveTo(m,y,o,u);break}case Ou.PATH_COMMAND_CUBIC:{const m=o+r.diffs[h++]*i,y=u+r.diffs[h++]*i,T=m+r.diffs[h++]*i,f=y+r.diffs[h++]*i;o=T+r.diffs[h++]*i,u=f+r.diffs[h++]*i,e.bezierCurveTo(m,y,T,f,o,u);break}case Ou.PATH_COMMAND_CLOSE:e.closePath()}return e}class bg{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;const i=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,i),i}put(e,i){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,i)}delete(e){this.cache.delete(e)}}class wg{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new Wn(e,e.data)}getFromCache(e,i,o){return this.cacheMap.has(o)||this.cacheMap.set(o,new bg(150)),this.cacheMap.get(o).get(xs(e.serialize(),i))}setInCache(e,i,o,u){this.cacheDependenciesMap.has(u)||this.cacheDependenciesMap.set(u,new Map),this.cacheMap.has(u)||this.cacheMap.set(u,new bg(150));const a=this.cacheDependenciesMap.get(u);a.get(xs(e.id,o))||a.set(xs(e.id,o),new Set);const h=this.cacheMap.get(u),m=e.serialize();a.get(xs(e.id,o)).add(m),h.put(xs(e.serialize(),o),i)}removeImagesFromCacheByIds(e,i,o=""){if(!this.cacheMap.has(o)||!this.cacheDependenciesMap.has(o))return;const u=this.cacheMap.get(o),a=this.cacheDependenciesMap.get(o);for(const h of e)if(a.has(xs(h,i))){for(const m of a.get(xs(h,i)))u.delete(m);a.delete(xs(h,i))}}rasterize(e,i,o,u,a=u3){const h=this.getFromCache(e,o,u);if(h)return h.clone();const m=a(i.icon,e.options),y=wg._getImage(m);return this.setInCache(e,y,o,u),y.clone()}}class Cx{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,i){const o=this.toIdx(e,i);return{min:this.minimums[o],max:this.maximums[o]}}isLeaf(e,i){return this.leaves[this.toIdx(e,i)]}toIdx(e,i){return i*this.size+e}}function Px(r,e,i,o){let u=0,a=Number.MAX_VALUE;for(let h=0;h<3;h++)if(Math.abs(o[h])<1e-15){if(i[h]<r[h]||i[h]>e[h])return null}else{const m=1/o[h];let y=(r[h]-i[h])*m,T=(e[h]-i[h])*m;if(y>T){const f=y;y=T,T=f}if(y>u&&(u=y),T<a&&(a=T),u>a)return null}return u}function zx(r,e,i,o,u,a,h,m,y,T,f){const x=o-r,w=u-e,g=a-i,v=h-r,S=m-e,C=y-i,z=f[1]*C-f[2]*S,O=f[2]*v-f[0]*C,B=f[0]*S-f[1]*v,L=x*z+w*O+g*B;if(Math.abs(L)<1e-15)return null;const V=1/L,j=T[0]-r,W=T[1]-e,te=T[2]-i,ee=(j*z+W*O+te*B)*V;if(ee<0||ee>1)return null;const Q=W*g-te*w,pe=te*x-j*g,ie=j*w-W*x,me=(f[0]*Q+f[1]*pe+f[2]*ie)*V;return me<0||ee+me>1?null:(v*Q+S*pe+C*ie)*V}function Rx(r,e,i){return(r-e)/(i-e)}function Dx(r,e,i,o,u,a,h,m,y){const T=1<<i,f=a-o,x=h-u,w=(r+1)/T*f+o,g=(e+0)/T*x+u,v=(e+1)/T*x+u;m[0]=(r+0)/T*f+o,m[1]=g,y[0]=w,y[1]=v}class Lx{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const i=function(a){const h=Math.ceil(Math.log2(a.dim/8)),m=[];let y=Math.ceil(Math.pow(2,h));const T=1/y,f=(g,v,S,C,z)=>{const O=C?1:0,B=(g+1)*S-O,L=v*S,V=(v+1)*S-O;z[0]=g*S,z[1]=L,z[2]=B,z[3]=V};let x=new Cx(y);const w=[];for(let g=0;g<y*y;g++){f(g%y,Math.floor(g/y),T,!1,w);const v=ol(w[0],w[1],a),S=ol(w[2],w[1],a),C=ol(w[2],w[3],a),z=ol(w[0],w[3],a);x.minimums.push(Math.min(v,S,C,z)),x.maximums.push(Math.max(v,S,C,z)),x.leaves.push(1)}for(m.push(x),y/=2;y>=1;y/=2){const g=m[m.length-1];x=new Cx(y);for(let v=0;v<y*y;v++){f(v%y,Math.floor(v/y),2,!0,w);const S=g.getElevation(w[0],w[1]),C=g.getElevation(w[2],w[1]),z=g.getElevation(w[2],w[3]),O=g.getElevation(w[0],w[3]),B=g.isLeaf(w[0],w[1]),L=g.isLeaf(w[2],w[1]),V=g.isLeaf(w[2],w[3]),j=g.isLeaf(w[0],w[3]),W=Math.min(S.min,C.min,z.min,O.min),te=Math.max(S.max,C.max,z.max,O.max),ee=B&&L&&V&&j;x.maximums.push(te),x.minimums.push(W),x.leaves.push(te-W<=5&&ee?1:0)}m.push(x)}return m}(this.dem),o=i.length-1,u=i[o];this._addNode(u.minimums[0],u.maximums[0],u.leaves[0]),this._construct(i,0,0,o,0)}raycastRoot(e,i,o,u,a,h,m=1){return Px([e,i,-100],[o,u,this.maximums[0]*m],a,h)}raycast(e,i,o,u,a,h,m=1){if(!this.nodeCount)return null;const y=this.raycastRoot(e,i,o,u,a,h,m);if(y==null)return null;const T=[],f=[],x=[],w=[],g=[{idx:0,t:y,nodex:0,nodey:0,depth:0}];for(;g.length>0;){const{idx:v,t:S,nodex:C,nodey:z,depth:O}=g.pop();if(this.leaves[v]){Dx(C,z,O,e,i,o,u,x,w);const L=1<<O,V=(C+0)/L,j=(C+1)/L,W=(z+0)/L,te=(z+1)/L,ee=ol(V,W,this.dem)*m,Q=ol(j,W,this.dem)*m,pe=ol(j,te,this.dem)*m,ie=ol(V,te,this.dem)*m,me=zx(x[0],x[1],ee,w[0],x[1],Q,w[0],w[1],pe,a,h),xe=zx(w[0],w[1],pe,x[0],w[1],ie,x[0],x[1],ee,a,h),ye=Math.min(me!==null?me:Number.MAX_VALUE,xe!==null?xe:Number.MAX_VALUE);if(ye!==Number.MAX_VALUE)return ye;{const we=Se.vec3.scaleAndAdd([],a,h,S);if(kx(ee,Q,ie,pe,Rx(we[0],x[0],w[0]),Rx(we[1],x[1],w[1]))>=we[2])return S}continue}let B=0;for(let L=0;L<this._siblingOffset.length;L++){Dx((C<<1)+this._siblingOffset[L][0],(z<<1)+this._siblingOffset[L][1],O+1,e,i,o,u,x,w),x[2]=-100,w[2]=this.maximums[this.childOffsets[v]+L]*m;const V=Px(x,w,a,h);if(V!=null){const j=V;T[L]=j;let W=!1;for(let te=0;te<B&&!W;te++)j>=T[f[te]]&&(f.splice(te,0,L),W=!0);W||(f[B]=L),B++}}for(let L=0;L<B;L++){const V=f[L];g.push({idx:this.childOffsets[v]+V,t:T[V],nodex:(C<<1)+this._siblingOffset[V][0],nodey:(z<<1)+this._siblingOffset[V][1],depth:O+1})}}return null}_addNode(e,i,o){return this.minimums.push(e),this.maximums.push(i),this.leaves.push(o),this.childOffsets.push(0),this.nodeCount++}_construct(e,i,o,u,a){if(e[u].isLeaf(i,o)===1)return;this.childOffsets[a]||(this.childOffsets[a]=this.nodeCount);const h=u-1,m=e[h];let y=0,T=0;for(let f=0;f<this._siblingOffset.length;f++){const x=2*i+this._siblingOffset[f][0],w=2*o+this._siblingOffset[f][1],g=m.getElevation(x,w),v=m.isLeaf(x,w),S=this._addNode(g.min,g.max,v);v&&(y|=1<<f),T||(T=S)}for(let f=0;f<this._siblingOffset.length;f++)y&1<<f||this._construct(e,2*i+this._siblingOffset[f][0],2*o+this._siblingOffset[f][1],h,T+f)}}function kx(r,e,i,o,u,a){return Gt(Gt(r,i,a),Gt(e,o,a),u)}function ol(r,e,i){const o=i.dim,u=ri(r*o-.5,0,o-1),a=ri(e*o-.5,0,o-1),h=Math.floor(u),m=Math.floor(a),y=Math.min(h+1,o-1),T=Math.min(m+1,o-1);return kx(i.get(h,m),i.get(y,m),i.get(h,T),i.get(y,T),u-h,a-m)}const h3={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function d3(r,e,i){return(256*r*256+256*e+i)/10-1e4}function f3(r,e,i){return 256*r+e+i/256-32768}class Yp{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,i,o,u=!1){if(this.uid=e,i.height!==i.width)throw new RangeError("DEM tiles must be square");if(o&&o!=="mapbox"&&o!=="terrarium")return void ti(`"${o}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=i.height;const a=this.dim=i.height-2,h=new Uint32Array(i.data.buffer);if(this.pixels=new Uint8Array(i.data.buffer),this.floatView=new Float32Array(i.data.buffer),this.borderReady=u,this._modifiedForSources={},!u){for(let y=0;y<a;y++)h[this._idx(-1,y)]=h[this._idx(0,y)],h[this._idx(a,y)]=h[this._idx(a-1,y)],h[this._idx(y,-1)]=h[this._idx(y,0)],h[this._idx(y,a)]=h[this._idx(y,a-1)];h[this._idx(-1,-1)]=h[this._idx(0,0)],h[this._idx(a,-1)]=h[this._idx(a-1,0)],h[this._idx(-1,a)]=h[this._idx(0,a-1)],h[this._idx(a,a)]=h[this._idx(a-1,a-1)]}const m=o==="terrarium"?f3:d3;for(let y=0;y<h.length;++y){const T=4*y;this.floatView[y]=m(this.pixels[T],this.pixels[T+1],this.pixels[T+2])}this._timestamp=ue.now()}_buildQuadTree(){this._tree=new Lx(this)}get(e,i,o=!1){o&&(e=ri(e,-1,this.dim),i=ri(i,-1,this.dim));const u=this._idx(e,i);return this.floatView[u]}set(e,i,o){const u=this._idx(e,i),a=this.floatView[u];return this.floatView[u]=o,o-a}static getUnpackVector(e){return h3[e]}_idx(e,i){if(e<-1||e>=this.dim+1||i<-1||i>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(i+1)*this.stride+(e+1)}static pack(e,i){const o=[0,0,0,0],u=Yp.getUnpackVector(i);let a=Math.floor((e+u[3])/u[2]);return o[2]=a%256,a=Math.floor(a/256),o[1]=a%256,a=Math.floor(a/256),o[0]=a,o}getPixels(){return new Qy({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,i,o){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let u=i*this.dim,a=i*this.dim+this.dim,h=o*this.dim,m=o*this.dim+this.dim;switch(i){case-1:u=a-1;break;case 1:a=u+1}switch(o){case-1:h=m-1;break;case 1:m=h+1}const y=-i*this.dim,T=-o*this.dim;for(let f=h;f<m;f++)for(let x=u;x<a;x++){const w=4*this._idx(x,f),g=4*this._idx(x+y,f+T);this.pixels[w+0]=e.pixels[g+0],this.pixels[w+1]=e.pixels[g+1],this.pixels[w+2]=e.pixels[g+2],this.pixels[w+3]=e.pixels[g+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function p3(r,e,i){r===1?e.headerLength=i.readFixed32():r===2?e.x=i.readVarint():r===3?e.y=i.readVarint():r===4?e.z=i.readVarint():r===5&&e.layers.push(function(o,u){return o.readFields(x3,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},u)}(i,i.readVarint()+i.pos))}function m3(r,e,i){r===1?(e.delta_filter=function(o,u){return o.readFields(_3,{blockSize:0},u)}(i,i.readVarint()+i.pos),e.filter="delta_filter"):r===2?(i.readVarint(),e.filter="zigzag_filter"):r===3?(i.readVarint(),e.filter="bitshuffle_filter"):r===4&&(i.readVarint(),e.filter="byteshuffle_filter")}function _3(r,e,i){r===1&&(e.blockSize=i.readVarint())}function g3(r,e,i){r===1?(i.readVarint(),e.codec="gzip_data"):r===2?(i.readVarint(),e.codec="jpeg_image"):r===3?(i.readVarint(),e.codec="webp_image"):r===4&&(i.readVarint(),e.codec="png_image")}function y3(r,e,i){let o=0,u=0;r===1?e.firstByte=i.readFixed64():r===2?e.lastByte=i.readFixed64():r===3?e.filters.push(function(a,h){return a.readFields(m3,{},h)}(i,i.readVarint()+i.pos)):r===4?e.codec=function(a,h){return a.readFields(g3,{},h)}(i,i.readVarint()+i.pos):r===5?u=i.readFloat():r===6?o=i.readFloat():r===7?e.bands.push(i.readString()):r===8?e.offset=i.readDouble():r===9&&(e.scale=i.readDouble()),e.offset===0&&(e.offset=u),e.scale===0&&(e.scale=o)}function x3(r,e,i){r===1?e.version=i.readVarint():r===2?e.name=i.readString():r===3?e.units=i.readString():r===4?e.tileSize=i.readVarint():r===5?e.buffer=i.readVarint():r===6?e.pixelFormat=i.readVarint():r===7&&e.dataIndex.push(function(o,u){return o.readFields(y3,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},u)}(i,i.readVarint()+i.pos))}function v3(r,e,i){if(r===2)(function(o,u,a){o.readFields(b3,a,u)})(i,i.readVarint()+i.pos,e);else if(r===3)throw new Error("Not implemented")}function b3(r,e,i){if(r===1){let o=0;const u=i.readVarint()+i.pos;for(;i.pos<u;)e[o++]=i.readVarint()}}function w3(r,e){if(e.length!==4)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let i=e[3];for(let o=2;o>=1;o--){const u=o===1?1:0,a=o===2?1:0;for(let h=0;h<e[0];h++){const m=e[1]*h;for(let y=u;y<e[1];y++){const T=e[2]*(y+m);for(let f=a;f<e[2];f++){const x=e[3]*(f+T);for(let w=0;w<e[3];w++){const g=x+w;r[g]+=r[g-i]}}}}i*=e[o]}return r}function T3(r){for(let e=0,i=r.length;e<i;e++)r[e]=r[e]>>>1^-(1&r[e]);return r}function S3(r,e){switch(e){case"uint32":return r;case"uint16":for(let i=0;i<r.length;i+=2){const o=r[i],u=r[i+1];r[i]=(240&o)>>4|(61440&o)>>8|(240&u)<<4|61440&u,r[i+1]=15&o|(3840&o)>>4|(15&u)<<8|(3840&u)<<4}return r;case"uint8":for(let i=0;i<r.length;i+=4){const o=r[i],u=r[i+1],a=r[i+2],h=r[i+3];r[i+0]=(192&o)>>6|(192&u)>>4|(192&a)>>2|192&h,r[i+1]=(48&o)>>4|(48&u)>>2|48&a|(48&h)<<2,r[i+2]=(12&o)>>2|12&u|(12&a)<<2|(12&h)<<4,r[i+3]=3&o|(3&u)<<2|(3&a)<<4|(3&h)<<6}return r;default:throw new Error(`Invalid pixel format, "${e}"`)}}Mt(Yp,"DEMData"),Mt(Lx,"DemMinMaxQuadTree",{omit:["dem"]});var ns=Uint8Array,Zd=Uint16Array,E3=Int32Array,Ox=new ns([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Fx=new ns([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),M3=new ns([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Bx=function(r,e){for(var i=new Zd(31),o=0;o<31;++o)i[o]=e+=1<<r[o-1];var u=new E3(i[30]);for(o=1;o<30;++o)for(var a=i[o];a<i[o+1];++a)u[a]=a-i[o]<<5|o;return{b:i,r:u}},Nx=Bx(Ox,2),Vx=Nx.b,I3=Nx.r;Vx[28]=258,I3[258]=28;for(var A3=Bx(Fx,0).b,Ux=new Zd(32768),wn=0;wn<32768;++wn){var Bu=(43690&wn)>>1|(21845&wn)<<1;Ux[wn]=((65280&(Bu=(61680&(Bu=(52428&Bu)>>2|(13107&Bu)<<2))>>4|(3855&Bu)<<4))>>8|(255&Bu)<<8)>>1}var Hd=function(r,e,i){for(var o=r.length,u=0,a=new Zd(e);u<o;++u)r[u]&&++a[r[u]-1];var h,m=new Zd(e);for(u=1;u<e;++u)m[u]=m[u-1]+a[u-1]<<1;h=new Zd(1<<e);var y=15-e;for(u=0;u<o;++u)if(r[u])for(var T=u<<4|r[u],f=e-r[u],x=m[r[u]-1]++<<f,w=x|(1<<f)-1;x<=w;++x)h[Ux[x]>>y]=T;return h},Wd=new ns(288);for(wn=0;wn<144;++wn)Wd[wn]=8;for(wn=144;wn<256;++wn)Wd[wn]=9;for(wn=256;wn<280;++wn)Wd[wn]=7;for(wn=280;wn<288;++wn)Wd[wn]=8;var jx=new ns(32);for(wn=0;wn<32;++wn)jx[wn]=5;var C3=Hd(Wd,9),P3=Hd(jx,5),Tg=function(r){for(var e=r[0],i=1;i<r.length;++i)r[i]>e&&(e=r[i]);return e},to=function(r,e,i){var o=e/8|0;return(r[o]|r[o+1]<<8)>>(7&e)&i},Sg=function(r,e){var i=e/8|0;return(r[i]|r[i+1]<<8|r[i+2]<<16)>>(7&e)},z3=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],io=function(r,e,i){var o=new Error(e||z3[r]);if(o.code=r,Error.captureStackTrace&&Error.captureStackTrace(o,io),!i)throw o;return o},R3=new ns(0),D3=typeof TextDecoder<"u"&&new TextDecoder;try{D3.decode(R3,{stream:!0})}catch{}const L3={gzip_data:"gzip"};class Ms extends Error{constructor(e){super(e),this.name="MRTError"}}const k3={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},Gx={uint32:1,uint16:2,uint8:4},O3={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let Eg;class Mg{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){const i=this.layers[e];if(!i)throw new Ms(`Layer '${e}' not found`);return i}getHeaderLength(e){const i=new Uint8Array(e),o=new DataView(e);if(i[0]!==13)throw new Ms("File is not a valid MRT.");return o.getUint32(1,!0)}parseHeader(e){const i=new Uint8Array(e),o=this.getHeaderLength(e);if(i.length<o)throw new Ms(`Expected header with length >= ${o} but got buffer of length ${i.length}`);const u=function(a,h){return a.readFields(p3,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0)}(new Eg(i.subarray(0,o)));if(!isNaN(this.x)&&(this.x!==u.x||this.y!==u.y||this.z!==u.z))throw new Ms(`Invalid attempt to parse header ${u.z}/${u.x}/${u.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=u.x,this.y=u.y,this.z=u.z;for(const a of u.layers)this.layers[a.name]=new F3(a,{cacheSize:this._cacheSize});return this}createDecodingTask(e){const i=[],o=this.getLayer(e.layerName);for(let u of e.blockIndices){const a=o.dataIndex[u],h=a.firstByte-e.firstByte,m=a.lastByte-e.firstByte;if(o._blocksInProgress.has(u))continue;const y={layerName:o.name,firstByte:h,lastByte:m,pixelFormat:o.pixelFormat,blockIndex:u,blockShape:[a.bands.length].concat(o.bandShape),buffer:o.buffer,codec:a.codec.codec,filters:a.filters.map(T=>T.filter)};o._blocksInProgress.add(u),i.push(y)}return new qx(i,()=>{i.forEach(u=>o._blocksInProgress.delete(u.blockIndex))},(u,a)=>{if(i.forEach(h=>o._blocksInProgress.delete(h.blockIndex)),u)throw u;a.forEach(h=>{this.getLayer(h.layerName).processDecodedData(h)})})}}class F3{constructor({version:e,name:i,units:o,tileSize:u,pixelFormat:a,buffer:h,dataIndex:m},y){if(this.version=e,this.version!==1)throw new Ms(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=i,this.units=o,this.tileSize=u,this.buffer=h,this.pixelFormat=k3[a],this.dataIndex=m,this.bandShape=[u+2*h,u+2*h,Gx[this.pixelFormat]],this._decodedBlocks=new bg(y?y.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return Gx[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:e})=>e).flat()}processDecodedData(e){const i=e.blockIndex.toString();this._decodedBlocks.get(i)||this._decodedBlocks.put(i,e.data)}getBlockForBand(e){let i=0;switch(typeof e){case"string":for(const[o,u]of this.dataIndex.entries()){for(const[a,h]of u.bands.entries())if(h===e)return{bandIndex:i+a,blockIndex:o,blockBandIndex:a};i+=u.bands.length}break;case"number":for(const[o,u]of this.dataIndex.entries()){if(e>=i&&e<i+u.bands.length)return{bandIndex:e,blockIndex:o,blockBandIndex:e-i};i+=u.bands.length}break;default:throw new Ms(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}throw new Ms(`Band not found: ${JSON.stringify(e)}`)}getDataRange(e){let i=1/0,o=-1/0;const u=[],a=new Set;for(const h of e){const{blockIndex:m}=this.getBlockForBand(h);if(m<0)throw new Ms(`Invalid band: ${JSON.stringify(h)}`);const y=this.dataIndex[m];u.includes(m)||u.push(m),a.add(m),i=Math.min(i,y.firstByte),o=Math.max(o,y.lastByte)}if(a.size>this.cacheSize)throw new Ms(`Number of blocks to decode (${a.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:i,lastByte:o,blockIndices:u}}hasBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0}hasDataForBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0&&!!this._decodedBlocks.get(i.toString())}getBandView(e){const{blockIndex:i,blockBandIndex:o}=this.getBlockForBand(e),u=this._decodedBlocks.get(i.toString());if(!u)throw new Ms(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);const a=this.dataIndex[i],h=this.bandShape.reduce((T,f)=>T*f,1),m=o*h,y=u.subarray(m,m+h);return{data:y,bytes:new Uint8Array(y.buffer).subarray(y.byteOffset,y.byteOffset+y.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:a.offset,scale:a.scale}}}Mg.setPbf=function(r){Eg=r};class qx{constructor(e,i,o){this.tasks=e,this._onCancel=i,this._onComplete=o,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,i){this._finalized||(this._onComplete(e,i),this._finalized=!0)}}Mg.performDecoding=function(r,e){const i=new Uint8Array(r);return Promise.all(e.tasks.map(o=>{const{layerName:u,firstByte:a,lastByte:h,pixelFormat:m,blockShape:y,blockIndex:T,filters:f,codec:x}=o,w=i.subarray(a,h+1),g=new Uint32Array(y[0]*y[1]*y[2]);let v;if(x!=="gzip_data")throw new Ms(`Unhandled codec: ${x}`);return v=function(S,C){if(!globalThis.DecompressionStream&&C==="gzip_data")return Promise.resolve(((L=function(W){W[0]==31&&W[1]==139&&W[2]==8||io(6,"invalid gzip data");var te=W[3],ee=10;4&te&&(ee+=2+(W[10]|W[11]<<8));for(var Q=(te>>3&1)+(te>>4&1);Q>0;Q-=!W[ee++]);return ee+(2&te)}(B=S))+8>B.length&&io(6,"invalid gzip data"),function(W,te,ee,Q){var pe=W.length;if(!pe||te.f&&!te.l)return ee||new ns(0);var ie=!ee,me=ie||te.i!=2,xe=te.i;ie&&(ee=new ns(3*pe));var ye,we,Ae=function(al){var pc=ee.length;if(al>pc){var Jd=new ns(Math.max(2*pc,al));Jd.set(ee),ee=Jd}},Re=te.f||0,Ee=te.p||0,$e=te.b||0,Qe=te.l,qe=te.d,_t=te.m,pt=te.n,rt=8*pe;do{if(!Qe){Re=to(W,Ee,1);var et=to(W,Ee+1,3);if(Ee+=3,!et){var Pt=W[(Kt=4+((Ee+7)/8|0))-4]|W[Kt-3]<<8,yt=Kt+Pt;if(yt>pe){xe&&io(0);break}me&&Ae($e+Pt),ee.set(W.subarray(Kt,yt),$e),te.b=$e+=Pt,te.p=Ee=8*yt,te.f=Re;continue}if(et==1)Qe=C3,qe=P3,_t=9,pt=5;else if(et==2){var Tt=to(W,Ee,31)+257,Wt=to(W,Ee+10,15)+4,ei=Tt+to(W,Ee+5,31)+1;Ee+=14;for(var ii=new ns(ei),ni=new ns(19),ci=0;ci<Wt;++ci)ni[M3[ci]]=to(W,Ee+3*ci,7);Ee+=3*Wt;var ui=Tg(ni),Ni=(1<<ui)-1,Di=Hd(ni,ui);for(ci=0;ci<ei;){var Kt,Pi=Di[to(W,Ee,Ni)];if(Ee+=15&Pi,(Kt=Pi>>4)<16)ii[ci++]=Kt;else{var Ri=0,Hi=0;for(Kt==16?(Hi=3+to(W,Ee,3),Ee+=2,Ri=ii[ci-1]):Kt==17?(Hi=3+to(W,Ee,7),Ee+=3):Kt==18&&(Hi=11+to(W,Ee,127),Ee+=7);Hi--;)ii[ci++]=Ri}}var un=ii.subarray(0,Tt),Tn=ii.subarray(Tt);_t=Tg(un),pt=Tg(Tn),Qe=Hd(un,_t),qe=Hd(Tn,pt)}else io(1);if(Ee>rt){xe&&io(0);break}}me&&Ae($e+131072);for(var hn=(1<<_t)-1,rn=(1<<pt)-1,mn=Ee;;mn=Ee){var An=(Ri=Qe[Sg(W,Ee)&hn])>>4;if((Ee+=15&Ri)>rt){xe&&io(0);break}if(Ri||io(2),An<256)ee[$e++]=An;else{if(An==256){mn=Ee,Qe=null;break}var ir=An-254;An>264&&(ir=to(W,Ee,(1<<(ro=Ox[ci=An-257]))-1)+Vx[ci],Ee+=ro);var Gi=qe[Sg(W,Ee)&rn],Dr=Gi>>4;if(Gi||io(3),Ee+=15&Gi,Tn=A3[Dr],Dr>3){var ro=Fx[Dr];Tn+=Sg(W,Ee)&(1<<ro)-1,Ee+=ro}if(Ee>rt){xe&&io(0);break}me&&Ae($e+131072);var Is=$e+ir;if($e<Tn){var As=0-Tn,fc=Math.min(Tn,Is);for(As+$e<0&&io(3);$e<fc;++$e)ee[$e]=(void 0)[As+$e]}for(;$e<Is;++$e)ee[$e]=ee[$e-Tn]}}te.l=Qe,te.p=mn,te.b=$e,te.f=Re,Qe&&(Re=1,te.m=_t,te.d=qe,te.n=pt)}while(!Re);return $e!=ee.length&&ie?(ye=ee,((we=$e)==null||we>ye.length)&&(we=ye.length),new ns(ye.subarray(0,we))):ee.subarray(0,$e)}(B.subarray(L,-8),{i:2},new ns(((z=B)[(O=z.length)-4]|z[O-3]<<8|z[O-2]<<16|z[O-1]<<24)>>>0))));var z,O,B,L;const V=L3[C];if(!V)throw new Error(`Unhandled codec: ${C}`);const j=new globalThis.DecompressionStream(V);return new Response(new Blob([S]).stream().pipeThrough(j)).arrayBuffer().then(W=>new Uint8Array(W))}(w,x).then(S=>(function(C,z){C.readFields(v3,z)}(new Eg(S),g),new O3[m](g.buffer))),v.then(S=>{for(let C=f.length-1;C>=0;C--)switch(f[C]){case"delta_filter":w3(S,y);break;case"zigzag_filter":T3(S);break;case"bitshuffle_filter":S3(S,m);break;default:throw new Ms(`Unhandled filter "${f[C]}"`)}return{layerName:u,blockIndex:T,data:S}}).catch(S=>{throw S})}))},Mt(qx,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]});let Xd,Ig,no,Nu,Ag,Vu=null;function $x(){return Us()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:Ig||Mn.DRACO_URL}function Zx(){if(Us()&&self.worker&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(Nu)return Nu;const r=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return Nu=WebAssembly.validate(r)?Mn.MESHOPT_SIMD_URL:Mn.MESHOPT_URL,Nu}const Kp={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},B3={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},Yd={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function Hx(r,e,i){const o=i.json.bufferViews.length,u=i.buffers.length;e.bufferView=o,i.json.bufferViews[o]={buffer:u,byteLength:r.byteLength},i.buffers[u]=r}const Cg="KHR_draco_mesh_compression";function N3(r,e){const i=r.extensions&&r.extensions[Cg];if(!i)return;const o=new no.Decoder,u=Kx(e,i.bufferView),a=new no.Mesh;if(!o.DecodeArrayToMesh(u,u.byteLength,a))throw new Error("Failed to decode Draco mesh");const h=e.json.accessors[r.indices],m=Kp[h.componentType],y=h.count*m.BYTES_PER_ELEMENT,T=no._malloc(y);m===Uint16Array?o.GetTrianglesUInt16Array(a,y,T):o.GetTrianglesUInt32Array(a,y,T),Hx(no.memory.buffer.slice(T,T+y),h,e),no._free(T);for(const f of Object.keys(i.attributes)){const x=o.GetAttributeByUniqueId(a,i.attributes[f]),w=e.json.accessors[r.attributes[f]],g=B3[w.componentType],v=w.count*Yd[w.type]*Kp[w.componentType].BYTES_PER_ELEMENT,S=no._malloc(v);o.GetAttributeDataArrayForAllPoints(a,x,no[g],v,S),Hx(no.memory.buffer.slice(S,S+v),w,e),no._free(S)}o.destroy(),a.destroy(),delete r.extensions[Cg]}const Jp="EXT_meshopt_compression";function V3(r,e){if(!r.extensions||!r.extensions[Jp])return;const i=r.extensions[Jp],o=new Uint8Array(e.buffers[i.buffer],i.byteOffset||0,i.byteLength||0),u=new Uint8Array(i.count*i.byteStride);Ag.decodeGltfBuffer(u,i.count,i.byteStride,o,i.mode,i.filter),r.buffer=e.buffers.length,r.byteOffset=0,e.buffers[r.buffer]=u.buffer,delete r.extensions[Jp]}const Wx=1179937895,Xx=new TextDecoder("utf8");function Yx(r,e){return new URL(r,e).href}function U3(r,e,i,o){return fetch(Yx(r.uri,o)).then(u=>u.arrayBuffer()).then(u=>{e.buffers[i]=u})}function Kx(r,e){const i=r.json.bufferViews[e];return new Uint8Array(r.buffers[i.buffer],i.byteOffset||0,i.byteLength)}function j3(r,e,i,o){if(r.uri){const u=Yx(r.uri,o);return fetch(u).then(a=>a.blob()).then(a=>createImageBitmap(a)).then(a=>{e.images[i]=a})}if(r.bufferView!==void 0){const u=Kx(e,r.bufferView),a=new Blob([u],{type:r.mimeType});return createImageBitmap(a).then(h=>{e.images[i]=h})}}function Jx(r,e=0,i){const o={json:null,images:[],buffers:[]};if(new Uint32Array(r,e,1)[0]===Wx){const f=new Uint32Array(r,e);let x=2;const w=(f[x++]>>2)-3,g=f[x++]>>2;if(x++,o.json=JSON.parse(Xx.decode(f.subarray(x,x+g))),x+=g,x<w){const v=f[x++];x++;const S=e+(x<<2);o.buffers[0]=r.slice(S,S+v)}}else o.json=JSON.parse(Xx.decode(new Uint8Array(r,e)));const{buffers:u,images:a,meshes:h,extensionsUsed:m,bufferViews:y}=o.json;let T=Promise.resolve();if(u){const f=[];for(let x=0;x<u.length;x++){const w=u[x];w.uri?f.push(U3(w,o,x,i)):o.buffers[x]||(o.buffers[x]=null)}T=Promise.all(f)}return T.then(()=>{const f=[],x=m&&m.includes(Cg),w=m&&m.includes(Jp);if(x&&f.push(function(){if(!no)return Xd??(Xd=function(g){let v,S=null;function C(){v=new Uint8Array(S.buffer)}function z(){throw new Error("Unexpected Draco error.")}const O={a:{a:z,d:function(B,L,V){return v.copyWithin(B,L,L+V)},c:function(B){const L=v.length,V=Math.max(B>>>0,Math.ceil(1.2*L)),j=Math.ceil((V-L)/65536);try{return S.grow(j),C(),!0}catch{return!1}},b:z}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(g,O):g.then(B=>B.arrayBuffer()).then(B=>WebAssembly.instantiate(B,O))).then(B=>{const{Rb:L,Qb:V,P:j,T:W,X:te,Ja:ee,La:Q,Qa:pe,Va:ie,Wa:me,eb:xe,jb:ye,f:we,e:Ae,yb:Re,zb:Ee,Ab:$e,Bb:Qe,Db:qe,Gb:_t}=B.instance.exports;S=Ae;const pt=(()=>{let rt=0,et=0,Pt=0,yt=0;return Tt=>{Pt&&(L(yt),L(rt),et+=Pt,Pt=rt=0),rt||(et+=128,rt=V(et));const Wt=Tt.length+7&-8;let ei=rt;Wt>=et&&(Pt=Wt,ei=yt=V(Wt));for(let ii=0;ii<Tt.length;ii++)v[ei+ii]=Tt[ii];return ei}})();return C(),we(),{memory:Ae,_free:L,_malloc:V,Mesh:class{constructor(){this.ptr=j()}destroy(){W(this.ptr)}},Decoder:class{constructor(){this.ptr=ee()}destroy(){ye(this.ptr)}DecodeArrayToMesh(rt,et,Pt){const yt=pt(rt),Tt=Q(this.ptr,yt,et,Pt.ptr);return!!te(Tt)}GetAttributeByUniqueId(rt,et){return{ptr:pe(this.ptr,rt.ptr,et)}}GetTrianglesUInt16Array(rt,et,Pt){ie(this.ptr,rt.ptr,et,Pt)}GetTrianglesUInt32Array(rt,et,Pt){me(this.ptr,rt.ptr,et,Pt)}GetAttributeDataArrayForAllPoints(rt,et,Pt,yt,Tt){xe(this.ptr,rt.ptr,et.ptr,Pt,yt,Tt)}},DT_INT8:Re(),DT_UINT8:Ee(),DT_INT16:$e(),DT_UINT16:Qe(),DT_UINT32:qe(),DT_FLOAT32:_t()}})}(fetch($x())),Xd.then(g=>{no=g,Xd=void 0}))}()),w&&f.push(function(){if(Ag)return;const g=function(v){let S;const C=WebAssembly.instantiateStreaming(v,{}).then(B=>{S=B.instance,S.exports.__wasm_call_ctors()}),z={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},O={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:C,supported:!0,decodeGltfBuffer(B,L,V,j,W,te){(function(ee,Q,pe,ie,me,xe,ye){const we=ee.exports.sbrk,Ae=ie+3&-4,Re=we(Ae*me),Ee=we(xe.length),$e=new Uint8Array(ee.exports.memory.buffer);$e.set(xe,Ee);const Qe=Q(Re,ie,me,Ee,xe.length);if(Qe===0&&ye&&ye(Re,Ae,me),pe.set($e.subarray(Re,Re+ie*me)),we(Re-we(0)),Qe!==0)throw new Error(`Malformed buffer data: ${Qe}`)})(S,S.exports[O[W]],B,L,V,j,S.exports[z[te]])}}}(fetch(Zx()));return g.ready.then(()=>{Ag=g})}()),a)for(let g=0;g<a.length;g++)f.push(j3(a[g],o,g,i));return(f.length?Promise.all(f):Promise.resolve()).then(()=>{if(x&&h)for(const{primitives:g}of h)for(const v of g)N3(v,o);if(w&&h&&y)for(const g of y)V3(g,o);return o})})}function dc(r,e){const i=r.json.bufferViews[e.bufferView],o=Kp[e.componentType];return new o(r.buffers[i.buffer],(e.byteOffset||0)+(i.byteOffset||0),e.count*(i.byteStride&&i.byteStride!==Yd[e.type]*o.BYTES_PER_ELEMENT?i.byteStride/o.BYTES_PER_ELEMENT:Yd[e.type]))}function Pg(r,e,i,o){const u=Kp[e.componentType],a=function(f){switch(f){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(u),h=r.json.bufferViews[e.bufferView],m=h.byteStride?h.byteStride/u.BYTES_PER_ELEMENT:Yd[e.type],y=i.float32,T=y.length/i.capacity;for(let f=0,x=0;f<e.count*m;f+=m,x+=T)for(let w=0;w<T;w++)y[x+w]=o[f+w]*a;i._trim()}function G3(r,e,i){const o=r.indices,u=r.attributes,a={};a.indexArray=new Gn;const h=e.json.accessors[o],m=h.count/3;a.indexArray.reserve(m);const y=dc(e,h);for(let w=0;w<m;w++)a.indexArray.emplaceBack(y[3*w],y[3*w+1],y[3*w+2]);a.indexArray._trim(),a.vertexArray=new vs;const T=e.json.accessors[u.POSITION];a.vertexArray.reserve(T.count);const f=dc(e,T);for(let w=0;w<T.count;w++)a.vertexArray.emplaceBack(f[3*w],f[3*w+1],f[3*w+2]);if(a.vertexArray._trim(),a.aabb=new Lt(T.min,T.max),a.centroid=function(w,g){const v=[0,0,0],S=w.length;if(S>0){for(let C=0;C<S;C++){const z=3*w[C];v[0]+=g[z],v[1]+=g[z+1],v[2]+=g[z+2]}v[0]/=S,v[1]/=S,v[2]/=S}return v}(y,f),u.COLOR_0!==void 0){const w=e.json.accessors[u.COLOR_0],g=Yd[w.type],v=dc(e,w);a.colorArray=g===3?new vs:new ta,a.colorArray.resize(w.count),Pg(e,w,a.colorArray,v)}if(u.NORMAL!==void 0){a.normalArray=new vs;const w=e.json.accessors[u.NORMAL];a.normalArray.resize(w.count);const g=dc(e,w);Pg(e,w,a.normalArray,g)}if(u.TEXCOORD_0!==void 0&&i.length>0){a.texcoordArray=new Wa;const w=e.json.accessors[u.TEXCOORD_0];a.texcoordArray.resize(w.count);const g=dc(e,w);Pg(e,w,a.texcoordArray,g)}if(u._FEATURE_ID_RGBA4444!==void 0){const w=e.json.accessors[u._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(a.featureData=dc(e,w))}u._FEATURE_RGBA4444!==void 0&&(a.featureData=new Uint32Array(dc(e,e.json.accessors[u._FEATURE_RGBA4444]).buffer));const x=r.material;return a.material=function(w,g){const{emissiveFactor:v=[0,0,0],alphaMode:S="OPAQUE",alphaCutoff:C=.5,normalTexture:z,occlusionTexture:O,emissiveTexture:B,doubleSided:L}=w,{baseColorFactor:V=[1,1,1,1],metallicFactor:j=1,roughnessFactor:W=1,baseColorTexture:te,metallicRoughnessTexture:ee}=w.pbrMetallicRoughness||{},Q=O?g[O.index]:void 0;if(O&&O.extensions&&O.extensions.KHR_texture_transform&&Q){const pe=O.extensions.KHR_texture_transform;Q.offsetScale=[pe.offset[0],pe.offset[1],pe.scale[0],pe.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new Mi(...V),metallicFactor:j,roughnessFactor:W,baseColorTexture:te?g[te.index]:void 0,metallicRoughnessTexture:ee?g[ee.index]:void 0},doubleSided:L,emissiveFactor:v,alphaMode:S,alphaCutoff:C,normalTexture:z?g[z.index]:void 0,occlusionTexture:Q,emissionTexture:B?g[B.index]:void 0,defined:w.defined===void 0}}(x!==void 0?e.json.materials[x]:{defined:!1},i),a}function Qx(r,e,i){const{matrix:o,rotation:u,translation:a,scale:h,mesh:m,extras:y,children:T}=r,f={};if(f.matrix=o||Se.mat4.fromRotationTranslationScale([],u||[0,0,0,1],a||[0,0,0],h||[1,1,1]),m!==void 0){f.meshes=i[m];const x=f.anchor=[0,0];for(const w of f.meshes){const{min:g,max:v}=w.aabb;x[0]+=g[0]+v[0],x[1]+=g[1]+v[1]}x[0]=Math.floor(x[0]/f.meshes.length/2),x[1]=Math.floor(x[1]/f.meshes.length/2)}if(y&&(y.id&&(f.id=y.id),y.lights&&(f.lights=function(x){if(!x.length)return[];const w=function(z){const O=atob(z),B=new Uint8Array(O.length);for(let L=0;L<O.length;L++)B[L]=O.codePointAt(L);return B}(x),g=[],v=w.length/24,S=new Uint16Array(w.buffer),C=new Float32Array(w.buffer);for(let z=0;z<v;z++){const O=S[2*z*6]/30,B=S[2*z*6+1]/30,L=S[2*z*6+10]/100,V=C[6*z+1],j=C[6*z+2],W=C[6*z+3],te=C[6*z+4],ee=W-V,Q=te-j,pe=Math.hypot(ee,Q);g.push({pos:[V+.5*ee,j+.5*Q,B],normal:[Q/pe,-ee/pe,0],width:pe,height:O,depth:L,points:[V,j,W,te]})}return g}(y.lights))),T){const x=[];for(const w of T)x.push(Qx(e.json.nodes[w],e,i));f.children=x}return f}function q3(r){if(r.vertices.length===0||r.indices.length===0)return null;const e=new R_(r.vertices,r.indices,8,256),[i,o]=[e.min.clone(),e.max.clone()];return{vertices:r.vertices,indices:r.indices,grid:e,min:i,max:o}}function $3(r){if(!r.extras||!r.extras.ground)return null;const e=r.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;const i=e[0];if(!i||!Array.isArray(i)||i.length===0)return null;const o=[];for(const h of i){if(!Array.isArray(h)||h.length!==2)continue;const m=h[0],y=h[1];typeof m=="number"&&typeof y=="number"&&o.push(new ft(m,y))}if(o.length<3)return null;o.length>1&&o[o.length-1].equals(o[0])&&o.pop();let u=0;for(let h=0;h<o.length;h++){const m=o[h],y=o[(h+1)%o.length],T=o[(h+2)%o.length];u+=(m.x-y.x)*(T.y-y.y)-(T.x-y.x)*(m.y-y.y)}u>0&&o.reverse();const a=bd(o.flatMap(h=>[h.x,h.y]),[]);return a.length===0?null:{vertices:o,indices:a}}function Z3(r,e){const i=[],o=[];let u=0;const a=[];for(const h of r){u=i.length;const m=h.vertexArray.float32,y=h.indexArray.uint16;for(let T=0;T<h.vertexArray.length;T++)a[0]=m[3*T+0],a[1]=m[3*T+1],a[2]=m[3*T+2],Se.vec3.transformMat4(a,a,e),i.push(new ft(a[0],a[1]));for(let T=0;T<3*h.indexArray.length;T++)o.push(y[T]+u)}if(o.length%3!=0)return null;for(let h=0;h<o.length;h+=3){const m=i[o[h+0]],y=i[o[h+1]],T=i[o[h+2]];(m.x-y.x)*(T.y-y.y)-(T.x-y.x)*(m.y-y.y)>0&&([o[h+1],o[h+2]]=[o[h+2],o[h+1]])}return{vertices:i,indices:o}}function ev(r){const e=function(y,T){const f=[],x=WebGL2RenderingContext;if(y.json.textures)for(const w of y.json.textures){const g={magFilter:x.LINEAR,minFilter:x.NEAREST,wrapS:x.REPEAT,wrapT:x.REPEAT};w.sampler!==void 0&&Object.assign(g,y.json.samplers[w.sampler]),f.push({image:T[w.source],sampler:g,uploaded:!1})}return f}(r,r.images),i=function(y,T){const f=[];for(const x of y.json.meshes){const w=[];for(const g of x.primitives)w.push(G3(g,y,T));f.push(w)}return f}(r,e),{scenes:o,scene:u,nodes:a}=r.json,h=o?o[u||0].nodes:a,m=[];for(const y of h)m.push(Qx(a[y],r,i));return function(y,T,f){const x={},w=new Set;for(let g=0;g<y.length;g++){const v=f[T[g]];if(!v.extras)continue;const S=v.extras["mapbox:footprint:version"],C=v.extras["mapbox:footprint:id"];(S||C)&&w.add(g),S==="1.0.0"&&C&&(x[C]=g)}for(let g=0;g<y.length;g++){if(w.has(g))continue;const v=y[g],S=f[T[g]];if(!S.extras)continue;let C=null;v.id in x&&(C=Z3(y[x[v.id]].meshes,v.matrix)),C||(C=$3(S)),C&&(v.footprint=q3(C))}if(w.size>0){const g=Array.from(w.values()).sort((v,S)=>v-S);for(let v=g.length-1;v>=0;v--)y.splice(g[v],1)}}(m,h,r.json.nodes),m}function H3(r){r.heightmap=new Float32Array(4096),r.heightmap.fill(-1);const e=r.vertexArray.float32,i=r.aabb.min[0]-1,o=r.aabb.min[1]-1,u=cc/(r.aabb.max[0]-i+2),a=cc/(r.aabb.max[1]-o+2);for(let h=0;h<e.length;h+=3){const m=e[h+2],y=(e[h+0]-i)*u|0,T=(e[h+1]-o)*a|0;m>r.heightmap[T*cc+y]&&(r.heightmap[T*cc+y]=m)}}function W3(r,e){const i={};i.indexArray=new Gn,i.indexArray.reserve(4*r.length),i.vertexArray=new vs,i.vertexArray.reserve(10*r.length),i.colorArray=new ta,i.vertexArray.reserve(10*r.length);let o=0;for(const h of r){const m=Math.min(10,Math.max(4,1.3*h.height))*e,y=[-h.normal[1],h.normal[0],0],T=Math.min(.29,.1*h.width/h.depth),f=h.width-2*h.depth*e*(T+.01),x=Se.vec3.scaleAndAdd([],h.pos,y,f/2),w=Se.vec3.scaleAndAdd([],h.pos,y,-f/2),g=[x[0],x[1],x[2]+h.height],v=[w[0],w[1],w[2]+h.height],S=Se.vec3.scaleAndAdd([],h.normal,y,T);Se.vec3.scale(S,S,m);const C=Se.vec3.scaleAndAdd([],h.normal,y,-T);Se.vec3.scale(C,C,m),Se.vec3.add(S,x,S),Se.vec3.add(C,w,C),x[2]+=.1,w[2]+=.1,i.vertexArray.emplaceBack(S[0],S[1],S[2]),i.vertexArray.emplaceBack(C[0],C[1],C[2]),i.vertexArray.emplaceBack(x[0],x[1],x[2]),i.vertexArray.emplaceBack(w[0],w[1],w[2]),i.vertexArray.emplaceBack(g[0],g[1],g[2]),i.vertexArray.emplaceBack(v[0],v[1],v[2]),i.vertexArray.emplaceBack(x[0],x[1],x[2]),i.vertexArray.emplaceBack(w[0],w[1],w[2]),i.vertexArray.emplaceBack(S[0],S[1],S[2]),i.vertexArray.emplaceBack(C[0],C[1],C[2]);const z=f/m/2;i.colorArray.emplaceBack(-z-T,-1,z,.8),i.colorArray.emplaceBack(z+T,-1,z,.8),i.colorArray.emplaceBack(-z,0,z,1.3),i.colorArray.emplaceBack(z,0,z,1.3),i.colorArray.emplaceBack(z+T,-.8,z,.7),i.colorArray.emplaceBack(z+T,-.8,z,.7),i.colorArray.emplaceBack(0,0,z,1.3),i.colorArray.emplaceBack(0,0,z,1.3),i.colorArray.emplaceBack(z+T,-1.2,z,.8),i.colorArray.emplaceBack(z+T,-1.2,z,.8),i.indexArray.emplaceBack(6+o,4+o,8+o),i.indexArray.emplaceBack(7+o,9+o,5+o),i.indexArray.emplaceBack(0+o,1+o,2+o),i.indexArray.emplaceBack(1+o,3+o,2+o),o+=10}const u={defined:!0,emissiveFactor:[0,0,0]},a={};return a.baseColorFactor=Mi.white,u.pbrMetallicRoughness=a,i.material=u,i.aabb=new Lt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),i}class tv{constructor(e){this._stringToNumber={},this._numberToString=[];for(let i=0;i<e.length;i++){const o=e[i];this._stringToNumber[o]=i,this._numberToString[i]=o}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}const X3=["id","tile","layer","source","sourceLayer","state"];class Uu{constructor(e,i,o,u,a){this.type="Feature",this._vectorTileFeature=e,this._z=i,this._x=o,this._y=u,this.properties=e.properties,this.id=a}clone(){const e=new Uu(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const i of X3)this[i]!==void 0&&(e[i]=this[i]);return e}}class iv{constructor(e,i){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new Jo(mt,16,0),this.featureIndexArray=new Ql,this.promoteId=i,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,i,o,u,a,h=0,m=0){const y=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(o,u,a,h);const T=this.grid;for(let f=0;f<i.length;f++){const x=i[f],w=[1/0,1/0,-1/0,-1/0];for(let g=0;g<x.length;g++){const v=x[g];w[0]=Math.min(w[0],v.x),w[1]=Math.min(w[1],v.y),w[2]=Math.max(w[2],v.x),w[3]=Math.max(w[3],v.y)}m!==0&&(w[0]-=m,w[1]-=m,w[2]+=m,w[3]+=m),w[0]<mt&&w[1]<mt&&w[2]>=0&&w[3]>=0&&T.insert(y,w[0],w[1],w[2],w[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Iu.VectorTile(new bp(this.rawTileData)).layers,this.sourceLayerCoder=new tv(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,i){const{tilespaceGeometry:o,transform:u,tileTransform:a,pixelPosMatrix:h,availableImages:m}=i;this.loadVTLayers(),this.serializedLayersCache.clear();const y=o.bufferedTilespaceBounds,T=this.grid.query(y.min.x,y.min.y,y.max.x,y.max.y,(g,v,S,C)=>ge(o.bufferedTilespaceGeometry,g,v,S,C));T.sort(Y3);let f=null;u.elevation&&T.length>0&&(f=Lu.create(u.elevation,this.tileID));const x={};let w;for(let g=0;g<T.length;g++){const v=T[g];if(v===w)continue;w=v;const S=this.featureIndexArray.get(v);let C=null;this.is3DTile?this.loadMatchingModelFeature(x,S,e,o,u):this.loadMatchingFeature(x,S,e,m,(z,O,B,L=0)=>(C||(C=A(z,this.tileID.canonical,a)),O.queryIntersectsFeature(o,z,B,C,this.z,u,h,f,L)))}return x}loadMatchingFeature(e,i,o,u,a){const{featureIndex:h,bucketIndex:m,sourceLayerIndex:y,layoutVertexArrayOffset:T}=i,f=this.bucketLayerIDs[m],x=o.layers,w=Object.keys(x);if(w.length&&!function(z,O){for(let B=0;B<z.length;B++)if(O.indexOf(z[B])>=0)return!0;return!1}(w,f))return;const g=o.sourceCache,v=this.sourceLayerCoder.decode(y),S=this.vtLayers[v].feature(h),C=this.getId(S,v);for(let z=0;z<f.length;z++){const O=f[z];if(!x[O])continue;const{styleLayer:B,targets:L}=x[O];let V={};C!==void 0&&(V=g.getFeatureState(B.sourceLayer,C));const j=!a||a(S,B,V,T);if(!j)continue;const W=new Uu(S,this.z,this.x,this.y,C);W.tile=this.tileID.canonical,W.state=V;let te=this.serializedLayersCache.get(O);te||(te=B.serialize(),te.id=O,this.serializedLayersCache.set(O,te)),W.source=te.source,W.sourceLayer=te["source-layer"],W.layer=sr({},te),W.layer.paint=nv(te.paint,B.paint,S,V,u),W.layer.layout=nv(te.layout,B.layout,S,V,u);let ee=!1;for(const Q of L){this.updateFeatureProperties(W,Q);const{filter:pe}=Q;if(pe){if(S.properties=W.properties,pe.needGeometry){const ie=R(S,!0);if(!pe.filter(new Vi(this.tileID.overscaledZ),ie,this.tileID.canonical))continue}else if(!pe.filter(new Vi(this.tileID.overscaledZ),S))continue}ee=!0,Q.targetId&&this.addFeatureVariant(W,Q)}ee&&this.appendToResult(e,O,h,W,j)}}loadMatchingModelFeature(e,i,o,u,a){const h=this.bucketLayerIDs[0][0],m=o.layers;if(!m[h])return;const{styleLayer:y,targets:T}=m[h];if(y.type!=="model")return;const f=u.tile,x=i.featureIndex,w=f.getBucket(y);if(!(w&&w instanceof Gp))return;const g=function(te,ee,Q,pe){const ie=te.getNodesInfo()[ee];if(ie.hiddenByReplacement||!ie.node.meshes)return;let me=Number.MAX_VALUE;const xe=ie.node,ye=Q.tile,we=pe.calculatePosMatrix(ye.tileID.toUnwrapped(),pe.worldSize),Ae=ie.evaluatedScale;let Re=0;pe.elevation&&xe.elevation&&(Re=xe.elevation*pe.elevation.exaggeration()),Se.mat4.translate(we,we,[(xe.anchor?xe.anchor[0]:0)*(Ae[0]-1),(xe.anchor?xe.anchor[1]:0)*(Ae[1]-1),Re]),Se.mat4.scale(we,we,Ae);const Ee=Q.queryGeometry,$e=Ee.isPointQuery()?Ee.screenBounds:Ee.screenGeometry,Qe=function(_t){const pt=Se.mat4.multiply([],we,_t.matrix);Se.mat4.multiply(pt,pe.expandedFarZProjMatrix,pt);for(let rt=0;rt<_t.meshes.length;++rt){const et=_t.meshes[rt];if(rt===_t.lightMeshIndex)continue;const Pt=tx($e,pe,pt,et.aabb);Pt!=null&&(me=Math.min(Pt,me))}if(_t.children)for(const rt of _t.children)Qe(rt)};if(Qe(xe),me===Number.MAX_VALUE)return;const qe=new bi(0,0);return fx(ye.tileID.canonical,qe,ie.node.anchor[0],ie.node.anchor[1]),{intersectionZ:me,position:qe,feature:ie.feature}}(w,x,u,a);if(!g)return;const{z:v,x:S,y:C}=f.tileID.canonical,{feature:z,intersectionZ:O,position:B}=g;let L={};z.id!==void 0&&(L=o.sourceCache.getFeatureState(y.sourceLayer,z.id));const V=new Uu({},v,S,C,z.id);V.tile=this.tileID.canonical,V.state=L,V.properties=z.properties,V.geometry={type:"Point",coordinates:[B.lng,B.lat]};let j=this.serializedLayersCache.get(h);j||(j=y.serialize(),j.id=h,this.serializedLayersCache.set(h,j)),V.source=j.source,V.sourceLayer=j["source-layer"],V.layer=sr({},j);let W=!1;for(const te of T){this.updateFeatureProperties(V,te);const{filter:ee}=te;if(ee){if(z.properties=V.properties,ee.needGeometry){if(!ee.filter(new Vi(this.tileID.overscaledZ),z,this.tileID.canonical))continue}else if(!ee.filter(new Vi(this.tileID.overscaledZ),z))continue}W=!0,te.targetId&&this.addFeatureVariant(V,te)}W&&this.appendToResult(e,h,x,V,O)}updateFeatureProperties(e,i,o){if(i.properties){const u={};for(const a in i.properties){const h=i.properties[a].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,o);h!=null&&(u[a]=h)}e.properties=u}}addFeatureVariant(e,i,o){const u={target:i.target,namespace:i.namespace,uniqueFeatureID:i.uniqueFeatureID};i.properties&&(u.properties=e.properties),e.variants=e.variants||{},e.variants[i.targetId]=e.variants[i.targetId]||[],e.variants[i.targetId].push(u)}appendToResult(e,i,o,u,a){let h=e[i];h===void 0&&(h=e[i]=[]),h.push({featureIndex:o,feature:u,intersectionZ:a})}lookupSymbolFeatures(e,i,o,u,a){const h={};this.loadVTLayers();for(const m of e)this.loadMatchingFeature(h,{bucketIndex:i,sourceLayerIndex:o,featureIndex:m,layoutVertexArrayOffset:0},u,a);return h}loadFeature(e){const{featureIndex:i,sourceLayerIndex:o}=e;this.loadVTLayers();const u=this.sourceLayerCoder.decode(o),a=this.vtFeatures[u];if(a[i])return a[i];const h=this.vtLayers[u].feature(i);return a[i]=h,h}hasLayer(e){for(const i of this.bucketLayerIDs)for(const o of i)if(e===o)return!0;return!1}getId(e,i){let o=e.id;if(this.promoteId){const u=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[i];if(u!=null)if(Array.isArray(u)){if(!this.promoteIdExpression){const a=Va(u);if(a.result!=="success"){const h=a.value.map(m=>`${m.key}: ${m.message}`).join(", ");return void ti(`Failed to create expression for promoteId: ${h}`)}this.promoteIdExpression=a.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new hh),o=this.promoteIdExpression.evaluate({zoom:0},e)}else o=e.properties[u];typeof o=="boolean"&&(o=Number(o))}return o}}function nv(r,e,i,o,u){return Ta(r,(a,h)=>{const m=e instanceof qa?e.get(h):null;return m&&m.evaluate?m.evaluate(i,o,u):m})}function Y3(r,e){return e-r}Mt(iv,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const rv=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class zg{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[i,o]=new Uint8Array(e,0,2);if(i!==219)throw new Error("Data does not appear to be in a KDBush format.");const u=o>>4;if(u!==1)throw new Error(`Got v${u} data when expected v1.`);const a=rv[15&o];if(!a)throw new Error("Unrecognized array type.");const[h]=new Uint16Array(e,2,1),[m]=new Uint32Array(e,4,1);return new zg(m,h,a,e)}constructor(e,i=64,o=Float64Array,u){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+i,2),65535),this.ArrayType=o,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const a=rv.indexOf(this.ArrayType),h=2*e*this.ArrayType.BYTES_PER_ELEMENT,m=e*this.IndexArrayType.BYTES_PER_ELEMENT,y=(8-m%8)%8;if(a<0)throw new Error(`Unexpected typed array class: ${o}.`);u&&u instanceof ArrayBuffer?(this.data=u,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+m+y,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+h+m+y),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+m+y,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+a]),new Uint16Array(this.data,2,1)[0]=i,new Uint32Array(this.data,4,1)[0]=e)}add(e,i){const o=this._pos>>1;return this.ids[o]=o,this.coords[this._pos++]=e,this.coords[this._pos++]=i,o}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return Rg(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,i,o,u){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:a,coords:h,nodeSize:m}=this,y=[0,a.length-1,0],T=[];for(;y.length;){const f=y.pop()||0,x=y.pop()||0,w=y.pop()||0;if(x-w<=m){for(let C=w;C<=x;C++){const z=h[2*C],O=h[2*C+1];z>=e&&z<=o&&O>=i&&O<=u&&T.push(a[C])}continue}const g=w+x>>1,v=h[2*g],S=h[2*g+1];v>=e&&v<=o&&S>=i&&S<=u&&T.push(a[g]),(f===0?e<=v:i<=S)&&(y.push(w),y.push(g-1),y.push(1-f)),(f===0?o>=v:u>=S)&&(y.push(g+1),y.push(x),y.push(1-f))}return T}within(e,i,o){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:u,coords:a,nodeSize:h}=this,m=[0,u.length-1,0],y=[],T=o*o;for(;m.length;){const f=m.pop()||0,x=m.pop()||0,w=m.pop()||0;if(x-w<=h){for(let C=w;C<=x;C++)ov(a[2*C],a[2*C+1],e,i)<=T&&y.push(u[C]);continue}const g=w+x>>1,v=a[2*g],S=a[2*g+1];ov(v,S,e,i)<=T&&y.push(u[g]),(f===0?e-o<=v:i-o<=S)&&(m.push(w),m.push(g-1),m.push(1-f)),(f===0?e+o>=v:i+o>=S)&&(m.push(g+1),m.push(x),m.push(1-f))}return y}}function Rg(r,e,i,o,u,a){if(u-o<=i)return;const h=o+u>>1;sv(r,e,h,o,u,a),Rg(r,e,i,o,h-1,1-a),Rg(r,e,i,h+1,u,1-a)}function sv(r,e,i,o,u,a){for(;u>o;){if(u-o>600){const T=u-o+1,f=i-o+1,x=Math.log(T),w=.5*Math.exp(2*x/3),g=.5*Math.sqrt(x*w*(T-w)/T)*(f-T/2<0?-1:1);sv(r,e,i,Math.max(o,Math.floor(i-f*w/T+g)),Math.min(u,Math.floor(i+(T-f)*w/T+g)),a)}const h=e[2*i+a];let m=o,y=u;for(Kd(r,e,o,i),e[2*u+a]>h&&Kd(r,e,o,u);m<y;){for(Kd(r,e,m,y),m++,y--;e[2*m+a]<h;)m++;for(;e[2*y+a]>h;)y--}e[2*o+a]===h?Kd(r,e,o,y):(y++,Kd(r,e,y,u)),y<=i&&(o=y+1),i<=y&&(u=y-1)}}function Kd(r,e,i,o){Dg(r,i,o),Dg(e,2*i,2*o),Dg(e,2*i+1,2*o+1)}function Dg(r,e,i){const o=r[e];r[e]=r[i],r[i]=o}function ov(r,e,i,o){const u=r-i,a=e-o;return u*u+a*a}s.$=Jh,s.A=Zn,s.B=2,s.C=Dd,s.D=ku,s.E=uo,s.F=y1,s.G=class extends Up{},s.H=Qr,s.I=wg,s.J=Fc,s.K=Gf,s.L=Fl,s.M=Ol,s.N=iu,s.O=Na,s.P=ft,s.Q=hu,s.R=Si,s.S=Vf,s.T=lg,s.U=Va,s.V=Up,s.W=Pl,s.X=Xo,s.Y=Ra,s.Z=pr,s._=Nr,s.a=function(r){return Mn.API_CDN_URL_REGEX.test(r)},s.a$=Uu,s.a0=Nh,s.a1=Ff,s.a2=function(r){const e=r.value;let i=[];if(!e)return i;const o=Qr(e);return o!=="string"?(i=i.concat([new Up(r.key,e,`string expected, "${o}" found`)]),i):(nx(e,!0)||(i=i.concat([new Up(r.key,e,`invalid url "${e}"`)])),i)},s.a3=ke,s.a4=uu,s.a5=Yi,s.a6=at,s.a7=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return xr(r.expression.evaluate(e))}interpolate(r,e,i){return{x:Gt(r.x,e.x,i),y:Gt(r.y,e.y,i),z:Gt(r.z,e.z,i),azimuthal:Gt(r.azimuthal,e.azimuthal,i),polar:Gt(r.polar,e.polar,i)}}},s.a8=Vi,s.a9=Bl,s.aA=ts,s.aB=class{constructor(r){this.entries={},this.scheduler=r}request(r,e,i,o){const u=this.entries[r]=this.entries[r]||{callbacks:[]};if(u.result){const[a,h]=u.result;return this.scheduler?this.scheduler.add(()=>{o(a,h)},e):o(a,h),()=>{}}return u.callbacks.push(o),u.cancel||(u.cancel=i((a,h)=>{u.result=[a,h];for(const m of u.callbacks)this.scheduler?this.scheduler.add(()=>{m(a,h)},e):m(a,h);setTimeout(()=>delete this.entries[r],3e3)})),()=>{u.result||(u.callbacks=u.callbacks.filter(a=>a!==o),u.callbacks.length||(u.cancel(),delete this.entries[r]))}}},s.aC=xs,s.aD=function(r,e,i){const o=JSON.stringify(r.request);return r.data&&(this.deduped.entries[o]={result:[null,r.data]}),this.deduped.request(o,{type:"parseTile",isSymbolTile:r.isSymbolTile,zoom:r.tileZoom},u=>{const a=Cn(r.request,(h,m,y,T)=>{h?u(h):m&&u(null,{vectorTile:i?void 0:new Iu.VectorTile(new bp(m)),rawData:m,cacheControl:y,expires:T})});return()=>{a.cancel(),u()}},e)},s.aE=function(r){Ot++,Ot>Fe&&(r.getActor().send("enforceCacheSizeLimit",be),Ot=0)},s.aF=function(r){return r<=1?1:Math.pow(2,Math.floor(Math.log(r)/Math.LN2))},s.aG=nt,s.aH=q1,s.aI=Y1,s.aJ=G1,s.aK=function(r,e){const i=document.createElement("video");i.muted=!0,i.onloadstart=function(){e(null,i)};for(let o=0;o<r.length;o++){const u=document.createElement("source");or(r[o])||(i.crossOrigin="Anonymous"),u.src=r[o],i.appendChild(u)}return{cancel:()=>{}}},s.aL=Op,s.aM=function(r){return fetch(r).then(e=>e.arrayBuffer()).then(e=>Jx(e,0,r))},s.aN=ev,s.aO=class{constructor(r,e,i,o){this.id=r,this.position=e!=null?new bi(e[0],e[1]):new bi(0,0),this.orientation=i??[0,0,0],this.nodes=o,this.uploaded=!1,this.aabb=new Lt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(r,e){if(Se.mat4.multiply(r.matrix,e,r.matrix),r.meshes)for(const i of r.meshes){const o=Lt.applyTransformFast(i.aabb,r.matrix);this.aabb.encapsulate(o)}if(r.children)for(const i of r.children)this._applyTransformations(i,r.matrix)}computeBoundsAndApplyParent(){const r=Se.mat4.identity([]);for(const e of this.nodes)this._applyTransformations(e,r)}computeModelMatrix(r,e,i,o,u,a,h=!1){lx(this.matrix,this,r.transform,this.position,e,i,o,u,a,h)}upload(r){if(!this.uploaded){for(const e of this.nodes)fg(e,r);for(const e of this.nodes)jp(e);this.uploaded=!0}}destroy(){for(const r of this.nodes)pg(r)}},s.aP=wa,s.aQ=kd,s.aR=Tr,s.aS=qn,s.aT=Ks,s.aU=Gn,s.aV=Bo,s.aW=dd,s.aX=Lp,s.aY=function(){Ar.isLoading()||Ar.isLoaded()||lu()!=="deferred"||jl()},s.aZ=qf,s.a_=R,s.aa=n,s.ab=Se,s.ac=us,s.ad=qa,s.ae=gr,s.af=Gt,s.ag=mt,s.ah=bf,s.ai=pi,s.aj=Mi,s.ak=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return function([i,o]){const u=xr([1,i,o]);return{x:u.x,y:u.y,z:u.z}}(r.expression.evaluate(e))}interpolate(r,e,i){return{x:Gt(r.x,e.x,i),y:Gt(r.y,e.y,i),z:Gt(r.z,e.z,i)}}},s.al=function(r,e,i=0,o=!0){const u=new ft(i,i),a=r.sub(u),h=e.add(u),m=[a,new ft(h.x,a.y),h,new ft(a.x,h.y)];return o&&m.push(a.clone()),m},s.am=function(r,e){const i=[];for(let o=0;o<r.length;o++){const u=Xr(o-1,-1,r.length-1),a=Xr(o+1,-1,r.length-1),h=r[o],m=r[a],y=r[u].sub(h).unit(),T=m.sub(h).unit(),f=T.angleWithSep(y.x,y.y),x=y.add(T).unit().mult(-1*e/Math.sin(f/2));i.push(h.add(x))}return i},s.an=C1,s.ao=ge,s.ap=function(r,e,i=0){return Se.vec3.fromValues(((e.x-i)*r.scale-r.x)*mt,(e.y*r.scale-r.y)*mt,cp(e.z,e.y))},s.aq=Yt,s.ar=W0,s.as=function(r){let e=1/0,i=1/0,o=-1/0,u=-1/0;for(const a of r)e=Math.min(e,a.x),i=Math.min(i,a.y),o=Math.max(o,a.x),u=Math.max(u,a.y);return{min:new ft(e,i),max:new ft(o,u)}},s.at=Ts,s.au=ae,s.av=d,s.aw=ri,s.ax=lr,s.ay=function(r,e){const i={};for(let o=0;o<e.length;o++){const u=e[o];u in r&&(i[u]=r[u])}return i},s.az=To,s.b=function(r){return Mn.API_FONTS_REGEX.test(r)},s.b$=Np,s.b0=Ea,s.b1=U_,s.b2=z_,s.b3=A,s.b4=Ys,s.b5=ud,s.b6=Bt,s.b7=an,s.b8=bd,s.b9=sg,s.bA=M0,s.bB=Q_,s.bC=E1,s.bD=Y_,s.bE=zg,s.bF=Xr,s.bG=Ia,s.bH=cr,s.bI=function(r,e,i){r[4*e+0]=i[0],r[4*e+1]=i[1],r[4*e+2]=i[2],r[4*e+3]=i[3]},s.bJ=sc,s.bK=jr,s.bL=Xa,s.bM=ln,s.bN=nc,s.bO=bi,s.bP=L1,s.bQ=Xe,s.bR=xi,s.bS=J1,s.bT=Je,s.bU=Qn,s.bV=function(r,e,i,o,u,a,h,m,y){if(y.name==="globe")return Qn(r,e,new Je(i,o,u),!1);const T=kd({z:i,x:o,y:u},y);return new Lt([(a+T.x/T.scale)*e,e*(T.y/T.scale),h],[(a+T.x2/T.scale)*e,e*(T.y2/T.scale),m])},s.bW=function(r,e,i){let o=0;for(let u=0;u<2;++u)r[u]>0&&(o+=(r[u]-0)*(r[u]-0)),e[u]<0&&(o+=(0-e[u])*(0-e[u]));return o},s.bX=_r,s.bY=ap,s.bZ=function(r){const e=Se.mat4.identity(new Float64Array(16));Se.mat4.multiply(e,r.pixelMatrix,r.globeMatrix);const i=[0,Cr,0],o=[0,Pr,0];return Se.vec3.transformMat4(i,i,e),Se.vec3.transformMat4(o,o,e),[i[0]>0&&i[0]<=r.width&&i[1]>0&&i[1]<=r.height&&!qr(r,new bi(r.center.lat,90)),o[0]>0&&o[0]<=r.width&&o[1]>0&&o[1]<=r.height&&!qr(r,new bi(r.center.lat,-90))]},s.b_=function(r,e){const{scale:i}=r.tileTransform,o=i*mt/(r.tileSize*Math.pow(2,e.zoom-r.tileID.overscaledZ+r.tileID.canonical.z));return Se.mat2.scale(new Float32Array(4),e.inverseAdjustmentMatrix,[o,o])},s.ba=function(r,e){const i=gr(e.zoom);if(i===0)return vn(r);const o=Ji(r),u=Bi(o),a=Ts(o.getWest())*e.worldSize,h=Ts(o.getEast())*e.worldSize,m=ts(o.getNorth())*e.worldSize,y=ts(o.getSouth())*e.worldSize,T=[a,m,0],f=[h,m,0],x=[a,y,0],w=[h,y,0],g=Se.mat4.invert([],e.globeMatrix);return Se.vec3.transformMat4(T,T,g),Se.vec3.transformMat4(f,f,g),Se.vec3.transformMat4(x,x,g),Se.vec3.transformMat4(w,w,g),u[0]=bn(u[0],x,i),u[1]=bn(u[1],w,i),u[2]=bn(u[2],f,i),u[3]=bn(u[3],T,i),Lt.fromPoints(u)},s.bb=zn,s.bc=Li,s.bd=bn,s.be=Ha,s.bf=kt,s.bg=Mg,s.bh=bp,s.bi=Cn,s.bj=function(r){const e=[];for(const i in r)e.push(r[i]);return e},s.bk=function(r,e){const i=[];for(const o in r)o in e||i.push(o);return i},s.bl=lo,s.bm=["type","source","source-layer","minzoom","maxzoom","filter","layout"],s.bn=rr,s.bo=function(r,e){const{x:i,y:o}=r.point,u=Sr(i,o,r.worldSize/r._pixelsPerMercatorPixel,0,0);return Se.mat4.multiply(u,u,Fi(vn(e)))},s.bp=Au,s.bq=is,s.br=vp,s.bs=function(r,e,i,o,u){const a=5*e+2;r.float32[a+0]=i,r.float32[a+1]=o,r.float32[a+2]=u},s.bt=Dp,s.bu=g1,s.bv=U,s.bw=tr,s.bx=v0,s.by=ix,s.bz=E0,s.c=Lc,s.c$=(r,e,i,o,u,a,h,m)=>{const y=r.transform,T=y.pitch<15?X0(.07,.7,ri((14-y.zoom)/5,0,1)):.07,f=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:K0(r,e,i,o),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:y.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:u,u_width_scale:a,u_floor_width_scale:h,u_image:0,u_tile_units_to_pixels:Y0(e,y),u_units_to_pixels:[1/y.pixelsToGLUnits[0],1/y.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:m,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toRenderColor(f?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:T,u_tile_to_meter:t(e.tileID.canonical,0)}},s.c0=K1,s.c1=function(r){const e=K1(r,!0);return Se.mat2.invert([],[e[0],e[1],e[4],e[5]])},s.c2=fi,s.c3=function(r){const{x:e,y:i}=r.point,{lng:o,lat:u}=r._center;return Sr(e,i,r.worldSize,o,u)},s.c4=Nn,s.c5=lt,s.c6=Ya,s.c7=function(r){const e=Math.round((r+45+360)%360/90)%4;return Br[e]},s.c8=45,s.c9=Su,s.cA=class extends ws{constructor(r){super(r),this.current=pd}set(r,e,i){if(this.fetchUniformLocation(r,e)){for(let o=0;o<9;o++)if(i[o]!==this.current[o]){this.current=i,this.gl.uniformMatrix3fv(this.location,!1,i);break}}}},s.cB=ao,s.cC=function(r,e,i){const o=gr(i.zoom),u=r.style.map._antialias,a=r.terrain&&r.terrain.exaggeration()>0;return o===0&&!u&&!a},s.cD=function(r){const e=r.pixelsPerMeter,i=e/cr(1,r.center.lat),o=Se.mat4.identity(new Float64Array(16));return Se.mat4.translate(o,o,[r.point.x,r.point.y,0]),Se.mat4.scale(o,o,[i,i,e]),Float32Array.from(o)},s.cE=Ji,s.cF=function(r){const e=_r-5;r=ri(r,-80.051129,e)/e*90;const i=Math.pow(Math.abs(Math.sin(pi(r))),3);return Math.round(i*(Tu.length-1))},s.cG=function(r,e,i,o){const u=e.getNorth(),a=e.getSouth(),h=e.getWest(),m=e.getEast(),y=1<<r.z,T=m-h,f=u-a,x=T/Ka,w=-f/Tu[i],g=[0,x,0,w,0,0,u,h,0];if(r.z>0){const v=180/o;Se.mat3.multiply(g,g,[v/T+1,0,0,0,v/f+1,0,-.5*v/x,.5*v/w,1])}return g[2]=y,g[5]=r.x,g[8]=r.y,g},s.cH=vn,s.cI=function(r,e,i){const o=Se.mat4.identity(new Float64Array(16)),u=(e/(1<<r)-.5)*Math.PI*2;return Se.mat4.rotateY(o,i.globeMatrix,u),Float32Array.from(o)},s.cJ=class{isDataAvailableAtPoint(r){const e=this._source();if(this.isUsingMockSource()||!e||r.y<0||r.y>1)return!1;const i=e.getSource().maxzoom,o=1<<i,u=Math.floor(r.x),a=Math.floor((r.x-u)*o),h=Math.floor(r.y*o),m=this.findDEMTileFor(new nt(i,u,i,a,h));return!(!m||!m.dem)}getAtPointOrZero(r,e=0){return this.getAtPoint(r,e)||0}getAtPoint(r,e,i=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);const o=this._source();if(!o||r.y<0||r.y>1)return e;const u=o.getSource().maxzoom,a=1<<u,h=Math.floor(r.x),m=r.x-h,y=new nt(u,h,u,Math.floor(m*a),Math.floor(r.y*a)),T=this.findDEMTileFor(y);if(!T||!T.dem)return e;const f=T.dem,x=1<<T.tileID.canonical.z,w=(m*x-T.tileID.canonical.x)*f.dim,g=(r.y*x-T.tileID.canonical.y)*f.dim,v=Math.floor(w),S=Math.floor(g);return(i?this.exaggeration():1)*Gt(Gt(f.get(v,S),f.get(v,S+1),g-S),Gt(f.get(v+1,S),f.get(v+1,S+1),g-S),w-v)}getAtTileOffset(r,e,i){const o=1<<r.canonical.z;return this.getAtPointOrZero(new n(r.wrap+(r.canonical.x+e/mt)/o,(r.canonical.y+i/mt)/o))}getAtTileOffsetFunc(r,e,i,o){return u=>{const a=this.getAtTileOffset(r,u.x,u.y),h=o.upVector(r.canonical,u.x,u.y),m=o.upVectorScale(r.canonical,e,i).metersToTile;return Se.vec3.scale(h,h,a*m),h}}getForTilePoints(r,e,i,o){if(this.isUsingMockSource())return!1;const u=Lu.create(this,r,o);return!!u&&(e.forEach(a=>{a[2]=this.exaggeration()*u.getElevationAt(a[0],a[1],i)}),!0)}getMinMaxForTile(r){if(this.isUsingMockSource())return null;const e=this.findDEMTileFor(r);if(!e||!e.dem)return null;const i=e.dem.tree,o=e.tileID,u=1<<r.canonical.z-o.canonical.z;let a=r.canonical.x/u-o.canonical.x,h=r.canonical.y/u-o.canonical.y,m=0;for(let y=0;y<r.canonical.z-o.canonical.z&&!i.leaves[m];y++){a*=2,h*=2;const T=2*Math.floor(h)+Math.floor(a);m=i.childOffsets[m]+T,a%=1,h%=1}return{min:this.exaggeration()*i.minimums[m],max:this.exaggeration()*i.maximums[m]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(r,e,i){throw new Error("Pure virtual method called.")}pointCoordinate(r){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(r){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const r=this.visibleDemTiles;if(r.length===0)return null;let e=!1,i=Number.MAX_VALUE,o=Number.MIN_VALUE;for(const u of r){const a=this.getMinMaxForTile(u.tileID);a&&(i=Math.min(i,a.min),o=Math.max(o,a.max),e=!0)}return e?{min:i,max:o}:null}},s.cK=Qy,s.cL=hi,s.cM=function(r,e){return[Math.pow(r[0],2.2)*e,Math.pow(r[1],2.2)*e,Math.pow(r[2],2.2)*e]},s.cN=Gr,s.cO=Dc,s.cP=Rc,s.cQ=256,s.cR=function(r,e){const i=[0,0,0],o=zn(vn(e.canonical));return Se.vec3.transformMat4(i,i,o),Se.vec3.transformMat4(i,i,r),i},s.cS=r=>({u_camera_to_center_distance:new ln(r),u_extrude_scale:new md(r),u_device_pixel_ratio:new ln(r),u_matrix:new sc(r),u_inv_rot_matrix:new sc(r),u_merc_center:new jr(r),u_tile_id:new Xa(r),u_zoom_transition:new ln(r),u_up_dir:new Xa(r),u_emissive_strength:new ln(r)}),s.cT=r=>({u_matrix:new sc(r),u_pixels_to_tile_units:new md(r),u_device_pixel_ratio:new ln(r),u_width_scale:new ln(r),u_floor_width_scale:new ln(r),u_units_to_pixels:new jr(r),u_dash_image:new nc(r),u_gradient_image:new nc(r),u_image_height:new ln(r),u_texsize:new jr(r),u_tile_units_to_pixels:new ln(r),u_alpha_discard_threshold:new ln(r),u_trim_offset:new jr(r),u_trim_fade_range:new jr(r),u_trim_color:new rc(r),u_emissive_strength:new ln(r),u_zbias_factor:new ln(r),u_tile_to_meter:new ln(r)}),s.cU=r=>({u_matrix:new sc(r),u_texsize:new jr(r),u_pixels_to_tile_units:new md(r),u_device_pixel_ratio:new ln(r),u_width_scale:new ln(r),u_floor_width_scale:new ln(r),u_image:new nc(r),u_units_to_pixels:new jr(r),u_tile_units_to_pixels:new ln(r),u_alpha_discard_threshold:new ln(r),u_trim_offset:new jr(r),u_trim_fade_range:new jr(r),u_trim_color:new rc(r),u_emissive_strength:new ln(r),u_zbias_factor:new ln(r),u_tile_to_meter:new ln(r)}),s.cV=sd,s.cW=Qw,s.cX=e2,s.cY=el,s.cZ=(r,e,i,o,u,a)=>{const h=r.transform,m=h.projection.name==="globe";let y;if(a.paint.get("circle-pitch-alignment")==="map")if(m){const f=Gr(h.zoom,e.canonical)*h._pixelsPerMercatorPixel;y=Float32Array.from([f,0,0,f])}else y=h.calculatePixelsToTileUnitsMatrix(i);else y=new Float32Array([h.pixelsToGLUnits[0],0,0,h.pixelsToGLUnits[1]]);const T={u_camera_to_center_distance:r.transform.getCameraToCenterDistance(h.projection),u_matrix:r.translatePosMatrix(e.projMatrix,i,a.paint.get("circle-translate"),a.paint.get("circle-translate-anchor")),u_device_pixel_ratio:ue.devicePixelRatio,u_extrude_scale:y,u_inv_rot_matrix:la,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:a.paint.get("circle-emissive-strength")};if(m){T.u_inv_rot_matrix=o,T.u_merc_center=u,T.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],T.u_zoom_transition=gr(h.zoom);const f=u[0]*mt,x=u[1]*mt;T.u_up_dir=h.projection.upVector(new Je(0,0,0),f,x)}return T},s.c_=J0,s.ca=rc,s.cb=function(r,e,i){const o=Math.sqrt(r*r+e*e+i*i),u=o>0?Math.acos(i/o)*va:0;let a=r!==0||e!==0?Math.atan2(-e,-r)*va+90:0;return a<0&&(a+=360),[o,a,u]},s.cc=t,s.cd=Lt,s.ce=xr,s.cf=function(r){return[Math.pow(r[0],1/2.2),Math.pow(r[1],1/2.2),Math.pow(r[2],1/2.2)]},s.cg=function(r,e){return r.readFields(Z2,{icons:[]},e)},s.ch=function(r){return r({pluginStatus:br,pluginURL:go}),Ua.on("pluginStateChange",r),r},s.ci=qp,s.cj=Pu,s.ck=K_,s.cl=fs,s.cm=Xh,s.cn=ve,s.co=Kr,s.cp=Mr,s.cq=function(r){const e=r.indexOf(fu);return e>=0?r.slice(0,e):r},s.cr=function(r){return r.indexOf(fu)>=0},s.cs=function(r){const e=r.indexOf(fu);return e>=0?r.slice(e+1):""},s.ct=function(r){const e=[],i=r.id;return i===void 0&&e.push({message:`layers.${i}: missing required property "id"`}),r.render===void 0&&e.push({message:`layers.${i}: missing required method "render"`}),r.renderingMode&&r.renderingMode!=="2d"&&r.renderingMode!=="3d"&&e.push({message:`layers.${i}: property "renderingMode" must be either "2d" or "3d"`}),e},s.cu=function(r,e,i,o){return r.type==="custom"?new R2(r,e):new G2[r.type](r,e,i,o)},s.cv=Sa,s.cw=class extends Uu{constructor(r,e){super(r._vectorTileFeature,r._z,r._x,r._y,r.id),r.state&&(this.state=Object.assign({},r.state)),this.target=e.target,this.namespace=e.namespace,e.properties&&(this.properties=e.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=r.source,this.sourceLayer=r.sourceLayer,this.layer=r.layer)}toJSON(){const r=super.toJSON();return r.target=this.target,r.namespace=this.namespace,r}},s.cx=Ua,s.cy=In,s.cz=rp,s.d=function(r){return Mn.API_TILEJSON_REGEX.test(r)},s.d$=iv,s.d0=(r,e,i,o,u,a,h,m,y)=>{const T=r.transform,f=T.calculatePixelsToTileUnitsMatrix(e),x=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none",w=T.pitch<15?X0(.07,.7,ri((14-T.zoom)/5,0,1)):.07;return{u_matrix:K0(r,e,i,o),u_pixels_to_tile_units:f,u_device_pixel_ratio:a,u_width_scale:h,u_floor_width_scale:m,u_units_to_pixels:[1/T.pixelsToGLUnits[0],1/T.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:u,u_texsize:Q0(i)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:Y0(e,r.transform),u_alpha_discard_threshold:0,u_trim_offset:y,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toRenderColor(x?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:w,u_tile_to_meter:t(e.tileID.canonical,0)}},s.d1=ba,s.d2=vd,s.d3=N0,s.d4=bt,s.d5=xp,s.d6=il,s.d7=450,s.d8=7,s.d9=z2,s.dA=Fo,s.dB=l,s.dC=sa,s.dD=function([r,e,i]){const o=Math.hypot(r,e,i),u=Math.atan2(r,i),a=.5*Math.PI-Math.acos(-e/o);return new bi(Nn(u),Nn(a))},s.dE=ug,s.dF=function(r){const e=r.navigator?r.navigator.userAgent:null;return!!function(i){if(Ma==null){const o=i.navigator?i.navigator.userAgent:null;Ma=!!i.safari||!(!o||!(/\b(iPad|iPhone|iPod)\b/.test(o)||o.match("Safari")&&!o.match("Chrome")))}return Ma}(r)&&e&&(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},s.dG=function(r,e){be=r,Fe=e},s.dH=qr,s.dI=Ss,s.dJ=function(r){const e=[0,0,0],i=Se.mat4.identity(new Float64Array(16));return Se.mat4.multiply(i,r.pixelMatrix,r.globeMatrix),Se.vec3.transformMat4(e,e,i),new ft(e[0],e[1])},s.dK=function(r,e,i=!1){if(br===Ul||br===au||br===Wh)throw new Error("setRTLTextPlugin cannot be called multiple times.");go=ue.resolveURL(r),br=Ul,ys=e,Yh(),i||jl()},s.dL=lu,s.dM=function(){qp().acquire(_g)},s.dN=function(){const r=Gd;r&&(r.isPreloaded()&&r.numActive()===1?(r.release(_g),Gd=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},s.dO=hc,s.dP=function(r){const e=ht();if(!e)return;const i=e.delete(Pe);r&&i.catch(r).then(()=>r())},s.dQ=jd,s.dR=$x,s.dS=function(r){Ig=ue.resolveURL(r),Vu||(Vu=new ku(qp(),new uo)),Vu.broadcast("setDracoUrl",Ig)},s.dT=Zx,s.dU=function(r){Nu=ue.resolveURL(r),Vu||(Vu=new ku(qp(),new uo)),Vu.broadcast("setMeshoptUrl",Nu)},s.dV=Mt,s.dW=tl,s.dX=eo,s.dY=Iu,s.dZ=class{constructor(r,e){this.pos=r,this.dir=e}intersectsPlane(r,e,i){const o=Se.vec2.dot(e,this.dir);if(Math.abs(o)<1e-6)return!1;const u=((r[0]-this.pos[0])*e[0]+(r[1]-this.pos[1])*e[1])/o;return i[0]=this.pos[0]+this.dir[0]*u,i[1]=this.pos[1]+this.dir[1]*u,!0}},s.d_=tv,s.da=Ii,s.db=hd,s.dc=256,s.dd=Fi,s.de=vs,s.df=vo,s.dg=gu,s.dh=function(r,e,i,o,u){return ri((r-e)/(i-e)*(u-o)+o,o,u)},s.di=eu,s.dj=Qa,s.dk=class{constructor(r,e,i,o){this.context=r,this.format=o,this.size=i,this.texture=r.gl.createTexture();const[u,a,h]=this.size,{gl:m}=r;m.bindTexture(m.TEXTURE_3D,this.texture),r.pixelStoreUnpackFlipY.set(!1),r.pixelStoreUnpack.set(1),r.pixelStoreUnpackPremultiplyAlpha.set(!1),m.texImage3D(m.TEXTURE_3D,0,this.format,u,a,h,0,og(this.format),ag(this.format),e.data)}bind(r,e){const{context:i}=this,{gl:o}=i;o.bindTexture(o.TEXTURE_3D,this.texture),r!==this.minFilter&&(o.texParameteri(o.TEXTURE_3D,o.TEXTURE_MAG_FILTER,r),o.texParameteri(o.TEXTURE_3D,o.TEXTURE_MIN_FILTER,r),this.minFilter=r),e!==this.wrapS&&(o.texParameteri(o.TEXTURE_3D,o.TEXTURE_WRAP_S,e),o.texParameteri(o.TEXTURE_3D,o.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){const{gl:r}=this.context;r.deleteTexture(this.texture),this.texture=null}},s.dl=hg,s.dm=[1,1,1],s.dn=Lu,s.dp=Du,s.dq=xo,s.dr=Wa,s.ds=oa,s.dt=yu,s.du=bs,s.dv=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new ft(1/0,1/0),max:new ft(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(r,e=!1){const i=w0(new ft(0,0),new ft(mt,mt),r),o=[];if(e&&!O_(i,this._globalClipBounds))return o;for(const u of this._activeRegions){if(u.hiddenByOverlap||!O_(i,u))continue;const a=Mw(u.min,u.max,r);o.push({min:a.min,max:a.max,sourceId:this._sourceIds[u.priority],footprint:u.footprint,footprintTileId:u.tileId,order:u.order,clipMask:u.clipMask,clipScope:u.clipScope})}return o}setSources(r){this._setSources(r.map(e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{const i=[];for(const o of e.cache.getVisibleCoordinates()){const u=e.cache.getTile(o).buckets[e.layer];u&&u.updateFootprints(o.toUnwrapped(),i)}return i},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope})))}_addSource(r){const e=r.getFootprints();if(e.length===0)return;const i=r.getOrder(),o=r.getClipMask(),u=r.getClipScope();for(const a of e){if(!a.footprint)continue;const h=w0(a.footprint.min,a.footprint.max,a.id);this._activeRegions.push({min:h.min,max:h.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:a.id,footprint:a.footprint,order:i,clipMask:o,clipScope:u})}this._sourceIds.push(r.getSourceId())}_computeReplacement(){this._activeRegions.sort((e,i)=>e.priority-i.priority||gp(e.min,i.min)||gp(e.max,i.max)||e.order-i.order||e.clipMask-i.clipMask||function(o,u){const a=(h,m)=>h+m;return o.length-u.length||o.reduce(a,"").localeCompare(u.reduce(a,""))}(e.clipScope,i.clipScope));let r=this._activeRegions.length!==this._prevRegions.length;if(!r){let e=0;for(;!r&&e!==this._activeRegions.length;){const i=this._activeRegions[e],o=this._prevRegions[e];r=i.priority!==o.priority||!b0(i,o)||i.order!==o.order||i.clipMask!==o.clipMask||!rr(i.clipScope,o.clipScope),++e}}if(r){++this._updateTime;for(const i of this._activeRegions)i.order!==_p&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,i.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,i.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,i.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,i.max.y));const e=i=>{const o=this._activeRegions;if(i>=o.length)return i;const u=o[i].priority;for(;i<o.length&&o[i].priority===u;)++i;return i};if(this._sourceIds.length>1){let i=0,o=e(i);for(;i!==o;){let u=i;const a=i;for(;u!==o;){const h=this._activeRegions[u];h.hiddenByOverlap=!1;for(let m=0;m<a;m++){const y=this._activeRegions[m];if(!y.hiddenByOverlap&&h.order===_p&&O_(h,y)&&(h.hiddenByOverlap=S0(h.footprint,h.tileId,y.footprint,y.tileId),h.hiddenByOverlap))break}++u}i=o,o=e(i)}}}}_setSources(r){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=r.length-1;e>=0;e--)this._addSource(r[e]);this._computeReplacement()}},s.dw=class{constructor(r){this._createGrid(r),this._createPoles(r)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const r of this._poleSegments)r.destroy();for(const r of this._gridSegments)r.withSkirts.destroy(),r.withoutSkirts.destroy()}_fillGridMeshWithLods(r,e){const i=new Ys,o=new Gn,u=[],a=r+1+2,h=e[0]+1,m=e[0]+1+(1+e.length),y=(T,f,x)=>{let w=T===a-1?T-2:T===0?T:T-1;return w+=x?24575:0,[w,f]};for(let T=0;T<a;++T)i.emplaceBack(...y(T,0,!0));for(let T=0;T<h;++T)for(let f=0;f<a;++f)i.emplaceBack(...y(f,T,(f===0||f===a-1)&&!0));for(let T=0;T<e.length;++T){const f=e[T];for(let x=0;x<a;++x)i.emplaceBack(...y(x,f,!0))}for(let T=0;T<e.length;++T){const f=o.length,x=e[T]+1+2,w=new Gn;for(let S=0;S<x-1;S++){const C=S===x-2,z=C?a*(m-e.length+T-S):a;for(let O=0;O<a-1;O++){const B=S*a+O;S===0||C||O===0||O===a-2?(w.emplaceBack(B+1,B,B+z),w.emplaceBack(B+z,B+z+1,B+1)):(o.emplaceBack(B+1,B,B+z),o.emplaceBack(B+z,B+z+1,B+1))}}const g=an.simpleSegment(0,f,i.length,o.length-f);for(let S=0;S<w.uint16.length;S+=3)o.emplaceBack(w.uint16[S],w.uint16[S+1],w.uint16[S+2]);const v=an.simpleSegment(0,f,i.length,o.length-f);u.push({withoutSkirts:g,withSkirts:v})}return{vertices:i,indices:o,segments:u}}_createGrid(r){const e=this._fillGridMeshWithLods(Ka,Tu);this._gridSegments=e.segments,this._gridBuffer=r.createVertexBuffer(e.vertices,Bt.members),this._gridIndexBuffer=r.createIndexBuffer(e.indices,!0)}_createPoles(r){const e=new Gn;for(let h=0;h<=Ka;h++)e.emplaceBack(0,h+1,h+2);this._poleIndexBuffer=r.createIndexBuffer(e,!0);const i=new vo,o=new vo,u=new vo,a=new vo;this._poleSegments=[];for(let h=0,m=0;h<Ya;h++){const y=360/(1<<h);i.emplaceBack(0,-lr,0,.5,0),o.emplaceBack(0,-lr,0,.5,1),u.emplaceBack(0,-lr,0,.5,.5),a.emplaceBack(0,-lr,0,.5,.5);for(let T=0;T<=Ka;T++){let f=T/Ka,x=0;const w=Gt(0,y,f),[g,v,S]=Ja(aa,Es,w,lr);i.emplaceBack(g,v,S,f,x),o.emplaceBack(g,v,S,f,1-x);const C=pi(w);f=.5+.5*Math.sin(C),x=.5+.5*Math.cos(C),u.emplaceBack(g,v,S,f,x),a.emplaceBack(g,v,S,f,1-x)}this._poleSegments.push(an.simpleSegment(m,0,66,64)),m+=66}this._poleNorthVertexBuffer=r.createVertexBuffer(i,$t,!1),this._poleSouthVertexBuffer=r.createVertexBuffer(o,$t,!1),this._texturedPoleNorthVertexBuffer=r.createVertexBuffer(u,$t,!1),this._texturedPoleSouthVertexBuffer=r.createVertexBuffer(a,$t,!1)}getGridBuffers(r,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[r].withSkirts:this._gridSegments[r].withoutSkirts]}getPoleBuffers(r,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[r]]}},s.dx=_p,s.dy=Oo,s.dz=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},s.e=Mn,s.e0=$0,s.e1=Ta,s.e2=gs,s.e3=x1,s.e4=function(r,e,i,o,u,a,h,m,y,T,f=1,x,w){r.createArrays(),r.tilePixelRatio=mt/(512*r.overscaling),r.compareText={},r.iconsNeedLinear=!1;const g=r.layers[0].layout,v=r.layers[0]._unevaluatedLayout._values,S={};S.scaleFactor=f,S.textSizeScaleRange=g.get("text-size-scale-range"),S.iconSizeScaleRange=g.get("icon-size-scale-range");const[C,z]=S.textSizeScaleRange,[O,B]=S.iconSizeScaleRange;if(S.textScaleFactor=ri(S.scaleFactor,C,z),S.iconScaleFactor=ri(S.scaleFactor,O,B),r.textSizeData.kind==="composite"){const{minZoom:W,maxZoom:te}=r.textSizeData;S.compositeTextSizes=[v["text-size"].possiblyEvaluate(new Vi(W),m),v["text-size"].possiblyEvaluate(new Vi(te),m)]}if(r.iconSizeData.kind==="composite"){const{minZoom:W,maxZoom:te}=r.iconSizeData;S.compositeIconSizes=[v["icon-size"].possiblyEvaluate(new Vi(W),m),v["icon-size"].possiblyEvaluate(new Vi(te),m)]}S.layoutTextSize=v["text-size"].possiblyEvaluate(new Vi(y+1),m),S.layoutIconSize=v["icon-size"].possiblyEvaluate(new Vi(y+1),m),S.textMaxSize=v["text-size"].possiblyEvaluate(new Vi(18),m);const L=g.get("text-rotation-alignment")==="map"&&g.get("symbol-placement")!=="point",V=g.get("text-size");let j=!1;for(const W of r.features)if(W.icon&&W.icon.nameSecondary){j=!0;break}for(const W of r.features){const te=g.get("text-font").evaluate(W,{},m).join(","),ee=V.evaluate(W,{},m)*S.textScaleFactor,Q=S.layoutTextSize.evaluate(W,{},m)*S.textScaleFactor,pe=(S.layoutIconSize.evaluate(W,{},m),{horizontal:{},vertical:void 0}),ie=W.text;let me,xe=[0,0];if(ie){const Ae=ie.toString(),Re=g.get("text-letter-spacing").evaluate(W,{},m)*tr,Ee=g.get("text-line-height").evaluate(W,{},m)*tr,$e=d_(Ae)?Re:0,Qe=g.get("text-anchor").evaluate(W,{},m),qe=g.get("text-variable-anchor");if(!qe){const Pt=g.get("text-radial-offset").evaluate(W,{},m);xe=Pt?E1(Qe,[Pt*tr,J_]):g.get("text-offset").evaluate(W,{},m).map(yt=>yt*tr)}let _t=L?"center":g.get("text-justify").evaluate(W,{},m);const pt=g.get("symbol-placement")==="point",rt=pt?g.get("text-max-width").evaluate(W,{},m)*tr:1/0,et=Pt=>{r.allowVerticalPlacement&&qh(Ae)&&(pe.vertical=X_(ie,e,i,u,te,rt,Ee,Qe,Pt,$e,xe,is.vertical,!0,Q,ee))};if(!L&&qe){const Pt=_t==="auto"?qe.map(Tt=>Q_(Tt)):[_t];let yt=!1;for(let Tt=0;Tt<Pt.length;Tt++){const Wt=Pt[Tt];if(!pe.horizontal[Wt])if(yt)pe.horizontal[Wt]=pe.horizontal[0];else{const ei=X_(ie,e,i,u,te,rt,Ee,"center",Wt,$e,xe,is.horizontal,!1,Q,ee);ei&&(pe.horizontal[Wt]=ei,yt=ei.positionedLines.length===1)}}et("left")}else{if(_t==="auto"&&(_t=Q_(Qe)),pt||g.get("text-writing-mode").indexOf("horizontal")>=0||!qh(Ae)){const Pt=X_(ie,e,i,u,te,rt,Ee,Qe,_t,$e,xe,is.horizontal,!1,Q,ee);Pt&&(pe.horizontal[_t]=Pt)}et(pt?"left":_t)}}let ye=!1;if(W.icon&&W.icon.namePrimary){const Ae=q_(r.iconSizeData,v["icon-size"],m,r.zoom,W)*S.iconScaleFactor*x,Re=W.icon.getPrimary().scaleSelf(Ae).serialize(),Ee=o[Re];Ee&&(me=h2(u[Re],W.icon.nameSecondary?u[W.icon.getSecondary().scaleSelf(Ae).serialize()]:void 0,g.get("icon-offset").evaluate(W,{},m),g.get("icon-anchor").evaluate(W,{},m)),ye=Ee.sdf,r.sdfIcons===void 0?r.sdfIcons=Ee.sdf:r.sdfIcons!==Ee.sdf&&ti("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Ee.pixelRatio!==r.pixelRatio||g.get("icon-rotate").constantOr(1)!==0)&&(r.iconsNeedLinear=!0))}const we=I1(pe.horizontal)||pe.vertical;r.iconsInText||(r.iconsInText=!!we&&we.iconsInText),(we||me)&&y2(r,W,pe,me,o,S,Q,0,xe,ye,h,m,T,w,j)}a&&r.generateCollisionDebugBuffers(y,r.collisionBoxArray,S.textScaleFactor)},s.e5=Yp,s.e6=ko,s.e7=_0,s.e8=s1,s.e9=_e,s.ea=function(r){let e=0;if(new Uint32Array(r,0,1)[0]!==Wx){const i=new Uint32Array(r,0,7),[,,o,u,a,h]=i;e=i.byteLength+u+a+h+a,(o!==r.byteLength||e>=r.byteLength)&&ti("Invalid b3dm header information.")}return Jx(r,e)},s.eb=function(r,e){const i=ev(r);for(const o of i){for(const u of o.meshes)H3(u);o.lights&&(o.lightMeshIndex=o.meshes.length,o.meshes.push(W3(o.lights,e)))}return i},s.ec=Gp,s.ed=px,s.ee=Ar,s.ef=function(r){dt(),Be!=null&&Be.then(e=>{e.keys().then(i=>{for(let o=0;o<i.length-r;o++)e.delete(i[o])})})},s.f=function(r){return r.indexOf("mapbox:")===0},s.g=function(r,e){return In(sr(r,{method:"GET"}),e)},s.h=fl,s.i=function(r){return Mn.API_STYLE_REGEX.test(r)&&!Lc(r)},s.j=function(r){return decodeURIComponent(atob(r).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))},s.k=function(r){return btoa(encodeURIComponent(r).replace(/%([0-9A-F]{2})/g,(e,i)=>String.fromCharCode(+("0x"+i))))},s.l=sr,s.m=Ut,s.n=function(r,e){return In(sr(r,{type:"json"}),e)},s.o=ih,s.p=function(r,e){return In(sr(r,{method:"POST"}),e)},s.q=ue,s.r=Wn,s.s=function(r){try{const e=self[r];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}},s.t=K,s.u=function(){return function r(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,r)}()},s.v=function(r){return!!r&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(r)},s.w=ti,s.x=function(){return gg||(gg=new hc),gg},s.y=kc,s.z=ms}),Y(["./shared"],function(s){function _e(Ne){const G=Ne?Ne.url.toString():void 0;return G?performance.getEntriesByName(G):[]}function ce(Ne){if(typeof Ne=="number"||typeof Ne=="boolean"||typeof Ne=="string"||Ne==null)return JSON.stringify(Ne);if(Array.isArray(Ne)){let X="[";for(const K of Ne)X+=`${ce(K)},`;return`${X}]`}let G="{";for(const X of Object.keys(Ne).sort())G+=`${X}:${ce(Ne[X])},`;return`${G}}`}function oe(Ne){let G="";for(const X of s.bm)(Ne.type!=="model"||X!=="minzoom"&&X!=="maxzoom")&&(G+=`/${ce(Ne[X])}`);return G}class Ie{constructor(G){this.keyCache={},this._layers={},this._layerConfigs={},G&&this.replace(G)}replace(G,X){this._layerConfigs={},this._layers={},this.update(G,[],X)}update(G,X,K){this._options=K;for(const fe of G)this._layerConfigs[fe.id]=fe,(this._layers[fe.id]=s.cu(fe,this.scope,null,this._options)).compileFilter(K),this.keyCache[fe.id]&&delete this.keyCache[fe.id];for(const fe of X)delete this.keyCache[fe],delete this._layerConfigs[fe],delete this._layers[fe];this.familiesBySource={};const ue=function(fe,ve){const Pe={};for(let Fe=0;Fe<fe.length;Fe++){const Oe=fe[Fe];let Be=ve&&ve[Oe.id];!Be&&(Be=oe(Oe),Oe.type==="line"&&Oe.paint)&&function ht(dt){return typeof dt=="string"&&dt==="line-progress"||(Array.isArray(dt)?dt.some(ht):!(!dt||typeof dt!="object")&&Object.values(dt).some(ht))}(Oe.paint["line-width"])&&(Be+=`/${ce(Oe.paint["line-width"])}`),ve&&(ve[Oe.id]=Be);let Ke=Pe[Be];Ke||(Ke=Pe[Be]=[]),Ke.push(Oe)}const be=[];for(const Fe in Pe)be.push(Pe[Fe]);return be}(s.bj(this._layerConfigs),this.keyCache);for(const fe of ue){const ve=fe.map(Ke=>this._layers[Ke.id]),Pe=ve[0];if(Pe.visibility==="none")continue;const be=Pe.source||"";let Fe=this.familiesBySource[be];Fe||(Fe=this.familiesBySource[be]={});const Oe=Pe.sourceLayer||"_geojsonTileLayer";let Be=Fe[Oe];Be||(Be=Fe[Oe]=[]),Be.push(ve)}}}const Me=1*s.dX;class De{constructor(G){const X={},K=[];for(const Pe in G){const be=G[Pe],Fe=X[Pe]={};for(const Oe in be.glyphs){const Be=be.glyphs[+Oe];if(!Be||Be.bitmap.width===0||Be.bitmap.height===0)continue;const Ke=Be.metrics.localGlyph?Me:1,ht={x:0,y:0,w:Be.bitmap.width+2*Ke,h:Be.bitmap.height+2*Ke};K.push(ht),Fe[Oe]=ht}}const{w:ue,h:fe}=s.F(K),ve=new s.dW({width:ue||1,height:fe||1});for(const Pe in G){const be=G[Pe];for(const Fe in be.glyphs){const Oe=be.glyphs[+Fe];if(!Oe||Oe.bitmap.width===0||Oe.bitmap.height===0)continue;const Be=X[Pe][Fe],Ke=Oe.metrics.localGlyph?Me:1;s.dW.copy(Oe.bitmap,ve,{x:0,y:0},{x:Be.x+Ke,y:Be.y+Ke},Oe.bitmap)}}this.image=ve,this.positions=X}}s.dV(De,"GlyphAtlas");const Ve="3d_elevation_id",We="hd_road_elevation";class st{constructor(){this._valid=!1}reset(G){return this.feature=G,this._valid=!0,this._geometry=G.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(G,X){return this._valid&&G(X(this._geometry)),this}require(G,X,K){return this.get(G,!0,X,K)}optional(G,X,K){return this.get(G,!1,X,K)}success(){return this._valid}get(G,X,K,ue){const fe=this.feature.properties.hasOwnProperty(G)?+this.feature.properties[G]:void 0;return this._valid&&fe!==void 0?K(ue?ue(fe):fe):X&&(this._valid=!1),this}}class ct{constructor(G,X){this.featureFunc=G,this.vertexFunc=X}parseFeature(G,X,K){return this.featureFunc(G,X,K)}parseVertex(G,X,K){return this.vertexFunc(G,X,K)}}const gt=new ct((Ne,G,X)=>Ne.reset(G).require(Ve,K=>{X.id=K}).optional("fixed_height_relative",K=>{X.constantHeight=K},ot.decodeRelativeHeight).geometry(K=>{X.bounds=K},ot.computeBounds).success(),(Ne,G,X)=>Ne.reset(G).require(Ve,K=>{X.id=K}).require("elevation_idx",K=>{X.idx=K}).require("extent",K=>{X.extent=K}).require("height_relative",K=>{X.height=K},ot.decodeRelativeHeight).geometry(K=>{X.position=K},ot.getPoint).success()),At=new ct((Ne,G,X)=>Ne.reset(G).require(Ve,K=>{X.id=K}).optional("fixed_height",K=>{X.constantHeight=K},ot.decodeMetricHeight).geometry(K=>{X.bounds=K},ot.computeBounds).success(),(Ne,G,X)=>Ne.reset(G).require(Ve,K=>{X.id=K}).require("elevation_idx",K=>{X.idx=K}).require("extent",K=>{X.extent=K}).require("height",K=>{X.height=K},ot.decodeMetricHeight).geometry(K=>{X.position=K},ot.getPoint).success());class ot{static computeBounds(G){const X=new s.P(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),K=new s.P(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const ue of G[0])X.x>ue.x&&(X.x=ue.x),X.y>ue.y&&(X.y=ue.y),K.x<ue.x&&(K.x=ue.x),K.y<ue.y&&(K.y=ue.y);return{min:X,max:K}}static getPoint(G){return s.ab.vec2.fromValues(G[0][0].x,G[0][0].y)}static decodeRelativeHeight(G){return 1e-4*G*5}static decodeMetricHeight(G){return 1e-4*G}static parse(G){const X=[],K=[],ue=G.length,fe=new st;for(let Pe=0;Pe<ue;Pe++){const be=G.feature(Pe),Fe=be.properties.hasOwnProperty("version")?String(be.properties.version):void 0,Oe=(ve=Fe)?ve==="1.0.1"?At:void 0:gt;if(Oe===void 0){s.w(`Unknown elevation feature version number ${Fe||"(unknown)"}`);continue}const Be=be.properties.hasOwnProperty("type")?be.properties.type:void 0;if(Be){if(s.dY.VectorTileFeature.types[be.type]==="Point"&&Be==="curve_point"){const Ke={};Oe.parseVertex(fe,be,Ke)&&X.push(Ke)}else if(s.dY.VectorTileFeature.types[be.type]==="Polygon"&&Be==="curve_meta"){const Ke={};Oe.parseFeature(fe,be,Ke)&&K.push(Ke)}}}var ve;return{vertices:X,features:K}}}class zt{constructor(G,X,K,ue,fe,ve){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this.id=G,this.heightRange={min:K,max:K},this.safeArea=X,this.constantHeight=K,this.constantHeight==null&&(this.constantHeight!=null||ue.length!==0)){this.vertices=ue,this.edges=fe,this.edges=this.edges.filter(Pe=>Pe.a<this.vertices.length&&Pe.b<this.vertices.length&&!s.ab.vec2.exactEquals(this.vertices[Pe.a].position,this.vertices[Pe.b].position)),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const Pe of this.vertices)this.vertexProps.push({dir:s.ab.vec2.fromValues(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,Pe.height),this.heightRange.max=Math.max(this.heightRange.max,Pe.height);for(const Pe of this.edges){const be=this.vertices[Pe.a].position,Fe=this.vertices[Pe.b].position,Oe=s.ab.vec2.subtract(s.ab.vec2.create(),Fe,be),Be=s.ab.vec2.length(Oe),Ke=s.ab.vec2.scale(s.ab.vec2.create(),Oe,1/Be);this.edgeProps.push({vec:Oe,dir:Ke,len:Be});const ht=this.vertexProps[Pe.a].dir,dt=this.vertexProps[Pe.b].dir;s.ab.vec2.add(ht,ht,Ke),s.ab.vec2.add(dt,dt,Ke)}for(const Pe of this.vertexProps)Pe.dir[0]===0&&Pe.dir[1]===0||s.ab.vec2.normalize(Pe.dir,Pe.dir);this.tessellate(ve)}}pointElevation(G){if(this.constantHeight!=null)return this.constantHeight;const X=this.getClosestEdge(G);if(X==null)return 0;const[K,ue]=X;return(1-(fe=ue))*this.vertices[this.edges[K].a].height+fe*this.vertices[this.edges[K].b].height;var fe}getClosestEdge(G){if(this.edges.length===0)return;let X=0,K=Number.POSITIVE_INFINITY,ue=0;const fe=s.ab.vec2.fromValues(G.x,G.y);for(let ve=0;ve<this.edges.length;ve++){const Pe=this.edges[ve],be=this.edgeProps[ve].dir,Fe=new s.dZ(fe,this.edgeProps[ve].dir),Oe=this.vertices[Pe.a].position,Be=this.vertices[Pe.b].position,Ke=s.ab.vec2.create(),ht=s.ab.vec2.create(),dt=Fe.intersectsPlane(Oe,this.vertexProps[Pe.a].dir,Ke),Ot=Fe.intersectsPlane(Be,this.vertexProps[Pe.b].dir,ht);if(!dt||!Ot)continue;const Ut=s.ab.vec2.subtract(s.ab.vec2.create(),ht,Ke),jt=s.ab.vec2.subtract(s.ab.vec2.create(),fe,Ke),Vt=s.ab.vec2.dot(Ut,Ut),di=Vt>0?s.ab.vec2.dot(jt,Ut)/Vt:0,gi=s.aw(di,0,1),si=Math.abs((di-gi)*this.edgeProps[ve].len),vi=s.ab.vec2.subtract(s.ab.vec2.create(),fe,Oe),Si=si+Math.abs(s.ab.vec2.dot(vi,s.ab.vec2.fromValues(be[1],-be[0])));Si<K&&(X=ve,K=Si,ue=gi)}return[X,ue]}tessellate(G){for(let X=this.edges.length-1;X>=0;--X){const K=this.edges[X].a,ue=this.edges[X].b,{position:fe,height:ve,extent:Pe}=this.vertices[K],{position:be,height:Fe,extent:Oe}=this.vertices[ue],Be=this.vertexProps[K].dir,Ke=this.vertexProps[ue].dir,ht=s.ab.vec3.fromValues(fe[0]/G,fe[1]/G,ve),dt=s.ab.vec3.fromValues(be[0]/G,be[1]/G,Fe),Ot=s.ab.vec3.fromValues(Be[1],-Be[0],0);s.ab.vec3.scale(Ot,Ot,Pe);const Ut=s.ab.vec3.fromValues(Ke[1],-Ke[0],0);if(s.ab.vec3.scale(Ut,Ut,Oe),this.distSqLines(s.ab.vec3.fromValues(ht[0]+.5*Ot[0],ht[1]+.5*Ot[1],ht[2]+.5*Ot[2]),s.ab.vec3.fromValues(dt[0]-.5*Ut[0],dt[1]-.5*Ut[1],dt[2]-.5*Ut[2]),s.ab.vec3.fromValues(ht[0]-.5*Ot[0],ht[1]-.5*Ot[1],ht[2]-.5*Ot[2]),s.ab.vec3.fromValues(dt[0]+.5*Ut[0],dt[1]+.5*Ut[1],dt[2]+.5*Ut[2]))<=.05*.05)continue;const jt=this.vertices.length,Vt=s.ab.vec2.add(s.ab.vec2.create(),fe,be);this.vertices.push({position:s.ab.vec2.scale(Vt,Vt,.5),height:.5*(ve+Fe),extent:.5*(Pe+Oe)});const di=s.ab.vec2.add(s.ab.vec2.create(),Be,Ke);this.vertexProps.push({dir:s.ab.vec2.normalize(di,di)}),this.edges.splice(X,1),this.edgeProps.splice(X,1),this.edges.push({a:K,b:jt}),this.edges.push({a:jt,b:ue});const gi=s.ab.vec2.subtract(s.ab.vec2.create(),this.vertices[jt].position,fe),si=s.ab.vec2.length(gi),vi={vec:gi,dir:s.ab.vec2.scale(s.ab.vec2.create(),gi,1/si),len:si};this.edgeProps.push(vi),this.edgeProps.push(vi)}}distSqLines(G,X,K,ue){const fe=s.ab.vec3.subtract(s.ab.vec3.create(),X,G),ve=s.ab.vec3.subtract(s.ab.vec3.create(),ue,K),Pe=s.ab.vec3.subtract(s.ab.vec3.create(),G,K),be=s.ab.vec3.dot(fe,fe),Fe=s.ab.vec3.dot(fe,ve),Oe=s.ab.vec3.dot(fe,Pe),Be=s.ab.vec3.dot(ve,ve),Ke=s.ab.vec3.dot(ve,Pe),ht=be*Be-Fe*Fe;if(ht===0){const Vt=s.ab.vec3.dot(Pe,ve)/s.ab.vec3.dot(ve,ve),di=s.ab.vec3.lerp(s.ab.vec3.create(),K,ue,Vt);return s.ab.vec3.squaredDistance(di,G)}const dt=(Fe*Ke-Oe*Be)/ht,Ot=(be*Ke-Fe*Oe)/ht,Ut=s.ab.vec3.lerp(s.ab.vec3.create(),G,X,dt),jt=s.ab.vec3.lerp(s.ab.vec3.create(),K,ue,Ot);return s.ab.vec3.squaredDistance(Ut,jt)}}class Rt{static parseFrom(G,X){const K=ot.parse(G);if(!K)return[];let{vertices:ue,features:fe}=K;const ve=1/s.cc(X);fe.sort((Oe,Be)=>Oe.id-Be.id),ue.sort((Oe,Be)=>Oe.id-Be.id||Oe.idx-Be.idx),ue=ue.filter((Oe,Be,Ke)=>Be===Ke.findIndex(ht=>ht.id===Oe.id&&ht.idx===Oe.idx));const Pe=new Array;let be=0;const Fe=ue.length;for(const Oe of fe){if(Oe.constantHeight){Pe.push(new zt(Oe.id,Oe.bounds,Oe.constantHeight));continue}for(;be!==Fe&&ue[be].id<Oe.id;)be++;if(be===Fe||ue[be].id!==Oe.id)continue;const Be=new Array,Ke=new Array,ht=be;for(;be!==Fe&&ue[be].id===Oe.id;){const dt=ue[be];if(Be.push({position:dt.position,height:dt.height,extent:dt.extent}),be!==ht&&ue[be-1].idx===dt.idx-1){const Ot=be-ht;Ke.push({a:Ot-1,b:Ot})}be++}Pe.push(new zt(Oe.id,Oe.bounds,void 0,Be,Ke,ve))}return Pe}}s.dV(zt,"ElevationFeature");class vt{constructor(G){this.tileID=new s.aG(G.tileID.overscaledZ,G.tileID.wrap,G.tileID.canonical.z,G.tileID.canonical.x,G.tileID.canonical.y),this.tileZoom=G.tileZoom,this.uid=G.uid,this.zoom=G.zoom,this.lut=G.lut,this.canonical=G.tileID.canonical,this.pixelRatio=G.pixelRatio,this.tileSize=G.tileSize,this.source=G.source,this.scope=G.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=G.showCollisionBoxes,this.collectResourceTiming=!!G.request&&G.request.collectResourceTiming,this.promoteId=G.promoteId,this.isSymbolTile=G.isSymbolTile,this.tileTransform=s.aQ(G.tileID.canonical,G.projection),this.projection=G.projection,this.worldview=G.worldview,this.localizableLayerIds=G.localizableLayerIds,this.brightness=G.brightness,this.extraShadowCaster=!!G.extraShadowCaster,this.tessellationStep=G.tessellationStep,this.scaleFactor=G.scaleFactor}parse(G,X,K,ue,fe){this.status="parsing",this.data=G,this.collisionBoxArray=new s.aW;const ve=new s.d_(Object.keys(G.layers).sort()),Pe=new s.d$(this.tileID,this.promoteId);Pe.bucketLayerIDs=[];const be={},Fe=new s.e0(256,256),Oe={featureIndex:Pe,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:Fe,availableImages:K,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},Be=X.familiesBySource[this.source];for(const Vt in Be){const di=G.layers[Vt];if(!di)continue;let gi=!1,si=!1,vi=!1;for(const In of Be[Vt])In[0].type==="symbol"?gi=!0:si=!0,In[0].is3D()&&In[0].type!=="model"&&(vi=!0);if(this.extraShadowCaster&&!vi||this.isSymbolTile===!0&&!gi||this.isSymbolTile===!1&&!si)continue;di.version===1&&s.w(`Vector tile source "${this.source}" layer "${Vt}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Si=ve.encode(Vt),fn=[];let fs=!1;for(let In=0,Cn=0;In<di.length;In++){const or=di.feature(In),ml=Pe.getId(or,Vt);if(this.localizableLayerIds&&this.localizableLayerIds.has(Vt)){const js=or.properties?or.properties.worldview:null;if(this.worldview&&typeof js=="string")if(js==="all")or.properties.$localized=!0;else{if(!js.split(",").includes(this.worldview))continue;or.properties.$localized=!0,or.properties.worldview=this.worldview}}!fs&&or.properties&&or.properties.hasOwnProperty(Ve)&&(fs=!0),fn.push({feature:or,id:ml,index:Cn,sourceLayerIndex:Si}),Cn++}fs&&G.layers.hasOwnProperty(We)&&(Oe.elevationFeatures=Rt.parseFrom(G.layers[We],this.canonical));for(const In of Be[Vt]){const Cn=In[0];(!this.extraShadowCaster||Cn.is3D()&&Cn.type!=="model")&&(this.isSymbolTile!==void 0&&Cn.type==="symbol"!==this.isSymbolTile||Cn.minzoom&&this.zoom<Math.floor(Cn.minzoom)||Cn.maxzoom&&this.zoom>=Cn.maxzoom||Cn.visibility!=="none"&&(Nt(In,this.zoom,Oe.brightness,K),(be[Cn.id]=Cn.createBucket({index:Pe.bucketLayerIDs.length,layers:In,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Si,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep})).populate(fn,Oe,this.tileID.canonical,this.tileTransform),Pe.bucketLayerIDs.push(In.map(or=>s.aC(or.id,or.scope)))))}}let Ke,ht,dt,Ot;Fe.trim();const Ut={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},jt=()=>{if(Ke)return this.status="done",fe(Ke);if(this.extraShadowCaster)this.status="done",fe(null,{buckets:s.bj(be).filter(Vt=>!Vt.isEmpty()),featureIndex:Pe,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:Oe.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(ht&&dt&&Ot){const Vt=new De(ht),di=new s.e3(dt,Ot,this.lut);for(const gi in be){const si=be[gi];si instanceof s.aX?(Nt(si.layers,this.zoom,Oe.brightness,K),s.e4(si,ht,Vt.positions,dt,di.iconPositions,this.showCollisionBoxes,K,this.tileID.canonical,this.tileZoom,this.projection,this.scaleFactor,this.pixelRatio,this.brightness)):si.hasPattern&&(si instanceof s.b1||si instanceof s.b2||si instanceof s.d5)&&(Nt(si.layers,this.zoom,Oe.brightness,K),si.addFeatures(Oe,this.tileID.canonical,di.patternPositions,K,this.tileTransform,this.brightness))}this.status="done",fe(null,{buckets:s.bj(be).filter(gi=>!gi.isEmpty()),featureIndex:Pe,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Vt.image,lineAtlas:Fe,imageAtlas:di,brightness:Oe.brightness})}};if(!this.extraShadowCaster){const Vt=s.e1(Oe.glyphDependencies,si=>Object.keys(si).map(Number));Object.keys(Vt).length?ue.send("getGlyphs",{uid:this.uid,stacks:Vt,scope:this.scope},(si,vi)=>{Ke||(Ke=si,ht=vi,jt())},void 0,!1,Ut):ht={};const di=Object.keys(Oe.iconDependencies);di.length?ue.send("getImages",{icons:di,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(si,vi)=>{if(Ke)return;Ke=si;const Si={};Object.values(vi).some(fn=>fn.usvg)?this.rasterize(ue,Si,vi,Oe.iconDependencies,()=>{dt=Si,jt()}):(this.fillImageMap(Si,Oe.iconDependencies,vi),dt=Si,jt())},void 0,!1,Ut):dt={};const gi=Object.keys(Oe.patternDependencies);gi.length?ue.send("getImages",{icons:gi,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(si,vi)=>{if(!Ke){Ke=si;const Si={};Object.values(vi).some(fn=>fn.usvg)?this.rasterize(ue,Si,vi,Oe.patternDependencies,()=>{Ot=Si,jt()}):(this.fillImageMap(Si,Oe.patternDependencies,vi),Ot=Si,jt())}},void 0,!1,Ut):Ot={}}jt()}fillImageMap(G,X,K){for(const ue in K){const fe=X[ue]||[];for(const ve of fe)K[ve.id].usvg||(G[ve.serialize()]=K[ve.id])}}getImageTaskQueue(G,X,K){const ue={};for(const fe in X){const ve=K[fe]||[];for(const Pe of ve){const be=Pe.serialize();X[Pe.id].usvg?ue[be]||(ue[be]=Pe):G[be]=X[Pe.id]}}return ue}rasterize(G,X,K,ue,fe){const ve=this.getImageTaskQueue(X,K,ue);this.rasterizeTask=G.send("rasterizeImages",{scope:this.scope,imageTasks:ve},(Pe,be)=>{if(!Pe)for(const Fe in be){const{id:Oe}=s.e2.deserializeFromString(Fe);X[Fe]=Object.assign({},K[Oe],{data:be[Fe]})}fe()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function Nt(Ne,G,X,K){const ue=new s.a8(G,{brightness:X});for(const fe of Ne)fe.recalculate(ue,K)}class Jt extends s.E{constructor(G,X,K,ue,fe,ve){super(),this.actor=G,this.layerIndex=X,this.availableImages=K,this.loadVectorData=fe||s.aD,this.loading={},this.loaded={},this.deduped=new s.aB(G.scheduler),this.isSpriteLoaded=ue,this.scheduler=G.scheduler,this.brightness=ve}loadTile(G,X){const K=G.uid,ue=G&&G.request,fe=ue&&ue.collectResourceTiming,ve=this.loading[K]=new vt(G);ve.abort=this.loadVectorData(G,(Pe,be)=>{const Fe=!this.loading[K];if(delete this.loading[K],ve.cancelRasterize(),Fe||Pe||!be)return ve.status="done",Fe||(this.loaded[K]=ve),X(Pe);const Oe=be.rawData,Be={};be.expires&&(Be.expires=be.expires),be.cacheControl&&(Be.cacheControl=be.cacheControl),ve.vectorTile=be.vectorTile||new s.dY.VectorTile(new s.bh(Oe));const Ke=()=>{ve.parse(ve.vectorTile,this.layerIndex,this.availableImages,this.actor,(ht,dt)=>{if(ht||!dt)return X(ht);const Ot={};if(fe){const Ut=_e(ue);Ut.length>0&&(Ot.resourceTiming=JSON.parse(JSON.stringify(Ut)))}X(null,s.l({rawTileData:Oe.slice(0)},dt,Be,Ot))})};this.isSpriteLoaded?Ke():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(Ke,{type:"parseTile",isSymbolTile:G.isSymbolTile,zoom:G.tileZoom}):Ke()}),this.loaded=this.loaded||{},this.loaded[K]=ve})}reloadTile(G,X){const K=this.loaded,ue=G.uid;if(K&&K[ue]){const fe=K[ue];fe.scaleFactor=G.scaleFactor,fe.showCollisionBoxes=G.showCollisionBoxes,fe.projection=G.projection,fe.brightness=G.brightness,fe.tileTransform=s.aQ(G.tileID.canonical,G.projection),fe.extraShadowCaster=G.extraShadowCaster,fe.lut=G.lut;const ve=(Pe,be)=>{const Fe=fe.reloadCallback;Fe&&(delete fe.reloadCallback,fe.parse(fe.vectorTile,this.layerIndex,this.availableImages,this.actor,Fe)),X(Pe,be)};fe.status==="parsing"?fe.reloadCallback=ve:fe.status==="done"&&(fe.vectorTile?fe.parse(fe.vectorTile,this.layerIndex,this.availableImages,this.actor,ve):ve())}else X(null,void 0)}abortTile(G,X){const K=G.uid,ue=this.loading[K];ue&&(ue.abort&&ue.abort(),delete this.loading[K]),X()}removeTile(G,X){const K=this.loaded,ue=G.uid;K&&K[ue]&&delete K[ue],X()}}class It{loadTile(G,X){const{uid:K,encoding:ue,rawImageData:fe,padding:ve}=G,Pe=ImageBitmap&&fe instanceof ImageBitmap?this.getImageData(fe,ve):fe;X(null,new s.e5(K,Pe,ue,ve<1))}getImageData(G,X){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(G.width,G.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=G.width,this.offscreenCanvas.height=G.height,this.offscreenCanvasContext.drawImage(G,0,0,G.width,G.height);const K=this.offscreenCanvasContext.getImageData(-X,-X,G.width+2*X,G.height+2*X);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),K}}s.bg.setPbf(s.bh);class xt{decodeRasterArray({task:G,buffer:X},K){s.bg.performDecoding(X,G).then(ue=>{K(null,ue)},ue=>{K(ue)})}}const $i=s.dY.VectorTileFeature.prototype.toGeoJSON;class ki{constructor(G){this._feature=G,this.extent=s.ag,this.type=G.type,this.properties=G.tags,"id"in G&&!isNaN(G.id)&&(this.id=parseInt(G.id,10))}loadGeometry(){if(this._feature.type===1){const G=[];for(const X of this._feature.geometry)G.push([new s.P(X[0],X[1])]);return G}{const G=[];for(const X of this._feature.geometry){const K=[];for(const ue of X)K.push(new s.P(ue[0],ue[1]));G.push(K)}return G}}toGeoJSON(G,X,K){return $i.call(this,G,X,K)}}class Oi{constructor(G){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=s.ag,this.length=G.length,this._features=G}feature(G){return new ki(this._features[G])}}const tt=64/4096,ai=128;class wi{constructor(){this.features=new Map}clear(){this.features.clear()}load(G=[],X){for(const K of G){const ue=K.id;if(ue==null)continue;let fe=this.features.get(ue);fe&&this.updateCache(fe,X),K.geometry?(fe=Zt(K),this.updateCache(fe,X),this.features.set(ue,fe)):this.features.delete(ue),this.updateCache(fe,X)}}updateCache(G,X){for(const{canonical:K,uid:ue}of Object.values(X)){const{z:fe,x:ve,y:Pe}=K;Wi(G,Math.pow(2,fe),ve,Pe)&&delete X[ue]}}getTile(G,X,K){const ue=Math.pow(2,G),fe=[];for(const ve of this.features.values())Wi(ve,ue,X,K)&&fe.push(qt(ve,ue,X,K));return{features:fe}}getFeatures(){return[...this.features.values()]}}function Wi({minX:Ne,minY:G,maxX:X,maxY:K},ue,fe,ve){return Ne<(fe+1+tt)/ue&&G<(ve+1+tt)/ue&&X>(fe-tt)/ue&&K>(ve-tt)/ue}function Zt(Ne){const{id:G,geometry:X,properties:K}=Ne;if(!X)return;if(X.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");const{type:ue,coordinates:fe}=X,ve={id:G,type:1,geometry:[],tags:K,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},Pe=ve.geometry;if(ue==="Point")Fn(fe,Pe,ve);else if(ue==="MultiPoint")for(const be of fe)Fn(be,Pe,ve);else if(ue==="LineString")ve.type=2,Bn(fe,Pe,ve);else if(ue==="MultiLineString")ve.type=2,Ln(fe,Pe,ve);else if(ue==="Polygon")ve.type=3,Ln(fe,Pe,ve,!0);else{if(ue!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");ve.type=3;for(const be of fe)Ln(be,Pe,ve,!0)}return ve}function Fn([Ne,G],X,K){const ue=s.at(Ne);let fe=s.aA(G);fe=fe<0?0:fe>1?1:fe,X.push(ue,fe),K.minX=Math.min(K.minX,ue),K.minY=Math.min(K.minY,fe),K.maxX=Math.max(K.maxX,ue),K.maxY=Math.max(K.maxY,fe)}function Bn(Ne,G,X,K=!1,ue=!1){const fe=[];for(const ve of Ne)Fn(ve,fe,X);G.push(fe),K&&function(ve,Pe){let be=0;for(let Fe=0,Oe=ve.length,Be=Oe-2;Fe<Oe;Be=Fe,Fe+=2)be+=(ve[Fe]-ve[Be])*(ve[Fe+1]+ve[Be+1]);if(be>0===Pe)for(let Fe=0,Oe=ve.length;Fe<Oe/2;Fe+=2){const Be=ve[Fe],Ke=ve[Fe+1];ve[Fe]=ve[Oe-2-Fe],ve[Fe+1]=ve[Oe-1-Fe],ve[Oe-2-Fe]=Be,ve[Oe-1-Fe]=Ke}}(fe,ue)}function Ln(Ne,G,X,K=!1){for(let ue=0;ue<Ne.length;ue++)Bn(Ne[ue],G,X,K,ue===0)}function qt(Ne,G,X,K){const{id:ue,type:fe,geometry:ve,tags:Pe}=Ne,be=[];if(fe===1)(function(Fe,Oe,Be,Ke,ht){for(let dt=0;dt<Fe.length;dt+=2){const Ot=Math.round(s.ag*(Fe[dt+0]*Oe-Be)),Ut=Math.round(s.ag*(Fe[dt+1]*Oe-Ke));ht.push([Ot,Ut])}})(ve,G,X,K,be);else for(const Fe of ve)ls(Fe,G,X,K,be);return{id:ue,type:fe,geometry:be,tags:Pe}}function ls(Ne,G,X,K,ue){const ve=s.ag+ai;let Pe;for(let be=0;be<Ne.length-2;be+=2){let Fe=Math.round(s.ag*(Ne[be+0]*G-X)),Oe=Math.round(s.ag*(Ne[be+1]*G-K)),Be=Math.round(s.ag*(Ne[be+2]*G-X)),Ke=Math.round(s.ag*(Ne[be+3]*G-K));const ht=Be-Fe,dt=Ke-Oe;Fe<-128&&Be<-128||(Fe<-128?(Oe+=Math.round(dt*((-128-Fe)/ht)),Fe=-128):Be<-128&&(Ke=Oe+Math.round(dt*((-128-Fe)/ht)),Be=-128),Oe<-128&&Ke<-128||(Oe<-128?(Fe+=Math.round(ht*((-128-Oe)/dt)),Oe=-128):Ke<-128&&(Be=Fe+Math.round(ht*((-128-Oe)/dt)),Ke=-128),Fe>=ve&&Be>=ve||(Fe>=ve?(Oe+=Math.round(dt*((ve-Fe)/ht)),Fe=ve):Be>=ve&&(Ke=Oe+Math.round(dt*((ve-Fe)/ht)),Be=ve),Oe>=ve&&Ke>=ve||(Oe>=ve?(Fe+=Math.round(ht*((ve-Oe)/dt)),Oe=ve):Ke>=ve&&(Be=Fe+Math.round(ht*((ve-Oe)/dt)),Ke=ve),Pe&&Fe===Pe[Pe.length-1][0]&&Oe===Pe[Pe.length-1][1]||(Pe=[[Fe,Oe]],ue.push(Pe)),Pe.push([Be,Ke])))))}}var nr,Bs,Ns,cs={exports:{}},ga=function(){if(Ns)return cs.exports;Ns=1;var Ne=s.e8(),G=function(){if(Bs)return nr;Bs=1;var Oe=s.e6(),Be=s.e7().VectorTileFeature;function Ke(dt,Ot){this.options=Ot||{},this.features=dt,this.length=dt.length}function ht(dt,Ot){this.id=typeof dt.id=="number"?dt.id:void 0,this.type=dt.type,this.rawGeometry=dt.type===1?[dt.geometry]:dt.geometry,this.properties=dt.tags,this.extent=Ot||4096}return nr=Ke,Ke.prototype.feature=function(dt){return new ht(this.features[dt],this.options.extent)},ht.prototype.loadGeometry=function(){var dt=this.rawGeometry;this.geometry=[];for(var Ot=0;Ot<dt.length;Ot++){for(var Ut=dt[Ot],jt=[],Vt=0;Vt<Ut.length;Vt++)jt.push(new Oe(Ut[Vt][0],Ut[Vt][1]));this.geometry.push(jt)}return this.geometry},ht.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var dt=this.geometry,Ot=1/0,Ut=-1/0,jt=1/0,Vt=-1/0,di=0;di<dt.length;di++)for(var gi=dt[di],si=0;si<gi.length;si++){var vi=gi[si];Ot=Math.min(Ot,vi.x),Ut=Math.max(Ut,vi.x),jt=Math.min(jt,vi.y),Vt=Math.max(Vt,vi.y)}return[Ot,jt,Ut,Vt]},ht.prototype.toGeoJSON=Be.prototype.toGeoJSON,nr}();function X(Oe){var Be=new Ne;return function(Ke,ht){for(var dt in Ke.layers)ht.writeMessage(3,K,Ke.layers[dt])}(Oe,Be),Be.finish()}function K(Oe,Be){var Ke;Be.writeVarintField(15,Oe.version||1),Be.writeStringField(1,Oe.name||""),Be.writeVarintField(5,Oe.extent||4096);var ht={keys:[],values:[],keycache:{},valuecache:{}};for(Ke=0;Ke<Oe.length;Ke++)ht.feature=Oe.feature(Ke),Be.writeMessage(2,ue,ht);var dt=ht.keys;for(Ke=0;Ke<dt.length;Ke++)Be.writeStringField(3,dt[Ke]);var Ot=ht.values;for(Ke=0;Ke<Ot.length;Ke++)Be.writeMessage(4,Fe,Ot[Ke])}function ue(Oe,Be){var Ke=Oe.feature;Ke.id!==void 0&&Be.writeVarintField(1,Ke.id),Be.writeMessage(2,fe,Oe),Be.writeVarintField(3,Ke.type),Be.writeMessage(4,be,Ke)}function fe(Oe,Be){var Ke=Oe.feature,ht=Oe.keys,dt=Oe.values,Ot=Oe.keycache,Ut=Oe.valuecache;for(var jt in Ke.properties){var Vt=Ke.properties[jt],di=Ot[jt];if(Vt!==null){di===void 0&&(ht.push(jt),Ot[jt]=di=ht.length-1),Be.writeVarint(di);var gi=typeof Vt;gi!=="string"&&gi!=="boolean"&&gi!=="number"&&(Vt=JSON.stringify(Vt));var si=gi+":"+Vt,vi=Ut[si];vi===void 0&&(dt.push(Vt),Ut[si]=vi=dt.length-1),Be.writeVarint(vi)}}}function ve(Oe,Be){return(Be<<3)+(7&Oe)}function Pe(Oe){return Oe<<1^Oe>>31}function be(Oe,Be){for(var Ke=Oe.loadGeometry(),ht=Oe.type,dt=0,Ot=0,Ut=Ke.length,jt=0;jt<Ut;jt++){var Vt=Ke[jt],di=1;ht===1&&(di=Vt.length),Be.writeVarint(ve(1,di));for(var gi=ht===3?Vt.length-1:Vt.length,si=0;si<gi;si++){si===1&&ht!==1&&Be.writeVarint(ve(2,gi-1));var vi=Vt[si].x-dt,Si=Vt[si].y-Ot;Be.writeVarint(Pe(vi)),Be.writeVarint(Pe(Si)),dt+=vi,Ot+=Si}ht===3&&Be.writeVarint(ve(7,1))}}function Fe(Oe,Be){var Ke=typeof Oe;Ke==="string"?Be.writeStringField(1,Oe):Ke==="boolean"?Be.writeBooleanField(7,Oe):Ke==="number"&&(Oe%1!=0?Be.writeDoubleField(3,Oe):Oe<0?Be.writeSVarintField(6,Oe):Be.writeVarintField(5,Oe))}return cs.exports=X,cs.exports.fromVectorTileJs=X,cs.exports.fromGeojsonVt=function(Oe,Be){Be=Be||{};var Ke={};for(var ht in Oe)Ke[ht]=new G(Oe[ht].features,Be),Ke[ht].name=ht,Ke[ht].version=Be.version,Ke[ht].extent=Be.extent;return X({layers:Ke})},cs.exports.GeoJSONWrapper=G,cs.exports}(),Se=s.e9(ga);const ya={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Ne=>Ne},xa=Math.fround||(ko=new Float32Array(1),Ne=>(ko[0]=+Ne,ko[0]));var ko;const ft=3,rr=5,hr=6;class va{constructor(G){this.options=Object.assign(Object.create(ya),G),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(G){const{log:X,minZoom:K,maxZoom:ue}=this.options;X&&console.time("total time");const fe=`prepare ${G.length} points`;X&&console.time(fe),this.points=G;const ve=[];for(let be=0;be<G.length;be++){const Fe=G[be];if(!Fe.geometry)continue;const[Oe,Be]=Fe.geometry.coordinates,Ke=xa(Br(Oe)),ht=xa(ao(Be));ve.push(Ke,ht,1/0,be,-1,1),this.options.reduce&&ve.push(0)}let Pe=this.trees[ue+1]=this._createTree(ve);X&&console.timeEnd(fe);for(let be=ue;be>=K;be--){const Fe=+Date.now();Pe=this.trees[be]=this._createTree(this._cluster(Pe,be)),X&&console.log("z%d: %d clusters in %dms",be,Pe.numItems,+Date.now()-Fe)}return X&&console.timeEnd("total time"),this}getClusters(G,X){let K=((G[0]+180)%360+360)%360-180;const ue=Math.max(-90,Math.min(90,G[1]));let fe=G[2]===180?180:((G[2]+180)%360+360)%360-180;const ve=Math.max(-90,Math.min(90,G[3]));if(G[2]-G[0]>=360)K=-180,fe=180;else if(K>fe){const Be=this.getClusters([K,ue,180,ve],X),Ke=this.getClusters([-180,ue,fe,ve],X);return Be.concat(Ke)}const Pe=this.trees[this._limitZoom(X)],be=Pe.range(Br(K),ao(ve),Br(fe),ao(ue)),Fe=Pe.data,Oe=[];for(const Be of be){const Ke=this.stride*Be;Oe.push(Fe[Ke+rr]>1?pi(Fe,Ke,this.clusterProps):this.points[Fe[Ke+ft]])}return Oe}getChildren(G){const X=this._getOriginId(G),K=this._getOriginZoom(G),ue="No cluster with the specified id.",fe=this.trees[K];if(!fe)throw new Error(ue);const ve=fe.data;if(X*this.stride>=ve.length)throw new Error(ue);const Pe=this.options.radius/(this.options.extent*Math.pow(2,K-1)),be=fe.within(ve[X*this.stride],ve[X*this.stride+1],Pe),Fe=[];for(const Oe of be){const Be=Oe*this.stride;ve[Be+4]===G&&Fe.push(ve[Be+rr]>1?pi(ve,Be,this.clusterProps):this.points[ve[Be+ft]])}if(Fe.length===0)throw new Error(ue);return Fe}getLeaves(G,X,K){const ue=[];return this._appendLeaves(ue,G,X=X||10,K=K||0,0),ue}getTile(G,X,K){const ue=this.trees[this._limitZoom(G)],fe=Math.pow(2,G),{extent:ve,radius:Pe}=this.options,be=Pe/ve,Fe=(K-be)/fe,Oe=(K+1+be)/fe,Be={features:[]};return this._addTileFeatures(ue.range((X-be)/fe,Fe,(X+1+be)/fe,Oe),ue.data,X,K,fe,Be),X===0&&this._addTileFeatures(ue.range(1-be/fe,Fe,1,Oe),ue.data,fe,K,fe,Be),X===fe-1&&this._addTileFeatures(ue.range(0,Fe,be/fe,Oe),ue.data,-1,K,fe,Be),Be.features.length?Be:null}getClusterExpansionZoom(G){let X=this._getOriginZoom(G)-1;for(;X<=this.options.maxZoom;){const K=this.getChildren(G);if(X++,K.length!==1)break;G=K[0].properties.cluster_id}return X}_appendLeaves(G,X,K,ue,fe){const ve=this.getChildren(X);for(const Pe of ve){const be=Pe.properties;if(be&&be.cluster?fe+be.point_count<=ue?fe+=be.point_count:fe=this._appendLeaves(G,be.cluster_id,K,ue,fe):fe<ue?fe++:G.push(Pe),G.length===K)break}return fe}_createTree(G){const X=new s.bE(G.length/this.stride|0,this.options.nodeSize,Float32Array);for(let K=0;K<G.length;K+=this.stride)X.add(G[K],G[K+1]);return X.finish(),X.data=G,X}_addTileFeatures(G,X,K,ue,fe,ve){for(const Pe of G){const be=Pe*this.stride,Fe=X[be+rr]>1;let Oe,Be,Ke;if(Fe)Oe=Nn(X,be,this.clusterProps),Be=X[be],Ke=X[be+1];else{const Ot=this.points[X[be+ft]];Oe=Ot.properties;const[Ut,jt]=Ot.geometry.coordinates;Be=Br(Ut),Ke=ao(jt)}const ht={type:1,geometry:[[Math.round(this.options.extent*(Be*fe-K)),Math.round(this.options.extent*(Ke*fe-ue))]],tags:Oe};let dt;dt=Fe||this.options.generateId?X[be+ft]:this.points[X[be+ft]].id,dt!==void 0&&(ht.id=dt),ve.features.push(ht)}}_limitZoom(G){return Math.max(this.options.minZoom,Math.min(Math.floor(+G),this.options.maxZoom+1))}_cluster(G,X){const{radius:K,extent:ue,reduce:fe,minPoints:ve}=this.options,Pe=K/(ue*Math.pow(2,X)),be=G.data,Fe=[],Oe=this.stride;for(let Be=0;Be<be.length;Be+=Oe){if(be[Be+2]<=X)continue;be[Be+2]=X;const Ke=be[Be],ht=be[Be+1],dt=G.within(be[Be],be[Be+1],Pe),Ot=be[Be+rr];let Ut=Ot;for(const jt of dt){const Vt=jt*Oe;be[Vt+2]>X&&(Ut+=be[Vt+rr])}if(Ut>Ot&&Ut>=ve){let jt,Vt=Ke*Ot,di=ht*Ot,gi=-1;const si=(Be/Oe<<5)+(X+1)+this.points.length;for(const vi of dt){const Si=vi*Oe;if(be[Si+2]<=X)continue;be[Si+2]=X;const fn=be[Si+rr];Vt+=be[Si]*fn,di+=be[Si+1]*fn,be[Si+4]=si,fe&&(jt||(jt=this._map(be,Be,!0),gi=this.clusterProps.length,this.clusterProps.push(jt)),fe(jt,this._map(be,Si)))}be[Be+4]=si,Fe.push(Vt/Ut,di/Ut,1/0,si,-1,Ut),fe&&Fe.push(gi)}else{for(let jt=0;jt<Oe;jt++)Fe.push(be[Be+jt]);if(Ut>1)for(const jt of dt){const Vt=jt*Oe;if(!(be[Vt+2]<=X)){be[Vt+2]=X;for(let di=0;di<Oe;di++)Fe.push(be[Vt+di])}}}}return Fe}_getOriginId(G){return G-this.points.length>>5}_getOriginZoom(G){return(G-this.points.length)%32}_map(G,X,K){if(G[X+rr]>1){const ve=this.clusterProps[G[X+hr]];return K?Object.assign({},ve):ve}const ue=this.points[G[X+ft]].properties,fe=this.options.map(ue);return K&&fe===ue?Object.assign({},fe):fe}}function pi(Ne,G,X){return{type:"Feature",id:Ne[G+ft],properties:Nn(Ne,G,X),geometry:{type:"Point",coordinates:[(K=Ne[G],360*(K-.5)),Oo(Ne[G+1])]}};var K}function Nn(Ne,G,X){const K=Ne[G+rr],ue=K>=1e4?`${Math.round(K/1e3)}k`:K>=1e3?Math.round(K/100)/10+"k":K,fe=Ne[G+hr],ve=fe===-1?{}:Object.assign({},X[fe]);return Object.assign(ve,{cluster:!0,cluster_id:Ne[G+ft],point_count:K,point_count_abbreviated:ue})}function Br(Ne){return Ne/360+.5}function ao(Ne){const G=Math.sin(Ne*Math.PI/180),X=.5-.25*Math.log((1+G)/(1-G))/Math.PI;return X<0?0:X>1?1:X}function Oo(Ne){const G=(180-360*Ne)*Math.PI/180;return 360*Math.atan(Math.exp(G))/Math.PI-90}function Fo(Ne,G,X,K){let ue=K;const fe=G+(X-G>>1);let ve,Pe=X-G;const be=Ne[G],Fe=Ne[G+1],Oe=Ne[X],Be=Ne[X+1];for(let Ke=G+3;Ke<X;Ke+=3){const ht=ri(Ne[Ke],Ne[Ke+1],be,Fe,Oe,Be);if(ht>ue)ve=Ke,ue=ht;else if(ht===ue){const dt=Math.abs(Ke-fe);dt<Pe&&(ve=Ke,Pe=dt)}}ue>K&&(ve-G>3&&Fo(Ne,G,ve,K),Ne[ve+2]=ue,X-ve>3&&Fo(Ne,ve,X,K))}function ri(Ne,G,X,K,ue,fe){let ve=ue-X,Pe=fe-K;if(ve!==0||Pe!==0){const be=((Ne-X)*ve+(G-K)*Pe)/(ve*ve+Pe*Pe);be>1?(X=ue,K=fe):be>0&&(X+=ve*be,K+=Pe*be)}return ve=Ne-X,Pe=G-K,ve*ve+Pe*Pe}function us(Ne,G,X,K){const ue={id:Ne??null,type:G,geometry:X,tags:K,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(G==="Point"||G==="MultiPoint"||G==="LineString")Xr(ue,X);else if(G==="Polygon")Xr(ue,X[0]);else if(G==="MultiLineString")for(const fe of X)Xr(ue,fe);else if(G==="MultiPolygon")for(const fe of X)Xr(ue,fe[0]);return ue}function Xr(Ne,G){for(let X=0;X<G.length;X+=3)Ne.minX=Math.min(Ne.minX,G[X]),Ne.minY=Math.min(Ne.minY,G[X+1]),Ne.maxX=Math.max(Ne.maxX,G[X]),Ne.maxY=Math.max(Ne.maxY,G[X+1])}function lo(Ne,G,X,K){if(!G.geometry)return;const ue=G.geometry.coordinates;if(ue&&ue.length===0)return;const fe=G.geometry.type,ve=Math.pow(X.tolerance/((1<<X.maxZoom)*X.extent),2);let Pe=[],be=G.id;if(X.promoteId?be=G.properties[X.promoteId]:X.generateId&&(be=K||0),fe==="Point")sr(ue,Pe);else if(fe==="MultiPoint")for(const Fe of ue)sr(Fe,Pe);else if(fe==="LineString")Vs(ue,Pe,ve,!1);else if(fe==="MultiLineString"){if(X.lineMetrics){for(const Fe of ue)Pe=[],Vs(Fe,Pe,ve,!1),Ne.push(us(be,"LineString",Pe,G.properties));return}Bo(ue,Pe,ve,!1)}else if(fe==="Polygon")Bo(ue,Pe,ve,!0);else{if(fe!=="MultiPolygon"){if(fe==="GeometryCollection"){for(const Fe of G.geometry.geometries)lo(Ne,{id:be,geometry:Fe,properties:G.properties},X,K);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const Fe of ue){const Oe=[];Bo(Fe,Oe,ve,!0),Pe.push(Oe)}}Ne.push(us(be,fe,Pe,G.properties))}function sr(Ne,G){G.push(ba(Ne[0]),wa(Ne[1]),0)}function Vs(Ne,G,X,K){let ue,fe,ve=0;for(let be=0;be<Ne.length;be++){const Fe=ba(Ne[be][0]),Oe=wa(Ne[be][1]);G.push(Fe,Oe,0),be>0&&(ve+=K?(ue*Oe-Fe*fe)/2:Math.sqrt(Math.pow(Fe-ue,2)+Math.pow(Oe-fe,2))),ue=Fe,fe=Oe}const Pe=G.length-3;G[2]=1,Fo(G,0,Pe,X),G[Pe+2]=1,G.size=Math.abs(ve),G.start=0,G.end=G.size}function Bo(Ne,G,X,K){for(let ue=0;ue<Ne.length;ue++){const fe=[];Vs(Ne[ue],fe,X,K),G.push(fe)}}function ba(Ne){return Ne/360+.5}function wa(Ne){const G=Math.sin(Ne*Math.PI/180),X=.5-.25*Math.log((1+G)/(1-G))/Math.PI;return X<0?0:X>1?1:X}function dr(Ne,G,X,K,ue,fe,ve,Pe){if(K/=G,fe>=(X/=G)&&ve<K)return Ne;if(ve<X||fe>=K)return null;const be=[];for(const Fe of Ne){const Oe=Fe.geometry;let Be=Fe.type;const Ke=ue===0?Fe.minX:Fe.minY,ht=ue===0?Fe.maxX:Fe.maxY;if(Ke>=X&&ht<K){be.push(Fe);continue}if(ht<X||Ke>=K)continue;let dt=[];if(Be==="Point"||Be==="MultiPoint")Ta(Oe,dt,X,K,ue);else if(Be==="LineString")Sa(Oe,dt,X,K,ue,!1,Pe.lineMetrics);else if(Be==="MultiLineString")No(Oe,dt,X,K,ue,!1);else if(Be==="Polygon")No(Oe,dt,X,K,ue,!0);else if(Be==="MultiPolygon")for(const Ot of Oe){const Ut=[];No(Ot,Ut,X,K,ue,!0),Ut.length&&dt.push(Ut)}if(dt.length){if(Pe.lineMetrics&&Be==="LineString"){for(const Ot of dt)be.push(us(Fe.id,Be,Ot,Fe.tags));continue}Be!=="LineString"&&Be!=="MultiLineString"||(dt.length===1?(Be="LineString",dt=dt[0]):Be="MultiLineString"),Be!=="Point"&&Be!=="MultiPoint"||(Be=dt.length===3?"Point":"MultiPoint"),be.push(us(Fe.id,Be,dt,Fe.tags))}}return be.length?be:null}function Ta(Ne,G,X,K,ue){for(let fe=0;fe<Ne.length;fe+=3){const ve=Ne[fe+ue];ve>=X&&ve<=K&&ti(G,Ne[fe],Ne[fe+1],Ne[fe+2])}}function Sa(Ne,G,X,K,ue,fe,ve){let Pe=Mr(Ne);const be=ue===0?hs:Pc;let Fe,Oe,Be=Ne.start;for(let Ut=0;Ut<Ne.length-3;Ut+=3){const jt=Ne[Ut],Vt=Ne[Ut+1],di=Ne[Ut+2],gi=Ne[Ut+3],si=Ne[Ut+4],vi=ue===0?jt:Vt,Si=ue===0?gi:si;let fn=!1;ve&&(Fe=Math.sqrt(Math.pow(jt-gi,2)+Math.pow(Vt-si,2))),vi<X?Si>X&&(Oe=be(Pe,jt,Vt,gi,si,X),ve&&(Pe.start=Be+Fe*Oe)):vi>K?Si<K&&(Oe=be(Pe,jt,Vt,gi,si,K),ve&&(Pe.start=Be+Fe*Oe)):ti(Pe,jt,Vt,di),Si<X&&vi>=X&&(Oe=be(Pe,jt,Vt,gi,si,X),fn=!0),Si>K&&vi<=K&&(Oe=be(Pe,jt,Vt,gi,si,K),fn=!0),!fe&&fn&&(ve&&(Pe.end=Be+Fe*Oe),G.push(Pe),Pe=Mr(Ne)),ve&&(Be+=Fe)}let Ke=Ne.length-3;const ht=Ne[Ke],dt=Ne[Ke+1],Ot=ue===0?ht:dt;Ot>=X&&Ot<=K&&ti(Pe,ht,dt,Ne[Ke+2]),Ke=Pe.length-3,fe&&Ke>=3&&(Pe[Ke]!==Pe[0]||Pe[Ke+1]!==Pe[1])&&ti(Pe,Pe[0],Pe[1],Pe[2]),Pe.length&&G.push(Pe)}function Mr(Ne){const G=[];return G.size=Ne.size,G.start=Ne.start,G.end=Ne.end,G}function No(Ne,G,X,K,ue,fe){for(const ve of Ne)Sa(ve,G,X,K,ue,fe,!1)}function ti(Ne,G,X,K){Ne.push(G,X,K)}function hs(Ne,G,X,K,ue,fe){const ve=(fe-G)/(K-G);return ti(Ne,fe,X+(ue-X)*ve,1),ve}function Pc(Ne,G,X,K,ue,fe){const ve=(fe-X)/(ue-X);return ti(Ne,G+(K-G)*ve,fe,1),ve}function xr(Ne,G){const X=[];for(let K=0;K<Ne.length;K++){const ue=Ne[K],fe=ue.type;let ve;if(fe==="Point"||fe==="MultiPoint"||fe==="LineString")ve=Us(ue.geometry,G);else if(fe==="MultiLineString"||fe==="Polygon"){ve=[];for(const Pe of ue.geometry)ve.push(Us(Pe,G))}else if(fe==="MultiPolygon"){ve=[];for(const Pe of ue.geometry){const be=[];for(const Fe of Pe)be.push(Us(Fe,G));ve.push(be)}}X.push(us(ue.id,fe,ve,ue.tags))}return X}function Us(Ne,G){const X=[];X.size=Ne.size,Ne.start!==void 0&&(X.start=Ne.start,X.end=Ne.end);for(let K=0;K<Ne.length;K+=3)X.push(Ne[K]+G,Ne[K+1],Ne[K+2]);return X}function Ea(Ne,G){if(Ne.transformed)return Ne;const X=1<<Ne.z,K=Ne.x,ue=Ne.y;for(const fe of Ne.features){const ve=fe.geometry,Pe=fe.type;if(fe.geometry=[],Pe===1)for(let be=0;be<ve.length;be+=2)fe.geometry.push(Ma(ve[be],ve[be+1],G,X,K,ue));else for(let be=0;be<ve.length;be++){const Fe=[];for(let Oe=0;Oe<ve[be].length;Oe+=2)Fe.push(Ma(ve[be][Oe],ve[be][Oe+1],G,X,K,ue));fe.geometry.push(Fe)}}return Ne.transformed=!0,Ne}function Ma(Ne,G,X,K,ue,fe){return[Math.round(X*(Ne*K-ue)),Math.round(X*(G*K-fe))]}function Ia(Ne,G,X,K,ue){const fe=G===ue.maxZoom?0:ue.tolerance/((1<<G)*ue.extent),ve={features:[],numPoints:0,numSimplified:0,numFeatures:Ne.length,source:null,x:X,y:K,z:G,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const Pe of Ne)zc(ve,Pe,fe,ue);return ve}function zc(Ne,G,X,K){const ue=G.geometry,fe=G.type,ve=[];if(Ne.minX=Math.min(Ne.minX,G.minX),Ne.minY=Math.min(Ne.minY,G.minY),Ne.maxX=Math.max(Ne.maxX,G.maxX),Ne.maxY=Math.max(Ne.maxY,G.maxY),fe==="Point"||fe==="MultiPoint")for(let Pe=0;Pe<ue.length;Pe+=3)ve.push(ue[Pe],ue[Pe+1]),Ne.numPoints++,Ne.numSimplified++;else if(fe==="LineString")Aa(ve,ue,Ne,X,!1,!1);else if(fe==="MultiLineString"||fe==="Polygon")for(let Pe=0;Pe<ue.length;Pe++)Aa(ve,ue[Pe],Ne,X,fe==="Polygon",Pe===0);else if(fe==="MultiPolygon")for(let Pe=0;Pe<ue.length;Pe++){const be=ue[Pe];for(let Fe=0;Fe<be.length;Fe++)Aa(ve,be[Fe],Ne,X,!0,Fe===0)}if(ve.length){let Pe=G.tags||null;if(fe==="LineString"&&K.lineMetrics){Pe={};for(const Fe in G.tags)Pe[Fe]=G.tags[Fe];Pe.mapbox_clip_start=ue.start/ue.size,Pe.mapbox_clip_end=ue.end/ue.size}const be={geometry:ve,type:fe==="Polygon"||fe==="MultiPolygon"?3:fe==="LineString"||fe==="MultiLineString"?2:1,tags:Pe};G.id!==null&&(be.id=G.id),Ne.features.push(be)}}function Aa(Ne,G,X,K,ue,fe){const ve=K*K;if(K>0&&G.size<(ue?ve:K))return void(X.numPoints+=G.length/3);const Pe=[];for(let be=0;be<G.length;be+=3)(K===0||G[be+2]>ve)&&(X.numSimplified++,Pe.push(G[be],G[be+1])),X.numPoints++;ue&&function(be,Fe){let Oe=0;for(let Be=0,Ke=be.length,ht=Ke-2;Be<Ke;ht=Be,Be+=2)Oe+=(be[Be]-be[ht])*(be[Be+1]+be[ht+1]);if(Oe>0===Fe)for(let Be=0,Ke=be.length;Be<Ke/2;Be+=2){const ht=be[Be],dt=be[Be+1];be[Be]=be[Ke-2-Be],be[Be+1]=be[Ke-1-Be],be[Ke-2-Be]=ht,be[Ke-1-Be]=dt}}(Pe,fe),Ne.push(Pe)}const Rc={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Dc{constructor(G,X){const K=(X=this.options=function(fe,ve){for(const Pe in ve)fe[Pe]=ve[Pe];return fe}(Object.create(Rc),X)).debug;if(K&&console.time("preprocess data"),X.maxZoom<0||X.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(X.promoteId&&X.generateId)throw new Error("promoteId and generateId cannot be used together.");let ue=function(fe,ve){const Pe=[];if(fe.type==="FeatureCollection")for(let be=0;be<fe.features.length;be++)lo(Pe,fe.features[be],ve,be);else lo(Pe,fe.type==="Feature"?fe:{geometry:fe},ve);return Pe}(G,X);this.tiles={},this.tileCoords=[],K&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",X.indexMaxZoom,X.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),ue=function(fe,ve){const Pe=ve.buffer/ve.extent;let be=fe;const Fe=dr(fe,1,-1-Pe,Pe,0,-1,2,ve),Oe=dr(fe,1,1-Pe,2+Pe,0,-1,2,ve);return(Fe||Oe)&&(be=dr(fe,1,-Pe,1+Pe,0,-1,2,ve)||[],Fe&&(be=xr(Fe,1).concat(be)),Oe&&(be=be.concat(xr(Oe,-1)))),be}(ue,X),ue.length&&this.splitTile(ue,0,0,0),K&&(ue.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(G,X,K,ue,fe,ve,Pe){const be=[G,X,K,ue],Fe=this.options,Oe=Fe.debug;for(;be.length;){ue=be.pop(),K=be.pop(),X=be.pop(),G=be.pop();const Be=1<<X,Ke=Mn(X,K,ue);let ht=this.tiles[Ke];if(!ht&&(Oe>1&&console.time("creation"),ht=this.tiles[Ke]=Ia(G,X,K,ue,Fe),this.tileCoords.push({z:X,x:K,y:ue}),Oe)){Oe>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",X,K,ue,ht.numFeatures,ht.numPoints,ht.numSimplified),console.timeEnd("creation"));const fn=`z${X}`;this.stats[fn]=(this.stats[fn]||0)+1,this.total++}if(ht.source=G,fe==null){if(X===Fe.indexMaxZoom||ht.numPoints<=Fe.indexMaxPoints)continue}else{if(X===Fe.maxZoom||X===fe)continue;if(fe!=null){const fn=fe-X;if(K!==ve>>fn||ue!==Pe>>fn)continue}}if(ht.source=null,G.length===0)continue;Oe>1&&console.time("clipping");const dt=.5*Fe.buffer/Fe.extent,Ot=.5-dt,Ut=.5+dt,jt=1+dt;let Vt=null,di=null,gi=null,si=null,vi=dr(G,Be,K-dt,K+Ut,0,ht.minX,ht.maxX,Fe),Si=dr(G,Be,K+Ot,K+jt,0,ht.minX,ht.maxX,Fe);G=null,vi&&(Vt=dr(vi,Be,ue-dt,ue+Ut,1,ht.minY,ht.maxY,Fe),di=dr(vi,Be,ue+Ot,ue+jt,1,ht.minY,ht.maxY,Fe),vi=null),Si&&(gi=dr(Si,Be,ue-dt,ue+Ut,1,ht.minY,ht.maxY,Fe),si=dr(Si,Be,ue+Ot,ue+jt,1,ht.minY,ht.maxY,Fe),Si=null),Oe>1&&console.timeEnd("clipping"),be.push(Vt||[],X+1,2*K,2*ue),be.push(di||[],X+1,2*K,2*ue+1),be.push(gi||[],X+1,2*K+1,2*ue),be.push(si||[],X+1,2*K+1,2*ue+1)}}getTile(G,X,K){G=+G,X=+X,K=+K;const ue=this.options,{extent:fe,debug:ve}=ue;if(G<0||G>24)return null;const Pe=1<<G,be=Mn(G,X=X+Pe&Pe-1,K);if(this.tiles[be])return Ea(this.tiles[be],fe);ve>1&&console.log("drilling down to z%d-%d-%d",G,X,K);let Fe,Oe=G,Be=X,Ke=K;for(;!Fe&&Oe>0;)Oe--,Be>>=1,Ke>>=1,Fe=this.tiles[Mn(Oe,Be,Ke)];return Fe&&Fe.source?(ve>1&&(console.log("found parent tile z%d-%d-%d",Oe,Be,Ke),console.time("drilling down")),this.splitTile(Fe.source,Oe,Be,Ke,G,X,K),ve>1&&console.timeEnd("drilling down"),this.tiles[be]?Ea(this.tiles[be],fe):null):null}}function Mn(Ne,G,X){return 32*((1<<Ne)*X+G)+Ne}function fl(Ne,G){const X=Ne.tileID.canonical;if(!this._geoJSONIndex)return void G(null,null);const K=this._geoJSONIndex.getTile(X.z,X.x,X.y);if(!K)return void G(null,null);const ue=new Oi(K.features);let fe=Se(ue);fe.byteOffset===0&&fe.byteLength===fe.buffer.byteLength||(fe=new Uint8Array(fe)),G(null,{vectorTile:ue,rawData:fe.buffer})}class Lc extends Jt{constructor(G,X,K,ue,fe,ve){super(G,X,K,ue,fl,ve),fe&&(this.loadGeoJSON=fe),this._dynamicIndex=new wi}loadData(G,X){const K=G&&G.request,ue=K&&K.collectResourceTiming;this.loadGeoJSON(G,(fe,ve)=>{if(fe||!ve)return X(fe);if(typeof ve!="object")return X(new Error(`Input data given to '${G.source}' is not a valid GeoJSON object.`));{try{if(G.filter){const be=s.U(G.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(be.result==="error")throw new Error(be.value.map(Fe=>`${Fe.key}: ${Fe.message}`).join(", "));ve.features=ve.features.filter(Fe=>be.value.evaluate({zoom:0},Fe))}G.dynamic?(ve.type==="Feature"&&(ve={type:"FeatureCollection",features:[ve]}),G.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(ve.features,this.loaded),G.cluster&&(ve.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=G.cluster?new va(function({superclusterOptions:be,clusterProperties:Fe}){if(!Fe||!be)return be;const Oe={},Be={},Ke={accumulated:null,zoom:0},ht={properties:null},dt=Object.keys(Fe);for(const Ot of dt){const[Ut,jt]=Fe[Ot],Vt=s.U(jt),di=s.U(typeof Ut=="string"?[Ut,["accumulated"],["get",Ot]]:Ut);Oe[Ot]=Vt.value,Be[Ot]=di.value}return be.map=Ot=>{ht.properties=Ot;const Ut={};for(const jt of dt)Ut[jt]=Oe[jt].evaluate(Ke,ht);return Ut},be.reduce=(Ot,Ut)=>{ht.properties=Ut;for(const jt of dt)Ke.accumulated=Ot[jt],Ot[jt]=Be[jt].evaluate(Ke,ht)},be}(G)).load(ve.features):G.dynamic?this._dynamicIndex:function(be,Fe){return new Dc(be,Fe)}(ve,G.geojsonVtOptions)}catch(be){return X(be)}const Pe={};if(ue){const be=_e(K);be&&(Pe.resourceTiming={},Pe.resourceTiming[G.source]=JSON.parse(JSON.stringify(be)))}X(null,Pe)}})}reloadTile(G,X){const K=this.loaded;return K&&K[G.uid]?G.partial?X(null,void 0):super.reloadTile(G,X):this.loadTile(G,X)}loadGeoJSON(G,X){if(G.request)s.n(G.request,X);else{if(typeof G.data!="string")return X(new Error(`Input data given to '${G.source}' is not a valid GeoJSON object.`));try{return X(null,JSON.parse(G.data))}catch{return X(new Error(`Input data given to '${G.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(G,X){try{X(null,this._geoJSONIndex.getClusterExpansionZoom(G.clusterId))}catch(K){X(K)}}getClusterChildren(G,X){try{X(null,this._geoJSONIndex.getChildren(G.clusterId))}catch(K){X(K)}}getClusterLeaves(G,X){try{X(null,this._geoJSONIndex.getLeaves(G.clusterId,G.limit,G.offset))}catch(K){X(K)}}}class pl{constructor(G,X){this.tileID=new s.aG(G.tileID.overscaledZ,G.tileID.wrap,G.tileID.canonical.z,G.tileID.canonical.x,G.tileID.canonical.y),this.tileZoom=G.tileZoom,this.uid=G.uid,this.zoom=G.zoom,this.canonical=G.tileID.canonical,this.pixelRatio=G.pixelRatio,this.tileSize=G.tileSize,this.source=G.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=G.projection,this.brightness=X}parse(G,X,K,ue){this.status="parsing";const fe=new s.aG(K.tileID.overscaledZ,K.tileID.wrap,K.tileID.canonical.z,K.tileID.canonical.x,K.tileID.canonical.y),ve=[],Pe=X.familiesBySource[K.source],be=new s.d$(fe,K.promoteId);return be.bucketLayerIDs=[],be.is3DTile=!0,s.ea(G).then(Fe=>{if(!Fe)return ue(new Error("Could not parse tile"));const Oe=s.eb(Fe,1/s.cc(K.tileID.canonical)),Be=Fe.json.extensionsUsed&&Fe.json.extensionsUsed.includes("MAPBOX_mesh_features")||Fe.json.asset.extras&&Fe.json.asset.extras.MAPBOX_mesh_features,Ke=Fe.json.extensionsUsed&&Fe.json.extensionsUsed.includes("EXT_meshopt_compression"),ht=new s.a8(this.zoom,{brightness:this.brightness});for(const dt in Pe)for(const Ot of Pe[dt]){const Ut=Ot[0];be.bucketLayerIDs.push(Ot.map(Vt=>s.aC(Vt.id,Vt.scope))),Ut.recalculate(ht,[]);const jt=new s.ec(Ot,Oe,fe,Be,Ke,this.brightness,be);Be||(jt.needsUpload=!0),ve.push(jt),jt.evaluate(Ut)}this.status="done",ue(null,{buckets:ve,featureIndex:be,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(Fe=>ue(new Error(Fe.message)))}}class $n{constructor(G,X,K,ue,fe,ve){this.actor=G,this.layerIndex=X,this.availableImages=K,this.brightness=ve,this.loading={},this.loaded={}}loadTile(G,X){const K=G.uid,ue=this.loading[K]=new pl(G,this.brightness);s.bi(G.request,(fe,ve)=>{const Pe=!this.loading[K];return delete this.loading[K],Pe||fe?(ue.status="done",Pe||(this.loaded[K]=ue),X(fe)):ve&&ve.byteLength!==0?void ue.parse(ve,this.layerIndex,G,(be,Fe)=>{ue.status="done",this.loaded=this.loaded||{},this.loaded[K]=ue,be||!Fe?X(be):X(null,Fe)}):(ue.status="done",this.loaded[K]=ue,X())})}reloadTile(G,X){const K=this.loaded,ue=G.uid;if(K&&K[ue]){const fe=K[ue];fe.projection=G.projection,fe.brightness=G.brightness;const ve=(Pe,be)=>{fe.reloadCallback&&(delete fe.reloadCallback,this.loadTile(G,X)),X(Pe,be)};fe.status==="parsing"?fe.reloadCallback=ve:fe.status==="done"&&this.loadTile(G,X)}}abortTile(G,X){const K=G.uid;this.loading[K]&&delete this.loading[K],X()}removeTile(G,X){const K=this.loaded,ue=G.uid;K&&K[ue]&&delete K[ue],X()}}class ds{constructor(G){this.self=G,this.actor=new s.ed(G,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.imageRasterizer=new s.I,this.projections={},this.defaultProjection=s.bP({name:"mercator"}),this.workerSourceTypes={vector:Jt,geojson:Lc,"batched-model":$n},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(X,K)=>{if(this.workerSourceTypes[X])throw new Error(`Worker source with name "${X}" already registered.`);this.workerSourceTypes[X]=K},this.self.registerRTLTextPlugin=X=>{if(s.ee.isParsed())throw new Error("RTL text plugin already registered.");s.ee.applyArabicShaping=X.applyArabicShaping,s.ee.processBidirectionalText=X.processBidirectionalText,s.ee.processStyledBidirectionalText=X.processStyledBidirectionalText}}clearCaches(G,X,K){delete this.layerIndexes[G],delete this.availableImages[G],delete this.workerSources[G],delete this.demWorkerSources[G],delete this.rasterArrayWorkerSource,K()}checkIfReady(G,X,K){K()}setReferrer(G,X){this.referrer=X}spriteLoaded(G,{scope:X,isLoaded:K}){if(this.isSpriteLoaded[G]||(this.isSpriteLoaded[G]={}),this.isSpriteLoaded[G][X]=K,this.workerSources[G]&&this.workerSources[G][X])for(const ue in this.workerSources[G][X]){const fe=this.workerSources[G][X][ue];for(const ve in fe){const Pe=fe[ve];Pe instanceof Jt&&(Pe.isSpriteLoaded=K,Pe.fire(new s.z("isSpriteLoaded")))}}}setImages(G,{scope:X,images:K},ue){if(this.availableImages[G]||(this.availableImages[G]={}),this.availableImages[G][X]=K,this.workerSources[G]&&this.workerSources[G][X]){for(const fe in this.workerSources[G][X]){const ve=this.workerSources[G][X][fe];for(const Pe in ve)ve[Pe].availableImages=K}ue()}else ue()}setProjection(G,X){this.projections[G]=s.bP(X)}setBrightness(G,X,K){this.brightness=X,K()}setLayers(G,X,K){this.getLayerIndex(G,X.scope).replace(X.layers,X.options),K()}updateLayers(G,X,K){this.getLayerIndex(G,X.scope).update(X.layers,X.removedIds,X.options),K()}loadTile(G,X,K){X.projection=this.projections[G]||this.defaultProjection,this.getWorkerSource(G,X.type,X.source,X.scope).loadTile(X,K)}loadDEMTile(G,X,K){this.getDEMWorkerSource(G,X.source,X.scope).loadTile(X,K)}decodeRasterArray(G,X,K){this.getRasterArrayWorkerSource().decodeRasterArray(X,K)}reloadTile(G,X,K){X.projection=this.projections[G]||this.defaultProjection,this.getWorkerSource(G,X.type,X.source,X.scope).reloadTile(X,K)}abortTile(G,X,K){this.getWorkerSource(G,X.type,X.source,X.scope).abortTile(X,K)}removeTile(G,X,K){this.getWorkerSource(G,X.type,X.source,X.scope).removeTile(X,K)}removeSource(G,X,K){if(!(this.workerSources[G]&&this.workerSources[G][X.scope]&&this.workerSources[G][X.scope][X.type]&&this.workerSources[G][X.scope][X.type][X.source]))return;const ue=this.workerSources[G][X.scope][X.type][X.source];delete this.workerSources[G][X.scope][X.type][X.source],ue.removeSource!==void 0?ue.removeSource(X,K):K()}loadWorkerSource(G,X,K){try{this.self.importScripts(X.url),K()}catch(ue){K(ue.toString())}}syncRTLPluginState(G,X,K){try{s.ee.setState(X);const ue=s.ee.getPluginURL();if(s.ee.isLoaded()&&!s.ee.isParsed()&&ue!=null){this.self.importScripts(ue);const fe=s.ee.isParsed();K(fe?void 0:new Error(`RTL Text Plugin failed to import scripts from ${ue}`),fe)}}catch(ue){K(ue.toString())}}setDracoUrl(G,X){this.dracoUrl=X}getAvailableImages(G,X){this.availableImages[G]||(this.availableImages[G]={});let K=this.availableImages[G][X];return K||(K=[]),K}getLayerIndex(G,X){this.layerIndexes[G]||(this.layerIndexes[G]={});let K=this.layerIndexes[G][X];return K||(K=this.layerIndexes[G][X]=new Ie,K.scope=X),K}getWorkerSource(G,X,K,ue){return this.workerSources[G]||(this.workerSources[G]={}),this.workerSources[G][ue]||(this.workerSources[G][ue]={}),this.workerSources[G][ue][X]||(this.workerSources[G][ue][X]={}),this.isSpriteLoaded[G]||(this.isSpriteLoaded[G]={}),this.workerSources[G][ue][X][K]||(this.workerSources[G][ue][X][K]=new this.workerSourceTypes[X]({send:(fe,ve,Pe,be,Fe,Oe)=>{this.actor.send(fe,ve,Pe,G,Fe,Oe)},scheduler:this.actor.scheduler},this.getLayerIndex(G,ue),this.getAvailableImages(G,ue),this.isSpriteLoaded[G][ue],void 0,this.brightness)),this.workerSources[G][ue][X][K]}rasterizeImages(G,X,K){const{imageTasks:ue,scope:fe}=X,ve={};for(const Pe in ue){const{image:be,imageIdWithOptions:Fe}=ue[Pe];ve[Pe]=this.imageRasterizer.rasterize(Fe,be,fe,G)}K(void 0,ve)}removeRasterizedImages(G,X,K){const{imageIds:ue,scope:fe}=X;this.imageRasterizer.removeImagesFromCacheByIds(ue,fe,G),K()}getDEMWorkerSource(G,X,K){return this.demWorkerSources[G]||(this.demWorkerSources[G]={}),this.demWorkerSources[G][K]||(this.demWorkerSources[G][K]={}),this.demWorkerSources[G][K][X]||(this.demWorkerSources[G][K][X]=new It),this.demWorkerSources[G][K][X]}getRasterArrayWorkerSource(){return this.rasterArrayWorkerSource||(this.rasterArrayWorkerSource=new xt),this.rasterArrayWorkerSource}enforceCacheSizeLimit(G,X){s.ef(X)}getWorkerPerformanceMetrics(G,X,K){K(void 0,void 0)}}return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope&&(self.worker=new ds(self)),ds}),Y(["./shared"],function(s){var _e="3.10.0";const ce={create:"create",load:"load",fullLoad:"fullLoad"},oe={mark(l){performance.mark(l)},measure(l,t,n){performance.measure(l,t,n)}};function Ie(l){const t=l.name.split("?")[0];return s.a(t)&&t.includes("mapbox-gl.js")?"javascript":s.a(t)&&t.includes("mapbox-gl.css")?"css":s.b(t)?"fontRange":s.c(t)?"sprite":s.i(t)?"style":s.d(t)?"tilejson":"other"}var Me,De={},Ve=function(){if(Me)return De;function l(c){return!t(c)}function t(c){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var p,_,b=new Blob([""],{type:"text/javascript"}),E=URL.createObjectURL(b);try{_=new Worker(E),p=!0}catch{p=!1}return _&&_.terminate(),URL.revokeObjectURL(E),p}()?function(){var p=document.createElement("canvas");p.width=p.height=1;var _=p.getContext("2d");if(!_)return!1;var b=_.getImageData(0,0,1,1);return b&&b.width===p.width}()?(n[d=c&&c.failIfMajorPerformanceCaveat]===void 0&&(n[d]=function(p){var _,b=function(E){var I=document.createElement("canvas"),A=Object.create(l.webGLContextAttributes);return A.failIfMajorPerformanceCaveat=E,I.getContext("webgl2",A)}(p);if(!b)return!1;try{_=b.createShader(b.VERTEX_SHADER)}catch{return!1}return!(!_||b.isContextLost())&&(b.shaderSource(_,"void main() {}"),b.compileShader(_),b.getShaderParameter(_,b.COMPILE_STATUS)===!0)}(d)),n[d]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var d}Me=1,De.supported=l,De.notSupportedReason=t;var n={};return l.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},De}();function We(l,t,n){const c=document.createElement(l);return t!=null&&(c.className=t),n&&n.appendChild(c),c}function st(l,t,n){const c=document.createElementNS("http://www.w3.org/2000/svg",l);for(const d of Object.keys(t))c.setAttributeNS(null,d,String(t[d]));return n&&n.appendChild(c),c}const ct=typeof document<"u"?document.documentElement&&document.documentElement.style:null,gt=ct&&ct.userSelect!==void 0?"userSelect":"WebkitUserSelect";let At;function ot(){ct&&gt&&(At=ct[gt],ct[gt]="none")}function zt(){ct&&gt&&(ct[gt]=At)}function Rt(l){l.preventDefault(),l.stopPropagation(),window.removeEventListener("click",Rt,!0)}function vt(){window.addEventListener("click",Rt,!0),window.setTimeout(()=>{window.removeEventListener("click",Rt,!0)},0)}function Nt(l,t){const n=l.getBoundingClientRect();return xt(l,n,t)}function Jt(l,t){const n=l.getBoundingClientRect(),c=[];for(let d=0;d<t.length;d++)c.push(xt(l,n,t[d]));return c}function It(l){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&l.button===2&&l.ctrlKey?0:l.button}function xt(l,t,n){const c=l.offsetWidth===t.width?1:l.offsetWidth/t.width;return new s.P((n.clientX-t.left)*c,(n.clientY-t.top)*c)}const $i="01",ki="NO_ACCESS_TOKEN";class Oi{constructor(t,n,c){this._transformRequestFn=t,this._customAccessToken=n,this._silenceAuthErrors=!!c,this._createSkuToken()}_createSkuToken(){const t=function(){let n="";for(let c=0;c<10;c++)n+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",$i,n].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,n){return this._transformRequestFn&&this._transformRequestFn(t,n)||{url:t}}normalizeStyleURL(t,n){if(!s.f(t))return t;const c=ai(t);return c.params.push(`sdk=js-${_e}`),c.path=`/styles/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||n)}normalizeGlyphsURL(t,n){if(!s.f(t))return t;const c=ai(t);return c.path=`/fonts/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||n)}normalizeModelURL(t,n){if(!s.f(t))return t;const c=ai(t);return c.path=`/models/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||n)}normalizeSourceURL(t,n,c,d){if(!s.f(t))return t;const p=ai(t);return p.path=`/v4/${p.authority}.json`,p.params.push("secure"),c&&p.params.push(`language=${c}`),d&&p.params.push(`worldview=${d}`),this._makeAPIURL(p,this._customAccessToken||n)}normalizeIconsetURL(t,n){const c=ai(t);return s.f(t)?(c.path=`/styles/v1${c.path}/iconset.pbf`,this._makeAPIURL(c,this._customAccessToken||n)):wi(c)}normalizeSpriteURL(t,n,c,d){const p=ai(t);return s.f(t)?(p.path=`/styles/v1${p.path}/sprite${n}${c}`,this._makeAPIURL(p,this._customAccessToken||d)):(p.path+=`${n}${c}`,wi(p))}normalizeTileURL(t,n,c){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!s.f(t))return t;const d=ai(t);d.path=d.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${n||c&&d.authority!=="raster"&&c===512?"@2x":""}${s.m.supported?".webp":"$1"}`),d.authority==="raster"?d.path=`/${s.e.RASTER_URL_PREFIX}${d.path}`:d.authority==="rasterarrays"?d.path=`/${s.e.RASTERARRAYS_URL_PREFIX}${d.path}`:d.authority==="3dtiles"?d.path=`/${s.e.TILES3D_URL_PREFIX}${d.path}`:(d.path=d.path.replace(/^.+\/v4\//,"/"),d.path=`/${s.e.TILE_URL_VERSION}${d.path}`);const p=this._customAccessToken||function(_){for(const b of _){const E=b.match(/^access_token=(.*)$/);if(E)return E[1]}return null}(d.params)||s.e.ACCESS_TOKEN;return s.e.REQUIRE_ACCESS_TOKEN&&p&&this._skuToken&&d.params.push(`sku=${this._skuToken}`),this._makeAPIURL(d,p)}canonicalizeTileURL(t,n){const c=ai(t);if(!c.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!c.path.match(/\.[\w]+$/))return t;let d="mapbox://";c.path.match(/^\/raster\/v1\//)?d+=`raster/${c.path.replace(`/${s.e.RASTER_URL_PREFIX}/`,"")}`:c.path.match(/^\/rasterarrays\/v1\//)?d+=`rasterarrays/${c.path.replace(`/${s.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:d+=`tiles/${c.path.replace(`/${s.e.TILE_URL_VERSION}/`,"")}`;let p=c.params;return n&&(p=p.filter(_=>!_.match(/^access_token=/))),p.length&&(d+=`?${p.join("&")}`),d}canonicalizeTileset(t,n){const c=!!n&&s.f(n),d=[];for(const p of t.tiles||[])s.h(p)?d.push(this.canonicalizeTileURL(p,c)):d.push(p);return d}_makeAPIURL(t,n){const c="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",d=ai(s.e.API_URL);if(t.protocol=d.protocol,t.authority=d.authority,t.protocol==="http"){const p=t.params.indexOf("secure");p>=0&&t.params.splice(p,1)}if(d.path!=="/"&&(t.path=`${d.path}${t.path}`),!s.e.REQUIRE_ACCESS_TOKEN)return wi(t);if(n=n||s.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!n)throw new Error(`An API access token is required to use Mapbox GL. ${c}`);if(n[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${c}`)}return t.params=t.params.filter(p=>p.indexOf("access_token")===-1),t.params.push(`access_token=${n||""}`),wi(t)}}const tt=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function ai(l){const t=l.match(tt);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function wi(l){const t=l.params.length?`?${l.params.join("&")}`:"";return`${l.protocol}://${l.authority}${l.path}${t}`}const Wi="mapbox.eventData";function Zt(l){if(!l)return null;const t=l.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(s.j(t[1]))}catch{return null}}class Fn{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const n=Zt(s.e.ACCESS_TOKEN);let c="";return c=n&&n.u?s.k(n.u):s.e.ACCESS_TOKEN||"",t?`${Wi}.${t}:${c}`:`${Wi}:${c}`}fetchEventData(){const t=s.s("localStorage"),n=this.getStorageKey(),c=this.getStorageKey("uuid");if(t)try{const d=localStorage.getItem(n);d&&(this.eventData=JSON.parse(d));const p=localStorage.getItem(c);p&&(this.anonId=p)}catch{s.w("Unable to read from LocalStorage")}}saveEventData(){const t=s.s("localStorage"),n=this.getStorageKey(),c=this.getStorageKey("uuid"),d=this.anonId;if(t&&d)try{localStorage.setItem(c,d),Object.keys(this.eventData).length>=1&&localStorage.setItem(n,JSON.stringify(this.eventData))}catch{s.w("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,n,c,d){if(!s.e.EVENTS_URL)return;const p=ai(s.e.EVENTS_URL);p.params.push(`access_token=${d||s.e.ACCESS_TOKEN||""}`);const _={event:this.type,created:new Date(t).toISOString()},b=n?s.l(_,n):_,E={url:wi(p),headers:{"Content-Type":"text/plain"},body:JSON.stringify([b])};this.pendingRequest=s.p(E,I=>{this.pendingRequest=null,c(I),this.saveEventData(),this.processRequests(d)})}queueRequest(t,n){this.queue.push(t),this.processRequests(n)}}const Bn=new class extends Fn{constructor(l){super("appUserTurnstile"),this._customAccessToken=l}postTurnstileEvent(l,t){s.e.EVENTS_URL&&s.e.ACCESS_TOKEN&&Array.isArray(l)&&l.some(n=>s.f(n)||s.h(n))&&this.queueRequest(Date.now(),t)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const t=Zt(s.e.ACCESS_TOKEN),n=t?t.u:s.e.ACCESS_TOKEN;let c=n!==this.eventData.tokenU;s.v(this.anonId)||(this.anonId=s.u(),c=!0);const d=this.queue.shift();if(this.eventData.lastSuccess){const p=new Date(this.eventData.lastSuccess),_=new Date(d),b=(d-this.eventData.lastSuccess)/864e5;c=c||b>=1||b<-1||p.getDate()!==_.getDate()}else c=!0;c?this.postEvent(d,{sdkIdentifier:"mapbox-gl-js",sdkVersion:_e,skuId:$i,"enabled.telemetry":!1,userId:this.anonId},p=>{p||(this.eventData.lastSuccess=d,this.eventData.tokenU=n)},l):this.processRequests()}},Ln=Bn.postTurnstileEvent.bind(Bn),qt=new class extends Fn{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(l,t,n,c){this.skuToken=t,this.errorCb=c,s.e.EVENTS_URL&&(n||s.e.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},n):this.errorCb(new Error(ki)))}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:n}=this.queue.shift();t&&this.success[t]||(this.anonId||this.fetchEventData(),s.v(this.anonId)||(this.anonId=s.u()),this.postEvent(n,{sdkIdentifier:"mapbox-gl-js",sdkVersion:_e,skuId:$i,skuToken:this.skuToken,userId:this.anonId},c=>{c?this.errorCb(c):t&&(this.success[t]=!0)},l))}remove(){this.errorCb=null}},ls=qt.postMapLoadEvent.bind(qt),nr=new class extends Fn{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(l){let t=this.mapInstanceIdMap.get(l);return t||(t=s.u(),this.mapInstanceIdMap.set(l,t)),t}getEventId(l){const t=this.eventIdPerMapInstanceMap.get(l)||0;return this.eventIdPerMapInstanceMap.set(l,t+1),t}postStyleLoadEvent(l,t){const{map:n,style:c,importedStyles:d}=t;if(!s.e.EVENTS_URL||!l&&!s.e.ACCESS_TOKEN)return;const p=this.getMapInstanceId(n),_={mapInstanceId:p,eventId:this.getEventId(p),style:c};d.length&&(_.importedStyles=d),this.queueRequest({timestamp:Date.now(),payload:_},l)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,payload:n}=this.queue.shift();this.postEvent(t,n,()=>{},l)}},Bs=nr.postStyleLoadEvent.bind(nr),Ns=new class extends Fn{constructor(){super("gljs.performance")}postPerformanceEvent(l,t){s.e.EVENTS_URL&&(l||s.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},l)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,performanceData:n}=this.queue.shift(),c=function(d){const p=performance.getEntriesByType("resource"),_=performance.getEntriesByType("mark"),b=function(F){const q={};if(F){for(const U in F)if(U!=="other")for(const H of F[U]){const Z=`${U}ResolveRangeMin`,J=`${U}ResolveRangeMax`,re=`${U}RequestCount`,ne=`${U}RequestCachedCount`;q[Z]=Math.min(q[Z]||1/0,H.startTime),q[J]=Math.max(q[J]||-1/0,H.responseEnd);const de=le=>{q[le]===void 0&&(q[le]=0),++q[le]};H.transferSize!==void 0&&H.transferSize===0&&de(ne),de(re)}}return q}(function(F,q){const U={};if(F)for(const H of F){const Z=q(H);U[Z]===void 0&&(U[Z]=[]),U[Z].push(H)}return U}(p,Ie)),E=window.devicePixelRatio,I=navigator.connection||navigator.mozConnection||navigator.webkitConnection,A=I?I.effectiveType:void 0,R={counters:[],metadata:[],attributes:[]},D=(F,q,U)=>{U!=null&&F.push({name:q,value:U.toString()})};for(const F in b)D(R.counters,F,b[F]);if(d.interactionRange[0]!==1/0&&d.interactionRange[1]!==-1/0&&(D(R.counters,"interactionRangeMin",d.interactionRange[0]),D(R.counters,"interactionRangeMax",d.interactionRange[1])),_)for(const F of Object.keys(ce)){const q=ce[F],U=_.find(H=>H.name===q);U&&D(R.counters,q,U.startTime)}return D(R.counters,"visibilityHidden",d.visibilityHidden),D(R.attributes,"style",function(F){if(F)for(const q of F){const U=q.name.split("?")[0];if(s.i(U)){const H=U.split("/").slice(-2);if(H.length===2)return`mapbox://styles/${H[0]}/${H[1]}`}}}(p)),D(R.attributes,"terrainEnabled",d.terrainEnabled?"true":"false"),D(R.attributes,"fogEnabled",d.fogEnabled?"true":"false"),D(R.attributes,"projection",d.projection),D(R.attributes,"zoom",d.zoom),D(R.metadata,"devicePixelRatio",E),D(R.metadata,"connectionEffectiveType",A),D(R.metadata,"navigatorUserAgent",navigator.userAgent),D(R.metadata,"screenWidth",window.screen.width),D(R.metadata,"screenHeight",window.screen.height),D(R.metadata,"windowWidth",window.innerWidth),D(R.metadata,"windowHeight",window.innerHeight),D(R.metadata,"mapWidth",d.width/E),D(R.metadata,"mapHeight",d.height/E),D(R.metadata,"webglRenderer",d.renderer),D(R.metadata,"webglVendor",d.vendor),D(R.metadata,"sdkVersion",_e),D(R.metadata,"sdkIdentifier","mapbox-gl-js"),R}(n);for(const d of c.metadata);for(const d of c.counters);for(const d of c.attributes);this.postEvent(t,c,()=>{},l)}},cs=Ns.postPerformanceEvent.bind(Ns),ga=new class extends Fn{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(l,t,n,c){if(!s.e.API_URL||!s.e.SESSION_PATH)return;const d=ai(s.e.API_URL+s.e.SESSION_PATH);d.params.push(`sku=${t||""}`),d.params.push(`access_token=${c||s.e.ACCESS_TOKEN||""}`);const p={url:wi(d),headers:{"Content-Type":"text/plain"}};this.pendingRequest=s.g(p,_=>{this.pendingRequest=null,n(_),this.saveEventData(),this.processRequests(c)})}getSessionAPI(l,t,n,c){this.skuToken=t,this.errorCb=c,s.e.SESSION_PATH&&s.e.API_URL&&(n||s.e.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},n):this.errorCb(new Error(ki)))}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:n}=this.queue.shift();t&&this.success[t]||this.getSession(n,this.skuToken,c=>{c?this.errorCb(c):t&&(this.success[t]=!0)},l)}remove(){this.errorCb=null}},Se=ga.getSessionAPI.bind(ga),ya=new Set;function xa(l,t){t?ya.add(l):ya.delete(l)}class ko{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages=new Set}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(t,n){this._updatedSourceCaches[t]=n,this.setDirty()}discardSourceCacheUpdate(t){delete this._updatedSourceCaches[t]}updateLayer(t){const n=t.scope;this._updatedLayers[n]=this._updatedLayers[n]||new Set,this._updatedLayers[n].add(t.id),this.setDirty()}removeLayer(t){const n=t.scope;this._removedLayers[n]=this._removedLayers[n]||{},this._updatedLayers[n]=this._updatedLayers[n]||new Set,this._removedLayers[n][t.id]=t,this._updatedLayers[n].delete(t.id),this._updatedPaintProps.delete(t.fqid),this.setDirty()}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){const t={};for(const n in this._updatedLayers)t[n]=t[n]||{},t[n].updatedIds=Array.from(this._updatedLayers[n].values());for(const n in this._removedLayers)t[n]=t[n]||{},t[n].removedIds=Object.keys(this._removedLayers[n]);return t}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(t){this._updatedPaintProps.add(t.fqid),this.setDirty()}getUpdatedImages(){return Array.from(this._updatedImages.values())}updateImage(t){this._updatedImages.add(t),this.setDirty()}resetUpdatedImages(){this._updatedImages.clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages.clear()}}function ft(l){const{userImage:t}=l;return!!(t&&t.render&&t.render())&&(l.data.replace(new Uint8Array(t.data.buffer)),!0)}class rr extends s.E{constructor(t){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.atlasImage={},this.atlasTexture={},this.dirty=!0,this.spriteFormat=t,t!=="raster"&&s.t()&&(this.imageRasterizerDispatcher=new s.D(s.x(),this,"Image Rasterizer Worker",1))}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new s.I),this._imageRasterizer}createScope(t){this.images[t]={},this.loaded[t]=!1,this.updatedImages[t]={},this.patterns[t]={},this.callbackDispatchedThisFrame[t]={},this.atlasImage[t]=new s.r({width:1,height:1})}isLoaded(){for(const t in this.loaded)if(!this.loaded[t])return!1;return!0}setLoaded(t,n){if(this.loaded[n]!==t&&(this.loaded[n]=t,t)){for(const{ids:c,callback:d}of this.requestors)this._notify(c,n,d);this.requestors=[]}}hasImage(t,n){return!!this.getImage(t,n)}getImage(t,n){return this.images[n][t]}addImage(t,n,c){this._validate(t,c)&&(this.images[n][t]=c)}_validate(t,n){let c=!0;return this._validateStretch(n.stretchX,n.data&&n.data.width)||(this.fire(new s.y(new Error(`Image "${t}" has invalid "stretchX" value`))),c=!1),this._validateStretch(n.stretchY,n.data&&n.data.height)||(this.fire(new s.y(new Error(`Image "${t}" has invalid "stretchY" value`))),c=!1),this._validateContent(n.content,n)||(this.fire(new s.y(new Error(`Image "${t}" has invalid "content" value`))),c=!1),c}_validateStretch(t,n){if(!t)return!0;let c=0;for(const d of t){if(d[0]<c||d[1]<d[0]||n<d[1])return!1;c=d[1]}return!0}_validateContent(t,n){return t?t.length!==4||!n.usvg&&(t[0]<0||n.data.width<t[0]||t[1]<0||n.data.height<t[1]||t[2]<0||n.data.width<t[2]||t[3]<0||n.data.height<t[3])?!1:!(t[2]<t[0]||t[3]<t[1]):!0}updateImage(t,n,c){c.version=this.images[n][t].version+1,this.images[n][t]=c,this.updatedImages[n][t]=!0,this.removeFromImageRasterizerCache(t,n)}removeFromImageRasterizerCache(t,n){this.spriteFormat!=="raster"&&(s.t()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[t],scope:n}):this.imageRasterizer.removeImagesFromCacheByIds([t],n))}removeImage(t,n){const c=this.images[n][t];delete this.images[n][t],delete this.patterns[n][t],this.removeFromImageRasterizerCache(t,n),c.userImage&&c.userImage.onRemove&&c.userImage.onRemove()}listImages(t){return Object.keys(this.images[t])}getImages(t,n,c){let d=!0;const p=!!this.loaded[n];if(!p)for(const _ of t)this.images[n][_]||(d=!1);p||d?this._notify(t,n,c):this.requestors.push({ids:t,scope:n,callback:c})}rasterizeImages({scope:t,imageTasks:n},c){const d={};for(const p in n){const _=n[p],b=this.getImage(_.id,t);b&&(d[p]={image:b,imageIdWithOptions:_})}s.t()?this.imageRasterizerDispatcher.getActor().send("rasterizeImages",{imageTasks:d,scope:t},c):this.rasterizeImagesInMainThread({imageTasks:d,scope:t},c)}rasterizeImagesInMainThread(t,n){const{imageTasks:c,scope:d}=t,p={};for(const _ in c){const{image:b,imageIdWithOptions:E}=c[_];p[_]=this.imageRasterizer.rasterize(E,b,d,"")}n(void 0,p)}getUpdatedImages(t){return this.updatedImages[t]}_notify(t,n,c){const d={};for(const p of t){this.images[n][p]||this.fire(new s.z("styleimagemissing",{id:p}));const _=this.images[n][p];_?d[p]={data:_.usvg?null:_.data.clone(),pixelRatio:_.pixelRatio,sdf:_.sdf,usvg:_.usvg,version:_.version,stretchX:_.stretchX,stretchY:_.stretchY,content:_.content,hasRenderCallback:!!(_.userImage&&_.userImage.render)}:s.w(`Image "${p}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}c(null,d)}getPixelSize(t){const{width:n,height:c}=this.atlasImage[t];return{width:n,height:c}}getPattern(t,n,c){const d=this.patterns[n][t],p=this.getImage(t,n);if(!p)return null;if(d&&d.position.version===p.version)return d.position;if(d)d.position.version=p.version;else{p.usvg&&!p.data&&(p.data=this.imageRasterizer.rasterize(s.A.from(t).getPrimary(),p,n,""));const _={w:p.data.width+2*s.B,h:p.data.height+2*s.B,x:0,y:0},b=new s.C(_,p,s.B);this.patterns[n][t]={bin:_,position:b}}return this._updatePatternAtlas(n,c),this.patterns[n][t].position}bind(t,n){const c=t.gl;let d=this.atlasTexture[n];d?this.dirty&&(d.update(this.atlasImage[n]),this.dirty=!1):(d=new s.T(t,this.atlasImage[n],c.RGBA8),this.atlasTexture[n]=d),d.bind(c.LINEAR,c.CLAMP_TO_EDGE)}_updatePatternAtlas(t,n){const c=[];for(const b in this.patterns[t])c.push(this.patterns[t][b].bin);const{w:d,h:p}=s.F(c),_=this.atlasImage[t];_.resize({width:d||1,height:p||1});for(const b in this.patterns[t]){const{bin:E,position:I}=this.patterns[t][b];let A=I.padding;const R=E.x+A,D=E.y+A,F=this.images[t][b].data,q=F.width,U=F.height;A=A>1?A-1:A,s.r.copy(F,_,{x:0,y:0},{x:R,y:D},{width:q,height:U},n),s.r.copy(F,_,{x:0,y:U-A},{x:R,y:D-A},{width:q,height:A},n),s.r.copy(F,_,{x:0,y:0},{x:R,y:D+U},{width:q,height:A},n),s.r.copy(F,_,{x:q-A,y:0},{x:R-A,y:D},{width:A,height:U},n),s.r.copy(F,_,{x:0,y:0},{x:R+q,y:D},{width:A,height:U},n),s.r.copy(F,_,{x:q-A,y:U-A},{x:R-A,y:D-A},{width:A,height:A},n),s.r.copy(F,_,{x:0,y:U-A},{x:R+q,y:D-A},{width:A,height:A},n),s.r.copy(F,_,{x:0,y:0},{x:R+q,y:D+U},{width:A,height:A},n),s.r.copy(F,_,{x:q-A,y:0},{x:R-A,y:D+U},{width:A,height:A},n)}this.dirty=!0}beginFrame(){for(const t in this.images)this.callbackDispatchedThisFrame[t]={}}dispatchRenderCallbacks(t,n){for(const c of t){if(this.callbackDispatchedThisFrame[n][c])continue;this.callbackDispatchedThisFrame[n][c]=!0;const d=this.images[n][c];ft(d)&&this.updateImage(c,n,d)}}}function hr(l){const t=l.key,n=l.value,c=l.valueSpec||{},d=l.objectElementValidators||{},p=l.style,_=l.styleSpec;let b=[];const E=s.H(n);if(E!=="object")return[new s.V(t,n,`object expected, ${E} found`)];for(const I in n){const A=I.split(".")[0];let R;d[A]?R=d[A]:c[A]?R=ti:d["*"]?R=d["*"]:c["*"]&&(R=ti),R?b=b.concat(R({key:(t&&`${t}.`)+I,value:n[I],valueSpec:c[A]||c["*"],style:p,styleSpec:_,object:n,objectKey:I},n)):b.push(new s.G(t,n[I],`unknown property "${I}"`))}for(const I in c)d[I]||c[I].required&&c[I].default===void 0&&n[I]===void 0&&b.push(new s.V(t,n,`missing required property "${I}"`));return b}function va(l){const t=l.value,n=l.valueSpec,c=l.style,d=l.styleSpec,p=l.key,_=l.arrayElementValidator||ti;if(s.H(t)!=="array")return[new s.V(p,t,`array expected, ${s.H(t)} found`)];if(n.length&&t.length!==n.length)return[new s.V(p,t,`array length ${n.length} expected, length ${t.length} found`)];if(n["min-length"]&&t.length<n["min-length"])return[new s.V(p,t,`array length at least ${n["min-length"]} expected, length ${t.length} found`)];let b={type:n.value,values:n.values,minimum:n.minimum,maximum:n.maximum,function:void 0};d.$version<7&&(b.function=n.function),s.H(n.value)==="object"&&(b=n.value);let E=[];for(let I=0;I<t.length;I++)E=E.concat(_({array:t,arrayIndex:I,value:t[I],valueSpec:b,style:c,styleSpec:d,key:`${p}[${I}]`},!0));return E}function pi(l){const t=l.key,n=l.value,c=l.valueSpec;let d=s.H(n);if(d==="number"&&n!=n&&(d="NaN"),d!=="number")return[new s.V(t,n,`number expected, ${d} found`)];if("minimum"in c){let p=c.minimum;if(s.H(c.minimum)==="array"&&(p=c.minimum[l.arrayIndex]),n<p)return[new s.V(t,n,`${n} is less than the minimum value ${p}`)]}if("maximum"in c){let p=c.maximum;if(s.H(c.maximum)==="array"&&(p=c.maximum[l.arrayIndex]),n>p)return[new s.V(t,n,`${n} is greater than the maximum value ${p}`)]}return[]}function Nn(l){const t=l.valueSpec,n=s.K(l.value.type);let c,d,p,_={};const b=n!=="categorical"&&l.value.property===void 0,E=!b,I=s.H(l.value.stops)==="array"&&s.H(l.value.stops[0])==="array"&&s.H(l.value.stops[0][0])==="object",A=hr({key:l.key,value:l.value,valueSpec:l.styleSpec.function,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{stops:function(F){if(n==="identity")return[new s.V(F.key,F.value,'identity function may not have a "stops" property')];let q=[];const U=F.value;return q=q.concat(va({key:F.key,value:U,valueSpec:F.valueSpec,style:F.style,styleSpec:F.styleSpec,arrayElementValidator:R})),s.H(U)==="array"&&U.length===0&&q.push(new s.V(F.key,U,"array must have at least one stop")),q},default:function(F){return ti({key:F.key,value:F.value,valueSpec:t,style:F.style,styleSpec:F.styleSpec})}}});return n==="identity"&&b&&A.push(new s.V(l.key,l.value,'missing required property "property"')),n==="identity"||l.value.stops||A.push(new s.V(l.key,l.value,'missing required property "stops"')),n==="exponential"&&l.valueSpec.expression&&!s.L(l.valueSpec)&&A.push(new s.V(l.key,l.value,"exponential functions not supported")),l.styleSpec.$version>=8&&(E&&!s.M(l.valueSpec)?A.push(new s.V(l.key,l.value,"property functions not supported")):b&&!s.N(l.valueSpec)&&A.push(new s.V(l.key,l.value,"zoom functions not supported"))),n!=="categorical"&&!I||l.value.property!==void 0||A.push(new s.V(l.key,l.value,'"property" property is required')),A;function R(F){let q=[];const U=F.value,H=F.key;if(s.H(U)!=="array")return[new s.V(H,U,`array expected, ${s.H(U)} found`)];if(U.length!==2)return[new s.V(H,U,`array length 2 expected, length ${U.length} found`)];if(I){if(s.H(U[0])!=="object")return[new s.V(H,U,`object expected, ${s.H(U[0])} found`)];if(U[0].zoom===void 0)return[new s.V(H,U,"object stop key must have zoom")];if(U[0].value===void 0)return[new s.V(H,U,"object stop key must have value")];const Z=s.K(U[0].zoom);if(typeof Z!="number")return[new s.V(H,U[0].zoom,"stop zoom values must be numbers")];if(p&&p>Z)return[new s.V(H,U[0].zoom,"stop zoom values must appear in ascending order")];Z!==p&&(p=Z,d=void 0,_={}),q=q.concat(hr({key:`${H}[0]`,value:U[0],valueSpec:{zoom:{}},style:F.style,styleSpec:F.styleSpec,objectElementValidators:{zoom:pi,value:D}}))}else q=q.concat(D({key:`${H}[0]`,value:U[0],valueSpec:{},style:F.style,styleSpec:F.styleSpec},U));return s.O(s.Q(U[1]))?q.concat([new s.V(`${H}[1]`,U[1],"expressions are not allowed in function stops.")]):q.concat(ti({key:`${H}[1]`,value:U[1],valueSpec:t,style:F.style,styleSpec:F.styleSpec}))}function D(F,q){const U=s.H(F.value),H=s.K(F.value),Z=F.value!==null?F.value:q;if(c){if(U!==c)return[new s.V(F.key,Z,`${U} stop domain type must match previous stop domain type ${c}`)]}else c=U;if(U!=="number"&&U!=="string"&&U!=="boolean"&&typeof H!="number"&&typeof H!="string"&&typeof H!="boolean")return[new s.V(F.key,Z,"stop domain value must be a number, string, or boolean")];if(U!=="number"&&n!=="categorical"){let J=`number expected, ${U} found`;return s.M(t)&&n===void 0&&(J+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new s.V(F.key,Z,J)]}return n!=="categorical"||U!=="number"||typeof H=="number"&&isFinite(H)&&Math.floor(H)===H?n!=="categorical"&&U==="number"&&typeof H=="number"&&typeof d=="number"&&d!==void 0&&H<d?[new s.V(F.key,Z,"stop domain values must appear in ascending order")]:(d=H,n==="categorical"&&H in _?[new s.V(F.key,Z,"stop domain values must be unique")]:(_[H]=!0,[])):[new s.V(F.key,Z,`integer expected, found ${String(H)}`)]}}function Br(l){const t=(l.expressionContext==="property"?s.S:s.U)(s.Q(l.value),l.valueSpec);if(t.result==="error")return t.value.map(c=>new s.V(`${l.key}${c.key}`,l.value,c.message));const n=t.value.expression||t.value._styleExpression.expression;if(l.expressionContext==="property"&&l.propertyKey==="text-font"&&!n.outputDefined())return[new s.V(l.key,l.value,`Invalid data expression for "${l.propertyKey}". Output values must be contained as literals within the expression.`)];if(l.expressionContext==="property"&&l.propertyType==="layout"&&!s.W(n))return[new s.V(l.key,l.value,'"feature-state" data expressions are not supported with layout properties.')];if(l.expressionContext==="filter")return ao(n,l);if(l.expressionContext&&l.expressionContext.indexOf("cluster")===0){if(!s.X(n,["zoom","feature-state"]))return[new s.V(l.key,l.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(l.expressionContext==="cluster-initial"&&!s.Y(n))return[new s.V(l.key,l.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function ao(l,t){const n=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(const d of t.valueSpec.expression.parameters)n.delete(d);if(n.size===0)return[];const c=[];return l instanceof s.Z&&n.has(l.name)?[new s.V(t.key,t.value,`["${l.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(l.eachChild(d=>{c.push(...ao(d,t))}),c)}function Oo(l){const t=l.key,n=l.value,c=l.valueSpec,d=[];return Array.isArray(c.values)?c.values.indexOf(s.K(n))===-1&&d.push(new s.V(t,n,`expected one of [${c.values.join(", ")}], ${JSON.stringify(n)} found`)):Object.keys(c.values).indexOf(s.K(n))===-1&&d.push(new s.V(t,n,`expected one of [${Object.keys(c.values).join(", ")}], ${JSON.stringify(n)} found`)),d}function Fo(l){return s.$(s.Q(l.value))?Br(s.J({},l,{expressionContext:"filter",valueSpec:l.styleSpec[`filter_${l.layerType||"fill"}`]})):ri(l)}function ri(l){const t=l.value,n=l.key;if(s.H(t)!=="array")return[new s.V(n,t,`array expected, ${s.H(t)} found`)];const c=l.styleSpec;let d,p=[];if(t.length<1)return[new s.V(n,t,"filter array must have at least 1 element")];switch(p=p.concat(Oo({key:`${n}[0]`,value:t[0],valueSpec:c.filter_operator,style:l.style,styleSpec:l.styleSpec})),s.K(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&s.K(t[1])==="$type"&&p.push(new s.V(n,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":t.length!==3&&p.push(new s.V(n,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(d=s.H(t[1]),d!=="string"&&p.push(new s.V(`${n}[1]`,t[1],`string expected, ${d} found`)));for(let _=2;_<t.length;_++)d=s.H(t[_]),s.K(t[1])==="$type"?p=p.concat(Oo({key:`${n}[${_}]`,value:t[_],valueSpec:c.geometry_type,style:l.style,styleSpec:l.styleSpec})):d!=="string"&&d!=="number"&&d!=="boolean"&&p.push(new s.V(`${n}[${_}]`,t[_],`string, number, or boolean expected, ${d} found`));break;case"any":case"all":case"none":for(let _=1;_<t.length;_++)p=p.concat(ri({key:`${n}[${_}]`,value:t[_],style:l.style,styleSpec:l.styleSpec}));break;case"has":case"!has":d=s.H(t[1]),t.length!==2?p.push(new s.V(n,t,`filter array for "${t[0]}" operator must have 2 elements`)):d!=="string"&&p.push(new s.V(`${n}[1]`,t[1],`string expected, ${d} found`))}return p}function us(l,t){const n=l.key,c=l.style,d=l.layer,p=l.styleSpec,_=l.value,b=l.objectKey,E=p[`${t}_${l.layerType}`];if(!E)return[];const I=b.match(/^(.*)-use-theme$/);if(t==="paint"&&I&&E[I[1]])return s.O(_)?[].concat(ti({key:l.key,value:_,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:c,styleSpec:p,expressionContext:"property",propertyType:t,propertyKey:b})):ti({key:n,value:_,valueSpec:{type:"string"},style:c,styleSpec:p});const A=b.match(/^(.*)-transition$/);if(t==="paint"&&A&&E[A[1]]&&E[A[1]].transition)return ti({key:n,value:_,valueSpec:p.transition,style:c,styleSpec:p});const R=l.valueSpec||E[b];if(!R)return[new s.G(n,_,`unknown property "${b}"`)];let D;if(s.H(_)==="string"&&s.M(R)&&!R.tokens&&(D=/^{([^}]+)}$/.exec(_))){const q=`\`{ "type": "identity", "property": ${D?JSON.stringify(D[1]):'"_"'} }\``;return[new s.V(n,_,`"${b}" does not support interpolation syntax
Use an identity property function instead: ${q}.`)]}const F=[];if(l.layerType==="symbol")b!=="text-field"||!c||c.glyphs||c.imports||F.push(new s.V(n,_,'use of "text-field" requires a style "glyphs" property')),b==="text-font"&&s.a0(s.Q(_))&&s.K(_.type)==="identity"&&F.push(new s.V(n,_,'"text-font" does not support identity functions'));else if(l.layerType==="model"&&t==="paint"&&d&&d.layout&&d.layout.hasOwnProperty("model-id")&&s.M(R)&&(s.a1(R)||s.N(R))){const q=s.S(s.Q(_),R),U=q.value.expression||q.value._styleExpression.expression;U&&!s.X(U,["measure-light"])&&(b==="model-emissive-strength"&&s.Y(U)&&s.W(U)||F.push(new s.V(n,_,`${b} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return F.concat(ti({key:l.key,value:_,valueSpec:R,style:c,styleSpec:p,expressionContext:"property",propertyType:t,propertyKey:b}))}function Xr(l){return us(l,"paint")}function lo(l){return us(l,"layout")}function sr(l){let t=[];const n=l.value,c=l.key,d=l.style,p=l.styleSpec;n.type||n.ref||t.push(new s.V(c,n,'either "type" or "ref" is required'));let _=s.K(n.type);const b=s.K(n.ref);if(n.id){const E=s.K(n.id);for(let I=0;I<l.arrayIndex;I++){const A=d.layers[I];s.K(A.id)===E&&t.push(new s.V(c,n.id,`duplicate layer id "${n.id}", previously used at line ${A.id.__line__}`))}}if("ref"in n){let E;["type","source","source-layer","filter","layout"].forEach(I=>{I in n&&t.push(new s.V(c,n[I],`"${I}" is prohibited for ref layers`))}),d.layers.forEach(I=>{s.K(I.id)===b&&(E=I)}),E?E.ref?t.push(new s.V(c,n.ref,"ref cannot reference another ref layer")):_=s.K(E.type):typeof b=="string"&&t.push(new s.V(c,n.ref,`ref layer "${b}" not found`))}else if(_!=="background"&&_!=="sky"&&_!=="slot")if(n.source){const E=d.sources&&d.sources[n.source],I=E&&s.K(E.type);E?I==="vector"&&_==="raster"?t.push(new s.V(c,n.source,`layer "${n.id}" requires a raster source`)):I==="raster"&&_!=="raster"?t.push(new s.V(c,n.source,`layer "${n.id}" requires a vector source`)):I!=="vector"||n["source-layer"]?I==="raster-dem"&&_!=="hillshade"?t.push(new s.V(c,n.source,"raster-dem source can only be used with layer type 'hillshade'.")):I!=="raster-array"||["raster","raster-particle"].includes(_)?_!=="line"||!n.paint||!n.paint["line-gradient"]&&!n.paint["line-trim-offset"]||I==="geojson"&&E.lineMetrics?_==="raster-particle"&&I!=="raster-array"&&t.push(new s.V(c,n.source,`layer "${n.id}" requires a 'raster-array' source.`)):t.push(new s.V(c,n,`layer "${n.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):t.push(new s.V(c,n.source,"raster-array source can only be used with layer type 'raster'.")):t.push(new s.V(c,n,`layer "${n.id}" must specify a "source-layer"`)):t.push(new s.V(c,n.source,`source "${n.source}" not found`))}else t.push(new s.V(c,n,'missing required property "source"'));return t=t.concat(hr({key:c,value:n,valueSpec:p.layer,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{"*":()=>[],type:()=>ti({key:`${c}.type`,value:n.type,valueSpec:p.layer.type,style:l.style,styleSpec:l.styleSpec,object:n,objectKey:"type"}),filter:E=>Fo(s.J({layerType:_},E)),layout:E=>hr({layer:n,key:E.key,value:E.value,valueSpec:{},style:E.style,styleSpec:E.styleSpec,objectElementValidators:{"*":I=>lo(s.J({layerType:_},I))}}),paint:E=>hr({layer:n,key:E.key,value:E.value,valueSpec:{},style:E.style,styleSpec:E.styleSpec,objectElementValidators:{"*":I=>Xr(s.J({layerType:_,layer:n},I))}})}})),t}function Vs(l){const t=l.value,n=l.key,c=s.H(t);return c!=="string"?[new s.V(n,t,`string expected, ${c} found`)]:[]}const Bo={promoteId:function l({key:t,value:n}){if(s.H(n)==="string")return Vs({key:t,value:n});if(Array.isArray(n)){const c=[],d=s.Q(n),p=s.U(d);return p.result==="error"&&p.value.forEach(_=>{c.push(new s.V(`${t}${_.key}`,null,`${_.message}`))}),s.X(p.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||c.push(new s.V(`${t}`,null,"promoteId expression should be only feature dependent")),c}{const c=[];for(const d in n)c.push(...l({key:`${t}.${d}`,value:n[d]}));return c}}};function ba(l){const t=l.value,n=l.key,c=l.styleSpec,d=l.style;if(!t.type)return[new s.V(n,t,'"type" is required')];const p=s.K(t.type);let _=[];switch(["vector","raster","raster-dem","raster-array"].includes(p)&&(t.url||t.tiles||_.push(new s.G(n,t,'Either "url" or "tiles" is required.'))),p){case"vector":case"raster":case"raster-dem":case"raster-array":return _=_.concat(hr({key:n,value:t,valueSpec:c[`source_${p.replace("-","_")}`],style:l.style,styleSpec:c,objectElementValidators:Bo})),_;case"geojson":if(_=hr({key:n,value:t,valueSpec:c.source_geojson,style:d,styleSpec:c,objectElementValidators:Bo}),t.cluster)for(const b in t.clusterProperties){const[E,I]=t.clusterProperties[b],A=typeof E=="string"?[E,["accumulated"],["get",b]]:E;_.push(...Br({key:`${n}.${b}.map`,value:I,expressionContext:"cluster-map"})),_.push(...Br({key:`${n}.${b}.reduce`,value:A,expressionContext:"cluster-reduce"}))}return _;case"video":return hr({key:n,value:t,valueSpec:c.source_video,style:d,styleSpec:c});case"image":return hr({key:n,value:t,valueSpec:c.source_image,style:d,styleSpec:c});case"canvas":return[new s.V(n,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Oo({key:`${n}.type`,value:t.type,valueSpec:{values:wa(c)},style:d,styleSpec:c})}}function wa(l){return l.source.reduce((t,n)=>{const c=l[n];return c.type.type==="enum"&&(t=t.concat(Object.keys(c.type.values))),t},[])}function dr(l){const t=l.value,n=l.styleSpec,c=n.light,d=l.style;let p=[];const _=s.H(t);if(t===void 0)return p;if(_!=="object")return p=p.concat([new s.V("light",t,`object expected, ${_} found`)]),p;for(const b in t){const E=b.match(/^(.*)-transition$/),I=b.match(/^(.*)-use-theme$/);p=p.concat(I&&c[I[1]]?ti({key:b,value:t[b],valueSpec:{type:"string"},style:d,styleSpec:n}):E&&c[E[1]]&&c[E[1]].transition?ti({key:b,value:t[b],valueSpec:n.transition,style:d,styleSpec:n}):c[b]?ti({key:b,value:t[b],valueSpec:c[b],style:d,styleSpec:n}):[new s.V(b,t[b],`unknown property "${b}"`)])}return p}function Ta(l){const t=l.value;let n=[];if(!t)return n;const c=s.H(t);if(c!=="object")return n=n.concat([new s.V("light-3d",t,`object expected, ${c} found`)]),n;const d=l.styleSpec,p=d["light-3d"],_=l.key,b=l.style,E=l.style.lights;for(const R of["type","id"])if(!(R in t))return n=n.concat([new s.V("light-3d",t,`missing property ${R} on light`)]),n;if(t.type&&E)for(let R=0;R<l.arrayIndex;R++){const D=s.K(t.type),F=E[R];s.K(F.type)===D&&n.push(new s.V(_,t.id,`duplicate light type "${t.type}", previously defined at line ${F.id.__line__}`))}const I=`properties_light_${t.type}`;if(!(I in d))return n=n.concat([new s.V("light-3d",t,`Invalid light type ${t.type}`)]),n;const A=d[I];for(const R in t)if(R==="properties"){const D=t[R],F=s.H(D);if(F!=="object")return n=n.concat([new s.V("properties",D,`object expected, ${F} found`)]),n;for(const q in D)n=n.concat(A[q]?ti({key:q,value:D[q],valueSpec:A[q],style:b,styleSpec:d}):[new s.G(l.key,D[q],`unknown property "${q}"`)])}else{const D=R.match(/^(.*)-transition$/),F=R.match(/^(.*)-use-theme$/);n=n.concat(F&&p[F[1]]?ti({key:R,value:t[R],valueSpec:{type:"string"},style:b,styleSpec:d}):D&&p[D[1]]&&p[D[1]].transition?ti({key:R,value:t[R],valueSpec:d.transition,style:b,styleSpec:d}):p[R]?ti({key:R,value:t[R],valueSpec:p[R],style:b,styleSpec:d}):[new s.G(R,t[R],`unknown property "${R}"`)])}return n}function Sa(l){const t=l.value,n=l.key,c=l.style,d=l.styleSpec,p=d.terrain;let _=[];const b=s.H(t);if(t===void 0||b==="null")return _;if(b!=="object")return _=_.concat([new s.V("terrain",t,`object expected, ${b} found`)]),_;for(const E in t){const I=E.match(/^(.*)-transition$/),A=E.match(/^(.*)-use-theme$/);_=_.concat(A&&p[A[1]]?ti({key:E,value:t[E],valueSpec:{type:"string"},style:c,styleSpec:d}):I&&p[I[1]]&&p[I[1]].transition?ti({key:E,value:t[E],valueSpec:d.transition,style:c,styleSpec:d}):p[E]?ti({key:E,value:t[E],valueSpec:p[E],style:c,styleSpec:d}):[new s.G(E,t[E],`unknown property "${E}"`)])}if(t.source){const E=c.sources&&c.sources[t.source],I=E&&s.K(E.type);E?I!=="raster-dem"&&_.push(new s.V(n,t.source,`terrain cannot be used with a source of type ${String(I)}, it only be used with a "raster-dem" source type`)):_.push(new s.V(n,t.source,`source "${t.source}" not found`))}else _.push(new s.V(n,t,'terrain is missing required property "source"'));return _}function Mr(l){const t=l.value,n=l.style,c=l.styleSpec,d=c.fog;let p=[];const _=s.H(t);if(t===void 0)return p;if(_!=="object")return p=p.concat([new s.V("fog",t,`object expected, ${_} found`)]),p;for(const b in t){const E=b.match(/^(.*)-transition$/),I=b.match(/^(.*)-use-theme$/);p=p.concat(I&&d[I[1]]?ti({key:b,value:t[b],valueSpec:{type:"string"},style:n,styleSpec:c}):E&&d[E[1]]&&d[E[1]].transition?ti({key:b,value:t[b],valueSpec:c.transition,style:n,styleSpec:c}):d[b]?ti({key:b,value:t[b],valueSpec:d[b],style:n,styleSpec:c}):[new s.G(b,t[b],`unknown property "${b}"`)])}return p}const No={"*":()=>[],array:va,boolean:function(l){const t=l.value,n=l.key,c=s.H(t);return c!=="boolean"?[new s.V(n,t,`boolean expected, ${c} found`)]:[]},number:pi,color:function(l){const t=l.key,n=l.value,c=s.H(n);return c!=="string"?[new s.V(t,n,`color expected, ${c} found`)]:s._.parseCSSColor(n)===null?[new s.V(t,n,`color expected, "${n}" found`)]:[]},enum:Oo,filter:Fo,function:Nn,layer:sr,object:hr,source:ba,model:s.a2,light:dr,"light-3d":Ta,terrain:Sa,fog:Mr,string:Vs,formatted:function(l){return Vs(l).length===0?[]:Br(l)},resolvedImage:function(l){return Vs(l).length===0?[]:Br(l)},projection:function(l){const t=l.value,n=l.styleSpec,c=n.projection,d=l.style;let p=[];const _=s.H(t);if(_==="object")for(const b in t)p=p.concat(ti({key:b,value:t[b],valueSpec:c[b],style:d,styleSpec:n}));else _!=="string"&&(p=p.concat([new s.V("projection",t,`object or string expected, ${_} found`)]));return p},import:function(l){const{value:t,styleSpec:n}=l,{data:c,...d}=t;Object.defineProperty(d,"__line__",{value:t.__line__,enumerable:!1});let p=hr(s.J({},l,{value:d,valueSpec:n.import}));return s.K(d.id)===""&&p.push(new s.V(`${l.key}.id`,d,"import id can't be an empty string")),c&&(p=p.concat(Pc(c,n,{key:`${l.key}.data`}))),p}};function ti(l,t=!1){const n=l.value,c=l.valueSpec,d=l.styleSpec;if(c.expression&&s.a0(s.K(n)))return Nn(l);if(c.expression&&s.O(s.Q(n)))return Br(l);if(c.type&&No[c.type]){const p=No[c.type](l);return t===!0&&p.length>0&&s.H(l.value)==="array"?Br(l):p}return hr(s.J({},l,{valueSpec:c.type?d[c.type]:c}))}function hs(l){const t=l.value,n=l.key,c=Vs(l);return c.length||(t.indexOf("{fontstack}")===-1&&c.push(new s.V(n,t,'"glyphs" url must include a "{fontstack}" token')),t.indexOf("{range}")===-1&&c.push(new s.V(n,t,'"glyphs" url must include a "{range}" token'))),c}function Pc(l,t=s.a3,n={}){return ti({key:n.key||"",value:l,valueSpec:t.$root,styleSpec:t,style:l,objectElementValidators:{glyphs:hs,"*":()=>[]}})}function xr(l,t=s.a3){return $n(Pc(l,t))}const Us=l=>$n(ba(l)),Ea=l=>$n(dr(l)),Ma=l=>$n(Ta(l)),Ia=l=>$n(Sa(l)),zc=l=>$n(Mr(l)),Aa=l=>$n(function(t){const n=t.value,c=t.style,d=t.styleSpec,p=d.snow;let _=[];const b=s.H(n);if(n===void 0)return _;if(b!=="object")return _=_.concat([new s.V("snow",n,`object expected, ${b} found`)]),_;for(const E in n){const I=E.match(/^(.*)-transition$/);_=_.concat(I&&p[I[1]]&&p[I[1]].transition?ti({key:E,value:n[E],valueSpec:d.transition,style:c,styleSpec:d}):p[E]?ti({key:E,value:n[E],valueSpec:p[E],style:c,styleSpec:d}):[new s.G(E,n[E],`unknown property "${E}"`)])}return _}(l)),Rc=l=>$n(function(t){const n=t.value,c=t.style,d=t.styleSpec,p=d.rain;let _=[];const b=s.H(n);if(n===void 0)return _;if(b!=="object")return _=_.concat([new s.V("rain",n,`object expected, ${b} found`)]),_;for(const E in n){const I=E.match(/^(.*)-transition$/);_=_.concat(I&&p[I[1]]&&p[I[1]].transition?ti({key:E,value:n[E],valueSpec:d.transition,style:c,styleSpec:d}):p[E]?ti({key:E,value:n[E],valueSpec:p[E],style:c,styleSpec:d}):[new s.G(E,n[E],`unknown property "${E}"`)])}return _}(l)),Dc=l=>$n(sr(l)),Mn=l=>$n(Fo(l)),fl=l=>$n(Xr(l)),Lc=l=>$n(lo(l)),pl=l=>$n(s.a2(l));function $n(l){return l.slice().sort((t,n)=>t.line&&n.line?t.line-n.line:0)}function ds(l,t){let n=!1;if(t&&t.length)for(const c of t)c instanceof s.G?s.w(c.message):(l.fire(new s.y(new Error(c.message))),n=!0);return n}let Ne;class G extends s.E{constructor(t,n="flat"){super(),this._transitionable=new s.a4(Ne||(Ne=new s.a5({anchor:new s.a6(s.a3.light.anchor),position:new s.a7(s.a3.light.position),color:new s.a6(s.a3.light.color),intensity:new s.a6(s.a3.light.intensity)}))),this.setLight(t,n),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,n,c={}){this._validate(Ea,t,c)||(this._transitionable.setTransitionOrValue(t),this.id=n)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,n,c){return(!c||c.validate!==!1)&&ds(this,t.call(xr,s.l({value:n,style:{glyphs:!0,sprite:!0},styleSpec:s.a3})))}}let X=class extends s.E{constructor(l,t,n,c){super(),this.scope=n,this._transitionable=new s.a4(new s.a5({source:new s.a6(s.a3.terrain.source),exaggeration:new s.a6(s.a3.terrain.exaggeration)}),n,c),this._transitionable.setTransitionOrValue(l,c),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t}get(){return this._transitionable.serialize()}set(l,t){this._transitionable.setTransitionOrValue(l,t)}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}getExaggeration(l){return this._transitioning.possiblyEvaluate(new s.a8(l)).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const l=this._transitionable._values.exaggeration;if(!l)return null;const t=l.value.expression;if(!t)return null;let n=-1,c=-1,d=1;for(const p of t.zoomStops)d=t.evaluate(new s.a8(p)),d>.01?(n=p,c=-1):c=p;return d<.01&&n>0&&c>n?[n,c]:null}isZoomDependent(){const l=this._transitionable._values.exaggeration;return l!=null&&l.value!=null&&l.value.expression!=null&&l.value.expression instanceof s.a9}};const K=45,ue=65,fe=.05;function ve(l,t,n,c){const d=s.ac(K,ue,n),[p,_]=Pe(l,c);let b=1-Math.min(1,Math.exp((t-p)/(_-p)*-6));return b*=b*b,b=Math.min(1,1.00747*b),b*d*l.alpha}function Pe(l,t){const n=.5/Math.tan(.5*t);return[l.range[0]+n,l.range[1]+n]}function be(l,t,n,c,d){const p=s.ab.vec3.transformMat4([],[t,n,c],d.mercatorFogMatrix);return ve(l,s.ab.vec3.length(p),d.pitch,d._fov)}function Fe(l,t,n,c,d,p,_){const b=[[n,c,0],[d,c,0],[d,p,0],[n,p,0]];let E=Number.MAX_VALUE,I=-Number.MAX_VALUE;for(const A of b){const R=s.ab.vec3.transformMat4([],A,t),D=s.ab.vec3.length(R);E=Math.min(E,D),I=Math.max(I,D)}return[ve(l,E,_.pitch,_._fov),ve(l,I,_.pitch,_._fov)]}class Oe extends s.E{constructor(t,n,c,d){super();const p=new s.a5({range:new s.a6(s.a3.fog.range),color:new s.a6(s.a3.fog.color),"color-use-theme":new s.a6({type:"string","property-type":"data-constant",default:"default"}),"high-color":new s.a6(s.a3.fog["high-color"]),"high-color-use-theme":new s.a6({type:"string","property-type":"data-constant",default:"default"}),"space-color":new s.a6(s.a3.fog["space-color"]),"space-color-use-theme":new s.a6({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new s.a6(s.a3.fog["horizon-blend"]),"star-intensity":new s.a6(s.a3.fog["star-intensity"]),"vertical-range":new s.a6(s.a3.fog["vertical-range"])});this._transitionable=new s.a4(p,c,new Map(d)),this.set(t,d),this._transitioning=this._transitionable.untransitioned(),this._transform=n,this.properties=new s.ad(p),this.scope=c}get state(){const t=this._transform,n=t.projection.name==="globe",c=s.ae(t.zoom),d=this.properties.get("range"),p=[.5,3];return{range:n?[s.af(p[0],d[0],c),s.af(p[1],d[1],c)]:d,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,n,c={}){if(this._validate(zc,t,c))return;const d=s.l({},t);for(const p of Object.keys(s.a3.fog))d[p]===void 0&&(d[p]=s.a3.fog[p].default);this._options=d,this._transitionable.setTransitionOrValue(this._options,n)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;const n=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:s.ac(K,ue,t))*n.a}getOpacityAtLatLng(t,n){return this._transform.projection.supportsFog?function(c,d,p){const _=s.aa.fromLngLat(d),b=p.elevation?p.elevation.getAtPointOrZero(_):0;return be(c,_.x,_.y,b,p)}(this.state,t,n):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];const n=this._transform.calculateFogTileMatrix(t.toUnwrapped());return Fe(this.state,n,0,0,s.ag,s.ag,this._transform)}getOpacityForBounds(t,n,c,d,p){return this._transform.projection.supportsFog?Fe(this.state,t,n,c,d,p,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?Pe(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;const n=[4,5,6,7];for(const c of n){const d=t.points[c];let p;if(d[2]>=0)p=d;else{const _=t.points[c-4];p=s.ah(_,d,_[2]/(_[2]-d[2]))}if(be(this.state,p[0],p[1],0,this._transform)>=fe)return!0}return!1}updateConfig(t){this._transitionable.setTransitionOrValue(this._options,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,n,c){return(!c||c.validate!==!1)&&ds(this,t.call(xr,s.l({value:n,style:{glyphs:!0,sprite:!0},styleSpec:s.a3})))}}let Be,Ke,ht,dt,Ot=class extends s.E{constructor(l,t,n,c){super();const d=Be||(Be=new s.a5({density:new s.a6(s.a3.snow.density),intensity:new s.a6(s.a3.snow.intensity),color:new s.a6(s.a3.snow.color),opacity:new s.a6(s.a3.snow.opacity),vignette:new s.a6(s.a3.snow.vignette),"vignette-color":new s.a6(s.a3.snow["vignette-color"]),"center-thinning":new s.a6(s.a3.snow["center-thinning"]),direction:new s.a6(s.a3.snow.direction),"flake-size":new s.a6(s.a3.snow["flake-size"])}));this._transitionable=new s.a4(d,n,new Map(c)),this.set(l,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new s.ad(d),this.scope=n}get state(){const l=this.properties.get("opacity"),t=this.properties.get("color"),n=this.properties.get("direction"),c=s.ai(n[0]),d=-Math.max(s.ai(n[1]),.01),p=[Math.cos(c)*Math.cos(d),Math.sin(c)*Math.cos(d),Math.sin(d)],_=this.properties.get("vignette"),b=this.properties.get("vignette-color");return b.a=_,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new s.aj(t.r,t.g,t.b,t.a*l),direction:p,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:b}}get(){return this._transitionable.serialize()}set(l,t,n={}){if(this._validate(Aa,l,n))return;const c=s.l({},l);for(const d of Object.keys(s.a3.snow))c[d]===void 0&&(c[d]=s.a3.snow[d].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(l){this._transitionable.setTransitionOrValue(this._options,new Map(l))}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,t,n){return(!n||n.validate!==!1)&&ds(this,l.call(xr,s.l({value:t,style:{glyphs:!0,sprite:!0},styleSpec:s.a3})))}},Ut=class extends s.E{constructor(l,t,n,c){super();const d=Ke||(Ke=new s.a5({density:new s.a6(s.a3.rain.density),intensity:new s.a6(s.a3.rain.intensity),color:new s.a6(s.a3.rain.color),opacity:new s.a6(s.a3.rain.opacity),vignette:new s.a6(s.a3.rain.vignette),"vignette-color":new s.a6(s.a3.rain["vignette-color"]),"center-thinning":new s.a6(s.a3.rain["center-thinning"]),direction:new s.a6(s.a3.rain.direction),"droplet-size":new s.a6(s.a3.rain["droplet-size"]),"distortion-strength":new s.a6(s.a3.rain["distortion-strength"])}));this._transitionable=new s.a4(d,n,new Map(c)),this.set(l,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new s.ad(d),this.scope=n}get state(){const l=this.properties.get("opacity"),t=this.properties.get("color"),n=this.properties.get("direction"),c=s.ai(n[0]),d=-Math.max(s.ai(n[1]),.01),p=[Math.cos(c)*Math.cos(d),Math.sin(c)*Math.cos(d),Math.sin(d)],_=this.properties.get("vignette-color");return _.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new s.aj(t.r,t.g,t.b,t.a*l),direction:p,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:_}}get(){return this._transitionable.serialize()}set(l,t,n={}){if(this._validate(Rc,l,n))return;const c=s.l({},l);for(const d of Object.keys(s.a3.rain))c[d]===void 0&&(c[d]=s.a3.rain[d].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(l){this._transitionable.setTransitionOrValue(this._options,new Map(l))}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,t,n){return(!n||n.validate!==!1)&&ds(this,l.call(xr,s.l({value:t,style:{glyphs:!0,sprite:!0},styleSpec:s.a3})))}};class jt extends s.E{constructor(t,n,c,d){super(),this.scope=c,this._options=t,this.properties=new s.ad(n),this._transitionable=new s.a4(n,c,new Map(d)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,n){this._options=t,this._transitionable.setTransitionOrValue(t.properties,n)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class Vt{constructor(t,n,c,d){this.screenBounds=t,this.cameraPoint=n,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=c,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,d)}static createFromScreenPoints(t,n){let c,d;if(t instanceof s.P||typeof t[0]=="number"){const p=s.P.convert(t);c=[p],d=n.isPointAboveHorizon(p)}else{const p=s.P.convert(t[0]),_=s.P.convert(t[1]);c=[p,_],d=s.al(p,_).every(b=>n.isPointAboveHorizon(b))}return new Vt(c,n.getCameraPoint(),d,n)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(t){return s.al(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){const n=this.screenBounds[0],c=this.screenBounds.length===1?this.screenBounds[0].add(new s.P(1,1)):this.screenBounds[1],d=s.al(n,c,0,!1);return this.cameraPoint.y>c.y&&(this.cameraPoint.x>n.x&&this.cameraPoint.x<c.x?d.splice(3,0,this.cameraPoint):this.cameraPoint.x>=c.x?d[2]=this.cameraPoint:this.cameraPoint.x<=n.x&&(d[3]=this.cameraPoint)),s.am(d,t)}bufferedCameraGeometryGlobe(t){const n=this.screenBounds[0],c=this.screenBounds.length===1?this.screenBounds[0].add(new s.P(1,1)):this.screenBounds[1],d=s.al(n,c,t),p=this.cameraPoint.clone();switch(3*((p.y>n.y)+(p.y>c.y))+((p.x>n.x)+(p.x>c.x))){case 0:d[0]=p,d[4]=p.clone();break;case 1:d.splice(1,0,p);break;case 2:d[1]=p;break;case 3:d.splice(4,0,p);break;case 5:d.splice(2,0,p);break;case 6:d[3]=p;break;case 7:d.splice(3,0,p);break;case 8:d[2]=p}return d}containsTile(t,n,c,d=0){const p=t.queryPadding/n._pixelsPerMercatorPixel+1,_=c?this._bufferedCameraMercator(p,n):this._bufferedScreenMercator(p,n);let b=t.tileID.wrap+(_.unwrapped?d:0);const E=_.polygon.map(H=>s.an(t.tileTransform,H,b));if(!s.ao(E,0,0,s.ag,s.ag))return;b=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?d:0);const I=this.screenGeometryMercator.polygon.map(H=>s.ap(t.tileTransform,H,b)),A=I.map(H=>new s.P(H[0],H[1])),R=n.getFreeCameraOptions().position||new s.aa(0,0,0),D=s.ap(t.tileTransform,R,b),F=I.map(H=>{const Z=s.ab.vec3.sub(H,H,D);return s.ab.vec3.normalize(Z,Z),new s.aq(D,Z)}),q=s.ar(t,1,n.zoom)*n._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:A,tilespaceRays:F,bufferedTilespaceGeometry:E,bufferedTilespaceBounds:(U=s.as(E),U.min.x=s.aw(U.min.x,0,s.ag),U.min.y=s.aw(U.min.y,0,s.ag),U.max.x=s.aw(U.max.x,0,s.ag),U.max.y=s.aw(U.max.y,0,s.ag),U),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:q};var U}_bufferedScreenMercator(t,n){const c=si(t);if(this._screenRaycastCache[c])return this._screenRaycastCache[c];{let d;return d=n.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(t),n):{polygon:this.bufferedScreenGeometry(t).map(p=>n.pointCoordinate3D(p)),unwrapped:!0},this._screenRaycastCache[c]=d,d}}_bufferedCameraMercator(t,n){const c=si(t);if(this._cameraRaycastCache[c])return this._cameraRaycastCache[c];{let d;return d=n.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),n):{polygon:this.bufferedCameraGeometry(t).map(p=>n.pointCoordinate3D(p)),unwrapped:!0},this._cameraRaycastCache[c]=d,d}}_projectAndResample(t,n){const c=function(p,_){const b=s.ab.mat4.multiply([],_.pixelMatrix,_.globeMatrix),E=[0,-s.ax,0,1],I=[0,s.ax,0,1],A=[0,0,0,1];s.ab.vec4.transformMat4(E,E,b),s.ab.vec4.transformMat4(I,I,b),s.ab.vec4.transformMat4(A,A,b);const R=new s.P(E[0]/E[3],E[1]/E[3]),D=new s.P(I[0]/I[3],I[1]/I[3]),F=s.au(p,R)&&E[3]<A[3],q=s.au(p,D)&&I[3]<A[3];if(!F&&!q)return null;const U=function(he,ae,ge){for(let Te=1;Te<he.length;Te++){const Ue=gi(ae.pointCoordinate3D(he[Te-1]).x),Le=gi(ae.pointCoordinate3D(he[Te]).x);if(ge<0){if(Ue<Le)return{idx:Te,t:-Ue/(Le-1-Ue)}}else if(Le<Ue)return{idx:Te,t:(1-Ue)/(Le+1-Ue)}}return null}(p,_,F?-1:1);if(!U)return null;const{idx:H,t:Z}=U;let J=H>1?di(p.slice(0,H),_):[],re=H<p.length?di(p.slice(H),_):[];J=J.map(he=>new s.P(gi(he.x),he.y)),re=re.map(he=>new s.P(gi(he.x),he.y));const ne=[...J];ne.length===0&&ne.push(re[re.length-1]);const de=s.af(ne[ne.length-1].y,(re.length===0?J[0]:re[0]).y,Z);let le;return le=F?[new s.P(0,de),new s.P(0,0),new s.P(1,0),new s.P(1,de)]:[new s.P(1,de),new s.P(1,1),new s.P(0,1),new s.P(0,de)],ne.push(...le),re.length===0?ne.push(J[0]):ne.push(...re),{polygon:ne.map(he=>new s.aa(he.x,he.y)),unwrapped:!1}}(t,n);if(c)return c;const d=function(p,_){let b=!1,E=-1/0,I=0;for(let R=0;R<p.length-1;R++)p[R].x>E&&(E=p[R].x,I=R);for(let R=0;R<p.length-1;R++){const D=(I+R)%(p.length-1),F=p[D],q=p[D+1];Math.abs(F.x-q.x)>.5&&(F.x<q.x?(F.x+=1,D===0&&(p[p.length-1].x+=1)):(q.x+=1,D+1===p.length-1&&(p[0].x+=1)),b=!0)}const A=s.at(_.center.lng);return b&&A<Math.abs(A-1)&&p.forEach(R=>{R.x-=1}),{polygon:p,unwrapped:b}}(di(t,n).map(p=>new s.P(gi(p.x),p.y)),n);return{polygon:d.polygon.map(p=>new s.aa(p.x,p.y)),unwrapped:d.unwrapped}}}function di(l,t){return s.av(l,n=>{const c=t.pointCoordinate3D(n);n.x=c.x,n.y=c.y},1/256)}function gi(l){return l<0?1+l%1:l%1}function si(l){return 100*l|0}function vi(l,t,n,c,d){const p=function(b,E){if(b)return d(b);if(E){if(l.url&&E.tiles&&l.tiles&&delete l.tiles,E.variants){if(!Array.isArray(E.variants))return d(new Error("variants must be an array"));for(const A of E.variants){if(A==null||typeof A!="object"||A.constructor!==Object)return d(new Error("variant must be an object"));if(!Array.isArray(A.capabilities))return d(new Error("capabilities must be an array"));if(A.capabilities.length===1&&A.capabilities[0]==="meshopt"){E=s.l(E,A);break}}}const I=s.ay(s.l({},E,l),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);I.tiles=t.canonicalizeTileset(I,l.url),d(null,I)}},_=function(b,E,I){if(!b)return null;if(!E&&!I)return b;I=I||b.worldview_default;const A=Object.values(b.language||{});if(A.length===0)return null;const R=Object.values(b.worldview||{});if(R.length===0)return null;const D=A.every(q=>q===E),F=R.every(q=>q===I);return D&&F?b:E in(b.language_options||{})||I in(b.worldview_options||{})?null:b.language_options&&b.worldview_options?b:null}(l.data,n,c);return _?s.q.frame(()=>p(null,_)):l.url?s.n(t.transformRequest(t.normalizeSourceURL(l.url,null,n,c),s.R.Source),p):s.q.frame(()=>{const{data:b,...E}=l;p(null,E)})}class Si{constructor(t,n,c){this.bounds=s.az.convert(this.validateBounds(t)),this.minzoom=n||0,this.maxzoom=c||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}contains(t){const n=Math.pow(2,t.z),c=Math.floor(s.at(this.bounds.getWest())*n),d=Math.floor(s.aA(this.bounds.getNorth())*n),p=Math.ceil(s.at(this.bounds.getEast())*n),_=Math.ceil(s.aA(this.bounds.getSouth())*n);return t.x>=c&&t.x<p&&t.y>=d&&t.y<_}}class fn extends s.E{constructor(t,n,c,d){if(super(),this.id=t,this.dispatcher=c,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,s.l(this,s.ay(n,["url","scheme","tileSize","promoteId"])),this._options=s.l({type:"vector"},n),this._collectResourceTiming=!!n.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(d),this._tileWorkers={},this._deduped=new s.aB}load(t){this._loaded=!1,this.fire(new s.z("dataloading",{dataType:"source"}));const n=Array.isArray(this.map._language)?this.map._language.join():this.map._language,c=this.map.getWorldview();this._tileJSONRequest=vi(this._options,this.map._requestManager,n,c,(d,p)=>{if(this._tileJSONRequest=null,this._loaded=!0,d)n&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${n}`),c&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${c}`),this.fire(new s.y(d));else if(p){if(s.l(this,p),this.hasWorldviews=!!p.worldview_options,p.worldview_default&&(this.worldviewDefault=p.worldview_default),p.vector_layers){this.vectorLayers=p.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const _ of p.vector_layers)this.vectorLayerIds.push(_.id),p.worldview&&p.worldview[_.source]&&this.localizableLayerIds.add(_.id)}p.bounds&&(this.tileBounds=new Si(p.bounds,this.minzoom,this.maxzoom)),Ln(p.tiles,this.map._requestManager._customAccessToken),this.fire(new s.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))}t&&t(d)})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=s.aC(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return s.l({},this._options)}loadTile(t,n){const c=t.tileID.canonical.url(this.tiles,this.scheme),d=this.map._requestManager.normalizeTileURL(c),p=this.map._requestManager.transformRequest(d,s.R.Tile),_=this.map.style?this.map.style.getLut(this.scope):null,b=_?{image:_.image.clone()}:null,E={request:p,data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,lut:b,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:s.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor()};if(this.hasWorldviews&&s.f(c)&&(E.worldview=this.map.getWorldview()||this.worldviewDefault,E.localizableLayerIds=this.localizableLayerIds),E.request.collectResourceTiming=this._collectResourceTiming,t.actor&&t.state!=="expired")t.state==="loading"?t.reloadCallback=n:t.request=t.actor.send("reloadTile",E,I.bind(this));else if(t.actor=this._tileWorkers[d]=this._tileWorkers[d]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",E,I.bind(this),void 0,!0);else{const A=s.aD.call({deduped:this._deduped},E,(R,D)=>{R||!D?I.call(this,R):(E.data={cacheControl:D.cacheControl,expires:D.expires,rawData:D.rawData.slice(0)},t.actor&&t.actor.send("loadTile",E,I.bind(this),void 0,!0))},!0);t.request={cancel:A}}function I(A,R){return delete t.request,t.aborted?n(null):A&&A.status!==404?n(A):(R&&R.resourceTiming&&(t.resourceTiming=R.resourceTiming),this.map._refreshExpiredTiles&&R&&t.setExpiryData(R),t.loadVectorData(R,this.map.painter),s.aE(this.dispatcher),n(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,n){t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope}),t.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class fs extends s.E{constructor(t,n,c,d){super(),this.id=t,this.dispatcher=c,this.setEventedParent(d),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=s.l({type:"raster"},n),s.l(this,s.ay(n,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new s.z("dataloading",{dataType:"source"})),this._tileJSONRequest=vi(this._options,this.map._requestManager,null,null,(n,c)=>{this._tileJSONRequest=null,this._loaded=!0,n?this.fire(new s.y(n)):c&&(s.l(this,c),c.raster_layers&&(this.rasterLayers=c.raster_layers,this.rasterLayerIds=this.rasterLayers.map(d=>d.id)),c.bounds&&(this.tileBounds=new Si(c.bounds,this.minzoom,this.maxzoom)),Ln(c.tiles),this.fire(new s.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))),t&&t(n)})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=s.aC(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return s.l({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,n){const c=s.q.devicePixelRatio>=2,d=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),c,this.tileSize);t.request=s.o(this.map._requestManager.transformRequest(d,s.R.Tile),(p,_,b,E)=>(delete t.request,t.aborted?(t.state="unloaded",n(null)):p?(t.state="errored",n(p)):_?(this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:b,expires:E}),t.setTexture(_,this.map.painter),t.state="loaded",s.aE(this.dispatcher),void n(null)):n(null)))}abortTile(t,n){t.request&&(t.request.cancel(),delete t.request),n&&n()}unloadTile(t,n){t.texture&&t.texture instanceof s.T?(t.destroy(!0),t.texture&&t.texture instanceof s.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),n&&n()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class In extends fs{constructor(t,n,c,d){super(t,n,c,d),this.type="raster-array",this.maxzoom=22,this._options=s.l({type:"raster-array"},n)}triggerRepaint(t){const n=this.map.painter._terrain,c=this.map.style.getSourceCache(this.id);n&&n.enabled&&c&&n._clearRenderCacheForTile(c.id,t.tileID),this.map.triggerRepaint()}loadTile(t,n){const c=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),d=this.map._requestManager.transformRequest(c,s.R.Tile);t.requestParams=d,t.actor||(t.actor=this.dispatcher.getActor()),t.request=t.fetchHeader(void 0,(p,_,b,E)=>{if(delete t.request,t.aborted)return t.state="unloaded",n(null);if(p)return p.code===20?void 0:(t.state="errored",n(p));this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:b,expires:E}),t.state="empty",n(null)})}unloadTile(t,n){const c=t.texture;c&&c instanceof s.T?(t.destroy(!0),this.map.painter.saveTileTexture(c)):(t.destroy(),t.flushQueues(),t._isHeaderLoaded=!1,delete t._mrt,delete t.textureDescriptor),t.fbo&&(t.fbo.destroy(),delete t.fbo),delete t.request,delete t.requestParams,delete t.neighboringTiles,t.state="unloaded"}prepareTile(t,n,c){t._isHeaderLoaded&&(t.state!=="empty"&&(t.state="reloading"),t.fetchBand(n,c,(d,p)=>{if(d)return t.state="errored",this.fire(new s.y(d)),void this.triggerRepaint(t);p&&(t.setTexture(p,this.map.painter),t.state="loaded",this.triggerRepaint(t))}))}getInitialBand(t){if(!this.rasterLayers)return 0;const n=this.rasterLayers.find(({id:p})=>p===t),c=n&&n.fields,d=c&&c.bands&&c.bands;return d?d[0]:0}getTextureDescriptor(t,n,c){if(!t)return;const d=n.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!d)return;let p=null;n instanceof s.aH?p=n.paint.get("raster-array-band"):n instanceof s.aI&&(p=n.paint.get("raster-particle-array-band"));const _=p||this.getInitialBand(d);if(_!=null)if(t.textureDescriptor){if(!t.updateNeeded(d,_)||c)return Object.assign({},t.textureDescriptor,{texture:t.texture})}else this.prepareTile(t,d,_)}}const Cn={vector:fn,raster:fs,"raster-dem":class extends fs{constructor(l,t,n,c){super(l,t,n,c),this.type="raster-dem",this.maxzoom=22,this._options=s.l({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(l,t){const n=this.map._requestManager.normalizeTileURL(l.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function c(d,p){d&&(l.state="errored",t(d)),p&&(l.dem=p,l.dem.onDeserialize(),l.needsHillshadePrepare=!0,l.needsDEMTextureUpload=!0,l.state="loaded",t(null))}l.request=s.o(this.map._requestManager.transformRequest(n,s.R.Tile),(function(d,p,_,b){if(delete l.request,l.aborted)l.state="unloaded",t(null);else if(d)l.state="errored",t(d);else if(p){this.map._refreshExpiredTiles&&l.setExpiryData({cacheControl:_,expires:b});const E=ImageBitmap&&p instanceof ImageBitmap&&s.t(),I=1-(p.width-s.aF(p.width))/2;I<1||l.neighboringTiles||(l.neighboringTiles=this._getNeighboringTiles(l.tileID));const A=E?p:s.q.getImageData(p,I),R={uid:l.uid,coord:l.tileID,source:this.id,scope:this.scope,rawImageData:A,encoding:this.encoding,padding:I};l.actor&&l.state!=="expired"||(l.actor=this.dispatcher.getActor(),l.actor.send("loadDEMTile",R,c.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(l){const t=l.canonical,n=Math.pow(2,t.z),c=(t.x-1+n)%n,d=t.x===0?l.wrap-1:l.wrap,p=(t.x+1+n)%n,_=t.x+1===n?l.wrap+1:l.wrap,b={};return b[new s.aG(l.overscaledZ,d,t.z,c,t.y).key]={backfilled:!1},b[new s.aG(l.overscaledZ,_,t.z,p,t.y).key]={backfilled:!1},t.y>0&&(b[new s.aG(l.overscaledZ,d,t.z,c,t.y-1).key]={backfilled:!1},b[new s.aG(l.overscaledZ,l.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},b[new s.aG(l.overscaledZ,_,t.z,p,t.y-1).key]={backfilled:!1}),t.y+1<n&&(b[new s.aG(l.overscaledZ,d,t.z,c,t.y+1).key]={backfilled:!1},b[new s.aG(l.overscaledZ,l.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},b[new s.aG(l.overscaledZ,_,t.z,p,t.y+1).key]={backfilled:!1}),b}},"raster-array":In,geojson:class extends s.E{constructor(l,t,n,c){super(),this.id=l,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=n.getActor(),this.setEventedParent(c),this._data=t.data,this._options=s.l({},t),this._collectResourceTiming=t.collectResourceTiming,t.maxzoom!==void 0&&(this.maxzoom=t.maxzoom),t.minzoom!==void 0&&(this.minzoom=t.minzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;const d=s.ag/this.tileSize;this.workerOptions=s.l({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(t.buffer!==void 0?t.buffer:128)*d,tolerance:(t.tolerance!==void 0?t.tolerance:.375)*d,extent:s.ag,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:t.clusterMaxZoom!==void 0?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:s.ag,radius:(t.clusterRadius!==void 0?t.clusterRadius:50)*d,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter,dynamic:t.dynamic},t.workerOptions)}onAdd(l){this.map=l,this.setData(this._data)}setData(l){return this._data=l,this._updateWorkerData(),this}updateData(l){if(!this._options.dynamic)return this.fire(new s.y(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof l!="string"&&(l.type==="Feature"&&(l={type:"FeatureCollection",features:[l]}),l.type!=="FeatureCollection"))return this.fire(new s.y(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof l!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){const t=new Map;for(const n of this._data.features)t.set(n.id,n);for(const n of l.features)t.set(n.id,n);this._data.features=[...t.values()]}else this._data=l;return this._updateWorkerData(!0),this}getClusterExpansionZoom(l,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:l,source:this.id,scope:this.scope},t),this}getClusterChildren(l,t){return this.actor.send("geojson.getClusterChildren",{clusterId:l,source:this.id,scope:this.scope},t),this}getClusterLeaves(l,t,n,c){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:l,limit:t,offset:n},c),this}_updateWorkerData(l=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new s.z("dataloading",{dataType:"source"})),this._loaded=!1;const t=s.l({append:l},this.workerOptions);t.scope=this.scope;const n=this._data;typeof n=="string"?(t.request=this.map._requestManager.transformRequest(s.q.resolveURL(n),s.R.Source),t.request.collectResourceTiming=this._collectResourceTiming):t.data=JSON.stringify(n),this._pendingLoad=this.actor.send(`${this.type}.loadData`,t,(c,d)=>{if(this._loaded=!0,this._pendingLoad=null,c)this.fire(new s.y(c));else{const p={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&d&&d.resourceTiming&&d.resourceTiming[this.id]&&(p.resourceTiming=d.resourceTiming[this.id]),l&&(this._partialReload=!0),this.fire(new s.z("data",p)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(l),this._coalesce=!1)})}loaded(){return this._loaded}reload(){const l=s.aC(this.id,this.scope);this.map.style.clearSource(l),this._updateWorkerData()}loadTile(l,t){const n=l.actor?"reloadTile":"loadTile";l.actor=this.actor;const c=this.map.style?this.map.style.getLut(this.scope):null,d=c?{image:c.image.clone()}:null,p=this._partialReload,_={type:this.type,uid:l.uid,tileID:l.tileID,tileZoom:l.tileZoom,zoom:l.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:d,scope:this.scope,pixelRatio:s.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,scaleFactor:this.map.getScaleFactor(),partial:p};l.request=this.actor.send(n,_,(b,E)=>p&&!E?(l.state="loaded",t(null)):(delete l.request,l.destroy(),l.aborted?t(null):b?t(b):(l.loadVectorData(E,this.map.painter,n==="reloadTile"),t(null))),void 0,n==="loadTile")}abortTile(l){l.request&&(l.request.cancel(),delete l.request),l.aborted=!0}unloadTile(l,t){this.actor.send("removeTile",{uid:l.uid,type:this.type,source:this.id,scope:this.scope}),l.destroy()}onRemove(l){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return s.l({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends s.aJ{constructor(l,t,n,c){super(l,t,n,c),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;const l=this.options;this.urls=[];for(const t of l.urls)this.urls.push(this.map._requestManager.transformRequest(t,s.R.Source).url);s.aK(this.urls,(t,n)=>{this._loaded=!0,t?this.fire(new s.y(t)):n&&(this.video=n,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(l){if(this.video){const t=this.video.seekable;l<t.start(0)||l>t.end(0)?this.fire(new s.y(new s.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${t.start(0)} and ${t.end(0)}-second mark.`))):this.video.currentTime=l}}getVideo(){return this.video}onAdd(l){this.map||(this.map=l,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const l=this.map.painter.context,t=l.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new s.T(l,this.video,t.RGBA8),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(l)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:s.aJ,model:class extends s.E{constructor(l,t,n,c){super(),this.id=l,this.type="model",this.models=[],this._loaded=!1,this._options=t}load(){const l=[];for(const t in this._options.models){const n=this._options.models[t],c=s.aM(this.map._requestManager.transformRequest(n.uri,s.R.Model).url).then(d=>{if(!d)return;const p=s.aN(d),_=new s.aO(t,n.position,n.orientation,p);_.computeBoundsAndApplyParent(),this.models.push(_)}).catch(d=>{this.fire(new s.y(new Error(`Could not load model ${t} from ${n.uri}: ${d.message}`)))});l.push(c)}return Promise.allSettled(l).then(()=>{this._loaded=!0,this.fire(new s.z("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(t=>{this.fire(new s.y(new Error(`Could not load models: ${t.message}`)))})}onAdd(l){this.map=l,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(l,t){}serialize(){return{type:"model"}}},"batched-model":class extends s.E{constructor(l,t,n,c){super(),this.type="batched-model",this.id=l,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=n,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(c)}onAdd(l){this.map=l,this.load()}reload(){this.cancelTileJSONRequest();const l=s.aC(this.id,this.scope);this.load(()=>this.map.style.clearSource(l))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(l){this._loaded=!1,this.fire(new s.z("dataloading",{dataType:"source"}));const t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,n=this.map.getWorldview();this._tileJSONRequest=vi(this._options,this.map._requestManager,t,n,(c,d)=>{this._tileJSONRequest=null,this._loaded=!0,c?(t&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${t}`),n&&n.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${n}`),this.fire(new s.y(c))):d&&(s.l(this,d),d.bounds&&(this.tileBounds=new Si(d.bounds,this.minzoom,this.maxzoom)),Ln(d.tiles,this.map._requestManager._customAccessToken),this.fire(new s.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))),l&&l(c)})}hasTransition(){return!1}hasTile(l){return!this.tileBounds||this.tileBounds.contains(l.canonical)}loaded(){return this._loaded}loadTile(l,t){const n=this.map._requestManager.normalizeTileURL(l.tileID.canonical.url(this.tiles,this.scheme)),c={request:this.map._requestManager.transformRequest(n,s.R.Tile),data:void 0,uid:l.uid,tileID:l.tileID,tileZoom:l.tileZoom,zoom:l.tileID.overscaledZ,tileSize:this.tileSize*l.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:l.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,lut:null,maxZoom:null,promoteId:null,pixelRatio:null,scaleFactor:null};if(l.actor&&l.state!=="expired")if(l.state==="loading")l.reloadCallback=t;else{if(l.buckets){const p=Object.values(l.buckets);for(const _ of p)_.dirty=!0;return void(l.state="loaded")}l.request=l.actor.send("reloadTile",c,d.bind(this))}else l.actor=this.dispatcher.getActor(),l.request=l.actor.send("loadTile",c,d.bind(this),void 0,!0);function d(p,_){return l.aborted?t(null):p&&p.status!==404?t(p):(this.map._refreshExpiredTiles&&_&&l.setExpiryData(_),l.loadModelData(_,this.map.painter),l.state="loaded",void t(null))}}serialize(){return s.l({},this._options)}},canvas:class extends s.aJ{constructor(l,t,n,c){super(l,t,n,c),t.coordinates?Array.isArray(t.coordinates)&&t.coordinates.length===4&&!t.coordinates.some(d=>!Array.isArray(d)||d.length!==2||d.some(p=>typeof p!="number"))||this.fire(new s.y(new s.V(`sources.${l}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new s.y(new s.V(`sources.${l}`,null,'missing required property "coordinates"'))),t.animate&&typeof t.animate!="boolean"&&this.fire(new s.y(new s.V(`sources.${l}`,null,'optional "animate" property must be a boolean value'))),t.canvas?typeof t.canvas=="string"||t.canvas instanceof HTMLCanvasElement||this.fire(new s.y(new s.V(`sources.${l}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new s.y(new s.V(`sources.${l}`,null,'missing required property "canvas"'))),this.options=t,this.animate=t.animate===void 0||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new s.y(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(l){this.map=l,this.load(),this.canvas&&this.animate&&this.play()}onRemove(l){this.pause()}prepare(){let l=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,l=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,l=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const t=this.map.painter.context;this.texture?!l&&!this._playing||this.texture instanceof s.aL||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new s.T(t,this.canvas,t.gl.RGBA8,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const l of[this.canvas.width,this.canvas.height])if(isNaN(l)||l<=0)return!0;return!1}},custom:class extends s.E{constructor(l,t,n,c){super(),this.id=l,this.type="custom",this._dataType="raster",this._dispatcher=n,this._implementation=t,this.setEventedParent(c),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new s.y(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new s.y(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new Si(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),s.l(this,s.ay(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return s.ay(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new s.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(l){this.map=l,this._loaded=!1,this.fire(new s.z("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(l),this.load()}onRemove(l){this._implementation.onRemove&&this._implementation.onRemove(l)}hasTile(l){if(this._implementation.hasTile){const{x:t,y:n,z:c}=l.canonical;return this._implementation.hasTile({x:t,y:n,z:c})}return!this.tileBounds||this.tileBounds.contains(l.canonical)}loadTile(l,t){const{x:n,y:c,z:d}=l.tileID.canonical,p=new AbortController;l.request=Promise.resolve(this._implementation.loadTile({x:n,y:c,z:d},{signal:p.signal})).then((function(_){return delete l.request,l.aborted?(l.state="unloaded",t(null)):_===void 0?(l.state="errored",t(null)):_===null?(this.loadTileData(l,{width:this.tileSize,height:this.tileSize,data:null}),l.state="loaded",t(null)):function(b){return b instanceof ImageData||b instanceof HTMLCanvasElement||b instanceof ImageBitmap||b instanceof HTMLImageElement}(_)?(this.loadTileData(l,_),l.state="loaded",void t(null)):(l.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(_=>{_.code!==20&&(l.state="errored",t(_))}),l.request.cancel=()=>p.abort()}loadTileData(l,t){l.setTexture(t,this.map.painter)}unloadTile(l,t){if(l.texture&&l.texture instanceof s.T?(l.destroy(!0),l.texture&&l.texture instanceof s.T&&this.map.painter.saveTileTexture(l.texture)):l.destroy(),this._implementation.unloadTile){const{x:n,y:c,z:d}=l.tileID.canonical;this._implementation.unloadTile({x:n,y:c,z:d})}t&&t()}abortTile(l,t){l.request&&l.request.cancel&&(l.request.cancel(),delete l.request),t&&t()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(l=>({x:l.canonical.x,y:l.canonical.y,z:l.canonical.z}))}_clearTiles(){const l=s.aC(this.id,this.scope);this.map.style.clearSource(l)}_update(){this.fire(new s.z("data",{dataType:"source",sourceDataType:"content"}))}}},or=function(l,t,n,c){const d=new Cn[t.type](l,t,n,c);if(d.id!==l)throw new Error(`Expected Source id to be ${l} instead of ${d.id}`);return s.aP(["load","abort","unload","serialize","prepare"],d),d};function ml(l,t,n=""){return`${n}:${t.id||""}:${t.layer.id}:${function(c){if("layerId"in c)return`layer:${c.layerId}`;{const{featuresetId:d,importId:p}=c;return`featureset:${d}${p?`:import:${p}`:""}`}}(l.target)}`}function js(l,t,n,c=""){if(l.uniqueFeatureID){const d=ml(l,t,c);if(n.has(d))return!0;n.add(d)}return!1}function _l(l,t,n,c,d=!1){const p=t.sourceCache.transform,_=t.sourceCache.tilesIn(l,t.has3DLayers,d);_.sort(nh);const b=[];for(const E of _){const I=E.tile.queryRenderedFeatures(t,E,n,c,p,d);Object.keys(I).length&&b.push({wrappedTileID:E.tile.tileID.wrapped().key,queryResults:I})}return b.length===0?{}:function(E){const I={},A={};for(const R of E){const D=R.queryResults,F=R.wrappedTileID,q=A[F]=A[F]||{};for(const U in D){const H=D[U],Z=q[U]=q[U]||{},J=I[U]=I[U]||[];for(const re of H)Z[re.featureIndex]||(Z[re.featureIndex]=!0,J.push(re))}}return I}(b)}function ih(l,t,n,c,d){const p={},_=c.queryRenderedSymbols(l),b=[];for(const E of Object.keys(_).map(Number))b.push(d[E]);b.sort(nh);for(const E of b){const I=E.featureIndex.lookupSymbolFeatures(_[E.bucketInstanceId],E.bucketIndex,E.sourceLayerIndex,t,n);for(const A in I){const R=p[A]=p[A]||[],D=I[A];D.sort((F,q)=>{const U=E.featureSortOrder;if(U){const H=U.indexOf(F.featureIndex);return U.indexOf(q.featureIndex)-H}return q.featureIndex-F.featureIndex});for(const F of D)R.push(F)}}return p}function xf(l,t){const n=l.getRenderableIds().map(p=>l.getTileByID(p)),c=[],d={};for(let p=0;p<n.length;p++){const _=n[p],b=_.tileID.canonical.key;d[b]||(d[b]=!0,_.querySourceFeatures(c,t))}return c}function nh(l,t){const n=l.tileID,c=t.tileID;return n.overscaledZ-c.overscaledZ||n.canonical.y-c.canonical.y||n.wrap-c.wrap||n.canonical.x-c.canonical.x}function rh(l,t){const n={};if(!t)return n;for(const c of l){const d=c.layerIds.map(p=>t.getLayer(p)).filter(Boolean);if(d.length!==0){c.layers=d,c.stateDependentLayerIds&&(c.stateDependentLayers=c.stateDependentLayerIds.map(p=>d.filter(_=>_.id===p)[0]));for(const p of d)n[p.fqid]=c}}return n}const ar=32,Yr=33,Gs=new Uint16Array(8184);for(let l=0;l<2046;l++){let t=l+2,n=0,c=0,d=0,p=0,_=0,b=0;for(1&t?d=p=_=ar:n=c=b=ar;(t>>=1)>1;){const I=n+d>>1,A=c+p>>1;1&t?(d=n,p=c,n=_,c=b):(n=d,c=p,d=_,p=b),_=I,b=A}const E=4*l;Gs[E+0]=n,Gs[E+1]=c,Gs[E+2]=d,Gs[E+3]=p}const ps=new Uint16Array(2178),Kr=new Uint8Array(1089),ms=new Uint16Array(1089);function kc(l){return l===0?-.03125:l===32?.03125:0}const sh={type:2,extent:s.ag,loadGeometry:()=>[[new s.P(0,0),new s.P(s.ag+1,0),new s.P(s.ag+1,s.ag+1),new s.P(0,s.ag+1),new s.P(0,0)]]};class co{constructor(t,n,c,d,p){this.tileID=t,this.uid=s.aV(),this.uses=0,this.tileSize=n,this.tileZoom=c,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=p,d&&d.style&&(this._lastUpdatedBrightness=d.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",d&&d.transform&&(this.projection=d.transform.projection)}registerFadeDuration(t){const n=t+this.timeAdded;n<s.q.now()||this.fadeEndTime&&n<this.fadeEndTime||(this.fadeEndTime=n)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=s.aQ(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,n,c){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=rh(t.buckets,n.style),this.hasSymbolBuckets=!1;for(const d in this.buckets){const p=this.buckets[d];if(p instanceof s.aX){if(this.hasSymbolBuckets=!0,!c)break;p.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const d in this.buckets){const p=this.buckets[d];if(p instanceof s.aX&&p.hasRTLText){this.hasRTLText=!0,s.aY();break}}this.queryPadding=0;for(const d in this.buckets){const p=this.buckets[d],_=n.style.getOwnLayer(d);if(!_)continue;const b=_.queryRadius(p);this.queryPadding=Math.max(this.queryPadding,b)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new s.aW}unloadVectorData(){if(this.hasData()){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(t,n,c){t&&(t.resourceTiming&&(this.resourceTiming=t.resourceTiming),this.buckets=Object.assign({},this.buckets,rh(t.buckets,n.style)),t.featureIndex&&(this.latestFeatureIndex=t.featureIndex))}getBucket(t){return this.buckets[t.fqid]}upload(t){for(const d in this.buckets){const p=this.buckets[d];p.uploadPending()&&p.upload(t)}const n=t.gl,c=this.imageAtlas;if(c&&!c.uploaded){const d=!!Object.keys(c.patternPositions).length;this.imageAtlasTexture=new s.T(t,c.image,n.RGBA8,{useMipmap:d}),this.imageAtlas.uploaded=!0}this.glyphAtlasImage&&(this.glyphAtlasTexture=new s.T(t,this.glyphAtlasImage,n.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new s.T(t,this.lineAtlas.image,n.R8),this.lineAtlas.uploaded=!0)}prepare(t,n,c){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,c),!n||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const d=n.style.getBrightness();(this._lastUpdatedBrightness||d)&&(this._lastUpdatedBrightness&&d&&Math.abs(this._lastUpdatedBrightness-d)<.001||(this.updateBuckets(n,this._lastUpdatedBrightness!==d),this._lastUpdatedBrightness=d))}queryRenderedFeatures(t,n,c,d,p,_){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const b=function(E,I){const A=s.ab.mat4.fromScaling([],[.5*E.width,.5*-E.height,1]);return s.ab.mat4.translate(A,A,[1,-1,0]),s.ab.mat4.multiply(A,A,E.calculateProjMatrix(I.toUnwrapped())),Float32Array.from(A)}(p,this.tileID);return this.latestFeatureIndex.query(t,{tilespaceGeometry:n,pixelPosMatrix:b,transform:d,availableImages:c,tileTransform:this.tileTransform})}querySourceFeatures(t,n){const c=this.latestFeatureIndex;if(!c||!c.rawTileData)return;const d=c.loadVTLayers(),p=n?n.sourceLayer:"",_=d._geojsonTileLayer||d[p];if(!_)return;const b=s.aZ(n&&n.filter),{z:E,x:I,y:A}=this.tileID.canonical,R={z:E,x:I,y:A};for(let D=0;D<_.length;D++){const F=_.feature(D);if(b.needGeometry){const H=s.a_(F,!0);if(!b.filter(new s.a8(this.tileID.overscaledZ),H,this.tileID.canonical))continue}else if(!b.filter(new s.a8(this.tileID.overscaledZ),F))continue;const q=c.getId(F,p),U=new s.a$(F,E,I,A,q);U.tile=R,t.push(U)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(t){const n=this.expirationTime;if(t.cacheControl){const c=s.b0(t.cacheControl);c["max-age"]&&(this.expirationTime=Date.now()+1e3*c["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const c=Date.now();let d=!1;if(this.expirationTime>c)d=!1;else if(n)if(this.expirationTime<n)d=!0;else{const p=this.expirationTime-n;p?this.expirationTime=c+Math.max(p,3e4):d=!0}else d=!0;d?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(t){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&t&&this.updateBuckets(t)}updateBuckets(t,n){if(!this.latestFeatureIndex||!t.style)return;const c=this.latestFeatureIndex.loadVTLayers(),d=t.style.listImages(),p=t.style.getBrightness();for(const _ in this.buckets){if(!t.style.hasLayer(_))continue;const b=this.buckets[_],E=b.layers[0],I=E.sourceLayer||"_geojsonTileLayer",A=c[I],R=t.style.getLayerSourceCache(E);let D={};R&&(D=R._state.getState(I,void 0));const F=this.imageAtlas&&this.imageAtlas.patternPositions||{},q=Object.keys(D).length>0&&!n;q&&!b.stateDependentLayers.length&&!n||b.update(D,A,d,F,q?b.stateDependentLayers:b.layers,n,p),(b instanceof s.b1||b instanceof s.b2)&&t._terrain&&t._terrain.enabled&&R&&b.programConfigurations.needsUpload&&t._terrain._clearRenderCacheForTile(R.id,this.tileID);const U=t&&t.style&&t.style.getOwnLayer(_);U&&(this.queryPadding=Math.max(this.queryPadding,U.queryRadius(b)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<s.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=s.q.now()+t}setTexture(t,n){const c=n.context,d=c.gl;this.texture=this.texture||n.getTileTexture(t.width),this.texture&&this.texture instanceof s.T?this.texture.update(t):(this.texture=new s.T(c,t,d.RGBA8,{useMipmap:!0}),this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE))}setDependencies(t,n){const c={};for(const d of n)c[d]=!0;this.dependencies[t]=c}hasDependency(t,n){for(const c of t){const d=this.dependencies[c];if(d){for(const p of n)if(d[p])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,n){if(!n||n.name==="mercator"||this._tileDebugBuffer)return;const c=s.b3(sh,this.tileID.canonical,this.tileTransform)[0],d=new s.b4,p=new s.b5;for(let _=0;_<c.length;_++){const{x:b,y:E}=c[_];d.emplaceBack(b,E),p.emplaceBack(_)}p.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(p),this._tileDebugBuffer=t.createVertexBuffer(d,s.b6.members),this._tileDebugSegments=s.b7.simpleSegment(0,0,d.length,p.length)}_makeTileBoundsBuffers(t,n){if(this._tileBoundsBuffer||!n||n.name==="mercator")return;const c=s.b3(sh,this.tileID.canonical,this.tileTransform)[0];let d,p;if(this.isRaster){const _=function(b,E){const I=s.aQ(b,E),A=Math.pow(2,b.z);for(let H=0;H<Yr;H++)for(let Z=0;Z<Yr;Z++){const J=s.aR((b.x+(Z+kc(Z))/ar)/A),re=s.aS((b.y+(H+kc(H))/ar)/A),ne=E.project(J,re),de=H*Yr+Z;ps[2*de+0]=Math.round((ne.x*I.scale-I.x)*s.ag),ps[2*de+1]=Math.round((ne.y*I.scale-I.y)*s.ag)}Kr.fill(0),ms.fill(0);for(let H=2045;H>=0;H--){const Z=4*H,J=Gs[Z+0],re=Gs[Z+1],ne=Gs[Z+2],de=Gs[Z+3],le=J+ne>>1,he=re+de>>1,ae=le+he-re,ge=he+J-le,Te=re*Yr+J,Ue=de*Yr+ne,Le=he*Yr+le,He=Math.hypot((ps[2*Te+0]+ps[2*Ue+0])/2-ps[2*Le+0],(ps[2*Te+1]+ps[2*Ue+1])/2-ps[2*Le+1])>=16;Kr[Le]=Kr[Le]||(He?1:0),H<1022&&(Kr[Le]=Kr[Le]||Kr[(re+ge>>1)*Yr+(J+ae>>1)]||Kr[(de+ge>>1)*Yr+(ne+ae>>1)])}const R=new s.aT,D=new s.aU;let F=0;function q(H,Z){const J=Z*Yr+H;return ms[J]===0&&(R.emplaceBack(ps[2*J+0],ps[2*J+1],H*s.ag/ar,Z*s.ag/ar),ms[J]=++F),ms[J]-1}function U(H,Z,J,re,ne,de){const le=H+J>>1,he=Z+re>>1;if(Math.abs(H-ne)+Math.abs(Z-de)>1&&Kr[he*Yr+le])U(ne,de,H,Z,le,he),U(J,re,ne,de,le,he);else{const ae=q(H,Z),ge=q(J,re),Te=q(ne,de);D.emplaceBack(ae,ge,Te)}}return U(0,0,ar,ar,ar,0),U(ar,ar,0,0,0,ar),{vertices:R,indices:D}}(this.tileID.canonical,n);d=_.vertices,p=_.indices}else{d=new s.aT,p=new s.aU;for(const{x:b,y:E}of c)d.emplaceBack(b,E,0,0);const _=s.b8(d.int16,void 0,4);for(let b=0;b<_.length;b+=3)p.emplaceBack(_[b],_[b+1],_[b+2])}this._tileBoundsBuffer=t.createVertexBuffer(d,s.b9.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(p),this._tileBoundsSegments=s.b7.simpleSegment(0,0,d.length,p.length)}_makeGlobeTileDebugBuffers(t,n){const c=n.projection;if(!c||c.name!=="globe"||n.freezeTileCoverage)return;const d=this.tileID.canonical,p=s.ba(d,n),_=s.bb(p),b=s.ae(n.zoom);let E;b>0&&(E=s.ab.mat4.invert(new Float64Array(16),n.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,d,n,_,E,b),this._makeGlobeTileDebugTextBuffer(t,d,n,_,E,b)}_globePoint(t,n,c,d,p,_,b){let E=s.bc(t,n,c);if(_){const I=1<<c.z,A=s.at(d.center.lng),R=s.aA(d.center.lat),D=(c.x+.5)/I-A;let F=0;D>.5?F=-1:D<-.5&&(F=1);let q=(t/s.ag+c.x)/I+F,U=(n/s.ag+c.y)/I;q=(q-A)*d._pixelsPerMercatorPixel+A,U=(U-R)*d._pixelsPerMercatorPixel+R;const H=[q*d.worldSize,U*d.worldSize,0];s.ab.vec3.transformMat4(H,H,_),E=s.bd(E,H,b)}return s.ab.vec3.transformMat4(E,E,p)}_makeGlobeTileDebugBorderBuffer(t,n,c,d,p,_){const b=new s.b4,E=new s.b5,I=new s.be,A=(D,F,q,U,H)=>{const Z=(q-D)/(H-1),J=(U-F)/(H-1),re=b.length;for(let ne=0;ne<H;ne++){const de=D+ne*Z,le=F+ne*J;b.emplaceBack(de,le);const he=this._globePoint(de,le,n,c,d,p,_);I.emplaceBack(he[0],he[1],he[2]),E.emplaceBack(re+ne)}},R=s.ag;A(0,0,R,0,16),A(R,0,R,R,16),A(R,R,0,R,16),A(0,R,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(E),this._tileDebugBuffer=t.createVertexBuffer(b,s.b6.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(I,s.bf.members),this._tileDebugSegments=s.b7.simpleSegment(0,0,b.length,E.length)}_makeGlobeTileDebugTextBuffer(t,n,c,d,p,_){const b=s.ag/4,E=new s.b4,I=new s.aU,A=new s.be,R=25;I.reserve(32),E.reserve(R),A.reserve(R);const D=(F,q)=>R*F+q;for(let F=0;F<R;F++){const q=F*b;for(let U=0;U<R;U++){const H=U*b;E.emplaceBack(H,q);const Z=this._globePoint(H,q,n,c,d,p,_);A.emplaceBack(Z[0],Z[1],Z[2])}}for(let F=0;F<4;F++)for(let q=0;q<4;q++){const U=D(F,q),H=D(F,q+1),Z=D(F+1,q),J=D(F+1,q+1);I.emplaceBack(U,H,Z),I.emplaceBack(Z,H,J)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(I),this._tileDebugTextBuffer=t.createVertexBuffer(E,s.b6.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(A,s.bf.members),this._tileDebugTextSegments=s.b7.simpleSegment(0,0,R,32)}destroy(t=!1){for(const n in this.buckets)this.buckets[n].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!t&&this.texture&&this.texture instanceof s.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}s.bg.setPbf(s.bh);class uo extends co{constructor(t,n,c,d,p){super(t,n,c,d,p),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}setTexture(t,n){const c=n.context,d=c.gl;this.texture=this.texture||n.getTileTexture(t.width),this.texture&&this.texture instanceof s.T?this.texture.update(t,{premultiply:!1}):this.texture=new s.T(c,t,d.RGBA8,{premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(t=16384,n){const c=this._mrt=new s.bg(30),d=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(t-1)}});return this.entireBuffer=null,this.request=s.bi(d,(p,_,b,E)=>{if(p)n(p);else try{const I=c.getHeaderLength(_);if(I>t)return void(this.request=this.fetchHeader(I,n));c.parseHeader(_),this._isHeaderLoaded=!0;let A=0;for(const R of Object.values(c.layers))A=Math.max(A,R.dataIndex[R.dataIndex.length-1].last_byte);_.byteLength>=A&&(this.entireBuffer=_),n(null,this.entireBuffer||_,b,E)}catch(I){n(I)}}),this.request}fetchBand(t,n,c){const d=this._mrt;if(!this._isHeaderLoaded||!d)return void c(new Error("Tile header is not ready"));const p=this.actor;if(!p)return void c(new Error("Can't fetch tile band without an actor"));let _;const b=(R,D)=>{_.complete(R,D),R?c(R):(this.updateTextureDescriptor(t,n),c(null,this.textureDescriptor&&this.textureDescriptor.img))},E=(R,D)=>{if(R)return c(R);const F=p.send("decodeRasterArray",{buffer:D,task:_},b,void 0,!0);this._workQueue.push(()=>{F&&F.cancel(),_.cancel()})},I=d.getLayer(t);if(!I)return void c(new Error(`Unknown sourceLayer "${t}"`));if(I.hasDataForBand(n))return this.updateTextureDescriptor(t,n),void c(null,this.textureDescriptor?this.textureDescriptor.img:null);const A=I.getDataRange([n]);if(_=d.createDecodingTask(A),!_||_.tasks.length)if(this.flushQueues(),this.entireBuffer)E(null,this.entireBuffer.slice(A.firstByte,A.lastByte+1));else{const R=Object.assign({},this.requestParams,{headers:{Range:`bytes=${A.firstByte}-${A.lastByte}`}}),D=s.bi(R,E);this._fetchQueue.push(()=>{D.cancel(),_.cancel()})}else c(null)}updateNeeded(t,n){return(!this.textureDescriptor||this.textureDescriptor.band!==n||this.textureDescriptor.layer!==t)&&this.state!=="errored"}updateTextureDescriptor(t,n){if(!this._mrt)return;const c=this._mrt.getLayer(t);if(!c||!c.hasBand(n)||!c.hasDataForBand(n))return;const{bytes:d,tileSize:p,buffer:_,offset:b,scale:E}=c.getBandView(n),I=p+2*_,A={data:d,width:I,height:I},R=this.texture;R&&R instanceof s.T&&R.update(A,{premultiply:!1}),this.textureDescriptor={layer:t,band:n,img:A,buffer:_,offset:b,tileSize:p,format:c.pixelFormat,mix:[E,256*E,65536*E,16777216*E]}}}class vf{constructor(t,n){this.max=t,this.onRemove=n,this.reset()}reset(){for(const t in this.data)for(const n of this.data[t])n.timeout&&clearTimeout(n.timeout),this.onRemove(n.value);return this.data={},this.order=[],this}add(t,n,c){const d=t.wrapped().key;this.data[d]===void 0&&(this.data[d]=[]);const p={value:n,timeout:void 0};if(c!==void 0&&(p.timeout=setTimeout(()=>{this.remove(t,p)},c)),this.data[d].push(p),this.order.push(d),this.order.length>this.max){const _=this._getAndRemoveByKey(this.order[0]);_&&this.onRemove(_)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const n=this.data[t].shift();return n.timeout&&clearTimeout(n.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),n.value}getByKey(t){const n=this.data[t];return n?n[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,n){if(!this.has(t))return this;const c=t.wrapped().key,d=n===void 0?0:this.data[c].indexOf(n),p=this.data[c][d];return this.data[c].splice(d,1),p.timeout&&clearTimeout(p.timeout),this.data[c].length===0&&delete this.data[c],this.onRemove(p.value),this.order.splice(this.order.indexOf(c),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const n=this._getAndRemoveByKey(this.order[0]);n&&this.onRemove(n)}return this}filter(t){const n=[];for(const c in this.data)for(const d of this.data[c])t(d.value)||n.push(d);for(const c of n)this.remove(c.value.tileID,c)}}class oh{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,n,c){const d=String(n);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][d]=this.stateChanges[t][d]||{},s.l(this.stateChanges[t][d],c),this.deletedStates[t]===null){this.deletedStates[t]={};for(const p in this.state[t])p!==d&&(this.deletedStates[t][p]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][d]===null){this.deletedStates[t][d]={};for(const p in this.state[t][d])c[p]||(this.deletedStates[t][d][p]=null)}else for(const p in c)this.deletedStates[t]&&this.deletedStates[t][d]&&this.deletedStates[t][d][p]===null&&delete this.deletedStates[t][d][p]}removeFeatureState(t,n,c){if(this.deletedStates[t]===null)return;const d=String(n);if(this.deletedStates[t]=this.deletedStates[t]||{},c&&n!==void 0)this.deletedStates[t][d]!==null&&(this.deletedStates[t][d]=this.deletedStates[t][d]||{},this.deletedStates[t][d][c]=null);else if(n!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][d])for(c in this.deletedStates[t][d]={},this.stateChanges[t][d])this.deletedStates[t][d][c]=null;else this.deletedStates[t][d]=null;else this.deletedStates[t]=null}getState(t,n){const c=this.state[t]||{},d=this.stateChanges[t]||{},p=this.deletedStates[t];if(p===null)return{};if(n!==void 0){const b=String(n),E=s.l({},c[b],d[b]);if(p){const I=p[n];if(I===null)return{};for(const A in I)delete E[A]}return E}const _=s.l({},c,d);if(p)for(const b in p)delete _[b];return _}initializeTileState(t,n){t.refreshFeatureState(n)}coalesceChanges(t,n){const c={};for(const d in this.stateChanges){this.state[d]=this.state[d]||{};const p={};for(const _ in this.stateChanges[d])this.state[d][_]||(this.state[d][_]={}),s.l(this.state[d][_],this.stateChanges[d][_]),p[_]=this.state[d][_];c[d]=p}for(const d in this.deletedStates){this.state[d]=this.state[d]||{};const p={};if(this.deletedStates[d]===null)for(const _ in this.state[d])p[_]={},this.state[d][_]={};else for(const _ in this.deletedStates[d]){if(this.deletedStates[d][_]===null)this.state[d][_]={};else if(this.state[d][_])for(const b of Object.keys(this.deletedStates[d][_]))delete this.state[d][_][b];p[_]=this.state[d][_]}c[d]=c[d]||{},s.l(c[d],p)}if(this.stateChanges={},this.deletedStates={},Object.keys(c).length!==0)for(const d in t)t[d].refreshFeatureState(n)}}class Nr extends s.E{constructor(t,n,c){super(),this.id=t,this._onlySymbols=c,n.on("data",d=>{d.dataType==="source"&&d.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&d.dataType==="source"&&d.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),n.on("error",()=>{this._sourceErrored=!0}),this._source=n,this._tiles={},this._cache=new vf(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=n.minTileCacheSize,this._maxTileCacheSize=n.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new oh,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const t in this._tiles){const n=this._tiles[t];if(n.state!=="loaded"&&n.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,n){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,n)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t)}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t)}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const n in this._tiles){const c=this._tiles[n];c.upload(t),c.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return s.bj(this._tiles).map(t=>t.tileID).sort(Mi).map(t=>t.key)}getRenderableIds(t,n){const c=[];for(const d in this._tiles)this._isIdRenderable(+d,t,n)&&c.push(this._tiles[d]);return t?c.sort((d,p)=>{const _=d.tileID,b=p.tileID,E=new s.P(_.canonical.x,_.canonical.y)._rotate(this.transform.angle),I=new s.P(b.canonical.x,b.canonical.y)._rotate(this.transform.angle);return _.overscaledZ-b.overscaledZ||I.y-E.y||I.x-E.x}).map(d=>d.tileID.key):c.map(d=>d.tileID).sort(Mi).map(d=>d.key)}hasRenderableParent(t){const n=this.findLoadedParent(t,0);return!!n&&this._isIdRenderable(n.tileID.key)}_isIdRenderable(t,n,c){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(n||!this._tiles[t].holdingForFade())&&(c||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,n){const c=this._tiles[t];c&&(c.state!=="loading"&&(c.state=n),this._loadTile(c,this._tileLoaded.bind(this,c,t,n)))}_tileLoaded(t,n,c,d){if(d)if(t.state="errored",d.status!==404)this._source.fire(new s.y(d,{tile:t}));else{if(this._source.fire(new s.z("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:t})),!(t.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const p=this.map.painter.terrain;this.update(this.transform,p.getScaledDemTileSize(),!0),p.resetTileLookupCache(this.id)}else this.update(this.transform)}else t.timeAdded=s.q.now(),c==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(n,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new s.z("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){const n=this.getRenderableIds();for(let d=0;d<n.length;d++){const p=n[d];if(t.neighboringTiles&&t.neighboringTiles[p]){const _=this.getTileByID(p);c(t,_),c(_,t)}}function c(d,p){if(!d.dem||d.dem.borderReady)return;d.needsHillshadePrepare=!0,d.needsDEMTextureUpload=!0;let _=p.tileID.canonical.x-d.tileID.canonical.x;const b=p.tileID.canonical.y-d.tileID.canonical.y,E=Math.pow(2,d.tileID.canonical.z),I=p.tileID.key;_===0&&b===0||Math.abs(b)>1||(Math.abs(_)>1&&(Math.abs(_+E)===1?_+=E:Math.abs(_-E)===1&&(_-=E)),p.dem&&d.dem&&(d.dem.backfillBorder(p.dem,_,b),d.neighboringTiles&&d.neighboringTiles[I]&&(d.neighboringTiles[I].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,n,c,d){for(const p in this._tiles){let _=this._tiles[p];if(d[p]||!_.hasData()||_.tileID.overscaledZ<=n||_.tileID.overscaledZ>c)continue;let b=_.tileID;for(;_&&_.tileID.overscaledZ>n+1;){const I=_.tileID.scaledTo(_.tileID.overscaledZ-1);_=this._tiles[I.key],_&&_.hasData()&&(b=I)}let E=b;for(;E.overscaledZ>n;)if(E=E.scaledTo(E.overscaledZ-1),t[E.key]){d[b.key]=b;break}}}findLoadedParent(t,n){if(t.key in this._loadedParentTiles){const c=this._loadedParentTiles[t.key];return c&&c.tileID.overscaledZ>=n?c:null}for(let c=t.overscaledZ-1;c>=n;c--){const d=t.scaledTo(c),p=this._getLoadedTile(d);if(p)return p}}_getLoadedTile(t){const n=this._tiles[t.key];return n&&n.hasData()?n:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,n){n=n||this._source.tileSize;const c=Math.ceil(t.width/n)+1,d=Math.ceil(t.height/n)+1,p=Math.floor(c*d*5),_=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,p):p,b=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,_):_;this._cache.setMaxSize(b)}handleWrapJump(t){const n=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,n){const c={};for(const d in this._tiles){const p=this._tiles[d];p.tileID=p.tileID.unwrapTo(p.tileID.wrap+n),c[p.tileID.key]=p}this._tiles=c;for(const d in this._timers)clearTimeout(this._timers[d]),delete this._timers[d];for(const d in this._tiles)this._setTileReloadTimer(+d,this._tiles[d])}}update(t,n,c,d){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!c)return;this.updateCacheSize(t,n),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const p=this._source.type==="batched-model";let _,b=this._source.maxzoom;const E=this.map&&this.map.painter?this.map.painter._terrain:null;if(E&&E.sourceCache===this&&E.attenuationRange()){const R=E.attenuationRange()[0],D=Math.floor(R)-Math.log2(E.getDemUpscale());b>D&&(b=D)}if(this.used||this.usedForTerrain){if(this._source.tileID)_=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(R=>new s.aG(R.canonical.z,R.wrap,R.canonical.z,R.canonical.x,R.canonical.y));else if(this.tileCoverLift!==0){const R=t.clone();R.tileCoverLift=this.tileCoverLift,_=R.coveringTiles({tileSize:n||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:b,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:p}),this._source.minzoom<=1&&t.projection.name==="globe"&&(_.push(new s.aG(1,0,1,0,0)),_.push(new s.aG(1,0,1,1,0)),_.push(new s.aG(1,0,1,0,1)),_.push(new s.aG(1,0,1,1,1)))}else if(_=t.coveringTiles({tileSize:n||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:b,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:p}),this._source.hasTile){const R=this._source.hasTile.bind(this._source);_=_.filter(D=>R(D))}}else _=[];if(_.length>0&&this.castsShadows&&d&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!ah(this._source.type)){const R=t.coveringZoomLevel({tileSize:n||this._source.tileSize,roundZoom:this._source.roundZoom&&!c}),D=Math.min(R,this._source.maxzoom);if(p){const F=t.extendTileCover(_,D);for(const q of F)_.push(q)}else{const F=t.extendTileCover(_,D,d);for(const q of F)this._shadowCasterTiles[q.key]=!0,_.push(q)}}const I=this._updateRetainedTiles(_);if(ah(this._source.type)&&_.length!==0){const R={},D={},F=Object.keys(I);for(const U of F){const H=I[U],Z=this._tiles[U];if(!Z||Z.fadeEndTime&&Z.fadeEndTime<=s.q.now())continue;const J=this.findLoadedParent(H,Math.max(H.overscaledZ-Nr.maxOverzooming,this._source.minzoom));J&&(this._addTile(J.tileID),R[J.tileID.key]=J.tileID),D[U]=H}const q=_[_.length-1].overscaledZ;for(const U in this._tiles){const H=this._tiles[U];if(I[U]||!H.hasData())continue;let Z=H.tileID;for(;Z.overscaledZ>q;){Z=Z.scaledTo(Z.overscaledZ-1);const J=this._tiles[Z.key];if(J&&J.hasData()&&D[Z.key]){I[U]=H.tileID;break}}}for(const U in R)I[U]||(this._coveredTiles[U]=!0,I[U]=R[U])}for(const R in I)this._tiles[R].clearFadeHold();const A=s.bk(this._tiles,I);for(const R of A){const D=this._tiles[R];D.hasSymbolBuckets&&!D.holdingForFade()?D.setHoldDuration(this.map._fadeDuration):D.hasSymbolBuckets&&!D.symbolFadeFinished()||this._removeTile(+R)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){const n={};if(t.length===0)return n;const c={},d=t.reduce((I,A)=>Math.min(I,A.overscaledZ),1/0),p=t[0].overscaledZ,_=Math.max(p-Nr.maxOverzooming,this._source.minzoom),b=Math.max(p+Nr.maxUnderzooming,this._source.minzoom),E={};for(const I of t){const A=this._addTile(I);n[I.key]=I,A.hasData()||d<this._source.maxzoom&&(E[I.key]=I)}this._retainLoadedChildren(E,d,b,n);for(const I of t){let A=this._tiles[I.key];if(A.hasData())continue;if(I.canonical.z>=this._source.maxzoom){const D=I.children(this._source.maxzoom)[0],F=this.getTile(D);if(F&&F.hasData()){n[D.key]=D;continue}}else{const D=I.children(this._source.maxzoom);if(n[D[0].key]&&n[D[1].key]&&n[D[2].key]&&n[D[3].key])continue}let R=A.wasRequested();for(let D=I.overscaledZ-1;D>=_;--D){const F=I.scaledTo(D);if(c[F.key]||(c[F.key]=!0,A=this.getTile(F),!A&&R&&(A=this._addTile(F)),A&&(n[F.key]=F,R=A.wasRequested(),A.hasData())))break}}return n}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const n=[];let c,d=this._tiles[t].tileID;for(;d.overscaledZ>0;){if(d.key in this._loadedParentTiles){c=this._loadedParentTiles[d.key];break}n.push(d.key);const p=d.scaledTo(d.overscaledZ-1);if(c=this._getLoadedTile(p),c)break;d=p}for(const p of n)this._loadedParentTiles[p]=c}}_addTile(t){let n=this._tiles[t.key];if(n)return n.isExtraShadowCaster!==!0||this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),n;n=this._cache.getAndRemove(t),n&&(this._setTileReloadTimer(t.key,n),n.tileID=t,this._state.initializeTileState(n,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,n)));const c=!!n;if(!c){const d=this.map?this.map.painter:null,p=this._source.tileSize*t.overscaleFactor();n=this._source.type==="raster-array"?new uo(t,p,this.transform.tileZoom,d,this._isRaster):new co(t,p,this.transform.tileZoom,d,this._isRaster),this._loadTile(n,this._tileLoaded.bind(this,n,t.key,n.state))}return n?(n.uses++,this._tiles[t.key]=n,c||this._source.fire(new s.z("dataloading",{tile:n,coord:n.tileID,dataType:"source"})),n):null}_setTileReloadTimer(t,n){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const c=n.getExpiryTimeout();c&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},c))}_removeTile(t){const n=this._tiles[t];n&&(n.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),n.uses>0||(n.hasData()&&n.state!=="reloading"||n.state==="empty"?this._cache.add(n.tileID,n,n.getExpiryTimeout()):(n.aborted=!0,this._abortTile(n),this._unloadTile(n))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,n,c){const d=[],p=this.transform;if(!p)return d;const _=p.projection.name==="globe",b=s.at(p.center.lng);for(const E in this._tiles){const I=this._tiles[E];if(c&&I.clearQueryDebugViz(),I.holdingForFade())continue;let A;if(_){const R=I.tileID.canonical;if(R.z===0){const D=[Math.abs(s.aw(b,...Gt(R,-1))-b),Math.abs(s.aw(b,...Gt(R,1))-b)];A=[0,2*D.indexOf(Math.min(...D))-1]}else{const D=[Math.abs(s.aw(b,...Gt(R,-1))-b),Math.abs(s.aw(b,...Gt(R,0))-b),Math.abs(s.aw(b,...Gt(R,1))-b)];A=[D.indexOf(Math.min(...D))-1]}}else A=[0];for(const R of A){const D=t.containsTile(I,p,n,R);D&&d.push(D)}}return d}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,n){const c=this.getRenderableIds(t,n).map(p=>this._tiles[p].tileID),d=this.transform.projection.name==="globe";for(const p of c)p.projMatrix=this.transform.calculateProjMatrix(p.toUnwrapped()),p.expandedProjMatrix=d?this.transform.calculateProjMatrix(p.toUnwrapped(),!1,!0):p.projMatrix;return c}sortCoordinatesByDistance(t){const n=t.slice(),c=this.transform._camera.position,d=this.transform._camera.forward(),p={};for(const _ of n){const b=1/(1<<_.canonical.z);p[_.key]=((_.canonical.x+.5)*b+_.wrap-c[0])*d[0]+((_.canonical.y+.5)*b-c[1])*d[1]-c[2]*d[2]}return n.sort((_,b)=>p[_.key]-p[b.key]),n}hasTransition(){if(this._source.hasTransition())return!0;if(ah(this._source.type))for(const t in this._tiles){const n=this._tiles[t];if(n.fadeEndTime!==void 0&&n.fadeEndTime>=s.q.now())return!0}return!1}setFeatureState(t,n,c){this._state.updateState(t=t||"_geojsonTileLayer",n,c)}removeFeatureState(t,n,c){this._state.removeFeatureState(t=t||"_geojsonTileLayer",n,c)}getFeatureState(t,n){return this._state.getState(t=t||"_geojsonTileLayer",n)}setDependencies(t,n,c){const d=this._tiles[t];d&&d.setDependencies(n,c)}reloadTilesForDependencies(t,n){for(const c in this._tiles)this._tiles[c].hasDependency(t,n)&&this._reloadTile(+c,"reloading");this._cache.filter(c=>!c.hasDependency(t,n))}_preloadTiles(t,n){if(!this._sourceLoaded){const E=()=>{this._sourceLoaded&&(this._source.off("data",E),this._preloadTiles(t,n))};return void this._source.on("data",E)}const c=new Map,d=Array.isArray(t)?t:[t],p=this.map.painter.terrain,_=this.usedForTerrain&&p?p.getScaledDemTileSize():this._source.tileSize;for(const E of d){const I=E.coveringTiles({tileSize:_,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const A of I)c.set(A.key,A);this.usedForTerrain&&E.updateElevation(!1)}const b=Array.from(c.values());s.bl(b,(E,I)=>{const A=new co(E,this._source.tileSize*E.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(A,R=>{this._source.type==="raster-dem"&&A.dem&&this._backfillDEM(A),I(R,A)})},n)}}function Mi(l,t){const n=Math.abs(2*l.wrap)-+(l.wrap<0),c=Math.abs(2*t.wrap)-+(t.wrap<0);return l.overscaledZ-t.overscaledZ||c-n||t.canonical.y-l.canonical.y||t.canonical.x-l.canonical.x}function ah(l){return l==="raster"||l==="image"||l==="video"||l==="custom"}function Gt(l,t){const n=1<<l.z;return[l.x/n+t,(l.x+1)/n+t]}Nr.maxOverzooming=10,Nr.maxUnderzooming=3;class bf{constructor(t){this.style=t,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const t=!1,n=!1;for(const c in this.style._mergedLayers){const d=this.style._mergedLayers[c];if(d.type==="fill-extrusion")this.layers.push({layer:d,visible:t,visibilityChanged:n});else if(d.type==="model"){const p=this.style.getLayerSource(d);p&&p.type==="batched-model"&&this.layers.push({layer:d,visible:t,visibilityChanged:n})}}}onNewFrame(t){this.layersGotHidden=!1;for(const n of this.layers){const c=n.layer;let d=!1;c.type==="fill-extrusion"?d=!c.isHidden(t)&&c.paint.get("fill-extrusion-opacity")>0:c.type==="model"&&(d=!c.isHidden(t)&&c.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!d&&n.visible,n.visible=d}}updateZOffset(t,n){this.currentBuildingBuckets=[];for(const d of this.layers){const p=d.layer,_=this.style.getLayerSourceCache(p);let b=1;p.type==="fill-extrusion"&&(b=d.visible?p.paint.get("fill-extrusion-vertical-scale"):0);let E=_?_.getTile(n):null;if(!E&&_&&n.canonical.z>_.getSource().minzoom){let I=n.scaledTo(Math.min(_.getSource().maxzoom,n.overscaledZ-1));for(;I.overscaledZ>=_.getSource().minzoom&&(E=_.getTile(I),!E&&I.overscaledZ!==0);)I=I.scaledTo(I.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:E?E.getBucket(p):null,tileID:E?E.tileID:n,verticalScale:b})}t.hasAnyZOffset=!1;let c=!1;for(let d=0;d<t.symbolInstances.length;d++){const p=t.symbolInstances.get(d),_=p.zOffset,b=this._getHeightAtTileOffset(n,p.tileAnchorX,p.tileAnchorY);p.zOffset=b!==Number.NEGATIVE_INFINITY?b:_,c||_===p.zOffset||(c=!0),t.hasAnyZOffset||p.zOffset===0||(t.hasAnyZOffset=!0)}c&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,n,c,d){let p=n,_=c;if(t.canonical.z!==d.canonical.z){const b=d.canonical,E=1/(1<<t.canonical.z-b.z);p=(n+t.canonical.x*s.ag)*E-b.x*s.ag|0,_=(c+t.canonical.y*s.ag)*E-b.y*s.ag|0}return{tileX:p,tileY:_}}_getHeightAtTileOffset(t,n,c){let d,p;for(let _=0;_<this.layers.length;++_){if(this.layers[_].layer.type!=="fill-extrusion")continue;const{bucket:b,tileID:E,verticalScale:I}=this.currentBuildingBuckets[_];if(!b)continue;const{tileX:A,tileY:R}=this._mapCoordToOverlappingTile(t,n,c,E),D=b.getHeightAtTileCoord(A,R);D&&D.height!==void 0&&(D.hidden?d=D.height:p=Math.max(D.height*I,p||0))}if(p!==void 0)return p;for(let _=0;_<this.layers.length;++_){const b=this.layers[_];if(b.layer.type!=="model"||!b.visible)continue;const{bucket:E,tileID:I}=this.currentBuildingBuckets[_];if(!E)continue;const{tileX:A,tileY:R}=this._mapCoordToOverlappingTile(t,n,c,I),D=E.getHeightAtTileCoord(A,R);if(D&&!D.hidden)return D.height===void 0&&d!==void 0?Math.min(D.maxHeight,d)*D.verticalScale:D.height?D.height*D.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function Oc(l,t){const n={};for(const c in l)c!=="ref"&&(n[c]=l[c]);return s.bm.forEach(c=>{c in t&&(n[c]=t[c])}),n}function Fc(l){l=l.slice();const t=Object.create(null);for(let n=0;n<l.length;n++)t[l[n].id]=l[n];for(let n=0;n<l.length;n++)"ref"in l[n]&&(l[n]=Oc(l[n],t[l[n].ref]));return l}const li={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport"};function Bc(l,t,n){n.push({command:li.addSource,args:[l,t[l]]})}function Vo(l,t,n){t.push({command:li.removeSource,args:[l]}),n[l]=!0}function Ct(l,t,n,c){Vo(l,n,c),Bc(l,t,n)}function Ci(l,t,n){let c;for(c in l[n])if(l[n].hasOwnProperty(c)&&c!=="data"&&!s.bn(l[n][c],t[n][c]))return!1;for(c in t[n])if(t[n].hasOwnProperty(c)&&c!=="data"&&!s.bn(l[n][c],t[n][c]))return!1;return!0}function yi(l,t,n,c,d,p){let _;for(_ in t=t||{},l=l||{})l.hasOwnProperty(_)&&(s.bn(l[_],t[_])||n.push({command:p,args:[c,_,t[_],d]}));for(_ in t)t.hasOwnProperty(_)&&!l.hasOwnProperty(_)&&(s.bn(l[_],t[_])||n.push({command:p,args:[c,_,t[_],d]}))}function Yn(l){return l.id}function qs(l,t){return l[t.id]=t,l}class Ti{constructor(t,n){this.reset(t,n)}reset(t,n){this.points=t||[],this._distances=[0];for(let c=1;c<this.points.length;c++)this._distances[c]=this._distances[c-1]+this.points[c].dist(this.points[c-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(n||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=s.aw(t,0,1);let n=1,c=this._distances[n];const d=t*this.paddedLength+this.padding;for(;c<d&&n<this._distances.length;)c=this._distances[++n];const p=n-1,_=this._distances[p],b=c-_,E=b>0?(d-_)/b:0;return this.points[p].mult(1-E).add(this.points[n].mult(E))}}class gl{constructor(t,n,c){const d=this.boxCells=[],p=this.circleCells=[];this.xCellCount=Math.ceil(t/c),this.yCellCount=Math.ceil(n/c);for(let _=0;_<this.xCellCount*this.yCellCount;_++)d.push([]),p.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=n,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/n,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,n,c,d,p){this._forEachCell(n,c,d,p,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(n),this.bboxes.push(c),this.bboxes.push(d),this.bboxes.push(p)}insertCircle(t,n,c,d){this._forEachCell(n-d,c-d,n+d,c+d,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(n),this.circles.push(c),this.circles.push(d)}_insertBoxCell(t,n,c,d,p,_){this.boxCells[p].push(_)}_insertCircleCell(t,n,c,d,p,_){this.circleCells[p].push(_)}_query(t,n,c,d,p,_){if(c<0||t>this.width||d<0||n>this.height)return!p&&[];const b=[];if(t<=0&&n<=0&&this.width<=c&&this.height<=d){if(p)return!0;for(let E=0;E<this.boxKeys.length;E++)b.push({key:this.boxKeys[E],x1:this.bboxes[4*E],y1:this.bboxes[4*E+1],x2:this.bboxes[4*E+2],y2:this.bboxes[4*E+3]});for(let E=0;E<this.circleKeys.length;E++){const I=this.circles[3*E],A=this.circles[3*E+1],R=this.circles[3*E+2];b.push({key:this.circleKeys[E],x1:I-R,y1:A-R,x2:I+R,y2:A+R})}return _?b.filter(_):b}return this._forEachCell(t,n,c,d,this._queryCell,b,{hitTest:p,seenUids:{box:{},circle:{}}},_),p?b.length>0:b}_queryCircle(t,n,c,d,p){const _=t-c,b=t+c,E=n-c,I=n+c;if(b<0||_>this.width||I<0||E>this.height)return!d&&[];const A=[];return this._forEachCell(_,E,b,I,this._queryCellCircle,A,{hitTest:d,circle:{x:t,y:n,radius:c},seenUids:{box:{},circle:{}}},p),d?A.length>0:A}query(t,n,c,d,p){return this._query(t,n,c,d,!1,p)}hitTest(t,n,c,d,p){return this._query(t,n,c,d,!0,p)}hitTestCircle(t,n,c,d){return this._queryCircle(t,n,c,!0,d)}_queryCell(t,n,c,d,p,_,b,E){const I=b.seenUids,A=this.boxCells[p];if(A!==null){const D=this.bboxes;for(const F of A)if(!I.box[F]){I.box[F]=!0;const q=4*F;if(t<=D[q+2]&&n<=D[q+3]&&c>=D[q+0]&&d>=D[q+1]&&(!E||E(this.boxKeys[F]))){if(b.hitTest)return _.push(!0),!0;_.push({key:this.boxKeys[F],x1:D[q],y1:D[q+1],x2:D[q+2],y2:D[q+3]})}}}const R=this.circleCells[p];if(R!==null){const D=this.circles;for(const F of R)if(!I.circle[F]){I.circle[F]=!0;const q=3*F;if(this._circleAndRectCollide(D[q],D[q+1],D[q+2],t,n,c,d)&&(!E||E(this.circleKeys[F]))){if(b.hitTest)return _.push(!0),!0;{const U=D[q],H=D[q+1],Z=D[q+2];_.push({key:this.circleKeys[F],x1:U-Z,y1:H-Z,x2:U+Z,y2:H+Z})}}}}}_queryCellCircle(t,n,c,d,p,_,b,E){const I=b.circle,A=b.seenUids,R=this.boxCells[p];if(R!==null){const F=this.bboxes;for(const q of R)if(!A.box[q]){A.box[q]=!0;const U=4*q;if(this._circleAndRectCollide(I.x,I.y,I.radius,F[U+0],F[U+1],F[U+2],F[U+3])&&(!E||E(this.boxKeys[q])))return _.push(!0),!0}}const D=this.circleCells[p];if(D!==null){const F=this.circles;for(const q of D)if(!A.circle[q]){A.circle[q]=!0;const U=3*q;if(this._circlesCollide(F[U],F[U+1],F[U+2],I.x,I.y,I.radius)&&(!E||E(this.circleKeys[q])))return _.push(!0),!0}}}_forEachCell(t,n,c,d,p,_,b,E){const I=this._convertToXCellCoord(t),A=this._convertToYCellCoord(n),R=this._convertToXCellCoord(c),D=this._convertToYCellCoord(d);for(let F=I;F<=R;F++)for(let q=A;q<=D;q++)if(p.call(this,t,n,c,d,this.xCellCount*q+F,_,b,E))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,n,c,d,p,_){const b=d-t,E=p-n,I=c+_;return I*I>b*b+E*E}_circleAndRectCollide(t,n,c,d,p,_,b){const E=(_-d)/2,I=Math.abs(t-(d+E));if(I>E+c)return!1;const A=(b-p)/2,R=Math.abs(n-(p+A));if(R>A+c)return!1;if(I<=E||R<=A)return!0;const D=I-E,F=R-A;return D*D+F*F<=c*c}}const _s={unknown:0,flipRequired:1,flipNotRequired:2},yl=Math.tan(85*Math.PI/180);function Vn(l,t,n,c,d,p,_){const b=s.ab.mat4.create();if(n)if(p.name==="globe"){const E=s.bo(d,t);s.ab.mat4.multiply(b,b,E)}else{const E=s.ab.mat2.invert([],_);b[0]=E[0],b[1]=E[1],b[4]=E[2],b[5]=E[3],c||s.ab.mat4.rotateZ(b,b,d.angle)}else s.ab.mat4.multiply(b,d.labelPlaneMatrix,l);return b}function on(l,t,n,c,d,p,_){const b=Vn(l,t,n,c,d,p,_);return p.name==="globe"&&n||(b[2]=b[6]=b[10]=b[14]=0),b}function lh(l,t,n,c,d,p,_){if(n){if(p.name==="globe"){const b=Vn(l,t,n,c,d,p,_);return s.ab.mat4.invert(b,b),s.ab.mat4.multiply(b,l,b),b}{const b=s.ab.mat4.clone(l),E=s.ab.mat4.identity([]);return E[0]=_[0],E[1]=_[1],E[4]=_[2],E[5]=_[3],s.ab.mat4.multiply(b,b,E),c||s.ab.mat4.rotateZ(b,b,-d.angle),b}}return d.glCoordMatrix}function fr(l,t,n,c){const d=[l,t,n,1];n?s.ab.vec4.transformMat4(d,d,c):Vr(d,d,c);const p=d[3];return d[0]/=p,d[1]/=p,d[2]/=p,d}function Nc(l,t){return Math.min(.5+l/t*.5,1.5)}function xl(l,t){const n=l[0]/l[3],c=l[1]/l[3];return n>=-t[0]&&n<=t[0]&&c>=-t[1]&&c<=t[1]}function Vc(l,t,n,c,d,p,_,b,E,I){const A=n.transform,R=c?l.textSizeData:l.iconSizeData,D=s.bp(R,n.transform.zoom),F=A.projection.name==="globe",q=[256/n.width*2+1,256/n.height*2+1],U=c?l.text.dynamicLayoutVertexArray:l.icon.dynamicLayoutVertexArray;U.clear();let H=null;F&&(H=c?l.text.globeExtVertexArray:l.icon.globeExtVertexArray);const Z=l.lineVertexArray,J=c?l.text.placedSymbolArray:l.icon.placedSymbolArray,re=n.transform.width/n.transform.height;let ne,de=!1;for(let le=0;le<J.length;le++){const he=J.get(le),{numGlyphs:ae,writingMode:ge}=he;if(ge!==s.bq.vertical||de||ne===s.bq.horizontal||(de=!0),ne=ge,(he.hidden||ge===s.bq.vertical)&&!de){nn(ae,U);continue}de=!1;const Te=new s.P(he.tileAnchorX,he.tileAnchorY);let{x:Ue,y:Le,z:He}=A.projection.projectTilePoint(Te.x,Te.y,I.canonical);if(E){const[Xe,nt,lt]=E(Te);Ue+=Xe,Le+=nt,He+=lt}const Ze=[Ue,Le,He,1];if(s.ab.vec4.transformMat4(Ze,Ze,t),!xl(Ze,q)){nn(ae,U);continue}const ze=Ze[3],je=Nc(n.transform.getCameraToCenterDistance(A.projection),ze),it=s.br(R,D,he),Ce=_?it/je:it*je,Ye=fr(Ue,Le,He,d);if(Ye[3]<=0){nn(ae,U);continue}let Ge={};const ut=_?null:E,Je=gs(he,Ce,!1,b,t,d,p,l.glyphOffsetArray,Z,U,H,Ye,Te,Ge,re,ut,A.projection,I,_);de=Je.useVertical,ut&&Je.needsFlipping&&(Ge={}),(Je.notEnoughRoom||de||Je.needsFlipping&&gs(he,Ce,!0,b,t,d,p,l.glyphOffsetArray,Z,U,H,Ye,Te,Ge,re,ut,A.projection,I,_).notEnoughRoom)&&nn(ae,U)}c?(l.text.dynamicLayoutVertexBuffer.updateData(U),H&&l.text.globeExtVertexBuffer&&l.text.globeExtVertexBuffer.updateData(H)):(l.icon.dynamicLayoutVertexBuffer.updateData(U),H&&l.icon.globeExtVertexBuffer&&l.icon.globeExtVertexBuffer.updateData(H))}function vl(l,t,n,c,d,p,_,b,E,I,A,R,D,F,q,U){const{lineStartIndex:H,glyphStartIndex:Z,segment:J}=b,re=Z+b.numGlyphs,ne=H+b.lineLength,de=t.getoffsetX(Z),le=t.getoffsetX(re-1),he=$s(l*de,n,c,d,p,_,J,H,ne,E,I,A,R,D,!0,F,q,U);if(!he)return null;const ae=$s(l*le,n,c,d,p,_,J,H,ne,E,I,A,R,D,!0,F,q,U);return ae?{first:he,last:ae}:null}function Kn(l,t,n,c){return l===s.bq.horizontal&&Math.abs(c)>Math.abs(n)?{useVertical:!0}:l===s.bq.vertical?c>0?{needsFlipping:!0}:null:t!==_s.unknown&&function(d,p){return d===0||Math.abs(p/d)>yl}(n,c)?t===_s.flipRequired?{needsFlipping:!0}:null:n<0?{needsFlipping:!0}:null}function gs(l,t,n,c,d,p,_,b,E,I,A,R,D,F,q,U,H,Z,J){const re=t/24,ne=l.lineOffsetX*re,de=l.lineOffsetY*re,{lineStartIndex:le,glyphStartIndex:he,numGlyphs:ae,segment:ge,writingMode:Te,flipState:Ue}=l,Le=le+l.lineLength,He=Ze=>{if(A){const[Ce,Ye,Ge]=Ze.up,ut=I.length;s.bs(A,ut+0,Ce,Ye,Ge),s.bs(A,ut+1,Ce,Ye,Ge),s.bs(A,ut+2,Ce,Ye,Ge),s.bs(A,ut+3,Ce,Ye,Ge)}const[ze,je,it]=Ze.point;s.bt(I,ze,je,it,Ze.angle)};if(ae>1){const Ze=vl(re,b,ne,de,n,R,D,l,E,p,F,U,!1,H,Z,J);if(!Ze)return{notEnoughRoom:!0};if(c&&!n){let[ze,je,it]=Ze.first.point,[Ce,Ye,Ge]=Ze.last.point;[ze,je]=fr(ze,je,it,_),[Ce,Ye]=fr(Ce,Ye,Ge,_);const ut=Kn(Te,Ue,(Ce-ze)*q,Ye-je);if(l.flipState=ut&&ut.needsFlipping?_s.flipRequired:_s.flipNotRequired,ut)return ut}He(Ze.first);for(let ze=he+1;ze<he+ae-1;ze++){const je=$s(re*b.getoffsetX(ze),ne,de,n,R,D,ge,le,Le,E,p,F,U,!1,!1,H,Z,J);if(!je)return I.length-=4*(ze-he),{notEnoughRoom:!0};He(je)}He(Ze.last)}else{if(c&&!n){const ze=fr(D.x,D.y,0,d),je=le+ge+1,it=new s.P(E.getx(je),E.gety(je)),Ce=fr(it.x,it.y,0,d),Ye=Ce[3]>0?Ce:ch(D,it,ze,1,d,void 0,H,Z.canonical),Ge=Kn(Te,Ue,(Ye[0]-ze[0])*q,Ye[1]-ze[1]);if(l.flipState=Ge&&Ge.needsFlipping?_s.flipRequired:_s.flipNotRequired,Ge)return Ge}const Ze=$s(re*b.getoffsetX(he),ne,de,n,R,D,ge,le,Le,E,p,F,U,!1,!1,H,Z,J);if(!Ze)return{notEnoughRoom:!0};He(Ze)}return{}}function Zn(l,t,n,c,d){const{x:p,y:_,z:b}=c.projectTilePoint(l.x,l.y,t);if(!d)return fr(p,_,b,n);const[E,I,A]=d(l);return fr(p+E,_+I,b+A,n)}function ch(l,t,n,c,d,p,_,b){const E=Zn(l.sub(t)._unit()._add(l),b,d,_,p);return s.ab.vec3.sub(E,n,E),s.ab.vec3.normalize(E,E),s.ab.vec3.scaleAndAdd(E,n,E,c)}function $s(l,t,n,c,d,p,_,b,E,I,A,R,D,F,q,U,H,Z){const J=c?l-t:l+t;let re=J>0?1:-1,ne=0;c&&(re*=-1,ne=Math.PI),re<0&&(ne+=Math.PI);let de=b+_+(re>0?0:1)|0,le=d,he=d,ae=0,ge=0;const Te=Math.abs(J),Ue=[],Le=[];let He=p,Ze=He;const ze=()=>ch(Ze,He,he,Te-ae+1,A,D,U,H.canonical);for(;ae+ge<=Te;){if(de+=re,de<b||de>=E)return null;if(he=le,Ze=He,Ue.push(he),F&&Le.push(Ze),He=new s.P(I.getx(de),I.gety(de)),le=R[de],!le){const nt=Zn(He,H.canonical,A,U,D);le=nt[3]>0?R[de]=nt:ze()}ae+=ge,ge=s.ab.vec3.distance(he,le)}q&&D&&(R[de]&&(le=ze(),ge=s.ab.vec3.distance(he,le)),R[de]=le);const je=(Te-ae)/ge,it=He.sub(Ze)._mult(je)._add(Ze),Ce=s.ab.vec3.sub([],le,he),Ye=s.ab.vec3.scaleAndAdd([],he,Ce,je);let Ge=[0,0,1],ut=Ce[0],Je=Ce[1];if(Z&&(Ge=U.upVector(H.canonical,it.x,it.y),Ge[0]!==0||Ge[1]!==0||Ge[2]!==1)){const nt=[Ge[2],0,-Ge[0]],lt=s.ab.vec3.cross([],Ge,nt);s.ab.vec3.normalize(nt,nt),s.ab.vec3.normalize(lt,lt),ut=s.ab.vec3.dot(Ce,nt),Je=s.ab.vec3.dot(Ce,lt)}if(n){const nt=s.ab.vec3.cross([],Ge,Ce);s.ab.vec3.normalize(nt,nt),s.ab.vec3.scaleAndAdd(Ye,Ye,nt,n*re)}const Xe=ne+Math.atan2(Je,ut);return Ue.push(Ye),F&&Le.push(it),{point:Ye,angle:Xe,path:Ue,tilePath:Le,up:Ge}}function nn(l,t){const n=t.length,c=n+4*l;t.resize(c),t.float32.fill(-1/0,4*n,4*c)}function Vr(l,t,n){const c=t[0],d=t[1];return l[0]=n[0]*c+n[4]*d+n[12],l[1]=n[1]*c+n[5]*d+n[13],l[3]=n[3]*c+n[7]*d+n[15],l}const Un=100;class pn{constructor(t,n,c=new gl(t.width+200,t.height+200,25),d=new gl(t.width+200,t.height+200,25)){this.transform=t,this.grid=c,this.ignoredGrid=d,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+Un,this.screenBottomBoundary=t.height+Un,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=n}placeCollisionBox(t,n,c,d,p,_,b,E){let I=c.projectedAnchorX,A=c.projectedAnchorY,R=c.projectedAnchorZ;const D=c.elevation,F=c.tileID,q=t.getProjection();if(D&&F){const[le,he,ae]=q.upVector(F.canonical,c.tileAnchorX,c.tileAnchorY),ge=q.upVectorScale(F.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;I+=le*D*ge,A+=he*D*ge,R+=ae*D*ge}const U=this.projectAndGetPerspectiveRatio(b,I,A,R,c.tileID,q.name==="globe"||!!D||this.transform.pitch>0,q),H=_*U.perspectiveRatio,Z=(c.x1*n+d.x-c.padding)*H+U.point.x,J=(c.y1*n+d.y-c.padding)*H+U.point.y,re=(c.x2*n+d.x+c.padding)*H+U.point.x,ne=(c.y2*n+d.y+c.padding)*H+U.point.y,de=U.perspectiveRatio<=.55||U.occluded;return!this.isInsideGrid(Z,J,re,ne)||!p&&this.grid.hitTest(Z,J,re,ne,E)||de?{box:[],offscreen:!1,occluded:U.occluded}:{box:[Z,J,re,ne],offscreen:this.isOffscreen(Z,J,re,ne),occluded:!1}}placeCollisionCircles(t,n,c,d,p,_,b,E,I,A,R,D,F,q,U){const H=[],Z=this.transform.elevation,J=t.getProjection(),re=Z?Z.getAtTileOffsetFunc(U,this.transform.center.lat,this.transform.worldSize,J):null,ne=new s.P(c.tileAnchorX,c.tileAnchorY);let{x:de,y:le,z:he}=J.projectTilePoint(ne.x,ne.y,U.canonical);if(re){const[it,Ce,Ye]=re(ne);de+=it,le+=Ce,he+=Ye}const ae=J.name==="globe",ge=this.projectAndGetPerspectiveRatio(b,de,le,he,U,ae||!!Z||this.transform.pitch>0,J),{perspectiveRatio:Te}=ge,Ue=(R?_/Te:_*Te)/s.bw,Le=fr(de,le,he,E),He=ge.signedDistanceFromCamera>0?vl(Ue,p,c.lineOffsetX*Ue,c.lineOffsetY*Ue,!1,Le,ne,c,d,E,{},Z&&!R?re:null,R&&!!Z,J,U,R):null;let Ze=!1,ze=!1,je=!0;if(He&&!ge.occluded){const it=.5*F*Te+q,Ce=new s.P(-100,-100),Ye=new s.P(this.screenRightBoundary,this.screenBottomBoundary),Ge=new Ti,{first:ut,last:Je}=He,Xe=ut.path.length;let nt=[];for(let Et=Xe-1;Et>=1;Et--)nt.push(ut.path[Et]);for(let Et=1;Et<Je.path.length;Et++)nt.push(Je.path[Et]);const lt=2.5*it;I&&(nt=nt.map(([Et,$t,kt],Bt)=>(re&&!ae&&(kt=re(Bt<Xe-1?ut.tilePath[Xe-1-Bt]:Je.tilePath[Bt-Xe+2])[2]),fr(Et,$t,kt,I))),nt.some(Et=>Et[3]<=0)&&(nt=[]));let bt=[];if(nt.length>0){let Et=1/0,$t=-1/0,kt=1/0,Bt=-1/0;for(const Yt of nt)Et=Math.min(Et,Yt[0]),kt=Math.min(kt,Yt[1]),$t=Math.max($t,Yt[0]),Bt=Math.max(Bt,Yt[1]);$t>=Ce.x&&Et<=Ye.x&&Bt>=Ce.y&&kt<=Ye.y&&(bt=[nt.map(Yt=>new s.P(Yt[0],Yt[1]))],(Et<Ce.x||$t>Ye.x||kt<Ce.y||Bt>Ye.y)&&(bt=s.bu(bt,Ce.x,Ce.y,Ye.x,Ye.y)))}for(const Et of bt){Ge.reset(Et,.25*it);let $t=0;$t=Ge.length<=.5*it?1:Math.ceil(Ge.paddedLength/lt)+1;for(let kt=0;kt<$t;kt++){const Bt=kt/Math.max($t-1,1),Yt=Ge.lerp(Bt),fi=Yt.x+Un,zi=Yt.y+Un;H.push(fi,zi,it,0);const Qi=fi-it,ji=zi-it,Qt=fi+it,xi=zi+it;if(je=je&&this.isOffscreen(Qi,ji,Qt,xi),ze=ze||this.isInsideGrid(Qi,ji,Qt,xi),!n&&this.grid.hitTestCircle(fi,zi,it,D)&&(Ze=!0,!A))return{circles:[],offscreen:!1,collisionDetected:Ze,occluded:!1}}}}return{circles:!A&&Ze||!ze?[]:H,offscreen:je,collisionDetected:Ze,occluded:ge.occluded}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const n=[];let c=1/0,d=1/0,p=-1/0,_=-1/0;for(const A of t){const R=new s.P(A.x+Un,A.y+Un);c=Math.min(c,R.x),d=Math.min(d,R.y),p=Math.max(p,R.x),_=Math.max(_,R.y),n.push(R)}const b=this.grid.query(c,d,p,_).concat(this.ignoredGrid.query(c,d,p,_)),E={},I={};for(const A of b){const R=A.key;if(E[R.bucketInstanceId]===void 0&&(E[R.bucketInstanceId]={}),E[R.bucketInstanceId][R.featureIndex])continue;const D=[new s.P(A.x1,A.y1),new s.P(A.x2,A.y1),new s.P(A.x2,A.y2),new s.P(A.x1,A.y2)];s.bv(n,D)&&(E[R.bucketInstanceId][R.featureIndex]=!0,I[R.bucketInstanceId]===void 0&&(I[R.bucketInstanceId]=[]),I[R.bucketInstanceId].push(R.featureIndex))}return I}insertCollisionBox(t,n,c,d,p){(n?this.ignoredGrid:this.grid).insert({bucketInstanceId:c,featureIndex:d,collisionGroupID:p},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,n,c,d,p){const _=n?this.ignoredGrid:this.grid,b={bucketInstanceId:c,featureIndex:d,collisionGroupID:p};for(let E=0;E<t.length;E+=4)_.insertCircle(b,t[E],t[E+1],t[E+2])}projectAndGetPerspectiveRatio(t,n,c,d,p,_,b){const E=[n,c,d,1];let I=!1;d||this.transform.pitch>0?(s.ab.vec4.transformMat4(E,E,t),this.fogState&&p&&b.name!=="globe"&&(I=function(D,F,q,U,H,Z){const J=Z.calculateFogTileMatrix(H),re=[F,q,U];return s.ab.vec3.transformMat4(re,re,J),ve(D,s.ab.vec3.length(re),Z.pitch,Z._fov)}(this.fogState,n,c,d,p.toUnwrapped(),this.transform)>.9)):Vr(E,E,t);const A=E[3];return{point:new s.P((E[0]/A+1)/2*this.transform.width+Un,(-E[1]/A+1)/2*this.transform.height+Un),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(b)/A*.5,1.5),signedDistanceFromCamera:A,occluded:_&&E[2]>A||I}}isOffscreen(t,n,c,d){return c<Un||t>=this.screenRightBoundary||d<Un||n>this.screenBottomBoundary}isInsideGrid(t,n,c,d){return c>=0&&t<this.gridRightBoundary&&d>=0&&n<this.gridBottomBoundary}getViewportMatrix(){const t=s.ab.mat4.identity([]);return s.ab.mat4.translate(t,t,[-100,-100,0]),t}}function bl(l,t,n){const c=t.createTileMatrix(l,l.worldSize,n.toUnwrapped());return s.ab.mat4.multiply(new Float32Array(16),l.projMatrix,c)}function Jr(l,t,n){if(t.projection.name===n.projection.name)return l.projMatrix;const c=n.clone();return c.setProjection(t.projection),bl(c,t.getProjection(),l)}function Uo(l,t,n){return t.name===n.projection.name?l.projMatrix:bl(n,t,l)}class wl{constructor(t,n,c,d){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?n:-n))):d&&c?1:0,this.placed=c}isHidden(){return this.opacity===0&&!this.placed}}class Qr{constructor(t,n,c,d,p,_=!1){this.text=new wl(t?t.text:null,n,c,p),this.icon=new wl(t?t.icon:null,n,d,p),this.clipped=_}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class uh{constructor(t,n,c,d=!1){this.text=t,this.icon=n,this.skipFade=c,this.clipped=d}}class Zs{constructor(){this.invProjMatrix=s.ab.mat4.create(),this.viewportMatrix=s.ab.mat4.create(),this.circles=[]}}class Gm{constructor(t,n,c,d,p){this.bucketInstanceId=t,this.featureIndex=n,this.sourceLayerIndex=c,this.bucketIndex=d,this.tileID=p}}class hh{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const n=++this.maxGroupID;this.collisionGroups[t]={ID:n,predicate:c=>c.collisionGroupID===n}}return this.collisionGroups[t]}}function pr(l,t,n,c,d){const{horizontalAlign:p,verticalAlign:_}=s.bD(l),b=-(p-.5)*t,E=-(_-.5)*n,I=s.bC(l,c);return new s.P(b+I[0]*d,E+I[1]*d)}function dh(l,t,n,c,d){const p=new s.P(l,t);return n&&p._rotate(c?d:-d),p}class Uc{constructor(t,n,c,d,p,_){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new pn(this.transform,p),this.buildingIndex=_,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=n,this.retainedQueryData={},this.collisionGroups=new hh(c),this.collisionCircleArrays={},this.prevPlacement=d,d&&(d.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,n,c,d,p=1){const _=c.getBucket(n),b=c.latestFeatureIndex;if(!_||!b||n.fqid!==_.layerIds[0])return;const E=_.layers[0].layout,I=_.layers[0].paint,A=c.collisionBoxArray,R=Math.pow(2,this.transform.zoom-c.tileID.overscaledZ),D=c.tileSize/s.ag,F=c.tileID.toUnwrapped();this.transform.setProjection(_.projection);const q=(U=c.tileID,H=_.getProjection(),Z=this.transform,H.name===this.projection?Z.calculateProjMatrix(U.toUnwrapped()):bl(Z,H,U));var U,H,Z;const J=E.get("text-pitch-alignment")==="map",re=E.get("text-rotation-alignment")==="map";n.compileFilter(n.options);const ne=n.dynamicFilter(),de=n.dynamicFilterNeedsFeature(),le=this.transform.calculatePixelsToTileUnitsMatrix(c),he=on(q,c.tileID.canonical,J,re,this.transform,_.getProjection(),le);let ae=null;if(J){const it=lh(q,c.tileID.canonical,J,re,this.transform,_.getProjection(),le);ae=s.ab.mat4.multiply([],this.transform.labelPlaneMatrix,it)}let ge=null;ne&&c.latestFeatureIndex&&(ge={unwrappedTileID:F,dynamicFilter:ne,dynamicFilterNeedsFeature:de}),this.retainedQueryData[_.bucketInstanceId]=new Gm(_.bucketInstanceId,b,_.sourceLayerIndex,_.index,c.tileID);const[Te,Ue]=_.layers[0].layout.get("text-size-scale-range"),Le=s.aw(p,Te,Ue),[He,Ze]=E.get("icon-size-scale-range"),ze=s.aw(p,He,Ze),je={bucket:_,layout:E,paint:I,posMatrix:q,textLabelPlaneMatrix:he,labelToScreenMatrix:ae,clippingData:ge,scale:R,textPixelRatio:D,holdingForFade:c.holdingForFade(),collisionBoxArray:A,partiallyEvaluatedTextSize:s.bp(_.textSizeData,this.transform.zoom,Le),partiallyEvaluatedIconSize:s.bp(_.iconSizeData,this.transform.zoom,ze),collisionGroup:this.collisionGroups.get(_.sourceID),latestFeatureIndex:c.latestFeatureIndex};if(d)for(const it of _.sortKeyRanges){const{sortKey:Ce,symbolInstanceStart:Ye,symbolInstanceEnd:Ge}=it;t.push({sortKey:Ce,symbolInstanceStart:Ye,symbolInstanceEnd:Ge,parameters:je})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:_.symbolInstances.length,parameters:je})}attemptAnchorPlacement(t,n,c,d,p,_,b,E,I,A,R,D,F,q,U,H,Z,J){const{textOffset0:re,textOffset1:ne,crossTileID:de}=D,le=[re,ne],he=pr(t,c,d,le,p),ae=this.collisionIndex.placeCollisionBox(q,p,n,dh(he.x,he.y,_,b,this.transform.angle),R,E,I,A.predicate);if(H){const ge=q.getSymbolInstanceIconSize(J,this.transform.zoom,D.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(q,ge,H,dh(he.x,he.y,_,b,this.transform.angle),R,E,I,A.predicate).box.length===0)return}if(ae.box.length>0){let ge;return this.prevPlacement&&this.prevPlacement.variableOffsets[de]&&this.prevPlacement.placements[de]&&this.prevPlacement.placements[de].text&&(ge=this.prevPlacement.variableOffsets[de].anchor),this.variableOffsets[de]={textOffset:le,width:c,height:d,anchor:t,textScale:p,prevAnchor:ge},this.markUsedJustification(q,t,D,U),q.allowVerticalPlacement&&(this.markUsedOrientation(q,U,D),this.placedOrientations[de]=U),{shift:he,placedGlyphBoxes:ae}}}placeLayerBucketPart(t,n,c,d,p=1){const{bucket:_,layout:b,paint:E,posMatrix:I,textLabelPlaneMatrix:A,labelToScreenMatrix:R,clippingData:D,textPixelRatio:F,holdingForFade:q,collisionBoxArray:U,partiallyEvaluatedTextSize:H,partiallyEvaluatedIconSize:Z,collisionGroup:J,latestFeatureIndex:re}=t.parameters,ne=b.get("text-optional"),de=b.get("icon-optional"),le=b.get("text-allow-overlap"),he=b.get("icon-allow-overlap"),ae=b.get("text-rotation-alignment")==="map",ge=b.get("text-pitch-alignment")==="map",Te=b.get("symbol-z-elevate"),Ue=E.get("symbol-z-offset"),Le=b.get("symbol-elevation-reference")==="sea",[He,Ze]=b.get("text-size-scale-range"),[ze,je]=b.get("icon-size-scale-range"),it=s.aw(p,He,Ze),Ce=s.aw(p,ze,je);this.transform.setProjection(_.projection);let Ye=le&&(he||!_.hasIconData()||de),Ge=he&&(le||!_.hasTextData()||ne);const ut=!Ue.isConstant();!_.collisionArrays&&U&&_.deserializeCollisionBoxes(U),c&&d&&_.updateCollisionDebugBuffers(this.transform.zoom,U,it,Ce);const Je=(Xe,nt,lt)=>{const{crossTileID:bt,numVerticalGlyphVertices:Et}=Xe;let $t=null;if(D&&D.dynamicFilterNeedsFeature||ut){const Bi=this.retainedQueryData[_.bucketInstanceId];$t=re.loadFeature({featureIndex:Xe.featureIndex,bucketIndex:Bi.bucketIndex,sourceLayerIndex:Bi.sourceLayerIndex,layoutVertexArrayOffset:0})}if(D&&!(0,D.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},$t,this.retainedQueryData[_.bucketInstanceId].tileID.canonical,new s.P(Xe.tileAnchorX,Xe.tileAnchorY),this.transform.calculateDistanceTileData(D.unwrappedTileID)))return this.placements[bt]=new uh(!1,!1,!1,!0),void n.add(bt);const kt=Ue.evaluate($t,{});if(n.has(bt))return;if(q)return void(this.placements[bt]=new uh(!1,!1,!1));let Bt=!1,Yt=!1,fi=!0,zi=!1,Qi=!1,ji=null,Qt={box:null,offscreen:null,occluded:null},xi={box:null,offscreen:null,occluded:null},Lt=null,hi=null,Ei=null,Ai=0,Ki=0,Pn=0;lt.textFeatureIndex?Ai=lt.textFeatureIndex:Xe.useRuntimeCollisionCircles&&(Ai=Xe.featureIndex),lt.verticalTextFeatureIndex&&(Ki=lt.verticalTextFeatureIndex);const vn=Bi=>{Bi.tileID=this.retainedQueryData[_.bucketInstanceId].tileID;const Li=this.transform.elevation;Bi.elevation=Le?kt:kt+(Li?Li.getAtTileOffset(Bi.tileID,Bi.tileAnchorX,Bi.tileAnchorY):0),Bi.elevation+=Xe.zOffset},bn=lt.textBox;if(bn){vn(bn);const Bi=_i=>{let cn=s.bq.horizontal;if(_.allowVerticalPlacement&&!_i&&this.prevPlacement){const zn=this.prevPlacement.placedOrientations[bt];zn&&(this.placedOrientations[bt]=zn,cn=zn,this.markUsedOrientation(_,cn,Xe))}return cn},Li=(_i,cn)=>{if(_.allowVerticalPlacement&&Et>0&&lt.verticalTextBox){for(const zn of _.writingModes)if(zn===s.bq.vertical?(Qt=cn(),xi=Qt):Qt=_i(),Qt&&Qt.box&&Qt.box.length)break}else Qt=_i()};if(b.get("text-variable-anchor")){let _i=b.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[bt]){const Fi=this.prevPlacement.variableOffsets[bt];_i.indexOf(Fi.anchor)>0&&(_i=_i.filter(er=>er!==Fi.anchor),_i.unshift(Fi.anchor))}const cn=(Fi,er,Gr)=>{const Sr=_.getSymbolInstanceTextSize(H,Xe,this.transform.zoom,nt),gr=(Fi.x2-Fi.x1)*Sr+2*Fi.padding,Ss=(Fi.y2-Fi.y1)*Sr+2*Fi.padding,qr=Xe.hasIconTextFit&&!he?er:null;qr&&vn(qr);let Rr={box:[],offscreen:!1,occluded:!1};const aa=le?2*_i.length:_i.length;for(let Es=0;Es<aa;++Es){const la=this.attemptAnchorPlacement(_i[Es%_i.length],Fi,gr,Ss,Sr,ae,ge,F,I,J,Es>=_i.length,Xe,nt,_,Gr,qr,H,Z);if(la&&(Rr=la.placedGlyphBoxes,Rr&&Rr.box&&Rr.box.length)){Bt=!0,ji=la.shift;break}}return Rr};Li(()=>cn(bn,lt.iconBox,s.bq.horizontal),()=>{const Fi=lt.verticalTextBox;return Fi&&vn(Fi),_.allowVerticalPlacement&&!(Qt&&Qt.box&&Qt.box.length)&&Et>0&&Fi?cn(Fi,lt.verticalIconBox,s.bq.vertical):{box:null,offscreen:null,occluded:null}}),Qt&&(Bt=Qt.box,fi=Qt.offscreen,zi=Qt.occluded);const zn=Bi(!(!Qt||!Qt.box));if(!Bt&&this.prevPlacement){const Fi=this.prevPlacement.variableOffsets[bt];Fi&&(this.variableOffsets[bt]=Fi,this.markUsedJustification(_,Fi.anchor,Xe,zn))}}else{const _i=(cn,zn)=>{const Fi=_.getSymbolInstanceTextSize(H,Xe,this.transform.zoom,nt,p),er=this.collisionIndex.placeCollisionBox(_,Fi,cn,new s.P(0,0),le,F,I,J.predicate);return er&&er.box&&er.box.length&&(this.markUsedOrientation(_,zn,Xe),this.placedOrientations[bt]=zn),er};Li(()=>_i(bn,s.bq.horizontal),()=>{const cn=lt.verticalTextBox;return _.allowVerticalPlacement&&Et>0&&cn?(vn(cn),_i(cn,s.bq.vertical)):{box:null,offscreen:null,occluded:null}}),Bi(!!(Qt&&Qt.box&&Qt.box.length))}}if(Lt=Qt,Bt=Lt&&Lt.box&&Lt.box.length>0,fi=Lt&&Lt.offscreen,zi=Lt&&Lt.occluded,Xe.useRuntimeCollisionCircles){const Bi=_.text.placedSymbolArray.get(Xe.centerJustifiedTextSymbolIndex>=0?Xe.centerJustifiedTextSymbolIndex:Xe.verticalPlacedTextSymbolIndex),Li=s.br(_.textSizeData,H,Bi),_i=b.get("text-padding");hi=this.collisionIndex.placeCollisionCircles(_,le,Bi,_.lineVertexArray,_.glyphOffsetArray,Li,I,A,R,c,ge,J.predicate,Xe.collisionCircleDiameter*Li/s.bw,_i,this.retainedQueryData[_.bucketInstanceId].tileID),Bt=le||hi.circles.length>0&&!hi.collisionDetected,fi=fi&&hi.offscreen,zi=hi.occluded}if(lt.iconFeatureIndex&&(Pn=lt.iconFeatureIndex),lt.iconBox){const Bi=Li=>{vn(Li);const _i=Xe.hasIconTextFit&&ji?dh(ji.x,ji.y,ae,ge,this.transform.angle):new s.P(0,0),cn=_.getSymbolInstanceIconSize(Z,this.transform.zoom,Xe.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(_,cn,Li,_i,he,F,I,J.predicate)};xi&&xi.box&&xi.box.length&&lt.verticalIconBox?(Ei=Bi(lt.verticalIconBox),Yt=Ei.box.length>0):(Ei=Bi(lt.iconBox),Yt=Ei.box.length>0),fi=fi&&Ei.offscreen,Qi=Ei.occluded}const zr=ne||Xe.numHorizontalGlyphVertices===0&&Et===0,Qn=de||Xe.numIconVertices===0;if(zr||Qn?Qn?zr||(Yt=Yt&&Bt):Bt=Yt&&Bt:Yt=Bt=Yt&&Bt,Bt&&Lt&&Lt.box&&this.collisionIndex.insertCollisionBox(Lt.box,b.get("text-ignore-placement"),_.bucketInstanceId,xi&&xi.box&&Ki?Ki:Ai,J.ID),Yt&&Ei&&this.collisionIndex.insertCollisionBox(Ei.box,b.get("icon-ignore-placement"),_.bucketInstanceId,Pn,J.ID),hi&&(Bt&&this.collisionIndex.insertCollisionCircles(hi.circles,b.get("text-ignore-placement"),_.bucketInstanceId,Ai,J.ID),c)){const Bi=_.bucketInstanceId;let Li=this.collisionCircleArrays[Bi];Li===void 0&&(Li=this.collisionCircleArrays[Bi]=new Zs);for(let _i=0;_i<hi.circles.length;_i+=4)Li.circles.push(hi.circles[_i+0]),Li.circles.push(hi.circles[_i+1]),Li.circles.push(hi.circles[_i+2]),Li.circles.push(hi.collisionDetected?1:0)}const Ji=_.projection.name!=="globe";Ye=Ye&&(Ji||!zi),Ge=Ge&&(Ji||!Qi),this.placements[bt]=new uh(Bt||Ye,Yt||Ge,fi||_.justReloaded),n.add(bt)};if(Te&&this.buildingIndex&&(this.buildingIndex.updateZOffset(_,this.retainedQueryData[_.bucketInstanceId].tileID),_.updateZOffset()),_.sortFeaturesByY){const Xe=_.getSortedSymbolIndexes(this.transform.angle);for(let nt=Xe.length-1;nt>=0;--nt){const lt=Xe[nt];Je(_.symbolInstances.get(lt),lt,_.collisionArrays[lt])}_.hasAnyZOffset&&s.w(`${_.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(_.hasAnyZOffset){const Xe=_.getSortedIndexesByZOffset();for(let nt=0;nt<Xe.length;++nt){const lt=Xe[nt];Je(_.symbolInstances.get(lt),lt,_.collisionArrays[lt])}}else for(let Xe=t.symbolInstanceStart;Xe<t.symbolInstanceEnd;Xe++)Je(_.symbolInstances.get(Xe),Xe,_.collisionArrays[Xe]);if(c&&_.bucketInstanceId in this.collisionCircleArrays){const Xe=this.collisionCircleArrays[_.bucketInstanceId];s.ab.mat4.invert(Xe.invProjMatrix,I),Xe.viewportMatrix=this.collisionIndex.getViewportMatrix()}_.justReloaded=!1}markUsedJustification(t,n,c,d){const{leftJustifiedTextSymbolIndex:p,centerJustifiedTextSymbolIndex:_,rightJustifiedTextSymbolIndex:b,verticalPlacedTextSymbolIndex:E,crossTileID:I}=c,A=s.bB(n),R=d===s.bq.vertical?E:A==="left"?p:A==="center"?_:A==="right"?b:-1;p>=0&&(t.text.placedSymbolArray.get(p).crossTileID=R>=0&&p!==R?0:I),_>=0&&(t.text.placedSymbolArray.get(_).crossTileID=R>=0&&_!==R?0:I),b>=0&&(t.text.placedSymbolArray.get(b).crossTileID=R>=0&&b!==R?0:I),E>=0&&(t.text.placedSymbolArray.get(E).crossTileID=R>=0&&E!==R?0:I)}markUsedOrientation(t,n,c){const d=n===s.bq.horizontal||n===s.bq.horizontalOnly?n:0,p=n===s.bq.vertical?n:0,{leftJustifiedTextSymbolIndex:_,centerJustifiedTextSymbolIndex:b,rightJustifiedTextSymbolIndex:E,verticalPlacedTextSymbolIndex:I}=c,A=t.text.placedSymbolArray;_>=0&&(A.get(_).placedOrientation=d),b>=0&&(A.get(b).placedOrientation=d),E>=0&&(A.get(E).placedOrientation=d),I>=0&&(A.get(I).placedOrientation=p)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const n=this.prevPlacement;let c=!1;this.prevZoomAdjustment=n?n.zoomAdjustment(this.transform.zoom):0;const d=n?n.symbolFadeChange(t):1,p=n?n.opacities:{},_=n?n.variableOffsets:{},b=n?n.placedOrientations:{};for(const E in this.placements){const I=this.placements[E],A=p[E];A?(this.opacities[E]=new Qr(A,d,I.text,I.icon,null,I.clipped),c=c||I.text!==A.text.placed||I.icon!==A.icon.placed):(this.opacities[E]=new Qr(null,d,I.text,I.icon,I.skipFade,I.clipped),c=c||I.text||I.icon)}for(const E in p){const I=p[E];if(!this.opacities[E]){const A=new Qr(I,d,!1,!1);A.isHidden()||(this.opacities[E]=A,c=c||I.text.placed||I.icon.placed)}}for(const E in _)this.variableOffsets[E]||!this.opacities[E]||this.opacities[E].isHidden()||(this.variableOffsets[E]=_[E]);for(const E in b)this.placedOrientations[E]||!this.opacities[E]||this.opacities[E].isHidden()||(this.placedOrientations[E]=b[E]);c?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=n?n.lastPlacementChangeTime:t)}updateLayerOpacities(t,n,c,d){const p=new Set;for(const _ of n){const b=_.getBucket(t);b&&_.latestFeatureIndex&&t.fqid===b.layerIds[0]&&(this.updateBucketOpacities(b,p,_,_.collisionBoxArray,c,d,_.tileID,t.scope),b.layers[0].layout.get("symbol-z-elevate")&&this.buildingIndex&&(this.buildingIndex.updateZOffset(b,_.tileID),b.updateZOffset()))}}updateBucketOpacities(t,n,c,d,p,_,b,E){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const I=t.layers[0].layout,A=t.layers[0].paint,R=!!t.layers[0].dynamicFilter(),D=new Qr(null,0,!1,!1,!0),F=I.get("text-allow-overlap"),q=I.get("icon-allow-overlap"),U=I.get("text-variable-anchor"),H=I.get("text-rotation-alignment")==="map",Z=I.get("text-pitch-alignment")==="map",J=A.get("symbol-z-offset"),re=I.get("symbol-elevation-reference")==="sea",ne=!J.isConstant(),de=new Qr(null,0,F&&(q||!t.hasIconData()||I.get("icon-optional")),q&&(F||!t.hasTextData()||I.get("text-optional")),!0);!t.collisionArrays&&d&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(d);const le=(ae,ge,Te)=>{for(let Ue=0;Ue<ge/4;Ue++)ae.opacityVertexArray.emplaceBack(Te)};let he=0;_&&t.updateReplacement(b,_);for(let ae=0;ae<t.symbolInstances.length;ae++){const ge=t.symbolInstances.get(ae),{numHorizontalGlyphVertices:Te,numVerticalGlyphVertices:Ue,crossTileID:Le,numIconVertices:He,tileAnchorX:Ze,tileAnchorY:ze}=ge;let je=null;const it=this.retainedQueryData[t.bucketInstanceId];ne&&ge&&it&&(je=c.latestFeatureIndex.loadFeature({featureIndex:ge.featureIndex,bucketIndex:it.bucketIndex,sourceLayerIndex:it.sourceLayerIndex,layoutVertexArrayOffset:0}));const Ce=J.evaluate(je,{}),Ye=n.has(Le);let Ge=this.opacities[Le];Ye?Ge=D:Ge||(Ge=de,this.opacities[Le]=Ge),n.add(Le);const ut=Te>0||Ue>0,Je=He>0,Xe=this.placedOrientations[Le],nt=Xe===s.bq.vertical,lt=Xe===s.bq.horizontal||Xe===s.bq.horizontalOnly;!ut&&!Je||Ge.isHidden()||he++;let bt=!1;if((ut||Je)&&_)for(const Et of t.activeReplacements){if(s.bx(Et,p,s.by.Symbol,E)||Et.min.x>Ze||Ze>Et.max.x||Et.min.y>ze||ze>Et.max.y)continue;const $t=s.bz(Ze,ze,b.canonical,Et.footprintTileId.canonical);if(bt=s.bA($t,Et.footprint),bt)break}if(ut){const Et=bt?Hs:fh(Ge.text);le(t.text,Te,nt?Hs:Et),le(t.text,Ue,lt?Hs:Et);const $t=Ge.text.isHidden(),{leftJustifiedTextSymbolIndex:kt,centerJustifiedTextSymbolIndex:Bt,rightJustifiedTextSymbolIndex:Yt,verticalPlacedTextSymbolIndex:fi}=ge,zi=t.text.placedSymbolArray,Qi=$t||nt?1:0;kt>=0&&(zi.get(kt).hidden=Qi),Bt>=0&&(zi.get(Bt).hidden=Qi),Yt>=0&&(zi.get(Yt).hidden=Qi),fi>=0&&(zi.get(fi).hidden=$t||lt?1:0);const ji=this.variableOffsets[Le];ji&&this.markUsedJustification(t,ji.anchor,ge,Xe);const Qt=this.placedOrientations[Le];Qt&&(this.markUsedJustification(t,"left",ge,Qt),this.markUsedOrientation(t,Qt,ge))}if(Je){const Et=bt?Hs:fh(Ge.icon),{placedIconSymbolIndex:$t,verticalPlacedIconSymbolIndex:kt}=ge,Bt=t.icon.placedSymbolArray,Yt=Ge.icon.isHidden()?1:0;$t>=0&&(le(t.icon,He,nt?Hs:Et),Bt.get($t).hidden=Yt),kt>=0&&(le(t.icon,ge.numVerticalIconVertices,lt?Hs:Et),Bt.get(kt).hidden=Yt)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const Et=t.collisionArrays[ae];if(Et){let $t=new s.P(0,0),kt=!0;if(Et.textBox||Et.verticalTextBox){if(U){const Yt=this.variableOffsets[Le];Yt?($t=pr(Yt.anchor,Yt.width,Yt.height,Yt.textOffset,Yt.textScale),H&&$t._rotate(Z?this.transform.angle:-this.transform.angle)):kt=!1}R&&(kt=!Ge.clipped),Et.textBox&&Tl(t.textCollisionBox.collisionVertexArray,Ge.text.placed,!kt||nt,Ce,re,$t.x,$t.y),Et.verticalTextBox&&Tl(t.textCollisionBox.collisionVertexArray,Ge.text.placed,!kt||lt,Ce,re,$t.x,$t.y)}const Bt=kt&&!!(!lt&&Et.verticalIconBox);Et.iconBox&&Tl(t.iconCollisionBox.collisionVertexArray,Ge.icon.placed,Bt,Ce,re,ge.hasIconTextFit?$t.x:0,ge.hasIconTextFit?$t.y:0),Et.verticalIconBox&&Tl(t.iconCollisionBox.collisionVertexArray,Ge.icon.placed,!Bt,Ce,re,ge.hasIconTextFit?$t.x:0,ge.hasIconTextFit?$t.y:0)}}}if(t.fullyClipped=he===0,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){const ae=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=ae.invProjMatrix,t.placementViewportMatrix=ae.viewportMatrix,t.collisionCircleArray=ae.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,n){const c=this.zoomAtLastRecencyCheck===n?1-this.zoomAdjustment(n):1;return this.zoomAtLastRecencyCheck=n,this.commitTime+this.fadeDuration*c>t}setStale(){this.stale=!0}}function Tl(l,t,n,c,d,p,_){l.emplaceBack(t?1:0,n?1:0,p||0,_||0,c,d?1:0),l.emplaceBack(t?1:0,n?1:0,p||0,_||0,c,d?1:0),l.emplaceBack(t?1:0,n?1:0,p||0,_||0,c,d?1:0),l.emplaceBack(t?1:0,n?1:0,p||0,_||0,c,d?1:0)}const Sl=Math.pow(2,25),qm=Math.pow(2,24),$m=Math.pow(2,17),El=Math.pow(2,16),Ml=Math.pow(2,9),Zm=Math.pow(2,8),Ca=Math.pow(2,1);function fh(l){if(l.opacity===0&&!l.placed)return 0;if(l.opacity===1&&l.placed)return 4294967295;const t=l.placed?1:0,n=Math.floor(127*l.opacity);return n*Sl+t*qm+n*$m+t*El+n*Ml+t*Zm+n*Ca+t}const Hs=0;class ho{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&t.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,n,c,d,p,_){const b=this._bucketParts;for(;this._currentTileIndex<t.length;)if(n.getBucketParts(b,d,t[this._currentTileIndex],this._sortAcrossTiles,_),this._currentTileIndex++,p())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,b.sort((E,I)=>E.sortKey-I.sortKey));this._currentPartIndex<b.length;){const E=b[this._currentPartIndex];if(n.placeLayerBucketPart(E,this._seenCrossTileIDs,c,E.symbolInstanceStart===0,_),this._currentPartIndex++,p())return!0}return!1}}class Hm{constructor(t,n,c,d,p,_,b,E,I){this.placement=new Uc(t,p,_,b,E,I),this._currentPlacementIndex=n.length-1,this._forceFullPlacement=c,this._showCollisionBoxes=d,this._done=!1}isDone(){return this._done}continuePlacement(t,n,c,d,p){const _=s.q.now(),b=()=>{const E=s.q.now()-_;return!this._forceFullPlacement&&E>2};for(;this._currentPlacementIndex>=0;){const E=n[t[this._currentPlacementIndex]],I=this.placement.collisionIndex.transform.zoom;if(E.type==="symbol"&&(!E.minzoom||E.minzoom<=I)&&(!E.maxzoom||E.maxzoom>I)){const A=E,R=A.layout.get("symbol-z-elevate"),D=A.layout.get("symbol-sort-key").constantOr(1)!==void 0,F=A.layout.get("symbol-z-order"),q=F==="viewport-y"||F==="auto"&&!(F!=="viewport-y"&&D),U=A.layout.get("text-allow-overlap")||A.layout.get("icon-allow-overlap")||A.layout.get("text-ignore-placement")||A.layout.get("icon-ignore-placement"),H=q&&U,Z=this._inProgressLayer=this._inProgressLayer||new ho(A),J=s.aC(E.source,E.scope);if(Z.continuePlacement(R||H?d[J]:c[J],this.placement,this._showCollisionBoxes,E,b,p))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const ph=512/s.ag/2;class Wm{constructor(t,n,c){this.tileID=t,this.bucketInstanceId=c,this.index=new s.bE(n.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const d=t.canonical.x*s.ag,p=t.canonical.y*s.ag;for(let _=0;_<n.length;_++){const{key:b,crossTileID:E,tileAnchorX:I,tileAnchorY:A}=n.get(_),R=Math.floor((d+I)*ph),D=Math.floor((p+A)*ph);this.index.add(R,D),this.keys.push(b),this.crossTileIDs.push(E)}this.index.finish()}findMatches(t,n,c){const d=this.tileID.canonical.z<n.canonical.z?1:Math.pow(2,this.tileID.canonical.z-n.canonical.z),p=ph/Math.pow(2,n.canonical.z-this.tileID.canonical.z),_=n.canonical.x*s.ag,b=n.canonical.y*s.ag;for(let E=0;E<t.length;E++){const I=t.get(E);if(I.crossTileID)continue;const{key:A,tileAnchorX:R,tileAnchorY:D}=I,F=Math.floor((_+R)*p),q=Math.floor((b+D)*p),U=this.index.range(F-d,q-d,F+d,q+d);for(const H of U){const Z=this.crossTileIDs[H];if(this.keys[H]===A&&!c.has(Z)){c.add(Z),I.crossTileID=Z;break}}}}}class wf{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Xm{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const n=Math.round((t-this.lng)/360);if(n!==0)for(const c in this.indexes){const d=this.indexes[c],p={};for(const _ in d){const b=d[_];b.tileID=b.tileID.unwrapTo(b.tileID.wrap+n),p[b.tileID.key]=b}this.indexes[c]=p}this.lng=t}addBucket(t,n,c){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===n.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let p=0;p<n.symbolInstances.length;p++)n.symbolInstances.get(p).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);const d=this.usedCrossTileIDs[t.overscaledZ];for(const p in this.indexes){const _=this.indexes[p];if(Number(p)>t.overscaledZ)for(const b in _){const E=_[b];E.tileID.isChildOf(t)&&E.findMatches(n.symbolInstances,t,d)}else{const b=_[t.scaledTo(Number(p)).key];b&&b.findMatches(n.symbolInstances,t,d)}}for(let p=0;p<n.symbolInstances.length;p++){const _=n.symbolInstances.get(p);_.crossTileID||(_.crossTileID=c.generate(),d.add(_.crossTileID))}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new Wm(t,n.symbolInstances,n.bucketInstanceId),!0}removeBucketCrossTileIDs(t,n){for(const c of n.crossTileIDs)this.usedCrossTileIDs[t].delete(c)}removeStaleBuckets(t){let n=!1;for(const c in this.indexes){const d=this.indexes[c];for(const p in d)t[d[p].bucketInstanceId]||(this.removeBucketCrossTileIDs(c,d[p]),delete d[p],n=!0)}return n}}class mh{constructor(){this.layerIndexes={},this.crossTileIDs=new wf,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,n,c,d){let p=this.layerIndexes[t.fqid];p===void 0&&(p=this.layerIndexes[t.fqid]=new Xm);let _=!1;const b={};d.name!=="globe"&&p.handleWrapJump(c);for(const E of n){const I=E.getBucket(t);I&&t.fqid===I.layerIds[0]&&(I.bucketInstanceId||(I.bucketInstanceId=++this.maxBucketInstanceId),p.addBucket(E.tileID,I,this.crossTileIDs)&&(_=!0),b[I.bucketInstanceId]=!0)}return p.removeStaleBuckets(b)&&(_=!0),_}pruneUnusedLayers(t){const n={};t.forEach(c=>{n[c]=!0});for(const c in this.layerIndexes)n[c]||delete this.layerIndexes[c]}}const jo=771;class oi{constructor(t,n,c,d){this.blendFunction=t,this.blendColor=n,this.mask=c,this.blendEquation=d}}oi.Replace=[1,0,1,0],oi.disabled=new oi(oi.Replace,s.aj.transparent,[!1,!1,!1,!1]),oi.unblended=new oi(oi.Replace,s.aj.transparent,[!0,!0,!0,!0]),oi.alphaBlended=new oi([1,jo,1,jo],s.aj.transparent,[!0,!0,!0,!0]),oi.alphaBlendedNonPremultiplied=new oi([770,jo,770,jo],s.aj.transparent,[!0,!0,!0,!0]),oi.multiply=new oi([774,0,774,0],s.aj.transparent,[!0,!0,!0,!0]);class Ft{constructor(t,n,c){this.func=t,this.mask=n,this.range=c}}Ft.ReadOnly=!1,Ft.ReadWrite=!0,Ft.disabled=new Ft(519,Ft.ReadOnly,[0,1]);const jc=7680;class Ht{constructor(t,n,c,d,p,_){this.test=t,this.ref=n,this.mask=c,this.fail=d,this.depthFail=p,this.pass=_}}Ht.disabled=new Ht({func:519,mask:0},0,0,jc,jc,jc);const Pa=1029,Gc=2305;class Xt{constructor(t,n,c){this.enable=t,this.mode=n,this.frontFace=c}}function za(l,t){const n=s.bG(l,3);s.ab.mat4.fromQuat(l,t),s.bI(l,3,n)}function Go(l,t){const n=s.ab.quat.identity([]);return s.ab.quat.rotateZ(n,n,-t),s.ab.quat.rotateX(n,n,-l),n}function _h(l,t){const n=[l[0],l[1],0],c=[t[0],t[1],0];if(s.ab.vec3.length(n)>=1e-15){const _=s.ab.vec3.normalize([],n);s.ab.vec3.scale(c,_,s.ab.vec3.dot(c,_)),t[0]=c[0],t[1]=c[1]}const d=s.ab.vec3.cross([],t,l);if(s.ab.vec3.len(d)<1e-15)return null;const p=Math.atan2(-d[1],d[0]);return Go(Math.atan2(Math.sqrt(l[0]*l[0]+l[1]*l[1]),-l[2]),p)}Xt.disabled=new Xt(!1,Pa,Gc),Xt.backCCW=new Xt(!0,Pa,Gc),Xt.backCW=new Xt(!0,Pa,2304),Xt.frontCW=new Xt(!0,1028,2304),Xt.frontCCW=new Xt(!0,1028,Gc);class qc{constructor(t,n){this.position=t,this.orientation=n}get position(){return this._position}set position(t){if(t){const n=t instanceof s.aa?t:new s.aa(t[0],t[1],t[2]);this._renderWorldCopies&&(n.x=s.bF(n.x,0,1)),this._position=n}else this._position=null}lookAtPoint(t,n){if(this.orientation=null,!this.position)return;const c=this.position,d=this._elevation?this._elevation.getAtPointOrZero(s.aa.fromLngLat(t)):0,p=s.aa.fromLngLat(t,d),_=[p.x-c.x,p.y-c.y,p.z-c.z];n||(n=[0,0,1]),n[2]=Math.abs(n[2]),this.orientation=_h(_,n)}setPitchBearing(t,n){this.orientation=Go(s.ai(t),s.ai(-n))}}class mr{constructor(t,n){this._transform=s.ab.mat4.identity([]),this.orientation=n,this.position=t}get mercatorPosition(){const t=this.position;return new s.aa(t[0],t[1],t[2])}get position(){const t=s.bG(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var n;t&&s.bI(this._transform,3,[(n=t)[0],n[1],n[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||s.ab.quat.identity([]),t&&za(this._transform,this._orientation)}getPitchBearing(){const t=this.forward(),n=this.right();return{bearing:Math.atan2(-n[1],n[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,n){this._orientation=Go(t,n),za(this._transform,this._orientation)}forward(){const t=s.bG(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){const t=s.bG(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){const t=s.bG(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,n){const c=new Float64Array(16);return s.ab.mat4.invert(c,this.getWorldToCamera(t,n)),c}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,n,c){const d=this.position;s.ab.vec3.scale(d,d,-t);const p=new Float64Array(16);return s.ab.mat4.fromScaling(p,[c,c,c]),s.ab.mat4.translate(p,p,d),p[10]*=n,p}getWorldToCamera(t,n){const c=new Float64Array(16),d=new Float64Array(4),p=this.position;return s.ab.quat.conjugate(d,this._orientation),s.ab.vec3.scale(p,p,-t),s.ab.mat4.fromQuat(c,d),s.ab.mat4.translate(c,c,p),c[1]*=-1,c[5]*=-1,c[9]*=-1,c[13]*=-1,c[8]*=n,c[9]*=n,c[10]*=n,c[11]*=n,c}getCameraToClipPerspective(t,n,c,d){const p=new Float64Array(16);return s.ab.mat4.perspective(p,t,n,c,d),p}getCameraToClipOrthographic(t,n,c,d,p,_){const b=new Float64Array(16);return s.ab.mat4.ortho(b,t,n,c,d,p,_),b}getDistanceToElevation(t,n=!1){const c=t===0?0:s.bH(t,n?s.aS(this.position[1]):this.position[1]),d=this.forward();return(c-this.position[2])/d[2]}clone(){return new mr([...this.position],[...this.orientation])}}const Hn={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class mt{constructor(t=0,n=0,c=0,d=0){if(isNaN(t)||t<0||isNaN(n)||n<0||isNaN(c)||c<0||isNaN(d)||d<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=n,this.left=c,this.right=d}interpolate(t,n,c){return n.top!=null&&t.top!=null&&(this.top=s.af(t.top,n.top,c)),n.bottom!=null&&t.bottom!=null&&(this.bottom=s.af(t.bottom,n.bottom,c)),n.left!=null&&t.left!=null&&(this.left=s.af(t.left,n.left,c)),n.right!=null&&t.right!=null&&(this.right=s.af(t.right,n.right,c)),this}getCenter(t,n){const c=s.aw((this.left+t-this.right)/2,0,t),d=s.aw((this.top+n-this.bottom)/2,0,n);return new s.P(c,d)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new mt(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const gh=(l,t,n)=>(1-n)*l+n*t,$c=l=>l*l*l*l*l;class Il{constructor(t,n,c,d,p,_,b){this.tileSize=512,this._renderWorldCopies=p===void 0||p,this._minZoom=t||0,this._maxZoom=n||22,this._minPitch=c??0,this._maxPitch=d??60,this.setProjection(_),this.setMaxBounds(b),this.width=0,this.height=0,this._center=new s.bO(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new mt,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new mr,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1}clone(){const t=new Il(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(t,n=!1){const c=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||c)&&this._updateCameraOnTerrain(),(t||c)&&this._constrainCamera(n),this._calcMatrices()}getProjection(){return s.ay(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};const n=this.projection?this.getProjection():void 0;this.projection=s.bP(this.projectionOptions);const c=this.getProjection(),d=!s.bn(n,c);return d&&this._calcMatrices(),this.mercatorFromTransition=!1,d}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){const t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=s.bP({name:"mercator"});const n=t!==this.projection.name;return n&&this._calcMatrices(),n}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return s.bH(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new s.P(this.width,this.height)}get bearing(){return s.bF(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){const n=-t*Math.PI/180;this.angle!==n&&(this._unmodified=!1,this.angle=n,this._calcMatrices(),this.rotationMatrix=s.ab.mat2.create(),s.ab.mat2.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const n=s.aw(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==n&&(this._unmodified=!1,this._pitch=n,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){const t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=s.ai(t),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){const n=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==n&&(this._unmodified=!1,this._setZoom(n),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(t){this._tileCoverLift!==t&&(this._tileCoverLift=t)}_updateCameraOnTerrain(){const t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,n=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!n||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const c=this._elevation;n||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&c.exaggeration()&&this._centerAltitudeValidForExaggeration!==c.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*c.exaggeration(),this._centerAltitudeValidForExaggeration=c.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=c.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){this._centerAltitudeValidForExaggeration!==void 0&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const t=this._elevation,n=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],c=this.horizonLineFromTop();let d=0,p=0;for(let _=0;_<n.length;_++){const b=new s.P(n[_][0]*this.width,c+n[_][1]*(this.height-c)),E=t.pointCoordinate(b);if(!E)continue;const I=1/Math.hypot(E[0]-this._camera.position[0],E[1]-this._camera.position[1]);d+=E[3]*I,p+=I}return p===0?NaN:d/p}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const t=this._seaLevelZoom,n=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),c=this.pixelsPerMeter/this.worldSize*n,d=this._mercatorZfromZoom(t),p=this._mercatorZfromZoom(this._maxZoom),_=Math.max(d-c,p);this._setZoom(this._zoomFromMercatorZ(_))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(t){const n=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude()));let c;c=t.z<this._camera.position[2]?[n.x,n.y,n.z]:[t.x,t.y,t.z];const d=s.ab.vec3.length(s.ab.vec3.sub([],this._camera.position,c));return s.aw(this._zoomFromMercatorZ(d),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let n=!1;if(t.orientation&&!s.ab.quat.exactEquals(t.orientation,this._camera.orientation)&&(n=this._setCameraOrientation(t.orientation)),t.position){const c=[t.position.x,t.position.y,t.position.z];s.ab.vec3.exactEquals(c,this._camera.position)||(this._setCameraPosition(c),n=!0)}n&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const t=this._camera.position,n=new qc;return n.position=new s.aa(t[0],t[1],t[2]),n.orientation=this._camera.orientation,n._elevation=this.elevation,n._renderWorldCopies=this.renderWorldCopies,n}_setCameraOrientation(t){if(!s.ab.quat.length(t))return!1;s.ab.quat.normalize(t,t);const n=s.ab.vec3.transformQuat([],[0,0,-1],t),c=s.ab.vec3.transformQuat([],[0,-1,0],t);if(c[2]<0)return!1;const d=_h(n,c);return!!d&&(this._camera.orientation=d,!0)}_setCameraPosition(t){const n=this.zoomScale(this.minZoom)*this.tileSize,c=this.zoomScale(this.maxZoom)*this.tileSize,d=this.cameraToCenterDistance;t[2]=s.aw(t[2],d/c,d/n),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,n,c){this._unmodified=!1,this._edgeInsets.interpolate(t,n,c),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const n=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,n)}getVisibleUnwrappedCoordinates(t){const n=[new s.bQ(0,t)];if(this.renderWorldCopies){const c=this.pointCoordinate(new s.P(0,0)),d=this.pointCoordinate(new s.P(this.width,0)),p=this.pointCoordinate(new s.P(this.width,this.height)),_=this.pointCoordinate(new s.P(0,this.height)),b=Math.floor(Math.min(c.x,d.x,p.x,_.x)),E=Math.floor(Math.max(c.x,d.x,p.x,_.x)),I=1;for(let A=b-I;A<=E+I;A++)A!==0&&n.push(new s.bQ(A,t))}return n}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(t,n,c){let d=[];const p=c!==void 0,_=!p;if(_&&this.zoom<n||p&&c[0]===0&&c[1]===0)return d;const b=new Set,E=(A,R,D,F,q)=>{const U=s.c5(R,A,D,F,q);b.has(U)||(d.push(new s.aG(A,R,D,F,q)),b.add(U))};for(let A=0;A<t.length;A++){const R=t[A];if(_&&R.canonical.z!==n)continue;const D=R.canonical,F=R.overscaledZ,q=R.wrap,U=1<<D.z,H=D.x+1<U,Z=D.x>0,J=D.y+1<U,re=D.y>0,ne=R.wrap-(Z?0:1),de=R.wrap+(H?0:1),le=Z?D.x-1:U-1,he=H?D.x+1:0;if(p)c[0]<0?(E(F,de,D.z,he,D.y),c[1]<0&&J&&(E(F,q,D.z,D.x,D.y+1),E(F,de,D.z,he,D.y+1)),c[1]>0&&re&&(E(F,q,D.z,D.x,D.y-1),E(F,de,D.z,he,D.y-1))):c[0]>0?(E(F,ne,D.z,le,D.y),c[1]<0&&J&&(E(F,q,D.z,D.x,D.y+1),E(F,ne,D.z,le,D.y+1)),c[1]>0&&re&&(E(F,q,D.z,D.x,D.y-1),E(F,ne,D.z,le,D.y-1))):c[1]<0&&J?E(F,q,D.z,D.x,D.y+1):re&&E(F,q,D.z,D.x,D.y-1);else{const ae=R.visibleQuadrants;1&ae&&(E(F,ne,D.z,le,D.y),re&&(E(F,q,D.z,D.x,D.y-1),E(F,ne,D.z,le,D.y-1))),2&ae&&(E(F,de,D.z,he,D.y),re&&(E(F,q,D.z,D.x,D.y-1),E(F,de,D.z,he,D.y-1))),4&ae&&(E(F,ne,D.z,le,D.y),J&&(E(F,q,D.z,D.x,D.y+1),E(F,ne,D.z,le,D.y+1))),8&ae&&(E(F,de,D.z,he,D.y),J&&(E(F,q,D.z,D.x,D.y+1),E(F,de,D.z,he,D.y+1)))}}const I=[];for(const A of d)d.some(R=>A.isChildOf(R))||I.push(A);if(d=I.filter(A=>!t.some(R=>!!(A.overscaledZ<n&&R.isChildOf(A))||A.equals(R)||A.isChildOf(R))),_){const A=1<<n,R=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),D=[A*R.x,A*R.y],F=4,q=F*F;d=d.filter(U=>{const H=U.canonical.x+.5-D[0],Z=U.canonical.y+.5-D[1];return H*H+Z*Z<q})}return d}coveringTiles(t){let n=this.coveringZoomLevel(t);const c=n,d=this.elevation&&this.elevation.exaggeration(),p=d&&!t.isTerrainDEM,_=this.projection.name==="mercator";if(t.minzoom!==void 0&&n<t.minzoom)return[];t.maxzoom!==void 0&&n>t.maxzoom&&(n=t.maxzoom);const b=this.locationCoordinate(this.center),E=this.center.lat,I=1<<n,A=[I*b.x,I*b.y,0],R=this.projection.name==="globe",D=!R,F=s.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,n,D),q=R?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),U=I*s.bH(1,this.center.lat),H=this._camera.position[2]/s.bH(1,this.center.lat),Z=[I*q.x,I*q.y,H*(D?1:U)],J=R||d,re=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),ne=this.isLODDisabled(!0)?n:0;let de;if(this._elevation&&t.isTerrainDEM)de=1e4*this._elevation.exaggeration();else if(this._elevation){const Ce=this._elevation.getMinMaxForVisibleTiles();de=Ce?Ce.max:this._centerAltitude}else de=this._centerAltitude;const le=t.isTerrainDEM?-de:this._elevation?this._elevation.getMinElevationBelowMSL():0,he=this.projection.isReprojectedInTileSpace?s.bS(this):1,ae=Ce=>{const Ge=new s.aa(Ce.x+25e-6,Ce.y,Ce.z),ut=new s.aa(Ce.x,Ce.y+25e-6,Ce.z),Je=Ce.toLngLat(),Xe=Ge.toLngLat(),nt=ut.toLngLat(),lt=this.locationCoordinate(Je),bt=this.locationCoordinate(Xe),Et=this.locationCoordinate(nt),$t=Math.hypot(bt.x-lt.x,bt.y-lt.y),kt=Math.hypot(Et.x-lt.x,Et.y-lt.y);return Math.sqrt($t*kt)*he/25e-6},ge=Ce=>{const Ye=de,Ge=le;return{aabb:s.bV(this,I,0,0,0,Ce,Ge,Ye,this.projection),zoom:0,x:0,y:0,minZ:Ge,maxZ:Ye,wrap:Ce,fullyVisible:!1}},Te=[];let Ue=[];const Le=n,He=t.reparseOverscaled?c:n,Ze=(H-this._centerAltitude)*U,ze=Ce=>{if(!this._elevation||!Ce.tileID||!_)return;const Ye=this._elevation.getMinMaxForTile(Ce.tileID),Ge=Ce.aabb;Ye?(Ge.min[2]=Ye.min,Ge.max[2]=Ye.max,Ge.center[2]=(Ge.min[2]+Ge.max[2])/2):(Ce.shouldSplit=it(Ce),Ce.shouldSplit||(Ge.min[2]=Ge.max[2]=Ge.center[2]=this._centerAltitude))},je=(Ce,Ye)=>{if(.707*Ye<Ce)return 1;const Ge=Ye/Ce;return Ge/(1.4144271570014144+(Math.pow(1.1,Ge-1.4144271570014144+1)-1)/(1.1-1)-1)},it=Ce=>{if(Ce.zoom<ne)return!0;if(Ce.zoom===Le)return!1;if(Ce.shouldSplit!=null)return Ce.shouldSplit;const Ye=Ce.aabb.distanceX(Z),Ge=Ce.aabb.distanceY(Z);let ut=Ze,Je=1;if(R){ut=Ce.aabb.distanceZ(Z);const kt=Math.pow(2,Ce.zoom),Bt=s.aS((Ce.y+1)/kt),Yt=s.aS(Ce.y/kt),fi=Math.min(Math.max(E,Bt),Yt),zi=s.c9(fi)/s.c9(E);if(Je=fi===E?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,zi/this._mercatorScaleRatio),this.zoom<=s.c6&&Ce.zoom===Le-1&&zi>=.9)return!0}else if(p&&(ut=Ce.aabb.distanceZ(Z)*U),this.projection.isReprojectedInTileSpace&&c<=5){const kt=Math.pow(2,Ce.zoom),Bt=ae(new s.aa((Ce.x+.5)/kt,(Ce.y+.5)/kt));Je=Bt>.85?1:Bt}if(!_){const kt=Math.sqrt(Ye*Ye+Ge*Ge+ut*ut);let Bt=(1<<Le-Ce.zoom)*re*Je;return Bt*=je(Math.max(ut,Ze),kt),kt<Bt}let Xe=Number.MAX_VALUE,nt=0;const lt=Ce.aabb.getCorners(),bt=[];for(const kt of lt){s.ab.vec3.sub(bt,kt,Z),R||(p?bt[2]*=U:bt[2]=Ze);const Bt=s.ab.vec3.dot(bt,this._camera.forward());Bt<Xe&&(Xe=Bt,nt=Math.abs(bt[2]))}let Et=(1<<Le-Ce.zoom)*re*Je;if(Et*=je(Math.max(nt,Ze),Xe),Xe<Et)return!0;const $t=Ce.aabb.closestPoint(A);return $t[0]===A[0]&&$t[1]===A[1]};if(this.renderWorldCopies)for(let Ce=1;Ce<=3;Ce++)Te.push(ge(-Ce)),Te.push(ge(Ce));for(Te.push(ge(0));Te.length>0;){const Ce=Te.pop(),Ye=Ce.x,Ge=Ce.y;let ut=Ce.fullyVisible;const Je=()=>this.projection.name==="globe"&&(Ce.y===0||Ce.y===(1<<Ce.zoom)-1);if(!ut){let Xe=J?Ce.aabb.intersects(F):Ce.aabb.intersectsFlat(F);if(Xe===0&&Je()){const nt=new s.bT(Ce.zoom,Ye,Ge);Xe=s.bU(this,I,nt,!0).intersects(F)}if(Xe===0)continue;ut=Xe===2}if(Ce.zoom!==Le&&it(Ce))for(let Xe=0;Xe<4;Xe++){const nt=(Ye<<1)+Xe%2,lt=(Ge<<1)+(Xe>>1),bt={aabb:_?Ce.aabb.quadrant(Xe):s.bV(this,I,Ce.zoom+1,nt,lt,Ce.wrap,Ce.minZ,Ce.maxZ,this.projection),zoom:Ce.zoom+1,x:nt,y:lt,wrap:Ce.wrap,fullyVisible:ut,tileID:void 0,shouldSplit:void 0,minZ:Ce.minZ,maxZ:Ce.maxZ};p&&!R&&(bt.tileID=new s.aG(Ce.zoom+1===Le?He:Ce.zoom+1,Ce.wrap,Ce.zoom+1,nt,lt),ze(bt)),Te.push(bt)}else{const Xe=Ce.zoom===Le?He:Ce.zoom;if(t.minzoom&&t.minzoom>Xe)continue;let nt=0;if(!ut){let $t=J?Ce.aabb.intersectsPrecise(F):Ce.aabb.intersectsPreciseFlat(F);if($t===0&&Je()){const kt=new s.bT(Ce.zoom,Ye,Ge);$t=s.bU(this,I,kt,!0).intersectsPrecise(F)}if($t===0)continue;if(t.calculateQuadrantVisibility)if(F.containsPoint(Ce.aabb.center))nt=15;else for(let kt=0;kt<4;kt++)Ce.aabb.quadrant(kt).intersects(F)!==0&&(nt|=1<<kt)}const lt=A[0]-(.5+Ye+(Ce.wrap<<Ce.zoom))*(1<<n-Ce.zoom),bt=A[1]-.5-Ge,Et=Ce.tileID?Ce.tileID:new s.aG(Xe,Ce.wrap,Ce.zoom,Ye,Ge);t.calculateQuadrantVisibility&&(Et.visibleQuadrants=nt),Ue.push({tileID:Et,distanceSq:lt*lt+bt*bt})}}if(this.fogCullDistSq){const Ce=this.fogCullDistSq,Ye=this.horizonLineFromTop();Ue=Ue.filter(Ge=>{const ut=[0,0,0,1],Je=[s.ag,s.ag,0,1],Xe=this.calculateFogTileMatrix(Ge.tileID.toUnwrapped());s.ab.vec4.transformMat4(ut,ut,Xe),s.ab.vec4.transformMat4(Je,Je,Xe);const nt=s.ab.vec4.min([],ut,Je),lt=s.ab.vec4.max([],ut,Je),bt=s.bW(nt,lt);if(bt===0)return!0;let Et=!1;const $t=this._elevation;if($t&&bt>Ce&&Ye!==0){const kt=this.calculateProjMatrix(Ge.tileID.toUnwrapped());let Bt;t.isTerrainDEM||(Bt=$t.getMinMaxForTile(Ge.tileID)),Bt||(Bt={min:le,max:de});const Yt=s.c7(this.rotation),fi=[Yt[0]*s.ag,Yt[1]*s.ag,Bt.max];s.ab.vec3.transformMat4(fi,fi,kt),Et=(1-fi[1])*this.height*.5<Ye}return bt<Ce||Et})}return Ue.sort((Ce,Ye)=>Ce.distanceSq-Ye.distanceSq).map(Ce=>Ce.tileID)}resize(t,n){this.width=t,this.height=n,this.pixelsToGLUnits=[2/t,-2/n],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(t){const n=s.aw(t.lat,-s.bX,s.bX),c=this.projection.project(t.lng,n);return new s.P(c.x*this.worldSize,c.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/s.bH(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,n){let c,d;const p=this.centerPoint;if(this.projection.name==="globe"){const b=this.worldSize;c=(n.x-p.x)/b,d=(n.y-p.y)/b}else{const b=this.pointCoordinate(n),E=this.pointCoordinate(p);c=b.x-E.x,d=b.y-E.y}const _=this.locationCoordinate(t);this.setLocation(new s.aa(_.x-c,_.y-d))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t){return this.projection.locationPoint(this,t)}locationPoint3D(t){return this.projection.locationPoint(this,t,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t){return this.coordinateLocation(this.pointCoordinate3D(t))}locationCoordinate(t,n){const c=n?s.bH(n,t.lat):void 0,d=this.projection.project(t.lng,t.lat);return new s.aa(d.x,d.y,c)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,n){const c=n??this._centerAltitude,d=[t.x,t.y,0,1],p=[t.x,t.y,1,1];s.ab.vec4.transformMat4(d,d,this.pixelMatrixInverse),s.ab.vec4.transformMat4(p,p,this.pixelMatrixInverse);const _=p[3];s.ab.vec4.scale(d,d,1/d[3]),s.ab.vec4.scale(p,p,1/_);const b=d[2],E=p[2];return{p0:d,p1:p,t:b===E?0:(c-b)/(E-b)}}screenPointToMercatorRay(t){const n=[t.x,t.y,0,1],c=[t.x,t.y,1,1];return s.ab.vec4.transformMat4(n,n,this.pixelMatrixInverse),s.ab.vec4.transformMat4(c,c,this.pixelMatrixInverse),s.ab.vec4.scale(n,n,1/n[3]),s.ab.vec4.scale(c,c,1/c[3]),n[2]=s.bH(n[2],this._center.lat)*this.worldSize,c[2]=s.bH(c[2],this._center.lat)*this.worldSize,s.ab.vec4.scale(n,n,1/this.worldSize),s.ab.vec4.scale(c,c,1/this.worldSize),new s.aq([n[0],n[1],n[2]],s.ab.vec3.normalize([],s.ab.vec3.sub([],c,n)))}rayIntersectionCoordinate(t){const{p0:n,p1:c,t:d}=t,p=s.bH(n[2],this._center.lat),_=s.bH(c[2],this._center.lat);return new s.aa(s.af(n[0],c[0],d)/this.worldSize,s.af(n[1],c[1],d)/this.worldSize,s.af(p,_,d))}pointCoordinate(t,n=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,n)}pointCoordinate3D(t){if(!this.elevation)return this.pointCoordinate(t);let n=this.projection.pointCoordinate3D(this,t.x,t.y);if(n)return new s.aa(n[0],n[1],n[2]);let c=0,d=this.horizonLineFromTop();if(t.y>d)return this.pointCoordinate(t);const p=.02*d,_=t.clone();for(let b=0;b<10&&d-c>p;b++){_.y=s.af(c,d,.66);const E=this.projection.pointCoordinate3D(this,_.x,_.y);E?(d=_.y,n=E):c=_.y}return n?new s.aa(n[0],n[1],n[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=s.bY)return!this.isPointAboveHorizon(t);const n=this.pointCoordinate(t);return n.y>=0&&n.y<=1}_coordinatePoint(t,n){const c=n&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,d=[t.x*this.worldSize,t.y*this.worldSize,c+t.toAltitude(),1];return s.ab.vec4.transformMat4(d,d,this.pixelMatrix),d[3]>0?new s.P(d[0]/d[3],d[1]/d[3]):new s.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:t,left:n}=this._edgeInsets,c=this.height-this._edgeInsets.bottom,d=this.width-this._edgeInsets.right,p=this.pointLocation3D(new s.P(n,t)),_=this.pointLocation3D(new s.P(d,t)),b=this.pointLocation3D(new s.P(d,c)),E=this.pointLocation3D(new s.P(n,c));let I=Math.min(p.lng,_.lng,b.lng,E.lng),A=Math.max(p.lng,_.lng,b.lng,E.lng),R=Math.min(p.lat,_.lat,b.lat,E.lat),D=Math.max(p.lat,_.lat,b.lat,E.lat);const F=Math.pow(2,-this.zoom)/16*270,q=this.projection.name==="globe"?1:4,U=(H,Z,J,re,ne)=>{const de=(H+J)/2,le=(Z+re)/2,he=new s.P(de,le),{lng:ae,lat:ge}=this.pointLocation3D(he),Te=Math.max(0,I-ae,R-ge,ae-A,ge-D);I=Math.min(I,ae),A=Math.max(A,ae),R=Math.min(R,ge),D=Math.max(D,ge),(ne<q||Te>F)&&(U(H,Z,de,le,ne+1),U(de,le,J,re,ne+1))};if(U(n,t,d,t,1),U(d,t,d,c,1),U(d,c,n,c,1),U(n,c,n,t,1),this.projection.name==="globe"){const[H,Z]=s.bZ(this);H?(D=90,A=180,I=-180):Z&&(R=-90,A=180,I=-180)}return new s.az(new s.bO(I,R),new s.bO(A,D))}_getBoundsRectangular(t,n){const{top:c,left:d}=this._edgeInsets,p=this.height-this._edgeInsets.bottom,_=this.width-this._edgeInsets.right,b=new s.P(d,c),E=new s.P(_,c),I=new s.P(_,p),A=new s.P(d,p);let R=this.pointCoordinate(b,t),D=this.pointCoordinate(E,t);const F=this.pointCoordinate(I,n),q=this.pointCoordinate(A,n),U=(H,Z)=>(Z.y-H.y)/(Z.x-H.x);return R.y>1&&D.y>=0?R=new s.aa((1-q.y)/U(q,R)+q.x,1):R.y<0&&D.y<=1&&(R=new s.aa(-q.y/U(q,R)+q.x,0)),D.y>1&&R.y>=0?D=new s.aa((1-F.y)/U(F,D)+F.x,1):D.y<0&&R.y<=1&&(D=new s.aa(-F.y/U(F,D)+F.x,0)),new s.az().extend(this.coordinateLocation(R)).extend(this.coordinateLocation(D)).extend(this.coordinateLocation(q)).extend(this.coordinateLocation(F))}_getBoundsRectangularTerrain(){const t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);const n=t.visibleDemTiles.reduce((c,d)=>{if(d.dem){const p=d.dem.tree;c.min=Math.min(c.min,p.minimums[0]),c.max=Math.max(c.max,p.maximums[0])}return c},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(n.min*t.exaggeration(),n.max*t.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){const n=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,c=this.height/2-n*(1-this._horizonShift);return t?Math.max(0,c):c}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-s.bX,this.maxLat=s.bX,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=s.at(this.minLng)*this.tileSize,this.worldMaxX=s.at(this.maxLng)*this.tileSize,this.worldMinY=s.aA(this.maxLat)*this.tileSize,this.worldMaxY=s.aA(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,n){return this.projection.createTileMatrix(this,n,t)}calculateDistanceTileData(t){const n=t.key,c=this._distanceTileDataCache;if(c[n])return c[n];const d=t.canonical,p=1/this.height,_=this.cameraWorldSize,b=_/this.zoomScale(d.z),E=(d.x+Math.pow(2,d.z)*t.wrap)*b,I=d.y*b,A=this.point;A.x*=_/this.worldSize,A.y*=_/this.worldSize;const R=this.angle,D=Math.sin(-R),F=-Math.cos(-R);return c[n]={bearing:[D,F],center:[(A.x-E)*p,(A.y-I)*p],scale:b/s.ag*p},c[n]}calculateFogTileMatrix(t){const n=t.key,c=this._fogTileMatrixCache;if(c[n])return c[n];const d=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return s.ab.mat4.multiply(d,this.worldToFogMatrix,d),c[n]=new Float32Array(d),c[n]}calculateProjMatrix(t,n=!1,c=!1){const d=t.key;let p;if(p=c?this._expandedProjMatrixCache:n?this._alignedProjMatrixCache:this._projMatrixCache,p[d])return p[d];const _=this.calculatePosMatrix(t,this.worldSize);let b;return b=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:c?this.expandedFarZProjMatrix:n?this.alignedProjMatrix:this.projMatrix,s.ab.mat4.multiply(_,b,_),p[d]=new Float32Array(_),p[d]}calculatePixelsToTileUnitsMatrix(t){const n=t.tileID.key,c=this._pixelsToTileUnitsCache;if(c[n])return c[n];const d=s.b_(t,this);return c[n]=d,c[n]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const t=1/this.worldSize,n=s.ab.mat4.fromScaling([],[t,t,t]);return s.ab.mat4.multiply(n,n,this.globeMatrix),n}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const t=this._elevation;this._updateCameraState();const n=s.bH(1,this._center.lat)*this.worldSize,c=this._computeCameraPosition(n),d=this._camera.forward(),p=s.bH(1,this._center.lat);c[2]/=p,d[2]/=p,s.ab.vec3.normalize(d,d);const _=t.raycast(c,d,t.exaggeration());if(_){const b=s.ab.vec3.scaleAndAdd([],c,d,_),E=new s.aa(b[0],b[1],s.bH(b[2],s.aS(b[1]))),I=(E.z+s.ab.vec3.length([E.x-c[0],E.y-c[1],E.z-c[2]*p]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(I),this._centerAltitude=E.toAltitude(),this._center=this.coordinateLocation(E),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;const n=this._elevation,c=s.bH(1,this._center.lat)*this.worldSize,d=this._computeCameraPosition(c),p=n.getAtPointOrZero(new s.aa(...d)),_=this.pixelsPerMeter/this.worldSize*p,b=this._minimumHeightOverTerrain(),E=d[2]-_;if(E<=b)if(E<0||t){const I=this.locationCoordinate(this._center,this._centerAltitude),A=[d[0],d[1],I.z-d[2]],R=s.ab.vec3.length(A);A[2]-=(b-E)/this._pixelsPerMercatorPixel;const D=s.ab.vec3.length(A);if(D===0)return;s.ab.vec3.scale(A,A,R/D*this._pixelsPerMercatorPixel),this._camera.position=[d[0],d[1],I.z*this._pixelsPerMercatorPixel-A[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){const D=this.center;return D.lat=s.aw(D.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(D.lng=s.aw(D.lng,this.minLng,this.maxLng)),this.center=D,void(this._constraining=!1)}const n=this._unmodified,{x:c,y:d}=this.point;let p=0,_=c,b=d;const E=this.width/2,I=this.height/2,A=this.worldMinY*this.scale,R=this.worldMaxY*this.scale;if(d-I<A&&(b=A+I),d+I>R&&(b=R-I),R-A<this.height&&(p=Math.max(p,this.height/(R-A)),b=(R+A)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const D=this.worldMinX*this.scale,F=this.worldMaxX*this.scale,q=this.worldSize/2-(D+F)/2;_=(c+q+this.worldSize)%this.worldSize-q,_-E<D&&(_=D+E),_+E>F&&(_=F-E),F-D<this.width&&(p=Math.max(p,this.width/(F-D)),_=(F+D)/2)}_===c&&b===d||(this.center=this.unproject(new s.P(_,b))),p&&(this.zoom+=this.scaleZoom(p)),this._constrainCamera(),this._unmodified=n,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,n=this.projection.name==="globe",c=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=s.bH(1,this.center.lat)/s.bH(1,s.c8));const d=s.b$(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,d),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const p=this.projection.zAxisUnit==="meters"?c:1,_=this._camera.getWorldToCamera(this.worldSize,p);let b;const E=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(E[8]=2*-t.x/this.width,E[9]=2*t.y/this.height,this.isOrthographic){let ge=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),Te=ge*this.aspect,Ue=-Te,Le=-ge;Te-=t.x,Ue-=t.x,ge+=t.y,Le+=t.y,b=this._camera.getCameraToClipOrthographic(Ue,Te,Le,ge,this._nearZ,this._farZ),((He,Ze,ze,je)=>{for(let it=0;it<16;it++)He[it]=gh(Ze[it],ze[it],je)})(b,b,E,$c(this.pitch>=15?1:this.pitch/15))}else b=E;const I=s.ab.mat4.mul([],E,_);let A=s.ab.mat4.mul([],b,_);if(this.projection.isReprojectedInTileSpace){const ge=this.locationCoordinate(this.center),Te=s.ab.mat4.identity([]);s.ab.mat4.translate(Te,Te,[ge.x*this.worldSize,ge.y*this.worldSize,0]),s.ab.mat4.multiply(Te,Te,s.c0(this)),s.ab.mat4.translate(Te,Te,[-ge.x*this.worldSize,-ge.y*this.worldSize,0]),s.ab.mat4.multiply(A,A,Te),s.ab.mat4.multiply(I,I,Te),this.inverseAdjustmentMatrix=s.c1(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=s.ab.mat4.scale([],A,[this.worldSize,this.worldSize,this.worldSize/p,1]),this.projMatrix=A,this.invProjMatrix=s.ab.mat4.invert(new Float64Array(16),this.projMatrix),n){const ge=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);ge[8]=2*-t.x/this.width,ge[9]=2*t.y/this.height,this.expandedFarZProjMatrix=s.ab.mat4.mul([],ge,_)}else this.expandedFarZProjMatrix=this.projMatrix;const R=s.ab.mat4.invert([],b);this.frustumCorners=s.c2.fromInvProjectionMatrix(R,this.horizonLineFromTop(),this.height),this.cameraFrustum=s.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!n);const D=new Float32Array(16);s.ab.mat4.identity(D),s.ab.mat4.scale(D,D,[1,-1,1]),s.ab.mat4.rotateX(D,D,this._pitch),s.ab.mat4.rotateZ(D,D,this.angle);const F=s.ab.mat4.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=s.ab.mat4.clone(F);const q=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;F[8]=2*-t.x/this.width,F[9]=2*(t.y+q)/this.height,this.skyboxMatrix=s.ab.mat4.multiply(D,F,D);const U=this.point,H=U.x,Z=U.y,J=this.width%2/2,re=this.height%2/2,ne=Math.cos(this.angle),de=Math.sin(this.angle),le=H-Math.round(H)+ne*J+de*re,he=Z-Math.round(Z)+ne*re+de*J,ae=new Float64Array(A);if(s.ab.mat4.translate(ae,ae,[le>.5?le-1:le,he>.5?he-1:he,0]),this.alignedProjMatrix=ae,A=s.ab.mat4.create(),s.ab.mat4.scale(A,A,[this.width/2,-this.height/2,1]),s.ab.mat4.translate(A,A,[1,-1,0]),this.labelPlaneMatrix=A,A=s.ab.mat4.create(),s.ab.mat4.scale(A,A,[1,-1,1]),s.ab.mat4.translate(A,A,[-1,-1,0]),s.ab.mat4.scale(A,A,[2/this.width,2/this.height,1]),this.glCoordMatrix=A,this.pixelMatrix=s.ab.mat4.multiply(new Float64Array(16),this.labelPlaneMatrix,I),this._calcFogMatrices(),this._distanceTileDataCache={},A=s.ab.mat4.invert(new Float64Array(16),this.pixelMatrix),!A)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=A,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=s.c3(this);const ge=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=s.ab.vec3.transformMat4(ge,ge,_),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=A;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const t=this.cameraWorldSizeForFog,n=this.cameraPixelsPerMeter,c=this._camera.position,d=1/this.height/this._pixelsPerMercatorPixel,p=[t,t,n];s.ab.vec3.scale(p,p,d),s.ab.vec3.scale(c,c,-1),s.ab.vec3.multiply(c,c,p);const _=s.ab.mat4.create();s.ab.mat4.translate(_,_,c),s.ab.mat4.scale(_,_,p),this.mercatorFogMatrix=_,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,n,d)}_computeCameraPosition(t){const n=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,c=this._camera.forward(),d=this.point,p=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*n-t/this.worldSize*this._centerAltitude;return[d.x/this.worldSize-c[0]*p,d.y/this.worldSize-c[1]*p,t/this.worldSize*this._centerAltitude-c[2]*p]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){const n=this._maxCameraBoundsDistance()*Math.cos(this._pitch),c=this._camera.position[2],d=t[2];let p=1;this.projection.wrap&&(this.center=this.center.wrap()),d>0&&(p=Math.min((n-c)/d,1)),this._camera.position=s.ab.vec3.scaleAndAdd([],this._camera.position,t,p),this._updateStateFromCamera()}_updateStateFromCamera(){const t=this._camera.position,n=this._camera.forward(),{pitch:c,bearing:d}=this._camera.getPitchBearing(),p=s.bH(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,_=this._mercatorZfromZoom(this._maxZoom)*Math.cos(s.ai(this._maxPitch)),b=Math.max((t[2]-p)/Math.cos(c),_),E=this._zoomFromMercatorZ(b);s.ab.vec3.scaleAndAdd(t,t,n,b),this._pitch=s.aw(c,s.ai(this.minPitch),s.ai(this.maxPitch)),this.angle=s.bF(d,-Math.PI,Math.PI),this._setZoom(s.aw(E,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new s.aa(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){const t=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(t*this.tileSize))}zoomFromMercatorZAdjusted(t){let n=0,c=s.bY,d=0,p=1/0;for(;c-n>1e-6&&c>n;){const _=n+.5*(c-n),b=this.tileSize*Math.pow(2,_),E=this.getCameraToCenterDistance(this.projection,_,b),I=this.scaleZoom(E/(t*this.tileSize)),A=Math.abs(_-I);A<p&&(p=A,d=_),_<I?n=_:c=_}return d}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(s.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,n){const c=Math.min(t.x,n.x),d=Math.max(t.x,n.x),p=Math.min(t.y,n.y),_=Math.max(t.y,n.y);if(p<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const b=[new s.P(c,p),new s.P(d,_),new s.P(c,_),new s.P(d,p)],E=this.renderWorldCopies?-3:0,I=this.renderWorldCopies?4:1;for(const A of b){const R=this.pointRayIntersection(A);if(R.t<0)return!0;const D=this.rayIntersectionCoordinate(R);if(D.x<E||D.y<0||D.x>I||D.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+s.c4(this.fovAboveCenter)>88||this.anyCornerOffEdge(new s.P(0,0),new s.P(this.width,this.height))}zoomDeltaToMovement(t,n){const c=s.ab.vec3.length(s.ab.vec3.sub([],this._camera.position,t)),d=this._zoomFromMercatorZ(c)+n;return c-this._mercatorZfromZoom(d)}getCameraPoint(){if(this.projection.name==="globe"){const t=function([n,c,d],p){const _=[n,c,d,1];s.ab.vec4.transformMat4(_,_,p);const b=_[3]=Math.max(_[3],1e-6);return _[0]/=b,_[1]/=b,_[2]/=b,_}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new s.P(t[0],t[1])}{const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new s.P(0,t))}}getCameraToCenterDistance(t,n=this.zoom,c=this.worldSize){const d=s.b$(t,n,this.width,this.height,1024),p=t.pixelSpaceConversion(this.center.lat,c,d);let _=.5/Math.tan(.5*this._fov)*this.height*p;return this.isOrthographic&&(_=gh(1,_,$c(this.pitch>=15?1:this.pitch/15))),_}getWorldToCameraMatrix(){const t=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&s.ab.mat4.multiply(t,t,this.globeMatrix),t}getFrustum(t){return s.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,this.projection.zAxisUnit==="meters")}}const fo=(l,t)=>{if(t>0&&l.terrain&&s.w("Cutoff is currently disabled on terrain"),t<=0||l.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const n=l.transform,c=Math.max(Math.abs(n._zoom-(l.minCutoffZoom-1)),1),d=n.isLODDisabled(!1)?s.ac(60,45,n.pitch):s.ac(30,15,n.pitch),p=n._farZ-n._nearZ,_=t*n.height,b=((1-(E=d))*n.cameraToCenterDistance+E*(n._farZ+_))*c;var E;return{shouldRenderCutoff:d<1,uniformValues:{u_cutoff_params:[n._nearZ,n._farZ,(b-n._nearZ)/p,(b-_-n._nearZ)/p]}}},jn={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class Ws{constructor(t,n){this.aabb=t,this.lastCascade=n}}class yh{add(t,n){const c=this.receivers[t.key];c!==void 0?(c.aabb.min[0]=Math.min(c.aabb.min[0],n.min[0]),c.aabb.min[1]=Math.min(c.aabb.min[1],n.min[1]),c.aabb.min[2]=Math.min(c.aabb.min[2],n.min[2]),c.aabb.max[0]=Math.max(c.aabb.max[0],n.max[0]),c.aabb.max[1]=Math.max(c.aabb.max[1],n.max[1]),c.aabb.max[2]=Math.max(c.aabb.max[2],n.max[2])):this.receivers[t.key]=new Ws(n,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,n,c){const d=s.cd.fromPoints(t.points);let p=0;for(const _ in this.receivers){const b=this.receivers[_];if(!b||!d.intersectsAabb(b.aabb))continue;b.aabb.min=d.closestPoint(b.aabb.min),b.aabb.max=d.closestPoint(b.aabb.max);const E=b.aabb.getCorners();for(let I=0;I<c.length;I++){let A=!0;for(const R of E){const D=[R[0]*n,R[1]*n,R[2]];if(s.ab.vec3.transformMat4(D,D,c[I].matrix),D[0]<-1||D[0]>1||D[1]<-1||D[1]>1){A=!1;break}}if(b.lastCascade=I,p=Math.max(p,I),A)break}}return p+1}}class qo{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new yh,this._depthMode=new Ft(t.context.gl.LEQUAL,Ft.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,t.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),t.tp.registerParameter(jn,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),t.tp.registerParameter(jn,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),t.tp.registerParameter(jn,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),t.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,n){const c=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!n||!n.properties)return;const d=n.properties.get("shadow-intensity");if(!n.shadowsEnabled()||d<=0||(this._shadowLayerCount=c.style.order.reduce((q,U)=>{const H=c.style._mergedLayers[U];return q+(H.hasShadowPass()&&!H.isHidden(t.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;const p=c.context,_=jn.shadowMapResolution,b=jn.shadowMapResolution;if(this._cascades.length===0||jn.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let q=0;q<jn.cascadeCount;++q){const U=c._shadowMapDebug,H=p.gl,Z=p.createFramebuffer(_,b,U,"texture"),J=new s.T(p,{width:_,height:b,data:null},H.DEPTH_COMPONENT16);if(Z.depthAttachment.set(J.texture),U){const re=new s.T(p,{width:_,height:b,data:null},H.RGBA8);Z.colorAttachment.set(re.texture)}this._cascades.push({framebuffer:Z,texture:J,matrix:[],far:0,boundingSphereRadius:0,frustum:new s.bR,scale:0})}}this.shadowDirection=Zo(n);let E=0;if(t.elevation){const q=t.elevation,U=[1e4,-1e4];q.visibleDemTiles.filter(H=>H.dem).forEach(H=>{const Z=H.dem.tree;U[0]=Math.min(U[0],Z.minimums[0]),U[1]=Math.max(U[1],Z.maximums[0])}),U[0]!==1e4&&(E=(U[1]-U[0])*q.exaggeration())}const I=1.5*t.cameraToCenterDistance,A=3*I,R=new Float64Array(16);for(let q=0;q<this._cascades.length;++q){const U=this._cascades[q];let H=t.height/50,Z=1;jn.cascadeCount===1?Z=A:q===0?Z=I:(H=I,Z=A);const[J,re]=Ym(t,this.shadowDirection,H,Z,jn.shadowMapResolution,E);U.scale=t.scale,U.matrix=J,U.boundingSphereRadius=re,s.ab.mat4.invert(R,U.matrix),U.frustum=s.bR.fromInvProjectionMatrix(R,1,0,!0),U.far=Z}const D=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[D].far,this._cascades[D].far],this._uniformValues.u_shadow_intensity=d,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/jn.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=jn.shadowMapResolution,this._uniformValues.u_shadowmap_0=Hn.ShadowMap0,this._uniformValues.u_shadowmap_1=Hn.ShadowMap0+1,this._groundShadowTiles=c.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const F=c.transform.elevation;for(const q of this._groundShadowTiles){let U={min:0,max:0};if(F){const H=F.getMinMaxForTile(q);H&&(U=H)}this.addShadowReceiver(q.toUnwrapped(),U.min,U.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(t){this._enabled=t}drawShadowPass(t,n){if(!this.enabled)return;const c=this.painter,d=c.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(c.transform.getFrustum(0),c.transform.worldSize,this._cascades),d.viewport.set([0,0,jn.shadowMapResolution,jn.shadowMapResolution]);for(let p=0;p<this._numCascadesToRender;++p){c.currentShadowCascade=p,d.bindFramebuffer.set(this._cascades[p].framebuffer.framebuffer),d.clear({color:s.aj.white,depth:1});for(const _ of t.order){const b=t._mergedLayers[_];if(!b.hasShadowPass()||b.isHidden(c.transform.zoom))continue;const E=t.getLayerSourceCache(b),I=E?n[E.id]:void 0;(b.type==="model"||I&&I.length)&&c.renderLayer(c,E,b,I)}}c.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const t=this.painter,n=t.style,c=t.context,d=n.directionalLight,p=n.ambientLight;if(!d||!p)return;const _=[],b=fo(t,t.longestCutoffRange);b.shouldRenderCutoff&&_.push("RENDER_CUTOFF"),_.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&_.push("NORMAL_OFFSET");const E=xh(n,d,p),I=new Ft(c.gl.LEQUAL,Ft.ReadOnly,t.depthRangeFor3D);for(const A of this._groundShadowTiles){const R=A.toUnwrapped(),D=t.isTileAffectedByFog(A),F=t.getOrCreateProgram("groundShadow",{defines:_,overrideFog:D});this.setupShadows(R,F),t.uploadCommonUniforms(c,F,R,null,b);const q={u_matrix:t.transform.calculateProjMatrix(R),u_ground_shadow_factor:E};F.draw(t,c.gl.TRIANGLES,I,Ht.disabled,oi.multiply,Xt.disabled,q,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,{},t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?oi.unblended:oi.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){const n=this.painter.transform,c=n.calculatePosMatrix(t,n.worldSize);return s.ab.mat4.multiply(c,this._cascades[this.painter.currentShadowCascade].matrix,c),Float32Array.from(c)}calculateShadowPassMatrixFromMatrix(t){return s.ab.mat4.multiply(t,this._cascades[this.painter.currentShadowCascade].matrix,t),Float32Array.from(t)}setupShadows(t,n,c,d=0){if(!this.enabled)return;const p=this.painter.transform,_=this.painter.context,b=_.gl,E=this._uniformValues,I=new Float64Array(16),A=p.calculatePosMatrix(t,p.worldSize);for(let R=0;R<this._cascades.length;R++)s.ab.mat4.multiply(I,this._cascades[R].matrix,A),E[R===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(I),_.activeTexture.set(b.TEXTURE0+Hn.ShadowMap0+R),this._cascades[R].texture.bind(b.NEAREST,b.CLAMP_TO_EDGE);if(this.useNormalOffset=!!c,this.useNormalOffset){const R=s.cc(t.canonical),D=2/p.tileSize*s.ag/jn.shadowMapResolution,F=D*this._cascades[0].boundingSphereRadius,q=D*this._cascades[this._cascades.length-1].boundingSphereRadius,U=(c==="vector-tile"?1:3)/Math.pow(2,d-t.canonical.z-(1-p.zoom+Math.floor(p.zoom)));E.u_shadow_normal_offset=[R,F*U,q*U],E.u_shadow_bias=[6e-5,.0012,.012]}else E.u_shadow_bias=[36e-5,.0012,.012];n.setShadowUniformValues(_,E)}setupShadowsFromMatrix(t,n,c=!1){if(!this.enabled)return;const d=this.painter.context,p=d.gl,_=this._uniformValues,b=new Float64Array(16);for(let E=0;E<jn.cascadeCount;E++)s.ab.mat4.multiply(b,this._cascades[E].matrix,t),_[E===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(b),d.activeTexture.set(p.TEXTURE0+Hn.ShadowMap0+E),this._cascades[E].texture.bind(p.NEAREST,p.CLAMP_TO_EDGE);if(this.useNormalOffset=c,c){const E=jn.normalOffset;_.u_shadow_normal_offset=[1,E,E],_.u_shadow_bias=[6e-5,.0012,.012]}else _.u_shadow_bias=[36e-5,.0012,.012];n.setShadowUniformValues(d,_)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,n,c,d){if(d[2]>=0)return{};const p=function(E,I,A){const R=A/(1<<E.canonical.z);return new s.cd([E.canonical.x*R+E.wrap*A,E.canonical.y*R+E.wrap*A,0],[(E.canonical.x+1)*R+E.wrap*A,(E.canonical.y+1)*R+E.wrap*A,I])}(t,n,c).getCorners(),_=n/-d[2];d[0]<0?(s.ab.vec3.add(p[0],p[0],[d[0]*_,0,0]),s.ab.vec3.add(p[3],p[3],[d[0]*_,0,0])):d[0]>0&&(s.ab.vec3.add(p[1],p[1],[d[0]*_,0,0]),s.ab.vec3.add(p[2],p[2],[d[0]*_,0,0])),d[1]<0?(s.ab.vec3.add(p[0],p[0],[0,d[1]*_,0]),s.ab.vec3.add(p[1],p[1],[0,d[1]*_,0])):d[1]>0&&(s.ab.vec3.add(p[2],p[2],[0,d[1]*_,0]),s.ab.vec3.add(p[3],p[3],[0,d[1]*_,0]));const b={};return b.vertices=p,b.planes=[$o(p[1],p[0],p[4]),$o(p[2],p[1],p[5]),$o(p[3],p[2],p[6]),$o(p[0],p[3],p[7])],b}addShadowReceiver(t,n,c){this._receivers.add(t,s.cd.fromTileIdAndHeight(t,n,c))}getMaxCascadeForTile(t){const n=this._receivers.get(t);return n&&n.lastCascade?n.lastCascade:0}}function $o(l,t,n){const c=s.ab.vec3.sub([],n,t),d=s.ab.vec3.sub([],l,t),p=s.ab.vec3.cross([],c,d),_=s.ab.vec3.length(p);return _===0?[0,0,1,0]:(s.ab.vec3.scale(p,p,1/_),[p[0],p[1],p[2],-s.ab.vec3.dot(p,t)])}function Zo(l){const t=l.properties.get("direction"),n=s.cb(t.x,t.y,t.z);n[2]=s.aw(n[2],0,75);const c=s.ce([n[0],n[1],n[2]]);return s.ab.vec3.fromValues(c.x,c.y,c.z)}function xh(l,t,n){const c=t.properties.get("color-use-theme")==="none",d=t.properties.get("color"),p=t.properties.get("intensity"),_=t.properties.get("direction"),b=[_.x,_.y,_.z],E=n.properties.get("color-use-theme")==="none",I=n.properties.get("color"),A=n.properties.get("intensity"),R=Math.max(s.ab.vec3.dot([0,0,1],b),0),D=[0,0,0];s.ab.vec3.scale(D,I.toRenderColor(E?null:l.getLut(t.scope)).toArray01Linear().slice(0,3),A);const F=[0,0,0];return s.ab.vec3.scale(F,d.toRenderColor(c?null:l.getLut(n.scope)).toArray01Linear().slice(0,3),R*p),s.cf([D[0]>0?D[0]/(D[0]+F[0]):0,D[1]>0?D[1]/(D[1]+F[1]):0,D[2]>0?D[2]/(D[2]+F[2]):0])}function Ym(l,t,n,c,d,p){const _=l.zoom,b=l.scale,E=l.worldSize,I=1/E,A=l.aspect,R=Math.sqrt(1+A*A)*Math.tan(.5*l.fovX),D=R*R,F=c-n,q=c+n;let U,H;D>F/q?(U=c,H=c*R):(U=.5*q*(1+D),H=.5*Math.sqrt(F*F+2*(c*c+n*n)*D+q*q*D*D));const Z=l.projection.pixelsPerMeter(l.center.lat,E),J=l._camera.getCameraToWorldMercator(),re=[0,0,-U*I];s.ab.vec3.transformMat4(re,re,J);let ne=H*I;const de=l._edgeInsets;if(!(de.left===0&&de.top===0&&de.right===0&&de.bottom===0||de.left===de.right&&de.top===de.bottom)){const ut=l._camera.getWorldToCamera(l.worldSize,l.projection.zAxisUnit==="meters"?Z:1),Je=l._camera.getCameraToClipPerspective(l._fov,l.width/l.height,n,c);Je[8]=2*-l.centerOffset.x/l.width,Je[9]=2*l.centerOffset.y/l.height;const Xe=new Float64Array(16);s.ab.mat4.mul(Xe,Je,ut);const nt=new Float64Array(16);s.ab.mat4.invert(nt,Xe);const lt=s.bR.fromInvProjectionMatrix(nt,E,_,!0);for(const bt of lt.points){const Et=((le=bt)[0]/=b,le[1]/=b,le[2]=s.bH(le[2],l._center.lat),le);ne=Math.max(ne,s.ab.vec3.len(s.ab.vec3.subtract([],re,Et)))}}var le;ne*=d/(d-1);const he=Math.acos(t[2]),ae=Math.atan2(-t[0],-t[1]),ge=new mr;ge.position=re,ge.setPitchBearing(he,ae);const Te=ge.getWorldToCamera(E,Z),Ue=ne*E,Le=Math.min(l._mercatorZfromZoom(17)*E*-2,-2*Ue),He=ge.getCameraToClipOrthographic(-Ue,Ue,-Ue,Ue,Le,(Ue+p*Z)/t[2]),Ze=new Float64Array(16);s.ab.mat4.multiply(Ze,He,Te);const ze=s.ab.vec3.fromValues(Math.floor(1e6*re[0])/1e6*E,Math.floor(1e6*re[1])/1e6*E,0),je=.5*d,it=[0,0,0];s.ab.vec3.transformMat4(it,ze,Ze),s.ab.vec3.scale(it,it,je);const Ce=[Math.floor(it[0]),Math.floor(it[1]),Math.floor(it[2])],Ye=[0,0,0];s.ab.vec3.sub(Ye,it,Ce),s.ab.vec3.scale(Ye,Ye,-1/je);const Ge=new Float64Array(16);return s.ab.mat4.identity(Ge),s.ab.mat4.translate(Ge,Ge,Ye),s.ab.mat4.multiply(Ze,Ge,Ze),[Ze,Ue]}class vh extends s.E{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.modelUris={"":{}},this.numModelsLoading={}}loadModel(t,n){return s.aM(this.requestManager.transformRequest(n,s.R.Model).url).then(c=>{if(!c)return;const d=s.aN(c),p=new s.aO(t,void 0,void 0,d);return p.computeBoundsAndApplyParent(),p}).catch(c=>{if(c&&c.status===404)return null;this.fire(new s.y(new Error(`Could not load model ${t} from ${n}: ${c.message}`)))})}load(t,n,c={keepNumReferences:!1}){this.models[n]||(this.models[n]={});const d=Object.keys(t);this.numModelsLoading[n]=(this.numModelsLoading[n]||0)+d.length;const p=[];for(const _ of d)p.push(this.loadModel(_,t[_]));Promise.allSettled(p).then(_=>{for(let b=0;b<_.length;b++){const{status:E,value:I}=_[b];if(E==="fulfilled"&&I){const A=this.models[n][d[b]];this.models[n][d[b]]={model:I,numReferences:c.keepNumReferences&&A?A.numReferences:1}}}this.numModelsLoading[n]-=d.length,this.fire(new s.z("data",{dataType:"style"}))}).catch(_=>{this.fire(new s.y(new Error(`Could not load models: ${_.message}`)))})}isLoaded(){for(const t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,n){return!!this.getModel(t,n)}getModel(t,n){return this.models[n]||(this.models[n]={}),this.models[n][t]?this.models[n][t].model:void 0}addModel(t,n,c){this.models[c]||(this.models[c]={}),this.modelUris[c]||(this.modelUris[c]={}),this.hasModel(t,c)&&this.models[c][t].numReferences++,this.modelUris[c][t]=this.requestManager.normalizeModelURL(n),this.load({[t]:this.modelUris[c][t]},c)}addModels(t,n){this.models[n]||(this.models[n]={}),this.modelUris[n]||(this.modelUris[n]={});const c=this.modelUris[n];for(const d in t)this.models[n][d]={},c[d]=this.requestManager.normalizeModelURL(t[d]);this.load(c,n,{keepNumReferences:!0})}reloadModels(t){this.load(this.modelUris[t],t)}addModelsFromBucket(t,n){this.models[n]||(this.models[n]={}),this.modelUris[n]||(this.modelUris[n]={});const c={};for(const d of t)this.hasModel(d,n)?this.models[n][d].numReferences++:(this.modelUris[n][d]=this.requestManager.normalizeModelURL(d),c[d]=this.modelUris[n][d]);this.load(c,n)}removeModel(t,n){if(this.models[n]&&this.models[n][t]&&(this.models[n][t].numReferences--,this.models[n][t].numReferences===0)){const c=this.models[n][t].model;delete this.models[n][t],delete this.modelUris[n][t],c.destroy()}}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,n){this.models[n]||(this.models[n]={});for(const c in this.models[n])this.models[n][c].model&&this.models[n][c].model.upload(t.context)}}const Km=new s.a5({data:new s.a6(s.a3.colorTheme.data)}),Tf={"mbx-indoor-active-floorplans":{default:["literal",[]]},"mbx-indoor-underground":{default:["literal",!1]},"mbx-indoor-loaded-levels":{default:["literal",[]]},"mbx-indoor-level-height":{default:["literal",{}]},"mbx-indoor-level-base":{default:["literal",{}]},"mbx-indoor-level-selected":{default:["literal",{}]},"mbx-indoor-level-overlapped":{default:["literal",{}]}};function bh(l){return l=l||{},Object.assign(l,Tf)}class wh extends s.E{constructor(t){super(),this.mergeFloors=!0,this._scope=void 0,this._queryFeatureSetId=void 0,this._buildingEntryFeatureSetId=void 0,this._selectedFloorplan=void 0,this._indoorData=void 0,this._selectedLevel=void 0,this._floorplanStates={},s.aP(["_onLoad","_onMove","_checkFloorplanVisible"],this),this._map=t,this._checkFloorplanVisible(!0),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=void 0}_onLoad(){this._map.style.forEachFragmentStyle(t=>{t.stylesheet.indoor&&(this._queryFeatureSetId?this.fire(new s.y(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._queryFeatureSetId=t.stylesheet.indoor.floorplanFeaturesetId,this._buildingEntryFeatureSetId=t.stylesheet.indoor.buildingFeaturesetId,this._scope=t.scope))}),this._queryFeatureSetId&&this._buildingEntryFeatureSetId&&this._map.addInteraction("mbx-indoor-buildingclick",{type:"click",target:{featuresetId:this._buildingEntryFeatureSetId,importId:this._scope},handler:t=>(t.feature&&t.feature.properties.floorplan&&this.selectFloorplan(t.feature.properties.floorplan),!0)}),this._checkFloorplanVisible(!0)}_onMove(){this._checkFloorplanVisible(!1)}_checkFloorplanVisible(t){if(!this._queryFeatureSetId||!this._map.isStyleLoaded()||this._map.transform.zoom<13)return;this._indoorData&&!function(_,b){const[E,I]=_,{center:A,radius:R}=b,[D,F]=A,q=Math.abs(E-D);return Math.sqrt((q>180?360-q:q)**2+(I-F)**2)<=R}([this._map.getCenter().lng,this._map.getCenter().lat],this._indoorData.circumCircle)&&(this._indoorData=void 0,this._selectedFloorplan=void 0,this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",["literal",[]]),this.fire(new s.z("floorplangone")));const n={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},c=new s.P(this._map.transform.width/2,this._map.transform.height/2),d=[new s.P(0,0),new s.P(this._map.transform.width,this._map.transform.height)],p=this._map.queryRenderedFeatures(t?d:c,n);p.length>0&&(this._selectedFloorplan&&p[0].properties.id===this._selectedFloorplan.properties.id||(this._selectedFloorplan=p[0],this._floorplanSelected(!1)))}_floorplanSelected(t){this._indoorData=JSON.parse(this._selectedFloorplan.properties["indoor-data"]),this._indoorData.id=this._selectedFloorplan.properties.id,this._indoorData.circumCircle=function(p){const[[_,b],[E,I]]=p,A=(E-_+360)%360,R=A>180?360-A:A;return{center:[(_+R/2+360)%360,(b+I)/2],radius:Math.sqrt(R**2+(I-b)**2)/2}}(this._indoorData.extent),this._floorplanStates[this._indoorData.id]||(this._floorplanStates[this._indoorData.id]={});const n=this._floorplanStates[this._indoorData.id].selectedBuilding,c=this._floorplanStates[this._indoorData.id].selectedLevel;let d;if(this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",this._indoorData.floorplanIDs),this._selectedLevel)for(const p of this._indoorData.levels)p.id===this._selectedLevel.id&&(d=p.id);if(this.fire(new s.z("floorplanselected",{buildings:this._indoorData.buildings,levels:this._indoorData.levels,selectedLevelId:d})),n){const p=this._indoorData.buildings.find(_=>_.id===n);this._buildingSelected(p,!1)}else this._indoorData.buildings.length>0&&this._buildingSelected(this._indoorData.buildings[0],!1);if(c){const p=this._indoorData.levels.find(_=>_.id===c);this._updateLevels(p,t)}else t&&this._indoorData["default-levels"].length>0&&this.selectLevel(this._indoorData["default-levels"][0])}_buildingSelected(t,n){n&&t&&t.extent&&this._map.fitBounds(t.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),this._floorplanStates[this._indoorData.id].selectedBuilding=t?t.id:void 0;const c=this._indoorData.levels.filter(d=>t.levels.includes(d.id));this.fire(new s.z("buildingselected",{buildingId:t.id,levels:c}))}_levelSelected(t){if(t==="overview")this._updateLevels(void 0,!0);else{const n=this._indoorData.levels.find(c=>c.id===t);this._updateLevels(n,!0)}this.fire(new s.z("levelselected",{levelId:t==="overview"?void 0:t}))}_updateLevels(t,n){if(!t)return this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",[]]),this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._floorplanStates[this._indoorData.id].selectedLevel=void 0,void(n&&this._indoorData.extent&&this._map.fitBounds(this._indoorData.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}));function c(I){const A=I.indexOf("/floor/");if(A===-1)return I;const R=A+7,D=I.indexOf("/",R);return D===-1?I.slice(R):I.slice(R,D)}this._selectedLevel=t,this._floorplanStates[this._indoorData.id].selectedLevel=t?t.id:void 0;const d=[],p={},_={},b={},E={};for(const I of this._indoorData.levels)if(d.push(I.id),p[I.id]=I.height,_[I.id]=I.base,t){if(this.mergeFloors){const A=c(t.id),R=c(I.id);b[I.id]=R===A?"true":"false"}else b[I.id]=I.id===t.id?"true":"false";E[I.id]=I.base<t.base?"true":"false"}else E[I.id]=!0;if(this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",d]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-height",["literal",p]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-base",["literal",_]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",b]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-overlapped",["literal",E]),t&&(this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!!t.isUnderground),n&&t.extent)){const I=this._map.cameraForBounds(t.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),A=this._map.getZoom(),R=I.zoom?Math.abs(A-I.zoom):0;this._map.fitBounds(t.extent,R>=1?{pitch:this._map.getPitch(),bearing:this._map.getBearing()}:{pitch:this._map.getPitch(),bearing:this._map.getBearing(),zoom:A})}}selectFloorplan(t){const n={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},c=[new s.P(0,0),new s.P(this._map.transform.width,this._map.transform.height)],d=this._map.queryRenderedFeatures(c,n);if(d.length>0){for(const p of d)if(JSON.parse(p.properties["indoor-data"]).floorplanIDs.includes(t)){this._selectedFloorplan=p,this._floorplanSelected(!0);break}}}selectBuilding(t){const n=this._indoorData.buildings.find(c=>c.id===t);this._buildingSelected(n,!0)}selectLevel(t){this._levelSelected(t)}}function Jm(l){if(!l.metadata||!l.metadata.content_area)return;const t=s.q.devicePixelRatio,{left:n,top:c,width:d,height:p}=l.metadata.content_area,_=n*t,b=c*t;return[_,b,_+d*t,b+p*t]}function Sf(l){if(l)return l.map(([t,n])=>[t*s.q.devicePixelRatio,n*s.q.devicePixelRatio])}const Ho=(l,t)=>ds(l,t&&t.filter(n=>n.identifier!=="source.canvas")),Qm=s.ay(li,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport"]),Ef=s.ay(li,["setCenter","setZoom","setBearing","setPitch"]),Th=new Set(["background","sky","slot","custom"]),Al={version:8,layers:[],sources:{}},Mf={duration:300,delay:0};class Ur extends s.E{constructor(t,n={}){super(),this.map=t,this.scope=n.scope||"",this.globalId=null,this.fragments=[],this.importDepth=n.importDepth||0,this.importsCache=n.importsCache||new Map,this.resolvedImports=n.resolvedImports||new Set,this.transition=s.l({},Mf),this._buildingIndex=new bf(this),this.crossTileSymbolIndex=new mh,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=n.styleChanges||new ko,this.dispatcher=n.dispatcher?n.dispatcher:new s.D(s.ci(),this),n.imageManager?this.imageManager=n.imageManager:(this.imageManager=new rr(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=n.glyphManager?n.glyphManager:new s.cj(t._requestManager,n.localFontFamily?s.ck.all:n.localIdeographFontFamily?s.ck.ideographs:s.ck.none,n.localFontFamily||n.localIdeographFontFamily),n.modelManager?this.modelManager=n.modelManager:(this.modelManager=new vh(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this.options=n.configOptions?n.configOptions:new Map,this._configDependentLayers=n.configDependentLayers?n.configDependentLayers:new Set,this._config=n.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:n.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=n.initialConfig,this.dispatcher.broadcast("setReferrer",s.cl());const c=this;this._rtlTextPluginCallback=Ur.registerForPluginStateChange(d=>{c.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:d.pluginStatus,pluginURL:d.pluginURL},(p,_)=>{if(s.cm(p),_&&_.every(b=>b))for(const b in c._sourceCaches){const E=c._sourceCaches[b],I=E.getSource().type;I!=="vector"&&I!=="geojson"||E.reload()}})}),this.on("data",d=>{if(d.dataType!=="source"||d.sourceDataType!=="metadata")return;const p=this.getOwnSource(d.sourceId);if(p&&p.vectorLayerIds)for(const _ in this._layers){const b=this._layers[_];b.source===p.id&&this._validateLayer(b)}})}load(t){return t?(typeof t=="string"?this.loadURL(t):this.loadJSON(t),this):this}_getGlobalId(t){if(!t)return null;if(typeof t=="string"){if(s.f(t))return t;const n=s.cn(t);if(!n.startsWith("http"))try{return new URL(n,location.href).toString()}catch{return n}return n}return`json://${s.co(JSON.stringify(t))}`}_diffStyle(t,n,c){this.globalId=this._getGlobalId(t);const d=(p,_)=>{try{_(null,this.setState(p,c))}catch(b){_(b,!1)}};if(typeof t=="string"){const p=this.map._requestManager.normalizeStyleURL(t),_=this.map._requestManager.transformRequest(p,s.R.Style);s.n(_,(b,E)=>{b?this.fire(new s.y(b)):E&&d(E,n)})}else typeof t=="object"&&d(t,n)}loadURL(t,n={}){this.fire(new s.z("dataloading",{dataType:"style"}));const c=typeof n.validate=="boolean"?n.validate:!s.f(t);this.globalId=this._getGlobalId(t),t=this.map._requestManager.normalizeStyleURL(t,n.accessToken),this.resolvedImports.add(t);const d=this.importsCache.get(t);if(d)return this._load(d,c);const p=this.map._requestManager.transformRequest(t,s.R.Style);this._request=s.n(p,(_,b)=>{if(this._request=null,_)this.fire(new s.y(_));else if(b)return this.importsCache.set(t,b),this._load(b,c)})}loadJSON(t,n={}){this.fire(new s.z("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(t),this._request=s.q.frame(()=>{this._request=null,this._load(t,n.validate!==!1)})}loadEmpty(){this.fire(new s.z("dataloading",{dataType:"style"})),this._load(Al,!1)}_loadImports(t,n,c){if(this.importDepth>=4)return s.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const d=[];for(const p of t){const _=this._createFragmentStyle(p),b=new Promise(A=>{_.once("style.import.load",A),_.once("error",A)}).then(()=>this.mergeAll());if(d.push(b),this.resolvedImports.has(p.url)){_.loadEmpty();continue}const E=p.data||this.importsCache.get(p.url);E?(_.loadJSON(E,{validate:n}),this._isInternalStyle(E)&&(_.globalId=null)):p.url?_.loadURL(p.url,{validate:n}):_.loadEmpty();const I={style:_,id:p.id,config:p.config};if(c){const A=this.fragments.findIndex(({id:R})=>R===c);this.fragments=this.fragments.slice(0,A).concat(I).concat(this.fragments.slice(A))}else this.fragments.push(I)}return Promise.allSettled(d)}getImportGlobalIds(t=this,n=new Set){for(const c of t.fragments)c.style.globalId&&n.add(c.style.globalId),this.getImportGlobalIds(c.style,n);return[...n.values()]}_createFragmentStyle(t){const n=this.scope?s.aC(t.id,this.scope):t.id;let c;const d=this._initialConfig&&this._initialConfig[n];(t.config||d)&&(c=s.l({},t.config,d));const p=new Ur(this.map,{scope:n,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:c,configOptions:this.options,colorThemeOverride:t["color-theme"],configDependentLayers:this._configDependentLayers});return p.setEventedParent(this.map,{style:p}),p}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(t){return this.isRootStyle()&&(t.fragment||!!t.schema&&t.fragment!==!1)}_load(t,n){const c=t.indoor?bh(t.schema):t.schema;if(this._isInternalStyle(t)){const _=s.l({},Al,{imports:[{id:"basemap",data:t,url:""}]});return void this._load(_,n)}if(this.updateConfig(this._config,c),n&&Ho(this,xr(t)))return;this._loaded=!0,this.stylesheet=s.cp(t);const d=()=>{for(const I in t.sources)this.addSource(I,t.sources[I],{validate:!1,isInitialLoad:!0});t.sprite?this._loadIconset(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.glyphManager.setURL(t.glyphs,this.scope);const _=Fc(this.stylesheet.layers);if(this._order=_.map(I=>I.id),this.stylesheet.light&&s.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const I=this.stylesheet.lights[0];this.light=new G(I.properties,I.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new G(this.stylesheet.light)),this._layers={};for(const I of _){const A=s.cu(I,this.scope,this._styleColorTheme.lut,this.options);A.configDependencies.size!==0&&this._configDependentLayers.add(A.fqid),A.setEventedParent(this,{layer:{id:A.id}}),this._layers[A.id]=A;const R=this.getOwnLayerSourceCache(A),D=!!this.directionalLight&&this.directionalLight.shadowsEnabled();R&&A.canCastShadows()&&D&&(R.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const b=this.stylesheet.terrain;b&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(b,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new s.z("data",{dataType:"style"}));const E=this.isRootStyle();t.imports?this._loadImports(t.imports,n).then(()=>{this._reloadImports(),this.fire(new s.z(E?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new s.z(E?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const p=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(p){const _=this._evaluateColorThemeData(p);this._loadColorTheme(_).then(()=>{d()}).catch(b=>{s.w(`Couldn't load color theme from the stylesheet: ${b}`),d()})}else this._styleColorTheme.lut=null,d()}isRootStyle(){return this.importDepth===0}mergeAll(){let t,n,c,d,p,_,b,E,I,A;const R={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(D=>{if(D.stylesheet){if(D.light!=null&&(t=D.light),D.stylesheet.lights)for(const F of D.stylesheet.lights)F.type==="ambient"&&D.ambientLight!=null&&(n=D.ambientLight),F.type==="directional"&&D.directionalLight!=null&&(c=D.directionalLight);d=this._prioritizeTerrain(d,D.terrain,D.stylesheet.terrain),D.stylesheet.fog&&D.fog!=null&&(p=D.fog),D.stylesheet.snow&&D.snow!=null&&(_=D.snow),D.stylesheet.rain&&D.rain!=null&&(b=D.rain),D.stylesheet.camera!=null&&(A=D.stylesheet.camera),D.stylesheet.projection!=null&&(E=D.stylesheet.projection),D.stylesheet.transition!=null&&(I=D.stylesheet.transition),R[D.scope]=D._styleColorTheme}}),this.light=t,this.ambientLight=n,this.directionalLight=c,this.fog=p,this.snow=_,this.rain=b,this._styleColorThemeForScope=R,d===null?delete this.terrain:this.terrain=d,this.camera=A||{"camera-projection":"perspective"},this.projection=E||{name:"mercator"},this.transition=s.l({},Mf,I),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(t){const n=c=>{for(const d of c.fragments)n(d.style);t(c)};n(this)}_prioritizeTerrain(t,n,c){const d=t&&t.drapeRenderMode===0;return c===null?n&&n.drapeRenderMode===0?n:d?t:null:n!=null&&(!t||d||n&&n.drapeRenderMode===1)?n:t}mergeTerrain(){let t;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(n=>{t=this._prioritizeTerrain(t,n.terrain,n.stylesheet.terrain)}),t===null?delete this.terrain:this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle(n=>{n.stylesheet.projection!=null&&(t=n.stylesheet.projection)}),this.projection=t||{name:"mercator"}}mergeSources(){const t={},n={},c={};this.forEachFragmentStyle(d=>{for(const p in d._sourceCaches){const _=s.aC(p,d.scope);t[_]=d._sourceCaches[p]}for(const p in d._otherSourceCaches){const _=s.aC(p,d.scope);n[_]=d._otherSourceCaches[p]}for(const p in d._symbolSourceCaches){const _=s.aC(p,d.scope);c[_]=d._symbolSourceCaches[p]}}),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=n,this._mergedSymbolSourceCaches=c}mergeLayers(){const t={},n=[],c={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(p=>{for(const _ of p._order){const b=p._layers[_];if(b.type==="slot"){const E=s.cq(_);if(t[E])continue;t[E]=[]}b.slot&&t[b.slot]?t[b.slot].push(b):n.push(b)}}),this._mergedOrder=[];const d=(p=[])=>{for(const _ of p)if(_.type==="slot"){const b=s.cq(_.id);t[b]&&d(t[b]),this._mergedSlots.push(b)}else{const b=s.aC(_.id,_.scope);this._mergedOrder.push(b),c[b]=_,_.is3D()&&(this._has3DLayers=!0),_.type==="circle"&&(this._hasCircleLayers=!0),_.type==="symbol"&&(this._hasSymbolLayers=!0),_.type==="clip"&&(this._clipLayerPresent=!0)}};d(n),this._mergedOrder.sort((p,_)=>{const b=c[p],E=c[_];return b.hasInitialOcclusionOpacityProperties?E.is3D()?1:0:b.is3D()&&E.hasInitialOcclusionOpacityProperties?-1:0}),this._mergedLayers=c,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=s.l({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(t){return t.data?function(n,c,d){const p=s.l({},c);for(const b of Object.keys(s.a3.colorTheme))p[b]===void 0&&(p[b]=s.a3.colorTheme[b].default);const _=new s.a4(Km,n,new Map(d));return _.setTransitionOrValue(p,d),_.untransitioned().possiblyEvaluate(new s.a8(0))}(this.scope,t,this.options).get("data"):null}_loadColorTheme(t){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const n=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((c,d)=>{const p="data:image/png;base64,";if(!t||t.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void c();let _=t;_.startsWith(p)||(_=p+_);const b="mapbox-reserved-lut",E=new Image;E.src=_,E.onerror=()=>{this._styleColorTheme.lutLoading=!1,d(new Error("Failed to load image data"))},E.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==n)return void c();this._styleColorTheme.lutLoading=!1;const{width:I,height:A,data:R}=s.q.getImageData(E);if(A>32)return void d(new Error("The height of the image must be less than or equal to 32 pixels."));if(I!==A*A)return void d(new Error("The width of the image must be equal to the height squared."));this.getImage(b)&&this.removeImage(b),this.addImage(b,{data:new s.r({width:I,height:A},R),pixelRatio:1,sdf:!1,usvg:!1,version:0});const D=this.imageManager.getImage(b,this.scope);D?(this._styleColorTheme.lut={image:D.data,data:t},c()):d(new Error("Missing LUT image."))}})}getLut(t){const n=this._styleColorThemeForScope[t];return n?n.lut:null}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=function(n,c,d){let p,_,b;const E=s.q.devicePixelRatio>1?"@2x":"";let I=s.n(c.transformRequest(c.normalizeSpriteURL(n,E,".json"),s.R.SpriteJSON),(D,F)=>{I=null,b||(b=D,p=F,R())}),A=s.o(c.transformRequest(c.normalizeSpriteURL(n,E,".png"),s.R.SpriteImage),(D,F)=>{A=null,b||(b=D,_=F,R())});function R(){if(b)d(b);else if(p&&_){const D=s.q.getImageData(_),F={};for(const q in p){const{width:U,height:H,x:Z,y:J,sdf:re,pixelRatio:ne,stretchX:de,stretchY:le,content:he}=p[q],ae=new s.r({width:U,height:H});s.r.copy(D,ae,{x:Z,y:J},{x:0,y:0},{width:U,height:H},null),F[q]={data:ae,pixelRatio:ne,sdf:re,stretchX:de,stretchY:le,content:he,usvg:!1}}d(null,F)}}return{cancel(){I&&(I.cancel(),I=null),A&&(A.cancel(),A=null)}}}(t,this.map._requestManager,(n,c)=>{if(this._spriteRequest=null,n)this.fire(new s.y(n));else if(c)for(const d in c)this.imageManager.addImage(d,this.scope,c[d]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new s.z("data",{dataType:"style"}))})}_loadIconset(t){if(!s.f(t)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(t);const n=this.map._spriteFormat==="auto";var c,d;this._spriteRequest=(d=(p,_)=>{if(this._spriteRequest=null,p)n?this._loadSprite(t):this.fire(new s.y(p));else if(_)for(const b in _)this.imageManager.addImage(b,this.scope,_[b]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new s.z("data",{dataType:"style"}))},s.bi((c=this.map._requestManager).transformRequest(c.normalizeIconsetURL(t),s.R.Iconset),(p,_)=>{if(p)return void d(p);const b={},E=s.cg(new s.bh(_));for(const I of E.icons){const A={version:1,pixelRatio:s.q.devicePixelRatio,content:Jm(I),stretchX:I.metadata?Sf(I.metadata.stretch_x_areas):void 0,stretchY:I.metadata?Sf(I.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:I};b[I.name]=A}d(null,b)}))}_validateLayer(t){const n=this.getOwnSource(t.source);if(!n)return;const c=t.sourceLayer;c&&(n.type==="geojson"||n.vectorLayerIds&&n.vectorLayerIds.indexOf(c)===-1)&&this.fire(new s.y(new Error(`Source layer "${c}" does not exist on source "${n.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(const{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((t,n)=>{const c=this.fragments[n];return c&&c.style&&(t.data=c.style.serialize()),t})}_serializeSources(){const t={};for(const n in this._sourceCaches){const c=this._sourceCaches[n].getSource();t[c.id]||(t[c.id]=c.serialize())}return t}_serializeLayers(t){const n=[];for(const c of t){const d=this._layers[c];d&&d.type!=="custom"&&n.push(d.serialize())}return n}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(const t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(t){return t?this.order:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&t.isDraped(this.getLayerSourceCache(t))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){const n=this.getOwnLayer(t);if(n)return n;this.fire(new s.y(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){const n=this.getOwnSource(t);if(n)return n;this.fire(new s.y(new Error(`The source '${t}' does not exist in the map's style.`)))}precompilePrograms(t,n){const c=this.map.painter;if(c)for(let d=t.minzoom||0;d<(t.maxzoom||25.5);d++){const p=t.getProgramIds();if(p)for(const _ of p){const b=t.getDefaultProgramParams(_,n.zoom,this._styleColorTheme.lut);b&&(c.style=this,this.fog&&(c._fogVisible=!0,b.overrideFog=!0,c.getOrCreateProgram(_,b)),c._fogVisible=!1,b.overrideFog=!1,c.getOrCreateProgram(_,b),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(b.overrideRtt=!0,c.getOrCreateProgram(_,b)))}}}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);const n=this.calculateLightsBrightness();t.brightness=n||0,n!==this._brightness&&(this._brightness=n,this.dispatcher.broadcast("setBrightness",n));const c=this._changes.isDirty();let d=!1;if(this._changes.isDirty()){const _=this._changes.getLayerUpdatesByScope();for(const b in _){const{updatedIds:E,removedIds:I}=_[b];(E||I)&&(this._updateWorkerLayers(b,E,I),d=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this.snow&&this.snow.updateTransitions(t),this.rain&&this.rain.updateTransitions(t),this._changes.reset()}const p={};for(const _ in this._mergedSourceCaches){const b=this._mergedSourceCaches[_];p[_]=b.used,b.used=!1,b.tileCoverLift=0}for(const _ of this._mergedOrder){const b=this._mergedLayers[_];if(b.recalculate(t,this._availableImages),!b.isHidden(t.zoom)){const E=this.getLayerSourceCache(b);E&&(E.used=!0,E.tileCoverLift=Math.max(E.tileCoverLift,b.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(b,t)}):this.precompilePrograms(b,t))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&d&&this.mergeLayers();for(const _ in p){const b=this._mergedSourceCaches[_];p[_]!==b.used&&b.getSource().fire(new s.z("data",{sourceDataType:"visibility",dataType:"source",sourceId:b.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.snow&&this.snow.recalculate(t),this.rain&&this.rain.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),c&&this.fire(new s.z("data",{dataType:"style"}))}_updateTilesForChangedImages(){const t=this._changes.getUpdatedImages();if(t.length){for(const n in this._sourceCaches)this._sourceCaches[n].reloadTilesForDependencies(["icons","patterns"],t);this._changes.resetUpdatedImages()}}_updateWorkerLayers(t,n,c){const d=this.getFragmentStyle(t);d&&this.dispatcher.broadcast("updateLayers",{layers:n?d._serializeLayers(n):[],scope:t,removedIds:c||[],options:d.options})}setState(t,n){if(this._checkLoaded(),Ho(this,xr(t)))return!1;(t=s.cp(t)).layers=Fc(t.layers);const c=function(_,b){if(!_)return[{command:li.setStyle,args:[b]}];let E=[];try{if(!s.bn(_.version,b.version))return[{command:li.setStyle,args:[b]}];if(s.bn(_.center,b.center)||E.push({command:li.setCenter,args:[b.center]}),s.bn(_.zoom,b.zoom)||E.push({command:li.setZoom,args:[b.zoom]}),s.bn(_.bearing,b.bearing)||E.push({command:li.setBearing,args:[b.bearing]}),s.bn(_.pitch,b.pitch)||E.push({command:li.setPitch,args:[b.pitch]}),s.bn(_.sprite,b.sprite)||E.push({command:li.setSprite,args:[b.sprite]}),s.bn(_.glyphs,b.glyphs)||E.push({command:li.setGlyphs,args:[b.glyphs]}),s.bn(_.imports,b.imports)||function(F=[],q=[],U){q=q||[];const H=(F=F||[]).map(Yn),Z=q.map(Yn),J=F.reduce(qs,{}),re=q.reduce(qs,{}),ne=H.slice();let de,le,he,ae;for(de=0,le=0;de<H.length;de++)he=H[de],re.hasOwnProperty(he)?le++:(U.push({command:li.removeImport,args:[he]}),ne.splice(ne.indexOf(he,le),1));for(de=0,le=0;de<Z.length;de++)he=Z[Z.length-1-de],ne[ne.length-1-de]!==he&&(J.hasOwnProperty(he)?(U.push({command:li.removeImport,args:[he]}),ne.splice(ne.lastIndexOf(he,ne.length-le),1)):le++,ae=ne[ne.length-de],U.push({command:li.addImport,args:[re[he],ae]}),ne.splice(ne.length-de,0,he));for(const ge of q){const Te=J[ge.id];Te&&!s.bn(Te,ge)&&U.push({command:li.updateImport,args:[ge.id,ge]})}}(_.imports,b.imports,E),s.bn(_.transition,b.transition)||E.push({command:li.setTransition,args:[b.transition]}),s.bn(_.light,b.light)||E.push({command:li.setLight,args:[b.light]}),s.bn(_.fog,b.fog)||E.push({command:li.setFog,args:[b.fog]}),s.bn(_.snow,b.snow)||E.push({command:li.setSnow,args:[b.snow]}),s.bn(_.rain,b.rain)||E.push({command:li.setRain,args:[b.rain]}),s.bn(_.projection,b.projection)||E.push({command:li.setProjection,args:[b.projection]}),s.bn(_.lights,b.lights)||E.push({command:li.setLights,args:[b.lights]}),s.bn(_.camera,b.camera)||E.push({command:li.setCamera,args:[b.camera]}),!s.bn(_["color-theme"],b["color-theme"]))return[{command:li.setStyle,args:[b]}];const I={},A=[];(function(F,q,U,H){let Z;for(Z in q=q||{},F=F||{})F.hasOwnProperty(Z)&&(q.hasOwnProperty(Z)||Vo(Z,U,H));for(Z in q){if(!q.hasOwnProperty(Z))continue;const J=q[Z];F.hasOwnProperty(Z)?s.bn(F[Z],J)||(F[Z].type==="geojson"&&J.type==="geojson"&&Ci(F,q,Z)?U.push({command:li.setGeoJSONSourceData,args:[Z,J.data]}):Ct(Z,q,U,H)):Bc(Z,q,U)}})(_.sources,b.sources,A,I);const R=[];_.layers&&_.layers.forEach(F=>{F.source&&I[F.source]?E.push({command:li.removeLayer,args:[F.id]}):R.push(F)});let D=_.terrain;D&&I[D.source]&&(E.push({command:li.setTerrain,args:[void 0]}),D=void 0),E=E.concat(A),s.bn(D,b.terrain)||E.push({command:li.setTerrain,args:[b.terrain]}),function(F,q,U){q=q||[];const H=(F=F||[]).map(Yn),Z=q.map(Yn),J=F.reduce(qs,{}),re=q.reduce(qs,{}),ne=H.slice(),de=Object.create(null);let le,he,ae,ge,Te,Ue,Le;for(le=0,he=0;le<H.length;le++)ae=H[le],re.hasOwnProperty(ae)?he++:(U.push({command:li.removeLayer,args:[ae]}),ne.splice(ne.indexOf(ae,he),1));for(le=0,he=0;le<Z.length;le++)ae=Z[Z.length-1-le],ne[ne.length-1-le]!==ae&&(J.hasOwnProperty(ae)?(U.push({command:li.removeLayer,args:[ae]}),ne.splice(ne.lastIndexOf(ae,ne.length-he),1)):he++,Ue=ne[ne.length-le],U.push({command:li.addLayer,args:[re[ae],Ue]}),ne.splice(ne.length-le,0,ae),de[ae]=!0);for(le=0;le<Z.length;le++)if(ae=Z[le],ge=J[ae],Te=re[ae],!de[ae]&&!s.bn(ge,Te))if(s.bn(ge.source,Te.source)&&s.bn(ge["source-layer"],Te["source-layer"])&&s.bn(ge.type,Te.type)){for(Le in yi(ge.layout,Te.layout,U,ae,null,li.setLayoutProperty),yi(ge.paint,Te.paint,U,ae,null,li.setPaintProperty),s.bn(ge.slot,Te.slot)||U.push({command:li.setSlot,args:[ae,Te.slot]}),s.bn(ge.filter,Te.filter)||U.push({command:li.setFilter,args:[ae,Te.filter]}),s.bn(ge.minzoom,Te.minzoom)&&s.bn(ge.maxzoom,Te.maxzoom)||U.push({command:li.setLayerZoomRange,args:[ae,Te.minzoom,Te.maxzoom]}),ge)ge.hasOwnProperty(Le)&&Le!=="layout"&&Le!=="paint"&&Le!=="filter"&&Le!=="metadata"&&Le!=="minzoom"&&Le!=="maxzoom"&&Le!=="slot"&&(Le.indexOf("paint.")===0?yi(ge[Le],Te[Le],U,ae,Le.slice(6),li.setPaintProperty):s.bn(ge[Le],Te[Le])||U.push({command:li.setLayerProperty,args:[ae,Le,Te[Le]]}));for(Le in Te)Te.hasOwnProperty(Le)&&!ge.hasOwnProperty(Le)&&Le!=="layout"&&Le!=="paint"&&Le!=="filter"&&Le!=="metadata"&&Le!=="minzoom"&&Le!=="maxzoom"&&Le!=="slot"&&(Le.indexOf("paint.")===0?yi(ge[Le],Te[Le],U,ae,Le.slice(6),li.setPaintProperty):s.bn(ge[Le],Te[Le])||U.push({command:li.setLayerProperty,args:[ae,Le,Te[Le]]}))}else U.push({command:li.removeLayer,args:[ae]}),Ue=ne[ne.lastIndexOf(ae)+1],U.push({command:li.addLayer,args:[Te,Ue]})}(R,b.layers,E)}catch(I){console.warn("Unable to compute style diff:",I),E=[{command:li.setStyle,args:[b]}]}return E}(this.serialize(),t).filter(_=>!(_.command in Ef));if(c.length===0)return!1;const d=c.filter(_=>!(_.command in Qm));if(d.length>0)throw new Error(`Unimplemented: ${d.map(_=>_.command).join(", ")}.`);const p=[];return c.forEach(_=>{p.push(this[_.command].apply(this,_.args))}),n&&Promise.all(p).then(n),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}addImage(t,n){return this.getImage(t)?this.fire(new s.y(new Error("An image with this name already exists."))):(this.imageManager.addImage(t,this.scope,n),this._afterImageUpdated(t),this)}updateImage(t,n,c=!1){this.imageManager.updateImage(t,this.scope,n),c&&this._afterImageUpdated(t)}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._afterImageUpdated(t),this):this.fire(new s.y(new Error("No image with this name exists.")))}_afterImageUpdated(t){this._availableImages=this.imageManager.listImages(this.scope),this._changes.updateImage(t),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.fire(new s.z("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(t,n,c={}){return this._checkLoaded(),this._validate(pl,`models.${t}`,n,null,c)||(this.modelManager.addModel(t,n,this.scope),this._changes.setDirty()),this}hasModel(t){return this.modelManager.hasModel(t,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope),this):this.fire(new s.y(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,n,c={}){if(this._checkLoaded(),this.getOwnSource(t)!==void 0)throw new Error(`There is already a source with ID "${t}".`);if(!n.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(n).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(n.type)>=0&&this._validate(Us,`sources.${t}`,n,null,c))return;this.map&&this.map._collectResourceTiming&&(n.collectResourceTiming=!0);const d=or(t,n,this.dispatcher,this);d.scope=this.scope,d.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(d.id),source:d.serialize(),sourceId:d.id}));const p=_=>{const b=(_?"symbol:":"other:")+d.id,E=s.aC(b,this.scope),I=this._sourceCaches[b]=new Nr(E,d,_);(_?this._symbolSourceCaches:this._otherSourceCaches)[d.id]=I,I.onAdd(this.map)};p(!1),n.type!=="vector"&&n.type!=="geojson"||p(!0),d.onAdd&&d.onAdd(this.map),c.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();const n=this.getOwnSource(t);if(!n)throw new Error("There is no source with this ID");for(const d in this._layers)if(this._layers[d].source===t)return this.fire(new s.y(new Error(`Source "${t}" cannot be removed while layer "${d}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new s.y(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));const c=this.getOwnSourceCaches(t);for(const d of c){const p=s.cq(d.id);delete this._sourceCaches[p],this._changes.discardSourceCacheUpdate(d.id),d.fire(new s.z("data",{sourceDataType:"metadata",dataType:"source",sourceId:d.getSource().id})),d.setEventedParent(null),d.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),n.setEventedParent(null),n.onRemove&&n.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(t,n){this._checkLoaded(),this.getOwnSource(t).setData(n),this._changes.setDirty()}getOwnSource(t){const n=this.getOwnSourceCache(t);return n&&n.getSource()}getOwnSources(){const t=[];for(const n in this._otherSourceCaches){const c=this.getOwnSourceCache(n);c&&t.push(c.getSource())}return t}areTilesLoaded(){const t=this._mergedSourceCaches;for(const n in t){const c=t[n]._tiles;for(const d in c){const p=c[d];if(p.state!=="loaded"&&p.state!=="errored")return!1}}return!0}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;const n=this._getTransitionParameters();for(const d of t){if(this._validate(Ma,"lights",d))return;switch(d.type){case"ambient":if(this.ambientLight){const p=this.ambientLight;p.set(d),p.updateTransitions(n)}else this.ambientLight=new jt(d,ht||(ht=new s.a5({color:new s.a6(s.a3.properties_light_ambient.color),"color-use-theme":new s.a6({type:"string",default:"default","property-type":"data-constant"}),intensity:new s.a6(s.a3.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const p=this.directionalLight;p.set(d),p.updateTransitions(n)}else this.directionalLight=new jt(d,dt||(dt=new s.a5({direction:new s.ak(s.a3.properties_light_directional.direction),color:new s.a6(s.a3.properties_light_directional.color),"color-use-theme":new s.a6({type:"string",default:"default","property-type":"data-constant"}),intensity:new s.a6(s.a3.properties_light_directional.intensity),"cast-shadows":new s.a6(s.a3.properties_light_directional["cast-shadows"]),"shadow-quality":new s.a6(s.a3.properties_light_directional["shadow-quality"]),"shadow-intensity":new s.a6(s.a3.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const c=new s.a8(this.z||0,n);this.ambientLight&&this.ambientLight.recalculate(c),this.directionalLight&&this.directionalLight.recalculate(c),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const t=this.directionalLight,n=this.ambientLight;if(!t||!n)return;const c=D=>.2126*(D[0]<=.03928?D[0]/12.92:Math.pow((D[0]+.055)/1.055,2.4))+.7152*(D[1]<=.03928?D[1]/12.92:Math.pow((D[1]+.055)/1.055,2.4))+.0722*(D[2]<=.03928?D[2]/12.92:Math.pow((D[2]+.055)/1.055,2.4)),d=t.properties.get("color").toRenderColor(null).toArray01(),p=t.properties.get("intensity"),_=t.properties.get("direction"),b=1-s.cb(_.x,_.y,_.z)[2]/90,E=c(d)*p*b,I=n.properties.get("color").toRenderColor(null).toArray01(),A=n.properties.get("intensity"),R=c(I)*A;return Number(((E+R)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(!t)return this;if(s.cr(t)){const n=s.cs(t),c=this.fragments.find(({id:p})=>p===n);if(!c)throw new Error(`Style import '${t}' not found`);const d=s.cq(t);return c.style.getFragmentStyle(d)}{const n=this.fragments.find(({id:c})=>c===t);return n?n.style:void 0}}setFeaturesetSelectors(t){if(!t)return;const n={},c=(d,p="")=>`${d}::${p}`;this._featuresetSelectors={};for(const d in t){const p=this._featuresetSelectors[d]=[];for(const _ of t[d].selectors){if(_.featureNamespace){const E=this.getOwnLayer(_.layer);if(!E){s.w(`Layer is undefined for selector: ${_.layer}`);continue}const I=c(E.source,E.sourceLayer);if(I in n&&n[I]!==_.featureNamespace){s.w(`"featureNamespace ${_.featureNamespace} of featureset ${d}'s selector is not associated to the same source, skip this selector`);continue}n[I]=_.featureNamespace}let b;if(_.properties)for(const E in _.properties){const I=s.U(_.properties[E]);I.result==="success"&&(b=b||{},b[E]=I.value)}p.push({layerId:_.layer,namespace:_.featureNamespace,properties:b,uniqueFeatureID:_._uniqueFeatureID})}}}getFeaturesetDescriptors(t){const n=this.getFragmentStyle(t);if(!n||!n.stylesheet.featuresets)return[];const c=[];for(const d in n.stylesheet.featuresets)c.push({featuresetId:d,importId:n.scope?n.scope:void 0});return c}getFeaturesetLayers(t,n){const c=this.getFragmentStyle(n),d=c.stylesheet.featuresets;if(!d||!d[t])return this.fire(new s.y(new Error(`The featureset '${t}' does not exist in the map's style and cannot be queried.`))),[];const p=[];for(const _ of d[t].selectors){const b=c.getOwnLayer(_.layer);b&&p.push(b)}return p}getConfigProperty(t,n){const c=this.getFragmentStyle(t);if(!c)return null;const d=s.aC(n,c.scope),p=c.options.get(d),_=p?p.value||p.default:null;return _?_.serialize():null}setConfigProperty(t,n,c){const d=this.getFragmentStyle(t);if(!d)return;const p=d.stylesheet.indoor?bh(d.stylesheet.schema):d.stylesheet.schema;if(!p||!p[n])return;const _=s.U(c);if(_.result!=="success")return void Ho(this,_.value);const b=_.value.expression,E=s.aC(n,d.scope),I=d.options.get(E);if(!I)return;let A;const{minValue:R,maxValue:D,stepValue:F,type:q,values:U}=p[n],H=s.U(p[n].default);H.result==="success"&&(A=H.value.expression),A?(this.options.set(E,Object.assign({},I,{value:b,default:A,minValue:R,maxValue:D,stepValue:F,type:q,values:U})),this.updateConfigDependencies(n)):this.fire(new s.y(new Error(`No schema defined for the config option "${n}" in the "${t}" fragment.`)))}getConfig(t){const n=this.getFragmentStyle(t);if(!n)return null;const c=n.stylesheet.schema;if(!c)return null;const d={};for(const p in c){const _=s.aC(p,n.scope),b=n.options.get(_),E=b?b.value||b.default:null;d[p]=E?E.serialize():null}return d}setConfig(t,n){const c=this.getFragmentStyle(t);c&&(c.updateConfig(n,c.stylesheet.schema),this.updateConfigDependencies())}getSchema(t){const n=this.getFragmentStyle(t);return n?n.stylesheet.schema:null}setSchema(t,n){const c=this.getFragmentStyle(t);c&&(c.stylesheet.schema=n,c.updateConfig(c._config,n),this.updateConfigDependencies())}updateConfig(t,n){if(this._config=t,t||n)if(n)for(const c in n){let d,p;const _=s.U(n[c].default);if(_.result==="success"&&(d=_.value.expression),t&&t[c]!==void 0){const D=s.U(t[c]);D.result==="success"&&(p=D.value.expression)}const{minValue:b,maxValue:E,stepValue:I,type:A,values:R}=n[c];if(d){const D=s.aC(c,this.scope);this.options.set(D,{default:d,value:p,minValue:b,maxValue:E,stepValue:I,type:A,values:R})}else this.fire(new s.y(new Error(`No schema defined for config option "${c}".`)))}else this.fire(new s.y(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(t){for(const n of this._configDependentLayers){const c=this.getLayer(n);if(c){if(t&&!c.configDependencies.has(t))continue;c.possiblyEvaluateVisibility(),this._updateLayer(c)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(n=>{const c=n._styleColorTheme.colorThemeOverride?n._styleColorTheme.colorThemeOverride:n._styleColorTheme.colorTheme;if(c){const d=n._evaluateColorThemeData(c);(!n._styleColorTheme.lut&&d!==""||n._styleColorTheme.lut&&d!==n._styleColorTheme.lut.data)&&n.setColorTheme(c)}}),this._changes.setDirty()}addLayer(t,n,c={}){this._checkLoaded();const d=t.id;if(this._layers[d])return void this.fire(new s.y(new Error(`Layer with id "${d}" already exists on this map`)));let p;if(t.type==="custom"){if(Ho(this,s.ct(t)))return;p=s.cu(t,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof t.source=="object"&&(this.addSource(d,t.source),t=s.cp(t),t=s.l(t,{source:d})),this._validate(Dc,`layers.${d}`,t,{arrayIndex:-1},c))return;p=s.cu(t,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(p),p.setEventedParent(this,{layer:{id:d}})}p.configDependencies.size!==0&&this._configDependentLayers.add(p.fqid);let _=this._order.length;if(n){const A=this._order.indexOf(n);if(A===-1)return void this.fire(new s.y(new Error(`Layer with id "${n}" does not exist on this map.`)));p.slot===this._layers[n].slot?_=A:s.w(`Layer with id "${n}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(_,0,d),this._layerOrderChanged=!0,this._layers[d]=p;const b=this.getOwnLayerSourceCache(p),E=!!this.directionalLight&&this.directionalLight.shadowsEnabled();b&&p.canCastShadows()&&E&&(b.castsShadows=!0);const I=this._changes.getRemovedLayer(p);if(I&&p.source&&b&&p.type!=="custom"){this._changes.discardLayerRemoval(p);const A=s.aC(p.source,p.scope);I.type!==p.type?this._changes.updateSourceCache(A,"clear"):(this._changes.updateSourceCache(A,"reload"),b.pause())}this._updateLayer(p),p.onAdd&&p.onAdd(this.map),p.scope=this.scope,this.mergeLayers()}moveLayer(t,n){this._checkLoaded();const c=this._checkLayer(t);if(!c||t===n)return;const d=this._order.indexOf(t);this._order.splice(d,1);let p=this._order.length;if(n){const _=this._order.indexOf(n);if(_===-1)return void this.fire(new s.y(new Error(`Layer with id "${n}" does not exist on this map.`)));c.slot===this._layers[n].slot?p=_:s.w(`Layer with id "${n}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(p,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(t){this._checkLoaded();const n=this._checkLayer(t);if(!n)return;n.setEventedParent(null);const c=this._order.indexOf(t);this._order.splice(c,1),delete this._layers[t],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(n.fqid),this._changes.removeLayer(n);const d=this.getOwnLayerSourceCache(n);if(d&&d.castsShadows){let p=!1;for(const _ in this._layers)if(this._layers[_].source===n.source&&this._layers[_].canCastShadows()){p=!0;break}d.castsShadows=p}n.onRemove&&n.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(const n in this._layers)if(this._layers[n].type===t)return!0;return!1}setLayerZoomRange(t,n,c){this._checkLoaded();const d=this._checkLayer(t);d&&(d.minzoom===n&&d.maxzoom===c||(n!=null&&(d.minzoom=n),c!=null&&(d.maxzoom=c),this._updateLayer(d)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(t,n){this._checkLoaded();const c=this._checkLayer(t);c&&c.slot!==n&&(c.slot=n,this._updateLayer(c))}setFilter(t,n,c={}){this._checkLoaded();const d=this._checkLayer(t);if(d&&!s.bn(d.filter,n))return n==null?(d.filter=void 0,void this._updateLayer(d)):void(this._validate(Mn,`layers.${d.id}.filter`,n,{layerType:d.type},c)||(d.filter=s.cp(n),this._updateLayer(d)))}getFilter(t){const n=this._checkLayer(t);if(n)return s.cp(n.filter)}setLayoutProperty(t,n,c,d={}){this._checkLoaded();const p=this._checkLayer(t);if(p&&!s.bn(p.getLayoutProperty(n),c)){if(c!=null&&(!d||d.validate!==!1)&&Ho(p,Lc.call(xr,{key:`layers.${t}.layout.${n}`,layerType:p.type,objectKey:n,value:c,styleSpec:s.a3,style:{glyphs:!0,sprite:!0}})))return;p.setLayoutProperty(n,c),p.configDependencies.size!==0&&this._configDependentLayers.add(p.fqid),this._updateLayer(p)}}getLayoutProperty(t,n){const c=this._checkLayer(t);if(c)return c.getLayoutProperty(n)}setPaintProperty(t,n,c,d={}){this._checkLoaded();const p=this._checkLayer(t);if(!p||s.bn(p.getPaintProperty(n),c)||c!=null&&(!d||d.validate!==!1)&&Ho(p,fl.call(xr,{key:`layers.${t}.paint.${n}`,layerType:p.type,objectKey:n,value:c,styleSpec:s.a3})))return;const _=p.setPaintProperty(n,c);p.configDependencies.size!==0&&this._configDependentLayers.add(p.fqid),_&&this._updateLayer(p),this._changes.updatePaintProperties(p)}getPaintProperty(t,n){const c=this._checkLayer(t);if(c)return c.getPaintProperty(n)}setFeatureState(t,n){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:E,importId:I}=t.target,A=this.getFragmentStyle(I),R=A.getFeaturesetLayers(E);for(const{source:D,sourceLayer:F}of R)A.setFeatureState({id:t.id,source:D,sourceLayer:F},n)}else if("layerId"in t.target){const{layerId:E}=t.target,I=this.getLayer(E);this.setFeatureState({id:t.id,source:I.source,sourceLayer:I.sourceLayer},n)}return}const c=t.source,d=t.sourceLayer,p=this._checkSource(c);if(!p)return;const _=p.type;if(_==="geojson"&&d)return void this.fire(new s.y(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(_==="vector"&&!d)return void this.fire(new s.y(new Error("The sourceLayer parameter must be provided for vector source types.")));t.id===void 0&&this.fire(new s.y(new Error("The feature id parameter must be provided.")));const b=this.getOwnSourceCaches(c);for(const E of b)E.setFeatureState(d,t.id,n)}removeFeatureState(t,n){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:E,importId:I}=t.target,A=this.getFragmentStyle(I),R=A.getFeaturesetLayers(E);for(const{source:D,sourceLayer:F}of R)A.removeFeatureState({id:t.id,source:D,sourceLayer:F},n)}else if("layerId"in t.target){const{layerId:E}=t.target,I=this.getLayer(E);this.removeFeatureState({id:t.id,source:I.source,sourceLayer:I.sourceLayer},n)}return}const c=t.source,d=this._checkSource(c);if(!d)return;const p=d.type,_=p==="vector"?t.sourceLayer:void 0;if(p==="vector"&&!_)return void this.fire(new s.y(new Error("The sourceLayer parameter must be provided for vector source types.")));if(n&&typeof t.id!="string"&&typeof t.id!="number")return void this.fire(new s.y(new Error("A feature id is required to remove its specific state property.")));const b=this.getOwnSourceCaches(c);for(const E of b)E.removeFeatureState(_,t.id,n)}getFeatureState(t){if(this._checkLoaded(),"target"in t){let p;if("featuresetId"in t.target){const{featuresetId:_,importId:b}=t.target,E=this.getFragmentStyle(b),I=E.getFeaturesetLayers(_);for(const{source:A,sourceLayer:R}of I){const D=E.getFeatureState({id:t.id,source:A,sourceLayer:R});if(D&&!p)p=D;else if(!s.bn(p,D))return void this.fire(new s.y(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in t.target){const{layerId:_}=t.target,b=this.getLayer(_);p=this.getFeatureState({id:t.id,source:b.source,sourceLayer:b.sourceLayer})}return p}const n=t.source,c=t.sourceLayer,d=this._checkSource(n);if(d){if(d.type!=="vector"||c)return t.id===void 0&&this.fire(new s.y(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(n)[0].getFeatureState(c,t.id);this.fire(new s.y(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=s.l({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return s.l({},this.stylesheet.transition)}serialize(){this._checkLoaded();const t=this.getTerrain(),n=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return s.cv({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:n,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},c=>c!==void 0)}_updateFilteredLayers(t){for(const n of Object.values(this._mergedLayers))t(n)&&this._updateLayer(n)}_updateLayer(t){this._changes.updateLayer(t);const n=this.getLayerSourceCache(t),c=s.aC(t.source,t.scope),d=this._changes.getUpdatedSourceCaches();t.source&&!d[c]&&n&&n.getSource().type!=="raster"&&(this._changes.updateSourceCache(c,"reload"),n.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){const n=b=>this._mergedLayers[b].is3D(),c=this.order,d={},p=[];for(let b=c.length-1;b>=0;b--){const E=c[b];if(n(E)){d[E]=b;for(const I of t){const A=I[E];if(A)for(const R of A)p.push(R)}}}p.sort((b,E)=>E.intersectionZ-b.intersectionZ);const _=[];for(let b=c.length-1;b>=0;b--){const E=c[b];if(n(E))for(let I=p.length-1;I>=0;I--){const A=p[I].feature;if(A.layer&&d[A.layer.id]<b)break;_.push(A),p.pop()}else for(const I of t){const A=I[E];if(A)for(const R of A)_.push(R.feature)}}return _}queryRenderedFeatures(t,n,c){let d;n&&!Array.isArray(n)&&n.filter&&(this._validate(Mn,"queryRenderedFeatures.filter",n.filter,null,n),d=s.aZ(n.filter));const p={},_=A=>{if(Th.has(A.type))return;const R=this.getOwnLayerSourceCache(A),D=p[R.id]=p[R.id]||{sourceCache:R,layers:{},has3DLayers:!1};A.is3D()&&(D.has3DLayers=!0),D.layers[A.fqid]=D.layers[A.fqid]||{styleLayer:A,targets:[]},D.layers[A.fqid].targets.push({filter:d})};if(n&&n.layers){if(!Array.isArray(n.layers))return this.fire(new s.y(new Error("parameters.layers must be an Array."))),[];for(const A of n.layers){const R=this._layers[A];if(!R)return this.fire(new s.y(new Error(`The layer '${A}' does not exist in the map's style and cannot be queried for features.`))),[];_(R)}}else for(const A in this._layers)_(this._layers[A]);const b=this._queryRenderedFeatures(t,p,c),E=this._flattenAndSortRenderedFeatures(b),I=[];for(const A of E)s.cs(A.layer.id)===this.scope&&I.push(A);return I}queryRenderedFeatureset(t,n,c){let d;n&&!Array.isArray(n)&&n.filter&&(this._validate(Mn,"queryRenderedFeatures.filter",n.filter,null,n),d=s.aZ(n.filter));const p="mock",_=[];if(n&&n.target)_.push(Object.assign({},n,{targetId:p,filter:d}));else{const A=this.getFeaturesetDescriptors();for(const R of A)_.push({targetId:p,filter:d,target:R});for(const{style:R}of this.fragments){const D=R.getFeaturesetDescriptors();for(const F of D)_.push({targetId:p,filter:d,target:F})}}const b=this.queryRenderedTargets(t,_,c),E=[],I=new Set;for(const A of b)for(const R of A.variants[p])js(R,A,I)||E.push(new s.cw(A,R));return E}queryRenderedTargets(t,n,c){const d={},p=(b,E,I,A)=>{const R=d[E.id]=d[E.id]||{sourceCache:E,layers:{},has3DLayers:!1};if(R.layers[b.fqid]=R.layers[b.fqid]||{styleLayer:b,targets:[]},b.is3D()&&(R.has3DLayers=!0),!A)return I.uniqueFeatureID=!1,void R.layers[b.fqid].targets.push(I);R.layers[b.fqid].targets.push(Object.assign({},I,{namespace:A.namespace,properties:A.properties,uniqueFeatureID:A.uniqueFeatureID}))};for(const b of n)if("featuresetId"in b.target){const{featuresetId:E,importId:I}=b.target,A=this.getFragmentStyle(I);if(!A||!A._featuresetSelectors)continue;const R=A._featuresetSelectors[E];if(!R){this.fire(new s.y(new Error(`The featureset '${E}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const D of R){const F=A.getOwnLayer(D.layerId);F&&!Th.has(F.type)&&p(F,A.getOwnLayerSourceCache(F),b,D)}}else if("layerId"in b.target){const{layerId:E}=b.target,I=this.getLayer(E);if(!I||Th.has(I.type))continue;p(I,this.getLayerSourceCache(I),b)}const _=this._queryRenderedFeatures(t,d,c);return this._flattenAndSortRenderedFeatures(_)}_queryRenderedFeatures(t,n,c){const d=[],p=!!this.map._showQueryGeometry,_=Vt.createFromScreenPoints(t,c);for(const b in n){const E=_l(_,n[b],this._availableImages,c,p);Object.keys(E).length&&d.push(E)}if(this.placement)for(const b in n){if(!n[b].sourceCache._onlySymbols)continue;const E=ih(_.screenGeometry,n[b],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData);Object.keys(E).length&&d.push(E)}return d}querySourceFeatures(t,n){const c=n&&n.filter;c&&this._validate(Mn,"querySourceFeatures.filter",c,null,n);let d=[];const p=this.getOwnSourceCaches(t);for(const _ of p)d=d.concat(xf(_,n));return d}addSourceType(t,n,c){return Ur.getSourceType(t)?c(new Error(`A source type called "${t}" already exists.`)):(Ur.setSourceType(t,n),n.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:n.workerSourceURL},c):c(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,n,c={}){this._checkLoaded();const d=this.light.getLight();let p=!1;for(const b in t)if(!s.bn(t[b],d[b])){p=!0;break}if(!p)return;const _=this._getTransitionParameters();this.light.setLight(t,n,c),this.light.updateTransitions(_)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=s.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&s.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(t,n=1){if(this._checkLoaded(),!t)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),n===0&&delete this.terrain,t===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let c=t;const d=t.source==null;if(n===1){if(this.disableElevatedTerrain)return;if(typeof c.source=="object"){const b="terrain-dem-src";this.addSource(b,c.source),c=s.cp(c),c=s.l(c,{source:b})}const p=s.l({},c),_={};if(this.terrain&&d){p.source=this.terrain.get().source;const b=this.terrain?this.getFragmentStyle(this.terrain.scope):null;b&&(_.style=b.serialize())}if(this._validate(Ia,"terrain",p,_))return}if(!this.terrain||this.terrain.scope!==this.scope&&!d||this.terrain&&n!==this.terrain.drapeRenderMode){if(!c)return;this._createTerrain(c,n),this.fire(new s.z("data",{dataType:"style"}))}else{const p=this.terrain,_=p.get();for(const b of Object.keys(s.a3.terrain))!c.hasOwnProperty(b)&&s.a3.terrain[b].default&&(c[b]=s.a3.terrain[b].default);for(const b in t)if(!s.bn(t[b],_[b])){p.set(t,this.options),this.stylesheet.terrain=t;const E=this._getTransitionParameters({duration:0});p.updateTransitions(E),this.fire(new s.z("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){const n=this.fog=new Oe(t,this.map.transform,this.scope,this.options);this.stylesheet.fog=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}_createSnow(t){const n=this.snow=new Ot(t,this.map.transform,this.scope,this.options);this.stylesheet.snow=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}_createRain(t){const n=this.rain=new Ut(t,this.map.transform,this.scope,this.options);this.stylesheet.rain=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const t of this.map._markers)t._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const n=this.fog;if(!s.bn(n.get(),t)){n.set(t,this.options),this.stylesheet.fog=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}}else this._createFog(t);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(t){if(this._checkLoaded(),!t)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const n=this.snow;if(!s.bn(n.get(),t)){n.set(t,this.options),this.stylesheet.snow=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}}else this._createSnow(t);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(t){if(this._checkLoaded(),!t)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const n=this.rain;if(!s.bn(n.get(),t)){n.set(t,this.options),this.stylesheet.rain=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}}else this._createRain(t);this._markersNeedUpdate=!0}_reloadColorTheme(){const t=()=>{for(const d in this._layers)this._layers[d].lut=this._styleColorTheme.lut;for(const d in this._sourceCaches)this._sourceCaches[d].clearTiles()},n=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!n)return this._styleColorTheme.lut=null,void t();const c=this._evaluateColorThemeData(n);this._loadColorTheme(c).then(()=>{this.fire(new s.z("colorthemeset")),t()}).catch(d=>{s.w(`Couldn't set color theme: ${d}`)})}setColorTheme(t){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&s.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=t,this._reloadColorTheme()}setImportColorTheme(t,n){const c=this.getFragmentStyle(t);c&&(c._styleColorTheme.colorThemeOverride=n,c._reloadColorTheme())}_getTransitionParameters(t){return{now:s.q.now(),transition:s.l(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;const t=[],n=[];for(const c of this._mergedOrder)this.isLayerDraped(this._mergedLayers[c])?t.push(c):n.push(c);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...n)}_createTerrain(t,n){const c=this.terrain=new X(t,n,this.scope,this.options);n===1&&(this.stylesheet.terrain=t),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const d=this._getTransitionParameters({duration:0});c.updateTransitions(d)}_force3DLayerUpdate(){for(const t in this._layers){const n=this._layers[t];n.type==="fill-extrusion"&&this._updateLayer(n)}}_forceSymbolLayerUpdate(){for(const t in this._layers){const n=this._layers[t];n.type==="symbol"&&this._updateLayer(n)}}_validate(t,n,c,d,p={}){if(p&&p.validate===!1)return!1;const _=s.l({},this.serialize());return Ho(this,t.call(xr,s.l({key:n,style:_,value:c,styleSpec:s.a3},d)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),s.cx.off("pluginStateChange",this._rtlTextPluginCallback);for(const t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(t){const n=this.getSourceCaches(t);for(const c of n)c.clearTiles()}clearSources(){for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}reloadSource(t){const n=this.getSourceCaches(t);for(const c of n)c.resume(),c.reload()}reloadSources(){for(const t of this.getSources())t.reload&&t.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(t=>{t.modelManager.reloadModels(t.scope)})}updateSources(t){let n;this.directionalLight&&(n=Zo(this.directionalLight));for(const c in this._mergedSourceCaches)this._mergedSourceCaches[c].update(t,void 0,void 0,n)}_generateCollisionBoxes(){for(const t in this._sourceCaches){const n=this._sourceCaches[t];n.resume(),n.reload()}}_updatePlacement(t,n,c,d,p,_,b=!1){let E=!1,I=!1;const A={},R={};for(const D of this._mergedOrder){const F=this._mergedLayers[D];if(F.type!=="symbol")continue;const q=s.aC(F.source,F.scope);let U=A[q];if(!U){const Z=this.getLayerSourceCache(F);if(!Z)continue;const J=Z.getRenderableIds(!0).map(re=>Z.getTileByID(re));R[q]=J.slice(),U=A[q]=J.sort((re,ne)=>ne.tileID.overscaledZ-re.tileID.overscaledZ||(re.tileID.isLessThan(ne.tileID)?-1:1))}const H=this.crossTileSymbolIndex.addLayer(F,U,n.center.lng,n.projection);E=E||H}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),b=b||this._layerOrderChanged||d===0,this._layerOrderChanged&&this.fire(new s.z("neworder")),(b||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(s.q.now(),n.zoom))&&(this.pauseablePlacement=new Hm(n,this._mergedOrder,b,c,d,p,this.placement,this.fog&&n.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,A,R,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(s.q.now()),I=!0),E&&this.pauseablePlacement.placement.setStale()),I||E){this._buildingIndex.onNewFrame(n.zoom);for(let D=0;D<this._mergedOrder.length;D++){const F=this._mergedLayers[this._mergedOrder[D]];if(F.type!=="symbol")continue;const q=this.isLayerClipped(F);this.placement.updateLayerOpacities(F,A[s.aC(F.source,F.scope)],D,q?_:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(s.q.now())}}_releaseSymbolFadeTiles(){for(const t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t,n){this._checkLoaded();const c=this.stylesheet.imports=this.stylesheet.imports||[];if(c.findIndex(({id:p})=>p===t.id)!==-1)return void this.fire(new s.y(new Error(`Import with id '${t.id}' already exists in the map's style.`)));if(!n)return c.push(t),this._loadImports([t],!0);const d=c.findIndex(({id:p})=>p===n);return d===-1&&this.fire(new s.y(new Error(`Import with id "${n}" does not exist on this map.`))),this.stylesheet.imports=c.slice(0,d).concat(t).concat(c.slice(d)),this._loadImports([t],!0,n)}updateImport(t,n){this._checkLoaded();const c=this.stylesheet.imports||[],d=this.getImportIndex(t);return d===-1?this:typeof n=="string"?(this.setImportUrl(t,n),this):(n.url&&n.url!==c[d].url&&this.setImportUrl(t,n.url),s.bn(n.config,c[d].config)||this.setImportConfig(t,n.config,n.data.schema),s.bn(n.data,c[d].data)||this.setImportData(t,n.data),this)}moveImport(t,n){this._checkLoaded();let c=this.stylesheet.imports||[];const d=this.getImportIndex(t);if(d===-1)return this;const p=this.getImportIndex(n);if(p===-1)return this;const _=c[d],b=this.fragments[d];return c=c.filter(({id:E})=>E!==t),this.fragments=this.fragments.filter(({id:E})=>E!==t),this.stylesheet.imports=c.slice(0,p).concat(_).concat(c.slice(p)),this.fragments=this.fragments.slice(0,p).concat(b).concat(this.fragments.slice(p)),this.mergeLayers(),this}setImportUrl(t,n){this._checkLoaded();const c=this.stylesheet.imports||[],d=this.getImportIndex(t);if(d===-1)return this;c[d].url=n;const p=this.fragments[d];return p.style=this._createFragmentStyle(c[d]),p.style.on("style.import.load",()=>this.mergeAll()),p.style.loadURL(n),this}setImportData(t,n){this._checkLoaded();const c=this.getImportIndex(t),d=this.stylesheet.imports||[];return c===-1?this:n?(this.fragments[c].style.setState(n),this._reloadImports(),this):(delete d[c].data,this.setImportUrl(t,d[c].url))}setImportConfig(t,n,c){this._checkLoaded();const d=this.getImportIndex(t),p=this.stylesheet.imports||[];if(d===-1)return this;n?p[d].config=n:delete p[d].config;const _=this.fragments[d];c&&_.style.stylesheet&&(_.style.stylesheet.schema=c);const b=_.style.stylesheet&&_.style.stylesheet.schema;return _.config=n,_.style.updateConfig(n,b),this.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();const n=this.stylesheet.imports||[],c=this.getImportIndex(t);c!==-1&&(n.splice(c,1),this.fragments[c].style._remove(),this.fragments.splice(c,1),this._reloadImports())}getImportIndex(t){const n=(this.stylesheet.imports||[]).findIndex(c=>c.id===t);return n===-1&&this.fire(new s.y(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),n}getLayer(t){return this._mergedLayers[t]}getSources(){const t=[];for(const n in this._mergedOtherSourceCaches){const c=this._mergedOtherSourceCaches[n];c&&t.push(c.getSource())}return t}getSource(t,n){const c=this.getSourceCache(t,n);return c&&c.getSource()}getLayerSource(t){const n=this.getLayerSourceCache(t);return n&&n.getSource()}getSourceCache(t,n){const c=s.aC(t,n);return this._mergedOtherSourceCaches[c]}getLayerSourceCache(t){const n=s.aC(t.source,t.scope);return t.type==="symbol"?this._mergedSymbolSourceCaches[n]:this._mergedOtherSourceCaches[n]}getSourceCaches(t){if(t==null)return Object.values(this._mergedSourceCaches);const n=[];return this._mergedOtherSourceCaches[t]&&n.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&n.push(this._mergedSymbolSourceCaches[t]),n}updateSourceCaches(){const t=this._changes.getUpdatedSourceCaches();for(const n in t){const c=t[n];c==="reload"?this.reloadSource(n):c==="clear"&&this.clearSource(n)}}updateLayers(t){const n=this._changes.getUpdatedPaintProperties();for(const c of n){const d=this.getLayer(c);d&&d.updateTransitions(t)}}getImages(t,n,c){this.imageManager.getImages(n.icons,n.scope,c),this._updateTilesForChangedImages();const d=p=>{p&&p.setDependencies(n.tileID.key,n.type,n.icons)};d(this._otherSourceCaches[n.source]),d(this._symbolSourceCaches[n.source])}rasterizeImages(t,n,c){this.imageManager.rasterizeImages(n,c)}getGlyphs(t,n,c){this.glyphManager.getGlyphs(n.stacks,n.scope,c)}getResource(t,n,c){return s.cy(n,c)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return t.type==="symbol"?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){const n=[];return this._otherSourceCaches[t]&&n.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&n.push(this._symbolSourceCaches[t]),n}_isSourceCacheLoaded(t){const n=this.getOwnSourceCaches(t);return n.length===0?(this.fire(new s.y(new Error(`There is no source with ID '${t}'`))),!1):n.every(c=>c.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(t,n){if(!this._clipLayerPresent&&t.type!=="fill-extrusion")return!1;const c=t.type==="fill-extrusion"&&t.sourceLayer==="building";if(t.is3D()){if(c||n&&n.type==="batched-model"||t.type==="model")return!0}else if(t.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(t=>{t.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Ur.getSourceType=function(l){return Cn[l]},Ur.setSourceType=function(l,t){Cn[l]=t},Ur.registerForPluginStateChange=s.ch;var Zc=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,Cl=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color,float height) {
#ifdef INDICATOR_CUTOUT
float verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,Hc=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}`,po="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",Wc=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }
#endif
#ifdef DEPTH_OCCLUSION
uniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;
#ifdef DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;
#ifdef DEPTH_D24
highp vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
highp vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));
#endif
res+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}
#else
bool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }
#endif//DEPTH_OCCLUSION`,Sh=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,Wo=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,Ra=`#ifdef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,Pl=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,zl=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,Xo=`#ifdef RENDER_SHADOWS
#ifdef DEPTH_TEXTURE
uniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;
#else
uniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;
#endif
uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_1,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_0,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;
#ifdef TEXTURE_GATHER
highp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));
#else
highp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(
shadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)
);
#endif
vec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return mix(lerpx.x,lerpx.y,f.y);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {
#ifdef SHADOWS_SINGLE_CASCADE
light_view_pos0.xyz/=light_view_pos0.w;vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);
#else
light_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth));
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)
{highp vec2 biasUV=vec2(
pos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;const Yo=[];Ko(Zc,Yo),Ko(Hc,Yo),Ko(Cl,Yo);const Da={"_prelude_fog.vertex.glsl":Sh,"_prelude_terrain.vertex.glsl":Wc,"_prelude_shadow.vertex.glsl":zl,"_prelude_fog.fragment.glsl":Wo,"_prelude_shadow.fragment.glsl":Xo,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":Ra,"_prelude_raster_particle.glsl":Pl},Rl={};mi("",Wc),mi(Wo,Sh),mi(Xo,zl),mi(Ra,""),mi(Pl,"");const Xc=mi(Cl,Hc),Dl=Zc;var La={background:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),circle:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? 
smoothstep(0.0,-antialiased_blur,1.0-extrude_length) : 
smoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
#ifdef ELEVATED_ROADS
in float a_circle_z_offset;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
#ifdef ELEVATED_ROADS
world_center.z+=a_circle_z_offset+ELEVATION_BIAS;
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:mi("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:mi(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:mi(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:mi("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:mi("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:mi("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),fill:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=opacity;
#ifdef INDICATOR_CUTOUT
if (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=z_offset;
#endif
}`),fillOutline:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
in float v_height;
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float emissive_strength
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,h);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp float emissive_strength
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=cutoff_opacity(u_cutoff_params,ground.z);if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:mi(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp vec4 color
out highp float v_depth;void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp vec4 color
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
in highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,height);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
out highp vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define highp float pixel_ratio
#pragma mapbox: define highp float line_width
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize highp float pixel_ratio
#pragma mapbox: initialize highp float line_width
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif 
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:mi(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:mi(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:mi(`precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)
in vec3 a_z_offset_width;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec3 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;
#ifdef VARIABLE_LINE_WIDTH
float left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;
#else
halfwidth=(u_width_scale*width)/2.0;
#endif
offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
highp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);
#else
v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),linePattern:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
uniform float u_emissive_strength;
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}
#endif
#ifdef LINE_JOIN_NONE
highp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_with_emission_ground(color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
color.rgb*=mix(v_road_z_offset > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_z_offset);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in vec3 a_z_offset_width;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define mediump float pixel_ratio
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize mediump float pixel_ratio
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);
#ifdef LINE_JOIN_NONE
v_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),raster:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:mi("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:mi("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:mi(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:mi(`#include "_prelude_lighting.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
in float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
in float is_sdf;in vec2 v_tex_a_icon;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];
#ifdef RENDER_TEXT_AND_SYMBOL
if (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}
#endif
#ifdef RENDER_SDF
float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;
#else
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
#endif
out_color*=opacity*fade_opacity;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_auto_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
out float is_sdf;out vec2 v_tex_a_icon;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
#pragma mapbox: define lowp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
#pragma mapbox: initialize lowp float z_offset
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_auto_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
#ifdef PROJECTED_POS_ON_VIEWPORT
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);
#else
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    
#endif
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
#ifdef Z_OFFSET
z+=u_pitch_with_map ? a_auto_z_offset+(u_elevation_from_sea ? z_offset : z_offset) : 0.0;
#else
z+=u_pitch_with_map ? (u_elevation_from_sea ? z_offset : z_offset) : 0.0;
#endif
float occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));
#ifdef DEPTH_OCCLUSION
float depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;
#endif
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;
#ifdef RENDER_TEXT_AND_SYMBOL
is_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;
#endif
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=e;
#endif
}`),terrainRaster:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:mi("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:mi(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,po),skyboxGradient:mi(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,po),skyboxCapture:mi(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:mi(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;
#ifdef DEPTH_D24
highp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor,v_position_height.w);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:mi(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:mi(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),snowParticle:mi("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; 
uniform float u_horizontalOscillationRate; 
uniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}`),rainParticle:mi("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity; 
uniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; 
pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}`),vignette:mi("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:mi("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function Ko(l,t){const n=l.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let c of n)if(c=c.trim(),c[0]==="#"&&c.includes("if")&&!c.includes("endif")){c=c.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const d=c.split(" ");for(const p of d)t.includes(p)||t.push(p)}}function mi(l,t){const n=/#include\s+"([^"]+)"/g,c=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let d=t.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);d&&(d=d.map(I=>{const A=I.split(" ");return A[A.length-1]}),d=[...new Set(d)]);const p={},_=[],b=[];if(l=l.replace(n,(I,A)=>(b.push(A),"")),(t=t.replace(n,(I,A)=>(_.push(A),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let E=[...Yo];Ko(l,E),Ko(t,E);for(const I of[..._,...b])Da[I]||console.error(`Undefined include: ${I}`),Rl[I]||(Rl[I]=[],Ko(Da[I],Rl[I])),E=[...E,...Rl[I]];return{fragmentSource:l=l.replace(c,(I,A,R,D,F)=>(p[F]=!0,A==="define"?`
#ifndef HAS_UNIFORM_u_${F}
in ${R} ${D} ${F};
#else
uniform ${R} ${D} u_${F};
#endif
`:A==="initialize"?`
#ifdef HAS_UNIFORM_u_${F}
    ${R} ${D} ${F} = u_${F};
#endif
`:A==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${F}
    in ${R} ${D} ${F};
#endif
`:A==="initialize-attribute"?"":void 0)),vertexSource:t=t.replace(c,(I,A,R,D,F)=>{const q=D==="float"?"vec2":D,U=F.match(/color/)?"color":q;return A==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${F}
in ${R} ${D} a_${F};
#endif
`:p[F]?A==="define"?`
#ifndef HAS_UNIFORM_u_${F}
uniform lowp float u_${F}_t;
in ${R} ${q} a_${F};
out ${R} ${D} ${F};
#else
uniform ${R} ${D} u_${F};
#endif
`:A==="initialize"?U==="vec4"?`
#ifndef HAS_UNIFORM_u_${F}
    ${F} = a_${F};
#else
    ${R} ${D} ${F} = u_${F};
#endif
`:`
#ifndef HAS_UNIFORM_u_${F}
    ${F} = unpack_mix_${U}(a_${F}, u_${F}_t);
#else
    ${R} ${D} ${F} = u_${F};
#endif
`:A==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${F}
    in ${R} ${D} a_${F};
    out ${R} ${D} ${F};
#endif
`:A==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${F}
    ${F} = a_${F};
#endif
`:void 0:A==="define"?`
#ifndef HAS_UNIFORM_u_${F}
uniform lowp float u_${F}_t;
in ${R} ${q} a_${F};
#else
uniform ${R} ${D} u_${F};
#endif
`:A==="define-instanced"?U==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${F}0;
in vec4 a_${F}1;
in vec4 a_${F}2;
in vec4 a_${F}3;
#else
uniform ${R} ${D} u_${F};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${R} ${q} a_${F};
#else
uniform ${R} ${D} u_${F};
#endif
`:A==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${F}
    ${R} ${D} ${F} = a_${F};
#endif
`:U==="vec4"?`
#ifndef HAS_UNIFORM_u_${F}
    ${R} ${D} ${F} = a_${F};
#else
    ${R} ${D} ${F} = u_${F};
#endif
`:`
#ifndef HAS_UNIFORM_u_${F}
    ${R} ${D} ${F} = unpack_mix_${U}(a_${F}, u_${F}_t);
#else
    ${R} ${D} ${F} = u_${F};
#endif
`}),staticAttributes:d,usedDefines:E,vertexIncludes:_,fragmentIncludes:b}}class If{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,n,c,d,p,_,b,E){this.context=t;let I=this.boundPaintVertexBuffers.length!==d.length;for(let R=0;!I&&R<d.length;R++)this.boundPaintVertexBuffers[R]!==d[R]&&(I=!0);let A=this.boundDynamicVertexBuffers.length!==b.length;for(let R=0;!A&&R<b.length;R++)this.boundDynamicVertexBuffers[R]!==b[R]&&(A=!0);if(!this.vao||this.boundProgram!==n||this.boundLayoutVertexBuffer!==c||I||A||this.boundIndexBuffer!==p||this.boundVertexOffset!==_)this.freshBind(n,c,d,p,_,b,E);else{t.bindVertexArrayOES.set(this.vao);for(const R of b)R&&(R.bind(),E&&R.instanceCount&&R.setVertexAttribDivisor(t.gl,n,E));p&&p.dynamicDraw&&p.bind()}}freshBind(t,n,c,d,p,_,b){const E=t.numAttributes,I=this.context,A=I.gl;this.vao&&this.destroy(),this.vao=I.gl.createVertexArray(),I.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=n,this.boundPaintVertexBuffers=c,this.boundIndexBuffer=d,this.boundVertexOffset=p,this.boundDynamicVertexBuffers=_,n.enableAttributes(A,t),n.bind(),n.setVertexAttribPointers(A,t,p);for(const R of c)R.enableAttributes(A,t),R.bind(),R.setVertexAttribPointers(A,t,p);for(const R of _)R&&(R.enableAttributes(A,t),R.bind(),R.setVertexAttribPointers(A,t,p),b&&R.instanceCount&&R.setVertexAttribDivisor(A,t,b));d&&d.bind(),I.currentNumAttributes=E}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function ka(l,t){const n=Math.pow(2,t.canonical.z),c=t.canonical.y;return[new s.aa(0,c/n).toLngLat().lat,new s.aa(0,(c+1)/n).toLngLat().lat]}function Af(l,t,n,c,d,p,_){const b=l.context,E=b.gl,I=n.hillshadeFBO;if(!I)return;l.prepareDrawTile();const A=l.isTileAffectedByFog(t),R=l.getOrCreateProgram("hillshade",{overrideFog:A});b.activeTexture.set(E.TEXTURE0),E.bindTexture(E.TEXTURE_2D,I.colorAttachment.get());const D=((H,Z,J,re)=>{const ne=J.paint.get("hillshade-shadow-color"),de=J.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",le=J.paint.get("hillshade-highlight-color"),he=J.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",ae=J.paint.get("hillshade-accent-color"),ge=J.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",Te=J.paint.get("hillshade-emissive-strength");let Ue=s.ai(J.paint.get("hillshade-illumination-direction"));if(J.paint.get("hillshade-illumination-anchor")==="viewport")Ue-=H.transform.angle;else if(H.style&&H.style.enable3dLights()&&H.style.directionalLight){const He=H.style.directionalLight.properties.get("direction"),Ze=s.cb(He.x,He.y,He.z);Ue=s.ai(Ze[1])}const Le=!H.options.moving;return{u_matrix:re||H.transform.calculateProjMatrix(Z.tileID.toUnwrapped(),Le),u_image:0,u_latrange:ka(0,Z.tileID),u_light:[J.paint.get("hillshade-exaggeration"),Ue],u_shadow:ne.toRenderColor(de?null:J.lut),u_highlight:le.toRenderColor(he?null:J.lut),u_emissive_strength:Te,u_accent:ae.toRenderColor(ge?null:J.lut)}})(l,n,c,l.terrain?t.projMatrix:null);l.uploadCommonUniforms(b,R,t.toUnwrapped());const{tileBoundsBuffer:F,tileBoundsIndexBuffer:q,tileBoundsSegments:U}=l.getTileBoundsBuffers(n);R.draw(l,E.TRIANGLES,d,p,_,Xt.disabled,D,c.id,F,q,U)}function Cf(l,t,n){if(!t.needsDEMTextureUpload)return;const c=l.context,d=c.gl;c.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||l.getTileTexture(n.stride);const p=n.getPixels();t.demTexture?t.demTexture.update(p,{premultiply:!1}):t.demTexture=new s.T(c,p,d.R32F,{premultiply:!1}),t.needsDEMTextureUpload=!1}function e_(l,t,n){const c=l.context,d=c.gl;if(!t.dem)return;const p=t.dem;if(c.activeTexture.set(d.TEXTURE1),Cf(l,t,p),!t.demTexture)return;t.demTexture.bind(d.NEAREST,d.CLAMP_TO_EDGE);const _=p.dim;c.activeTexture.set(d.TEXTURE0);let b=t.hillshadeFBO;if(!b){const D=new s.T(c,{width:_,height:_,data:null},d.RGBA8);D.bind(d.LINEAR,d.CLAMP_TO_EDGE),b=t.hillshadeFBO=c.createFramebuffer(_,_,!0,"renderbuffer"),b.colorAttachment.set(D.texture)}c.bindFramebuffer.set(b.framebuffer),c.viewport.set([0,0,_,_]);const{tileBoundsBuffer:E,tileBoundsIndexBuffer:I,tileBoundsSegments:A}=l.getMercatorTileBoundsBuffers(),R=[];l.linearFloatFilteringSupported()&&R.push("TERRAIN_DEM_FLOAT_FORMAT"),l.getOrCreateProgram("hillshadePrepare",{defines:R}).draw(l,d.TRIANGLES,Ft.disabled,Ht.disabled,oi.unblended,Xt.disabled,((D,F)=>{const q=F.stride,U=s.ab.mat4.create();return s.ab.mat4.ortho(U,0,s.ag,-s.ag,0,0,1),s.ab.mat4.translate(U,U,[0,-s.ag,0]),{u_matrix:U,u_image:1,u_dimension:[q,q],u_zoom:D.overscaledZ}})(t.tileID,p),n.id,E,I,A),t.needsHillshadePrepare=!1}class Zi{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Eh extends Zi{getDefault(){return s.aj.transparent}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Mh extends Zi{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class Ih extends Zi{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class Ah extends Zi{getDefault(){return[!0,!0,!0,!0]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Pf extends Zi{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class zf extends Zi{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class t_ extends Zi{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const n=this.current;(t.func!==n.func||t.ref!==n.ref||t.mask!==n.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class Ll extends Zi{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class kl extends Zi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.STENCIL_TEST):n.disable(n.STENCIL_TEST),this.current=t,this.dirty=!1}}class Rf extends Zi{getDefault(){return[0,1]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class vr extends Zi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),this.current=t,this.dirty=!1}}class Ch extends Zi{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class Yc extends Zi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.BLEND):n.disable(n.BLEND),this.current=t,this.dirty=!1}}class Kc extends Zi{getDefault(){const t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Ph extends Zi{getDefault(){return s.aj.transparent}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class zh extends Zi{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class Jc extends Zi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),this.current=t,this.dirty=!1}}class Rh extends Zi{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class Dh extends Zi{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let Qc=class extends Zi{getDefault(){return null}set(l){(l!==this.current||this.dirty)&&(this.gl.useProgram(l),this.current=l,this.dirty=!1)}};class Df extends Zi{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class Lf extends Zi{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Oa extends Zi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindFramebuffer(n.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class i_ extends Zi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindRenderbuffer(n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class n_ extends Zi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindTexture(n.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class r_ extends Zi{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindBuffer(n.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class s_ extends Zi{getDefault(){return null}set(t){const n=this.gl;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class o_ extends Zi{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class a_ extends Zi{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class Lh extends Zi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class kh extends Zi{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class eu extends Zi{constructor(t,n){super(t),this.context=t,this.parent=n}getDefault(){return null}}class Fa extends eu{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Oh extends eu{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferRenderbuffer(n.FRAMEBUFFER,this.attachment(),n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class kf extends eu{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,this.attachment(),n.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Of extends Oh{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const Fh=(l,t,n)=>({u_matrix:l,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:n}),mo=(l,t,n,c,d,p,_,b,E,I,A,R,D,F,q,U)=>({u_proj_matrix:Float32Array.from(l),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(c),u_merc_matrix:n,u_zoom_transition:d,u_merc_center:p,u_image0:0,u_frustum_tl:_,u_frustum_tr:b,u_frustum_br:E,u_frustum_bl:I,u_globe_pos:A,u_globe_radius:R,u_viewport:D,u_grid_matrix:U?Float32Array.from(U):new Float32Array(9),u_skirt_height:F,u_far_z_cutoff:q});function Bh(l,t){return l!=null&&t!=null&&!(!l.hasData()||!t.hasData())&&l.demTexture!=null&&t.demTexture!=null&&l.tileID.key!==t.tileID.key}const Ir=new class{constructor(){this.operations={}}newMorphing(l,t,n,c,d){if(l in this.operations){const p=this.operations[l];p.to.tileID.key!==n.tileID.key&&(p.queued=n)}else this.operations[l]={startTime:c,phase:0,duration:d,from:t,to:n,queued:null}}getMorphValuesForProxy(l){if(!(l in this.operations))return null;const t=this.operations[l];return{from:t.from,to:t.to,phase:t.phase}}update(l){for(const t in this.operations){const n=this.operations[t];for(n.phase=(l-n.startTime)/n.duration;n.phase>=1||!this._validOp(n);)if(!this._nextOp(n,l)){delete this.operations[t];break}}}_nextOp(l,t){return!!l.queued&&(l.from=l.to,l.to=l.queued,l.queued=null,l.phase=0,l.startTime=t,!0)}_validOp(l){return l.from.hasData()&&l.to.hasData()}},tu={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Ol(l,t,n){if(t===0)return 0;const c=t<1&&n===514?.25/t:1;return 6*Math.pow(1.5,22-l)*Math.max(t,1)*c}function Ff(l,t){const n=1<<l.z;return!t&&(l.x===0||l.x===n-1)||l.y===0||l.y===n-1}const iu=l=>({u_matrix:l});function Fl(l,t,n,c,d){if(d>0){const p=s.q.now(),_=(p-l.timeAdded)/d,b=t?(p-t.timeAdded)/d:-1,E=n.getSource(),I=c.coveringZoomLevel({tileSize:E.tileSize,roundZoom:E.roundZoom}),A=!t||Math.abs(t.tileID.overscaledZ-I)>Math.abs(l.tileID.overscaledZ-I),R=A&&l.refreshedUponExpiration?1:s.aw(A?_:1-b,0,1);return l.refreshedUponExpiration&&_>=1&&(l.refreshedUponExpiration=!1),t?{opacity:1,mix:1-R}:{opacity:R,mix:0}}return{opacity:1,mix:0}}class Nh extends Nr{constructor(t){const n={type:"raster-dem",maxzoom:t.transform.maxZoom},c=new s.D(s.ci(),null),d=or("mock-dem",n,c,t.style);super("mock-dem",d,!1),d.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,n){t.state="loaded",n(null)}}class l_ extends Nr{constructor(t){const n=or("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},new s.D(s.ci(),null),t.style);super("proxy",n,!1),n.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,n,c){if(t.freezeTileCoverage)return;this.transform=t;const d=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((p,_)=>{if(p[_.key]="",!this._tiles[_.key]){const b=new co(_,this._source.tileSize*_.overscaleFactor(),t.tileZoom);b.state="loaded",this._tiles[_.key]=b}return p},{});for(const p in this._tiles)p in d||(this.freeFBO(p),this._tiles[p].unloadVectorData(),delete this._tiles[p])}freeFBO(t){const n=this.proxyCachedFBO[t];if(n!==void 0){const c=Object.values(n);this.renderCachePool.push(...c),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach(t=>t.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Vh extends s.aG{constructor(t,n,c){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=n,this.projMatrix=c}}class Ba extends s.cJ{constructor(t,n){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},t.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[c,d,p]=function(E){const I=new s.b4,A=new s.aU,R=131;I.reserve(17161),A.reserve(33800);const D=s.ag/128,F=s.ag+D/2,q=F+D;for(let H=-D;H<q;H+=D)for(let Z=-D;Z<q;Z+=D){const J=Z<0||Z>F||H<0||H>F?24575:0,re=s.aw(Math.round(Z),0,s.ag),ne=s.aw(Math.round(H),0,s.ag);I.emplaceBack(re+J,ne)}const U=(H,Z)=>{const J=Z*R+H;A.emplaceBack(J+1,J,J+R),A.emplaceBack(J+R,J+R+1,J+1)};for(let H=1;H<129;H++)for(let Z=1;Z<129;Z++)U(Z,H);return[0,129].forEach(H=>{for(let Z=0;Z<130;Z++)U(Z,H),U(H,Z)}),[I,A,32768]}(),_=t.context;this.gridBuffer=_.createVertexBuffer(c,s.b6.members),this.gridIndexBuffer=_.createIndexBuffer(d),this.gridSegments=s.b7.simpleSegment(0,0,c.length,d.length),this.gridNoSkirtSegments=s.b7.simpleSegment(0,0,c.length,p),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new l_(n.map),this.orthoMatrix=s.ab.mat4.create(),s.ab.mat4.ortho(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,s.ag,0,s.ag,0,1);const b=_.gl;this._overlapStencilMode=new Ht({func:b.GEQUAL,mask:255},0,255,b.KEEP,b.KEEP,b.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=n,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Nh(n.map),this._pendingGroundEffectLayers=[]}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(t,n,c){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);const d=t.terrain.properties,p=t.terrain.drapeRenderMode===0,_=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=s.q.now();const b=t.terrain&&t.terrain.scope,E=d.get("source"),I=p?this._mockSourceCache:t.getSourceCache(E,b);if(!I)return void s.w(`Couldn't find terrain source "${E}".`);if(this.sourceCache=I,this._attenuationRange=t.terrain.getAttenuationRange(),this._exaggeration=_?this.calculateExaggeration(n):d.get("exaggeration"),!n.projection.requiresDraping&&_&&this._exaggeration===0)return void this._disable();this.enabled=!0;const A=()=>{this.sourceCache.used&&s.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const R=this.getScaledDemTileSize();this.sourceCache.update(n,R,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,A(),this._initializing=!0),A(),n.updateElevation(!0,c),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(n),this._emptyDEMTextureDirty=!0,this._previousZoom=n.zoom}else this._disable()}calculateExaggeration(t){if(this._attenuationRange&&t.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(t.zoom);const n=this._previousCameraAltitude,c=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=c;const d=n!=null?c-n:Number.MAX_VALUE;if(Math.abs(d)<2)return this._exaggeration;const p=t.zoom,_=this._style.terrain;if(!this._previousUpdateTimestamp)return _.getExaggeration(p);let b=p-this._previousZoom;const E=this._previousUpdateTimestamp;let I=p;this._evaluationZoom!=null&&(I=this._evaluationZoom,Math.abs(p-I)>.5&&(b=.5*(p-I+b)),b*d<0&&(I+=b)),this._evaluationZoom=I;const A=_.getExaggeration(I),R=A===_.getExaggeration(Math.max(0,I-.1));if(R&&Math.abs(A-this._exaggeration)<.01)return A;let D=Math.min(.1,.00375*(this._updateTimestamp-E));return(R||A<.1||Math.abs(b)<1e-4)&&(D=Math.min(.2,4*D)),s.af(this._exaggeration,A,D)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.coord&&t.dataType==="source"?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):t.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(t=>t.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const n=this.proxySourceCache,c=this.painter.transform;this._initializing&&(this._initializing=c._centerAltitude===0&&this.getAtPointOrZero(s.aa.fromLngLat(c.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const d=this.proxyCoords=n.getIds().map(E=>{const I=n.getTileByID(E).tileID;return I.projMatrix=c.calculateProjMatrix(I.toUnwrapped()),I});(function(E,I){const A=I.transform.pointCoordinate(I.transform.getCameraPoint()),R=new s.P(A.x,A.y);E.sort((D,F)=>{if(F.overscaledZ-D.overscaledZ)return F.overscaledZ-D.overscaledZ;const q=new s.P(D.canonical.x+(1<<D.canonical.z)*D.wrap,D.canonical.y),U=new s.P(F.canonical.x+(1<<F.canonical.z)*F.wrap,F.canonical.y),H=R.mult(1<<D.canonical.z);return H.x-=.5,H.y-=.5,H.distSqr(q)-H.distSqr(U)})})(d,this.painter);const p=this.proxyToSource||{};this.proxyToSource={},d.forEach(E=>{this.proxyToSource[E.key]={}}),this.terrainTileForTile={};const _=this._style._mergedSourceCaches;for(const E in _){const I=_[E];if(!I.used||(I!==this.sourceCache&&this.resetTileLookupCache(I.id),this._setupProxiedCoordsForOrtho(I,t[E],p),I.usedForTerrain))continue;const A=t[E];I.getSource().reparseOverscaled&&this._assignTerrainTiles(A)}this.proxiedCoords[n.id]=d.map(E=>new Vh(E,E.key,this.orthoMatrix)),this._assignTerrainTiles(d),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(p),this.renderingToTexture=!1;const b={};this._visibleDemTiles=[];for(const E of this.proxyCoords){const I=this.terrainTileForTile[E.key];if(!I)continue;const A=I.tileID.key;A in b||(this._visibleDemTiles.push(I),b[A]=A)}}_assignTerrainTiles(t){this._initializing||t.forEach(n=>{if(this.terrainTileForTile[n.key])return;const c=this._findTileCoveringTileID(n,this.sourceCache);c&&(this.terrainTileForTile[n.key]=c)})}_prepareDEMTextures(){const t=this.painter.context,n=t.gl;for(const c in this.terrainTileForTile){const d=this.terrainTileForTile[c],p=d.dem;!p||d.demTexture&&!d.needsDEMTextureUpload||(t.activeTexture.set(n.TEXTURE1),Cf(this.painter,d,p))}}_prepareDemTileUniforms(t,n,c,d){if(!n||n.demTexture==null)return!1;const p=t.tileID.canonical,_=Math.pow(2,n.tileID.canonical.z-p.z),b=d||"";return c[`u_dem_tl${b}`]=[p.x*_%1,p.y*_%1],c[`u_dem_scale${b}`]=_,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let t=0;const n=this._visibleDemTiles.reduce((c,d)=>{if(!d.dem)return c;const p=d.dem.tree.minimums[0];return p>0&&t++,c+p},0);return t?n/t:0}_updateEmptyDEMTexture(){const t=this.painter.context,n=t.gl;t.activeTexture.set(n.TEXTURE2);const c=this._getLoadedAreaMinimum(),d=new s.cK({width:1,height:1},new Float32Array([c]));this._emptyDEMTextureDirty=!1;let p=this._emptyDEMTexture;return p?p.update(d,{premultiply:!1}):p=this._emptyDEMTexture=new s.T(t,d,n.R32F,{premultiply:!1}),p}setupElevationDraw(t,n,c){const d=this.painter.context,p=d.gl,_={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};_.u_exaggeration=this.exaggeration();let b=null,E=null,I=1;if(c&&c.morphing&&this._useVertexMorphing){const F=c.morphing.srcDemTile,q=c.morphing.dstDemTile;I=c.morphing.phase,F&&q&&(this._prepareDemTileUniforms(t,F,_,"_prev")&&(E=F),this._prepareDemTileUniforms(t,q,_)&&(b=q))}const A=F=>F&&F.demTexture&&this.painter.linearFloatFilteringSupported()?p.LINEAR:p.NEAREST;let R=null;var D;if(this.enabled?E&&b?(R=b.demTexture,d.activeTexture.set(p.TEXTURE4),E.demTexture.bind(A(E),p.CLAMP_TO_EDGE),_.u_dem_lerp=I):(b=this.terrainTileForTile[t.tileID.key],R=this._prepareDemTileUniforms(t,b,_)?b.demTexture:this.emptyDEMTexture):R=this.emptyDEMTexture,d.activeTexture.set(p.TEXTURE2),R&&(_.u_dem_size=(D=R).size[0]===1?1:D.size[0]-2,R.bind(A(b),p.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(c&&c.useDepthForOcclusion,n,_),c&&c.useMeterToDem&&b){const F=(1<<b.tileID.canonical.z)*s.bH(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;_.u_meter_to_dem=F}if(c&&c.labelPlaneMatrixInv&&(_.u_label_plane_matrix_inv=c.labelPlaneMatrixInv),n.setTerrainUniformValues(d,_),this.painter.transform.projection.name==="globe"){const F=this.globeUniformValues(this.painter.transform,t.tileID.canonical,c&&c.useDenormalizedUpVectorScale);n.setGlobeUniformValues(d,F)}}globeUniformValues(t,n,c){const d=t.projection;return{u_tile_tl_up:d.upVector(n,0,0),u_tile_tr_up:d.upVector(n,s.ag,0),u_tile_br_up:d.upVector(n,s.ag,s.ag),u_tile_bl_up:d.upVector(n,0,s.ag),u_tile_up_scale:c?s.cL(1):d.upVectorScale(n,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){const n=this.painter,c=this.painter.context;t.length!==0&&(c.bindFramebuffer.set(null),c.viewport.set([0,0,n.width,n.height]),n.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(d,p,_,b,E){if(d.transform.projection.name==="globe")(function(I,A,R,D,F){const q=I.context,U=q.gl;let H,Z;const J=I.transform,re=s.cC(I,q,J),ne=(He,Ze)=>{if(Z===Ze)return;const ze=[tu[Ze],"PROJECTION_GLOBE_VIEW"];re&&ze.push("CUSTOM_ANTIALIASING");const je=I.isTileAffectedByFog(He);H=I.getOrCreateProgram("globeRaster",{defines:ze,overrideFog:je}),Z=Ze},de=I.colorModeForRenderPass(),le=new Ft(U.LEQUAL,Ft.ReadWrite,I.depthRangeFor3D);Ir.update(F);const he=s.cD(J),ae=[s.at(J.center.lng),s.aA(J.center.lat)],ge=I.globeSharedBuffers,Te=[J.width*s.q.devicePixelRatio,J.height*s.q.devicePixelRatio],Ue=Float32Array.from(J.globeMatrix),Le={useDenormalizedUpVectorScale:!0};{const He=I.transform,Ze=Ol(He.zoom,A.exaggeration(),A.sourceCache._source.tileSize);Z=-1;const ze=U.TRIANGLES;for(const je of D){const it=R.getTile(je),Ce=Ht.disabled,Ye=A.prevTerrainTileForTile[je.key],Ge=A.terrainTileForTile[je.key];Bh(Ye,Ge)&&Ir.newMorphing(je.key,Ye,Ge,F,250),q.activeTexture.set(U.TEXTURE0),it.texture&&it.texture.bind(U.LINEAR,U.CLAMP_TO_EDGE);const ut=Ir.getMorphValuesForProxy(je.key),Je=ut?1:0;ut&&s.J(Le,{morphing:{srcDemTile:ut.from,dstDemTile:ut.to,phase:s.cB(ut.phase)}});const Xe=s.cE(je.canonical),nt=s.cF(Xe.getCenter().lat),lt=s.cG(je.canonical,Xe,nt,He.worldSize/He._pixelsPerMercatorPixel),bt=s.bb(s.cH(je.canonical)),Et=mo(He.expandedFarZProjMatrix,Ue,he,bt,s.ae(He.zoom),ae,He.frustumCorners.TL,He.frustumCorners.TR,He.frustumCorners.BR,He.frustumCorners.BL,He.globeCenterInViewSpace,He.globeRadius,Te,Ze,He._farZ,lt);if(ne(je,Je),H&&(A.setupElevationDraw(it,H,Le),I.uploadCommonUniforms(q,H,je.toUnwrapped()),ge)){const[$t,kt,Bt]=ge.getGridBuffers(nt,Ze!==0);H.draw(I,ze,le,Ce,de,Xt.backCCW,Et,"globe_raster",$t,kt,Bt)}}}if(ge&&(I.renderDefaultNorthPole||I.renderDefaultSouthPole)){const He=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];re&&He.push("CUSTOM_ANTIALIASING"),H=I.getOrCreateProgram("globeRaster",{defines:He});for(const Ze of D){const{x:ze,y:je,z:it}=Ze.canonical,Ce=je===0,Ye=je===(1<<it)-1,[Ge,ut,Je,Xe]=ge.getPoleBuffers(it,!1);if(Xe&&(Ce||Ye)){const nt=R.getTile(Ze);q.activeTexture.set(U.TEXTURE0),nt.texture&&nt.texture.bind(U.LINEAR,U.CLAMP_TO_EDGE);let lt=s.cI(it,ze,J);const bt=s.bb(s.cH(Ze.canonical)),Et=($t,kt)=>$t.draw(I,U.TRIANGLES,le,Ht.disabled,de,Xt.disabled,mo(J.expandedFarZProjMatrix,lt,lt,bt,0,ae,J.frustumCorners.TL,J.frustumCorners.TR,J.frustumCorners.BR,J.frustumCorners.BL,J.globeCenterInViewSpace,J.globeRadius,Te,0,J._farZ),"globe_pole_raster",kt,Je,Xe);A.setupElevationDraw(nt,H,Le),I.uploadCommonUniforms(q,H,Ze.toUnwrapped()),Ce&&I.renderDefaultNorthPole&&Et(H,Ge),Ye&&I.renderDefaultSouthPole&&(lt=s.ab.mat4.scale(s.ab.mat4.create(),lt,[1,-1,1]),Et(H,ut))}}}})(d,p,_,b,E);else{const I=d.context,A=I.gl;let R,D;const F=d.shadowRenderer,q=fo(d,d.longestCutoffRange),U=de=>{if(D===de)return;const le=[];le.push(tu[de]),q.shouldRenderCutoff&&le.push("RENDER_CUTOFF"),F&&(le.push("RENDER_SHADOWS","DEPTH_TEXTURE"),F.useNormalOffset&&le.push("NORMAL_OFFSET")),R=d.getOrCreateProgram("terrainRaster",{defines:le}),D=de},H=d.colorModeForRenderPass(),Z=new Ft(A.LEQUAL,Ft.ReadWrite,d.depthRangeFor3D);Ir.update(E);const J=d.transform,re=Ol(J.zoom,p.exaggeration(),p.sourceCache._source.tileSize);let ne=[0,0,0];if(F){const de=d.style.directionalLight,le=d.style.ambientLight;de&&le&&(ne=xh(d.style,de,le))}{D=-1;const de=A.TRIANGLES,[le,he]=[p.gridIndexBuffer,p.gridSegments];for(const ae of b){const ge=_.getTile(ae),Te=Ht.disabled,Ue=p.prevTerrainTileForTile[ae.key],Le=p.terrainTileForTile[ae.key];Bh(Ue,Le)&&Ir.newMorphing(ae.key,Ue,Le,E,250),I.activeTexture.set(A.TEXTURE0),ge.texture&&ge.texture.bind(A.LINEAR,A.CLAMP_TO_EDGE);const He=Ir.getMorphValuesForProxy(ae.key),Ze=He?1:0;let ze;He&&(ze={morphing:{srcDemTile:He.from,dstDemTile:He.to,phase:s.cB(He.phase)}});const je=Fh(ae.projMatrix,Ff(ae.canonical,J.renderWorldCopies)?re/10:re,ne);if(U(Ze),!R)continue;p.setupElevationDraw(ge,R,ze);const it=ae.toUnwrapped();F&&F.setupShadows(it,R),d.uploadCommonUniforms(I,R,it,null,q),R.draw(d,de,Z,Te,H,Xt.backCCW,je,"terrain_raster",p.gridBuffer,le,he)}}}}(n,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,n.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(this._drapedRenderBatches.length===0)return t+1;this.renderingToTexture=!0;const n=this.painter,c=this.painter.context,d=this.proxySourceCache,p=this.proxiedCoords[d.id],_=this._drapedRenderBatches.shift(),b=n.style.order,E=[];let I=0;for(const A of p){const R=d.getTileByID(A.proxyTileKey),D=d.proxyCachedFBO[A.key]?d.proxyCachedFBO[A.key][t]:void 0,F=D!==void 0?d.renderCache[D]:this.pool[I++],q=D!==void 0;if(R.texture=F.tex,q&&!F.dirty){E.push(R.tileID);continue}let U;c.bindFramebuffer.set(F.fb.framebuffer),this.renderedToTile=!1,F.dirty&&(c.clear({color:s.aj.transparent,stencil:0}),F.dirty=!1);for(let H=_.start;H<=_.end;++H){const Z=n.style._mergedLayers[b[H]];if(Z.isHidden(n.transform.zoom))continue;const J=n.style.getLayerSourceCache(Z),re=J?this.proxyToSource[A.key][J.id]:[A];if(!re)continue;const ne=re;c.viewport.set([0,0,F.fb.width,F.fb.height]),U!==(J?J.id:null)&&(this._setupStencil(F,re,Z,J),U=J?J.id:null),n.renderLayer(n,J,Z,ne)}if(this._drapedRenderBatches.length===0)for(const H of this._pendingGroundEffectLayers){const Z=n.style._mergedLayers[b[H]];if(Z.isHidden(n.transform.zoom))continue;const J=n.style.getLayerSourceCache(Z),re=J?this.proxyToSource[A.key][J.id]:[A];if(!re)continue;const ne=re;c.viewport.set([0,0,F.fb.width,F.fb.height]),U!==(J?J.id:null)&&(this._setupStencil(F,re,Z,J),U=J?J.id:null),n.renderLayer(n,J,Z,ne)}this.renderedToTile?(F.dirty=!0,E.push(R.tileID)):q||--I,I===5&&(I=0,this.renderToBackBuffer(E))}return this.renderToBackBuffer(E),this.renderingToTexture=!1,c.bindFramebuffer.set(null),c.viewport.set([0,0,n.width,n.height]),_.end+1}postRender(){}isLayerOrderingCorrect(t){const n=t.order.length;let c=-1,d=n;for(let p=0;p<n;++p)this._style.isLayerDraped(t._mergedLayers[t.order[p]])?c=Math.max(c,p):d=Math.min(d,p);return d>c}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter(n=>n.dem).forEach(n=>{t=Math.min(t,n.dem.tree.minimums[0])}),t===0?t:(t-30)*this._exaggeration}raycast(t,n,c){if(!this._visibleDemTiles)return null;const d=this._visibleDemTiles.filter(p=>p.dem).map(p=>{const _=p.tileID,b=1<<_.overscaledZ,{x:E,y:I}=_.canonical,A=E/b,R=(E+1)/b,D=I/b,F=(I+1)/b;return{minx:A,miny:D,maxx:R,maxy:F,t:p.dem.tree.raycastRoot(A,D,R,F,t,n,c),tile:p}});d.sort((p,_)=>(p.t!==null?p.t:Number.MAX_VALUE)-(_.t!==null?_.t:Number.MAX_VALUE));for(const p of d){if(p.t==null)return null;const _=p.tile.dem.tree.raycast(p.minx,p.miny,p.maxx,p.maxy,t,n,c);if(_!=null)return _}return null}_createFBO(){const t=this.painter.context,n=t.gl,c=this.drapeBufferSize;t.activeTexture.set(n.TEXTURE0);const d=new s.T(t,{width:c[0],height:c[1],data:null},n.RGBA8);d.bind(n.LINEAR,n.CLAMP_TO_EDGE);const p=t.createFramebuffer(c[0],c[1],!0,null);return p.colorAttachment.set(d.texture),p.depthAttachment=new Of(t,p.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,c[0],c[1]),this._stencilRef=0,p.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):p.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&n.texParameterf(n.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:p,tex:d,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some(t=>{const n=this._style._mergedLayers[t],c=n.isHidden(this.painter.transform.zoom);return n.type==="hillshade"||n.type==="custom"?!c&&n.shouldRedrape():!c&&n.hasTransition()})}_clearLineLayersFromRenderCache(){let t=!1;for(const c of this._style.getSources())if(c instanceof fn){t=!0;break}if(!t)return;const n={};for(let c=0;c<this._style.order.length;++c){const d=this._style._mergedLayers[this._style.order[c]],p=this._style.getLayerSourceCache(d);if(p&&!n[p.id]&&!d.isHidden(this.painter.transform.zoom)&&d.type==="line"&&d.widthExpression()instanceof s.a9){n[p.id]=!0;for(const _ of this.proxyCoords){const b=this.proxyToSource[_.key][p.id];if(b)for(const E of b)this._clearRenderCacheForTile(p.id,E)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(const c in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[c]._source instanceof fs){t=!0;break}if(!t)return;const n={};for(let c=0;c<this._style.order.length;++c){const d=this._style._mergedLayers[this._style.order[c]],p=this._style.getLayerSourceCache(d);if(!p||n[p.id]||d.isHidden(this.painter.transform.zoom)||d.type!=="raster")continue;const _=d.paint.get("raster-fade-duration");for(const b of this.proxyCoords){const E=this.proxyToSource[b.key][p.id];if(E)for(const I of E){const A=Fl(p.getTile(I),p.findLoadedParent(I,0),p,this.painter.transform,_);(A.opacity!==1||A.mix!==0)&&this._clearRenderCacheForTile(p.id,I)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const t=this._style.order,n=t.length;if(n===0)return;const c=[];this._pendingGroundEffectLayers=[];let d,p=0,_=this._style._mergedLayers[t[p]];for(;!this._style.isLayerDraped(_)&&_.isHidden(this.painter.transform.zoom)&&++p<n;)_=this._style._mergedLayers[t[p]];for(;p<n;++p){const b=this._style._mergedLayers[t[p]];b.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(b)?d===void 0&&(d=p):(b.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(p),d!==void 0&&(c.push({start:d,end:p-1}),d=void 0)))}if(d!==void 0&&c.push({start:d,end:p-1}),c.length!==0){const b=c[c.length-1];this._pendingGroundEffectLayers.every(E=>E>b.end)||s.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=c}_setupRenderCache(t){const n=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,n.renderCache.length>n.renderCachePool.length){const _=Object.values(n.proxyCachedFBO);n.proxyCachedFBO={};for(let b=0;b<_.length;++b){const E=Object.values(_[b]);n.renderCachePool.push(...E)}}return}this._clearRasterLayersFromRenderCache();const c=this.proxyCoords,d=this._tilesDirty;for(let _=c.length-1;_>=0;_--){const b=c[_];if(n.getTileByID(b.key),n.proxyCachedFBO[b.key]!==void 0){const E=t[b.key],I=this.proxyToSource[b.key];let A=0;for(const R in I){const D=I[R],F=E[R];if(!F||F.length!==D.length||D.some((q,U)=>q!==F[U]||d[R]&&d[R].hasOwnProperty(q.key))){A=-1;break}++A}for(const R in n.proxyCachedFBO[b.key])n.renderCache[n.proxyCachedFBO[b.key][R]].dirty=A<0||A!==Object.values(E).length}}const p=[...this._drapedRenderBatches];p.sort((_,b)=>b.end-b.start-(_.end-_.start));for(const _ of p)for(const b of c){if(n.proxyCachedFBO[b.key])continue;let E=n.renderCachePool.pop();E===void 0&&n.renderCache.length<50&&(E=n.renderCache.length,n.renderCache.push(this._createFBO())),E!==void 0&&(n.proxyCachedFBO[b.key]={},n.proxyCachedFBO[b.key][_.start]=E,n.renderCache[E].dirty=!0)}this._tilesDirty={}}_setupStencil(t,n,c,d){if(!d||!this._sourceTilesOverlap[d.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const p=this.painter.context,_=p.gl;if(n.length<=1)return void(this._overlapStencilType=!1);let b;if(c.isTileClipped())b=n.length,this._overlapStencilMode.test={func:_.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(n[0].overscaledZ>n[n.length-1].overscaledZ))return void(this._overlapStencilType=!1);b=1,this._overlapStencilMode.test={func:_.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+b>255&&(p.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=b,this._overlapStencilMode.ref=this._stencilRef,c.isTileClipped()&&this._renderTileClippingMasks(n,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):Ht.disabled}_renderTileClippingMasks(t,n){const c=this.painter,d=this.painter.context,p=d.gl;c._tileClippingMaskIDs={},d.setColorMode(oi.disabled),d.setDepthMode(Ft.disabled);const _=c.getOrCreateProgram("clippingMask");for(const b of t){const E=c._tileClippingMaskIDs[b.key]=--n;_.draw(c,p.TRIANGLES,Ft.disabled,new Ht({func:p.ALWAYS,mask:0},E,255,p.KEEP,p.KEEP,p.REPLACE),oi.disabled,Xt.disabled,iu(b.projMatrix),"$clipping",c.tileExtentBuffer,c.quadTriangleIndexBuffer,c.tileExtentSegments)}}pointCoordinate(t){const n=this.painter.transform;if(t.x<0||t.x>n.width||t.y<0||t.y>n.height)return null;const c=[t.x,t.y,1,1];s.ab.vec4.transformMat4(c,c,n.pixelMatrixInverse),s.ab.vec4.scale(c,c,1/c[3]),c[0]/=n.worldSize,c[1]/=n.worldSize;const d=n._camera.position,p=s.bH(1,n.center.lat),_=[d[0],d[1],d[2]/p,0],b=s.ab.vec3.subtract([],c.slice(0,3),_);s.ab.vec3.normalize(b,b);const E=this.raycast(_,b,this._exaggeration);return E!==null&&E?(s.ab.vec3.scaleAndAdd(_,_,b,E),_[3]=_[2],_[2]*=p,_):null}_setupProxiedCoordsForOrtho(t,n,c){if(t.getSource()instanceof s.aJ)return this._setupProxiedCoordsForImageSource(t,n,c);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};const d=this.proxiedCoords[t.id]=[],p=this.proxyCoords;for(let E=0;E<p.length;E++){const I=p[E],A=this._findTileCoveringTileID(I,t);if(A){const R=this._createProxiedId(I,A,c[I.key]&&c[I.key][t.id]);d.push(R),this.proxyToSource[I.key][t.id]=[R]}}let _=!1;const b=new Set;for(let E=0;E<n.length;E++){const I=t.getTile(n[E]);if(!I||!I.hasData())continue;const A=this._findTileCoveringTileID(I.tileID,this.proxySourceCache);if(A&&A.tileID.canonical.z!==I.tileID.canonical.z){const R=this.proxyToSource[A.tileID.key][t.id],D=this._createProxiedId(A.tileID,I,c[A.tileID.key]&&c[A.tileID.key][t.id]);R?R.splice(R.length-1,0,D):this.proxyToSource[A.tileID.key][t.id]=[D];const F=this.proxyToSource[A.tileID.key][t.id];b.has(F)||b.add(F),d.push(D),_=!0}}if(this._sourceTilesOverlap[t.id]=_,_&&this._debugParams.sortTilesHiZFirst)for(const E of b)E.sort((I,A)=>A.overscaledZ-I.overscaledZ)}_setupProxiedCoordsForImageSource(t,n,c){if(!t.getSource().loaded())return;const d=this.proxiedCoords[t.id]=[],p=this.proxyCoords,_=t.getSource(),b=_.tileID;if(!b)return;const E=new s.P(b.x,b.y)._div(1<<b.z),I=_.coordinates.map(s.aa.fromLngLat).reduce((R,D)=>(R.min.x=Math.min(R.min.x,D.x-E.x),R.min.y=Math.min(R.min.y,D.y-E.y),R.max.x=Math.max(R.max.x,D.x-E.x),R.max.y=Math.max(R.max.y,D.y-E.y),R),{min:new s.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new s.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),A=(R,D)=>{const F=R.wrap+R.canonical.x/(1<<R.canonical.z),q=R.canonical.y/(1<<R.canonical.z),U=s.ag/(1<<R.canonical.z),H=D.wrap+D.canonical.x/(1<<D.canonical.z),Z=D.canonical.y/(1<<D.canonical.z);return F+U<H+I.min.x||F>H+I.max.x||q+U<Z+I.min.y||q>Z+I.max.y};for(let R=0;R<p.length;R++){const D=p[R];for(let F=0;F<n.length;F++){const q=t.getTile(n[F]);if(!q||!q.hasData()||A(D,q.tileID))continue;const U=this._createProxiedId(D,q,c[D.key]&&c[D.key][t.id]),H=this.proxyToSource[D.key][t.id];H?H.push(U):this.proxyToSource[D.key][t.id]=[U],d.push(U)}}}_createProxiedId(t,n,c){let d=this.orthoMatrix;if(c){const p=c.find(_=>_.key===n.tileID.key);if(p)return p}if(n.tileID.key!==t.key){const p=t.canonical.z-n.tileID.canonical.z;let _,b,E;d=s.ab.mat4.create();const I=n.tileID.wrap-t.wrap<<t.overscaledZ;p>0?(_=s.ag>>p,b=_*((n.tileID.canonical.x<<p)-t.canonical.x+I),E=_*((n.tileID.canonical.y<<p)-t.canonical.y)):(_=s.ag<<-p,b=s.ag*(n.tileID.canonical.x-(t.canonical.x+I<<-p)),E=s.ag*(n.tileID.canonical.y-(t.canonical.y<<-p))),s.ab.mat4.ortho(d,0,_,0,_,0,1),s.ab.mat4.translate(d,d,[b,E,0])}return new Vh(n.tileID,t.key,d)}_findTileCoveringTileID(t,n){let c=n.getTile(t);if(c&&c.hasData())return c;const d=this._findCoveringTileCache[n.id],p=d[t.key];if(c=p?n.getTileByID(p):null,c&&c.hasData()||p===null)return c;let _=c?c.tileID:t,b=_.overscaledZ;const E=n.getSource().minzoom,I=[];if(!p){const R=n.getSource().maxzoom;if(t.canonical.z>=R){const D=t.canonical.z-R;n.getSource().reparseOverscaled?(b=Math.max(t.canonical.z+2,n.transform.tileZoom),_=new s.aG(b,t.wrap,R,t.canonical.x>>D,t.canonical.y>>D)):D!==0&&(b=R,_=new s.aG(b,t.wrap,R,t.canonical.x>>D,t.canonical.y>>D))}_.key!==t.key&&(I.push(_.key),c=n.getTile(_))}const A=R=>{I.forEach(D=>{d[D]=R}),I.length=0};for(b-=1;b>=E&&(!c||!c.hasData());b--){c&&A(c.tileID.key);const R=_.calculateScaledKey(b);if(c=n.getTileByID(R),c&&c.hasData())break;const D=d[R];if(D===null)break;D===void 0?I.push(R):c=n.getTileByID(D)}return A(c?c.tileID.key:null),c&&c.hasData()?c:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,n){let c=this._tilesDirty[t];c||(c=this._tilesDirty[t]={}),c[n.key]=!0}}function c_(l,t,n){const c=function(b,E,I){const A=s.ab.vec3.dot(E,b),R=s.ab.vec3.dot(I,[.2126,.7152,.0722]),D=(q,U,H)=>(1-H)*q+H*U,F=D(1-.3*Math.min(R,1),1,Math.min(A+1,1));return D(.92,1,Math.asin(s.aw(E[2],-1,1))/Math.PI+.5)*F}(l,[0,0,1],t),d=[0,0,0];s.ab.vec3.scale(d,n.slice(0,3),c);const p=[0,0,0];s.ab.vec3.scale(p,t.slice(0,3),l[2]);const _=[0,0,0];return s.ab.vec3.add(_,d,p),s.cf(_)}const u_=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],Bf=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","model","symbol"];class Nf{static cacheKey(t,n,c,d){let p=`${n}${d?d.cacheKey:""}`;for(const _ of c)t.usedDefines.includes(_)&&(p+=`/${_}`);return p}constructor(t,n,c,d,p,_){const b=t.gl;this.program=b.createProgram(),this.configuration=d,this.name=n,this.fixedDefines=[..._];const E=d?d.getBinderAttributes():[],I=(c.staticAttributes||[]).concat(E);let A=d?d.defines():[];A=A.concat(_.map(H=>`#define ${H}`));const R=`#version 300 es
`;let D=R+A.concat("precision mediump float;",Dl,Xc.fragmentSource).join(`
`);for(const H of c.fragmentIncludes)D+=`
${Da[H]}`;D+=`
${c.fragmentSource}`;let F=R+A.concat("precision highp float;",Dl,Xc.vertexSource).join(`
`);for(const H of c.vertexIncludes)F+=`
${Da[H]}`;this.forceManualRenderingForInstanceIDShaders=t.forceManualRenderingForInstanceIDShaders&&c.vertexSource.indexOf("gl_InstanceID")!==-1,this.forceManualRenderingForInstanceIDShaders&&(F+=`
uniform int u_instanceID;
`),F+=`
${c.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(F=F.replaceAll("gl_InstanceID","u_instanceID"));const q=b.createShader(b.FRAGMENT_SHADER);if(b.isContextLost())return void(this.failedToCreate=!0);b.shaderSource(q,D),b.compileShader(q),b.attachShader(this.program,q);const U=b.createShader(b.VERTEX_SHADER);if(b.isContextLost())this.failedToCreate=!0;else{b.shaderSource(U,F),b.compileShader(U),b.attachShader(this.program,U),this.attributes={},this.numAttributes=I.length;for(let H=0;H<this.numAttributes;H++)if(I[H]){const Z=I[H].startsWith("a_")?I[H]:`a_${I[H]}`;b.bindAttribLocation(this.program,H,Z),this.attributes[Z]=H}b.linkProgram(this.program),b.deleteShader(U),b.deleteShader(q),this.fixedUniforms=p(t),this.binderUniforms=d?d.getUniforms(t):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(H=>({u_instanceID:new s.bN(H)}))(t)),(_.includes("TERRAIN")||n.indexOf("symbol")!==-1||n.indexOf("circle")!==-1)&&(this.terrainUniforms=(H=>({u_dem:new s.bN(H),u_dem_prev:new s.bN(H),u_dem_tl:new s.bK(H),u_dem_scale:new s.bM(H),u_dem_tl_prev:new s.bK(H),u_dem_scale_prev:new s.bM(H),u_dem_size:new s.bM(H),u_dem_lerp:new s.bM(H),u_exaggeration:new s.bM(H),u_depth:new s.bN(H),u_depth_size_inv:new s.bK(H),u_depth_range_unpack:new s.bK(H),u_occluder_half_size:new s.bM(H),u_occlusion_depth_offset:new s.bM(H),u_meter_to_dem:new s.bM(H),u_label_plane_matrix_inv:new s.bJ(H)}))(t)),_.includes("GLOBE")&&(this.globeUniforms=(H=>({u_tile_tl_up:new s.bL(H),u_tile_tr_up:new s.bL(H),u_tile_br_up:new s.bL(H),u_tile_bl_up:new s.bL(H),u_tile_up_scale:new s.bM(H)}))(t)),_.includes("FOG")&&(this.fogUniforms=(H=>({u_fog_matrix:new s.bJ(H),u_fog_range:new s.bK(H),u_fog_color:new s.ca(H),u_fog_horizon_blend:new s.bM(H),u_fog_vertical_limit:new s.bK(H),u_fog_temporal_offset:new s.bM(H),u_frustum_tl:new s.bL(H),u_frustum_tr:new s.bL(H),u_frustum_br:new s.bL(H),u_frustum_bl:new s.bL(H),u_globe_pos:new s.bL(H),u_globe_radius:new s.bM(H),u_globe_transition:new s.bM(H),u_is_globe:new s.bN(H),u_viewport:new s.bK(H)}))(t)),_.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(H=>({u_cutoff_params:new s.ca(H)}))(t)),_.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(H=>({u_lighting_ambient_color:new s.bL(H),u_lighting_directional_dir:new s.bL(H),u_lighting_directional_color:new s.bL(H),u_ground_radiance:new s.bL(H)}))(t)),_.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(H=>({u_light_matrix_0:new s.bJ(H),u_light_matrix_1:new s.bJ(H),u_fade_range:new s.bK(H),u_shadow_normal_offset:new s.bL(H),u_shadow_intensity:new s.bM(H),u_shadow_texel_size:new s.bM(H),u_shadow_map_resolution:new s.bM(H),u_shadow_direction:new s.bL(H),u_shadow_bias:new s.bL(H),u_shadowmap_0:new s.bN(H),u_shadowmap_1:new s.bN(H)}))(t))}}setTerrainUniformValues(t,n){if(!this.terrainUniforms)return;const c=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d]&&c[d].set(this.program,d,n[d])}}setGlobeUniformValues(t,n){if(!this.globeUniforms)return;const c=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d]&&c[d].set(this.program,d,n[d])}}setFogUniformValues(t,n){if(!this.fogUniforms)return;const c=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}}setCutoffUniformValues(t,n){if(!this.cutoffUniforms)return;const c=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}}setLightsUniformValues(t,n){if(!this.lightsUniforms)return;const c=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}}setShadowUniformValues(t,n){if(this.failedToCreate||!this.shadowUniforms)return;const c=this.shadowUniforms;t.program.set(this.program);for(const d in n)c[d].set(this.program,d,n[d])}_drawDebugWireframe(t,n,c,d,p,_,b,E,I,A){const R=t.options.wireframe;if(R.terrain===!1&&R.layers2D===!1&&R.layers3D===!1)return;const D=t.context;if(!(!(!R.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!R.layers2D||t._terrain&&t._terrain.renderingToTexture||!u_.includes(this.name))||!(!R.layers3D||!Bf.includes(this.name))))return;const F=D.gl,q=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,p,D);if(!q)return;const U=[...this.fixedDefines];U.push("DEBUG_WIREFRAME");const H=t.getOrCreateProgram(this.name,{config:this.configuration,defines:U});D.program.set(H.program);const Z=(ne,de,le)=>{if(de[ne]&&le[ne])for(const he in de[ne])le[ne][he]&&le[ne][he].set(le.program,he,de[ne][he].current)};I&&I.setUniforms(H.program,D,H.binderUniforms,b,{zoom:E}),Z("fixedUniforms",this,H),Z("terrainUniforms",this,H),Z("globeUniforms",this,H),Z("fogUniforms",this,H),Z("lightsUniforms",this,H),Z("shadowUniforms",this,H),q.bind(),D.setColorMode(new oi([F.ONE,F.ONE_MINUS_SRC_ALPHA,F.ZERO,F.ONE],s.aj.transparent,[!0,!0,!0,!1])),D.setDepthMode(new Ft(n.func===F.LESS?F.LEQUAL:n.func,Ft.ReadOnly,n.range)),D.setStencilMode(Ht.disabled);const J=3*_.primitiveLength*2,re=3*_.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const ne=A||1;for(let de=0;de<ne;++de)H.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",de),F.drawElements(F.LINES,J,F.UNSIGNED_SHORT,re)}else A&&A>1?F.drawElementsInstanced(F.LINES,J,F.UNSIGNED_SHORT,re,A):F.drawElements(F.LINES,J,F.UNSIGNED_SHORT,re);p.bind(),D.program.set(this.program),D.setDepthMode(n),D.setStencilMode(c),D.setColorMode(d)}checkUniforms(t,n,c){if(this.fixedDefines.includes(n)){for(const d of Object.keys(c))if(!c[d].initialized)throw new Error(`Program '${this.name}', from draw '${t}': uniform ${d} not set but required by ${n} being defined`)}}draw(t,n,c,d,p,_,b,E,I,A,R,D,F,q,U,H){const Z=t.context,J=Z.gl;if(this.failedToCreate)return;Z.program.set(this.program),Z.setDepthMode(c),Z.setStencilMode(d),Z.setColorMode(p),Z.setCullFace(_);for(const de of Object.keys(this.fixedUniforms))this.fixedUniforms[de].set(this.program,de,b[de]);q&&q.setUniforms(this.program,Z,this.binderUniforms,D,{zoom:F});const re={[J.POINTS]:1,[J.LINES]:2,[J.TRIANGLES]:3,[J.LINE_STRIP]:1}[n];this.checkUniforms(E,"RENDER_SHADOWS",this.shadowUniforms);const ne=H&&H>0?1:void 0;for(const de of R.get()){const le=de.vaos||(de.vaos={});if((le[E]||(le[E]=new If)).bind(Z,this,I,q?q.getPaintVertexBuffers():[],A,de.vertexOffset,U||[],ne),this.forceManualRenderingForInstanceIDShaders){const he=H||1;for(let ae=0;ae<he;++ae)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",ae),A?J.drawElements(n,de.primitiveLength*re,J.UNSIGNED_SHORT,de.primitiveOffset*re*2):J.drawArrays(n,de.vertexOffset,de.vertexLength)}else H&&H>1?J.drawElementsInstanced(n,de.primitiveLength*re,J.UNSIGNED_SHORT,de.primitiveOffset*re*2,H):A?J.drawElements(n,de.primitiveLength*re,J.UNSIGNED_SHORT,de.primitiveOffset*re*2):J.drawArrays(n,de.vertexOffset,de.vertexLength);n===J.TRIANGLES&&A&&this._drawDebugWireframe(t,c,d,p,A,de,D,F,q,H)}}}function nu(l,t){const n=Math.pow(2,t.tileID.overscaledZ),c=t.tileSize*Math.pow(2,l.transform.tileZoom)/n,d=c*(t.tileID.canonical.x+t.tileID.wrap*n),p=c*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/s.ar(t,1,l.transform.tileZoom),u_pixel_coord_upper:[d>>16,p>>16],u_pixel_coord_lower:[65535&d,65535&p]}}const Na={terrain:0,flat:1},Va=s.ab.mat4.create(),ru=(l,t,n,c,d,p,_,b,E,I,A,R,D,F,q,U,H,Z)=>{const J=t.style.light,re=J.properties.get("position"),ne=[re.x,re.y,re.z],de=s.ab.mat3.create();J.properties.get("anchor")==="viewport"&&(s.ab.mat3.fromRotation(de,-t.transform.angle),s.ab.vec3.transformMat3(ne,ne,de));const le=J.properties.get("color"),he=t.transform,ae={u_matrix:l,u_lightpos:ne,u_lightintensity:J.properties.get("intensity"),u_lightcolor:[le.r,le.g,le.b],u_vertical_gradient:+n,u_opacity:c,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Va,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:Na[I],u_base_type:Na[A],u_ao:d,u_edge_radius:p,u_width_scale:_,u_flood_light_color:q,u_vertical_scale:U,u_flood_light_intensity:H,u_ground_shadow_factor:Z};return he.projection.name==="globe"&&(ae.u_tile_id=[b.canonical.x,b.canonical.y,1<<b.canonical.z],ae.u_zoom_transition=R,ae.u_inv_rot_matrix=F,ae.u_merc_center=D,ae.u_up_dir=he.projection.upVector(new s.bT(0,0,0),D[0]*s.ag,D[1]*s.ag),ae.u_height_lift=E),ae},Bl=(l,t,n,c,d,p)=>({u_matrix:l,u_edge_radius:t,u_width_scale:n,u_vertical_scale:c,u_height_type:Na[d],u_base_type:Na[p]}),Vf=(l,t,n,c,d,p,_,b,E,I,A,R,D,F,q,U,H)=>{const Z=ru(l,t,n,c,d,p,_,b,I,A,R,D,F,q,U,H,1,[0,0,0]),J={u_height_factor:-Math.pow(2,b.overscaledZ)/E.tileSize/8};return s.l(Z,nu(t,E),J)},Nl=(l,t)=>({u_matrix:l,u_emissive_strength:t}),Vl=(l,t,n,c)=>s.l(Nl(l,t),nu(n,c)),Uh=(l,t,n)=>({u_matrix:l,u_world:n,u_emissive_strength:t}),Uf=(l,t,n,c,d)=>s.l(Vl(l,t,n,c),{u_world:d}),h_=(l,t,n,c)=>{const d=s.ag/n.tileSize;return{u_matrix:l,u_camera_to_center_distance:t.getCameraToCenterDistance(c),u_extrude_scale:[t.pixelsToGLUnits[0]/d,t.pixelsToGLUnits[1]/d]}},Jo=(l,t,n=1)=>({u_matrix:l,u_color:t.toRenderColor(null),u_overlay:0,u_overlay_scale:n}),su=s.ab.mat4.create(),Mt=(l,t,n,c,d,p,_)=>{const b=l.transform,E=b.projection.name==="globe",I=E?s.cN(b.zoom,t.canonical)*b._pixelsPerMercatorPixel:s.ar(n,1,p),A={u_matrix:t.projMatrix,u_extrude_scale:I,u_intensity:_,u_inv_rot_matrix:su,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(E){A.u_inv_rot_matrix=c,A.u_merc_center=d,A.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],A.u_zoom_transition=s.ae(b.zoom);const R=d[0]*s.ag,D=d[1]*s.ag;A.u_up_dir=b.projection.upVector(new s.bT(0,0,0),R,D)}return A};function jh(l,[t,n,c,d],[p,_]){if(p===_)return[0,0,0,0];const b=255*(l-1)/(l*(_-p));return[t*b,n*b,c*b,d*b]}function Gh(l,t,[n,c]){return n===c?0:.5/l+(t-n)*(l-1)/(l*(c-n))}const _o=(l,t,n,c,d,p,_,b,E,I,A,R,D,F,q,U,H,Z,J,re,ne)=>({u_matrix:l,u_normalize_matrix:t,u_globe_matrix:n,u_merc_matrix:c,u_grid_matrix:d,u_tl_parent:p,u_scale_parent:I,u_fade_t:A.mix,u_opacity:A.opacity*R.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:R.paint.get("raster-brightness-min"),u_brightness_high:R.paint.get("raster-brightness-max"),u_saturation_factor:s.cO(R.paint.get("raster-saturation")),u_contrast_factor:s.cP(R.paint.get("raster-contrast")),u_spin_weights:Qo(R.paint.get("raster-hue-rotate")),u_perspective_transform:D,u_raster_elevation:F,u_zoom_transition:_,u_merc_center:b,u_cutoff_params:E,u_colorization_mix:jh(s.cQ,U,Z),u_colorization_offset:Gh(s.cQ,H,Z),u_color_ramp:q,u_texture_offset:[re/(J+2*re),J/(J+2*re)],u_texture_res:[J+2*re,J+2*re],u_emissive_strength:ne});function Qo(l){l*=Math.PI/180;const t=Math.sin(l),n=Math.cos(l);return[(2*n+1)/3,(-Math.sqrt(3)*t-n+1)/3,(Math.sqrt(3)*t-n+1)/3]}const Dt=.05,qh=(l,t,n,c,d,p,_,b,E,I,A,R)=>({u_matrix:l,u_normalize_matrix:t,u_globe_matrix:n,u_merc_matrix:c,u_grid_matrix:d,u_tl_parent:p,u_scale_parent:I,u_fade_t:A.mix,u_opacity:A.opacity,u_image0:0,u_image1:1,u_raster_elevation:R,u_zoom_transition:_,u_merc_center:b,u_cutoff_params:E}),d_=(l,t,n,c,d,p,_,b,E,I)=>({u_particle_texture:l,u_particle_texture_side_len:t,u_tile_offset:n,u_velocity:c,u_color_ramp:p,u_velocity_res:d,u_max_speed:_,u_uv_offset:b,u_data_scale:[255*E[0],255*E[1]],u_data_offset:I,u_particle_pos_scale:1.1,u_particle_pos_offset:[Dt,Dt]}),f_=(l,t,n,c,d,p,_,b,E,I)=>({u_particle_texture:l,u_particle_texture_side_len:t,u_velocity:n,u_velocity_res:c,u_max_speed:d,u_speed_factor:p,u_reset_rate:_,u_rand_seed:Math.random(),u_uv_offset:b,u_data_scale:[255*E[0],255*E[1]],u_data_offset:I,u_particle_pos_scale:1.1,u_particle_pos_offset:[Dt,Dt]}),ou=s.ab.mat4.create(),$h=(l,t,n,c,d,p,_,b,E,I,A,R,D,F,q,U,H,Z,J,re,ne,de)=>{const le=d.transform,he={u_is_size_zoom_constant:+(l==="constant"||l==="source"),u_is_size_feature_constant:+(l==="constant"||l==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:le.getCameraToCenterDistance(J),u_rotate_symbol:+n,u_aspect_ratio:le.width/le.height,u_fade_change:d.options.fadeDuration?d.symbolFadeChange:1,u_matrix:p,u_label_plane_matrix:_,u_coord_matrix:b,u_is_text:+I,u_elevation_from_sea:E?1:0,u_pitch_with_map:+c,u_texsize:A,u_texsize_icon:R,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:ou,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:ou,u_up_vector:[0,-1,0],u_color_adj_mat:re,u_icon_transition:ne||0,u_gamma_scale:c?d.transform.getCameraToCenterDistance(J)*Math.cos(d.terrain?0:d.transform._pitch):1,u_device_pixel_ratio:s.q.devicePixelRatio,u_is_halo:1,u_scale_factor:de||1};return J.name==="globe"&&(he.u_tile_id=[F.canonical.x,F.canonical.y,1<<F.canonical.z],he.u_zoom_transition=q,he.u_inv_rot_matrix=H,he.u_merc_center=U,he.u_camera_forward=le._camera.forward(),he.u_ecef_origin=s.cR(le.globeMatrix,F.toUnwrapped()),he.u_tile_matrix=Float32Array.from(le.globeMatrix),he.u_up_vector=Z),he},Zh=(l,t,n,c)=>({u_matrix:l,u_emissive_strength:t,u_opacity:n,u_color:c}),jf=(l,t,n,c,d,p,_,b,E)=>s.l(function(I,A,R,D,F,q){const{width:U,height:H}=D.imageManager.getPixelSize(A),Z=Math.pow(2,q.tileID.overscaledZ),J=q.tileSize*Math.pow(2,D.transform.tileZoom)/Z,re=J*(q.tileID.canonical.x+q.tileID.wrap*Z),ne=J*q.tileID.canonical.y;return{u_image:0,u_pattern_tl:R.tl,u_pattern_br:R.br,u_texsize:[U,H],u_pattern_size:R.displaySize,u_pattern_units_to_pixels:F?[D.transform.width,-1*D.transform.height]:[1/s.ar(q,1,D.transform.tileZoom),1/s.ar(q,1,D.transform.tileZoom)],u_pixel_coord_upper:[re>>16,ne>>16],u_pixel_coord_lower:[65535&re,65535&ne]}}(0,p,_,c,b,E),{u_matrix:l,u_emissive_strength:t,u_opacity:n}),Hh=new Float32Array(s.ab.mat4.identity([])),Ul=(l,t,n,c,d,p,_,b,E,I,A,R,D,F=[0,0,0],q)=>{const U=d.style.light,H=U.properties.get("position"),Z=[-H.x,-H.y,H.z],J=s.ab.mat3.create();U.properties.get("anchor")==="viewport"&&(s.ab.mat3.fromRotation(J,-d.transform.angle),s.ab.vec3.transformMat3(Z,Z,J));const re=A.alphaMode==="MASK",ne=U.properties.get("color").toRenderColor(null),de=D.paint.get("model-ambient-occlusion-intensity"),le=D.paint.get("model-color").constantOr(s.aj.white).toRenderColor(null),he=D.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:l,u_lighting_matrix:t,u_normal_matrix:n,u_node_matrix:c||Hh,u_lightpos:Z,u_lightintensity:U.properties.get("intensity"),u_lightcolor:[ne.r,ne.g,ne.b],u_camera_pos:F,u_opacity:p,u_baseTextureIsAlpha:0,u_alphaMask:+re,u_alphaCutoff:A.alphaCutoff,u_baseColorFactor:[_.r,_.g,_.b,_.a],u_emissiveFactor:[b[0],b[1],b[2],1],u_metallicFactor:E,u_roughnessFactor:I,u_baseColorTexture:Hn.BaseColor,u_metallicRoughnessTexture:Hn.MetallicRoughness,u_normalTexture:Hn.Normal,u_occlusionTexture:Hn.Occlusion,u_emissionTexture:Hn.Emission,u_lutTexture:Hn.LUT,u_color_mix:[le.r,le.g,le.b,he],u_aoIntensity:de,u_emissive_strength:R,u_occlusionTextureTransform:q||[0,0,0,0]}},au=(l,t=Hh,n=Hh)=>({u_matrix:l,u_instance:t,u_node_matrix:n}),Wh={fillExtrusion:l=>({u_matrix:new s.bJ(l),u_lightpos:new s.bL(l),u_lightintensity:new s.bM(l),u_lightcolor:new s.bL(l),u_vertical_gradient:new s.bM(l),u_opacity:new s.bM(l),u_edge_radius:new s.bM(l),u_width_scale:new s.bM(l),u_ao:new s.bK(l),u_height_type:new s.bN(l),u_base_type:new s.bN(l),u_tile_id:new s.bL(l),u_zoom_transition:new s.bM(l),u_inv_rot_matrix:new s.bJ(l),u_merc_center:new s.bK(l),u_up_dir:new s.bL(l),u_height_lift:new s.bM(l),u_flood_light_color:new s.bL(l),u_vertical_scale:new s.bM(l),u_flood_light_intensity:new s.bM(l),u_ground_shadow_factor:new s.bL(l)}),fillExtrusionDepth:l=>({u_matrix:new s.bJ(l),u_edge_radius:new s.bM(l),u_width_scale:new s.bM(l),u_vertical_scale:new s.bM(l),u_height_type:new s.bN(l),u_base_type:new s.bN(l)}),fillExtrusionPattern:l=>({u_matrix:new s.bJ(l),u_lightpos:new s.bL(l),u_lightintensity:new s.bM(l),u_lightcolor:new s.bL(l),u_vertical_gradient:new s.bM(l),u_height_factor:new s.bM(l),u_edge_radius:new s.bM(l),u_width_scale:new s.bM(l),u_ao:new s.bK(l),u_height_type:new s.bN(l),u_base_type:new s.bN(l),u_tile_id:new s.bL(l),u_zoom_transition:new s.bM(l),u_inv_rot_matrix:new s.bJ(l),u_merc_center:new s.bK(l),u_up_dir:new s.bL(l),u_height_lift:new s.bM(l),u_image:new s.bN(l),u_texsize:new s.bK(l),u_pixel_coord_upper:new s.bK(l),u_pixel_coord_lower:new s.bK(l),u_tile_units_to_pixels:new s.bM(l),u_opacity:new s.bM(l)}),fillExtrusionGroundEffect:l=>({u_matrix:new s.bJ(l),u_opacity:new s.bM(l),u_ao_pass:new s.bM(l),u_meter_to_tile:new s.bM(l),u_ao:new s.bK(l),u_flood_light_intensity:new s.bM(l),u_flood_light_color:new s.bL(l),u_attenuation:new s.bM(l),u_edge_radius:new s.bM(l),u_fb:new s.bN(l),u_fb_size:new s.bM(l),u_dynamic_offset:new s.bM(l)}),fill:l=>({u_matrix:new s.bJ(l),u_emissive_strength:new s.bM(l)}),fillPattern:l=>({u_matrix:new s.bJ(l),u_emissive_strength:new s.bM(l),u_image:new s.bN(l),u_texsize:new s.bK(l),u_pixel_coord_upper:new s.bK(l),u_pixel_coord_lower:new s.bK(l),u_tile_units_to_pixels:new s.bM(l)}),fillOutline:l=>({u_matrix:new s.bJ(l),u_emissive_strength:new s.bM(l),u_world:new s.bK(l)}),fillOutlinePattern:l=>({u_matrix:new s.bJ(l),u_emissive_strength:new s.bM(l),u_world:new s.bK(l),u_image:new s.bN(l),u_texsize:new s.bK(l),u_pixel_coord_upper:new s.bK(l),u_pixel_coord_lower:new s.bK(l),u_tile_units_to_pixels:new s.bM(l)}),circle:s.cS,collisionBox:l=>({u_matrix:new s.bJ(l),u_camera_to_center_distance:new s.bM(l),u_extrude_scale:new s.bK(l)}),collisionCircle:l=>({u_matrix:new s.bJ(l),u_inv_matrix:new s.bJ(l),u_camera_to_center_distance:new s.bM(l),u_viewport_size:new s.bK(l)}),debug:l=>({u_color:new s.cz(l),u_matrix:new s.bJ(l),u_overlay:new s.bN(l),u_overlay_scale:new s.bM(l)}),clippingMask:l=>({u_matrix:new s.bJ(l)}),heatmap:l=>({u_extrude_scale:new s.bM(l),u_intensity:new s.bM(l),u_matrix:new s.bJ(l),u_inv_rot_matrix:new s.bJ(l),u_merc_center:new s.bK(l),u_tile_id:new s.bL(l),u_zoom_transition:new s.bM(l),u_up_dir:new s.bL(l)}),heatmapTexture:l=>({u_image:new s.bN(l),u_color_ramp:new s.bN(l),u_opacity:new s.bM(l)}),hillshade:l=>({u_matrix:new s.bJ(l),u_image:new s.bN(l),u_latrange:new s.bK(l),u_light:new s.bK(l),u_shadow:new s.cz(l),u_highlight:new s.cz(l),u_emissive_strength:new s.bM(l),u_accent:new s.cz(l)}),hillshadePrepare:l=>({u_matrix:new s.bJ(l),u_image:new s.bN(l),u_dimension:new s.bK(l),u_zoom:new s.bM(l)}),line:s.cT,linePattern:s.cU,raster:l=>({u_matrix:new s.bJ(l),u_normalize_matrix:new s.bJ(l),u_globe_matrix:new s.bJ(l),u_merc_matrix:new s.bJ(l),u_grid_matrix:new s.cA(l),u_tl_parent:new s.bK(l),u_scale_parent:new s.bM(l),u_fade_t:new s.bM(l),u_opacity:new s.bM(l),u_image0:new s.bN(l),u_image1:new s.bN(l),u_brightness_low:new s.bM(l),u_brightness_high:new s.bM(l),u_saturation_factor:new s.bM(l),u_contrast_factor:new s.bM(l),u_spin_weights:new s.bL(l),u_perspective_transform:new s.bK(l),u_raster_elevation:new s.bM(l),u_zoom_transition:new s.bM(l),u_merc_center:new s.bK(l),u_cutoff_params:new s.ca(l),u_colorization_mix:new s.ca(l),u_colorization_offset:new s.bM(l),u_color_ramp:new s.bN(l),u_texture_offset:new s.bK(l),u_texture_res:new s.bK(l),u_emissive_strength:new s.bM(l)}),rasterParticle:l=>({u_matrix:new s.bJ(l),u_normalize_matrix:new s.bJ(l),u_globe_matrix:new s.bJ(l),u_merc_matrix:new s.bJ(l),u_grid_matrix:new s.cA(l),u_tl_parent:new s.bK(l),u_scale_parent:new s.bM(l),u_fade_t:new s.bM(l),u_opacity:new s.bM(l),u_image0:new s.bN(l),u_image1:new s.bN(l),u_raster_elevation:new s.bM(l),u_zoom_transition:new s.bM(l),u_merc_center:new s.bK(l),u_cutoff_params:new s.ca(l)}),rasterParticleTexture:l=>({u_texture:new s.bN(l),u_opacity:new s.bM(l)}),rasterParticleDraw:l=>({u_particle_texture:new s.bN(l),u_particle_texture_side_len:new s.bM(l),u_tile_offset:new s.bK(l),u_velocity:new s.bN(l),u_color_ramp:new s.bN(l),u_velocity_res:new s.bK(l),u_max_speed:new s.bM(l),u_uv_offset:new s.bK(l),u_data_scale:new s.bK(l),u_data_offset:new s.bM(l),u_particle_pos_scale:new s.bM(l),u_particle_pos_offset:new s.bK(l)}),rasterParticleUpdate:l=>({u_particle_texture:new s.bN(l),u_particle_texture_side_len:new s.bM(l),u_velocity:new s.bN(l),u_velocity_res:new s.bK(l),u_max_speed:new s.bM(l),u_speed_factor:new s.bM(l),u_reset_rate:new s.bM(l),u_rand_seed:new s.bM(l),u_uv_offset:new s.bK(l),u_data_scale:new s.bK(l),u_data_offset:new s.bM(l),u_particle_pos_scale:new s.bM(l),u_particle_pos_offset:new s.bK(l)}),symbol:l=>({u_is_size_zoom_constant:new s.bN(l),u_is_size_feature_constant:new s.bN(l),u_size_t:new s.bM(l),u_size:new s.bM(l),u_camera_to_center_distance:new s.bM(l),u_rotate_symbol:new s.bN(l),u_aspect_ratio:new s.bM(l),u_fade_change:new s.bM(l),u_matrix:new s.bJ(l),u_label_plane_matrix:new s.bJ(l),u_coord_matrix:new s.bJ(l),u_is_text:new s.bN(l),u_elevation_from_sea:new s.bN(l),u_pitch_with_map:new s.bN(l),u_texsize:new s.bK(l),u_texsize_icon:new s.bK(l),u_texture:new s.bN(l),u_texture_icon:new s.bN(l),u_gamma_scale:new s.bM(l),u_device_pixel_ratio:new s.bM(l),u_tile_id:new s.bL(l),u_zoom_transition:new s.bM(l),u_inv_rot_matrix:new s.bJ(l),u_merc_center:new s.bK(l),u_camera_forward:new s.bL(l),u_tile_matrix:new s.bJ(l),u_up_vector:new s.bL(l),u_ecef_origin:new s.bL(l),u_is_halo:new s.bN(l),u_icon_transition:new s.bM(l),u_color_adj_mat:new s.bJ(l),u_scale_factor:new s.bM(l)}),background:l=>({u_matrix:new s.bJ(l),u_emissive_strength:new s.bM(l),u_opacity:new s.bM(l),u_color:new s.cz(l)}),backgroundPattern:l=>({u_matrix:new s.bJ(l),u_emissive_strength:new s.bM(l),u_opacity:new s.bM(l),u_image:new s.bN(l),u_pattern_tl:new s.bK(l),u_pattern_br:new s.bK(l),u_texsize:new s.bK(l),u_pattern_size:new s.bK(l),u_pixel_coord_upper:new s.bK(l),u_pixel_coord_lower:new s.bK(l),u_pattern_units_to_pixels:new s.bK(l)}),terrainRaster:l=>({u_matrix:new s.bJ(l),u_image0:new s.bN(l),u_skirt_height:new s.bM(l),u_ground_shadow_factor:new s.bL(l)}),skybox:l=>({u_matrix:new s.bJ(l),u_sun_direction:new s.bL(l),u_cubemap:new s.bN(l),u_opacity:new s.bM(l),u_temporal_offset:new s.bM(l)}),skyboxGradient:l=>({u_matrix:new s.bJ(l),u_color_ramp:new s.bN(l),u_center_direction:new s.bL(l),u_radius:new s.bM(l),u_opacity:new s.bM(l),u_temporal_offset:new s.bM(l)}),skyboxCapture:l=>({u_matrix_3f:new s.cA(l),u_sun_direction:new s.bL(l),u_sun_intensity:new s.bM(l),u_color_tint_r:new s.ca(l),u_color_tint_m:new s.ca(l),u_luminance:new s.bM(l)}),globeRaster:l=>({u_proj_matrix:new s.bJ(l),u_globe_matrix:new s.bJ(l),u_normalize_matrix:new s.bJ(l),u_merc_matrix:new s.bJ(l),u_zoom_transition:new s.bM(l),u_merc_center:new s.bK(l),u_image0:new s.bN(l),u_grid_matrix:new s.cA(l),u_skirt_height:new s.bM(l),u_far_z_cutoff:new s.bM(l),u_frustum_tl:new s.bL(l),u_frustum_tr:new s.bL(l),u_frustum_br:new s.bL(l),u_frustum_bl:new s.bL(l),u_globe_pos:new s.bL(l),u_globe_radius:new s.bM(l),u_viewport:new s.bK(l)}),globeAtmosphere:l=>({u_frustum_tl:new s.bL(l),u_frustum_tr:new s.bL(l),u_frustum_br:new s.bL(l),u_frustum_bl:new s.bL(l),u_horizon:new s.bM(l),u_transition:new s.bM(l),u_fadeout_range:new s.bM(l),u_color:new s.ca(l),u_high_color:new s.ca(l),u_space_color:new s.ca(l),u_temporal_offset:new s.bM(l),u_horizon_angle:new s.bM(l)}),model:l=>({u_matrix:new s.bJ(l),u_lighting_matrix:new s.bJ(l),u_normal_matrix:new s.bJ(l),u_node_matrix:new s.bJ(l),u_lightpos:new s.bL(l),u_lightintensity:new s.bM(l),u_lightcolor:new s.bL(l),u_camera_pos:new s.bL(l),u_opacity:new s.bM(l),u_baseColorFactor:new s.ca(l),u_emissiveFactor:new s.ca(l),u_metallicFactor:new s.bM(l),u_roughnessFactor:new s.bM(l),u_baseTextureIsAlpha:new s.bN(l),u_alphaMask:new s.bN(l),u_alphaCutoff:new s.bM(l),u_baseColorTexture:new s.bN(l),u_metallicRoughnessTexture:new s.bN(l),u_normalTexture:new s.bN(l),u_occlusionTexture:new s.bN(l),u_emissionTexture:new s.bN(l),u_lutTexture:new s.bN(l),u_color_mix:new s.ca(l),u_aoIntensity:new s.bM(l),u_emissive_strength:new s.bM(l),u_occlusionTextureTransform:new s.ca(l)}),modelDepth:l=>({u_matrix:new s.bJ(l),u_instance:new s.bJ(l),u_node_matrix:new s.bJ(l)}),groundShadow:l=>({u_matrix:new s.bJ(l),u_ground_shadow_factor:new s.bL(l)}),stars:l=>({u_matrix:new s.bJ(l),u_up:new s.bL(l),u_right:new s.bL(l),u_intensity_multiplier:new s.bM(l)}),snowParticle:l=>({u_modelview:new s.bJ(l),u_projection:new s.bJ(l),u_time:new s.bM(l),u_cam_pos:new s.bL(l),u_velocityConeAperture:new s.bM(l),u_velocity:new s.bM(l),u_horizontalOscillationRadius:new s.bM(l),u_horizontalOscillationRate:new s.bM(l),u_boxSize:new s.bM(l),u_billboardSize:new s.bM(l),u_simpleShapeParameters:new s.bK(l),u_screenSize:new s.bK(l),u_thinningCenterPos:new s.bK(l),u_thinningShape:new s.bL(l),u_thinningAffectedRatio:new s.bM(l),u_thinningParticleOffset:new s.bM(l),u_particleColor:new s.ca(l),u_direction:new s.bL(l)}),rainParticle:l=>({u_modelview:new s.bJ(l),u_projection:new s.bJ(l),u_time:new s.bM(l),u_cam_pos:new s.bL(l),u_texScreen:new s.bN(l),u_velocityConeAperture:new s.bM(l),u_velocity:new s.bM(l),u_boxSize:new s.bM(l),u_rainDropletSize:new s.bK(l),u_distortionStrength:new s.bM(l),u_rainDirection:new s.bL(l),u_color:new s.ca(l),u_screenSize:new s.bK(l),u_thinningCenterPos:new s.bK(l),u_thinningShape:new s.bL(l),u_thinningAffectedRatio:new s.bM(l),u_thinningParticleOffset:new s.bM(l),u_shapeDirectionalPower:new s.bM(l),u_shapeNormalPower:new s.bM(l),u_mode:new s.bM(l)}),vignette:l=>({u_vignetteShape:new s.bL(l),u_vignetteColor:new s.ca(l)}),occlusion:l=>({u_matrix:new s.bJ(l),u_anchorPos:new s.bL(l),u_screenSizePx:new s.bK(l),u_occluderSizePx:new s.bK(l),u_color:new s.ca(l)})};class ys{constructor(t,n,c,d){this.id=ys.uniqueIdxCounter,ys.uniqueIdxCounter++,this.context=t;const p=t.gl;this.buffer=p.createBuffer(),this.dynamicDraw=!!c,this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),p.bufferData(p.ELEMENT_ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?p.DYNAMIC_DRAW:p.STATIC_DRAW),this.dynamicDraw||d||n.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){this.id=ys.uniqueIdxCounter,ys.uniqueIdxCounter++;const n=this.context.gl;this.context.unbindVAO(),this.bind(),n.bufferSubData(n.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}ys.uniqueIdxCounter=0;const br={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class go{constructor(t,n,c,d,p,_){this.length=n.length,this.attributes=c,this.itemSize=n.bytesPerElement,this.dynamicDraw=d,this.instanceCount=_,this.context=t;const b=t.gl;this.buffer=b.createBuffer(),t.bindVertexBuffer.set(this.buffer),b.bufferData(b.ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?b.DYNAMIC_DRAW:b.STATIC_DRAW),this.dynamicDraw||p||n.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){const n=this.context.gl;this.bind(),n.bufferSubData(n.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,n){for(let c=0;c<this.attributes.length;c++){const d=n.attributes[this.attributes[c].name];d!==void 0&&t.enableVertexAttribArray(d)}}setVertexAttribPointers(t,n,c){for(let d=0;d<this.attributes.length;d++){const p=this.attributes[d],_=n.attributes[p.name];_!==void 0&&t.vertexAttribPointer(_,p.components,t[br[p.type]],!1,this.itemSize,p.offset+this.itemSize*(c||0))}}setVertexAttribDivisor(t,n,c){for(let d=0;d<this.attributes.length;d++){const p=n.attributes[this.attributes[d].name];p!==void 0&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(p,c)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Xh{constructor(t,n,c,d,p){this.context=t,this.width=n,this.height=c;const _=this.framebuffer=t.gl.createFramebuffer();d&&(this.colorAttachment=new Fa(t,_)),p&&(this.depthAttachmentType=p,this.depthAttachment=p==="renderbuffer"?new Oh(t,_):new kf(t,_))}destroy(){const t=this.context.gl;if(this.colorAttachment){const n=this.colorAttachment.get();n&&t.deleteTexture(n)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const n=this.depthAttachment.get();n&&t.deleteRenderbuffer(n)}else{const n=this.depthAttachment.get();n&&t.deleteTexture(n)}t.deleteFramebuffer(this.framebuffer)}}class Yh{constructor(t,n){this.gl=t,this.clearColor=new Eh(this),this.clearDepth=new Mh(this),this.clearStencil=new Ih(this),this.colorMask=new Ah(this),this.depthMask=new Pf(this),this.stencilMask=new zf(this),this.stencilFunc=new t_(this),this.stencilOp=new Ll(this),this.stencilTest=new kl(this),this.depthRange=new Rf(this),this.depthTest=new vr(this),this.depthFunc=new Ch(this),this.blend=new Yc(this),this.blendFunc=new Kc(this),this.blendColor=new Ph(this),this.blendEquation=new zh(this),this.cullFace=new Jc(this),this.cullFaceSide=new Rh(this),this.frontFace=new Dh(this),this.program=new Qc(this),this.activeTexture=new Df(this),this.viewport=new Lf(this),this.bindFramebuffer=new Oa(this),this.bindRenderbuffer=new i_(this),this.bindTexture=new n_(this),this.bindVertexBuffer=new r_(this),this.bindElementBuffer=new s_(this),this.bindVertexArrayOES=new o_(this),this.pixelStoreUnpack=new a_(this),this.pixelStoreUnpackPremultiplyAlpha=new Lh(this),this.pixelStoreUnpackFlipY=new kh(this),this.options=n?Object.assign({},n):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=n&&!!n.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxPointSize=t.getParameter(t.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,n,c){return new ys(this,t,n,c)}createVertexBuffer(t,n,c,d,p){return new go(this,t,n,c,d,p)}createRenderbuffer(t,n,c){const d=this.gl,p=d.createRenderbuffer();return this.bindRenderbuffer.set(p),d.renderbufferStorage(d.RENDERBUFFER,t,n,c),this.bindRenderbuffer.set(null),p}createFramebuffer(t,n,c,d){return new Xh(this,t,n,c,d)}clear({color:t,depth:n,stencil:c,colorMask:d}){const p=this.gl;let _=0;t&&(_|=p.COLOR_BUFFER_BIT,this.clearColor.set(t),this.colorMask.set(d||[!0,!0,!0,!0])),n!==void 0&&(_|=p.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(n),this.depthMask.set(!0)),c!==void 0&&(_|=p.STENCIL_BUFFER_BIT,this.clearStencil.set(c),this.stencilMask.set(255)),p.clear(_)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){s.bn(t.blendFunction,oi.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let Ua;function lu(l,t,n,c,d,p,_){const b=l.context,E=b.gl,I=l.transform,A=l.getOrCreateProgram("collisionBox"),R=[];let D=0,F=0;for(let ne=0;ne<c.length;ne++){const de=c[ne],le=t.getTile(de),he=le.getBucket(n);if(!he)continue;const ae=Jr(de,he,I);let ge=ae;d[0]===0&&d[1]===0||(ge=l.translatePosMatrix(ae,le,d,p));const Te=_?he.textCollisionBox:he.iconCollisionBox,Ue=he.collisionCircleArray;if(Ue.length>0){const Le=s.ab.mat4.create(),He=ge;s.ab.mat4.mul(Le,he.placementInvProjMatrix,I.glCoordMatrix),s.ab.mat4.mul(Le,Le,he.placementViewportMatrix),R.push({circleArray:Ue,circleOffset:F,transform:He,invTransform:Le,projection:he.getProjection()}),D+=Ue.length/4,F=D}Te&&(l.terrain&&l.terrain.setupElevationDraw(le,A),A.draw(l,E.LINES,Ft.disabled,Ht.disabled,l.colorModeForRenderPass(),Xt.disabled,h_(ge,I,le,he.getProjection()),n.id,Te.layoutVertexBuffer,Te.indexBuffer,Te.segments,null,I.zoom,null,[Te.collisionVertexBuffer,Te.collisionVertexBufferExt]))}if(!_||!R.length)return;const q=l.getOrCreateProgram("collisionCircle"),U=new s.cV;U.resize(4*D),U._trim();let H=0;for(const ne of R)for(let de=0;de<ne.circleArray.length/4;de++){const le=4*de,he=ne.circleArray[le+0],ae=ne.circleArray[le+1],ge=ne.circleArray[le+2],Te=ne.circleArray[le+3];U.emplace(H++,he,ae,ge,Te,0),U.emplace(H++,he,ae,ge,Te,1),U.emplace(H++,he,ae,ge,Te,2),U.emplace(H++,he,ae,ge,Te,3)}(!Ua||Ua.length<2*D)&&(Ua=function(ne){const de=2*ne,le=new s.aU;le.resize(de),le._trim();for(let he=0;he<de;he++){const ae=6*he;le.uint16[ae+0]=4*he+0,le.uint16[ae+1]=4*he+1,le.uint16[ae+2]=4*he+2,le.uint16[ae+3]=4*he+2,le.uint16[ae+4]=4*he+3,le.uint16[ae+5]=4*he+0}return le}(D));const Z=b.createIndexBuffer(Ua,!0),J=b.createVertexBuffer(U,s.cW.members,!0);for(const ne of R){const de={u_matrix:ne.transform,u_inv_matrix:ne.invTransform,u_camera_to_center_distance:(re=I).getCameraToCenterDistance(ne.projection),u_viewport_size:[re.width,re.height]};q.draw(l,E.TRIANGLES,Ft.disabled,Ht.disabled,l.colorModeForRenderPass(),Xt.disabled,de,n.id,J,Z,s.b7.simpleSegment(0,2*ne.circleOffset,ne.circleArray.length,ne.circleArray.length/2),null,I.zoom)}var re;J.destroy(),Z.destroy()}const jl=s.ab.mat4.create();function Ar(l){const t=l._camera.getWorldToCamera(l.worldSize,1),n=s.ab.mat4.multiply([],t,l.globeMatrix);s.ab.mat4.invert(n,n);const c=[0,0,0],d=[0,1,0,0];return s.ab.vec4.transformMat4(d,d,n),c[0]=d[0],c[1]=d[1],c[2]=d[2],s.ab.vec3.normalize(c,c),c}function Vi({width:l,height:t,anchor:n,textOffset:c,textScale:d},p){const{horizontalAlign:_,verticalAlign:b}=s.bD(n),E=-(_-.5)*l,I=-(b-.5)*t,A=s.bC(n,c);return new s.P((E/d+A[0])*p,(I/d+A[1])*p)}function cu(l,t,n,c,d,p,_,b,E,I,A){const R=l.text.placedSymbolArray,D=l.text.dynamicLayoutVertexArray,F=l.icon.dynamicLayoutVertexArray,q={},U=l.getProjection(),H=Uo(b,U,p),Z=p.elevation,J=U.upVectorScale(b.canonical,p.center.lat,p.worldSize).metersToTile;D.clear();for(let re=0;re<R.length;re++){const ne=R.get(re),{tileAnchorX:de,tileAnchorY:le,numGlyphs:he}=ne,ae=ne.hidden||!ne.crossTileID||l.allowVerticalPlacement&&!ne.placedOrientation?null:c[ne.crossTileID];if(ae){let ge=0,Te=0,Ue=0;if(Z){const Ge=Z?Z.getAtTileOffset(b,de,le):0,[ut,Je,Xe]=U.upVector(b.canonical,de,le);ge=Ge*ut*J,Te=Ge*Je*J,Ue=Ge*Xe*J}let[Le,He,Ze,ze]=fr(ne.projectedAnchorX+ge,ne.projectedAnchorY+Te,ne.projectedAnchorZ+Ue,n?H:_);const je=Nc(p.getCameraToCenterDistance(U),ze);let it=d.evaluateSizeForFeature(l.textSizeData,I,ne)*je/s.bw;n&&(it*=l.tilePixelRatio/E);const Ce=Vi(ae,it);n?({x:Le,y:He,z:Ze}=U.projectTilePoint(de+Ce.x,le+Ce.y,b.canonical),[Le,He,Ze]=fr(Le+ge,He+Te,Ze+Ue,_)):(t&&Ce._rotate(-p.angle),Le+=Ce.x,He+=Ce.y,Ze=0);const Ye=l.allowVerticalPlacement&&ne.placedOrientation===s.bq.vertical?Math.PI/2:0;for(let Ge=0;Ge<he;Ge++)s.bt(D,Le,He,Ze,Ye);A&&ne.associatedIconIndex>=0&&(q[ne.associatedIconIndex]={x:Le,y:He,z:Ze,angle:Ye})}else nn(he,D)}if(A){F.clear();const re=l.icon.placedSymbolArray;for(let ne=0;ne<re.length;ne++){const de=re.get(ne),{numGlyphs:le}=de,he=q[ne];if(de.hidden||!he)nn(le,F);else{const{x:ae,y:ge,z:Te,angle:Ue}=he;for(let Le=0;Le<le;Le++)s.bt(F,ae,ge,Te,Ue)}}l.icon.dynamicLayoutVertexBuffer.updateData(F)}l.text.dynamicLayoutVertexBuffer.updateData(D)}function Gl(l,t,n,c,d,p,_={}){const b=n.paint.get("icon-translate"),E=n.paint.get("text-translate"),I=n.paint.get("icon-translate-anchor"),A=n.paint.get("text-translate-anchor"),R=n.layout.get("icon-rotation-alignment"),D=n.layout.get("text-rotation-alignment"),F=n.layout.get("icon-pitch-alignment"),q=n.layout.get("text-pitch-alignment"),U=n.layout.get("icon-keep-upright"),H=n.layout.get("text-keep-upright"),Z=n.paint.get("icon-color-saturation"),J=n.paint.get("icon-color-contrast"),re=n.paint.get("icon-color-brightness-min"),ne=n.paint.get("icon-color-brightness-max"),de=n.layout.get("symbol-elevation-reference")==="sea",le=l.context,he=le.gl,ae=l.transform,ge=R==="map",Te=D==="map",Ue=F==="map",Le=q==="map",He=n.layout.get("symbol-sort-key").constantOr(1)!==void 0;let Ze=!1;const ze=l.depthModeForSublayer(0,Ft.ReadOnly),je=[s.at(ae.center.lng),s.aA(ae.center.lat)],it=n.layout.get("text-variable-anchor"),Ce=ae.projection.name==="globe",Ye=[],Ge=[0,-1,0];for(const ut of c){const Je=t.getTile(ut),Xe=Je.getBucket(n);if(!Xe||Xe.projection.name==="mercator"&&Ce||Xe.fullyClipped)continue;const nt=Xe.projection.name==="globe",lt=nt?s.ae(ae.zoom):0,bt=Uo(ut,Xe.getProjection(),ae),Et=ae.calculatePixelsToTileUnitsMatrix(Je),$t=it&&Xe.hasTextData(),kt=Xe.hasIconTextFit()&&$t&&Xe.hasIconData(),Bt=Xe.getProjection().createInversionMatrix(ae,ut.canonical),Yt=Ei=>{ae.depthOcclusionForSymbolsAndCircles&&(n.hasInitialOcclusionOpacityProperties||l.terrain)&&(Ei.push("DEPTH_D24"),Ei.push("DEPTH_OCCLUSION"))},fi=()=>{const Ei=ge&&n.layout.get("symbol-placement")!=="point",Ai=[];Yt(Ai);const Ki=Ei||kt,Pn=n.paint.get("icon-image-cross-fade").constantOr(0);l.terrainRenderModeElevated()&&Ue&&Ai.push("PITCH_WITH_MAP_TERRAIN"),nt&&(Ai.push("PROJECTION_GLOBE_VIEW"),Ki&&Ai.push("PROJECTED_POS_ON_VIEWPORT")),Pn>0&&Ai.push("ICON_TRANSITION"),Xe.icon.zOffsetVertexBuffer&&Ai.push("Z_OFFSET"),Z===0&&J===0&&re===0&&ne===1||Ai.push("COLOR_ADJUSTMENT"),Xe.sdfIcons&&Ai.push("RENDER_SDF");const vn=Xe.icon.programConfigurations.get(n.id),bn=l.getOrCreateProgram("symbol",{config:vn,defines:Ai}),zr=Je.imageAtlasTexture?Je.imageAtlasTexture.size:[0,0],Qn=Xe.iconSizeData,Ji=s.bp(Qn,ae.zoom),Bi=Ue||ae.pitch!==0,Li=Vn(bt,Je.tileID.canonical,Ue,ge,ae,Xe.getProjection(),Et),_i=lh(bt,Je.tileID.canonical,Ue,ge,ae,Xe.getProjection(),Et),cn=l.translatePosMatrix(_i,Je,b,I,!0),zn=l.translatePosMatrix(bt,Je,b,I),Fi=Ki?jl:Li,er=ge&&!Ue&&!Ei;let Gr=Ge;!Ce&&!ae.mercatorFromTransition||ge||(Gr=Ar(ae));const Sr=nt?Gr:Ge,gr=n.getColorAdjustmentMatrix(Z,J,re,ne),Ss=$h(Qn.kind,Ji,er,Ue,l,zn,Fi,cn,de,!1,zr,[0,0],!0,ut,lt,je,Bt,Sr,Xe.getProjection(),gr,Pn),qr=Je.imageAtlasTexture?Je.imageAtlasTexture:null,Rr=n.layout.get("icon-size").constantOr(0)!==1||Xe.iconsNeedLinear,aa=Xe.sdfIcons||l.options.rotating||l.options.zooming||Rr||Bi?he.LINEAR:he.NEAREST,Es=Xe.sdfIcons&&n.paint.get("icon-halo-width").constantOr(1)!==0,la=l.terrain&&Ue&&Ei?s.ab.mat4.invert(s.ab.mat4.create(),Li):jl;if(Ei&&Xe.icon){const el=ae.elevation,Eu=el?el.getAtTileOffsetFunc(ut,ae.center.lat,ae.worldSize,Xe.getProjection()):null,xd=on(bt,Je.tileID.canonical,Ue,ge,ae,Xe.getProjection(),Et);Vc(Xe,bt,l,!1,xd,_i,Ue,U,Eu,ut)}return{program:bn,buffers:Xe.icon,uniformValues:Ss,atlasTexture:qr,atlasTextureIcon:null,atlasInterpolation:aa,atlasInterpolationIcon:null,isSDF:Xe.sdfIcons,hasHalo:Es,tile:Je,labelPlaneMatrixInv:la}},zi=()=>{const Ei=Te&&n.layout.get("symbol-placement")!=="point",Ai=[],Ki=Ei||it||kt;l.terrainRenderModeElevated()&&Le&&Ai.push("PITCH_WITH_MAP_TERRAIN"),nt&&(Ai.push("PROJECTION_GLOBE_VIEW"),Ki&&Ai.push("PROJECTED_POS_ON_VIEWPORT")),Xe.text.zOffsetVertexBuffer&&Ai.push("Z_OFFSET"),Xe.iconsInText&&Ai.push("RENDER_TEXT_AND_SYMBOL"),Ai.push("RENDER_SDF"),Yt(Ai);const Pn=Xe.text.programConfigurations.get(n.id),vn=l.getOrCreateProgram("symbol",{config:Pn,defines:Ai});let bn,zr=[0,0],Qn=null;const Ji=Xe.textSizeData;Xe.iconsInText&&(zr=Je.imageAtlasTexture?Je.imageAtlasTexture.size:[0,0],Qn=Je.imageAtlasTexture?Je.imageAtlasTexture:null,bn=Le||ae.pitch!==0||l.options.rotating||l.options.zooming||Ji.kind==="composite"||Ji.kind==="camera"?he.LINEAR:he.NEAREST);const Bi=Je.glyphAtlasTexture?Je.glyphAtlasTexture.size:[0,0],Li=n.layout.get("text-size-scale-range"),_i=s.aw(l.scaleFactor,Li[0],Li[1]),cn=s.bp(Ji,ae.zoom,_i),zn=Vn(bt,Je.tileID.canonical,Le,Te,ae,Xe.getProjection(),Et),Fi=lh(bt,Je.tileID.canonical,Le,Te,ae,Xe.getProjection(),Et),er=l.translatePosMatrix(Fi,Je,E,A,!0),Gr=l.translatePosMatrix(bt,Je,E,A),Sr=Ki?jl:zn,gr=Te&&!Le&&!Ei;let Ss=Ge;!Ce&&!ae.mercatorFromTransition||Te||(Ss=Ar(ae));const qr=$h(Ji.kind,cn,gr,Le,l,Gr,Sr,er,de,!0,Bi,zr,!0,ut,lt,je,Bt,nt?Ss:Ge,Xe.getProjection(),null,null,_i),Rr=Je.glyphAtlasTexture?Je.glyphAtlasTexture:null,aa=he.LINEAR,Es=n.paint.get("text-halo-width").constantOr(1)!==0,la=l.terrain&&Le&&Ei?s.ab.mat4.invert(s.ab.mat4.create(),zn):jl;if(Ei&&Xe.text){const el=ae.elevation,Eu=el?el.getAtTileOffsetFunc(ut,ae.center.lat,ae.worldSize,Xe.getProjection()):null,xd=on(bt,Je.tileID.canonical,Le,Te,ae,Xe.getProjection(),Et);Vc(Xe,bt,l,!0,xd,Fi,Le,H,Eu,ut)}return{program:vn,buffers:Xe.text,uniformValues:qr,atlasTexture:Rr,atlasTextureIcon:Qn,atlasInterpolation:aa,atlasInterpolationIcon:bn,isSDF:!0,hasHalo:Es,tile:Je,labelPlaneMatrixInv:la}},Qi=Xe.icon.segments.get().length,ji=Xe.text.segments.get().length,Qt=Qi&&!_.onlyText?fi():null,xi=ji&&!_.onlyIcons?zi():null,Lt=n.paint.get("icon-opacity").constantOr(1),hi=n.paint.get("text-opacity").constantOr(1);if(He&&Xe.canOverlap){Ze=!0;const Ei=Lt&&!_.onlyText?Xe.icon.segments.get():[],Ai=hi&&!_.onlyIcons?Xe.text.segments.get():[];for(const Ki of Ei)Ye.push({segments:new s.b7([Ki]),sortKey:Ki.sortKey,state:Qt});for(const Ki of Ai)Ye.push({segments:new s.b7([Ki]),sortKey:Ki.sortKey,state:xi})}else _.onlyText||Ye.push({segments:Lt?Xe.icon.segments:new s.b7([]),sortKey:0,state:Qt}),_.onlyIcons||Ye.push({segments:hi?Xe.text.segments:new s.b7([]),sortKey:0,state:xi})}Ze&&Ye.sort((ut,Je)=>ut.sortKey-Je.sortKey);for(const ut of Ye){const Je=ut.state;if(Je)if(l.terrain?l.terrain.setupElevationDraw(Je.tile,Je.program,{useDepthForOcclusion:ae.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:Je.labelPlaneMatrixInv}):l.setupDepthForOcclusion(ae.depthOcclusionForSymbolsAndCircles,Je.program),le.activeTexture.set(he.TEXTURE0),Je.atlasTexture&&Je.atlasTexture.bind(Je.atlasInterpolation,he.CLAMP_TO_EDGE,!0),Je.atlasTextureIcon&&(le.activeTexture.set(he.TEXTURE1),Je.atlasTextureIcon&&Je.atlasTextureIcon.bind(Je.atlasInterpolationIcon,he.CLAMP_TO_EDGE,!0)),l.uploadCommonLightUniforms(l.context,Je.program),Je.hasHalo){const Xe=Je.uniformValues;Xe.u_is_halo=1,uu(Je.buffers,ut.segments,n,l,Je.program,ze,d,p,Xe,2),Xe.u_is_halo=0}else{if(Je.isSDF){const Xe=Je.uniformValues;Je.hasHalo&&(Xe.u_is_halo=1,uu(Je.buffers,ut.segments,n,l,Je.program,ze,d,p,Xe,1)),Xe.u_is_halo=0}uu(Je.buffers,ut.segments,n,l,Je.program,ze,d,p,Je.uniformValues,1)}}}function uu(l,t,n,c,d,p,_,b,E,I){const A=[l.dynamicLayoutVertexBuffer,l.opacityVertexBuffer,l.iconTransitioningVertexBuffer,l.globeExtVertexBuffer,l.zOffsetVertexBuffer];d.draw(c,c.context.gl.TRIANGLES,p,_,b,Xt.disabled,E,n.id,l.layoutVertexBuffer,l.indexBuffer,t,n.paint,c.transform.zoom,l.programConfigurations.get(n.id),A,I)}function Kh(l,t,n,c,d,p,_){const b=l.context.gl,E=n.paint.get("fill-pattern"),I=n.is3D(),A=I?l.stencilModeFor3D():Ht.disabled,R=E&&E.constantOr(1);let D,F,q,U,H;_?(F=R&&!n.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",D=b.LINES):(F=R?"fillPattern":"fill",D=b.TRIANGLES);for(const Z of c){const J=t.getTile(Z);if(R&&!J.patternsLoaded())continue;const re=J.getBucket(n);if(!re)continue;l.prepareDrawTile();const ne=re.programConfigurations.get(n.id),de=l.isTileAffectedByFog(Z),le=l.getOrCreateProgram(F,{config:ne,overrideFog:de});R&&(l.context.activeTexture.set(b.TEXTURE0),J.imageAtlasTexture&&J.imageAtlasTexture.bind(b.LINEAR,b.CLAMP_TO_EDGE),ne.updatePaintBuffers());const he=E.constantOr(null);if(he&&J.imageAtlas){const Te=J.imageAtlas,Ue=s.A.from(he).getPrimary().scaleSelf(s.q.devicePixelRatio).serialize(),Le=Te.patternPositions[Ue];Le&&ne.setConstantPatternPositions(Le)}const ae=l.translatePosMatrix(Z.projMatrix,J,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor")),ge=n.paint.get("fill-emissive-strength");if(_){U=re.indexBuffer2,H=re.segments2;const Te=l.terrain&&l.terrain.renderingToTexture?l.terrain.drapeBufferSize:[b.drawingBufferWidth,b.drawingBufferHeight];q=F==="fillOutlinePattern"&&R?Uf(ae,ge,l,J,Te):Uh(ae,ge,Te)}else U=re.indexBuffer,H=re.segments,q=R?Vl(ae,ge,l,J):Nl(ae,ge);l.uploadCommonUniforms(l.context,le,Z.toUnwrapped()),le.draw(l,D,d,I?A:l.stencilModeForClipping(Z),p,Xt.disabled,q,n.id,re.layoutVertexBuffer,U,H,n.paint,l.transform.zoom,ne,void 0)}}function ql(l,t,n,c,d,p,_,b){n.resetLayerRenderingStats(l);const E=l.context,I=E.gl,A=l.transform,R=n.paint.get("fill-extrusion-pattern"),D=R.constantOr(1),F=n.paint.get("fill-extrusion-opacity"),q=l.style.enable3dLights(),U=n.paint.get(q&&!D?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),H=[n.paint.get("fill-extrusion-ambient-occlusion-intensity"),U],Z=n.layout.get("fill-extrusion-edge-radius"),J=Z>0&&!n.paint.get("fill-extrusion-rounded-roof"),re=J?0:Z,ne=A.projection.name==="globe"?s.d3():0,de=A.projection.name==="globe",le=de?s.ae(A.zoom):0,he=[s.at(A.center.lng),s.aA(A.center.lat)],ae=n.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",ge=n.paint.get("fill-extrusion-flood-light-color").toRenderColor(ae?null:n.lut).toArray01().slice(0,3),Te=n.paint.get("fill-extrusion-flood-light-intensity"),Ue=n.paint.get("fill-extrusion-vertical-scale"),Le=n.paint.get("fill-extrusion-line-width").constantOr(1)!==0,He=n.paint.get("fill-extrusion-height-alignment"),Ze=n.paint.get("fill-extrusion-base-alignment"),ze=fo(l,n.paint.get("fill-extrusion-cutoff-fade-range")),je=[];let it;de&&je.push("PROJECTION_GLOBE_VIEW"),H[0]>0&&je.push("FAUX_AO"),J&&je.push("ZERO_ROOF_RADIUS"),b&&je.push("HAS_CENTROID"),Te>0&&je.push("FLOOD_LIGHT"),ze.shouldRenderCutoff&&je.push("RENDER_CUTOFF"),Le&&je.push("RENDER_WALL_MODE");const Ce=l.renderPass==="shadow",Ye=l.shadowRenderer,Ge=Ce&&!!Ye;l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!0);let ut=[0,0,0];if(Ye){const nt=l.style.directionalLight,lt=l.style.ambientLight;nt&&lt&&(ut=xh(l.style,nt,lt)),Ce||(je.push("RENDER_SHADOWS","DEPTH_TEXTURE"),Ye.useNormalOffset&&je.push("NORMAL_OFFSET")),it=je.concat(["SHADOWS_SINGLE_CASCADE"])}const Je=Ge?"fillExtrusionDepth":D?"fillExtrusionPattern":"fillExtrusion",Xe=n.getLayerRenderingStats();for(const nt of c){const lt=t.getTile(nt),bt=lt.getBucket(n);if(!bt||bt.projection.name!==A.projection.name)continue;let Et=!1;Ye&&(Et=Ye.getMaxCascadeForTile(nt.toUnwrapped())===0);const $t=l.isTileAffectedByFog(nt),kt=bt.programConfigurations.get(n.id),Bt=l.getOrCreateProgram(Je,{config:kt,defines:Et?it:je,overrideFog:$t});if(l.terrain&&l.terrain.setupElevationDraw(lt,Bt,{useMeterToDem:!0}),!bt.centroidVertexBuffer){const xi=Bt.attributes.a_centroid_pos;xi!==void 0&&I.vertexAttrib2f(xi,0,0)}!Ce&&Ye&&Ye.setupShadows(lt.tileID.toUnwrapped(),Bt,"vector-tile",lt.tileID.overscaledZ),D&&(l.context.activeTexture.set(I.TEXTURE0),lt.imageAtlasTexture&&lt.imageAtlasTexture.bind(I.LINEAR,I.CLAMP_TO_EDGE),kt.updatePaintBuffers());const Yt=R.constantOr(null);if(Yt&&lt.imageAtlas){const xi=lt.imageAtlas,Lt=s.A.from(Yt).getPrimary().scaleSelf(s.q.devicePixelRatio),hi=xi.patternPositions[Lt.serialize()];hi&&kt.setConstantPatternPositions(hi)}const fi=n.paint.get("fill-extrusion-vertical-gradient"),zi=1/bt.tileToMeter;let Qi;if(Ce&&Ye){if($a(lt.tileID,bt,l))continue;const xi=Ye.calculateShadowPassMatrixFromTile(lt.tileID.toUnwrapped());Qi=Bl(xi,re,zi,Ue,He,Ze)}else{const xi=l.translatePosMatrix(nt.expandedProjMatrix,lt,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),Lt=A.projection.createInversionMatrix(A,nt.canonical);Qi=D?Vf(xi,l,fi,F,H,re,zi,nt,lt,ne,He,Ze,le,he,Lt,ge,Ue):ru(xi,l,fi,F,H,re,zi,nt,ne,He,Ze,le,he,Lt,ge,Ue,Te,ut)}l.uploadCommonUniforms(E,Bt,nt.toUnwrapped(),null,ze);let ji=bt.segments;if(A.projection.name==="mercator"&&!Ce&&(ji=bt.getVisibleSegments(lt.tileID,l.terrain,l.transform.getFrustum(0)),!ji.get().length))continue;if(Xe)if(Ce)for(const xi of ji.get())Xe.numRenderedVerticesInShadowPass+=xi.primitiveLength;else for(const xi of ji.get())Xe.numRenderedVerticesInTransparentPass+=xi.primitiveLength;const Qt=[];(l.terrain||b)&&Qt.push(bt.centroidVertexBuffer),de&&Qt.push(bt.layoutVertexExtBuffer),Le&&Qt.push(bt.wallVertexBuffer),Bt.draw(l,E.gl.TRIANGLES,d,p,_,Xt.backCCW,Qi,n.id,bt.layoutVertexBuffer,bt.indexBuffer,ji,n.paint,l.transform.zoom,kt,Qt)}l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!1)}function ja(l,t,n,c,d,p,_,b,E,I,A,R,D,F,q,U,H,Z,J){const re=l.context,ne=re.gl,de=l.transform,le=l.transform.zoom,he=[],ae=fo(l,n.paint.get("fill-extrusion-cutoff-fade-range"));I==="clear"?(he.push("CLEAR_SUBPASS"),J&&(he.push("CLEAR_FROM_TEXTURE"),re.activeTexture.set(ne.TEXTURE0),J.bind(ne.LINEAR,ne.CLAMP_TO_EDGE))):I==="sdf"&&he.push("SDF_SUBPASS"),H&&he.push("HAS_CENTROID"),ae.shouldRenderCutoff&&he.push("RENDER_CUTOFF");const ge=n.layout.get("fill-extrusion-edge-radius"),Te=(Ue,Le,He,Ze,ze)=>{const je=Le.programConfigurations.get(n.id),it=l.isTileAffectedByFog(Ue),Ce=l.getOrCreateProgram("fillExtrusionGroundEffect",{config:je,defines:he,overrideFog:it}),Ye=((ut,Je,Xe,nt,lt,bt,Et,$t,kt,Bt,Yt)=>({u_matrix:Je,u_opacity:Xe,u_ao_pass:nt?1:0,u_meter_to_tile:lt,u_ao:bt,u_flood_light_intensity:Et,u_flood_light_color:$t,u_attenuation:kt,u_edge_radius:Bt,u_fb:0,u_fb_size:Yt,u_dynamic_offset:1}))(0,Ze,A,E,ze,[R,D*ze],F,q,U,le>=17?0:ge*ze,J?J.size[0]:0),Ge=[];H&&Ge.push(Le.hiddenByLandmarkVertexBuffer),l.uploadCommonUniforms(re,Ce,Ue.toUnwrapped(),null,ae),Ce.draw(l,re.gl.TRIANGLES,d,p,_,b,Ye,n.id,Le.vertexBuffer,Le.indexBuffer,He,n.paint,le,je,Ge)};for(const Ue of c){const Le=t.getTile(Ue),He=Le.getBucket(n);if(!He||He.projection.name!==de.projection.name||!He.groundEffect||He.groundEffect&&!He.groundEffect.hasData())continue;const Ze=He.groundEffect,ze=1/He.tileToMeter;{const je=l.translatePosMatrix(Ue.projMatrix,Le,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),it=Ze.getDefaultSegment();Te(Ue,Ze,it,je,ze)}if(Z)for(let je=0;je<4;je++){const it=s.d4[je](Ue),Ce=t.getTile(it);if(!Ce)continue;const Ye=Ce.getBucket(n);if(!Ye||Ye.projection.name!==de.projection.name||!Ye.groundEffect||Ye.groundEffect&&!Ye.groundEffect.hasData())continue;const Ge=Ye.groundEffect;let ut,Je;je===0?(ut=[-s.ag,0,0],Je=1):je===1?(ut=[s.ag,0,0],Je=0):je===2?(ut=[0,-s.ag,0],Je=3):(ut=[0,s.ag,0],Je=2);const Xe=Ge.regionSegments[Je];if(!Xe)continue;const nt=new Float32Array(16);s.ab.mat4.translate(nt,Ue.projMatrix,ut),Te(Ue,Ge,Xe,l.translatePosMatrix(nt,Le,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),ze)}}}function Ga(l,t,n,c,d,p,_){c.centroidVertexArray.length===0&&c.createCentroidsBuffer();const b=p?p.findDEMTileFor(n):null;if(!(b&&b.dem||_))return;p&&b&&b.dem&&c.selfDEMTileTimestamp!==b.dem._timestamp&&(c.borderDoneWithNeighborZ=[-1,-1,-1,-1],c.selfDEMTileTimestamp=b.dem._timestamp);const E=Z=>new s.P(Math.ceil((Z+s.d7)*s.d8),0),I=Z=>{const J=t.getSource().minzoom,re=de=>{const le=t.getTileByID(de);if(le&&le.hasData())return le.getBucket(d)},ne=[0,-1,1];for(const de of ne){if(Z.overscaledZ+de<J)continue;const le=re(Z.calculateScaledKey(Z.overscaledZ+de));if(le)return le}},A=[0,0,0],R=(Z,J)=>(A[0]=Math.min(Z.min.y,J.min.y),A[1]=Math.max(Z.max.y,J.max.y),A[2]=s.ag-J.min.x>Z.max.x?J.min.x-s.ag:Z.max.x,A),D=(Z,J)=>(A[0]=Math.min(Z.min.x,J.min.x),A[1]=Math.max(Z.max.x,J.max.x),A[2]=s.ag-J.min.y>Z.max.y?J.min.y-s.ag:Z.max.y,A),F=[(Z,J)=>R(Z,J),(Z,J)=>R(J,Z),(Z,J)=>D(Z,J),(Z,J)=>D(J,Z)],q=(Z,J,re,ne,de,le,he)=>{if(!p)return 0;const ae=[[le?re:Z,le?Z:re,0],[le?re:J,le?J:re,0]],ge=he<0?s.ag+he:he,Te=[le?ge:(Z+J)/2,le?(Z+J)/2:ge,0];return re===0&&he<0||re!==0&&he>0?p.getForTilePoints(de,[Te],!0,ne):ae.push(Te),p.getForTilePoints(n,ae,!0,b),Math.max(ae[0][2],ae[1][2],Te[2])/p.exaggeration()};for(let Z=0;Z<4;Z++){const J=c.borderFeatureIndices[Z];if(J.length===0)continue;const re=s.d4[Z](n),ne=I(re);if(!(ne&&ne instanceof s.d5))continue;const de=p?p.findDEMTileFor(re):null;if(!(de&&de.dem||_)||(p&&de&&de.dem&&c.borderDEMTileTimestamp[Z]!==de.dem._timestamp&&(c.borderDoneWithNeighborZ[Z]=-1,c.borderDEMTileTimestamp[Z]=de.dem._timestamp),c.borderDoneWithNeighborZ[Z]===ne.canonical.z))continue;ne.centroidVertexArray.length===0&&ne.createCentroidsBuffer();const le=(Z<2?1:5)-Z,he=ne.borderDoneWithNeighborZ[le]!==c.canonical.z,ae=ne.borderFeatureIndices[le];let ge=0;if(c.canonical.z!==ne.canonical.z){for(const Te of J)c.showCentroid(c.featuresOnBorder[Te]);if(he)for(const Te of ae)ne.showCentroid(ne.featuresOnBorder[Te]);c.borderDoneWithNeighborZ[Z]=ne.canonical.z,ne.borderDoneWithNeighborZ[le]=c.canonical.z}for(const Te of J){const Ue=c.featuresOnBorder[Te],Le=c.centroidData[Ue.centroidDataIndex],He=Ue.borders[Z];let Ze;for(;ge<ae.length;){Ze=ne.featuresOnBorder[ae[ge]];const ze=Ze.borders[le];if(ze[1]>He[0]+3||ze[0]>He[0]-3)break;ne.showCentroid(Ze),ge++}if(Ze&&ge<ae.length){const ze=ge;let je=0;for(;!(Ze.borders[le][0]>He[1]-3)&&(je++,++ge!==ae.length);)Ze=ne.featuresOnBorder[ae[ge]];Ze=ne.featuresOnBorder[ae[ze]];let it=!1;if(je>=1){const Ge=Ze.borders[le];Math.abs(He[0]-Ge[0])<3&&Math.abs(He[1]-Ge[1])<3&&(je=1,it=!0,ge=ze+1)}else if(je===0){c.showCentroid(Ue);continue}const Ce=ne.centroidData[Ze.centroidDataIndex];_&&it&&(((U=Le).flags|(H=Ce).flags)&s.d6?(U.flags|=s.d6,H.flags|=s.d6):(U.flags&=~s.d6,H.flags&=~s.d6));const Ye=Ue.intersectsCount()>1||Ze.intersectsCount()>1;if(je>1)ge=ze,Le.centroidXY=Ce.centroidXY=new s.P(0,0);else if(de&&de.dem&&!Ye){const Ge=F[Z](Le,Ce),ut=Z%2?s.ag-1:0,Je=q(Ge[0],Math.min(s.ag-1,Ge[1]),ut,de,re,Z<2,Ge[2]);Le.centroidXY=Ce.centroidXY=E(Je)}else Ye?Le.centroidXY=Ce.centroidXY=new s.P(0,0):(Le.centroidXY=c.encodeBorderCentroid(Ue),Ce.centroidXY=ne.encodeBorderCentroid(Ze));c.writeCentroidToBuffer(Le),ne.writeCentroidToBuffer(Ce)}else c.showCentroid(Ue)}c.borderDoneWithNeighborZ[Z]=ne.canonical.z,ne.borderDoneWithNeighborZ[le]=c.canonical.z}var U,H;(c.needsCentroidUpdate||!c.centroidVertexBuffer&&c.centroidVertexArray.length!==0)&&c.uploadCentroid(l)}const qa=[1,0,0],at=[0,1,0],wt=[0,0,1];function $a(l,t,n){const c=n.transform,d=n.shadowRenderer;if(!d)return!0;const p=l.toUnwrapped(),_=c.tileSize*d._cascades[n.currentShadowCascade].scale;let b=t.maxHeight;if(c.elevation){const U=c.elevation.getMinMaxForTile(l);U&&(b+=U.max)}const E=[...d.shadowDirection];E[2]=-E[2];const I=d.computeSimplifiedTileShadowVolume(p,b,_,E);if(!I)return!1;const A=[qa,at,wt,E,[E[0],0,E[2]],[0,E[1],E[2]]],R=c.projection.name==="globe",D=c.scaleZoom(_),F=s.bR.fromInvProjectionMatrix(c.invProjMatrix,c.worldSize,D,!R),q=d.getCurrentCascadeFrustum();return F.intersectsPrecise(I.vertices,I.planes,A)===0||q.intersectsPrecise(I.vertices,I.planes,A)===0}function Yi(l){return[l[0]*s.d9,l[1]*s.d9,l[2]*s.d9,0]}function ke(l,t,n,c,d,p,_,b,E){const I=c.getSource(),A=n.globeSharedBuffers;if(!A)return;let R,D,F;if(t&&(R=c.getTile(t)),I instanceof s.aJ?(D=I.texture,F=s.cI(0,0,n.transform)):R&&t&&(D=R.texture,F=s.cI(t.canonical.z,t.canonical.x,n.transform)),!D||!F)return;l||(F=s.ab.mat4.scale(s.ab.mat4.create(),F,[1,-1,1]));const q=n.context,U=q.gl,H=d.paint.get("raster-resampling")==="nearest"?U.NEAREST:U.LINEAR,Z=n.colorModeForDrapableLayerRenderPass(p),J=_.defines;J.push("GLOBE_POLES");const re=new Ft(U.LEQUAL,Ft.ReadWrite,n.depthRangeFor3D),ne=Float32Array.from(n.transform.expandedFarZProjMatrix),de=Float32Array.from(s.bb(s.cH(new s.bT(0,0,0))));n.terrain&&n.terrain.prepareDrawTile(),q.activeTexture.set(U.TEXTURE0),D.bind(H,U.CLAMP_TO_EDGE),q.activeTexture.set(U.TEXTURE1),D.bind(H,U.CLAMP_TO_EDGE),D.useMipmap&&q.extTextureFilterAnisotropic&&n.transform.pitch>20&&U.texParameterf(U.TEXTURE_2D,q.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,q.extTextureFilterAnisotropicMax);const[le,he,ae,ge]=t?A.getPoleBuffers(t.canonical.z,!1):A.getPoleBuffers(0,!0),Te=d.paint.get("raster-elevation");let Ue;l?(Ue=le,n.renderDefaultNorthPole=Te!==0):(Ue=he,n.renderDefaultSouthPole=Te!==0);const Le=Yi(_.mix),He=((ze,je,it,Ce,Ye,Ge,ut,Je,Xe,nt,lt,bt,Et)=>_o(ze,je,it,new Float32Array(16),new Float32Array(9),[0,0],Ce,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Ge,[0,0],Je,2,nt,lt,bt,1,0,Et))(ne,de,F,s.ae(n.transform.zoom),0,d,0,Te,0,Le,_.offset,_.range,p),Ze=n.getOrCreateProgram("raster",{defines:J});n.uploadCommonUniforms(q,Ze,null),Ze.draw(n,U.TRIANGLES,re,E,Z,b,He,d.id,Ue,ae,ge)}function Gf(l){const t=l._nearZ,n=l.projection.farthestPixelDistance(l),c=n-t,d=.2*l.height,p=t+d;return[t,n,(p-d-t)/c,(p-t)/c]}function hu(l,t,n,c){if(l)return t instanceof In&&l instanceof uo?t.getTextureDescriptor(l,n,!0):{texture:l.texture,mix:Yi(c.mix),offset:c.offset,buffer:0,tileSize:1}}var Jh=s.da([{name:"a_index",type:"Int16",components:1}]);class qf{constructor(t,n,c,d){const p={width:c[0],height:c[1],data:null},_=t.gl;this.targetColorTexture=new s.T(t,p,_.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new s.T(t,p,_.RGBA8,{useMipmap:!1}),this.context=t,this.updateParticleTexture(n,d),this.lastInvalidatedAt=0}updateParticleTexture(t,n){if(this.particleTextureDimension===n.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const c=this.context.gl,d=n.width*n.height;this.particleTexture0=new s.T(this.context,n,c.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new s.T(this.context,n,c.RGBA8,{premultiply:!1,useMipmap:!1});const p=new s.db;p.reserve(d);for(let _=0;_<d;_++)p.emplaceBack(_);this.particleIndexBuffer=this.context.createVertexBuffer(p,Jh.members,!0),this.particleSegment=s.b7.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=n.width}update(t){return!(this.lastInvalidatedAt<t&&(this.lastInvalidatedAt=s.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function $f(l,t,n){if(!l)return null;const c=t.getTextureDescriptor(l,n,!0);if(!c)return null;let{texture:d,mix:p,offset:_,tileSize:b,buffer:E,format:I}=c;if(!d||!I)return null;let A=!1;return I==="uint32"&&(A=!0,p[3]=0,p=jh(s.dc,p,[0,n.paint.get("raster-particle-max-speed")]),_=Gh(s.dc,_,[0,n.paint.get("raster-particle-max-speed")])),{texture:d,textureOffset:[E/(b+2*E),b/(b+2*E)],tileSize:b,scalarData:A,scale:p,offset:_,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[I]]}}function Zf(l){const t=l._nearZ,n=l.projection.farthestPixelDistance(l),c=n-t,d=.2*l.height,p=t+d;return[t,n,(p-d-t)/c,(p-t)/c]}const Za=new s.aj(1,0,0,1),p_=new s.aj(0,1,0,1),m_=new s.aj(0,0,1,1),Hf=new s.aj(1,0,1,1),du=new s.aj(0,1,1,1);function yo(l,t,n,c,d,p,_){const b=l.context,E=l.transform,I=b.gl,A=E.projection.name==="globe",R=A?["PROJECTION_GLOBE_VIEW"]:[];let D=s.ab.mat4.clone(n.projMatrix);if(A&&s.ae(E.zoom)>0){const Le=s.ba(n.canonical,E),He=s.dd(Le);D=s.ab.mat4.multiply(new Float32Array(16),E.globeMatrix,He),s.ab.mat4.multiply(D,E.projMatrix,D)}const F=s.ab.mat4.create();F[12]+=2*d/(s.q.devicePixelRatio*E.width),F[13]+=2*p/(s.q.devicePixelRatio*E.height),s.ab.mat4.multiply(D,F,D);const q=l.getOrCreateProgram("debug",{defines:R}),U=t.getTileByID(n.key);l.terrain&&l.terrain.setupElevationDraw(U,q);const H=Ft.disabled,Z=Ht.disabled,J=l.colorModeForRenderPass(),re="$debug";b.activeTexture.set(I.TEXTURE0),l.emptyTexture.bind(I.LINEAR,I.CLAMP_TO_EDGE),A?U._makeGlobeTileDebugBuffers(l.context,E):U._makeDebugTileBoundsBuffers(l.context,E.projection);const ne=U._tileDebugBuffer||l.debugBuffer,de=U._tileDebugIndexBuffer||l.debugIndexBuffer,le=U._tileDebugSegments||l.debugSegments;if(q.draw(l,I.LINE_STRIP,H,Z,J,Xt.disabled,Jo(D,c),re,ne,de,le,null,null,null,[U._globeTileDebugBorderBuffer]),_){const Le=U.latestRawTileData,He=Math.floor((Le&&Le.byteLength||0)/1024);let Ze=n.canonical.toString();n.overscaledZ!==n.canonical.z&&(Ze+=` => ${n.overscaledZ}`),Ze+=` ${U.state}`,Ze+=` ${He}kb`,function(ze,je){ze.initDebugOverlayCanvas();const it=ze.debugOverlayCanvas,Ce=ze.context.gl,Ye=ze.debugOverlayCanvas.getContext("2d");Ye.clearRect(0,0,it.width,it.height),Ye.shadowColor="white",Ye.shadowBlur=2,Ye.lineWidth=1.5,Ye.strokeStyle="white",Ye.textBaseline="top",Ye.font="bold 36px Open Sans, sans-serif",Ye.fillText(je,5,5),Ye.strokeText(je,5,5),ze.debugOverlayTexture.update(it),ze.debugOverlayTexture.bind(Ce.LINEAR,Ce.CLAMP_TO_EDGE)}(l,Ze)}const he=t.getTile(n).tileSize,ae=512/Math.min(he,512)*(n.overscaledZ/E.zoom)*.5,ge=U._tileDebugTextBuffer||l.debugBuffer,Te=U._tileDebugTextIndexBuffer||l.quadTriangleIndexBuffer,Ue=U._tileDebugTextSegments||l.debugSegments;q.draw(l,I.TRIANGLES,H,Z,oi.alphaBlended,Xt.disabled,Jo(D,s.aj.transparent,ae),re,ge,Te,Ue,null,null,null,[U._globeTileDebugTextBuffer])}function Qh(l,t,n,c){ea(l,0,t+n/2,l.transform.width,n,c)}function ed(l,t,n,c){ea(l,t-n/2,0,n,l.transform.height,c)}function ea(l,t,n,c,d,p){const _=l.context,b=_.gl;b.enable(b.SCISSOR_TEST),b.scissor(t*s.q.devicePixelRatio,n*s.q.devicePixelRatio,c*s.q.devicePixelRatio,d*s.q.devicePixelRatio),_.clear({color:p}),b.disable(b.SCISSOR_TEST)}const fu=s.da([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:xs}=fu;function Xs(l,t,n,c){l.emplaceBack(t,n,c)}class Wf{constructor(t){this.vertexArray=new s.de,this.indices=new s.aU,Xs(this.vertexArray,-1,-1,1),Xs(this.vertexArray,1,-1,1),Xs(this.vertexArray,-1,1,1),Xs(this.vertexArray,1,1,1),Xs(this.vertexArray,-1,-1,-1),Xs(this.vertexArray,1,-1,-1),Xs(this.vertexArray,-1,1,-1),Xs(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,xs),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=s.b7.simpleSegment(0,0,36,12)}}function kn(l,t,n,c,d,p){const _=l.context.gl,b=t.paint.get("sky-atmosphere-color"),E=t.paint.get("sky-atmosphere-halo-color"),I=t.paint.get("sky-atmosphere-sun-intensity"),A=((R,D,F,q,U)=>({u_matrix_3f:R,u_sun_direction:D,u_sun_intensity:F,u_color_tint_r:[q.r,q.g,q.b,q.a],u_color_tint_m:[U.r,U.g,U.b,U.a],u_luminance:5e-5}))(s.ab.mat3.fromMat4(s.ab.mat3.create(),c),d,I,b,E);_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_CUBE_MAP_POSITIVE_X+p,t.skyboxTexture,0),n.draw(l,_.TRIANGLES,Ft.disabled,Ht.disabled,oi.unblended,Xt.frontCW,A,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}const __=s.da([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class $l{constructor(t){const n=new s.df;n.emplaceBack(-1,1,1,0,0),n.emplaceBack(1,1,1,1,0),n.emplaceBack(1,-1,1,1,1),n.emplaceBack(-1,-1,1,0,1);const c=new s.aU;c.emplaceBack(0,1,2),c.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(n,__.members),this.indexBuffer=t.createIndexBuffer(c),this.segments=s.b7.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const Ui=s.da([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Ii{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class Xf{constructor(t){this.colorModeAlphaBlendedWriteRGB=new oi([1,jo,1,jo],s.aj.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new oi([1,0,1,0],s.aj.transparent,[!1,!1,!1,!0]),this.params=new Ii,this.updateNeeded=!0,t.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),t.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(t){const n=t.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new $l(n);const c=this.params.sizeRange,d=this.params.intensityRange,p=function(A){const R=s.di(30),D=[];for(let F=0;F<A;++F){const q=2*Math.PI*R(),U=Math.acos(1-2*R())-.5*Math.PI;D.push(s.ab.vec3.fromValues(Math.cos(U)*Math.cos(q),Math.cos(U)*Math.sin(q),Math.sin(U)))}return D}(this.params.starsCount),_=s.di(300),b=new s.dg,E=new s.aU;let I=0;for(let A=0;A<p.length;++A){const R=s.ab.vec3.scale([],p[A],200),D=Math.max(0,1+.01*c*(1*_()-.5)),F=Math.max(0,1+.01*d*(1*_()-.5));b.emplaceBack(R[0],R[1],R[2],-1,-1,D,F),b.emplaceBack(R[0],R[1],R[2],1,-1,D,F),b.emplaceBack(R[0],R[1],R[2],1,1,D,F),b.emplaceBack(R[0],R[1],R[2],-1,1,D,F),E.emplaceBack(I+0,I+1,I+2),E.emplaceBack(I+0,I+2,I+3),I+=4}this.starsVx=n.createVertexBuffer(b,Ui.members),this.starsIdx=n.createIndexBuffer(E),this.starsSegments=s.b7.simpleSegment(0,0,b.length,E.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,n){const c=t.context,d=c.gl,p=t.transform,_=new Ft(d.LEQUAL,Ft.ReadOnly,[0,1]),b=s.ae(p.zoom),E=t.style.getLut(n.scope),I=n.properties.get("color-use-theme")==="none",A=n.properties.get("color").toRenderColor(I?null:E).toArray01(),R=n.properties.get("high-color-use-theme")==="none",D=n.properties.get("high-color").toRenderColor(R?null:E).toArray01(),F=n.properties.get("space-color-use-theme")==="none",q=n.properties.get("space-color").toRenderColor(F?null:E).toArray01PremultipliedAlpha(),U=5e-4,H=s.dh(n.properties.get("horizon-blend"),0,1,U,.25),Z=s.cC(t,c,p)&&H===U?p.worldSize/(2*Math.PI*1.025)-1:p.globeRadius,J=t.frameCounter/1e3%1,re=s.ab.vec3.length(p.globeCenterInViewSpace),ne=Math.sqrt(Math.pow(re,2)-Math.pow(Z,2)),de=Math.acos(ne/re),le=he=>{const ae=p.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];he&&ae.push("ALPHA_PASS");const ge=t.getOrCreateProgram("globeAtmosphere",{defines:ae}),Te=((Le,He,Ze,ze,je,it,Ce,Ye,Ge,ut,Je,Xe)=>({u_frustum_tl:Le,u_frustum_tr:He,u_frustum_br:Ze,u_frustum_bl:ze,u_horizon:je,u_transition:it,u_fadeout_range:Ce,u_color:Ye,u_high_color:Ge,u_space_color:ut,u_temporal_offset:Je,u_horizon_angle:Xe}))(p.frustumCorners.TL,p.frustumCorners.TR,p.frustumCorners.BR,p.frustumCorners.BL,p.frustumCorners.horizon,b,H,A,D,q,J,de);t.uploadCommonUniforms(c,ge);const Ue=this.atmosphereBuffer;Ue&&ge.draw(t,d.TRIANGLES,_,Ht.disabled,he?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Xt.backCW,Te,he?"atmosphere_glow_alpha":"atmosphere_glow",Ue.vertexBuffer,Ue.indexBuffer,Ue.segments)};le(!1),le(!0)}drawStars(t,n){const c=s.aw(n.properties.get("star-intensity"),0,1);if(c===0)return;const d=t.context,p=d.gl,_=t.transform,b=t.getOrCreateProgram("stars"),E=s.ab.quat.identity([]);s.ab.quat.rotateX(E,E,-_._pitch),s.ab.quat.rotateZ(E,E,-_.angle),s.ab.quat.rotateX(E,E,s.ai(_._center.lat)),s.ab.quat.rotateY(E,E,-s.ai(_._center.lng));const I=s.ab.mat4.fromQuat(new Float32Array(16),E),A=s.ab.mat4.multiply([],_.starsProjMatrix,I),R=s.ab.mat3.fromMat4([],I),D=s.ab.mat3.invert([],R),F=[0,1,0];s.ab.vec3.transformMat3(F,F,D),s.ab.vec3.scale(F,F,this.params.sizeMultiplier);const q=[1,0,0];s.ab.vec3.transformMat3(q,q,D),s.ab.vec3.scale(q,q,this.params.sizeMultiplier);const U=(H=F,Z=q,J=c,{u_matrix:Float32Array.from(A),u_up:H,u_right:Z,u_intensity_multiplier:J});var H,Z,J;t.uploadCommonUniforms(d,b),this.starsVx&&this.starsIdx&&b.draw(t,p.TRIANGLES,Ft.disabled,Ht.disabled,this.colorModeAlphaBlendedWriteRGB,Xt.disabled,U,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function Ys(l,t){const n=[...l],c=t.cameraWorldSizeForFog/t.worldSize,d=s.ab.mat4.identity([]);return s.ab.mat4.scale(d,d,[c,c,1]),s.ab.mat4.multiply(n,d,n),s.ab.mat4.multiply(n,t.worldToFogMatrix,n),n}function Ha(l,t,n,c,d){const p=n.material,_=c.context,{baseColorTexture:b,metallicRoughnessTexture:E}=p.pbrMetallicRoughness,{normalTexture:I,occlusionTexture:A,emissionTexture:R}=p;function D(q,U,H){if(q&&(l.push(U),_.activeTexture.set(_.gl.TEXTURE0+H),q.gfxTexture)){const{minFilter:Z,magFilter:J,wrapS:re,wrapT:ne}=q.sampler;q.gfxTexture.bindExtraParam(Z,J,re,ne)}}D(b,"HAS_TEXTURE_u_baseColorTexture",Hn.BaseColor),D(E,"HAS_TEXTURE_u_metallicRoughnessTexture",Hn.MetallicRoughness),D(I,"HAS_TEXTURE_u_normalTexture",Hn.Normal),D(A,"HAS_TEXTURE_u_occlusionTexture",Hn.Occlusion),D(R,"HAS_TEXTURE_u_emissionTexture",Hn.Emission),d&&(d.texture||(d.texture=new s.dk(c.context,d.image,[d.image.height,d.image.height,d.image.height],_.gl.RGBA8)),_.activeTexture.set(_.gl.TEXTURE0+Hn.LUT),d.texture&&d.texture.bind(_.gl.LINEAR,_.gl.CLAMP_TO_EDGE),l.push("APPLY_LUT_ON_GPU")),n.texcoordBuffer&&(l.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(n.texcoordBuffer)),n.colorBuffer&&(l.push(n.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(n.colorBuffer)),n.normalBuffer&&(l.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(n.normalBuffer)),n.pbrBuffer&&(l.push("HAS_ATTRIBUTE_a_pbr"),l.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(n.pbrBuffer)),p.alphaMode!=="OPAQUE"&&p.alphaMode!=="MASK"||l.push("UNPREMULT_TEXTURE_IN_SHADER"),p.defined||l.push("DIFFUSE_SHADED");const F=c.shadowRenderer;F&&(l.push("RENDER_SHADOWS","DEPTH_TEXTURE"),F.useNormalOffset&&l.push("NORMAL_OFFSET"))}function Ks(l,t,n,c,d,p){const _=n.paint.get("model-opacity").constantOr(1),b=t.context,E=new Ft(t.context.gl.LEQUAL,Ft.ReadWrite,t.depthRangeFor3D),I=t.transform,A=l.mesh,R=A.material,D=R.pbrMetallicRoughness,F=t.style.fog;let q;q=t.transform.projection.zAxisUnit==="pixels"?[...l.nodeModelMatrix]:s.ab.mat4.multiply([],c.zScaleMatrix,l.nodeModelMatrix),s.ab.mat4.multiply(q,c.negCameraPosMatrix,q);const U=s.ab.mat4.invert([],q);s.ab.mat4.transpose(U,U);const H=n.paint.get("model-color-use-theme").constantOr("default")==="none",Z=n.paint.get("model-emissive-strength").constantOr(0),J=Ul(new Float32Array(l.worldViewProjection),new Float32Array(q),new Float32Array(U),null,t,_,D.baseColorFactor.toRenderColor(null),R.emissiveFactor,D.metallicFactor,D.roughnessFactor,R,Z,n),re={defines:[]},ne=[],de=t.shadowRenderer;de&&(de.useNormalOffset=!1),Ha(re.defines,ne,A,t,H?null:n.lut);let le=null;if(F){const ge=Ys(l.nodeModelMatrix,t.transform);if(le=new Float32Array(ge),I.projection.name!=="globe"){const Te=A.aabb.min,Ue=A.aabb.max,[Le,He]=F.getOpacityForBounds(ge,Te[0],Te[1],Ue[0],Ue[1]);re.overrideFog=Le>=fe||He>=fe}}const he=fo(t,n.paint.get("model-cutoff-fade-range"));he.shouldRenderCutoff&&re.defines.push("RENDER_CUTOFF");const ae=t.getOrCreateProgram("model",re);t.uploadCommonUniforms(b,ae,null,le,he),t.renderPass!=="shadow"&&de&&de.setupShadowsFromMatrix(l.nodeModelMatrix,ae),ae.draw(t,b.gl.TRIANGLES,E,d,p,A.material.doubleSided?Xt.disabled:Xt.backCCW,J,n.id,A.vertexBuffer,A.indexBuffer,A.segments,n.paint,t.transform.zoom,void 0,ne)}function pu(l,t,n,c,d,p,_){let b;b=l.projection.name==="globe"?s.dl(n,l):[...n],s.ab.mat4.multiply(b,b,t.matrix);const E=s.ab.mat4.multiply([],c,b);if(t.meshes)for(const I of t.meshes){if(I.material.alphaMode!=="BLEND"){_.push({mesh:I,depth:0,modelIndex:d,worldViewProjection:E,nodeModelMatrix:b});continue}const A=s.ab.vec3.transformMat4([],I.centroid,E);!l.isOrthographic&&A[2]<=0||p.push({mesh:I,depth:A[2],modelIndex:d,worldViewProjection:E,nodeModelMatrix:b})}if(t.children)for(const I of t.children)pu(l,I,n,c,d,p,_)}function Zl(l,t,n,c){const d=n.shadowRenderer;if(!d)return;const p=d.getShadowPassDepthMode(),_=d.getShadowPassColorMode(),b=d.calculateShadowPassMatrixFromMatrix(t),E=au(b);n.getOrCreateProgram("modelDepth",{defines:n._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(n,n.context.gl.TRIANGLES,p,Ht.disabled,_,Xt.backCCW,E,c.id,l.vertexBuffer,l.indexBuffer,l.segments,c.paint,n.transform.zoom,void 0,void 0)}function vs(l,t,n){const c=t.updateZoomBasedPaintProperties(),d=function(p,_,b){let E,I,A,R=p.terrain?p.terrain.exaggeration():0;if(p.terrain&&R>0){const D=p.terrain,F=D.findDEMTileFor(b);F&&F.dem?E=s.dn.create(D,b,F):R=0}if(R===0&&(_.terrainElevationMin=0,_.terrainElevationMax=0),R===_.validForExaggeration&&(R===0||E&&E._demTile&&E._demTile.tileID===_.validForDEMTile.id&&E._dem._timestamp===_.validForDEMTile.timestamp))return!1;for(const D in _.instancesPerModel){const F=_.instancesPerModel[D];for(let q=0;q<F.instancedDataArray.length;++q){const U=(E?R*E.getElevationAt(0|F.instancedDataArray.float32[16*q],0|F.instancedDataArray.float32[16*q+1],!0,!0):0)+F.instancesEvaluatedElevation[q];F.instancedDataArray.float32[16*q+6]=U,I=I?Math.min(_.terrainElevationMin,U):U,A=A?Math.max(_.terrainElevationMax,U):U}}return _.terrainElevationMin=I||0,_.terrainElevationMax=A||0,_.validForExaggeration=R,_.validForDEMTile=E&&E._demTile?{id:E._demTile.tileID,timestamp:E._dem._timestamp}:{id:void 0,timestamp:0},!0}(l,t,n);(c||d)&&(t.uploaded=!1,t.upload(l.context))}const Jn={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new s.cd([0,0,0],[s.ag,s.ag,0])};function mu(l,t){const n=1<<l.canonical.z,c=t.getFreeCameraOptions().position,d=t.elevation,p=l.canonical.x/n,_=(l.canonical.x+1)/n,b=l.canonical.y/n,E=(l.canonical.y+1)/n;let I=t._centerAltitude;if(d){const F=d.getMinMaxForTile(l);F&&F.max>I&&(I=F.max)}const A=s.aw(c.x,p,_)-c.x,R=s.aw(c.y,b,E)-c.y,D=s.bH(I,t.center.lat)-c.z;return t._zoomFromMercatorZ(Math.sqrt(A*A+R*R+D*D))}function Hl(l,t,n,c,d,p,_){const b=l.context,E=l.renderPass==="shadow",I=l.shadowRenderer,A=E&&I?I.getShadowPassDepthMode():new Ft(b.gl.LEQUAL,Ft.ReadWrite,l.depthRangeFor3D),R=l.isTileAffectedByFog(p);if(n.meshes)for(const D of n.meshes){const F=["MODEL_POSITION_ON_GPU"],q=[];let U,H,Z;c.instancedDataArray.length>20&&F.push("INSTANCED_ARRAYS");const J=fo(l,t.paint.get("model-cutoff-fade-range"));if(J.shouldRenderCutoff&&F.push("RENDER_CUTOFF"),E&&I)U=l.getOrCreateProgram("modelDepth",{defines:F}),H=au(_.shadowTileMatrix,_.shadowTileMatrix,Float32Array.from(n.matrix)),Z=I.getShadowPassColorMode();else{Ha(F,q,D,l,t.paint.get("model-color-use-theme").constantOr("default")==="none"?null:t.lut),U=l.getOrCreateProgram("model",{defines:F,overrideFog:R});const ne=D.material,de=ne.pbrMetallicRoughness,le=t.paint.get("model-opacity").constantOr(1),he=t.paint.get("model-emissive-strength").constantOr(0);H=Ul(p.expandedProjMatrix,Float32Array.from(n.matrix),new Float32Array(16),null,l,le,de.baseColorFactor.toRenderColor(null),ne.emissiveFactor,de.metallicFactor,de.roughnessFactor,ne,he,t,d),I&&(_.shadowUniformsInitialized?U.setShadowUniformValues(b,I.getShadowUniformValues()):(I.setupShadows(p.toUnwrapped(),U,"model-tile",p.overscaledZ),_.shadowUniformsInitialized=!0)),Z=J.shouldRenderCutoff||le<1||ne.alphaMode!=="OPAQUE"?oi.alphaBlended:oi.unblended}l.uploadCommonUniforms(b,U,p.toUnwrapped(),null,J);const re=D.material.doubleSided?Xt.disabled:Xt.backCCW;if(c.instancedDataArray.length>20)q.push(c.instancedDataBuffer),U.draw(l,b.gl.TRIANGLES,A,Ht.disabled,Z,re,H,t.id,D.vertexBuffer,D.indexBuffer,D.segments,t.paint,l.transform.zoom,void 0,q,c.instancedDataArray.length);else{const ne=E?"u_instance":"u_normal_matrix";for(let de=0;de<c.instancedDataArray.length;++de)H[ne]=new Float32Array(c.instancedDataArray.arrayBuffer,64*de,16),U.draw(l,b.gl.TRIANGLES,A,Ht.disabled,Z,re,H,t.id,D.vertexBuffer,D.indexBuffer,D.segments,t.paint,l.transform.zoom,void 0,q)}}if(n.children)for(const D of n.children)Hl(l,t,D,c,d,p,_)}const td=[1,-1,1];function id(l,t,n,c){if(!n.modelManager)return!0;const d=n.modelManager;if(!n.shadowRenderer)return!0;const p=n.shadowRenderer,_=t.aabb;let b=!0,E=l.maxHeight;if(E===0){let A=0;for(const R in l.instancesPerModel){const D=d.getModel(R,c);D?A=Math.max(A,Math.max(Math.max(D.aabb.max[0],D.aabb.max[1]),D.aabb.max[2])):b=!1}E=l.maxScale*A*1.41+l.maxVerticalOffset,b&&(l.maxHeight=E)}_.max[2]=E,_.min[2]+=l.terrainElevationMin,_.max[2]+=l.terrainElevationMax,s.ab.vec3.transformMat4(_.min,_.min,t.tileMatrix),s.ab.vec3.transformMat4(_.max,_.max,t.tileMatrix);const I=_.intersects(p.getCurrentCascadeFrustum());return n.currentShadowCascade===0&&(l.isInsideFirstShadowMapFrustum=I===2),I===0}function ta(l,t){const n=l.uniformValues.u_cutoff_params[0],c=l.uniformValues.u_cutoff_params[1],d=l.uniformValues.u_cutoff_params[2],p=l.uniformValues.u_cutoff_params[3];return c===n||p===d?1:s.aw(((t-n)/(c-n)-d)/(p-d),0,1)}function nd(l,t,n,c){if(t.pitch<20)return 1;const d=t.getWorldToCameraMatrix();s.ab.mat4.multiply(d,d,l);const p=s.ab.vec4.fromValues(n.min[0],n.min[1],n.min[2],1);let _=s.ab.vec4.transformMat4(s.ab.vec4.create(),p,d),b=_,E=_;p[1]=n.max[1],_=s.ab.vec4.transformMat4(s.ab.vec4.create(),p,d),b=_[1]<b[1]?_:b,E=_[1]>E[1]?_:E,p[0]=n.max[0],_=s.ab.vec4.transformMat4(s.ab.vec4.create(),p,d),b=_[1]<b[1]?_:b,E=_[1]>E[1]?_:E,p[1]=n.min[1],_=s.ab.vec4.transformMat4(s.ab.vec4.create(),p,d),b=_[1]<b[1]?_:b,E=_[1]>E[1]?_:E;const I=s.aw(c[0],0,1),A=100*t.pixelsPerMeter*s.aw(c[1],0,1),R=s.aw(c[2],0,1),D=s.ab.vec4.lerp(s.ab.vec4.create(),b,E,I),F=Math.tan(.5*t.fovX),q=-D[2]*F;if(A===0)return D[1]<-Math.abs(q)?R:1;const U=(-Math.abs(q)-D[1])/A,H=(J,re,ne)=>(1-ne)*J+ne*re,Z=s.aw(H(1,R,U),R,1);return H(1,Z,s.aw((t.pitch-20)/20,0,1))}class xo{}class rd{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,n,c){{const R=this._storage.get(n.id);if(R)return R.lastUsedFrameIdx=t,R.buf}const d=c.gl,p=d.getBufferParameter(d.ELEMENT_ARRAY_BUFFER,d.BUFFER_SIZE),_=new ArrayBuffer(p),b=new Int16Array(_);d.getBufferSubData(d.ELEMENT_ARRAY_BUFFER,0,new Int16Array(_));const E=new s.dq;for(let R=0;R<p/2;R+=3){const D=b[R],F=b[R+1],q=b[R+2];E.emplaceBack(D,F),E.emplaceBack(F,q),E.emplaceBack(q,D)}const I=c.bindVertexArrayOES.current,A=new xo;return A.buf=new ys(c,E),A.lastUsedFrameIdx=t,this._storage.set(n.id,A),c.bindVertexArrayOES.set(I),A.buf}update(t){for(const[n,c]of this._storage)t-c.lastUsedFrameIdx>30&&(c.buf.destroy(),this._storage.delete(n))}destroy(){for(const[t,n]of this._storage)n.buf.destroy(),this._storage.delete(t)}}class _u{constructor(t){this.occluderSize=30,this.depthOffset=-1e-4,t.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),t.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}const sd=s.da([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class od{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class Gn{constructor(t,n){this.revealStart=11,this.revealRange=2,t.registerParameter(this,[...n,"Reveal"],"revealStart",{min:0,max:17,step:.05}),t.registerParameter(this,[...n,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}const ad=s.da([{type:"Float32",name:"a_pos_2f",components:2}]);class ld{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(t,n){const c=t.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const _=new s.dr,b=new s.aU;_.emplaceBack(-1,-1),_.emplaceBack(1,-1),_.emplaceBack(1,1),_.emplaceBack(-1,1),b.emplaceBack(0,1,2),b.emplaceBack(0,2,3),this.vignetteVx=t.context.createVertexBuffer(_,ad.members),this.vignetteIdx=t.context.createIndexBuffer(b)}const d=s.b7.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){t.uploadCommonUniforms(t.context,c);const _={u_vignetteShape:(p={vignetteShape:[n.start,n.range,Math.pow(10,n.fadePower)],vignetteColor:[n.color.r,n.color.g,n.color.b,n.color.a*n.strength]}).vignetteShape,u_vignetteColor:p.vignetteColor};c.draw(t,t.context.gl.TRIANGLES,Ft.disabled,Ht.disabled,oi.alphaBlended,Xt.disabled,_,"vignette",this.vignetteVx,this.vignetteIdx,d,{})}var p}}class Wl{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(t,n){const c=t.getFreeCameraOptions().position,d=c.toAltitude(),p=c.toLngLat(),_=s.ai(p.lng),b=s.ai(p.lat),E=t.pixelsPerMeter/n,I=_*s.ds,A=s.ds*Math.log(Math.tan(Math.PI/4+b/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const R=-this._offsetYPrev+A,D=-this._elevationPrev+d;this._accumulatedOffsetX+=(-this._offsetXPrev+I)*E,this._accumulatedOffsetY+=R*E,this._accumulatedElevation+=D*E,this._offsetXPrev=I,this._offsetYPrev=A,this._elevationPrev=d}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function vo(l,t){return[-(l[0]-Math.floor(l[0]/t)*t),-(l[1]-Math.floor(l[1]/t)*t),-(l[2]-Math.floor(l[2]/t)*t)]}function gu(l){const t=s.di(1323123451230),n=[];for(let c=0;c<l;++c){const d=2*t()-1,p=2*t()-1,_=2*t()-1;n.push(s.ab.vec3.fromValues(d,p,_))}return n}function bs(l,t,n,c,d){const p=s.aw((d-n)/(c-n),0,1);return(1-p)*l+p*t}class yu{constructor(t){this._movement=new Wl,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new ld,this._ppmScaleFactor=t}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(t,n){const c=t.transform;this._movement.update(c,this._ppmScaleFactor);const d=c.starsProjMatrix,p=s.ab.quat.identity([]);s.ab.quat.rotateX(p,p,s.ai(90)-c._pitch),s.ab.quat.rotateZ(p,p,-c.angle);const _=s.ab.mat4.fromQuat(new Float32Array(16),p),b=s.ab.mat4.fromValues(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),E=s.ab.mat4.transpose([],b),I=s.ab.mat4.multiply([],E,_),A=Date.now()/1e3;return this._accumulatedTimeFromStart+=(A-this._prevTime)*n,this._prevTime=A,{projectionMatrix:d,modelviewMatrix:I}}}class Wa extends yu{constructor(t){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new Gn(t.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(t){const n=t.context;if(!this.particlesVx){const c=gu(this.particlesCount),d=new s.dt,p=new s.aU;let _=0;const b=s.di(1323123451230);for(let E=0;E<c.length;++E){const I=c[E],A=[2*b()-1,b(),b(),b()];d.emplaceBack(I[0],I[1],I[2],-1,-1,...A),d.emplaceBack(I[0],I[1],I[2],1,-1,...A),d.emplaceBack(I[0],I[1],I[2],1,1,...A),d.emplaceBack(I[0],I[1],I[2],-1,1,...A),p.emplaceBack(_+0,_+1,_+2),p.emplaceBack(_+0,_+2,_+3),_+=4}this.particlesVx=n.createVertexBuffer(d,sd.members),this.particlesIdx=n.createIndexBuffer(p)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.rain)return;const n=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},c=t.transform.zoom;if(n.revealStart>c)return;const d=bs(0,1,n.revealStart,n.revealStart+n.revealRange,c);if(!this.particlesVx||!this.particlesIdx)return;const p=structuredClone(this._params);let _=[-p.direction.x,p.direction.y,-100];s.ab.vec3.normalize(_,_);const b=structuredClone(this._vignetteParams);b.strength*=d,p.overrideStyleParameters||(p.intensity=t.style.rain.state.density,p.timeFactor=t.style.rain.state.intensity,p.color=structuredClone(t.style.rain.state.color),_=structuredClone(t.style.rain.state.direction),p.screenThinning.intensity=t.style.rain.state.centerThinning,p.dropletSizeX=t.style.rain.state.dropletSize[0],p.dropletSizeYScale=t.style.rain.state.dropletSize[1]/t.style.rain.state.dropletSize[0],p.distortionStrength=100*t.style.rain.state.distortionStrength,b.strength=1,b.color=structuredClone(t.style.rain.state.vignetteColor));const E=this.updateOnRender(t,p.timeFactor),I=t.context,A=I.gl,R=t.transform;this.screenTexture&&this.screenTexture.size[0]===t.width&&this.screenTexture.size[1]===t.height||(this.screenTexture=new s.T(I,{width:t.width,height:t.height,data:null},A.RGBA8)),p.distortionStrength>0&&(I.activeTexture.set(A.TEXTURE0),this.screenTexture.bind(A.LINEAR,A.CLAMP_TO_EDGE),A.copyTexSubImage2D(A.TEXTURE_2D,0,0,0,0,0,t.width,t.height));const D=t.getOrCreateProgram("rainParticle");t.uploadCommonUniforms(I,D),I.activeTexture.set(A.TEXTURE0),this.screenTexture.bind(A.LINEAR,A.CLAMP_TO_EDGE);const F=[p.color.r,p.color.g,p.color.b,p.color.a],q=(U,H)=>{const Z=vo(this._movement.getPosition(),U),J=p.dropletSizeX,re=p.dropletSizeX*p.dropletSizeYScale,ne=t.width/2,de=t.height/2,le=bs(0,p.screenThinning.start,0,1,p.screenThinning.intensity),he=bs(.001,p.screenThinning.range,0,1,p.screenThinning.intensity),ae=bs(0,p.screenThinning.particleOffset,0,1,p.screenThinning.intensity),ge=(Te={modelview:E.modelviewMatrix,projection:E.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:Z,velocityConeAperture:p.velocityConeAperture,velocity:p.velocity,boxSize:U,rainDropletSize:[J,re],distortionStrength:p.distortionStrength,rainDirection:_,color:F,screenSize:[R.width,R.height],thinningCenterPos:[ne,de],thinningShape:[le,he,Math.pow(10,p.screenThinning.fadePower)],thinningAffectedRatio:p.screenThinning.affectedRatio,thinningParticleOffset:ae,shapeDirectionalPower:p.shapeDirPower,shapeNormalPower:p.shapeNormalPower,mode:H?0:1},{u_modelview:Float32Array.from(Te.modelview),u_projection:Float32Array.from(Te.projection),u_time:Te.time,u_cam_pos:Te.camPos,u_texScreen:0,u_velocityConeAperture:Te.velocityConeAperture,u_velocity:Te.velocity,u_boxSize:Te.boxSize,u_rainDropletSize:Te.rainDropletSize,u_distortionStrength:Te.distortionStrength,u_rainDirection:Te.rainDirection,u_color:Te.color,u_screenSize:Te.screenSize,u_thinningCenterPos:Te.thinningCenterPos,u_thinningShape:Te.thinningShape,u_thinningAffectedRatio:Te.thinningAffectedRatio,u_thinningParticleOffset:Te.thinningParticleOffset,u_shapeDirectionalPower:Te.shapeDirectionalPower,u_shapeNormalPower:Te.shapeNormalPower,u_mode:Te.mode});var Te;const Ue=Math.round(p.intensity*this.particlesCount),Le=s.b7.simpleSegment(0,0,4*Ue,2*Ue);D.draw(t,A.TRIANGLES,Ft.disabled,Ht.disabled,oi.alphaBlended,Xt.disabled,ge,"rain_particles",this.particlesVx,this.particlesIdx,Le,{})};p.distortionStrength>0&&q(p.boxSize,!0),q(p.boxSize,!1),this._vignette.draw(t,b)}}const cd=s.da([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class ud extends yu{constructor(t){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new Gn(t.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(t){const n=t.context;if(!this.particlesVx){const c=gu(this.particlesCount),d=new s.du,p=new s.aU;let _=0;const b=s.di(1323123451230);for(let E=0;E<c.length;++E){const I=c[E],A=b(),R=b(),D=b(),F=[E/c.length,A,R,D],q=[b(),b()];d.emplaceBack(I[0],I[1],I[2],-1,-1,...F,...q),d.emplaceBack(I[0],I[1],I[2],1,-1,...F,...q),d.emplaceBack(I[0],I[1],I[2],1,1,...F,...q),d.emplaceBack(I[0],I[1],I[2],-1,1,...F,...q),p.emplaceBack(_+0,_+1,_+2),p.emplaceBack(_+0,_+2,_+3),_+=4}this.particlesVx=n.createVertexBuffer(d,cd.members),this.particlesIdx=n.createIndexBuffer(p)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.snow)return;const n=structuredClone(this._params);let c=[-n.direction.x,n.direction.y,-100];s.ab.vec3.normalize(c,c);const d=structuredClone(this._vignetteParams),p=n.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},_=t.transform.zoom;if(p.revealStart>_)return;const b=bs(0,1,p.revealStart,p.revealStart+p.revealRange,_);d.strength*=b,n.overrideStyleParameters||(n.intensity=t.style.snow.state.density,n.timeFactor=t.style.snow.state.intensity,n.color=structuredClone(t.style.snow.state.color),c=structuredClone(t.style.snow.state.direction),n.screenThinning.intensity=t.style.snow.state.centerThinning,n.billboardSize=2.79*t.style.snow.state.flakeSize,d.strength=1,d.color=structuredClone(t.style.snow.state.vignetteColor));const E=this.updateOnRender(t,n.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const I=t.context,A=I.gl,R=t.transform,D=t.getOrCreateProgram("snowParticle");t.uploadCommonUniforms(I,D),((F,q,U)=>{const H=vo(this._movement.getPosition(),F),Z=R.width/2,J=R.height/2,re=bs(0,U.screenThinning.start,0,1,U.screenThinning.intensity),ne=bs(.001,U.screenThinning.range,0,1,U.screenThinning.intensity),de=bs(0,U.screenThinning.particleOffset,0,1,U.screenThinning.intensity),le=(he={modelview:E.modelviewMatrix,projection:E.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:H,velocityConeAperture:U.velocityConeAperture,velocity:U.velocity,horizontalOscillationRadius:U.horizontalOscillationRadius,horizontalOscillationRate:U.horizontalOscillationRate,boxSize:F,billboardSize:1*U.billboardSize,simpleShapeParameters:[U.shapeFadeStart,U.shapeFadePower],screenSize:[R.width,R.height],thinningCenterPos:[Z,J],thinningShape:[re,ne,Math.pow(10,U.screenThinning.fadePower)],thinningAffectedRatio:U.screenThinning.affectedRatio,thinningParticleOffset:de,color:[U.color.r,U.color.g,U.color.b,U.color.a],direction:c},{u_modelview:Float32Array.from(he.modelview),u_projection:Float32Array.from(he.projection),u_time:he.time,u_cam_pos:he.camPos,u_velocityConeAperture:he.velocityConeAperture,u_velocity:he.velocity,u_horizontalOscillationRadius:he.horizontalOscillationRadius,u_horizontalOscillationRate:he.horizontalOscillationRate,u_boxSize:he.boxSize,u_billboardSize:he.billboardSize,u_simpleShapeParameters:he.simpleShapeParameters,u_screenSize:he.screenSize,u_thinningCenterPos:he.thinningCenterPos,u_thinningShape:he.thinningShape,u_thinningAffectedRatio:he.thinningAffectedRatio,u_thinningParticleOffset:he.thinningParticleOffset,u_particleColor:he.color,u_direction:he.direction});var he;const ae=Math.round(U.intensity*this.particlesCount),ge=s.b7.simpleSegment(0,0,4*ae,2*ae);this.particlesVx&&this.particlesIdx&&D.draw(t,A.TRIANGLES,Ft.disabled,Ht.disabled,oi.alphaBlended,Xt.disabled,le,"snow_particles",this.particlesVx,this.particlesIdx,ge,{})})(n.boxSize,0,n),this._vignette.draw(t,d)}}const Xl={symbol:function(l,t,n,c,d){if(l.renderPass!=="translucent")return;const p=Ht.disabled,_=l.colorModeForRenderPass(),b=n.layout.get("text-variable-anchor"),E=n.layout.get("text-size-scale-range"),I=s.aw(l.scaleFactor,E[0],E[1]);b&&function(D,F,q,U,H,Z,J,re){const ne=F.transform,de=H==="map",le=Z==="map";for(const he of D){const ae=U.getTile(he),ge=ae.getBucket(q);if(!ge||!ge.text||!ge.text.segments.get().length)continue;const Te=s.bp(ge.textSizeData,ne.zoom,re),Ue=Uo(he,ge.getProjection(),ne),Le=ne.calculatePixelsToTileUnitsMatrix(ae),He=Vn(Ue,ae.tileID.canonical,le,de,ne,ge.getProjection(),Le),Ze=ge.hasIconTextFit()&&ge.hasIconData();if(Te){const ze=Math.pow(2,ne.zoom-ae.tileID.overscaledZ);cu(ge,de,le,J,s.cX,ne,He,he,ze,Te,Ze)}}}(c,l,n,t,n.layout.get("text-rotation-alignment"),n.layout.get("text-pitch-alignment"),d,I);const A=n.paint.get("icon-opacity").constantOr(1)!==0,R=n.paint.get("text-opacity").constantOr(1)!==0;n.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(A||R)?Gl(l,t,n,c,p,_):(A&&Gl(l,t,n,c,p,_,{onlyIcons:!0}),R&&Gl(l,t,n,c,p,_,{onlyText:!0})),t.map.showCollisionBoxes&&(lu(l,t,n,c,n.paint.get("text-translate"),n.paint.get("text-translate-anchor"),!0),lu(l,t,n,c,n.paint.get("icon-translate"),n.paint.get("icon-translate-anchor"),!1))},circle:function(l,t,n,c){if(l.renderPass!=="translucent")return;const d=n.paint.get("circle-opacity"),p=n.paint.get("circle-stroke-width"),_=n.paint.get("circle-stroke-opacity"),b=n.layout.get("circle-sort-key").constantOr(1)!==void 0,E=n.paint.get("circle-emissive-strength");if(d.constantOr(1)===0&&(p.constantOr(1)===0||_.constantOr(1)===0))return;const I=l.context,A=I.gl,R=l.transform,D=l.depthModeForSublayer(0,Ft.ReadOnly),F=Ht.disabled,q=l.colorModeForDrapableLayerRenderPass(E),U=R.projection.name==="globe",H=[s.at(R.center.lng),s.aA(R.center.lat)],Z=[];for(let re=0;re<c.length;re++){const ne=c[re],de=t.getTile(ne),le=de.getBucket(n);if(!le||le.projection.name!==R.projection.name)continue;const he=le.programConfigurations.get(n.id),ae=s.cY(n),ge=l.isTileAffectedByFog(ne);U&&ae.push("PROJECTION_GLOBE_VIEW"),ae.push("DEPTH_D24"),l.terrain&&R.depthOcclusionForSymbolsAndCircles&&ae.push("DEPTH_OCCLUSION");const Te=l.getOrCreateProgram("circle",{config:he,defines:ae,overrideFog:ge}),Ue=le.layoutVertexBuffer,Le=le.globeExtVertexBuffer,He=le.indexBuffer,Ze=R.projection.createInversionMatrix(R,ne.canonical),ze={programConfiguration:he,program:Te,layoutVertexBuffer:Ue,globeExtVertexBuffer:Le,indexBuffer:He,uniformValues:s.cZ(l,ne,de,Ze,H,n),tile:de};if(b){const je=le.segments.get();for(const it of je)Z.push({segments:new s.b7([it]),sortKey:it.sortKey,state:ze})}else Z.push({segments:le.segments,sortKey:0,state:ze})}b&&Z.sort((re,ne)=>re.sortKey-ne.sortKey);const J={useDepthForOcclusion:R.depthOcclusionForSymbolsAndCircles};for(const re of Z){const{programConfiguration:ne,program:de,layoutVertexBuffer:le,globeExtVertexBuffer:he,indexBuffer:ae,uniformValues:ge,tile:Te}=re.state,Ue=re.segments;l.terrain&&l.terrain.setupElevationDraw(Te,de,J),l.uploadCommonUniforms(I,de,Te.tileID.toUnwrapped()),de.draw(l,A.TRIANGLES,D,F,q,Xt.disabled,ge,n.id,le,ae,Ue,n.paint,R.zoom,ne,[he])}},heatmap:function(l,t,n,c){if(n.paint.get("heatmap-opacity")!==0)if(l.renderPass==="offscreen"){const d=l.context,p=d.gl,_=Ht.disabled,b=new oi([p.ONE,p.ONE,p.ONE,p.ONE],s.aj.transparent,[!0,!0,!0,!0]);(function(F,q,U,H){const Z=F.gl,J=q.width*H,re=q.height*H;F.activeTexture.set(Z.TEXTURE1),F.viewport.set([0,0,J,re]);let ne=U.heatmapFbo;if(!ne||ne&&(ne.width!==J||ne.height!==re)){ne&&ne.destroy();const de=Z.createTexture();Z.bindTexture(Z.TEXTURE_2D,de),Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_WRAP_S,Z.CLAMP_TO_EDGE),Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_WRAP_T,Z.CLAMP_TO_EDGE),Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_MIN_FILTER,Z.LINEAR),Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_MAG_FILTER,Z.LINEAR),ne=U.heatmapFbo=F.createFramebuffer(J,re,!0,null),function(le,he,ae,ge,Te,Ue){const Le=le.gl;Le.texImage2D(Le.TEXTURE_2D,0,le.extRenderToTextureHalfFloat?Le.RGBA16F:Le.RGBA,Te,Ue,0,Le.RGBA,le.extRenderToTextureHalfFloat?Le.HALF_FLOAT:Le.UNSIGNED_BYTE,null),ge.colorAttachment.set(ae)}(F,0,de,ne,J,re)}else Z.bindTexture(Z.TEXTURE_2D,ne.colorAttachment.get()),F.bindFramebuffer.set(ne.framebuffer)})(d,l,n,l.transform.projection.name==="globe"?.5:.25),d.clear({color:s.aj.transparent});const E=l.transform,I=E.projection.name==="globe",A=I?["PROJECTION_GLOBE_VIEW"]:[],R=I?Xt.frontCCW:Xt.disabled,D=[s.at(E.center.lng),s.aA(E.center.lat)];for(let F=0;F<c.length;F++){const q=c[F];if(t.hasRenderableParent(q))continue;const U=t.getTile(q),H=U.getBucket(n);if(!H||H.projection.name!==E.projection.name)continue;const Z=l.isTileAffectedByFog(q),J=H.programConfigurations.get(n.id),re=l.getOrCreateProgram("heatmap",{config:J,defines:A,overrideFog:Z}),{zoom:ne}=l.transform;l.terrain&&l.terrain.setupElevationDraw(U,re),l.uploadCommonUniforms(d,re,q.toUnwrapped());const de=E.projection.createInversionMatrix(E,q.canonical);re.draw(l,p.TRIANGLES,Ft.disabled,_,b,R,Mt(l,q,U,de,D,ne,n.paint.get("heatmap-intensity")),n.id,H.layoutVertexBuffer,H.indexBuffer,H.segments,n.paint,l.transform.zoom,J,I?[H.globeExtVertexBuffer]:null)}d.viewport.set([0,0,l.width,l.height])}else l.renderPass==="translucent"&&(l.context.setColorMode(l.colorModeForRenderPass()),function(d,p){const _=d.context,b=_.gl,E=p.heatmapFbo;if(!E)return;_.activeTexture.set(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,E.colorAttachment.get()),_.activeTexture.set(b.TEXTURE1);let I=p.colorRampTexture;I||(I=p.colorRampTexture=new s.T(_,p.colorRamp,b.RGBA8)),I.bind(b.LINEAR,b.CLAMP_TO_EDGE),d.getOrCreateProgram("heatmapTexture").draw(d,b.TRIANGLES,Ft.disabled,Ht.disabled,d.colorModeForRenderPass(),Xt.disabled,((A,R,D,F)=>({u_image:0,u_color_ramp:1,u_opacity:R.paint.get("heatmap-opacity")}))(0,p),p.id,d.viewportBuffer,d.quadTriangleIndexBuffer,d.viewportSegments,p.paint,d.transform.zoom)}(l,n))},line:function(l,t,n,c){if(l.renderPass!=="translucent")return;const d=n.paint.get("line-opacity"),p=n.paint.get("line-width");if(d.constantOr(1)===0||p.constantOr(1)===0)return;const _=n.paint.get("line-emissive-strength"),b=n.paint.get("line-occlusion-opacity"),E=n.layout.get("line-elevation-reference"),I=n.layout.get("line-width-unit")==="meters",A=E==="sea",R=l.context,D=R.gl;if(n.hasElevatedBuckets&&l.transform.projection.name==="globe")return;const F=n.layout.get("line-cross-slope"),q=F!==void 0,U=F<1,H=l.colorModeForDrapableLayerRenderPass(_),Z=l.terrain&&l.terrain.renderingToTexture,J=Z?1:s.q.devicePixelRatio,re=n.paint.get("line-dasharray"),ne=re.constantOr(1),de=n.layout.get("line-cap"),le=re.constantOr(null),he=de.constantOr(null),ae=n.paint.get("line-pattern"),ge=ae.constantOr(1),Te=ae.constantOr(null),Ue=n.paint.get("line-opacity").constantOr(1);let Le=!ge&&Ue!==1||l.depthOcclusion&&b>0&&b<1;const He=n.paint.get("line-gradient"),Ze=ge?"linePattern":"line",ze=s.c_(n);let je;if(Z&&l.terrain&&l.terrain.clipOrMaskOverlapStencilType()&&(Le=!1),b!==0&&l.depthOcclusion){const Ce=n.paint._values["line-opacity"];Ce&&Ce.value&&Ce.value.kind==="constant"?je=Ce.value:s.w(`Occlusion opacity for layer ${n.id} is supported only when line-opacity isn't data-driven.`)}p.value.kind!=="constant"&&p.value.isLineProgressConstant===!1&&ze.push("VARIABLE_LINE_WIDTH");const it=(Ce,Ye,Ge,ut,Je)=>{for(const Xe of Ce){const nt=t.getTile(Xe);if(ge&&!nt.patternsLoaded())continue;const lt=nt.getBucket(n);if(!lt||lt.hasZOffset&&!Je||!lt.hasZOffset&&Je)continue;l.prepareDrawTile();const bt=lt.programConfigurations.get(n.id),Et=l.isTileAffectedByFog(Xe),$t=l.getOrCreateProgram(Ze,{config:bt,defines:Ye,overrideFog:Et,overrideRtt:!Je&&void 0});if(Te&&nt.imageAtlas){const Qt=s.A.from(Te).getPrimary().scaleSelf(J).serialize(),xi=nt.imageAtlas.patternPositions[Qt];xi&&bt.setConstantPatternPositions(xi)}if(!ge&&le&&he&&nt.lineAtlas){const Qt=nt.lineAtlas.getDash(le,he);Qt&&bt.setConstantPatternPositions(Qt)}let[kt,Bt]=n.paint.get("line-trim-offset");(he==="round"||he==="square")&&kt!==Bt&&(kt===0&&(kt-=1),Bt===1&&(Bt+=1));const Yt=Z?Xe.projMatrix:null,fi=I?1/lt.tileToMeter/s.ar(nt,1,l.transform.zoom):1,zi=I?1/lt.tileToMeter/s.ar(nt,1,Math.floor(l.transform.zoom)):1,Qi=ge?s.c$(l,nt,n,Yt,J,fi,zi,[kt,Bt]):s.d0(l,nt,n,Yt,lt.lineClipsArray.length,J,fi,zi,[kt,Bt]);if(He){const Qt=lt.gradients[n.id];let xi=Qt.texture;if(n.gradientVersion!==Qt.version){let Lt=256;if(n.stepInterpolant){const hi=t.getSource().maxzoom,Ei=Xe.canonical.z===hi?Math.ceil(1<<l.transform.maxZoom-Xe.canonical.z):1;Lt=s.aw(s.d1(lt.maxLineLength/s.ag*1024*Ei),256,R.maxTextureSize)}Qt.gradient=s.d2({expression:n.gradientExpression(),evaluationKey:"lineProgress",resolution:Lt,image:Qt.gradient||void 0,clips:lt.lineClipsArray}),Qt.texture?Qt.texture.update(Qt.gradient):Qt.texture=new s.T(R,Qt.gradient,D.RGBA8),Qt.version=n.gradientVersion,xi=Qt.texture}R.activeTexture.set(D.TEXTURE1),xi.bind(n.stepInterpolant?D.NEAREST:D.LINEAR,D.CLAMP_TO_EDGE)}ne&&(R.activeTexture.set(D.TEXTURE0),nt.lineAtlasTexture&&nt.lineAtlasTexture.bind(D.LINEAR,D.REPEAT),bt.updatePaintBuffers()),ge&&(R.activeTexture.set(D.TEXTURE0),nt.imageAtlasTexture&&nt.imageAtlasTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE),bt.updatePaintBuffers()),Je&&!A&&l.terrain.setupElevationDraw(nt,$t),l.uploadCommonUniforms(R,$t,Xe.toUnwrapped());const ji=Qt=>{je!=null&&(je.value=Ue*b),$t.draw(l,D.TRIANGLES,Ge,Qt,H,Xt.disabled,Qi,n.id,lt.layoutVertexBuffer,lt.indexBuffer,lt.segments,n.paint,l.transform.zoom,bt,[lt.layoutVertexBuffer2,lt.patternVertexBuffer,lt.zOffsetVertexBuffer]),je!=null&&(je.value=Ue)};if(Le&&!Je){const Qt=l.stencilModeForClipping(Xe).ref;Qt===0&&Z&&R.clear({stencil:0});const xi={func:D.EQUAL,mask:255};Qi.u_alpha_discard_threshold=.8,ji(new Ht(xi,Qt,255,D.KEEP,D.KEEP,D.INVERT)),Qi.u_alpha_discard_threshold=0,ji(new Ht(xi,Qt,255,D.KEEP,D.KEEP,D.KEEP))}else Le&&Je&&(Qi.u_alpha_discard_threshold=.001),ji(Je?ut:l.stencilModeForClipping(Xe))}};if(n.hasNonElevatedBuckets){const Ce=!Z&&l.terrain;b!==0&&Ce?s.w(`Occlusion opacity for layer ${n.id} is supported on terrain only if the layer has line-z-offset enabled.`):Ce?s.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${n.id}.`):it(c,ze,l.depthModeForSublayer(0,Ft.ReadOnly),Ht.disabled,!1)}if(n.hasElevatedBuckets){ze.push("ELEVATED"),q&&ze.push(U?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),A&&ze.push("ELEVATION_REFERENCE_SEA");const Ce=Le?l.stencilModeFor3D():Ht.disabled,Ye=new Ft(l.depthOcclusion?D.GREATER:D.LEQUAL,Ft.ReadOnly,l.depthRangeFor3D);l.forceTerrainMode=!0,it(c,ze,Ye,Ce,!0),l.forceTerrainMode=!1}Le&&(l.resetStencilClippingMasks(),Z&&R.clear({stencil:0})),b===0||l.depthOcclusion||Z||l.layersWithOcclusionOpacity.push(l.currentLayer)},fill:function(l,t,n,c){const d=n.paint.get("fill-color"),p=n.paint.get("fill-opacity"),_=n.is3D(),b=new Ft(l.context.gl.LEQUAL,Ft.ReadWrite,l.depthRangeFor3D);if(p.constantOr(1)===0)return;const E=n.paint.get("fill-emissive-strength"),I=l.colorModeForDrapableLayerRenderPass(E),A=n.paint.get("fill-pattern"),R=l.opaquePassEnabledForLayer()&&!A.constantOr(1)&&d.constantOr(s.aj.transparent).a===1&&p.constantOr(0)===1?"opaque":"translucent";if(l.renderPass===R){const D=_?b:l.depthModeForSublayer(1,l.renderPass==="opaque"?Ft.ReadWrite:Ft.ReadOnly);Kh(l,t,n,c,D,I,!1)}if(!_&&l.renderPass==="translucent"&&n.paint.get("fill-antialias")){const D=_?b:l.depthModeForSublayer(n.getPaintProperty("fill-outline-color")?2:0,Ft.ReadOnly);Kh(l,t,n,c,D,I,!0)}},"fill-extrusion":function(l,t,n,c){const d=n.paint.get("fill-extrusion-opacity"),p=l.context,_=p.gl,b=l.terrain,E=b&&b.renderingToTexture;if(d===0)return;const I=l.conflationActive&&l.style.isLayerClipped(n,t.getSource()),A=l.style.order.indexOf(n.fqid);if(I&&function(R,D,F,q,U){for(const H of q){const Z=D.getTile(H).getBucket(F);Z&&(Z.updateReplacement(H,R.replacementSource,U),Z.uploadCentroid(R.context))}}(l,t,n,c,A),b||I)for(const R of c){const D=t.getTile(R).getBucket(n);D&&Ga(l.context,t,R,D,n,b,I)}if(l.renderPass==="shadow"&&l.shadowRenderer){const R=l.shadowRenderer;if(b&&d<.65&&n._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof s.a9)return;const D=R.getShadowPassDepthMode(),F=R.getShadowPassColorMode();ql(l,t,n,c,D,Ht.disabled,F,I)}else if(l.renderPass==="translucent"){const R=!n.paint.get("fill-extrusion-pattern").constantOr(1),D=n.paint.get("fill-extrusion-color").constantOr(s.aj.white);if(!E&&D.a!==0){const F=new Ft(l.context.gl.LEQUAL,Ft.ReadWrite,l.depthRangeFor3D);d===1&&R?ql(l,t,n,c,F,Ht.disabled,oi.unblended,I):(ql(l,t,n,c,F,Ht.disabled,oi.disabled,I),ql(l,t,n,c,F,l.stencilModeFor3D(),l.colorModeForRenderPass(),I),l.resetStencilClippingMasks())}if(l.style.enable3dLights()&&R&&(!b&&l.transform.projection.name!=="globe"||E)){const F=n.paint.get("fill-extrusion-opacity"),q=n.paint.get("fill-extrusion-ambient-occlusion-intensity"),U=n.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),H=n.paint.get("fill-extrusion-flood-light-intensity"),Z=n.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",J=n.paint.get("fill-extrusion-flood-light-color").toRenderColor(Z?null:n.lut).toArray01().slice(0,3),re=q>0&&U>0,ne=H>0,de=(he,ae,ge)=>(1-ge)*he+ge*ae,le=he=>{const ae=l.depthModeForSublayer(1,Ft.ReadOnly,_.LEQUAL,!0),ge=n.paint.get(he?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Te=de(.1,3,ge),Ue=l._showOverdrawInspector;if(!Ue){const Le=new Ht({func:_.ALWAYS,mask:255},255,255,_.KEEP,_.KEEP,_.REPLACE),He=new oi([_.ONE,_.ONE,_.ONE,_.ONE],s.aj.transparent,[!1,!1,!1,!0],_.MIN);ja(l,t,n,c,ae,Le,He,Xt.disabled,he,"sdf",F,q,U,H,J,Te,I,!1)}{const Le=Ue?Ht.disabled:new Ht({func:_.EQUAL,mask:255},255,255,_.KEEP,_.DECR,_.DECR),He=Ue?l.colorModeForRenderPass():new oi([_.ONE_MINUS_DST_ALPHA,_.DST_ALPHA,_.ONE,_.ONE],s.aj.transparent,[!0,!0,!0,!0]);ja(l,t,n,c,ae,Le,He,Xt.disabled,he,"color",F,q,U,H,J,Te,I,!1)}};if(E){const he=(ae,ge,Te)=>{const Ue=l.depthModeForSublayer(1,Ft.ReadOnly,_.LEQUAL,!1),Le=n.paint.get(ae?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),He=de(.1,3,Le);{const Ze=new oi([_.ONE,_.ONE,_.ONE,_.ONE],s.aj.transparent,[!1,!1,!1,!0]);ja(l,t,n,c,Ue,Ht.disabled,Ze,Xt.disabled,ae,"clear",F,q,U,H,J,He,I,ge)}{const Ze=new Ht({func:_.ALWAYS,mask:255},255,255,_.KEEP,_.KEEP,_.REPLACE),ze=new oi([_.ONE,_.ONE,_.ONE,_.ONE],s.aj.transparent,[!1,!1,!1,!0],_.MIN);ja(l,t,n,c,Ue,Ze,ze,Xt.disabled,ae,"sdf",F,q,U,H,J,He,I,ge)}{const Ze=ae?_.ZERO:_.ONE_MINUS_DST_ALPHA,ze=new Ht({func:_.EQUAL,mask:255},255,255,_.KEEP,_.DECR,_.DECR),je=new oi([Ze,_.DST_ALPHA,_.ONE_MINUS_DST_ALPHA,_.ZERO],s.aj.transparent,[!0,!0,!0,!0]);ja(l,t,n,c,Ue,ze,je,Xt.disabled,ae,"color",F,q,U,H,J,He,I,ge)}{const Ze=new oi([_.ONE,_.ONE,_.ONE,ae?_.ZERO:_.ONE],s.aj.transparent,[!1,!1,!1,!0],ae?_.FUNC_ADD:_.MAX);ja(l,t,n,c,Ue,Ht.disabled,Ze,Xt.disabled,ae,"clear",F,q,U,H,J,He,I,ge,Te)}};if(re||ne){let ae;if(l.prepareDrawTile(),b){const ge=b.drapeBufferSize[0],Te=b.drapeBufferSize[1];ae=b.framebufferCopyTexture,ae&&(!ae||ae.size[0]===ge&&ae.size[1]===Te)||(ae&&ae.destroy(),ae=b.framebufferCopyTexture=new s.T(p,new s.r({width:ge,height:Te}),_.RGBA8)),ae.bind(_.LINEAR,_.CLAMP_TO_EDGE),_.copyTexSubImage2D(_.TEXTURE_2D,0,0,0,0,0,ge,Te)}re&&he(!0,!1,ae),ne&&he(!1,!0,ae)}}else re&&le(!0),ne&&le(!1),(re||ne)&&l.resetStencilClippingMasks()}}},hillshade:function(l,t,n,c){if(l.renderPass!=="offscreen"&&l.renderPass!=="translucent"||l.style.disableElevatedTerrain)return;const d=l.context,p=l.terrain&&l.terrain.renderingToTexture,[_,b]=l.renderPass!=="translucent"||p?[{},c]:l.stencilConfigForOverlap(c);for(const E of b){const I=t.getTile(E);if(I.needsHillshadePrepare&&l.renderPass==="offscreen")e_(l,I,n);else if(l.renderPass==="translucent"){const A=l.depthModeForSublayer(0,Ft.ReadOnly),R=n.paint.get("hillshade-emissive-strength"),D=l.colorModeForDrapableLayerRenderPass(R),F=p&&l.terrain?l.terrain.stencilModeForRTTOverlap(E):_[E.overscaledZ];Af(l,E,I,n,A,F,D)}}d.viewport.set([0,0,l.width,l.height]),l.resetStencilClippingMasks()},raster:function(l,t,n,c,d,p){if(l.renderPass!=="translucent"||n.paint.get("raster-opacity")===0)return;const _=l.transform.projection.name==="globe",b=n.paint.get("raster-elevation")!==0,E=b&&_;if(l.renderElevatedRasterBackface&&!E)return;const I=l.context,A=I.gl,R=t.getSource(),D=function(le,he,ae,ge){const Te=he.paint.get("raster-color"),Ue=le.type==="raster-array",Le=[],He=he.paint.get("raster-resampling"),Ze=he.paint.get("raster-color-mix");let ze=he.paint.get("raster-color-range");const je=[Ze[0],Ze[1],Ze[2],0],it=Ze[3];let Ce=He==="nearest"?ge.NEAREST:ge.LINEAR;if(Ue&&(Le.push("RASTER_ARRAY"),Te||Le.push("RASTER_COLOR"),He==="linear"&&Le.push("RASTER_ARRAY_LINEAR"),Ce=ge.NEAREST,!ze&&le.rasterLayers)){const Ye=le.rasterLayers.find(({id:Ge})=>Ge===he.sourceLayer);Ye&&Ye.fields&&Ye.fields.range&&(ze=Ye.fields.range)}if(ze=ze||[0,1],Te){Le.push("RASTER_COLOR"),ae.activeTexture.set(ge.TEXTURE2),he.updateColorRamp(ze);let Ye=he.colorRampTexture;Ye||(Ye=he.colorRampTexture=new s.T(ae,he.colorRamp,ge.RGBA8)),Ye.bind(ge.LINEAR,ge.CLAMP_TO_EDGE)}return{mix:je,range:ze,offset:it,defines:Le,resampling:Ce}}(R,n,I,A);if(R instanceof s.aJ&&!c.length&&!_)return;const F=n.paint.get("raster-emissive-strength"),q=l.colorModeForDrapableLayerRenderPass(F),U=l.terrain&&l.terrain.renderingToTexture,H=!l.options.moving,Z=n.paint.get("raster-resampling")==="nearest"?A.NEAREST:A.LINEAR;if(R instanceof s.aJ&&!c.length&&(R.onNorthPole||R.onSouthPole)){const le=b?l.stencilModeFor3D():Ht.disabled;return void ke(!!R.onNorthPole,null,l,t,n,F,D,Xt.disabled,le)}if(!c.length)return;const[J,re]=R instanceof s.aJ||U?[{},c]:l.stencilConfigForOverlap(c),ne=re[re.length-1].overscaledZ;E&&D.defines.push("PROJECTION_GLOBE_VIEW"),b&&D.defines.push("RENDER_CUTOFF");const de=(le,he,ae)=>{for(const ge of le){const Te=ge.toUnwrapped(),Ue=t.getTile(ge);if(U&&(!Ue||!Ue.hasData()))continue;I.activeTexture.set(A.TEXTURE0);const Le=hu(Ue,R,n,D);if(!Le||!Le.texture)continue;const{texture:He,mix:Ze,offset:ze,tileSize:je,buffer:it}=Le;let Ce,Ye;U?(Ce=Ft.disabled,Ye=ge.projMatrix):b?(Ce=new Ft(A.LEQUAL,Ft.ReadWrite,l.depthRangeFor3D),Ye=_?Float32Array.from(l.transform.expandedFarZProjMatrix):l.transform.calculateProjMatrix(Te,H)):(Ce=l.depthModeForSublayer(ge.overscaledZ-ne,n.paint.get("raster-opacity")===1?Ft.ReadWrite:Ft.ReadOnly,A.LESS),Ye=l.transform.calculateProjMatrix(Te,H));const Ge=l.terrain&&U?l.terrain.stencilModeForRTTOverlap(ge):J[ge.overscaledZ],ut=p?0:n.paint.get("raster-fade-duration");Ue.registerFadeDuration(ut);const Je=t.findLoadedParent(ge,0),Xe=Fl(Ue,Je,t,l.transform,ut);let nt,lt;l.terrain&&l.terrain.prepareDrawTile(),I.activeTexture.set(A.TEXTURE0),He.bind(Z,A.CLAMP_TO_EDGE),I.activeTexture.set(A.TEXTURE1),Je?(Je.texture&&Je.texture.bind(Z,A.CLAMP_TO_EDGE),nt=Math.pow(2,Je.tileID.overscaledZ-Ue.tileID.overscaledZ),lt=[Ue.tileID.canonical.x*nt%1,Ue.tileID.canonical.y*nt%1]):He.bind(Z,A.CLAMP_TO_EDGE),He.useMipmap&&I.extTextureFilterAnisotropic&&l.transform.pitch>20&&A.texParameterf(A.TEXTURE_2D,I.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,I.extTextureFilterAnisotropicMax);const bt=l.transform;let Et;const $t=b?Gf(bt):[0,0,0,0];let kt,Bt,Yt,fi,zi,Qi=0;if(E&&R instanceof s.aJ&&R.coordinates.length>3)kt=Float32Array.from(s.bb(s.cH(new s.bT(0,0,0)))),Bt=Float32Array.from(bt.globeMatrix),Yt=Float32Array.from(s.cD(bt)),fi=[s.at(bt.center.lng),s.aA(bt.center.lat)],Et=R.elevatedGlobePerspectiveTransform,zi=R.elevatedGlobeGridMatrix||new Float32Array(9);else if(E){const Lt=s.cE(ge.canonical);Qi=s.cF(Lt.getCenter().lat),kt=Float32Array.from(s.bb(s.cH(ge.canonical))),Bt=Float32Array.from(bt.globeMatrix),Yt=Float32Array.from(s.cD(bt)),fi=[s.at(bt.center.lng),s.aA(bt.center.lat)],Et=[0,0],zi=Float32Array.from(s.cG(ge.canonical,Lt,Qi,bt.worldSize/bt._pixelsPerMercatorPixel))}else Et=R instanceof s.aJ?R.perspectiveTransform:[0,0],kt=new Float32Array(16),Bt=new Float32Array(9),Yt=new Float32Array(16),fi=[0,0],zi=new Float32Array(9);const ji=_o(Ye,kt,Bt,Yt,zi,lt||[0,0],s.ae(l.transform.zoom),fi,$t,nt||1,Xe,n,Et,b?n.paint.get("raster-elevation"):0,2,Ze,ze,D.range,je,it,F),Qt=l.isTileAffectedByFog(ge),xi=l.getOrCreateProgram("raster",{defines:D.defines,overrideFog:Qt});if(l.uploadCommonUniforms(I,xi,Te),R instanceof s.aJ){const Lt=R.elevatedGlobeVertexBuffer,hi=R.elevatedGlobeIndexBuffer;if(U||!_)R.boundsBuffer&&R.boundsSegments&&xi.draw(l,A.TRIANGLES,Ce,Ht.disabled,q,Xt.disabled,ji,n.id,R.boundsBuffer,l.quadTriangleIndexBuffer,R.boundsSegments);else if(Lt&&hi){const Ei=bt.zoom<=s.c6?R.elevatedGlobeSegments:R.getSegmentsForLongitude(bt.center.lng);Ei&&xi.draw(l,A.TRIANGLES,Ce,Ht.disabled,q,he,ji,n.id,Lt,hi,Ei)}}else if(E){Ce=new Ft(A.LEQUAL,Ft.ReadOnly,l.depthRangeFor3D);const Lt=l.globeSharedBuffers;if(Lt){const[hi,Ei,Ai]=Lt.getGridBuffers(Qi,!1);xi.draw(l,A.TRIANGLES,Ce,ae||Ge,l.colorModeForRenderPass(),he,ji,n.id,hi,Ei,Ai)}}else{const{tileBoundsBuffer:Lt,tileBoundsIndexBuffer:hi,tileBoundsSegments:Ei}=l.getTileBoundsBuffers(Ue);xi.draw(l,A.TRIANGLES,Ce,Ge,q,Xt.disabled,ji,n.id,Lt,hi,Ei)}}if(!(R instanceof s.aJ)&&E)for(const ge of le){const Te=ge.canonical.y===(1<<ge.canonical.z)-1;ge.canonical.y===0&&ke(!0,ge,l,t,n,F,D,he,ae||Ht.disabled),Te&&ke(!1,ge,l,t,n,F,D,he===Xt.frontCW?Xt.backCW:Xt.frontCW,ae||Ht.disabled)}};E?de(re,l.renderElevatedRasterBackface?Xt.backCW:Xt.frontCW,l.stencilModeFor3D()):de(re,Xt.disabled,void 0),l.resetStencilClippingMasks()},"raster-particle":function(l,t,n,c,d,p){l.renderPass==="offscreen"&&function(_,b,E,I){if(!I.length)return;const A=_.context,R=A.gl,D=b.getSource();if(!(D instanceof In))return;const F=Math.ceil(Math.sqrt(E.paint.get("raster-particle-count")));let q=E.particlePositionRGBAImage;if(!q||q.width!==F){const re=function(ne){const de=ne*ne,le=new Uint8Array(4*de),he=function(ge){return ge|=0,ge=Math.imul(2747636419^ge,2654435769),ge=Math.imul(ge^ge>>>16,2654435769),((ge=Math.imul(ge^ge>>>16,2654435769))>>>0)/4294967296},ae=1/1.1;for(let ge=0;ge<de;ge++){const Te=ae*(he(2*ge+0)+Dt),Ue=ae*(he(2*ge+1)+Dt),Le=255*Te%1,He=255*Ue%1,Ze=Le,ze=Ue-He/255,je=He;le[4*ge+0]=255*(Te-Le/255),le[4*ge+1]=255*Ze,le[4*ge+2]=255*ze,le[4*ge+3]=255*je}return le}(F);q=E.particlePositionRGBAImage=new s.r({width:F,height:F},re)}let U=E.particleFramebuffer;U?U.width!==F&&(U.destroy(),U=E.particleFramebuffer=A.createFramebuffer(F,F,!0,null)):U=E.particleFramebuffer=A.createFramebuffer(F,F,!0,null);const H=[];for(const re of I){const ne=b.getTile(re);if(!(ne instanceof uo))continue;const de=$f(ne,D,E);if(!de)continue;const le=[ne.tileSize,ne.tileSize];let he=E.tileFramebuffer;he||(he=E.tileFramebuffer=A.createFramebuffer(le[0],le[1],!0,null));let ae=ne.rasterParticleState;ae||(ae=ne.rasterParticleState=new qf(A,re,le,q));const ge=ae.update(E.lastInvalidatedAt);ae.particleTextureDimension!==F&&ae.updateParticleTexture(re,q);const Te=ae.targetColorTexture;ae.targetColorTexture=ae.backgroundColorTexture,ae.backgroundColorTexture=Te;const Ue=ae.particleTexture0;ae.particleTexture0=ae.particleTexture1,ae.particleTexture1=Ue,H.push([re,de,ae,ge])}if(H.length===0)return;const Z=s.q.now(),J=E.previousDrawTimestamp?.001*(Z-E.previousDrawTimestamp):.0167;if(E.previousDrawTimestamp=Z,E.hasColorMap()){A.activeTexture.set(R.TEXTURE0+2);let re=E.colorRampTexture;re||(re=E.colorRampTexture=new s.T(A,E.colorRamp,R.RGBA8)),re.bind(R.LINEAR,R.CLAMP_TO_EDGE)}A.bindFramebuffer.set(E.tileFramebuffer.framebuffer),function(re,ne,de){const le=re.context,he=le.gl,ae=ne.tileFramebuffer;le.activeTexture.set(he.TEXTURE0);const ge={u_texture:0,u_opacity:1.05*(Ue=ne.paint.get("raster-particle-fade-opacity-factor"))/(Ue+.05)},Te=re.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Ue;for(const Le of de){const[,,He,Ze]=Le;ae.colorAttachment.set(He.targetColorTexture.texture),le.viewport.set([0,0,ae.width,ae.height]),le.clear({color:s.aj.transparent}),Ze&&(He.backgroundColorTexture.bind(he.NEAREST,he.CLAMP_TO_EDGE),Te.draw(re,he.TRIANGLES,Ft.disabled,Ht.disabled,oi.alphaBlended,Xt.disabled,ge,ne.id,re.viewportBuffer,re.quadTriangleIndexBuffer,re.viewportSegments))}}(_,E,H),function(re,ne,de,le){const he=re.context,ae=he.gl,ge=de.tileFramebuffer,Te=re.transform.projection.name==="globe",Ue=de.paint.get("raster-particle-max-speed");for(const Le of le){const[He,Ze,ze]=Le;he.activeTexture.set(ae.TEXTURE0+0),Ze.texture.bind(ae.LINEAR,ae.CLAMP_TO_EDGE),ge.colorAttachment.set(ze.targetColorTexture.texture);const je=re.getOrCreateProgram("rasterParticleDraw",{defines:Ze.defines,overrideFog:!1});he.activeTexture.set(ae.TEXTURE0+1);const it=Ze.scalarData?[]:[0,1,2,3].map(Ge=>s.d4[Ge](He));it.push(He);const Ce=He.canonical.x,Ye=He.canonical.y;for(const Ge of it){const ut=ne.getTile(Te?Ge.wrapped():Ge);if(!ut)continue;const Je=ut.rasterParticleState;if(!Je)continue;const Xe=Ge.canonical.x+(1<<Ge.canonical.z)*(Ge.wrap-He.wrap),nt=Ge.canonical.y;Je.particleTexture0.bind(ae.NEAREST,ae.CLAMP_TO_EDGE);const lt=d_(1,Je.particleTexture0.size[0],[Xe-Ce,nt-Ye],0,Ze.texture.size,2,Ue,Ze.textureOffset,Ze.scale,Ze.offset);je.draw(re,ae.POINTS,Ft.disabled,Ht.disabled,oi.alphaBlended,Xt.disabled,lt,de.id,Je.particleIndexBuffer,void 0,Je.particleSegment)}}}(_,b,E,H),A.bindFramebuffer.set(E.particleFramebuffer.framebuffer),function(re,ne,de,le){const he=re.context,ae=he.gl,ge=ne.paint.get("raster-particle-max-speed"),Te=le*ne.paint.get("raster-particle-speed-factor")*.15,Ue=function(He){return Math.pow(He,6)}(.01+1*ne.paint.get("raster-particle-reset-rate-factor")),Le=ne.particleFramebuffer;he.viewport.set([0,0,Le.width,Le.height]);for(const He of de){const[,Ze,ze]=He;he.activeTexture.set(ae.TEXTURE0+0),Ze.texture.bind(ae.LINEAR,ae.CLAMP_TO_EDGE),he.activeTexture.set(ae.TEXTURE0+1);const je=ze.particleTexture0;je.bind(ae.NEAREST,ae.CLAMP_TO_EDGE);const it=f_(1,je.size[0],0,Ze.texture.size,ge,Te,Ue,Ze.textureOffset,Ze.scale,Ze.offset);Le.colorAttachment.set(ze.particleTexture1.texture),he.clear({color:s.aj.transparent}),re.getOrCreateProgram("rasterParticleUpdate",{defines:Ze.defines}).draw(re,ae.TRIANGLES,Ft.disabled,Ht.disabled,oi.unblended,Xt.disabled,it,ne.id,re.viewportBuffer,re.quadTriangleIndexBuffer,re.viewportSegments)}}(_,E,H,J)}(l,t,n,c),l.renderPass==="translucent"&&(function(_,b,E,I,A){const R=_.context,D=R.gl,F=b.getSource().tileSize,q=5*(1-s.ac(s.bY,s.bY+1,_.transform.zoom))*F+E.paint.get("raster-particle-elevation"),U=!_.options.moving,H=_.transform.projection.name==="globe";if(!I.length)return;const[Z,J]=_.stencilConfigForOverlap(I),re=[];H&&re.push("PROJECTION_GLOBE_VIEW");const ne=_.stencilModeFor3D();for(const de of J){const le=de.toUnwrapped(),he=b.getTile(de);if(!he.rasterParticleState)continue;const ae=he.rasterParticleState,ge=100;he.registerFadeDuration(ge);const Te=b.findLoadedParent(de,0),Ue=Fl(he,Te,b,_.transform,ge);let Le,He;_.terrain&&_.terrain.prepareDrawTile(),R.activeTexture.set(D.TEXTURE0),ae.targetColorTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE),R.activeTexture.set(D.TEXTURE1),Te&&Te.rasterParticleState?(Te.rasterParticleState.targetColorTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE),Le=Math.pow(2,Te.tileID.overscaledZ-he.tileID.overscaledZ),He=[he.tileID.canonical.x*Le%1,he.tileID.canonical.y*Le%1]):ae.targetColorTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE);const Ze=H?Float32Array.from(_.transform.expandedFarZProjMatrix):_.transform.calculateProjMatrix(le,U),ze=_.transform,je=Zf(ze),it=s.cE(de.canonical),Ce=s.cF(it.getCenter().lat);let Ye,Ge,ut,Je,Xe;H?(Ye=Float32Array.from(s.bb(s.cH(de.canonical))),Ge=Float32Array.from(ze.globeMatrix),ut=Float32Array.from(s.cD(ze)),Je=[s.at(ze.center.lng),s.aA(ze.center.lat)],Xe=Float32Array.from(s.cG(de.canonical,it,Ce,ze.worldSize/ze._pixelsPerMercatorPixel))):(Ye=new Float32Array(16),Ge=new Float32Array(9),ut=new Float32Array(16),Je=[0,0],Xe=new Float32Array(9));const nt=qh(Ze,Ye,Ge,ut,Xe,He||[0,0],s.ae(_.transform.zoom),Je,je,Le||1,Ue,q),lt=_.isTileAffectedByFog(de),bt=_.getOrCreateProgram("rasterParticle",{defines:re,overrideFog:lt});if(_.uploadCommonUniforms(R,bt,le),H){const Et=new Ft(D.LEQUAL,Ft.ReadOnly,_.depthRangeFor3D),$t=0,kt=_.globeSharedBuffers;if(kt){const[Bt,Yt,fi]=kt.getGridBuffers(Ce,$t!==0);bt.draw(_,D.TRIANGLES,Et,ne,oi.alphaBlended,_.renderElevatedRasterBackface?Xt.frontCCW:Xt.backCCW,nt,E.id,Bt,Yt,fi)}}else{const Et=_.depthModeForSublayer(0,Ft.ReadOnly),$t=Z[de.overscaledZ],{tileBoundsBuffer:kt,tileBoundsIndexBuffer:Bt,tileBoundsSegments:Yt}=_.getTileBoundsBuffers(he);bt.draw(_,D.TRIANGLES,Et,$t,oi.alphaBlended,Xt.disabled,nt,E.id,kt,Bt,Yt)}}_.resetStencilClippingMasks()}(l,t,n,c),l.style.map.triggerRepaint())},background:function(l,t,n,c){const d=n.paint.get("background-color"),p=n.paint.get("background-color-use-theme").constantOr("default")==="none",_=n.paint.get("background-opacity"),b=n.paint.get("background-emissive-strength"),E=n.paint.get("background-pitch-alignment")==="viewport";if(_===0)return;const I=l.context,A=I.gl,R=l.transform,D=R.tileSize,F=n.paint.get("background-pattern");let q;if(F!==void 0&&(F===null||(q=l.imageManager.getPattern(F.toString(),n.scope,l.style.getLut(n.scope)),!q)))return;const U=!F&&d.a===1&&_===1&&l.opaquePassEnabledForLayer()?"opaque":"translucent";if(l.renderPass!==U)return;const H=Ht.disabled,Z=l.depthModeForSublayer(0,U==="opaque"?Ft.ReadWrite:Ft.ReadOnly),J=l.colorModeForDrapableLayerRenderPass(b),re=F?"backgroundPattern":"background";let ne,de=c;if(de||(ne=l.getBackgroundTiles(),de=Object.values(ne).map(le=>le.tileID)),F&&(I.activeTexture.set(A.TEXTURE0),l.imageManager.bind(l.context,n.scope)),E){const le=l.getOrCreateProgram(re,{overrideFog:!1,overrideRtt:!0}),he=new Float32Array(s.ab.mat4.identity([])),ae=new s.aG(0,0,0,0,0),ge=F?jf(he,b,_,l,0,n.scope,q,E,{tileID:ae,tileSize:D}):Zh(he,b,_,d.toRenderColor(p?null:n.lut));le.draw(l,A.TRIANGLES,Z,H,J,Xt.disabled,ge,n.id,l.viewportBuffer,l.quadTriangleIndexBuffer,l.viewportSegments)}else for(const le of de){const he=l.isTileAffectedByFog(le),ae=l.getOrCreateProgram(re,{overrideFog:he}),ge=le.toUnwrapped(),Te=c?le.projMatrix:l.transform.calculateProjMatrix(ge);l.prepareDrawTile();const Ue=t?t.getTile(le):ne?ne[le.key]:new co(le,D,R.zoom,l),Le=F?jf(Te,b,_,l,0,n.scope,q,E,{tileID:le,tileSize:D}):Zh(Te,b,_,d.toRenderColor(p?null:n.lut));l.uploadCommonUniforms(I,ae,ge);const{tileBoundsBuffer:He,tileBoundsIndexBuffer:Ze,tileBoundsSegments:ze}=l.getTileBoundsBuffers(Ue);ae.draw(l,A.TRIANGLES,Z,H,J,Xt.disabled,Le,n.id,He,Ze,ze)}},sky:function(l,t,n){const c=l._atmosphere?s.ae(l.transform.zoom):1,d=n.paint.get("sky-opacity")*c;if(d===0)return;const p=l.context,_=n.paint.get("sky-type"),b=new Ft(p.gl.LEQUAL,Ft.ReadOnly,[0,1]),E=l.frameCounter/1e3%1;_==="atmosphere"?l.renderPass==="offscreen"?n.needsSkyboxCapture(l)&&(function(I,A,R,D){const F=I.context,q=F.gl;let U=A.skyboxFbo;if(!U){U=A.skyboxFbo=F.createFramebuffer(32,32,!0,null),A.skyboxGeometry=new Wf(F),A.skyboxTexture=F.gl.createTexture(),q.bindTexture(q.TEXTURE_CUBE_MAP,A.skyboxTexture),q.texParameteri(q.TEXTURE_CUBE_MAP,q.TEXTURE_WRAP_S,q.CLAMP_TO_EDGE),q.texParameteri(q.TEXTURE_CUBE_MAP,q.TEXTURE_WRAP_T,q.CLAMP_TO_EDGE),q.texParameteri(q.TEXTURE_CUBE_MAP,q.TEXTURE_MIN_FILTER,q.LINEAR),q.texParameteri(q.TEXTURE_CUBE_MAP,q.TEXTURE_MAG_FILTER,q.LINEAR);for(let re=0;re<6;++re)q.texImage2D(q.TEXTURE_CUBE_MAP_POSITIVE_X+re,0,q.RGBA,32,32,0,q.RGBA,q.UNSIGNED_BYTE,null)}F.bindFramebuffer.set(U.framebuffer),F.viewport.set([0,0,32,32]);const H=A.getCenter(I,!0),Z=I.getOrCreateProgram("skyboxCapture"),J=new Float64Array(16);s.ab.mat4.identity(J),s.ab.mat4.rotateY(J,J,.5*-Math.PI),kn(I,A,Z,J,H,0),s.ab.mat4.identity(J),s.ab.mat4.rotateY(J,J,.5*Math.PI),kn(I,A,Z,J,H,1),s.ab.mat4.identity(J),s.ab.mat4.rotateX(J,J,.5*-Math.PI),kn(I,A,Z,J,H,2),s.ab.mat4.identity(J),s.ab.mat4.rotateX(J,J,.5*Math.PI),kn(I,A,Z,J,H,3),s.ab.mat4.identity(J),kn(I,A,Z,J,H,4),s.ab.mat4.identity(J),s.ab.mat4.rotateY(J,J,Math.PI),kn(I,A,Z,J,H,5),F.viewport.set([0,0,I.width,I.height])}(l,n),n.markSkyboxValid(l)):l.renderPass==="sky"&&function(I,A,R,D,F){const q=I.context,U=q.gl,H=I.transform,Z=I.getOrCreateProgram("skybox");q.activeTexture.set(U.TEXTURE0),U.bindTexture(U.TEXTURE_CUBE_MAP,A.skyboxTexture);const J=((re,ne,de,le,he)=>({u_matrix:re,u_sun_direction:ne,u_cubemap:0,u_opacity:le,u_temporal_offset:he}))(H.skyboxMatrix,A.getCenter(I,!1),0,D,F);I.uploadCommonUniforms(q,Z),Z.draw(I,U.TRIANGLES,R,Ht.disabled,I.colorModeForRenderPass(),Xt.backCW,J,"skybox",A.skyboxGeometry.vertexBuffer,A.skyboxGeometry.indexBuffer,A.skyboxGeometry.segment)}(l,n,b,d,E):_==="gradient"&&l.renderPass==="sky"&&function(I,A,R,D,F){const q=I.context,U=q.gl,H=I.transform,Z=I.getOrCreateProgram("skyboxGradient");A.skyboxGeometry||(A.skyboxGeometry=new Wf(q)),q.activeTexture.set(U.TEXTURE0);let J=A.colorRampTexture;J||(J=A.colorRampTexture=new s.T(q,A.colorRamp,U.RGBA8)),J.bind(U.LINEAR,U.CLAMP_TO_EDGE);const re=((ne,de,le,he,ae)=>({u_matrix:ne,u_color_ramp:0,u_center_direction:de,u_radius:s.ai(le),u_opacity:he,u_temporal_offset:ae}))(H.skyboxMatrix,A.getCenter(I,!1),A.paint.get("sky-gradient-radius"),D,F);I.uploadCommonUniforms(q,Z),Z.draw(I,U.TRIANGLES,R,Ht.disabled,I.colorModeForRenderPass(),Xt.backCW,re,"skyboxGradient",A.skyboxGeometry.vertexBuffer,A.skyboxGeometry.indexBuffer,A.skyboxGeometry.segment)}(l,n,b,d,E)},debug:function(l,t,n,c,d,p){for(let _=0;_<n.length;_++)if(d){const I=new s.aj(c.r*.8,c.g*.8,c.b*.8,1);yo(l,t,n[_],c,-1,-1,p),yo(l,t,n[_],c,-1,1,p),yo(l,t,n[_],c,1,1,p),yo(l,t,n[_],c,1,-1,p),yo(l,t,n[_],I,0,0,p)}else yo(l,t,n[_],c,0,0,p)},custom:function(l,t,n,c){const d=l.context,p=n.implementation;if(!l.transform.projection.unsupportedLayers||!l.transform.projection.unsupportedLayers.includes("custom")||l.terrain&&(l.terrain.renderingToTexture||l.renderPass==="offscreen")&&n.isDraped(t)){if(l.renderPass==="offscreen"){const _=p.prerender;if(_){if(l.setCustomLayerDefaults(),d.setColorMode(l.colorModeForRenderPass()),l.transform.projection.name==="globe"){const b=l.transform.pointMerc;_.call(p,d.gl,l.transform.customLayerMatrix(),l.transform.getProjection(),l.transform.globeToMercatorMatrix(),s.ae(l.transform.zoom),[b.x,b.y],l.transform.pixelsPerMeterRatio)}else _.call(p,d.gl,l.transform.customLayerMatrix());d.setDirty(),l.setBaseState()}}else if(l.renderPass==="translucent"){if(l.terrain&&l.terrain.renderingToTexture){const b=p.renderToTile;if(b){const E=c[0].canonical,I=new s.aa(E.x+c[0].wrap*(1<<E.z),E.y,E.z);d.setDepthMode(Ft.disabled),d.setStencilMode(Ht.disabled),d.setColorMode(l.colorModeForRenderPass()),l.setCustomLayerDefaults(),b.call(p,d.gl,I),d.setDirty(),l.setBaseState()}return}l.setCustomLayerDefaults(),d.setColorMode(l.colorModeForRenderPass()),d.setStencilMode(Ht.disabled);const _=p.renderingMode==="3d"?new Ft(l.context.gl.LEQUAL,Ft.ReadWrite,l.depthRangeFor3D):l.depthModeForSublayer(0,Ft.ReadOnly);if(d.setDepthMode(_),l.transform.projection.name==="globe"){const b=l.transform.pointMerc;p.render(d.gl,l.transform.customLayerMatrix(),l.transform.getProjection(),l.transform.globeToMercatorMatrix(),s.ae(l.transform.zoom),[b.x,b.y],l.transform.pixelsPerMeterRatio)}else p.render(d.gl,l.transform.customLayerMatrix());d.setDirty(),l.setBaseState(),d.bindFramebuffer.set(null)}}else s.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(l,t,n,c){if(l.renderPass==="opaque")return;const d=n.paint.get("model-opacity").constantOr(1);if(d===0)return;const p=n.paint.get("model-cast-shadows");if(l.renderPass==="shadow"&&(!p||l.terrain&&d<.65&&n._transitionablePaint._values["model-opacity"].value.expression instanceof s.a9))return;const _=l.shadowRenderer,b=n.paint.get("model-receive-shadows");_&&(_.useNormalOffset=!0,b||(_.enabled=!1));const E=()=>{_&&(_.useNormalOffset=!0,b||(_.enabled=!0))},I=t.getSource();if(l.renderPass==="light-beam"&&I.type!=="batched-model")return;if(I.type==="vector"||I.type==="geojson")return function(Z,J,re,ne,de){const le=Z.transform;if(le.projection.name!=="mercator")return void s.w(`Drawing 3D models for ${le.projection.name} projection is not yet implemented`);const he=le.getFreeCameraOptions().position;if(!Z.modelManager)return;const ae=Z.modelManager;re.modelManager=ae;const ge=Z.shadowRenderer;if(!re._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const Te=re._unevaluatedLayout._values["model-id"],Ue=Object.assign({},re.layout.get("model-id").parameters),Le=Z.style.order.indexOf(re.fqid);for(const He of ne){const Ze=J.getTile(He).getBucket(re);if(!Ze||Ze.projection.name!==le.projection.name)continue;const ze=Ze.getModelUris();ze&&!Ze.modelsRequested&&(ae.addModelsFromBucket(ze,de),Ze.modelsRequested=!0);const je=mu(He,le);Ue.zoom=je;const it=Te.possiblyEvaluate(Ue);if(vs(Z,Ze,He),Jn.shadowUniformsInitialized=!1,Jn.useSingleShadowCascade=!!ge&&ge.getMaxCascadeForTile(He.toUnwrapped())===0,Z.renderPass==="shadow"&&ge){if(Z.currentShadowCascade===1&&Ze.isInsideFirstShadowMapFrustum)continue;const Ge=le.calculatePosMatrix(He.toUnwrapped(),le.worldSize);if(Jn.tileMatrix.set(Ge),Jn.shadowTileMatrix=Float32Array.from(ge.calculateShadowPassMatrixFromMatrix(Ge)),Jn.aabb.min.fill(0),Jn.aabb.max[0]=Jn.aabb.max[1]=s.ag,Jn.aabb.max[2]=0,id(Ze,Jn,Z,re.scope))continue}const Ce=1<<He.canonical.z,Ye=[((he.x-He.wrap)*Ce-He.canonical.x)*s.ag,(he.y*Ce-He.canonical.y)*s.ag,he.z*Ce*s.ag];Z.conflationActive&&Object.keys(Ze.instancesPerModel).length>0&&Z.style.isLayerClipped(re,J.getSource())&&Ze.updateReplacement(He,Z.replacementSource,Le,de)&&(Ze.uploaded=!1,Ze.upload(Z.context));for(let Ge in Ze.instancesPerModel){const ut=Ze.instancesPerModel[Ge];ut.features.length>0&&(Ge=it.evaluate(ut.features[0].feature,{}));const Je=ae.getModel(Ge,de);if(Je&&Je.uploaded)for(const Xe of Je.nodes)Hl(Z,re,Xe,ut,Ye,He,Jn)}}}(l,t,n,c,I.type==="vector"?n.scope:""),void E();if(!I.loaded())return;if(I.type==="batched-model")return function(Z,J,re,ne){re.resetLayerRenderingStats(Z);const de=Z.context,le=Z.transform,he=Z.style.fog,ae=Z.shadowRenderer;if(le.projection.name!=="mercator")return void s.w(`Drawing 3D landmark models for ${le.projection.name} projection is not yet implemented`);const ge=Z.transform.getFreeCameraOptions().position,Te=s.ab.vec3.scale([],[ge.x,ge.y,ge.z],Z.transform.worldSize),Ue=s.ab.vec3.negate([],Te),Le=s.ab.mat4.identity([]),He=s.dj(le.center.lat,le.zoom),Ze=s.ab.mat4.fromScaling([],[1,1,1/He]);s.ab.mat4.translate(Le,Le,Ue);const ze=re.paint.get("model-opacity").constantOr(1),je=new Ft(de.gl.LEQUAL,Ft.ReadWrite,Z.depthRangeFor3D),it=new Ft(de.gl.LEQUAL,Ft.ReadOnly,Z.depthRangeFor3D),Ce=new s.cd([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Ye=Z.renderPass==="shadow",Ge=Ye&&ae?ae.getCurrentCascadeFrustum():le.getFrustum(le.scaleZoom(le.worldSize)),ut=re.paint.get("model-front-cutoff"),Je=ut[2]<1,Xe=fo(Z,re.paint.get("model-cutoff-fade-range")),nt=re.getLayerRenderingStats();(function(lt,bt,Et,$t){const kt=lt.terrain?lt.terrain.exaggeration():0,Bt=lt.transform.zoom;for(const Yt of $t){const fi=bt.getTile(Yt).getBucket(Et);fi&&(lt.conflationActive&&fi.updateReplacement(Yt,lt.replacementSource),fi.evaluateScale(lt,Et),lt.terrain&&kt>0&&fi.elevationUpdate(lt.terrain,kt,Yt,Et.source),fi.needsReEvaluation(lt,Bt,Et)&&fi.evaluate(Et))}})(Z,J,re,ne),function(){let lt,bt,Et;Je?(lt=ne.length-1,bt=-1,Et=-1):(lt=0,bt=ne.length,Et=1);const $t=new Float64Array(16),kt=s.ab.vec3.create(),Bt=new s.P(0,0);for(let Yt=lt;Yt!==bt;Yt+=Et){const fi=ne[Yt],zi=J.getTile(fi).getBucket(re);if(!zi||!zi.uploaded)continue;let Qi=!1;ae&&(Qi=ae.getMaxCascadeForTile(fi.toUnwrapped())===0);const ji=le.calculatePosMatrix(fi.toUnwrapped(),le.worldSize),Qt=zi.modelTraits;!Ye&&Je&&(s.ab.mat4.invert($t,ji),s.ab.vec3.transformMat4(kt,Te,$t),Bt.x=kt[0],Bt.y=kt[1]);const xi=[];for(const Lt of zi.getNodesInfo()){if(Lt.hiddenByReplacement||!Lt.node.meshes)continue;const hi=Lt.node;let Ei=0;Z.terrain&&hi.elevation&&(Ei=hi.elevation*Z.terrain.exaggeration());const Ai=(()=>{const _i=Lt.aabb;return Ce.min=[..._i.min],Ce.max=[..._i.max],Ce.min[2]+=Ei,Ce.max[2]+=Ei,s.ab.vec3.transformMat4(Ce.min,Ce.min,ji),s.ab.vec3.transformMat4(Ce.max,Ce.max,ji),Ce})(),Ki=Lt.evaluatedScale;if(Ki[0]<=1&&Ki[1]<=1&&Ki[2]<=1&&Ai.intersects(Ge)===0)continue;if(!Ye&&Je){const _i=.16666666666666666;Lt.cameraCollisionOpacity=Te[0]>Ai.min[0]&&Te[0]<Ai.max[0]&&Te[1]>Ai.min[1]&&Te[1]<Ai.max[1]&&Te[2]*He<Ai.max[2]&&hi.footprint&&s.bA(Bt,hi.footprint)?Math.max(Lt.cameraCollisionOpacity-_i,0):Math.min(1,Lt.cameraCollisionOpacity+_i)}const Pn=[...ji],vn=hi.anchor?hi.anchor[0]:0,bn=hi.anchor?hi.anchor[1]:0;s.ab.mat4.translate(Pn,Pn,[vn*(Ki[0]-1),bn*(Ki[1]-1),Ei]),s.ab.vec3.exactEquals(Ki,s.dm)||s.ab.mat4.scale(Pn,Pn,Ki);const zr=s.ab.mat4.multiply([],Pn,hi.matrix),Qn=s.ab.mat4.multiply([],le.expandedFarZProjMatrix,zr),Ji=s.ab.mat4.multiply([],le.expandedFarZProjMatrix,Pn),Bi=s.ab.vec4.transformMat4([],[vn,bn,Ei,1],Qn)[2];hi.hidden=!1;let Li=ze;Ye||(Je&&(Li*=Lt.cameraCollisionOpacity,Li*=nd(Pn,le,Lt.aabb,ut)),Li*=ta(Xe,Bi)),Li!==0?xi.push({nodeInfo:Lt,depth:Bi,opacity:Li,wvpForNode:Qn,wvpForTile:Ji,nodeModelMatrix:zr,tileModelMatrix:Pn}):hi.hidden=!0}Ye||xi.sort((Lt,hi)=>!Je||Lt.opacity===1&&hi.opacity===1?Lt.depth<hi.depth?-1:1:Lt.opacity===1?-1:hi.opacity===1?1:Lt.depth>hi.depth?-1:1);for(const Lt of xi){const hi=Lt.nodeInfo,Ei=hi.node;let Ai=s.ab.mat4.multiply([],Ze,Lt.tileModelMatrix);s.ab.mat4.multiply(Ai,Le,Ai);const Ki=s.ab.mat4.invert([],Ai);s.ab.mat4.transpose(Ki,Ki),s.ab.mat4.scale(Ki,Ki,td),Ai=s.ab.mat4.multiply(Ai,Ai,Ei.matrix);const Pn=Z.renderPass==="light-beam",vn=re.paint.get("model-color-use-theme").constantOr("default")==="none",bn=Qt&s.dp.HasMapboxMeshFeatures,zr=bn?0:hi.evaluatedRMEA[0][2];for(let Qn=0;Qn<Ei.meshes.length;++Qn){const Ji=Ei.meshes[Qn],Bi=Qn===Ei.lightMeshIndex;let Li=Lt.wvpForNode;if(Bi){if(!Pn&&!Z.terrain&&Z.shadowRenderer){Z.currentLayer<Z.firstLightBeamLayer&&(Z.firstLightBeamLayer=Z.currentLayer);continue}Li=Lt.wvpForTile}else if(Pn)continue;const _i={defines:[]},cn=[];if(!Ye&&ae&&(ae.useNormalOffset=!!Ji.normalBuffer),Ha(_i.defines,cn,Ji,Z,vn?null:re.lut),bn||_i.defines.push("DIFFUSE_SHADED"),Qi&&_i.defines.push("SHADOWS_SINGLE_CASCADE"),nt&&(Ye?nt.numRenderedVerticesInShadowPass+=Ji.vertexArray.length:nt.numRenderedVerticesInTransparentPass+=Ji.vertexArray.length),Ye){Zl(Ji,Lt.nodeModelMatrix,Z,re);continue}let zn=null;if(he){const Ss=Ys(Lt.nodeModelMatrix,Z.transform);if(zn=new Float32Array(Ss),le.projection.name!=="globe"){const qr=Ji.aabb.min,Rr=Ji.aabb.max,[aa,Es]=he.getOpacityForBounds(Ss,qr[0],qr[1],Rr[0],Rr[1]);_i.overrideFog=aa>=fe||Es>=fe}}const Fi=Ji.material;let er;Fi.occlusionTexture&&Fi.occlusionTexture.offsetScale&&(er=Fi.occlusionTexture.offsetScale,_i.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const Gr=Z.getOrCreateProgram("model",_i);!Ye&&ae&&ae.setupShadowsFromMatrix(Lt.tileModelMatrix,Gr,ae.useNormalOffset),Z.uploadCommonUniforms(de,Gr,null,zn);const Sr=Fi.pbrMetallicRoughness;Sr.metallicFactor=.9,Sr.roughnessFactor=.5;const gr=Ul(new Float32Array(Li),new Float32Array(Ai),new Float32Array(Ki),new Float32Array(Ei.matrix),Z,Lt.opacity,Sr.baseColorFactor.toRenderColor(null),Fi.emissiveFactor,Sr.metallicFactor,Sr.roughnessFactor,Fi,zr,re,[0,0,0],er);!Bi&&(hi.hasTranslucentParts||Lt.opacity<1)&&Gr.draw(Z,de.gl.TRIANGLES,je,Ht.disabled,oi.disabled,Xt.backCCW,gr,re.id,Ji.vertexBuffer,Ji.indexBuffer,Ji.segments,re.paint,Z.transform.zoom,void 0,cn),Gr.draw(Z,de.gl.TRIANGLES,Bi?it:je,Ht.disabled,Bi||Lt.opacity<1||hi.hasTranslucentParts?oi.alphaBlended:oi.unblended,Xt.backCCW,gr,re.id,Ji.vertexBuffer,Ji.indexBuffer,Ji.segments,re.paint,Z.transform.zoom,void 0,cn)}}}}()}(l,t,n,c),void E();if(I.type!=="model")return;const A=I.getModels(),R=[],D=l.transform.getFreeCameraOptions().position,F=s.ab.vec3.scale([],[D.x,D.y,D.z],l.transform.worldSize);s.ab.vec3.negate(F,F);const q=[],U=[];let H=0;for(const Z of A){const J=n.paint.get("model-rotation").constantOr(null),re=n.paint.get("model-scale").constantOr(null),ne=n.paint.get("model-translation").constantOr(null);Z.computeModelMatrix(l,J,re,ne,!0,!0,!1);const de=s.ab.mat4.identity([]),le=s.dj(Z.position.lat,l.transform.zoom),he=s.ab.mat4.fromScaling([],[1,1,1/le]);s.ab.mat4.translate(de,de,F),R.push({zScaleMatrix:he,negCameraPosMatrix:de});for(const ae of Z.nodes)pu(l.transform,ae,Z.matrix,l.transform.expandedFarZProjMatrix,H,q,U);H++}if(q.sort((Z,J)=>J.depth-Z.depth),l.renderPass!=="shadow"){if(d===1)for(const Z of U)Ks(Z,l,n,R[Z.modelIndex],Ht.disabled,l.colorModeForRenderPass());else{for(const Z of U)Ks(Z,l,n,R[Z.modelIndex],Ht.disabled,oi.disabled);for(const Z of U)Ks(Z,l,n,R[Z.modelIndex],l.stencilModeFor3D(),l.colorModeForRenderPass());l.resetStencilClippingMasks()}for(const Z of q)Ks(Z,l,n,R[Z.modelIndex],Ht.disabled,l.colorModeForRenderPass());E()}else{for(const Z of U)Zl(Z.mesh,Z.nodeModelMatrix,l,n);for(const Z of q)Zl(Z.mesh,Z.nodeModelMatrix,l,n);E()}}},Yl={line:function(l,t,n){if(l.hasElevatedBuckets=!1,l.hasNonElevatedBuckets=!1,l._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||l._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(t){const c=t.getVisibleCoordinates();for(const d of c){const p=t.getTile(d).getBucket(l);if(p&&(p.hasZOffset?l.hasElevatedBuckets=!0:l.hasNonElevatedBuckets=!0,l.hasElevatedBuckets&&l.hasNonElevatedBuckets))break}}}else l.hasNonElevatedBuckets=!0},model:function(l,t,n){const c=t.getSource();if(!c.loaded())return;if(c.type==="vector"||c.type==="geojson")return void(n.modelManager&&n.modelManager.upload(n,c.type==="vector"?l.scope:""));if(c.type==="batched-model"||c.type!=="model")return;const d=c.getModels();for(const p of d)p.upload(n.context)},raster:function(l,t,n){const c=t.getSource();if(!(c instanceof In&&c.loaded()))return;const d=l.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!d)return;const p=l.paint.get("raster-array-band")||c.getInitialBand(d);if(p==null)return;const _=t.getIds().map(b=>t.getTileByID(b));for(const b of _)b.updateNeeded(d,p)&&c.prepareTile(b,d,p)},"raster-particle":function(l,t,n){const c=t.getSource();if(!(c instanceof In&&c.loaded()))return;const d=l.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!d)return;const p=l.paint.get("raster-particle-array-band")||c.getInitialBand(d);if(p==null)return;const _=t.getIds().map(b=>t.getTileByID(b));for(const b of _)b.updateNeeded(d,p)&&c.prepareTile(b,d,p)}};class hd{constructor(t,n,c,d,p){this.context=new Yh(t,n),this.transform=c,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=p,this._timeStamp=s.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const _=["fill","line","symbol","circle","heatmap","fill-extrusion","raster","raster-particle","hillshade","model","background","sky"];for(const E of _)this._debugParams.enabledLayers[E]=!0;p.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),p.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),p.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),p.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),p.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),p.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const E of _)p.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],E);this.occlusionParams=new _u(p),this.setup(),this.numSublayers=Nr.maxUnderzooming+Nr.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new s.dv,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new qo(this),this._wireframeDebugCache=new rd,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const b=new s.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new s.T(this.context,b,t.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=d}updateTerrain(t,n){const c=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(c||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Ba(this,t));const d=this._terrain;this.transform.elevation=c?d:null,d.update(t,this.transform,n),this.transform.elevation&&!d.enabled&&(this.transform.elevation=null)}_updateFog(t){const n=t.fog;if(!n||this.transform.projection.name==="globe"||n.getOpacity(this.transform.pitch)<1||n.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[c,d]=n.getFovAdjustedRange(this.transform._fov);if(c>d)return void(this.transform.fogCullDistSq=null);const p=c+.78*(d-c);this.transform.fogCullDistSq=p*p}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(t){t&&!this._terrain&&(this._terrain=new Ba(this,this.style)),this._forceTerrainMode=t}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,n){if(this.width=t*s.q.devicePixelRatio,this.height=n*s.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const c of this.style.order)this.style._mergedLayers[c].resize()}setup(){const t=this.context,n=new s.b4;n.emplaceBack(0,0),n.emplaceBack(s.ag,0),n.emplaceBack(0,s.ag),n.emplaceBack(s.ag,s.ag),this.tileExtentBuffer=t.createVertexBuffer(n,s.b6.members),this.tileExtentSegments=s.b7.simpleSegment(0,0,4,2);const c=new s.b4;c.emplaceBack(0,0),c.emplaceBack(s.ag,0),c.emplaceBack(0,s.ag),c.emplaceBack(s.ag,s.ag),this.debugBuffer=t.createVertexBuffer(c,s.b6.members),this.debugSegments=s.b7.simpleSegment(0,0,4,5);const d=new s.b4;d.emplaceBack(-1,-1),d.emplaceBack(1,-1),d.emplaceBack(-1,1),d.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(d,s.b6.members),this.viewportSegments=s.b7.simpleSegment(0,0,4,2);const p=new s.aT;p.emplaceBack(0,0,0,0),p.emplaceBack(s.ag,0,s.ag,0),p.emplaceBack(0,s.ag,0,s.ag),p.emplaceBack(s.ag,s.ag,s.ag,s.ag),this.mercatorBoundsBuffer=t.createVertexBuffer(p,s.b9.members),this.mercatorBoundsSegments=s.b7.simpleSegment(0,0,4,2);const _=new s.aU;_.emplaceBack(0,1,2),_.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(_);const b=new s.b5;for(const I of[0,1,3,2,0])b.emplaceBack(I);this.debugIndexBuffer=t.createIndexBuffer(b),this.emptyTexture=new s.T(t,new s.r({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA8),this.identityMat=s.ab.mat4.create();const E=this.context.gl;this.stencilClearMode=new Ht({func:E.ALWAYS,mask:0},0,255,E.ZERO,E.ZERO,E.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,Ft.disabled,this.stencilClearMode,oi.disabled,Xt.disabled,iu(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,n,c){if(!n||this.currentStencilSource===n.id||!t.isTileClipped()||!c||c.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let b=!1;for(const E of c)if(this._tileClippingMaskIDs[E.key]===void 0){b=!0;break}if(!b)return}this.currentStencilSource=n.id;const d=this.context,p=d.gl;this.nextStencilID+c.length>256&&this.clearStencil(),d.setColorMode(oi.disabled),d.setDepthMode(Ft.disabled);const _=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const b of c){const E=n.getTile(b),I=this._tileClippingMaskIDs[b.key]=this.nextStencilID++,{tileBoundsBuffer:A,tileBoundsIndexBuffer:R,tileBoundsSegments:D}=this.getTileBoundsBuffers(E);_.draw(this,p.TRIANGLES,Ft.disabled,new Ht({func:p.ALWAYS,mask:0},I,255,p.KEEP,p.KEEP,p.REPLACE),oi.disabled,Xt.disabled,iu(b.projMatrix),"$clipping",A,R,D)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,n=this.context.gl;return new Ht({func:n.NOTEQUAL,mask:255},t,255,n.KEEP,n.KEEP,n.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);const n=this.context.gl;return new Ht({func:n.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,n.KEEP,n.KEEP,n.REPLACE)}stencilConfigForOverlap(t){const n=this.context.gl,c=t.sort((_,b)=>b.overscaledZ-_.overscaledZ),d=c[c.length-1].overscaledZ,p=c[0].overscaledZ-d+1;if(p>1){this.currentStencilSource=void 0,this.nextStencilID+p>256&&this.clearStencil();const _={};for(let b=0;b<p;b++)_[b+d]=new Ht({func:n.GEQUAL,mask:255},b+this.nextStencilID,255,n.KEEP,n.KEEP,n.REPLACE);return this.nextStencilID+=p,[_,c]}return[{[d]:Ht.disabled},c]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new oi([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new s.aj(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?oi.unblended:oi.alphaBlended}colorModeForDrapableLayerRenderPass(t){const n=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new oi([n.ONE,n.ONE_MINUS_SRC_ALPHA,n.CONSTANT_ALPHA,n.ONE_MINUS_SRC_ALPHA],new s.aj(0,0,0,t===void 0?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(t,n,c,d=!1){if(this.depthOcclusion)return new Ft(this.context.gl.GREATER,Ft.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!d)return Ft.disabled;const p=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new Ft(c||this.context.gl.LEQUAL,n,[p,p])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const t=this.context.gl,n=Math.ceil(this.width),c=Math.ceil(this.height),d=this.context.bindFramebuffer.get(),p=t.getParameter(t.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===n&&this.depthFBO.height===c||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),n!==0&&c!==0&&(this.depthFBO=new Xh(this.context,n,c,!1,"texture"),this.depthTexture=new s.T(this.context,{width:n,height:c,data:null},t.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(d),t.bindTexture(t.TEXTURE_2D,p),this.depthFBO&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),t.blitFramebuffer(0,0,n,c,0,0,n,c,t.DEPTH_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((t,n)=>t+n/this._fpsHistory.length,0))}render(t,n){const c=s.q.now();this._dt=c-this._timeStamp,this._timeStamp=c,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=t.map.repaint,this.style=t,this.options=n;const d=this.style._mergedLayers,p=!(!this.terrain||!this.terrain.enabled),_=()=>this.style._getOrder(p).filter(ze=>{const je=d[ze];return!(je.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[je.type]});let b=_(),E=!1,I=!1;for(const ze of b){const je=d[ze];je.type==="circle"&&(E=!0),je.type==="symbol"&&(je.hasInitialOcclusionOpacityProperties?I=!0:E=!0)}let A=b.map(ze=>d[ze]);const R=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(s.q.now()),this.imageManager.beginFrame();let D=0,F=!1;for(const ze in R){const je=R[ze];je.used&&(je.prepare(this.context),je.getSource().usedInConflation&&++D)}let q=!1;for(const ze of A)ze.isHidden(this.transform.zoom)||(ze.type==="clip"&&(q=!0),this.prepareLayer(ze));const U={},H={},Z={},J={},re={};for(const ze in R){const je=R[ze];U[ze]=je.getVisibleCoordinates(),H[ze]=U[ze].slice().reverse(),Z[ze]=je.getVisibleCoordinates(!0).reverse(),J[ze]=je.getShadowCasterCoordinates(),re[ze]=je.sortCoordinatesByDistance(U[ze])}const ne=ze=>{const je=this.style.getLayerSourceCache(ze);return je&&je.used?je.getSource():null};if(D||q||this._clippingActiveLastFrame){const ze=[],je=[];let it=0;for(const Ce of A)this.isSourceForClippingOrConflation(Ce,ne(Ce))&&(ze.push(Ce),je.push(it)),it++;if(q||ze.length>1||this._clippingActiveLastFrame){q=!1;const Ce=[];for(let Ye=0;Ye<ze.length;Ye++){const Ge=ze[Ye],ut=je[Ye],Je=this.style.getLayerSourceCache(Ge);if(!Je||!Je.used||!Je.getSource().usedInConflation&&Ge.type!=="clip")continue;let Xe=s.dx,nt=s.by.None;const lt=[];let bt=!0;if(Ge.type==="clip"){Xe=ut;for(const Et of Ge.layout.get("clip-layer-types"))nt|=Et==="model"?s.by.Model:Et==="symbol"?s.by.Symbol:s.by.FillExtrusion;for(const Et of Ge.layout.get("clip-layer-scope"))lt.push(Et);Ge.isHidden(this.transform.zoom)?bt=!1:q=!0}bt&&Ce.push({layer:Ge.fqid,cache:Je,order:Xe,clipMask:nt,clipScope:lt})}this.replacementSource.setSources(Ce),F=!0}}this._clippingActiveLastFrame=q,F||this.replacementSource.clear(),this.conflationActive=F,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let ze=0;ze<A.length;ze++){const je=A[ze],it=je.cutoffRange();if(this.longestCutoffRange=Math.max(it,this.longestCutoffRange),it>0){const Ce=ne(je);Ce&&(this.minCutoffZoom=Math.max(Ce.minzoom,this.minCutoffZoom)),je.minzoom&&(this.minCutoffZoom=Math.max(je.minzoom,this.minCutoffZoom))}je.is3D()&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=ze),this._lastOcclusionLayer=ze)}const de=this.style&&this.style.fog;de?(this._fogVisible=de.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=de.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(Z),this.opaquePassCutoff=0,b=_(),A=b.map(ze=>d[ze]));const le=this._shadowRenderer;if(le){le.updateShadowParameters(this.transform,this.style.directionalLight);for(const ze in R)for(const je of U[ze]){let it={min:0,max:0};this.terrain&&(it=this.terrain.getMinMaxForTile(je)||it),le.addShadowReceiver(je.toUnwrapped(),it.min,it.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new s.dw(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new Xf(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const he=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),ae=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(he&&!this._snow&&(this._snow=new ud(this)),!he&&this._snow&&(this._snow.destroy(),delete this._snow),ae&&!this._rain&&(this._rain=new Wa(this)),!ae&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),!ya.has(this.context.gl))return;this.renderPass="offscreen";for(const ze of A){const je=t.getLayerSourceCache(ze);if(!ze.hasOffscreenPass()||ze.isHidden(this.transform.zoom))continue;const it=je?H[je.id]:void 0;(ze.type==="custom"||ze.type==="raster"||ze.type==="raster-particle"||ze.isSky()||it&&it.length)&&this.renderLayer(this,je,ze,it)}this.depthRangeFor3D=[0,1-(A.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,J)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const ge=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),Te=(()=>{if(n.showOverdrawInspector)return s.aj.black;const ze=this.style.fog;if(ze&&this.transform.projection.supportsFog){const je=this.style.getLut(ze.scope);if(!ge){const it=ze.properties.get("color-use-theme")==="none",Ce=ze.properties.get("color").toRenderColor(it?null:je).toArray01();return new s.aj(...Ce)}if(ge){const it=ze.properties.get("space-color-use-theme")==="none",Ce=ze.properties.get("space-color").toRenderColor(it?null:je).toArray01();return new s.aj(...Ce)}}return s.aj.transparent})();if(this.context.clear({color:Te,depth:1}),this.clearStencil(),this._showOverdrawInspector=n.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ge&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=b.length-1;this.currentLayer>=0;this.currentLayer--){const ze=A[this.currentLayer],je=t.getLayerSourceCache(ze);if(ze.isSky())continue;const it=je?(ze.is3D()?re:H)[je.id]:void 0;this._renderTileClippingMasks(ze,je,it),this.renderLayer(this,je,ze,it)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ge&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||s.ae(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<b.length;this.currentLayer++){const ze=A[this.currentLayer],je=t.getLayerSourceCache(ze);ze.isSky()&&this.renderLayer(this,je,ze,je?H[je.id]:void 0)}function Ue(ze,je){let it;return je&&(it=(ze.type==="symbol"?Z:ze.is3D()?re:H)[je.id]),it}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<b.length;){const ze=A[this.currentLayer];if(ze.type==="raster"||ze.type==="raster-particle"){const je=t.getLayerSourceCache(ze);this.renderLayer(this,je,ze,Ue(ze,je))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Le=0;le&&(Le=le.getShadowCastingLayerCount());let He=!1,Ze=-1;for(let ze=0;ze<b.length;++ze){const je=A[ze];je.isHidden(this.transform.zoom)||je.is3D()&&(Ze=ze)}for(I&&Ze===-1&&(E=!0);this.currentLayer<b.length;){const ze=A[this.currentLayer],je=t.getLayerSourceCache(ze);if(ze.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(ze)){if(ze.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(E&&!He&&this.terrain&&!this.transform.isOrthographic&&(He=!0,this.blitDepth()),I&&Ze!==-1&&this.currentLayer===Ze+1&&!this.transform.isOrthographic&&this.blitDepth(),ze.is3D()||this.terrain||this._renderTileClippingMasks(ze,je,je?U[je.id]:void 0),this.renderLayer(this,je,ze,Ue(ze,je)),!this.terrain&&le&&Le>0&&ze.hasShadowPass()&&--Le==0&&(le.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const it=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=it;this.currentLayer++){const Ce=A[this.currentLayer];if(!Ce.hasLightBeamPass())continue;const Ye=t.getLayerSourceCache(Ce);this.renderLayer(this,Ye,Ce,Ye?H[Ye.id]:void 0)}this.currentLayer=it,this.renderPass="translucent"}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const it=this.currentLayer;this.depthOcclusion=!0;for(const Ce of this.layersWithOcclusionOpacity){this.currentLayer=Ce;const Ye=A[this.currentLayer],Ge=t.getLayerSourceCache(Ye),ut=Ge?H[Ge.id]:void 0;Ye.is3D()||this.terrain||this._renderTileClippingMasks(Ye,Ge,Ge?U[Ge.id]:void 0),this.renderLayer(this,Ge,Ye,ut)}this.depthOcclusion=!1,this.currentLayer=it,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let ze=null;A.forEach(je=>{const it=t.getLayerSourceCache(je);it&&!je.isHidden(this.transform.zoom)&&it.getVisibleCoordinates().length&&(!ze||ze.getSource().maxzoom<it.getSource().maxzoom)&&(ze=it)}),ze&&this.options.showTileBoundaries&&Xl.debug(this,ze,ze.getVisibleCoordinates(),s.aj.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&Xl.debug(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new s.aj(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(ze){const je=ze.transform.padding;Qh(ze,ze.transform.height-(je.top||0),3,Za),Qh(ze,je.bottom||0,3,p_),ed(ze,je.left||0,3,m_),ed(ze,ze.transform.width-(je.right||0),3,Hf);const it=ze.transform.centerPoint;(function(Ce,Ye,Ge,ut){ea(Ce,Ye-1,Ge-10,2,20,ut),ea(Ce,Ye-10,Ge-1,20,2,ut)})(ze,it.x,ze.transform.height-it.y,du)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),F||(this.conflationActive=!1)}prepareLayer(t){this.gpuTimingStart(t);const{unsupportedLayers:n}=this.transform.projection,c=!n||!n.includes(t.type);if(Yl[t.type]&&(c||this.terrain&&t.type==="custom")){const d=this.style.getLayerSourceCache(t);Yl[t.type](t,d,this)}this.gpuTimingEnd()}renderLayer(t,n,c,d){c.isHidden(this.transform.zoom)||(c.type==="background"||c.type==="sky"||c.type==="custom"||c.type==="model"||c.type==="raster"||c.type==="raster-particle"||d&&d.length)&&(this.id=c.id,this.gpuTimingStart(c),t.transform.projection.unsupportedLayers&&t.transform.projection.unsupportedLayers.includes(c.type)&&(!t.terrain||c.type!=="custom")||c.type==="clip"||Xl[c.type](t,n,c,d,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;const n=this.context.extTimerQuery,c=this.context.gl;let d=this.gpuTimers[t.id];d||(d=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:c.createQuery()}),d.calls++,c.beginQuery(n.TIME_ELAPSED_EXT,d.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const t=this.context.extTimerQuery,n=this.context.gl,c=n.createQuery();this.deferredRenderGpuTimeQueries.push(c),n.beginQuery(t.TIME_ELAPSED_EXT,c)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){const t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){const n={};for(const c in t){const d=t[c],p=this.context.extTimerQuery,_=p.getQueryParameter(d.query,this.context.gl.QUERY_RESULT)/1e6;p.deleteQueryEXT(d.query),n[c]=_}return n}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;const n=this.context.gl;let c=0;for(const d of t)c+=n.getQueryParameter(d,n.QUERY_RESULT)/1e6,n.deleteQuery(d);return c}translatePosMatrix(t,n,c,d,p){if(!c[0]&&!c[1])return t;const _=p?d==="map"?this.transform.angle:0:d==="viewport"?-this.transform.angle:0;if(_){const I=Math.sin(_),A=Math.cos(_);c=[c[0]*A-c[1]*I,c[0]*I+c[1]*A]}const b=[p?c[0]:s.ar(n,c[0],this.transform.zoom),p?c[1]:s.ar(n,c[1],this.transform.zoom),0],E=new Float32Array(16);return s.ab.mat4.translate(E,t,b),E}saveTileTexture(t){const n=t.size[0],c=this._tileTextures[n];c?c.push(t):this._tileTextures[n]=[t]}getTileTexture(t){const n=this._tileTextures[t];return n&&n.length>0?n.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(t,n,c){const d=c===void 0?this.terrain&&this.terrain.renderingToTexture:c,p=[];return this.style&&this.style.enable3dLights()&&(t==="globeRaster"||t==="terrainRaster"?(p.push("LIGHTING_3D_MODE"),p.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):d||p.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||p.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(p.push("TERRAIN"),this.linearFloatFilteringSupported()&&p.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&p.push("GLOBE"),!this._fogVisible||d||n!==void 0&&!n||p.push("FOG","FOG_DITHERING"),d&&p.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&p.push("OVERDRAW_INSPECTOR"),p}getOrCreateProgram(t,n){this.cache=this.cache||{};const c=n&&n.defines||[],d=n&&n.config,p=this.currentGlobalDefines(t,n&&n.overrideFog,n&&n.overrideRtt).concat(c),_=Nf.cacheKey(La[t],t,p,d);return this.cache[_]||(this.cache[_]=new Nf(this.context,t,La[t],d,Wh[t],p)),this.cache[_]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new s.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,n){if(this.style.enable3dLights()){const c=this.style.directionalLight,d=this.style.ambientLight;if(c&&d){const p=((_,b,E)=>{const I=_.properties.get("direction"),A=_.properties.get("color-use-theme")==="none",R=_.properties.get("color").toRenderColor(A?null:E.getLut(_.scope)).toArray01(),D=_.properties.get("intensity"),F=b.properties.get("color-use-theme")==="none",q=b.properties.get("color").toRenderColor(F?null:E.getLut(b.scope)).toArray01(),U=b.properties.get("intensity"),H=[I.x,I.y,I.z],Z=s.cM(q,U),J=s.cM(R,D);return{u_lighting_ambient_color:Z,u_lighting_directional_dir:H,u_lighting_directional_color:J,u_ground_radiance:c_(H,J,Z)}})(c,d,this.style);n.setLightsUniformValues(t,p)}}}uploadCommonUniforms(t,n,c,d,p){if(this.uploadCommonLightUniforms(t,n),this.terrain&&this.terrain.renderingToTexture)return;const _=this.style.fog;if(_){const b=_.getOpacity(this.transform.pitch),E=((I,A,R,D,F,q,U,H,Z,J,re,ne)=>{const de=I.transform,le=A.properties.get("color-use-theme")==="none",he=A.properties.get("color").toRenderColor(le?null:I.style.getLut(A.scope)).toArray01();he[3]=D;const ae=I.frameCounter/1e3%1,[ge,Te]=A.properties.get("vertical-range");return{u_fog_matrix:R?de.calculateFogTileMatrix(R):ne||I.identityMat,u_fog_range:A.getFovAdjustedRange(de._fov),u_fog_color:he,u_fog_horizon_blend:A.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(ge,Te),Te],u_fog_temporal_offset:ae,u_frustum_tl:F,u_frustum_tr:q,u_frustum_br:U,u_frustum_bl:H,u_globe_pos:Z,u_globe_radius:J,u_viewport:re,u_globe_transition:s.ae(de.zoom),u_is_globe:+(de.projection.name==="globe")}})(this,_,c,b,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*s.q.devicePixelRatio,this.transform.height*s.q.devicePixelRatio],d);n.setFogUniformValues(t,E)}p&&n.setCutoffUniformValues(t,p.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){const t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){const t=this.context.gl,n=t.createTexture();return t.bindTexture(t.TEXTURE_2D,n),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),n}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const t=this.style&&this.style.fog;return!!t&&t.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const t=this._backgroundTiles,n=this._backgroundTiles={},c=this.transform.coveringTiles({tileSize:512});for(const d of c)n[d.key]=t[d.key]||new co(d,512,this.transform.tileZoom,this);return n}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(t,n){return!(!t.is3D()||t.type!=="clip"&&(t.minzoom&&t.minzoom>this.transform.zoom||(this.style._clipLayerPresent||t.sourceLayer!=="building")&&(!n||n.type!=="batched-model")))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let n=this._cachedTileFogOpacities[t.key];return n||(this._cachedTileFogOpacities[t.key]=n=this.style.fog.getOpacityForTile(t)),n[0]>=fe||n[1]>=fe}setupDepthForOcclusion(t,n,c){const d=this.context,p=d.gl,_=!!c;var b;c||(c={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),d.activeTexture.set(p.TEXTURE3),t&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(p.NEAREST,p.CLAMP_TO_EDGE),c.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],c.u_depth_range_unpack=[2/((b=this.depthRangeFor3D)[1]-b[0]),-1-2*b[0]/(b[1]-b[0])],c.u_occluder_half_size=.5*this.occlusionParams.occluderSize,c.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(p.NEAREST,p.CLAMP_TO_EDGE),d.activeTexture.set(p.TEXTURE0),_||n.setTerrainUniformValues(d,c)}}function xu(l,t){let n=!1,c=null;const d=()=>{c=null,n&&(l(),c=setTimeout(d,t),n=!1)};return()=>(n=!0,c||d(),c)}class Yf{constructor(t){this._hashName=t&&encodeURIComponent(t),s.aP(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=xu(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,window.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const t=this._map;if(!t)return"";const n=dd(t);if(this._hashName){const c=this._hashName;let d=!1;const p=location.hash.slice(1).split("&").map(_=>{const b=_.split("=")[0];return b===c?(d=!0,`${b}=${n}`):_}).filter(_=>_);return d||p.push(`${c}=${n}`),`#${p.join("&")}`}return`#${n}`}_getCurrentHash(){const t=location.hash.replace("#","");if(this._hashName){let n;return t.split("&").map(c=>c.split("=")).forEach(c=>{c[0]===this._hashName&&(n=c)}),(n&&n[1]||"").split("/")}return t.split("/")}_onHashChange(){const t=this._map;if(!t)return!1;const n=this._getCurrentHash();if(n.length>=3&&!n.some(c=>isNaN(c))){const c=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(n[3]||0):t.getBearing();return t.jumpTo({center:[+n[2],+n[1]],zoom:+n[0],bearing:c,pitch:+(n[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function dd(l,t){const n=l.getCenter(),c=Math.round(100*l.getZoom())/100,d=Math.ceil((c*Math.LN2+Math.log(512/360/.5))/Math.LN10),p=Math.pow(10,d),_=Math.round(n.lng*p)/p,b=Math.round(n.lat*p)/p,E=l.getBearing(),I=l.getPitch();let A=t?`/${_}/${b}/${c}`:`${c}/${b}/${_}`;return(E||I)&&(A+="/"+Math.round(10*E)/10),I&&(A+=`/${Math.round(I)}`),A}const Kl={linearity:.3,easing:s.dy(0,0,.3,1)},Kf=s.l({deceleration:2500,maxSpeed:1400},Kl),Jf=s.l({deceleration:20,maxSpeed:1400},Kl),Qf=s.l({deceleration:1e3,maxSpeed:360},Kl),ep=s.l({deceleration:1e3,maxSpeed:90},Kl);class tp{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:s.q.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,n=s.q.now();for(;t.length>0&&n-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const n={zoom:0,bearing:0,pitch:0,pan:new s.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:p}of this._inertiaBuffer)n.zoom+=p.zoomDelta||0,n.bearing+=p.bearingDelta||0,n.pitch+=p.pitchDelta||0,p.panDelta&&n.pan._add(p.panDelta),p.around&&(n.around=p.around),p.pinchAround&&(n.pinchAround=p.pinchAround);const c=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,d={};if(n.pan.mag()){const p=Ql(n.pan.mag(),c,s.l({},Kf,t||{}));d.offset=n.pan.mult(p.amount/n.pan.mag()),d.center=this._map.transform.center,Jl(d,p)}if(n.zoom){const p=Ql(n.zoom,c,Jf);d.zoom=this._map.transform.zoom+p.amount,Jl(d,p)}if(n.bearing){const p=Ql(n.bearing,c,Qf);d.bearing=this._map.transform.bearing+s.aw(p.amount,-179,179),Jl(d,p)}if(n.pitch){const p=Ql(n.pitch,c,ep);d.pitch=this._map.transform.pitch+p.amount,Jl(d,p)}if(d.zoom||d.bearing){const p=n.pinchAround===void 0?n.around:n.pinchAround;d.around=p?this._map.unproject(p):this._map.getCenter()}return this.clear(),d.noMoveStart=!0,d}}function Jl(l,t){(!l.duration||l.duration<t.duration)&&(l.duration=t.duration,l.easing=t.easing)}function Ql(l,t,n){const{maxSpeed:c,linearity:d,deceleration:p}=n,_=s.aw(l*d/(t/1e3),-c,c),b=Math.abs(_)/(p*d);return{easing:n.easing,duration:1e3*b,amount:_*(b/2)}}class wr extends s.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,c,d={}){const p=Nt(n.getCanvasContainer(),c),_=n.unproject(p);super(t,s.l({point:p,lngLat:_,originalEvent:c},d)),this._defaultPrevented=!1,this.target=n}}class ec extends s.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,c){const d=t==="touchend"?c.changedTouches:c.touches,p=Jt(n.getCanvasContainer(),d),_=p.map(E=>n.unproject(E)),b=p.reduce((E,I,A,R)=>E.add(I.div(R.length)),new s.P(0,0));super(t,{points:p,point:b,lngLats:_,lngLat:n.unproject(b),originalEvent:c}),this._defaultPrevented=!1}}class ip extends s.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n){super("wheel",{originalEvent:n}),this._defaultPrevented=!1}}class g_{constructor(t,n){this._map=t,this._clickTolerance=n.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new ip(this._map,t))}mousedown(t,n){return this._mousedownPos=n,this._firePreventable(new wr(t.type,this._map,t))}mouseup(t){this._map.fire(new wr(t.type,this._map,t))}preclick(t){const n=s.l({},t);n.type="preclick",this._map.fire(new wr(n.type,this._map,n))}click(t,n){this._mousedownPos&&this._mousedownPos.dist(n)>=this._clickTolerance||(this.preclick(t),this._map.fire(new wr(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new wr(t.type,this._map,t))}mouseover(t){this._map.fire(new wr(t.type,this._map,t))}mouseout(t){this._map.fire(new wr(t.type,this._map,t))}touchstart(t){return this._firePreventable(new ec(t.type,this._map,t))}touchmove(t){this._map.fire(new ec(t.type,this._map,t))}touchend(t){this._map.fire(new ec(t.type,this._map,t))}touchcancel(t){this._map.fire(new ec(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class y_{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new wr(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new wr("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new wr(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class an{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=n.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,n){this.isEnabled()&&t.shiftKey&&t.button===0&&(ot(),this._startPos=this._lastPos=n,this._active=!0)}mousemoveWindow(t,n){if(!this._active)return;const c=n,d=this._startPos,p=this._lastPos;if(!d||!p||p.equals(c)||!this._box&&c.dist(d)<this._clickTolerance)return;this._lastPos=c,this._box||(this._box=We("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));const _=Math.min(d.x,c.x),b=Math.max(d.x,c.x),E=Math.min(d.y,c.y),I=Math.max(d.y,c.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${_}px,${E}px)`,this._box.style.width=b-_+"px",this._box.style.height=I-E+"px")})}mouseupWindow(t,n){if(!this._active)return;const c=this._startPos,d=n;if(c&&t.button===0){if(this.reset(),vt(),c.x!==d.x||c.y!==d.y)return this._map.fire(new s.z("boxzoomend",{originalEvent:t})),{cameraAnimation:p=>p.fitScreenCoordinates(c,d,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),zt(),delete this._startPos,delete this._lastPos}_fireEvent(t,n){return this._map.fire(new s.z(t,{originalEvent:n}))}}function vu(l,t){const n={};for(let c=0;c<l.length;c++)n[l[c].identifier]=t[c];return n}class x_{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,n,c){(this.centroid||c.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=t.timeStamp),c.length===this.numTouches&&(this.centroid=function(d){const p=new s.P(0,0);for(const _ of d)p._add(_);return p.div(d.length)}(n),this.touches=vu(c,n)))}touchmove(t,n,c){if(this.aborted||!this.centroid)return;const d=vu(c,n);for(const p in this.touches){const _=d[p];(!_||_.dist(this.touches[p])>30)&&(this.aborted=!0)}}touchend(t,n,c){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),c.length===0){const d=!this.aborted&&this.centroid;if(this.reset(),d)return d}}}class fd{constructor(t){this.singleTap=new x_(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,n,c){this.singleTap.touchstart(t,n,c)}touchmove(t,n,c){this.singleTap.touchmove(t,n,c)}touchend(t,n,c){const d=this.singleTap.touchend(t,n,c);if(d){const p=t.timeStamp-this.lastTime<500,_=!this.lastTap||this.lastTap.dist(d)<30;if(p&&_||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=d,this.count===this.numTaps)return this.reset(),d}}}class tc{constructor(){this._zoomIn=new fd({numTouches:1,numTaps:2}),this._zoomOut=new fd({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,n,c){this._zoomIn.touchstart(t,n,c),this._zoomOut.touchstart(t,n,c)}touchmove(t,n,c){this._zoomIn.touchmove(t,n,c),this._zoomOut.touchmove(t,n,c)}touchend(t,n,c){const d=this._zoomIn.touchend(t,n,c),p=this._zoomOut.touchend(t,n,c);return d?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:_=>_.easeTo({duration:300,zoom:_.getZoom()+1,around:_.unproject(d)},{originalEvent:t})}):p?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:_=>_.easeTo({duration:300,zoom:_.getZoom()-1,around:_.unproject(p)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const np={0:1,2:2};class ic{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,n){return!1}_move(t,n){return{}}mousedown(t,n){if(this._lastPoint)return;const c=It(t);this._correctButton(t,c)&&(this._lastPoint=n,this._eventButton=c)}mousemoveWindow(t,n){const c=this._lastPoint;if(c){if(t.preventDefault(),this._eventButton!=null&&function(d,p){const _=np[p];return d.buttons===void 0||(d.buttons&_)!==_}(t,this._eventButton))this.reset();else if(this._moved||!(n.dist(c)<this._clickTolerance))return this._moved=!0,this._lastPoint=n,this._move(c,n)}}mouseupWindow(t){this._lastPoint&&It(t)===this._eventButton&&(this._moved&&vt(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class bu extends ic{mousedown(t,n){super.mousedown(t,n),this._lastPoint&&(this._active=!0)}_correctButton(t,n){return n===0&&!t.ctrlKey}_move(t,n){return{around:n,panDelta:n.sub(t)}}}class ws extends ic{_correctButton(t,n){return n===0&&t.ctrlKey||n===2}_move(t,n){const c=.8*(n.x-t.x);if(c)return this._active=!0,{bearingDelta:c}}contextmenu(t){t.preventDefault()}}class nc extends ic{_correctButton(t,n){return n===0&&t.ctrlKey||n===2}_move(t,n){const c=-.5*(n.y-t.y);if(c)return this._active=!0,{pitchDelta:c}}contextmenu(t){t.preventDefault()}}class ln{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=n.clickTolerance||1,this.reset(),s.aP(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new s.P(0,0)}touchstart(t,n,c){return this._calculateTransform(t,n,c)}touchmove(t,n,c){if(this._active&&!(c.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(c.length===1&&!s.dz())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,n,c)}}touchend(t,n,c){this._calculateTransform(t,n,c),this._active&&c.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,n,c){c.length>0&&(this._active=!0);const d=vu(c,n),p=new s.P(0,0),_=new s.P(0,0);let b=0;for(const I in d){const A=d[I],R=this._touches[I];R&&(p._add(A),_._add(A.sub(R)),b++,d[I]=A)}if(this._touches=d,b<this._minTouches||!_.mag())return;const E=_.div(b);return this._sum._add(E),this._sum.mag()<this._clickTolerance?void 0:{around:p.div(b),panDelta:E}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=We("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class jr{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,n,c){return{}}touchstart(t,n,c){this._firstTwoTouches||c.length<2||(this._firstTwoTouches=[c[0].identifier,c[1].identifier],this._start([n[0],n[1]]))}touchmove(t,n,c){const d=this._firstTwoTouches;if(!d)return;t.preventDefault();const[p,_]=d,b=Xa(c,n,p),E=Xa(c,n,_);if(!b||!E)return;const I=this._aroundCenter?null:b.add(E).div(2);return this._move([b,E],I,t)}touchend(t,n,c){if(!this._firstTwoTouches)return;const[d,p]=this._firstTwoTouches,_=Xa(c,n,d),b=Xa(c,n,p);_&&b||(this._active&&vt(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Xa(l,t,n){for(let c=0;c<l.length;c++)if(l[c].identifier===n)return t[c]}function rc(l,t){return Math.log(l/t)/Math.LN2}class rp extends jr{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,n){const c=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(rc(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:rc(this._distance,c),pinchAround:n}}}function sp(l,t){return 180*l.angleWith(t)/Math.PI}class sc extends jr{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,n){const c=this._vector;if(this._vector=t[0].sub(t[1]),c&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:sp(this._vector,c),pinchAround:n}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const n=25/(Math.PI*this._minDiameter)*360,c=this._startVector;if(!c)return!1;const d=sp(t,c);return Math.abs(d)<n}}function pd(l){return Math.abs(l.y)>Math.abs(l.x)}class v_ extends jr{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,pd(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,n,c){const d=this._lastPoints;if(!d)return;const p=t[0].sub(d[0]),_=t[1].sub(d[1]);return this._map._cooperativeGestures&&!s.dz()&&c.touches.length<3||(this._valid=this.gestureBeginsVertically(p,_,c.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(p.y+_.y)/2*-.5})}gestureBeginsVertically(t,n,c){if(this._valid!==void 0)return this._valid;const d=t.mag()>=2,p=n.mag()>=2;if(!d&&!p)return;if(!d||!p)return this._firstMove==null&&(this._firstMove=c),c-this._firstMove<100&&void 0;const _=t.y>0==n.y>0;return pd(t)&&pd(n)&&_}}const md={panStep:100,bearingStep:15,pitchStep:10};class _d{constructor(){const t=md;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let n=0,c=0,d=0,p=0,_=0;switch(t.keyCode){case 61:case 107:case 171:case 187:n=1;break;case 189:case 109:case 173:n=-1;break;case 37:t.shiftKey?c=-1:(t.preventDefault(),p=-1);break;case 39:t.shiftKey?c=1:(t.preventDefault(),p=1);break;case 38:t.shiftKey?d=1:(t.preventDefault(),_=-1);break;case 40:t.shiftKey?d=-1:(t.preventDefault(),_=1);break;default:return}return this._rotationDisabled&&(c=0,d=0),{cameraAnimation:b=>{const E=b.getZoom();b.easeTo({duration:300,easeId:"keyboardHandler",easing:ia,zoom:n?Math.round(E)+n*(t.shiftKey?2:1):E,bearing:b.getBearing()+c*this._bearingStep,pitch:b.getPitch()+d*this._pitchStep,offset:[-p*this._panStep,-_*this._panStep],center:b.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function ia(l){return l*(2-l)}const na=4.000244140625,Js=1/450;class es{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._handler=n,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=Js,s.aP(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||s.dz()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let n=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const c=s.q.now(),d=c-(this._lastWheelEventTime||0);this._lastWheelEventTime=c,n!==0&&n%na==0?this._type="wheel":n!==0&&Math.abs(n)<4?this._type="trackpad":d>400?(this._type=null,this._lastValue=n,this._timeout=window.setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(d*n)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,n+=this._lastValue)),t.shiftKey&&n&&(n/=4),this._type&&(this._lastWheelEvent=t,this._delta-=n,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const n=Nt(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:n,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._map.transform;this._type==="wheel"&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const n=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(this._delta!==0){const I=this._type==="wheel"&&Math.abs(this._delta)>na?this._wheelZoomRate:this._defaultZoomRate;let A=2/(1+Math.exp(-Math.abs(this._delta*I)));this._delta<0&&A!==0&&(A=1/A);const R=n(),D=Math.pow(2,R),F=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):D;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(F*A))),this._type==="wheel"&&(this._startZoom=R,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const c=typeof this._targetZoom=="number"?this._targetZoom:n(),d=this._startZoom,p=this._easing;let _,b=!1;if(this._type==="wheel"&&d&&p){const I=Math.min((s.q.now()-this._lastWheelEventTime)/200,1),A=p(I);_=s.af(d,c,A),I<1?this._frameId||(this._frameId=!0):b=!0}else _=c,b=!0;this._active=!0,b&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let E=_-n();return E*this._lastDelta<0&&(E=0),{noInertia:!0,needsRenderFrame:!b,zoomDelta:E,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let n=s.dA;if(this._prevEase){const c=this._prevEase,d=(s.q.now()-c.start)/c.duration,p=c.easing(d+.01)-c.easing(d),_=.27/Math.sqrt(p*p+1e-4)*.01,b=Math.sqrt(.0729-_*_);n=s.dy(_,b,.25,1)}return this._prevEase={start:s.q.now(),duration:t,easing:n},n}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=We("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class bo{constructor(t,n){this._clickZoom=t,this._tapZoom=n}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class ra{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,n){return t.preventDefault(),{cameraAnimation:c=>{c.easeTo({duration:300,zoom:c.getZoom()+(t.shiftKey?-1:1),around:c.unproject(n)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class wo{constructor(){this._tap=new fd({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,n,c){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?c.length>0&&(this._swipePoint=n[0],this._swipeTouch=c[0].identifier):this._tap.touchstart(t,n,c))}touchmove(t,n,c){if(this._tapTime){if(this._swipePoint){if(c[0].identifier!==this._swipeTouch)return;const d=n[0],p=d.y-this._swipePoint.y;return this._swipePoint=d,t.preventDefault(),this._active=!0,{zoomDelta:p/128}}}else this._tap.touchmove(t,n,c)}touchend(t,n,c){this._tapTime?this._swipePoint&&c.length===0&&this.reset():this._tap.touchend(t,n,c)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class b_{constructor(t,n,c){this._el=t,this._mousePan=n,this._touchPan=c}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class w_{constructor(t,n,c){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=n,this._mousePitch=c}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class T_{constructor(t,n,c,d){this._el=t,this._touchZoom=n,this._touchRotate=c,this._tapDragZoom=d,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const wu=l=>l.zoom||l.drag||l.pitch||l.rotate;class op extends s.z{}class lr{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,n){const c=s.ab.vec3.sub([],n,t);this.radius=s.ab.vec3.length(c[2]<0?s.ab.vec3.div([],c,this.constants):[c[0],c[1],0])}projectRay(t){s.ab.vec3.div(t,t,this.constants),s.ab.vec3.normalize(t,t),s.ab.vec3.mul(t,t,this.constants);const n=s.ab.vec3.scale([],t,this.radius);if(n[2]>0){const c=s.ab.vec3.scale([],[0,0,1],s.ab.vec3.dot(n,[0,0,1])),d=s.ab.vec3.scale([],s.ab.vec3.normalize([],[n[0],n[1],0]),this.radius),p=s.ab.vec3.add([],n,s.ab.vec3.scale([],s.ab.vec3.sub([],s.ab.vec3.add([],d,c),n),2));n[0]=p[0],n[1]=p[1]}return n}}function Ya(l){return l.panDelta&&l.panDelta.mag()||l.zoomDelta||l.bearingDelta||l.pitchDelta}class ap{constructor(t,n){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new tp(t),this._bearingSnap=n.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new lr,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(n),s.aP(["handleEvent","handleWindowEvent"],this);const c=this._el;this._listeners=[[c,"touchstart",{passive:!0}],[c,"touchmove",{passive:!1}],[c,"touchend",void 0],[c,"touchcancel",void 0],[c,"mousedown",void 0],[c,"mousemove",void 0],[c,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[c,"mouseover",void 0],[c,"mouseout",void 0],[c,"dblclick",void 0],[c,"click",void 0],[c,"keydown",{capture:!1}],[c,"keyup",void 0],[c,"wheel",{passive:!1}],[c,"contextmenu",void 0],[window,"blur",void 0]];for(const[d,p,_]of this._listeners){const b=d===document?this.handleWindowEvent:this.handleEvent;d.addEventListener(p,b,_)}}destroy(){for(const[t,n,c]of this._listeners){const d=t===document?this.handleWindowEvent:this.handleEvent;t.removeEventListener(n,d,c)}}_addDefaultHandlers(t){const n=this._map,c=n.getCanvasContainer();this._add("mapEvent",new g_(n,t));const d=n.boxZoom=new an(n,t);this._add("boxZoom",d);const p=new tc,_=new ra;n.doubleClickZoom=new bo(_,p),this._add("tapZoom",p),this._add("clickZoom",_);const b=new wo;this._add("tapDragZoom",b);const E=n.touchPitch=new v_(n);this._add("touchPitch",E);const I=new ws(t),A=new nc(t);n.dragRotate=new w_(t,I,A),this._add("mouseRotate",I,["mousePitch"]),this._add("mousePitch",A,["mouseRotate"]);const R=new bu(t),D=new ln(n,t);n.dragPan=new b_(c,R,D),this._add("mousePan",R),this._add("touchPan",D,["touchZoom","touchRotate"]);const F=new sc,q=new rp;n.touchZoomRotate=new T_(c,q,F,b),this._add("touchRotate",F,["touchPan","touchZoom"]),this._add("touchZoom",q,["touchPan","touchRotate"]),this._add("blockableMapEvent",new y_(n));const U=n.scrollZoom=new es(n,this);this._add("scrollZoom",U,["mousePan"]);const H=n.keyboard=new _d;this._add("keyboard",H);for(const Z of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[Z]&&n[Z].enable(t[Z])}_add(t,n,c){this._handlers.push({handlerName:t,handler:n,allowed:c}),this._handlersById[t]=n}stop(t){if(!this._updatingCamera){for(const{handler:n}of this._handlers)n.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!wu(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,n,c){for(const d in t)if(d!==c&&(!n||n.indexOf(d)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){const n=[];for(const c of t)this._el.contains(c.target)&&n.push(c);return n}handleEvent(t,n){this._updatingCamera=!0;const c=t.type==="renderFrame",d=c?void 0:t,p={needsRenderFrame:!1},_={},b={},E=t.touches?this._getMapTouches(t.touches):void 0,I=E?Jt(this._el,E):c?void 0:Nt(this._el,t);for(const{handlerName:D,handler:F,allowed:q}of this._handlers){if(!F.isEnabled())continue;let U;this._blockedByActive(b,q,D)?F.reset():F[n||t.type]&&(U=F[n||t.type](t,I,E),this.mergeHandlerResult(p,_,U,D,d),U&&U.needsRenderFrame&&this._triggerRenderFrame()),(U||F.isActive())&&(b[D]=F)}const A={};for(const D in this._previousActiveHandlers)b[D]||(A[D]=d);this._previousActiveHandlers=b,(Object.keys(A).length||Ya(p))&&(this._changes.push([p,_,A]),this._triggerRenderFrame()),(Object.keys(b).length||Ya(p))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:R}=p;R&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],R(this._map))}mergeHandlerResult(t,n,c,d,p){if(!c)return;s.l(t,c);const _={handlerName:d,originalEvent:c.originalEvent||p};c.zoomDelta!==void 0&&(n.zoom=_),c.panDelta!==void 0&&(n.drag=_),c.pitchDelta!==void 0&&(n.pitch=_),c.bearingDelta!==void 0&&(n.rotate=_)}_applyChanges(){const t={},n={},c={};for(const[d,p,_]of this._changes)d.panDelta&&(t.panDelta=(t.panDelta||new s.P(0,0))._add(d.panDelta)),d.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+d.zoomDelta),d.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+d.bearingDelta),d.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+d.pitchDelta),d.around!==void 0&&(t.around=d.around),d.aroundCoord!==void 0&&(t.aroundCoord=d.aroundCoord),d.pinchAround!==void 0&&(t.pinchAround=d.pinchAround),d.noInertia&&(t.noInertia=d.noInertia),s.l(n,p),s.l(c,_);this._updateMapTransform(t,n,c),this._changes=[]}_updateMapTransform(t,n,c){const d=this._map,p=d.transform,_=J=>[J.x,J.y,J.z];if((J=>{const re=this._eventsInProgress.drag;return re&&!this._handlersById[re.handlerName].isActive()})()&&!Ya(t)){const J=p.zoom;p.cameraElevationReference="sea",this._originalZoom!=null&&p._orthographicProjectionAtLowPitch&&p.projection.name!=="globe"&&p.pitch===0?(p.cameraElevationReference="ground",p.zoom=this._originalZoom):(p.recenterOnTerrain(),p.cameraElevationReference="ground"),J!==p.zoom&&this._map._update(!0)}if(p._isCameraConstrained&&d._stop(!0),!Ya(t))return void this._fireEvents(n,c,!0);let{panDelta:b,zoomDelta:E,bearingDelta:I,pitchDelta:A,around:R,aroundCoord:D,pinchAround:F}=t;p._isCameraConstrained&&(E>0&&(E=0),p._isCameraConstrained=!1),F!==void 0&&(R=F),(E||(J=>n[J]&&!this._eventsInProgress[J])("drag"))&&R&&(this._dragOrigin=_(p.pointCoordinate3D(R)),this._originalZoom=p.zoom,this._trackingEllipsoid.setup(p._camera.position,this._dragOrigin)),p.cameraElevationReference="sea",d._stop(!0),R=R||d.transform.centerPoint,I&&(p.bearing+=I),A&&(p.pitch+=A),p._updateCameraState();const q=[0,0,0];if(b)if(p.projection.name==="mercator"){const J=this._trackingEllipsoid.projectRay(p.screenPointToMercatorRay(R).dir),re=this._trackingEllipsoid.projectRay(p.screenPointToMercatorRay(R.sub(b)).dir);q[0]=re[0]-J[0],q[1]=re[1]-J[1]}else{const J=p.pointCoordinate(R);if(p.projection.name==="globe"){b=b.rotate(-p.angle);const re=p._pixelsPerMercatorPixel/p.worldSize;q[0]=-b.x*s.dB(s.aS(J.y))*re,q[1]=-b.y*s.dB(p.center.lat)*re}else{const re=p.pointCoordinate(R.sub(b));J&&re&&(q[0]=re.x-J.x,q[1]=re.y-J.y)}}const U=p.zoom,H=[0,0,0];if(E){const J=_(D||p.pointCoordinate3D(R)),re={dir:s.ab.vec3.normalize([],s.ab.vec3.sub([],J,p._camera.position))};if(re.dir[2]<0){const ne=p.zoomDeltaToMovement(J,E);s.ab.vec3.scale(H,re.dir,ne)}}const Z=s.ab.vec3.add(q,q,H);p._translateCameraConstrained(Z),E&&Math.abs(p.zoom-U)>1e-4&&p.recenterOnTerrain(),p.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(n,c,!0)}_fireEvents(t,n,c){const d=wu(this._eventsInProgress),p=wu(t),_={};for(const A in t){const{originalEvent:R}=t[A];this._eventsInProgress[A]||(_[`${A}start`]=R),this._eventsInProgress[A]=t[A]}!d&&p&&this._fireEvent("movestart",p.originalEvent);for(const A in _)this._fireEvent(A,_[A]);p&&this._fireEvent("move",p.originalEvent);for(const A in t){const{originalEvent:R}=t[A];this._fireEvent(A,R)}const b={};let E;for(const A in this._eventsInProgress){const{handlerName:R,originalEvent:D}=this._eventsInProgress[A];this._handlersById[R].isActive()||(delete this._eventsInProgress[A],E=n[R]||D,b[`${A}end`]=E)}for(const A in b)this._fireEvent(A,b[A]);const I=wu(this._eventsInProgress);if(c&&(d||p)&&!I){this._updatingCamera=!0;const A=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),R=D=>D!==0&&-this._bearingSnap<D&&D<this._bearingSnap;A?(R(A.bearing||this._map.getBearing())&&(A.bearing=0),this._map.easeTo(A,{originalEvent:E})):(this._map.fire(new s.z("moveend",{originalEvent:E})),R(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,n){this._map.fire(new s.z(t,n?{originalEvent:n}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{this._frameId=void 0,this.handleEvent(new op("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const lp="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Ka extends s.E{constructor(t,n){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=n.bearingSnap,this._respectPrefersReducedMotion=n.respectPrefersReducedMotion!==!1,s.aP(["_renderFrameCallback"],this)}getCenter(){return new s.bO(this.transform.center.lng,this.transform.center.lat)}setCenter(t,n){return this.jumpTo({center:t},n)}panBy(t,n,c){return t=s.P.convert(t).mult(-1),this.panTo(this.transform.center,s.l({offset:t},n),c)}panTo(t,n,c){return this.easeTo(s.l({center:t},n),c)}getZoom(){return this.transform.zoom}setZoom(t,n){return this.jumpTo({zoom:t},n),this}zoomTo(t,n,c){return this.easeTo(s.l({zoom:t},n),c)}zoomIn(t,n){return this.zoomTo(this.getZoom()+1,t,n),this}zoomOut(t,n){return this.zoomTo(this.getZoom()-1,t,n),this}getBearing(){return this.transform.bearing}setBearing(t,n){return this.jumpTo({bearing:t},n),this}getPadding(){return this.transform.padding}setPadding(t,n){return this.jumpTo({padding:t},n),this}rotateTo(t,n,c){return this.easeTo(s.l({bearing:t},n),c)}resetNorth(t,n){return this.rotateTo(0,s.l({duration:1e3},t),n),this}resetNorthPitch(t,n){return this.easeTo(s.l({bearing:0,pitch:0,duration:1e3},t),n),this}snapToNorth(t,n){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,n):this}getPitch(){return this.transform.pitch}setPitch(t,n){return this.jumpTo({pitch:t},n),this}cameraForBounds(t,n){t=s.az.convert(t);const c=n&&n.bearing||0,d=n&&n.pitch||0,p=t.getNorthWest(),_=t.getSouthEast();return this._cameraForBounds(this.transform,p,_,c,d,n)}_extendPadding(t){const n={top:0,right:0,bottom:0,left:0};return t==null?s.l({},n,this.transform.padding):typeof t=="number"?{top:t,bottom:t,right:t,left:t}:s.l({},n,t)}_extendCameraOptions(t){return(t=s.l({offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding=this._extendPadding(t.padding),t}_minimumAABBFrustumDistance(t,n){const c=n.max[0]-n.min[0],d=n.max[1]-n.min[1];return c/d>t.aspect?c/(2*Math.tan(.5*t.fovX)*t.aspect):d/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,n,c,d,p,_){const b=t.clone(),E=this._extendCameraOptions(_);b.bearing=d,b.pitch=p;const I=s.bO.convert(n),A=s.bO.convert(c),R=.5*(I.lat+A.lat),D=.5*(I.lng+A.lng),F=s.dC(R,D),q=s.ab.vec3.normalize([],F),U=s.ab.vec3.normalize([],s.ab.vec3.cross([],q,[0,1,0])),H=s.ab.vec3.cross([],U,q),Z=[U[0],U[1],U[2],0,H[0],H[1],H[2],0,q[0],q[1],q[2],0,0,0,0,1],J=[F,s.dC(I.lat,I.lng),s.dC(A.lat,I.lng),s.dC(A.lat,A.lng),s.dC(I.lat,A.lng),s.dC(R,I.lng),s.dC(R,A.lng),s.dC(I.lat,D),s.dC(A.lat,D)];let re=s.cd.fromPoints(J.map(Ge=>[s.ab.vec3.dot(U,Ge),s.ab.vec3.dot(H,Ge),s.ab.vec3.dot(q,Ge)]));const ne=s.ab.vec3.transformMat4([],re.center,Z);s.ab.vec3.squaredLength(ne)===0&&s.ab.vec3.set(ne,0,0,1),s.ab.vec3.normalize(ne,ne),s.ab.vec3.scale(ne,ne,s.ax),b.center=s.dD(ne);const de=b.getWorldToCameraMatrix(),le=s.ab.mat4.invert(new Float64Array(16),de);re=s.cd.applyTransform(re,s.ab.mat4.multiply([],de,Z));const he=this._extendAABB(re,b,E,d);if(!he)return void s.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");re=he,s.ab.vec3.transformMat4(ne,ne,de);const ae=.5*(re.max[2]-re.min[2]),ge=this._minimumAABBFrustumDistance(b,re),Te=s.ab.vec3.scale([],[0,0,1],ae),Ue=s.ab.vec3.add(Te,ne,Te),Le=ge+(b.pitch===0?0:s.ab.vec3.distance(ne,Ue)),He=b.globeCenterInViewSpace,Ze=s.ab.vec3.sub([],ne,[He[0],He[1],He[2]]);s.ab.vec3.normalize(Ze,Ze),s.ab.vec3.scale(Ze,Ze,Le);const ze=s.ab.vec3.add([],ne,Ze);s.ab.vec3.transformMat4(ze,ze,le);const je=s.ds/s.ax,it=s.ab.vec3.length(ze),Ce=s.bH(Math.max(it*je-s.ds,Number.EPSILON),0),Ye=Math.min(b.zoomFromMercatorZAdjusted(Ce),E.maxZoom);return Ye>.5*(s.c6+s.bY)?(b.setProjection({name:"mercator"}),b.zoom=Ye,this._cameraForBounds(b,n,c,d,p,_)):{center:b.center,zoom:Ye,bearing:d,pitch:p}}_extendAABB(t,n,c,d){const p=.5*((c.padding.left||0)+(c.padding.right||0)),_=.5*((c.padding.top||0)+(c.padding.bottom||0)),b=_,E=p,I=p,A=_,R=n.width-(E+I),D=n.height-(b+A),F=s.ab.vec3.sub([],t.max,t.min),q=Math.min(R/F[0],D/F[1]),U=Math.min(n.scaleZoom(n.scale*q),c.maxZoom);if(isNaN(U))return null;const H=n.scale/n.zoomScale(U),Z=new s.cd([t.min[0]-E*H,t.min[1]-A*H,t.min[2]],[t.max[0]+I*H,t.max[1]+b*H,t.max[2]]),J=(typeof c.offset.x=="number"&&typeof c.offset.y=="number"?new s.P(c.offset.x,c.offset.y):s.P.convert(c.offset)).rotate(-s.ai(d));return Z.center[0]-=J.x*H,Z.center[1]+=J.y*H,Z}queryTerrainElevation(t,n){const c=this.transform.elevation;return c?(n=s.l({},{exaggerated:!0},n),c.getAtPoint(s.aa.fromLngLat(t),null,n.exaggerated)):null}_cameraForBounds(t,n,c,d,p,_){if(t.projection.name==="globe")return this._cameraForBoundsOnGlobe(t,n,c,d,p,_);const b=t.clone(),E=this._extendCameraOptions(_);b.bearing=d,b.pitch=p;const I=s.bO.convert(n),A=s.bO.convert(c),R=new s.bO(I.lng,A.lat),D=new s.bO(A.lng,I.lat),F=b.project(I),q=b.project(A),U=this.queryTerrainElevation(I),H=this.queryTerrainElevation(A),Z=this.queryTerrainElevation(R),J=this.queryTerrainElevation(D),re=[[F.x,F.y,Math.min(U||0,H||0,Z||0,J||0)],[q.x,q.y,Math.max(U||0,H||0,Z||0,J||0)]];let ne=s.cd.fromPoints(re);const de=b.getWorldToCameraMatrix(),le=s.ab.mat4.invert(new Float64Array(16),de);ne=s.cd.applyTransform(ne,de);const he=this._extendAABB(ne,b,E,d);if(!he)return void s.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");ne=he;const ae=.5*s.ab.vec3.sub([],ne.max,ne.min)[2],ge=this._minimumAABBFrustumDistance(b,ne),Te=[0,0,1,0];s.ab.vec4.transformMat4(Te,Te,de),s.ab.vec4.normalize(Te,Te);const Ue=s.ab.vec3.scale([],Te,ge+ae),Le=s.ab.vec3.add([],ne.center,Ue);s.ab.vec3.transformMat4(ne.center,ne.center,le),s.ab.vec3.transformMat4(Le,Le,le);const He=b.unproject(new s.P(ne.center[0],ne.center[1])),Ze=s.dE(b.projection,He),ze=Math.pow(2,Ze),je=Math.min(b._zoomFromMercatorZ(Le[2]*b.pixelsPerMeter*ze/b.worldSize),E.maxZoom);return b.mercatorFromTransition&&je<.5*(s.c6+s.bY)?(b.setProjection({name:"globe"}),b.zoom=je,this._cameraForBounds(b,n,c,d,p,_)):{center:He,zoom:je,bearing:d,pitch:p}}fitBounds(t,n,c){const d=this.cameraForBounds(t,n);return this._fitInternal(d,n,c)}fitScreenCoordinates(t,n,c,d,p){const _=s.P.convert(t),b=s.P.convert(n),E=new s.P(Math.min(_.x,b.x),Math.min(_.y,b.y)),I=new s.P(Math.max(_.x,b.x),Math.max(_.y,b.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(_,b))return this;const A=this.transform.pointLocation3D(E),R=this.transform.pointLocation3D(I),D=this.transform.pointLocation3D(new s.P(E.x,I.y)),F=this.transform.pointLocation3D(new s.P(I.x,E.y)),q=[Math.min(A.lng,R.lng,D.lng,F.lng),Math.min(A.lat,R.lat,D.lat,F.lat)],U=[Math.max(A.lng,R.lng,D.lng,F.lng),Math.max(A.lat,R.lat,D.lat,F.lat)],H=d&&d.pitch?d.pitch:this.getPitch(),Z=this._cameraForBounds(this.transform,q,U,c,H,d);return this._fitInternal(Z,d,p)}_fitInternal(t,n,c){return t?(n=s.l(t,n)).linear?this.easeTo(n,c):this.flyTo(n,c):this}jumpTo(t,n){this.stop();const c=t.preloadOnly?this.transform.clone():this.transform;let d=!1,p=!1,_=!1;"zoom"in t&&c.zoom!==+t.zoom&&(d=!0,c.zoom=+t.zoom),t.center!==void 0&&(c.center=s.bO.convert(t.center)),"bearing"in t&&c.bearing!==+t.bearing&&(p=!0,c.bearing=+t.bearing),"pitch"in t&&c.pitch!==+t.pitch&&(_=!0,c.pitch=+t.pitch);const b=typeof t.padding=="number"?this._extendPadding(t.padding):t.padding;if(t.padding!=null&&!c.isPaddingEqual(b))if(t.retainPadding===!1){const E=c.clone();E.padding=b,c.setLocationAtPoint(c.center,E.centerPoint)}else c.padding=b;return t.preloadOnly?(this._preloadTiles(c),this):(this.fire(new s.z("movestart",n)).fire(new s.z("move",n)),d&&this.fire(new s.z("zoomstart",n)).fire(new s.z("zoom",n)).fire(new s.z("zoomend",n)),p&&this.fire(new s.z("rotatestart",n)).fire(new s.z("rotate",n)).fire(new s.z("rotateend",n)),_&&this.fire(new s.z("pitchstart",n)).fire(new s.z("pitch",n)).fire(new s.z("pitchend",n)),this.fire(new s.z("moveend",n)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||s.w(lp),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,n){const c=this.transform;if(!c.projection.supportsFreeCamera)return s.w(lp),this;this.stop();const d=c.zoom,p=c.pitch,_=c.bearing;c.setFreeCameraOptions(t);const b=d!==c.zoom,E=p!==c.pitch,I=_!==c.bearing;return this.fire(new s.z("movestart",n)).fire(new s.z("move",n)),b&&this.fire(new s.z("zoomstart",n)).fire(new s.z("zoom",n)).fire(new s.z("zoomend",n)),I&&this.fire(new s.z("rotatestart",n)).fire(new s.z("rotate",n)).fire(new s.z("rotateend",n)),E&&this.fire(new s.z("pitchstart",n)).fire(new s.z("pitch",n)).fire(new s.z("pitchend",n)),this.fire(new s.z("moveend",n)),this}easeTo(t,n){this._stop(!1,t.easeId),((t=s.l({offset:[0,0],duration:500,easing:s.dA},t)).animate===!1||this._prefersReducedMotion(t))&&(t.duration=0);const c=this.transform,d=this.getZoom(),p=this.getBearing(),_=this.getPitch(),b=this.getPadding(),E="zoom"in t?+t.zoom:d,I="bearing"in t?this._normalizeBearing(t.bearing,p):p,A="pitch"in t?+t.pitch:_,R=this._extendPadding(t.padding),D=s.P.convert(t.offset);let F,q,U;if(c.projection.name==="globe"){const Te=s.aa.fromLngLat(c.center),Ue=D.rotate(-c.angle);Te.x+=Ue.x/c.worldSize,Te.y+=Ue.y/c.worldSize;const Le=Te.toLngLat(),He=s.bO.convert(t.center||Le);this._normalizeCenter(He),F=c.centerPoint.add(Ue),q=new s.P(Te.x,Te.y).mult(c.worldSize),U=new s.P(s.at(He.lng),s.aA(He.lat)).mult(c.worldSize).sub(q)}else{F=c.centerPoint.add(D);const Te=c.pointLocation(F),Ue=s.bO.convert(t.center||Te);this._normalizeCenter(Ue),q=c.project(Te),U=c.project(Ue).sub(q)}const H=c.zoomScale(E-d);let Z,J;t.around&&(Z=s.bO.convert(t.around),J=c.locationPoint(Z));const re=this._zooming||E!==d,ne=this._rotating||p!==I,de=this._pitching||A!==_,le=!c.isPaddingEqual(R),he=t.retainPadding===!1?c.clone():c,ae=Te=>Ue=>{if(re&&(Te.zoom=s.af(d,E,Ue)),ne&&(Te.bearing=s.af(p,I,Ue)),de&&(Te.pitch=s.af(_,A,Ue)),le&&(he.interpolatePadding(b,R,Ue),F=he.centerPoint.add(D)),Z)Te.setLocationAtPoint(Z,J);else{const Le=Te.zoomScale(Te.zoom-d),He=E>d?Math.min(2,H):Math.max(.5,H),Ze=Math.pow(He,1-Ue),ze=Te.unproject(q.add(U.mult(Ue*Ze)).mult(Le));Te.setLocationAtPoint(Te.renderWorldCopies?ze.wrap():ze,F)}return t.preloadOnly||this._fireMoveEvents(n),Te};if(t.preloadOnly){const Te=this._emulate(ae,t.duration,c);return this._preloadTiles(Te),this}const ge={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=re,this._rotating=ne,this._pitching=de,this._padding=le,this._easeId=t.easeId,this._prepareEase(n,t.noMoveStart,ge),this._ease(ae(c),Te=>{c.cameraElevationReference==="sea"&&c.recenterOnTerrain(),this._afterEase(n,Te)},t),this}_prepareEase(t,n,c={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),n||c.moving||this.fire(new s.z("movestart",t)),this._zooming&&!c.zooming&&this.fire(new s.z("zoomstart",t)),this._rotating&&!c.rotating&&this.fire(new s.z("rotatestart",t)),this._pitching&&!c.pitching&&this.fire(new s.z("pitchstart",t))}_fireMoveEvents(t){this.fire(new s.z("move",t)),this._zooming&&this.fire(new s.z("zoom",t)),this._rotating&&this.fire(new s.z("rotate",t)),this._pitching&&this.fire(new s.z("pitch",t))}_afterEase(t,n){if(this._easeId&&n&&this._easeId===n)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const c=this._zooming,d=this._rotating,p=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,c&&this.fire(new s.z("zoomend",t)),d&&this.fire(new s.z("rotateend",t)),p&&this.fire(new s.z("pitchend",t)),this.fire(new s.z("moveend",t))}flyTo(t,n){if(this._prefersReducedMotion(t)){const Ge=s.ay(t,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Ge,n)}this.stop(),t=s.l({offset:[0,0],speed:1.2,curve:1.42,easing:s.dA},t);const c=this.transform,d=this.getZoom(),p=this.getBearing(),_=this.getPitch(),b=this.getPadding(),E="zoom"in t?s.aw(+t.zoom,c.minZoom,c.maxZoom):d,I="bearing"in t?this._normalizeBearing(t.bearing,p):p,A="pitch"in t?+t.pitch:_,R=this._extendPadding(t.padding),D=c.zoomScale(E-d),F=s.P.convert(t.offset);let q=c.centerPoint.add(F);const U=c.pointLocation(q),H=s.bO.convert(t.center||U);this._normalizeCenter(H);const Z=c.project(U),J=c.project(H).sub(Z);let re=t.curve;const ne=Math.max(c.width,c.height),de=ne/D,le=J.mag();if("minZoom"in t){const Ge=s.aw(Math.min(t.minZoom,d,E),c.minZoom,c.maxZoom),ut=ne/c.zoomScale(Ge-d);re=Math.sqrt(ut/le*2)}const he=re*re;function ae(Ge){const ut=(de*de-ne*ne+(Ge?-1:1)*he*he*le*le)/(2*(Ge?de:ne)*he*le);return Math.log(Math.sqrt(ut*ut+1)-ut)}function ge(Ge){return(Math.exp(Ge)-Math.exp(-Ge))/2}function Te(Ge){return(Math.exp(Ge)+Math.exp(-Ge))/2}const Ue=ae(0);let Le=function(Ge){return Te(Ue)/Te(Ue+re*Ge)},He=function(Ge){return ne*((Te(Ue)*(ge(ut=Ue+re*Ge)/Te(ut))-ge(Ue))/he)/le;var ut},Ze=(ae(1)-Ue)/re;if(Math.abs(le)<1e-6||!isFinite(Ze)){if(Math.abs(ne-de)<1e-6)return this.easeTo(t,n);const Ge=de<ne?-1:1;Ze=Math.abs(Math.log(de/ne))/re,He=function(){return 0},Le=function(ut){return Math.exp(Ge*re*ut)}}t.duration="duration"in t?+t.duration:1e3*Ze/("screenSpeed"in t?+t.screenSpeed/re:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);const ze=p!==I,je=A!==_,it=!c.isPaddingEqual(R),Ce=t.retainPadding===!1?c.clone():c,Ye=Ge=>ut=>{const Je=ut*Ze,Xe=1/Le(Je);Ge.zoom=ut===1?E:d+Ge.scaleZoom(Xe),ze&&(Ge.bearing=s.af(p,I,ut)),je&&(Ge.pitch=s.af(_,A,ut)),it&&(Ce.interpolatePadding(b,R,ut),q=Ce.centerPoint.add(F));const nt=ut===1?H:Ge.unproject(Z.add(J.mult(He(Je))).mult(Xe));return Ge.setLocationAtPoint(Ge.renderWorldCopies?nt.wrap():nt,q),Ge._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(n),Ge};if(t.preloadOnly){const Ge=this._emulate(Ye,t.duration,c);return this._preloadTiles(Ge),this}return this._zooming=!0,this._rotating=ze,this._pitching=je,this._padding=it,this._prepareEase(n,!1),this._ease(Ye(c),()=>this._afterEase(n),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(t){}_cancelRenderFrame(t){}_stop(t,n){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const c=this._onEaseEnd;this._onEaseEnd=void 0,c.call(this,n)}if(!t){const c=this.handlers;c&&c.stop(!1)}return this}_ease(t,n,c){c.animate===!1||c.duration===0?(t(1),n()):(this._easeStart=s.q.now(),this._easeOptions=c,this._onEaseFrame=t,this._onEaseEnd=n,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const t=Math.min((s.q.now()-this._easeStart)/this._easeOptions.duration,1),n=this._onEaseFrame;n&&n(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,n){t=s.bF(t,-180,180);const c=Math.abs(t-n);return Math.abs(t-360-n)<c&&(t-=360),Math.abs(t+360-n)<c&&(t+=360),t}_normalizeCenter(t){const n=this.transform;if(n.maxBounds||n.projection.name!=="globe"&&!n.renderWorldCopies)return;const c=t.lng-n.center.lng;t.lng+=c>180?-360:c<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&s.q.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,n,c){const d=Math.ceil(15*n/1e3),p=[],_=t(c.clone());for(let b=0;b<=d;b++){const E=_(b/d);p.push(E.clone())}return p}_preloadTiles(t,n){}}class Tu{constructor(t={}){this.options=t,s.aP(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){const n=this.options&&this.options.compact,c=t._getUIString("AttributionControl.ToggleAttribution");this._map=t,this._container=We("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=We("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",c);const d=We("span","mapboxgl-ctrl-icon",this._compactButton);return d.setAttribute("aria-hidden","true"),d.setAttribute("title",c),this._innerContainer=We("div","mapboxgl-ctrl-attrib-inner",this._container),n&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),n===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));const n=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||s.e.ACCESS_TOKEN}];if(t){const c=n.reduce((d,p,_)=>(p.value&&(d+=`${p.key}=${p.value}${_<n.length-1?"&":""}`),d),"?");t.href=`${s.e.FEEDBACK_URL}/${c}#${dd(this._map,!0)}`,t.rel="noopener nofollow"}}_updateData(t){!t||t.sourceDataType!=="metadata"&&t.sourceDataType!=="visibility"&&t.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){const d=this._map.style.stylesheet;this.styleOwner=d.owner,this.styleId=d.id}const n=this._map.style._mergedSourceCaches;for(const d in n){const p=n[d];if(p.used){const _=p.getSource();_.attribution&&t.indexOf(_.attribution)<0&&t.push(_.attribution)}}t.sort((d,p)=>d.length-p.length),t=t.filter((d,p)=>{for(let _=p+1;_<t.length;_++)if(t[_].indexOf(d)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));const c=t.join(" | ");c!==this._attribHTML&&(this._attribHTML=c,t.length?(this._innerContainer.innerHTML=c,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Cr{constructor(){s.aP(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=We("div","mapboxgl-ctrl");const n=We("a","mapboxgl-ctrl-logo");return n.target="_blank",n.rel="noopener nofollow",n.href="https://www.mapbox.com/",n.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),n.setAttribute("rel","noopener nofollow"),this._container.appendChild(n),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&t.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const t=this._map.style._sourceCaches;if(Object.entries(t).length===0)return!0;for(const n in t){const c=t[n].getSource();if(c.hasOwnProperty("mapbox_logo")&&!c.mapbox_logo)return!1}return!0}_updateCompact(){const t=this._container.children;if(t.length){const n=t[0];this._map.getCanvasContainer().offsetWidth<250?n.classList.add("mapboxgl-compact"):n.classList.remove("mapboxgl-compact")}}}class Pr{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const n=++this._id;return this._queue.push({callback:t,id:n,cancelled:!1}),n}remove(t){const n=this._currentlyRunning,c=n?this._queue.concat(n):this._queue;for(const d of c)if(d.id===t)return void(d.cancelled=!0)}run(t=0){const n=this._currentlyRunning=this._queue;this._queue=[];for(const c of n)if(!c.cancelled&&(c.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class Ja{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;const n=s.cB((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-n)+this._end*n}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,n,c){this._start=this.getValue(n),this._end=t,this._startTime=n,this._endTime=n+c}}const sa={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use ⌘ + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class oa extends s.z{constructor(t,n,c,d){const{point:p,lngLat:_,originalEvent:b,target:E}=t;super(t.type,{point:p,lngLat:_,originalEvent:b,target:E}),this.preventDefault=()=>{t.preventDefault()},this.id=n,this.interaction=c,this.feature=d}}class gd{constructor(t){this.map=t,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(t,n){if(this.typeById.has(t))throw new Error(`Interaction id "${t}" already exists.`);const c=n.filter;let d=n.type;c&&this.filters.set(t,s.aZ(c)),d==="mouseover"&&(d="mouseenter"),d==="mouseout"&&(d="mouseleave");const p=this.interactionsByType.get(d)||new Map;d==="mouseenter"||d==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(t,n)):p.size===0&&this.map.on(d,this.handleType),p.size===0&&this.interactionsByType.set(d,p),p.set(t,n),this.typeById.set(t,d)}get(t){const n=this.typeById.get(t);if(!n)return;const c=this.interactionsByType.get(n);return c?c.get(t):void 0}remove(t){const n=this.typeById.get(t);if(!n)return;this.typeById.delete(t),this.filters.delete(t);const c=this.interactionsByType.get(n);c&&(c.delete(t),n==="mouseenter"||n==="mouseleave"?(this.delegatedInteractions.delete(t),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):c.size===0&&this.map.off(n,this.handleType))}queryTargets(t,n){const c=[];for(const[d,p]of n)p.target&&c.push({targetId:d,target:p.target,filter:this.filters.get(d)});return this.map.style.queryRenderedTargets(t,c,this.map.transform)}handleMove(t){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const n=this.queryTargets(t.point,Array.from(this.delegatedInteractions).reverse());n.length&&(t.type="mouseenter",this.handleType(t,n));const c=new Map;for(const[d,{feature:p}]of this.prevHoveredFeatures)this.hoveredFeatures.has(d)||c.set(p.id,p);c.size&&(t.type="mouseleave",this.handleType(t,Array.from(c.values())))}handleOut(t){const n=Array.from(this.hoveredFeatures.values()).map(({feature:c})=>c);n.length&&(t.type="mouseleave",this.handleType(t,n)),this.hoveredFeatures.clear()}handleType(t,n){const c=Array.from(this.interactionsByType.get(t.type)).reverse(),d=!!n;n=n||this.queryTargets(t.point,c);const p=t.type==="mouseenter";let _=!1;const b=new Set;for(const E of n){for(const[I,A]of c){if(!A.target)continue;const R=E.variants?E.variants[I]:null;if(R){for(const D of R){if(js(D,E,b,I))continue;const F=new s.cw(E,D),q=ml(D,E,I);d&&(F.state=this.map.getFeatureState(F));const U=p?this.prevHoveredFeatures.get(q):null,H=new oa(t,I,A,F),Z=U?U.stop:A.handler(H);if(p&&this.hoveredFeatures.set(q,{feature:E,stop:Z}),Z!==!1){_=!0;break}}if(_)break}}if(_)break}if(!_)for(const[E,I]of c){const{handler:A,target:R}=I;if(!R&&A(new oa(t,E,I,null))!==!1)break}}}function bi(l,t){if(Array.isArray(l)&&Array.isArray(t)){const n=new Set(l),c=new Set(t);return n.size===c.size&&l.every(d=>c.has(d))}return s.bn(l,t)}const To={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},S_={showCompass:!0,showZoom:!0,visualizePitch:!1};class E_{constructor(t,n,c=!1){this._clickTolerance=10,this.element=n,this.mouseRotate=new ws({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,c&&(this.mousePitch=new nc({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),s.aP(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),n.addEventListener("mousedown",this.mousedown),n.addEventListener("touchstart",this.touchstart,{passive:!1}),n.addEventListener("touchmove",this.touchmove),n.addEventListener("touchend",this.touchend),n.addEventListener("touchcancel",this.reset)}down(t,n){this.mouseRotate.mousedown(t,n),this.mousePitch&&this.mousePitch.mousedown(t,n),ot()}move(t,n){const c=this.map,d=this.mouseRotate.mousemoveWindow(t,n),p=d&&d.bearingDelta;if(p&&c.setBearing(c.getBearing()+p),this.mousePitch){const _=this.mousePitch.mousemoveWindow(t,n),b=_&&_.pitchDelta;b&&c.setPitch(c.getPitch()+b)}}off(){const t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart,{passive:!1}),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){zt(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(s.l({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),Nt(this.element,t)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,Nt(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){t.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=Jt(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){t.targetTouches.length!==1?this.reset():(this._lastPos=Jt(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){t.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function Su(l,t,n){if(l=new s.bO(l.lng,l.lat),t){const c=new s.bO(l.lng-360,l.lat),d=new s.bO(l.lng+360,l.lat),p=360*Math.ceil(Math.abs(l.lng-n.center.lng)/360),_=n.locationPoint(l).distSqr(t),b=t.x<0||t.y<0||t.x>n.width||t.y>n.height;n.locationPoint(c).distSqr(t)<_&&(b||Math.abs(c.lng-n.center.lng)<p)?l=c:n.locationPoint(d).distSqr(t)<_&&(b||Math.abs(d.lng-n.center.lng)<p)&&(l=d)}for(;Math.abs(l.lng-n.center.lng)>180;){const c=n.locationPoint(l);if(c.x>=0&&c.y>=0&&c.x<=n.width&&c.y<=n.height)break;l.lng>n.center.lng?l.lng-=360:l.lng+=360}return l}const Ts={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class ts extends s.E{constructor(t,n){if(super(),(t instanceof HTMLElement||n)&&(t=s.l({element:t},n)),s.aP(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=t&&t.anchor||"center",this._color=t&&t.color||"#3FB1CE",this._scale=t&&t.scale||1,this._draggable=t&&t.draggable||!1,this._clickTolerance=t&&t.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=t&&t.rotation||0,this._rotationAlignment=t&&t.rotationAlignment||"auto",this._pitchAlignment=t&&t.pitchAlignment&&t.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=t&&t.occludedOpacity||.2,t&&t.element)this._element=t.element,this._offset=s.P.convert(t&&t.offset||[0,0]);else{this._defaultMarker=!0,this._element=We("div");const p=41,_=27,b=st("svg",{display:"block",height:p*this._scale+"px",width:_*this._scale+"px",viewBox:`0 0 ${_} ${p}`},this._element),E=st("radialGradient",{id:"shadowGradient"},st("defs",{},b));st("stop",{offset:"10%","stop-opacity":.4},E),st("stop",{offset:"100%","stop-opacity":.05},E),st("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},b),st("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},b),st("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},b),st("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},b),this._offset=s.P.convert(t&&t.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",p=>{p.preventDefault()}),this._element.addEventListener("mousedown",p=>{p.preventDefault()});const c=this._element.classList;for(const p in Ts)c.remove(`mapboxgl-marker-anchor-${p}`);c.add(`mapboxgl-marker-anchor-${this._anchor}`);const d=t&&t.className?t.className.trim().split(/\s+/):[];c.add(...d),this._popup=null}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){const t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=s.bO.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const d=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[d,-1*(38.1-13.5+d)],"bottom-right":[-d,-1*(38.1-13.5+d)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,t._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){const n=t.code,c=t.charCode||t.keyCode;n!=="Space"&&n!=="Enter"&&c!==32&&c!==13||this.togglePopup()}_onMapClick(t){const n=t.originalEvent.target,c=this._element;this._popup&&(n===c||c.contains(n))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const t=this._map,n=this._pos;if(!t||!n)return!1;const c=t.unproject(n),d=t.getFreeCameraOptions();if(!d.position)return!1;const p=d.position.toLngLat();return p.distanceTo(c)<.9*p.distanceTo(this._lngLat)}_evaluateOpacity(){const t=this._map;if(!t)return;const n=this._pos;if(!n||n.x<0||n.x>t.transform.width||n.y<0||n.y>t.transform.height)return void this._clearFadeTimer();const c=t.unproject(n);let d;t._showingGlobe()&&s.dH(t.transform,this._lngLat)?d=0:(d=1-t._queryFogOpacity(c),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(d*=this._occludedOpacity)),this._element.style.opacity=`${d}`,this._element.style.pointerEvents=d>0?"auto":"none",this._popup&&this._popup._setOpacity(d),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const t=this._pos;if(!t||!this._map)return;const n=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${t.x}px,${t.y}px)
            ${Ts[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${n.x}px,${n.y}px)
        `}_calculateXYTransform(){const t=this._pos,n=this._map,c=this.getPitchAlignment();if(!n||!t||c!=="map")return"";if(!n._showingGlobe()){const E=n.getPitch();return E?`rotateX(${E}deg)`:""}const d=s.c4(s.dI(n.transform,this._lngLat)),p=t.sub(s.dJ(n.transform)),_=Math.abs(p.x)+Math.abs(p.y);if(_===0)return"";const b=d/_;return`rotateX(${-p.y*b}deg) rotateY(${p.x*b}deg)`}_calculateZTransform(){const t=this._pos,n=this._map;if(!n||!t)return"";let c=0;const d=this.getRotationAlignment();if(d==="map")if(n._showingGlobe()){const p=n.project(new s.bO(this._lngLat.lng,this._lngLat.lat+.001)),_=n.project(new s.bO(this._lngLat.lng,this._lngLat.lat-.001)).sub(p);c=s.c4(Math.atan2(_.y,_.x))-90}else c=-n.getBearing();else if(d==="horizon"){const p=s.ac(4,6,n.getZoom()),_=s.dJ(n.transform);_.y+=p*n.transform.height;const b=t.sub(_),E=s.c4(Math.atan2(b.y,b.x));c=(E>90?E-270:E+90)*(1-p)}return c+=this._rotation,c?`rotateZ(${c}deg)`:""}_update(t){cancelAnimationFrame(this._updateFrameId);const n=this._map;n&&(n.transform.renderWorldCopies&&(this._lngLat=Su(this._lngLat,this._pos,n.transform)),this._pos=n.project(this._lngLat),t===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),n._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(n._showingGlobe()||n.getTerrain()||n.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(t){return this._offset=s.P.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){const n=this._map;if(!n)return;const c=this._pointerdownPos,d=this._positionDelta;if(c&&d){if(!this._isDragging){const p=this._clickTolerance||n._clickTolerance;if(t.point.dist(c)<p)return;this._isDragging=!0}this._pos=t.point.sub(d),this._lngLat=n.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new s.z("dragstart"))),this.fire(new s.z("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new s.z("dragend")),this._state="inactive"}_addDragHandler(t){const n=this._map,c=this._pos;n&&c&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(c),this._pointerdownPos=t.point,this._state="pending",n.on("mousemove",this._onMove),n.on("touchmove",this._onMove),n.once("mouseup",this._onUp),n.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;const n=this._map;return n&&(t?(n.on("mousedown",this._addDragHandler),n.on("touchstart",this._addDragHandler)):(n.off("mousedown",this._addDragHandler),n.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||"auto",this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const cr={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Tr={maxWidth:100,unit:"metric"},qn={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},cp={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},_r=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function yd(l=new s.P(0,0),t="bottom"){if(typeof l=="number"){const n=Math.round(Math.sqrt(.5*Math.pow(l,2)));switch(t){case"top":return new s.P(0,l);case"top-left":return new s.P(n,n);case"top-right":return new s.P(-n,n);case"bottom":return new s.P(0,-l);case"bottom-left":return new s.P(n,-n);case"bottom-right":return new s.P(-n,-n);case"left":return new s.P(l,0);case"right":return new s.P(-l,0)}return new s.P(0,0)}return l instanceof s.P||Array.isArray(l)?s.P.convert(l):s.P.convert(l[t]||[0,0])}return{version:_e,supported:Ve.supported,setRTLTextPlugin:s.dK,getRTLTextPluginStatus:s.dL,Map:class extends Ka{constructor(l){oe.mark(ce.create);const t=l;if((l=s.l({},To,l)).minZoom!=null&&l.maxZoom!=null&&l.minZoom>l.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(l.minPitch!=null&&l.maxPitch!=null&&l.minPitch>l.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(l.minPitch!=null&&l.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(l.maxPitch!=null&&l.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(l.antialias&&s.dF(window)&&(l.antialias=!1,s.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Il(l.minZoom,l.maxZoom,l.minPitch,l.maxPitch,l.renderWorldCopies),l),this._repaint=!!l.repaint,this._interactive=l.interactive,this._minTileCacheSize=l.minTileCacheSize,this._maxTileCacheSize=l.maxTileCacheSize,this._failIfMajorPerformanceCaveat=l.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=l.preserveDrawingBuffer,this._antialias=l.antialias,this._trackResize=l.trackResize,this._bearingSnap=l.bearingSnap,this._refreshExpiredTiles=l.refreshExpiredTiles,this._fadeDuration=l.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=l.crossSourceCollisions,this._collectResourceTiming=l.collectResourceTiming,this._language=this._parseLanguage(l.language),this._worldview=l.worldview,this._renderTaskQueue=new Pr,this._domRenderTaskQueue=new Pr,this._controls=[],this._markers=[],this._popups=[],this._mapId=s.aV(),this._locale=s.l({},sa,l.locale),this._clickTolerance=l.clickTolerance,this._cooperativeGestures=l.cooperativeGestures,this._performanceMetricsCollection=l.performanceMetricsCollection,this._tessellationStep=l.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=l.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new Ja(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=l.scaleFactor,this._requestManager=new Oi(l.transformRequest,l.accessToken,l.testMode),this._silenceAuthErrors=!!l.testMode,this._contextCreateOptions=l.contextCreateOptions?Object.assign({},l.contextCreateOptions):{},typeof l.container=="string"){const n=document.getElementById(l.container);if(!n)throw new Error(`Container '${l.container.toString()}' not found.`);this._container=n}else{if(!(l.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=l.container}if(this._container.childNodes.length>0&&s.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),l.maxBounds&&this.setMaxBounds(l.maxBounds),this._spriteFormat=l.spriteFormat,s.aP(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new od),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},()=>{this.setScaleFactor(this._scaleFactor)}),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new ap(this,l),this._localFontFamily=l.localFontFamily,this._localIdeographFontFamily=l.localIdeographFontFamily,(l.style||!l.testMode)&&this.setStyle(l.style||s.e.DEFAULT_STYLE,{config:l.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),l.projection&&this.setProjection(l.projection),this.indoor=new wh(this),l.hash&&(this._hash=new Yf(typeof l.hash=="string"&&l.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){t.center==null&&t.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:l.center,zoom:l.zoom,bearing:l.bearing,pitch:l.pitch});const n=l.bounds;n&&(this.resize(),this.fitBounds(n,s.l({},l.fitBoundsOptions,{duration:0})))}this.resize(),l.attributionControl&&this.addControl(new Tu({customAttribution:l.customAttribution})),this._logoControl=new Cr,this.addControl(this._logoControl,l.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()}),this.on("data",n=>{this._update(n.dataType==="style"),this.fire(new s.z(`${n.dataType}data`,n))}),this.on("dataloading",n=>{this.fire(new s.z(`${n.dataType}dataloading`,n))}),this._interactions=new gd(this)}_getMapId(){return this._mapId}addControl(l,t){if(t===void 0&&(t=l.getDefaultPosition?l.getDefaultPosition():"top-right"),!l||!l.onAdd)return this.fire(new s.y(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const n=l.onAdd(this);this._controls.push(l);const c=this._controlPositions[t];return t.indexOf("bottom")!==-1?c.insertBefore(n,c.firstChild):c.appendChild(n),this}removeControl(l){if(!l||!l.onRemove)return this.fire(new s.y(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(l);return t>-1&&this._controls.splice(t,1),l.onRemove(this),this}hasControl(l){return this._controls.indexOf(l)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(l){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const t=!this._moving;return t&&this.fire(new s.z("movestart",l)).fire(new s.z("move",l)),this.fire(new s.z("resize",l)),t&&this.fire(new s.z("moveend",l)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(l){return this.transform.setMaxBounds(s.az.convert(l)),this._update()}setMinZoom(l){if((l=l??-2)>=-2&&l<=this.transform.maxZoom)return this.transform.minZoom=l,this._update(),this.getZoom()<l?this.setZoom(l):this.fire(new s.z("zoomstart")).fire(new s.z("zoom")).fire(new s.z("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(l){if((l=l??22)>=this.transform.minZoom)return this.transform.maxZoom=l,this._update(),this.getZoom()>l?this.setZoom(l):this.fire(new s.z("zoomstart")).fire(new s.z("zoom")).fire(new s.z("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(l){if((l=l??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(l>=0&&l<=this.transform.maxPitch)return this.transform.minPitch=l,this._update(),this.getPitch()<l?this.setPitch(l):this.fire(new s.z("pitchstart")).fire(new s.z("pitch")).fire(new s.z("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(l){if((l=l??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(l>=this.transform.minPitch)return this.transform.maxPitch=l,this._update(),this.getPitch()>l?this.setPitch(l):this.fire(new s.z("pitchstart")).fire(new s.z("pitch")).fire(new s.z("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(l){return this._scaleFactor=l,this.painter.scaleFactor=l,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers(t=>t.type==="symbol"),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(l){return this.transform.renderWorldCopies=l,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(l){return l==="auto"?navigator.language:Array.isArray(l)?l.length===0?void 0:l.map(t=>t==="auto"?navigator.language:t):l}setLanguage(l){const t=this._parseLanguage(l);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(const n of this._controls)n._setLanguage&&n._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(l){return this.style&&l!==this._worldview?(this._worldview=l,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(l){return this._lazyInitEmptyStyle(),l?typeof l=="string"&&(l={name:l}):l=null,this._useExplicitProjection=!!l,this._prioritizeAndUpdateProjection(l,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const l=this.transform,t=l.projection.name;let n;t==="globe"&&l.zoom>=s.bY?(l.setMercatorFromTransition(),n=!0):t==="mercator"&&l.zoom<s.bY&&(l.setProjection({name:"globe"}),n=!0),n&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(l,t){return this._updateProjection(l||t||{name:"mercator"})}_updateProjection(l){let t;return t=l.name==="globe"&&this.transform.zoom>=s.bY?this.transform.setMercatorFromTransition():this.transform.setProjection(l),this.style.applyProjectionUpdate(),t&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(l){return this.transform.locationPoint3D(s.bO.convert(l))}unproject(l){return this.transform.pointLocation3D(s.P.convert(l))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(l,t,n){const c=d=>{let p=[];if(Array.isArray(t)){const _=t.filter(b=>this.getLayer(b));p=_.length?this.queryRenderedFeatures(d,{layers:_}):[]}else p=this.queryRenderedFeatures(d,{target:t});return p};if(l==="mouseenter"||l==="mouseover"){let d=!1;return{listener:n,targets:t,delegates:{mousemove:_=>{const b=c(_.point);b.length?d||(d=!0,n.call(this,new wr(l,this,_.originalEvent,{features:b}))):d=!1},mouseout:()=>{d=!1}}}}if(l==="mouseleave"||l==="mouseout"){let d=!1;return{listener:n,targets:t,delegates:{mousemove:b=>{c(b.point).length?d=!0:d&&(d=!1,n.call(this,new wr(l,this,b.originalEvent)))},mouseout:b=>{d&&(d=!1,n.call(this,new wr(l,this,b.originalEvent)))}}}}{const d=p=>{const _=c(p.point);_.length&&(p.features=_,n.call(this,p),delete p.features)};return{listener:n,targets:t,delegates:{[l]:d}}}}on(l,t,n){if(typeof t=="function"||n===void 0)return super.on(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._createDelegatedListener(l,t,n);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[l]=this._delegatedListeners[l]||[],this._delegatedListeners[l].push(c);for(const d in c.delegates)this.on(d,c.delegates[d]);return this}once(l,t,n){if(typeof t=="function"||n===void 0)return super.once(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._createDelegatedListener(l,t,n);for(const d in c.delegates)this.once(d,c.delegates[d]);return this}off(l,t,n){if(typeof t=="function"||n===void 0)return super.off(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._delegatedListeners?this._delegatedListeners[l]:void 0;return c&&(d=>{for(let p=0;p<d.length;p++){const _=d[p];if(_.listener===n&&bi(_.targets,t)){for(const b in _.delegates)this.off(b,_.delegates[b]);return d.splice(p,1),this}}})(c),this}queryRenderedFeatures(l,t){if(!this.style)return[];if(l===void 0||l instanceof s.P||Array.isArray(l)||t!==void 0||(t=l,l=void 0),l=l||[[0,0],[this.transform.width,this.transform.height]],!t){const p=this.style.queryRenderedFeatures(l,void 0,this.transform),_=this.style.queryRenderedFeatureset(l,void 0,this.transform);return p.concat(_)}let n=!0;if(t.target&&(n=this._isTargetValid(t.target),n&&!t.layers))return this.style.queryRenderedFeatureset(l,t,this.transform);let c=!0;if(t.layers&&Array.isArray(t.layers)){for(const p of t.layers)if(!this._isValidId(p)){c=!1;break}if(c&&!t.target)return this.style.queryRenderedFeatures(l,t,this.transform)}let d=[];return c&&(d=d.concat(this.style.queryRenderedFeatures(l,t,this.transform))),n&&(d=d.concat(this.style.queryRenderedFeatureset(l,t,this.transform))),d}querySourceFeatures(l,t){return!l||typeof l=="string"&&!this._isValidId(l)?[]:this.style.querySourceFeatures(l,t)}isPointOnSurface(l){const{name:t}=this.transform.projection;return t!=="globe"&&t!=="mercator"&&s.w(`${t} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(s.P.convert(l))}addInteraction(l,t){return this._interactions.add(l,t),this}removeInteraction(l){return this._interactions.remove(l),this}setStyle(l,t){return t=s.l({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t),this.style&&l&&t.diff!==!1&&t.localFontFamily===this._localFontFamily&&t.localIdeographFontFamily===this._localIdeographFontFamily&&!t.config?(this.style._diffStyle(l,(n,c)=>{n?(s.w(`Unable to perform style diff: ${String(n.message||n.error||n)}. Rebuilding the style from scratch.`),this._updateStyle(l,t)):c&&this._update(!0)},()=>{this._postStyleLoadEvent()}),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(l,t))}_getUIString(l){const t=this._locale[l];if(t==null)throw new Error(`Missing UI string '${l}'`);return t}_updateStyle(l,t){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),l){const n=s.l({},t);t&&t.config&&(n.initialConfig=t.config,delete n.config),this.style=new Ur(this,n).load(l),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Ur(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(s.w("There is no style added to the map."),!1)}_isValidId(l){return l==null?(this.fire(new s.y(new Error("IDs can't be empty."))),!1):!s.cr(l)||(this.fire(new s.y(new Error(`IDs can't contain special symbols: "${l}".`))),!1)}_isTargetValid(l){return"featuresetId"in l?this._isValidId("importId"in l?l.importId:l.featuresetId):"layerId"in l&&this._isValidId(l.layerId)}_areTargetsValid(l){if(Array.isArray(l)){for(const t of l)if(!this._isValidId(t))return!1;return!0}return this._isTargetValid(l)}addSource(l,t){return this._isValidId(l)?(this._lazyInitEmptyStyle(),this.style.addSource(l,t),this._update(!0)):this}isSourceLoaded(l){return!!this._isValidId(l)&&!!this.style&&this.style._isSourceCacheLoaded(l)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(l,t,n){this._lazyInitEmptyStyle(),this.style.addSourceType(l,t,n)}removeSource(l){return this._isValidId(l)?(this.style.removeSource(l),this._updateTerrain(),this._update(!0)):this}getSource(l){return this._isValidId(l)?this.style.getOwnSource(l):null}addImage(l,t,{pixelRatio:n=1,sdf:c=!1,stretchX:d,stretchY:p,content:_}={}){if(this._lazyInitEmptyStyle(),t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap){const{width:b,height:E,data:I}=s.q.getImageData(t);this.style.addImage(l,{data:new s.r({width:b,height:E},I),pixelRatio:n,stretchX:d,stretchY:p,content:_,sdf:c,version:0,usvg:!1})}else if(t.width===void 0||t.height===void 0)this.fire(new s.y(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:b,height:E}=t,I=t;this.style.addImage(l,{data:new s.r({width:b,height:E},new Uint8Array(I.data)),pixelRatio:n,stretchX:d,stretchY:p,content:_,sdf:c,usvg:!1,version:0,userImage:I}),I.onAdd&&I.onAdd(this,l)}}updateImage(l,t){this._lazyInitEmptyStyle();const n=this.style.getImage(l);if(!n)return void this.fire(new s.y(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const c=t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap?s.q.getImageData(t):t,{width:d,height:p,data:_}=c;if(d===void 0||p===void 0)return void this.fire(new s.y(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(d!==(n.usvg?n.icon.usvg_tree.width:n.data.width)||p!==(n.usvg?n.icon.usvg_tree.height:n.data.height))return void this.fire(new s.y(new Error(`The width and height of the updated image (${d}, ${p})
                must be that same as the previous version of the image
                (${n.data.width}, ${n.data.height})`)));const b=!(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap);let E=!1;n.usvg?(n.data=new s.r({width:d,height:p},new Uint8Array(_)),n.usvg=!1,n.icon=void 0,E=!0):n.data.replace(_,b),this.style.updateImage(l,n,E)}hasImage(l){return l?!!this.style&&!!this.style.getImage(l):(this.fire(new s.y(new Error("Missing required image id"))),!1)}removeImage(l){this.style.removeImage(l)}loadImage(l,t){s.o(this._requestManager.transformRequest(l,s.R.Image),(n,c)=>{t(n,c instanceof HTMLImageElement?s.q.getImageData(c):c)})}listImages(){return this.style.listImages()}addModel(l,t){this._lazyInitEmptyStyle(),this.style.addModel(l,t)}hasModel(l){return l?this.style.hasModel(l):(this.fire(new s.y(new Error("Missing required model id"))),!1)}removeModel(l){this.style.removeModel(l)}listModels(){return this.style.listModels()}addLayer(l,t){return this._isValidId(l.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(l,t),this._update(!0)):this}getSlot(l){const t=this.getLayer(l);return t&&t.slot||null}setSlot(l,t){return this.style.setSlot(l,t),this.style.mergeLayers(),this._update(!0)}addImport(l,t){return this.style.addImport(l,t),this}updateImport(l,t){return typeof t!="string"&&t.id!==l?(this.removeImport(l),this.addImport(t)):(this.style.updateImport(l,t),this._update(!0))}removeImport(l){return this.style.removeImport(l),this}moveImport(l,t){return this.style.moveImport(l,t),this._update(!0)}moveLayer(l,t){return this._isValidId(l)?(this.style.moveLayer(l,t),this._update(!0)):this}removeLayer(l){return this._isValidId(l)?(this.style.removeLayer(l),this._update(!0)):this}getLayer(l){if(!this._isValidId(l))return null;const t=this.style.getOwnLayer(l);return t?t.type==="custom"?t.implementation:t.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(l,t,n){return this._isValidId(l)?(this.style.setLayerZoomRange(l,t,n),this._update(!0)):this}setFilter(l,t,n={}){return this._isValidId(l)?(this.style.setFilter(l,t,n),this._update(!0)):this}getFilter(l){return this._isValidId(l)?this.style.getFilter(l):null}setPaintProperty(l,t,n,c={}){return this._isValidId(l)?(this.style.setPaintProperty(l,t,n,c),this._update(!0)):this}getPaintProperty(l,t){return this._isValidId(l)?this.style.getPaintProperty(l,t):null}setLayoutProperty(l,t,n,c={}){return this._isValidId(l)?(this.style.setLayoutProperty(l,t,n,c),this._update(!0)):this}getLayoutProperty(l,t){return this._isValidId(l)?this.style.getLayoutProperty(l,t):null}getSchema(l){return this.style.getSchema(l)}setSchema(l,t){return this.style.setSchema(l,t),this._update(!0)}getConfig(l){return this.style.getConfig(l)}setConfig(l,t){return this.style.setConfig(l,t),this._update(!0)}getConfigProperty(l,t){return this.style.getConfigProperty(l,t)}setConfigProperty(l,t,n){return this.style.setConfigProperty(l,t,n),this._update(!0)}getFeaturesetDescriptors(l){return this.style.getFeaturesetDescriptors(l)}setLights(l){if(this._lazyInitEmptyStyle(),l&&l.length===1&&l[0].type==="flat"){const t=l[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(l),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const l=this.style.getLights()||[];return l.length===0&&l.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),l}setLight(l,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:l}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(l){return this._lazyInitEmptyStyle(),!l&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(l),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(l){return this._lazyInitEmptyStyle(),this.style.setFog(l),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(l){return this._lazyInitEmptyStyle(),this.style.setSnow(l),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(l){return this._lazyInitEmptyStyle(),this.style.setRain(l),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(l){return this._lazyInitEmptyStyle(),this.style.setColorTheme(l),this._update(!0)}setImportColorTheme(l,t){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(l,t),this._update(!0)}setCamera(l){return this.style.setCamera(l),this._triggerCameraUpdate(l)}_triggerCameraUpdate(l){return this._update(this.transform.setOrthographicProjectionAtLowPitch(l["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(l){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(s.bO.convert(l),this.transform):0}setFeatureState(l,t){return l.source&&!this._isValidId(l.source)?this:(this.style.setFeatureState(l,t),this._update())}removeFeatureState(l,t){return l.source&&!this._isValidId(l.source)?this:(this.style.removeFeatureState(l,t),this._update())}getFeatureState(l){return l.source&&!this._isValidId(l.source)?null:this.style.getFeatureState(l)}_updateContainerDimensions(){if(!this._container)return;const l=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300;let n,c,d,p=this._container;for(;p&&(!c||!d);){const _=window.getComputedStyle(p).transform;_&&_!=="none"&&(n=_.match(/matrix.*\((.+)\)/)[1].split(", "),n[0]&&n[0]!=="0"&&n[0]!=="1"&&(c=n[0]),n[3]&&n[3]!=="0"&&n[3]!=="1"&&(d=n[3])),p=p.parentElement}this._containerWidth=c?Math.abs(l/c):l,this._containerHeight=d?Math.abs(t/d):t}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&s.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const l=this._container;l.classList.add("mapboxgl-map"),(this._missingCSSCanary=We("div","mapboxgl-canary",l)).style.visibility="hidden",this._detectMissingCSS();const t=this._canvasContainer=We("div","mapboxgl-canvas-container",l);this._canvas=We("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const n=this._controlContainer=We("div","mapboxgl-control-container",l),c=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(d=>{c[d]=We("div",`mapboxgl-ctrl-${d}`,n)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(l,t){const n=s.q.devicePixelRatio||1;this._canvas.width=n*Math.ceil(l),this._canvas.height=n*Math.ceil(t),this._canvas.style.width=`${l}px`,this._canvas.style.height=`${t}px`}_addMarker(l){this._markers.push(l)}_removeMarker(l){const t=this._markers.indexOf(l);t!==-1&&this._markers.splice(t,1)}_addPopup(l){this._popups.push(l)}_removePopup(l){const t=this._popups.indexOf(l);t!==-1&&this._popups.splice(t,1)}_setupPainter(){const l=s.l({},Ve.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",l);t?(xa(t,!0),this.painter=new hd(t,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp),this.on("data",n=>{n.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),s.m.testSupport(t)):this.fire(new s.y(new Error("Failed to initialize WebGL")))}_contextLost(l){l.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new s.z("webglcontextlost",{originalEvent:l}))}_contextRestored(l){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style.reloadModels(),this.style.clearSources(),this._update(),this.fire(new s.z("webglcontextrestored",{originalEvent:l}))}_onMapScroll(l){if(l.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(l){return this.style?(this._styleDirty=this._styleDirty||l,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(l){return this._update(),this._renderTaskQueue.add(l)}_cancelRenderFrame(l){this._renderTaskQueue.remove(l)}_requestDomTask(l){!this.loaded()||this.loaded()&&!this.isMoving()?l():this._domRenderTaskQueue.add(l)}_render(l){let t;this.fire(new s.z("renderstart")),++this._frameId;const n=this.painter.context.extTimerQuery,c=s.q.now(),d=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=d.createQuery(),d.beginQuery(n.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(l),this._domRenderTaskQueue.run(l),this._removed)return;this._updateProjectionTransition();const p=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const I=this.transform.zoom,A=this.transform.pitch,R=s.q.now(),D=new s.a8(I,{now:R,fadeDuration:p,pitch:A,transition:this.style.transition});this.style.update(D)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let _=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),_=this._updateAverageElevation(c),this.style.updateSources(this.transform),this._forceMarkerAndPopupUpdate()):_=this._updateAverageElevation(c);const b=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,p,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),b&&(this._placementDirty=b.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:p,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new s.z("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,oe.mark(ce.load),this.fire(new s.z("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){const I=s.q.now()-c;d.endQuery(n.TIME_ELAPSED_EXT),setTimeout(()=>{const A=d.getQueryParameter(t,d.QUERY_RESULT)/1e6;d.deleteQuery(t),this.fire(new s.z("gpu-timing-frame",{cpuTime:I,gpuTime:A}))},50)}if(this.listens("gpu-timing-layer")){const I=this.painter.collectGpuTimers();setTimeout(()=>{const A=this.painter.queryGpuTimers(I);this.fire(new s.z("gpu-timing-layer",{layerTimes:A}))},50)}if(this.listens("gpu-timing-deferred-render")){const I=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const A=this.painter.queryGpuTimeDeferredRender(I);this.fire(new s.z("gpu-timing-deferred-render",{gpuTime:A}))},50)}const E=this._sourcesDirty||this._styleDirty||this._placementDirty||_;if(E||this._repaint)this.triggerRepaint();else{const I=this.idle();if(I&&(_=this._updateAverageElevation(c,!0)),_)this.triggerRepaint();else if(this._triggerFrame(!1),I&&(this.fire(new s.z("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const A=this._calculateSpeedIndex();this.fire(new s.z("speedindexcompleted",{speedIndex:A})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||E||(this._fullyLoaded=!0,oe.mark(ce.fullLoad),this._performanceMetricsCollection&&cs(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(l){for(const t of this._markers)l&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(const t of this._popups)!l||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(l,t=!1){const n=d=>(this.transform.averageElevation=d,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&n(0);const c=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(c||(t||l-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(l)){const d=this.transform.averageElevation;let p=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(p)?p=0:this._averageElevationLastSampledAt=l;const _=Math.abs(d-p);if(_>1){if(this._isInitialLoad||c)return this._averageElevation.jumpTo(p),n(p);this._averageElevation.easeTo(p,l,300)}else if(_>1e-4)return this._averageElevation.jumpTo(p),n(p)}return!!this._averageElevation.isEasing(l)&&n(this._averageElevation.getValue(l))}_authenticate(){Se(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,l=>{if(l&&(l.message===ki||l.status===401)){const t=this.painter.context.gl;xa(t,!1),this._logoControl instanceof Cr&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new s.y(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),ls(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&Bs(this._requestManager._customAccessToken,{map:this,skuToken:this._requestManager._skuToken,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){const l=this._isDragging();this.painter.updateTerrain(this.style,l)}_calculateSpeedIndex(){const l=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());const n=this.painter.context.gl,c=n.createFramebuffer();function d(p){n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,p,0);const _=new Uint8Array(n.drawingBufferWidth*n.drawingBufferHeight*4);return n.readPixels(0,0,n.drawingBufferWidth,n.drawingBufferHeight,n.RGBA,n.UNSIGNED_BYTE,_),_}return n.bindFramebuffer(n.FRAMEBUFFER,c),this._canvasPixelComparison(d(l),t.canvasCopies.map(d),t.timeStamps)}_canvasPixelComparison(l,t,n){let c=n[1]-n[0];const d=l.length/4;for(let p=0;p<t.length;p++){const _=t[p];let b=0;for(let E=0;E<_.length;E+=4)_[E]===l[E]&&_[E+1]===l[E+1]&&_[E+2]===l[E+2]&&_[E+3]===l[E+3]&&(b+=1);c+=(n[p+2]-n[p+1])*(1-b/d)}return c}remove(){this._hash&&this._hash.remove();for(const t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const l=this.painter.context.gl.getExtension("WEBGL_lose_context");l&&l.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),ya.delete(this.painter.context.gl),ga.remove(),qt.remove(),this._removed=!0,this.fire(new s.z("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(l){this._renderNextFrame=this._renderNextFrame||l,this.style&&!this._frame&&(this._frame=s.q.frame(t=>{const n=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,n&&this._render(t)}))}_preloadTiles(l){const t=this.style?this.style.getSourceCaches():[];return s.bl(t,(n,c)=>n._preloadTiles(l,c),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(l){this._trackResize&&this.resize({originalEvent:l})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(l){this._showTileBoundaries!==l&&(this._showTileBoundaries=l,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(l){this._showParseStatus!==l&&(this._showParseStatus=l,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(l){this._showTerrainWireframe!==l&&(this._showTerrainWireframe=l,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(l){this._showLayers2DWireframe!==l&&(this._showLayers2DWireframe=l,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(l){this._showLayers3DWireframe!==l&&(this._showLayers3DWireframe=l,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(l){this._speedIndexTiming!==l&&(this._speedIndexTiming=l,this._update())}get showPadding(){return!!this._showPadding}set showPadding(l){this._showPadding!==l&&(this._showPadding=l,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(l){this._showCollisionBoxes!==l&&(this._showCollisionBoxes=l,this._tp.refreshUI(),l?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(l){this._showOverdrawInspector!==l&&(this._showOverdrawInspector=l,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(l){this._repaint!==l&&(this._repaint=l,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(l){this._vertices=l,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(l){this._showTileAABBs!==l&&(this._showTileAABBs=l,this._tp.refreshUI(),l&&this._update())}_setCacheLimits(l,t){s.dG(l,t)}get version(){return _e}},NavigationControl:class{constructor(l={}){this.options=s.l({},S_,l),this._container=We("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(s.aP(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",t=>{this._map&&this._map.zoomIn({},{originalEvent:t})}),We("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",t=>{this._map&&this._map.zoomOut({},{originalEvent:t})}),We("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(s.aP(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",t=>{const n=this._map;n&&(this.options.visualizePitch?n.resetNorthPitch({},{originalEvent:t}):n.resetNorth({},{originalEvent:t}))}),this._compassIcon=We("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const l=this._map;if(!l)return;const t=l.getZoom(),n=t===l.getMaxZoom(),c=t===l.getMinZoom();this._zoomInButton.disabled=n,this._zoomOutButton.disabled=c,this._zoomInButton.setAttribute("aria-disabled",n.toString()),this._zoomOutButton.setAttribute("aria-disabled",c.toString())}_rotateCompassArrow(){const l=this._map;if(!l)return;const t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(l.transform.pitch*(Math.PI/180)),.5)}) rotateX(${l.transform.pitch}deg) rotateZ(${l.transform.angle*(180/Math.PI)}deg)`:`rotate(${l.transform.angle*(180/Math.PI)}deg)`;l._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=t)})}onAdd(l){return this._map=l,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),l.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&l.on("pitch",this._rotateCompassArrow),l.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new E_(l,this._compass,this.options.visualizePitch)),this._container}onRemove(){const l=this._map;l&&(this._container.remove(),this.options.showZoom&&l.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&l.off("pitch",this._rotateCompassArrow),l.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(l,t){const n=We("button",l,this._container);return n.type="button",n.addEventListener("click",t),n}_setButtonTitle(l,t){if(!this._map)return;const n=this._map._getUIString(`NavigationControl.${t}`);l.setAttribute("aria-label",n),l.firstElementChild&&l.firstElementChild.setAttribute("title",n)}},GeolocateControl:class extends s.E{constructor(l={}){super();const t=navigator.geolocation;this.options=s.l({geolocation:t},cr,l),s.aP(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=xu(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(l){return this._map=l,this._container=We("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(l){const t=(n=!!this.options.geolocation)=>{this._supportsGeolocation=n,l(n)};this._supportsGeolocation!==void 0?l(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(n=>t(n.state!=="denied")).catch(()=>t()):t()}_isOutOfMapMaxBounds(l){const t=this._map.getMaxBounds(),n=l.coords;return!!t&&(n.longitude<t.getWest()||n.longitude>t.getEast()||n.latitude<t.getSouth()||n.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(l){if(this._map){if(this._isOutOfMapMaxBounds(l))return this._setErrorState(),this.fire(new s.z("outofmaxbounds",l)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=l,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(l),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(l),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new s.z("geolocate",l)),this._finish()}}_updateCamera(l){const t=new s.bO(l.coords.longitude,l.coords.latitude),n=l.coords.accuracy,c=this._map.getBearing(),d=s.l({bearing:c},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(n),d,{geolocateSource:!0})}_updateMarker(l){if(l){const t=new s.bO(l.coords.longitude,l.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=l.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const l=this._map.transform,t=s.bH(1,l._center.lat)*l.worldSize,n=Math.ceil(2*this._accuracy*t);this._circleElement.style.width=`${n}px`,this._circleElement.style.height=`${n}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(l){if(this._map){if(this.options.trackUserLocation)if(l.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(l.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new s.z("error",l)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(l){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",t=>t.preventDefault()),this._geolocateButton=We("button","mapboxgl-ctrl-geolocate",this._container),We("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",l===!1){s.w("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{const t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=We("div","mapboxgl-user-location"),this._dotElement.appendChild(We("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(We("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new ts({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=We("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new ts({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",t=>{t.geolocateSource||this._watchState!=="ACTIVE_LOCK"||t.originalEvent&&t.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new s.z("trackuserlocationend")))})}}_onDeviceOrientation(l){this._userLocationDotMarker&&(l.webkitCompassHeading?this._heading=l.webkitCompassHeading:l.absolute===!0&&(this._heading=-1*l.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return s.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new s.z("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new s.z("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new s.z("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let l;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(l={maximumAge:6e5,timeout:0},this._noTimeout=!0):(l=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,l),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const l=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(t=>{t==="granted"&&l()}).catch(console.error):l()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Tu,ScaleControl:class{constructor(l={}){this.options=s.l({},Tr,l),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),s.aP(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const l=this.options.maxWidth||100,t=this._map,n=t._containerHeight/2,c=t._containerWidth/2-l/2,d=t.unproject([c,n]),p=t.unproject([c+l,n]),_=d.distanceTo(p);if(this.options.unit==="imperial"){const b=3.2808*_;b>5280?this._setScale(l,b/5280,"mile"):this._setScale(l,b,"foot")}else this.options.unit==="nautical"?this._setScale(l,_/1852,"nautical-mile"):_>=1e3?this._setScale(l,_/1e3,"kilometer"):this._setScale(l,_,"meter")}_setScale(l,t,n){this._map._requestDomTask(()=>{const c=function(p){const _=Math.pow(10,`${Math.floor(p)}`.length-1);let b=p/_;return b=b>=10?10:b>=5?5:b>=3?3:b>=2?2:b>=1?1:function(E){const I=Math.pow(10,Math.ceil(-Math.log(E)/Math.LN10));return Math.round(E*I)/I}(b),_*b}(t),d=c/t;this._container.innerHTML=this._isNumberFormatSupported&&n!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:n}).format(c):`${c}&nbsp;${qn[n]}`,this._container.style.width=l*d+"px"})}onAdd(l){return this._map=l,this._language=l.getLanguage(),this._container=We("div","mapboxgl-ctrl mapboxgl-ctrl-scale",l.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(l){this._language=l,this._update()}setUnit(l){this.options.unit=l,this._update()}},FullscreenControl:class{constructor(l={}){this._fullscreen=!1,l&&l.container&&(l.container instanceof HTMLElement?this._container=l.container:s.w("Full screen control 'container' must be a DOM element.")),s.aP(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(l){return this._map=l,this._container||(this._container=this._map.getContainer()),this._controlContainer=We("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",s.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const l=this._fullscreenButton=We("button","mapboxgl-ctrl-fullscreen",this._controlContainer);We("span","mapboxgl-ctrl-icon",l).setAttribute("aria-hidden","true"),l.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const l=this._getTitle();this._fullscreenButton.setAttribute("aria-label",l),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",l)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends s.E{constructor(l){super(),this.options=s.l(Object.create(cp),l),s.aP(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(l&&l.className?l.className.trim().split(/\s+/):[])}addTo(l){return this._map&&this.remove(),this._map=l,this.options.closeOnClick&&l.on("preclick",this._onClose),this.options.closeOnMove&&l.on("move",this._onClose),l.on("remove",this.remove),this._update(),l._addPopup(this),this._focusFirstElement(),this._trackPointer?(l.on("mousemove",this._onMouseEvent),l.on("mouseup",this._onMouseEvent),l._canvasContainer.classList.add("mapboxgl-track-pointer")):l.on("move",this._update),this.fire(new s.z("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const l=this._map;return l&&(l.off("move",this._update),l.off("move",this._onClose),l.off("preclick",this._onClose),l.off("click",this._onClose),l.off("remove",this.remove),l.off("mousemove",this._onMouseEvent),l.off("mouseup",this._onMouseEvent),l.off("drag",this._onMouseEvent),l._canvasContainer&&l._canvasContainer.classList.remove("mapboxgl-track-pointer"),l._removePopup(this),this._map=void 0),this.fire(new s.z("close")),this}getLngLat(){return this._lngLat}setLngLat(l){this._lngLat=s.bO.convert(l),this._pos=null,this._trackPointer=!1,this._update();const t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const l=this._map;return l&&(l.off("move",this._update),l.on("mousemove",this._onMouseEvent),l.on("drag",this._onMouseEvent),l._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(l){return this.setDOMContent(document.createTextNode(l))}setHTML(l){const t=document.createDocumentFragment(),n=document.createElement("body");let c;for(n.innerHTML=l;c=n.firstChild,c;)t.appendChild(c);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(l){return this.options.maxWidth=l,this._update(),this}setDOMContent(l){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=We("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(l),this.options.closeButton){const n=this._closeButton=We("button","mapboxgl-popup-close-button",t);n.type="button",n.setAttribute("aria-label","Close popup"),n.innerHTML='<span aria-hidden="true">&#215;</span>',n.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(l){return this._classList.add(l),this._updateClassList(),this}removeClassName(l){return this._classList.delete(l),this._updateClassList(),this}setOffset(l){return this.options.offset=l,this._update(),this}toggleClassName(l){let t;return this._classList.delete(l)?t=!1:(this._classList.add(l),t=!0),this._updateClassList(),t}_onMouseEvent(l){this._update(l.point)}_getAnchor(l){if(this.options.anchor)return this.options.anchor;const t=this._map,n=this._container,c=this._pos;if(!t||!n||!c)return"bottom";const d=n.offsetWidth,p=n.offsetHeight,_=c.x<d/2,b=c.x>t.transform.width-d/2;if(c.y+l<p)return _?"top-left":b?"top-right":"top";if(c.y>t.transform.height-p){if(_)return"bottom-left";if(b)return"bottom-right"}return _?"left":b?"right":"bottom"}_updateClassList(){const l=this._container;if(!l)return;const t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),l.className=t.join(" ")}_update(l){const t=this._map,n=this._content;if(!t||!this._lngLat&&!this._trackPointer||!n)return;let c=this._container;if(c||(c=this._container=We("div","mapboxgl-popup",t.getContainer()),this._tip=We("div","mapboxgl-popup-tip",c),c.appendChild(n)),this.options.maxWidth&&c.style.maxWidth!==this.options.maxWidth&&(c.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Su(this._lngLat,this._pos,t.transform)),!this._trackPointer||l){const d=this._pos=this._trackPointer&&l instanceof s.P?l:t.project(this._lngLat),p=yd(this.options.offset),_=this._anchor=this._getAnchor(p.y),b=yd(this.options.offset,_),E=d.add(b).round();t._requestDomTask(()=>{this._container&&_&&(this._container.style.transform=`${Ts[_]} translate(${E.x}px,${E.y}px)`)})}if(!this._marker&&t._showingGlobe()){const d=s.dH(t.transform,this._lngLat)?0:1;this._setOpacity(d)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const l=this._container.querySelector(_r);l&&l.focus()}_onClose(){this.remove()}_setOpacity(l){this._container&&(this._container.style.opacity=`${l}`),this._content&&(this._content.style.pointerEvents=l?"auto":"none")}},Marker:ts,Style:Ur,LngLat:s.bO,LngLatBounds:s.az,Point:s.P,MercatorCoordinate:s.aa,FreeCameraOptions:qc,Evented:s.E,config:s.e,prewarm:s.dM,clearPrewarmedResources:s.dN,get accessToken(){return s.e.ACCESS_TOKEN},set accessToken(l){s.e.ACCESS_TOKEN=l},get baseApiUrl(){return s.e.API_URL},set baseApiUrl(l){s.e.API_URL=l},get workerCount(){return s.dO.workerCount},set workerCount(l){s.dO.workerCount=l},get maxParallelImageRequests(){return s.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(l){s.e.MAX_PARALLEL_IMAGE_REQUESTS=l},clearStorage(l){s.dP(l)},get workerUrl(){return s.dQ.workerUrl},set workerUrl(l){s.dQ.workerUrl=l},get workerClass(){return s.dQ.workerClass},set workerClass(l){s.dQ.workerClass=l},get workerParams(){return s.dQ.workerParams},set workerParams(l){s.dQ.workerParams=l},get dracoUrl(){return s.dR()},set dracoUrl(l){s.dS(l)},get meshoptUrl(){return s.dT()},set meshoptUrl(l){s.dU(l)},setNow:s.q.setNow,restoreNow:s.q.restoreNow}});var se=$;return se})}(um)),um.exports}var M4=E4();const I4=T4(M4),A4="FeatureCollection",C4=[{type:"Feature",id:"ContiguousUSA",properties:{name:"United States of America - Lower 48 states"},geometry:{type:"Polygon",coordinates:[[[-94.81758,49.38905],[-94.64,48.84],[-94.32914,48.67074],[-93.63087,48.60926],[-92.61,48.45],[-91.64,48.14],[-90.83,48.27],[-89.6,48.01],[-89.272917,48.019808],[-88.378114,48.302918],[-87.439793,47.94],[-86.461991,47.553338],[-85.652363,47.220219],[-84.87608,46.900083],[-84.779238,46.637102],[-84.543749,46.538684],[-84.6049,46.4396],[-84.3367,46.40877],[-84.14212,46.512226],[-84.091851,46.275419],[-83.890765,46.116927],[-83.616131,46.116927],[-83.469551,45.994686],[-83.592851,45.816894],[-82.550925,45.347517],[-82.337763,44.44],[-82.137642,43.571088],[-82.43,42.98],[-82.9,42.43],[-83.12,42.08],[-83.142,41.975681],[-83.02981,41.832796],[-82.690089,41.675105],[-82.439278,41.675105],[-81.277747,42.209026],[-80.247448,42.3662],[-78.939362,42.863611],[-78.92,42.965],[-79.01,43.27],[-79.171674,43.466339],[-78.72028,43.625089],[-77.737885,43.629056],[-76.820034,43.628784],[-76.5,44.018459],[-76.375,44.09631],[-75.31821,44.81645],[-74.867,45.00048],[-73.34783,45.00738],[-71.50506,45.0082],[-71.405,45.255],[-71.08482,45.30524],[-70.66,45.46],[-70.305,45.915],[-69.99997,46.69307],[-69.237216,47.447781],[-68.905,47.185],[-68.23444,47.35486],[-67.79046,47.06636],[-67.79134,45.70281],[-67.13741,45.13753],[-66.96466,44.8097],[-68.03252,44.3252],[-69.06,43.98],[-70.11617,43.68405],[-70.645476,43.090238],[-70.81489,42.8653],[-70.825,42.335],[-70.495,41.805],[-70.08,41.78],[-70.185,42.145],[-69.88497,41.92283],[-69.96503,41.63717],[-70.64,41.475],[-71.12039,41.49445],[-71.86,41.32],[-72.295,41.27],[-72.87643,41.22065],[-73.71,40.931102],[-72.24126,41.11948],[-71.945,40.93],[-73.345,40.63],[-73.982,40.628],[-73.952325,40.75075],[-74.25671,40.47351],[-73.96244,40.42763],[-74.17838,39.70926],[-74.90604,38.93954],[-74.98041,39.1964],[-75.20002,39.24845],[-75.52805,39.4985],[-75.32,38.96],[-75.071835,38.782032],[-75.05673,38.40412],[-75.37747,38.01551],[-75.94023,37.21689],[-76.03127,37.2566],[-75.72205,37.93705],[-76.23287,38.319215],[-76.35,39.15],[-76.542725,38.717615],[-76.32933,38.08326],[-76.989998,38.239992],[-76.30162,37.917945],[-76.25874,36.9664],[-75.9718,36.89726],[-75.86804,36.55125],[-75.72749,35.55074],[-76.36318,34.80854],[-77.397635,34.51201],[-78.05496,33.92547],[-78.55435,33.86133],[-79.06067,33.49395],[-79.20357,33.15839],[-80.301325,32.509355],[-80.86498,32.0333],[-81.33629,31.44049],[-81.49042,30.72999],[-81.31371,30.03552],[-80.98,29.18],[-80.535585,28.47213],[-80.53,28.04],[-80.056539,26.88],[-80.088015,26.205765],[-80.13156,25.816775],[-80.38103,25.20616],[-80.68,25.08],[-81.17213,25.20126],[-81.33,25.64],[-81.71,25.87],[-82.24,26.73],[-82.70515,27.49504],[-82.85526,27.88624],[-82.65,28.55],[-82.93,29.1],[-83.70959,29.93656],[-84.1,30.09],[-85.10882,29.63615],[-85.28784,29.68612],[-85.7731,30.15261],[-86.4,30.4],[-87.53036,30.27433],[-88.41782,30.3849],[-89.18049,30.31598],[-89.593831,30.159994],[-89.413735,29.89419],[-89.43,29.48864],[-89.21767,29.29108],[-89.40823,29.15961],[-89.77928,29.30714],[-90.15463,29.11743],[-90.880225,29.148535],[-91.626785,29.677],[-92.49906,29.5523],[-93.22637,29.78375],[-93.84842,29.71363],[-94.69,29.48],[-95.60026,28.73863],[-96.59404,28.30748],[-97.14,27.83],[-97.37,27.38],[-97.38,26.69],[-97.33,26.21],[-97.14,25.87],[-97.53,25.84],[-98.24,26.06],[-99.02,26.37],[-99.3,26.84],[-99.52,27.54],[-100.11,28.11],[-100.45584,28.69612],[-100.9576,29.38071],[-101.6624,29.7793],[-102.48,29.76],[-103.11,28.97],[-103.94,29.27],[-104.45697,29.57196],[-104.70575,30.12173],[-105.03737,30.64402],[-105.63159,31.08383],[-106.1429,31.39995],[-106.50759,31.75452],[-108.24,31.754854],[-108.24194,31.34222],[-109.035,31.34194],[-111.02361,31.33472],[-113.30498,32.03914],[-114.815,32.52528],[-114.72139,32.72083],[-115.99135,32.61239],[-117.12776,32.53534],[-117.295938,33.046225],[-117.944,33.621236],[-118.410602,33.740909],[-118.519895,34.027782],[-119.081,34.078],[-119.438841,34.348477],[-120.36778,34.44711],[-120.62286,34.60855],[-120.74433,35.15686],[-121.71457,36.16153],[-122.54747,37.55176],[-122.51201,37.78339],[-122.95319,38.11371],[-123.7272,38.95166],[-123.86517,39.76699],[-124.39807,40.3132],[-124.17886,41.14202],[-124.2137,41.99964],[-124.53284,42.76599],[-124.14214,43.70838],[-124.020535,44.615895],[-123.89893,45.52341],[-124.079635,46.86475],[-124.39567,47.72017],[-124.68721,48.184433],[-124.566101,48.379715],[-123.12,48.04],[-122.58736,47.096],[-122.34,47.36],[-122.5,48.18],[-122.84,49],[-120,49],[-117.03121,49],[-116.04818,49],[-113,49],[-110.05,49],[-107.05,49],[-104.04826,48.99986],[-100.65,49],[-97.22872,49.0007],[-95.15907,49],[-95.15609,49.38425],[-94.81758,49.38905]]]}}],P4={type:A4,features:C4};class Sc{constructor(){this._partials=new Float64Array(32),this._n=0}add(M){const k=this._partials;let N=0;for(let $=0;$<this._n&&$<32;$++){const Y=k[$],se=M+Y,s=Math.abs(M)<Math.abs(Y)?M-(se-Y):Y-(se-M);s&&(k[N++]=s),M=se}return k[N]=M,this._n=N+1,this}valueOf(){const M=this._partials;let k=this._n,N,$,Y,se=0;if(k>0){for(se=M[--k];k>0&&(N=se,$=M[--k],se=N+$,Y=$-(se-N),!Y););k>0&&(Y<0&&M[k-1]<0||Y>0&&M[k-1]>0)&&($=Y*2,N=se+$,$==N-se&&(se=N))}return se}}function*z4(P){for(const M of P)yield*M}function Rb(P){return Array.from(z4(P))}var yn=1e-6,qi=Math.PI,zs=qi/2,Mv=qi/4,Fs=qi*2,so=180/qi,kr=qi/180,Sn=Math.abs,R4=Math.atan,Wu=Math.atan2,Dn=Math.cos,gn=Math.sin,hm=Math.sign||function(P){return P>0?1:P<0?-1:0},ma=Math.sqrt;function D4(P){return P>1?0:P<-1?qi:Math.acos(P)}function Ec(P){return P>1?zs:P<-1?-zs:Math.asin(P)}function Rs(){}function wm(P,M){P&&Av.hasOwnProperty(P.type)&&Av[P.type](P,M)}var Iv={Feature:function(P,M){wm(P.geometry,M)},FeatureCollection:function(P,M){for(var k=P.features,N=-1,$=k.length;++N<$;)wm(k[N].geometry,M)}},Av={Sphere:function(P,M){M.sphere()},Point:function(P,M){P=P.coordinates,M.point(P[0],P[1],P[2])},MultiPoint:function(P,M){for(var k=P.coordinates,N=-1,$=k.length;++N<$;)P=k[N],M.point(P[0],P[1],P[2])},LineString:function(P,M){iy(P.coordinates,M,0)},MultiLineString:function(P,M){for(var k=P.coordinates,N=-1,$=k.length;++N<$;)iy(k[N],M,0)},Polygon:function(P,M){Cv(P.coordinates,M)},MultiPolygon:function(P,M){for(var k=P.coordinates,N=-1,$=k.length;++N<$;)Cv(k[N],M)},GeometryCollection:function(P,M){for(var k=P.geometries,N=-1,$=k.length;++N<$;)wm(k[N],M)}};function iy(P,M,k){var N=-1,$=P.length-k,Y;for(M.lineStart();++N<$;)Y=P[N],M.point(Y[0],Y[1],Y[2]);M.lineEnd()}function Cv(P,M){var k=-1,N=P.length;for(M.polygonStart();++k<N;)iy(P[k],M,1);M.polygonEnd()}function Gu(P,M){P&&Iv.hasOwnProperty(P.type)?Iv[P.type](P,M):wm(P,M)}function ny(P){return[Wu(P[1],P[0]),Ec(P[2])]}function Xu(P){var M=P[0],k=P[1],N=Dn(k);return[N*Dn(M),N*gn(M),gn(k)]}function tm(P,M){return P[0]*M[0]+P[1]*M[1]+P[2]*M[2]}function Tm(P,M){return[P[1]*M[2]-P[2]*M[1],P[2]*M[0]-P[0]*M[2],P[0]*M[1]-P[1]*M[0]]}function Ug(P,M){P[0]+=M[0],P[1]+=M[1],P[2]+=M[2]}function im(P,M){return[P[0]*M,P[1]*M,P[2]*M]}function ry(P){var M=ma(P[0]*P[0]+P[1]*P[1]+P[2]*P[2]);P[0]/=M,P[1]/=M,P[2]/=M}function sy(P,M){function k(N,$){return N=P(N,$),M(N[0],N[1])}return P.invert&&M.invert&&(k.invert=function(N,$){return N=M.invert(N,$),N&&P.invert(N[0],N[1])}),k}function oy(P,M){return Sn(P)>qi&&(P-=Math.round(P/Fs)*Fs),[P,M]}oy.invert=oy;function L4(P,M,k){return(P%=Fs)?M||k?sy(zv(P),Rv(M,k)):zv(P):M||k?Rv(M,k):oy}function Pv(P){return function(M,k){return M+=P,Sn(M)>qi&&(M-=Math.round(M/Fs)*Fs),[M,k]}}function zv(P){var M=Pv(P);return M.invert=Pv(-P),M}function Rv(P,M){var k=Dn(P),N=gn(P),$=Dn(M),Y=gn(M);function se(s,_e){var ce=Dn(_e),oe=Dn(s)*ce,Ie=gn(s)*ce,Me=gn(_e),De=Me*k+oe*N;return[Wu(Ie*$-De*Y,oe*k-Me*N),Ec(De*$+Ie*Y)]}return se.invert=function(s,_e){var ce=Dn(_e),oe=Dn(s)*ce,Ie=gn(s)*ce,Me=gn(_e),De=Me*$-Ie*Y;return[Wu(Ie*$+Me*Y,oe*k+De*N),Ec(De*k-oe*N)]},se}function k4(P,M,k,N,$,Y){if(k){var se=Dn(M),s=gn(M),_e=N*k;$==null?($=M+N*Fs,Y=M-_e/2):($=Dv(se,$),Y=Dv(se,Y),(N>0?$<Y:$>Y)&&($+=N*Fs));for(var ce,oe=$;N>0?oe>Y:oe<Y;oe-=_e)ce=ny([se,-s*Dn(oe),-s*gn(oe)]),P.point(ce[0],ce[1])}}function Dv(P,M){M=Xu(M),M[0]-=P,ry(M);var k=D4(-M[1]);return((-M[2]<0?-k:k)+Fs-yn)%Fs}function Db(){var P=[],M;return{point:function(k,N,$){M.push([k,N,$])},lineStart:function(){P.push(M=[])},lineEnd:Rs,rejoin:function(){P.length>1&&P.push(P.pop().concat(P.shift()))},result:function(){var k=P;return P=[],M=null,k}}}function dm(P,M){return Sn(P[0]-M[0])<yn&&Sn(P[1]-M[1])<yn}function nm(P,M,k,N){this.x=P,this.z=M,this.o=k,this.e=N,this.v=!1,this.n=this.p=null}function Lb(P,M,k,N,$){var Y=[],se=[],s,_e;if(P.forEach(function(Ve){if(!((We=Ve.length-1)<=0)){var We,st=Ve[0],ct=Ve[We],gt;if(dm(st,ct)){if(!st[2]&&!ct[2]){for($.lineStart(),s=0;s<We;++s)$.point((st=Ve[s])[0],st[1]);$.lineEnd();return}ct[0]+=2*yn}Y.push(gt=new nm(st,Ve,null,!0)),se.push(gt.o=new nm(st,null,gt,!1)),Y.push(gt=new nm(ct,Ve,null,!1)),se.push(gt.o=new nm(ct,null,gt,!0))}}),!!Y.length){for(se.sort(M),Lv(Y),Lv(se),s=0,_e=se.length;s<_e;++s)se[s].e=k=!k;for(var ce=Y[0],oe,Ie;;){for(var Me=ce,De=!0;Me.v;)if((Me=Me.n)===ce)return;oe=Me.z,$.lineStart();do{if(Me.v=Me.o.v=!0,Me.e){if(De)for(s=0,_e=oe.length;s<_e;++s)$.point((Ie=oe[s])[0],Ie[1]);else N(Me.x,Me.n.x,1,$);Me=Me.n}else{if(De)for(oe=Me.p.z,s=oe.length-1;s>=0;--s)$.point((Ie=oe[s])[0],Ie[1]);else N(Me.x,Me.p.x,-1,$);Me=Me.p}Me=Me.o,oe=Me.z,De=!De}while(!Me.v);$.lineEnd()}}}function Lv(P){if(M=P.length){for(var M,k=0,N=P[0],$;++k<M;)N.n=$=P[k],$.p=N,N=$;N.n=$=P[0],$.p=N}}function jg(P){return Sn(P[0])<=qi?P[0]:hm(P[0])*((Sn(P[0])+qi)%Fs-qi)}function O4(P,M){var k=jg(M),N=M[1],$=gn(N),Y=[gn(k),-Dn(k),0],se=0,s=0,_e=new Sc;$===1?N=zs+yn:$===-1&&(N=-zs-yn);for(var ce=0,oe=P.length;ce<oe;++ce)if(Me=(Ie=P[ce]).length)for(var Ie,Me,De=Ie[Me-1],Ve=jg(De),We=De[1]/2+Mv,st=gn(We),ct=Dn(We),gt=0;gt<Me;++gt,Ve=ot,st=Rt,ct=vt,De=At){var At=Ie[gt],ot=jg(At),zt=At[1]/2+Mv,Rt=gn(zt),vt=Dn(zt),Nt=ot-Ve,Jt=Nt>=0?1:-1,It=Jt*Nt,xt=It>qi,$i=st*Rt;if(_e.add(Wu($i*Jt*gn(It),ct*vt+$i*Dn(It))),se+=xt?Nt+Jt*Fs:Nt,xt^Ve>=k^ot>=k){var ki=Tm(Xu(De),Xu(At));ry(ki);var Oi=Tm(Y,ki);ry(Oi);var tt=(xt^Nt>=0?-1:1)*Ec(Oi[2]);(N>tt||N===tt&&(ki[0]||ki[1]))&&(s+=xt^Nt>=0?1:-1)}}return(se<-1e-6||se<yn&&_e<-1e-12)^s&1}function kb(P,M,k,N){return function($){var Y=M($),se=Db(),s=M(se),_e=!1,ce,oe,Ie,Me={point:De,lineStart:We,lineEnd:st,polygonStart:function(){Me.point=ct,Me.lineStart=gt,Me.lineEnd=At,oe=[],ce=[]},polygonEnd:function(){Me.point=De,Me.lineStart=We,Me.lineEnd=st,oe=Rb(oe);var ot=O4(ce,N);oe.length?(_e||($.polygonStart(),_e=!0),Lb(oe,B4,ot,k,$)):ot&&(_e||($.polygonStart(),_e=!0),$.lineStart(),k(null,null,1,$),$.lineEnd()),_e&&($.polygonEnd(),_e=!1),oe=ce=null},sphere:function(){$.polygonStart(),$.lineStart(),k(null,null,1,$),$.lineEnd(),$.polygonEnd()}};function De(ot,zt){P(ot,zt)&&$.point(ot,zt)}function Ve(ot,zt){Y.point(ot,zt)}function We(){Me.point=Ve,Y.lineStart()}function st(){Me.point=De,Y.lineEnd()}function ct(ot,zt){Ie.push([ot,zt]),s.point(ot,zt)}function gt(){s.lineStart(),Ie=[]}function At(){ct(Ie[0][0],Ie[0][1]),s.lineEnd();var ot=s.clean(),zt=se.result(),Rt,vt=zt.length,Nt,Jt,It;if(Ie.pop(),ce.push(Ie),Ie=null,!!vt){if(ot&1){if(Jt=zt[0],(Nt=Jt.length-1)>0){for(_e||($.polygonStart(),_e=!0),$.lineStart(),Rt=0;Rt<Nt;++Rt)$.point((It=Jt[Rt])[0],It[1]);$.lineEnd()}return}vt>1&&ot&2&&zt.push(zt.pop().concat(zt.shift())),oe.push(zt.filter(F4))}}return Me}}function F4(P){return P.length>1}function B4(P,M){return((P=P.x)[0]<0?P[1]-zs-yn:zs-P[1])-((M=M.x)[0]<0?M[1]-zs-yn:zs-M[1])}const kv=kb(function(){return!0},N4,U4,[-qi,-zs]);function N4(P){var M=NaN,k=NaN,N=NaN,$;return{lineStart:function(){P.lineStart(),$=1},point:function(Y,se){var s=Y>0?qi:-qi,_e=Sn(Y-M);Sn(_e-qi)<yn?(P.point(M,k=(k+se)/2>0?zs:-zs),P.point(N,k),P.lineEnd(),P.lineStart(),P.point(s,k),P.point(Y,k),$=0):N!==s&&_e>=qi&&(Sn(M-N)<yn&&(M-=N*yn),Sn(Y-s)<yn&&(Y-=s*yn),k=V4(M,k,Y,se),P.point(N,k),P.lineEnd(),P.lineStart(),P.point(s,k),$=0),P.point(M=Y,k=se),N=s},lineEnd:function(){P.lineEnd(),M=k=NaN},clean:function(){return 2-$}}}function V4(P,M,k,N){var $,Y,se=gn(P-k);return Sn(se)>yn?R4((gn(M)*(Y=Dn(N))*gn(k)-gn(N)*($=Dn(M))*gn(P))/($*Y*se)):(M+N)/2}function U4(P,M,k,N){var $;if(P==null)$=k*zs,N.point(-qi,$),N.point(0,$),N.point(qi,$),N.point(qi,0),N.point(qi,-$),N.point(0,-$),N.point(-qi,-$),N.point(-qi,0),N.point(-qi,$);else if(Sn(P[0]-M[0])>yn){var Y=P[0]<M[0]?qi:-qi;$=k*Y/2,N.point(-Y,$),N.point(0,$),N.point(Y,$)}else N.point(M[0],M[1])}function j4(P){var M=Dn(P),k=2*kr,N=M>0,$=Sn(M)>yn;function Y(oe,Ie,Me,De){k4(De,P,k,Me,oe,Ie)}function se(oe,Ie){return Dn(oe)*Dn(Ie)>M}function s(oe){var Ie,Me,De,Ve,We;return{lineStart:function(){Ve=De=!1,We=1},point:function(st,ct){var gt=[st,ct],At,ot=se(st,ct),zt=N?ot?0:ce(st,ct):ot?ce(st+(st<0?qi:-qi),ct):0;if(!Ie&&(Ve=De=ot)&&oe.lineStart(),ot!==De&&(At=_e(Ie,gt),(!At||dm(Ie,At)||dm(gt,At))&&(gt[2]=1)),ot!==De)We=0,ot?(oe.lineStart(),At=_e(gt,Ie),oe.point(At[0],At[1])):(At=_e(Ie,gt),oe.point(At[0],At[1],2),oe.lineEnd()),Ie=At;else if($&&Ie&&N^ot){var Rt;!(zt&Me)&&(Rt=_e(gt,Ie,!0))&&(We=0,N?(oe.lineStart(),oe.point(Rt[0][0],Rt[0][1]),oe.point(Rt[1][0],Rt[1][1]),oe.lineEnd()):(oe.point(Rt[1][0],Rt[1][1]),oe.lineEnd(),oe.lineStart(),oe.point(Rt[0][0],Rt[0][1],3)))}ot&&(!Ie||!dm(Ie,gt))&&oe.point(gt[0],gt[1]),Ie=gt,De=ot,Me=zt},lineEnd:function(){De&&oe.lineEnd(),Ie=null},clean:function(){return We|(Ve&&De)<<1}}}function _e(oe,Ie,Me){var De=Xu(oe),Ve=Xu(Ie),We=[1,0,0],st=Tm(De,Ve),ct=tm(st,st),gt=st[0],At=ct-gt*gt;if(!At)return!Me&&oe;var ot=M*ct/At,zt=-M*gt/At,Rt=Tm(We,st),vt=im(We,ot),Nt=im(st,zt);Ug(vt,Nt);var Jt=Rt,It=tm(vt,Jt),xt=tm(Jt,Jt),$i=It*It-xt*(tm(vt,vt)-1);if(!($i<0)){var ki=ma($i),Oi=im(Jt,(-It-ki)/xt);if(Ug(Oi,vt),Oi=ny(Oi),!Me)return Oi;var tt=oe[0],ai=Ie[0],wi=oe[1],Wi=Ie[1],Zt;ai<tt&&(Zt=tt,tt=ai,ai=Zt);var Fn=ai-tt,Bn=Sn(Fn-qi)<yn,Ln=Bn||Fn<yn;if(!Bn&&Wi<wi&&(Zt=wi,wi=Wi,Wi=Zt),Ln?Bn?wi+Wi>0^Oi[1]<(Sn(Oi[0]-tt)<yn?wi:Wi):wi<=Oi[1]&&Oi[1]<=Wi:Fn>qi^(tt<=Oi[0]&&Oi[0]<=ai)){var qt=im(Jt,(-It+ki)/xt);return Ug(qt,vt),[Oi,ny(qt)]}}}function ce(oe,Ie){var Me=N?P:qi-P,De=0;return oe<-Me?De|=1:oe>Me&&(De|=2),Ie<-Me?De|=4:Ie>Me&&(De|=8),De}return kb(se,s,Y,N?[0,-P]:[-qi,P-qi])}function G4(P,M,k,N,$,Y){var se=P[0],s=P[1],_e=M[0],ce=M[1],oe=0,Ie=1,Me=_e-se,De=ce-s,Ve;if(Ve=k-se,!(!Me&&Ve>0)){if(Ve/=Me,Me<0){if(Ve<oe)return;Ve<Ie&&(Ie=Ve)}else if(Me>0){if(Ve>Ie)return;Ve>oe&&(oe=Ve)}if(Ve=$-se,!(!Me&&Ve<0)){if(Ve/=Me,Me<0){if(Ve>Ie)return;Ve>oe&&(oe=Ve)}else if(Me>0){if(Ve<oe)return;Ve<Ie&&(Ie=Ve)}if(Ve=N-s,!(!De&&Ve>0)){if(Ve/=De,De<0){if(Ve<oe)return;Ve<Ie&&(Ie=Ve)}else if(De>0){if(Ve>Ie)return;Ve>oe&&(oe=Ve)}if(Ve=Y-s,!(!De&&Ve<0)){if(Ve/=De,De<0){if(Ve>Ie)return;Ve>oe&&(oe=Ve)}else if(De>0){if(Ve<oe)return;Ve<Ie&&(Ie=Ve)}return oe>0&&(P[0]=se+oe*Me,P[1]=s+oe*De),Ie<1&&(M[0]=se+Ie*Me,M[1]=s+Ie*De),!0}}}}}var rm=1e9,sm=-1e9;function q4(P,M,k,N){function $(ce,oe){return P<=ce&&ce<=k&&M<=oe&&oe<=N}function Y(ce,oe,Ie,Me){var De=0,Ve=0;if(ce==null||(De=se(ce,Ie))!==(Ve=se(oe,Ie))||_e(ce,oe)<0^Ie>0)do Me.point(De===0||De===3?P:k,De>1?N:M);while((De=(De+Ie+4)%4)!==Ve);else Me.point(oe[0],oe[1])}function se(ce,oe){return Sn(ce[0]-P)<yn?oe>0?0:3:Sn(ce[0]-k)<yn?oe>0?2:1:Sn(ce[1]-M)<yn?oe>0?1:0:oe>0?3:2}function s(ce,oe){return _e(ce.x,oe.x)}function _e(ce,oe){var Ie=se(ce,1),Me=se(oe,1);return Ie!==Me?Ie-Me:Ie===0?oe[1]-ce[1]:Ie===1?ce[0]-oe[0]:Ie===2?ce[1]-oe[1]:oe[0]-ce[0]}return function(ce){var oe=ce,Ie=Db(),Me,De,Ve,We,st,ct,gt,At,ot,zt,Rt,vt={point:Nt,lineStart:$i,lineEnd:ki,polygonStart:It,polygonEnd:xt};function Nt(tt,ai){$(tt,ai)&&oe.point(tt,ai)}function Jt(){for(var tt=0,ai=0,wi=De.length;ai<wi;++ai)for(var Wi=De[ai],Zt=1,Fn=Wi.length,Bn=Wi[0],Ln,qt,ls=Bn[0],nr=Bn[1];Zt<Fn;++Zt)Ln=ls,qt=nr,Bn=Wi[Zt],ls=Bn[0],nr=Bn[1],qt<=N?nr>N&&(ls-Ln)*(N-qt)>(nr-qt)*(P-Ln)&&++tt:nr<=N&&(ls-Ln)*(N-qt)<(nr-qt)*(P-Ln)&&--tt;return tt}function It(){oe=Ie,Me=[],De=[],Rt=!0}function xt(){var tt=Jt(),ai=Rt&&tt,wi=(Me=Rb(Me)).length;(ai||wi)&&(ce.polygonStart(),ai&&(ce.lineStart(),Y(null,null,1,ce),ce.lineEnd()),wi&&Lb(Me,s,tt,Y,ce),ce.polygonEnd()),oe=ce,Me=De=Ve=null}function $i(){vt.point=Oi,De&&De.push(Ve=[]),zt=!0,ot=!1,gt=At=NaN}function ki(){Me&&(Oi(We,st),ct&&ot&&Ie.rejoin(),Me.push(Ie.result())),vt.point=Nt,ot&&oe.lineEnd()}function Oi(tt,ai){var wi=$(tt,ai);if(De&&Ve.push([tt,ai]),zt)We=tt,st=ai,ct=wi,zt=!1,wi&&(oe.lineStart(),oe.point(tt,ai));else if(wi&&ot)oe.point(tt,ai);else{var Wi=[gt=Math.max(sm,Math.min(rm,gt)),At=Math.max(sm,Math.min(rm,At))],Zt=[tt=Math.max(sm,Math.min(rm,tt)),ai=Math.max(sm,Math.min(rm,ai))];G4(Wi,Zt,P,M,k,N)?(ot||(oe.lineStart(),oe.point(Wi[0],Wi[1])),oe.point(Zt[0],Zt[1]),wi||oe.lineEnd(),Rt=!1):wi&&(oe.lineStart(),oe.point(tt,ai),Rt=!1)}gt=tt,At=ai,ot=wi}return vt}}const ay=P=>P;var Gg=new Sc,ly=new Sc,Ob,Fb,cy,uy,da={point:Rs,lineStart:Rs,lineEnd:Rs,polygonStart:function(){da.lineStart=$4,da.lineEnd=H4},polygonEnd:function(){da.lineStart=da.lineEnd=da.point=Rs,Gg.add(Sn(ly)),ly=new Sc},result:function(){var P=Gg/2;return Gg=new Sc,P}};function $4(){da.point=Z4}function Z4(P,M){da.point=Bb,Ob=cy=P,Fb=uy=M}function Bb(P,M){ly.add(uy*P-cy*M),cy=P,uy=M}function H4(){Bb(Ob,Fb)}var Yu=1/0,Sm=Yu,mf=-Yu,Em=mf,Mm={point:W4,lineStart:Rs,lineEnd:Rs,polygonStart:Rs,polygonEnd:Rs,result:function(){var P=[[Yu,Sm],[mf,Em]];return mf=Em=-(Sm=Yu=1/0),P}};function W4(P,M){P<Yu&&(Yu=P),P>mf&&(mf=P),M<Sm&&(Sm=M),M>Em&&(Em=M)}var hy=0,dy=0,rf=0,Im=0,Am=0,qu=0,fy=0,py=0,sf=0,Nb,Vb,Ao,Co,Ps={point:Mc,lineStart:Ov,lineEnd:Fv,polygonStart:function(){Ps.lineStart=K4,Ps.lineEnd=J4},polygonEnd:function(){Ps.point=Mc,Ps.lineStart=Ov,Ps.lineEnd=Fv},result:function(){var P=sf?[fy/sf,py/sf]:qu?[Im/qu,Am/qu]:rf?[hy/rf,dy/rf]:[NaN,NaN];return hy=dy=rf=Im=Am=qu=fy=py=sf=0,P}};function Mc(P,M){hy+=P,dy+=M,++rf}function Ov(){Ps.point=X4}function X4(P,M){Ps.point=Y4,Mc(Ao=P,Co=M)}function Y4(P,M){var k=P-Ao,N=M-Co,$=ma(k*k+N*N);Im+=$*(Ao+P)/2,Am+=$*(Co+M)/2,qu+=$,Mc(Ao=P,Co=M)}function Fv(){Ps.point=Mc}function K4(){Ps.point=Q4}function J4(){Ub(Nb,Vb)}function Q4(P,M){Ps.point=Ub,Mc(Nb=Ao=P,Vb=Co=M)}function Ub(P,M){var k=P-Ao,N=M-Co,$=ma(k*k+N*N);Im+=$*(Ao+P)/2,Am+=$*(Co+M)/2,qu+=$,$=Co*P-Ao*M,fy+=$*(Ao+P),py+=$*(Co+M),sf+=$*3,Mc(Ao=P,Co=M)}function jb(P){this._context=P}jb.prototype={_radius:4.5,pointRadius:function(P){return this._radius=P,this},polygonStart:function(){this._line=0},polygonEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){this._line===0&&this._context.closePath(),this._point=NaN},point:function(P,M){switch(this._point){case 0:{this._context.moveTo(P,M),this._point=1;break}case 1:{this._context.lineTo(P,M);break}default:{this._context.moveTo(P+this._radius,M),this._context.arc(P,M,this._radius,0,Fs);break}}},result:Rs};var my=new Sc,qg,Gb,qb,of,af,_f={point:Rs,lineStart:function(){_f.point=eS},lineEnd:function(){qg&&$b(Gb,qb),_f.point=Rs},polygonStart:function(){qg=!0},polygonEnd:function(){qg=null},result:function(){var P=+my;return my=new Sc,P}};function eS(P,M){_f.point=$b,Gb=of=P,qb=af=M}function $b(P,M){of-=P,af-=M,my.add(ma(of*of+af*af)),of=P,af=M}let Bv,Cm,Nv,Vv;class Uv{constructor(M){this._append=M==null?Zb:tS(M),this._radius=4.5,this._=""}pointRadius(M){return this._radius=+M,this}polygonStart(){this._line=0}polygonEnd(){this._line=NaN}lineStart(){this._point=0}lineEnd(){this._line===0&&(this._+="Z"),this._point=NaN}point(M,k){switch(this._point){case 0:{this._append`M${M},${k}`,this._point=1;break}case 1:{this._append`L${M},${k}`;break}default:{if(this._append`M${M},${k}`,this._radius!==Nv||this._append!==Cm){const N=this._radius,$=this._;this._="",this._append`m0,${N}a${N},${N} 0 1,1 0,${-2*N}a${N},${N} 0 1,1 0,${2*N}z`,Nv=N,Cm=this._append,Vv=this._,this._=$}this._+=Vv;break}}}result(){const M=this._;return this._="",M.length?M:null}}function Zb(P){let M=1;this._+=P[0];for(const k=P.length;M<k;++M)this._+=arguments[M]+P[M]}function tS(P){const M=Math.floor(P);if(!(M>=0))throw new RangeError(`invalid digits: ${P}`);if(M>15)return Zb;if(M!==Bv){const k=10**M;Bv=M,Cm=function($){let Y=1;this._+=$[0];for(const se=$.length;Y<se;++Y)this._+=Math.round(arguments[Y]*k)/k+$[Y]}}return Cm}function iS(P,M){let k=3,N=4.5,$,Y;function se(s){return s&&(typeof N=="function"&&Y.pointRadius(+N.apply(this,arguments)),Gu(s,$(Y))),Y.result()}return se.area=function(s){return Gu(s,$(da)),da.result()},se.measure=function(s){return Gu(s,$(_f)),_f.result()},se.bounds=function(s){return Gu(s,$(Mm)),Mm.result()},se.centroid=function(s){return Gu(s,$(Ps)),Ps.result()},se.projection=function(s){return arguments.length?($=s==null?(P=null,ay):(P=s).stream,se):P},se.context=function(s){return arguments.length?(Y=s==null?(M=null,new Uv(k)):new jb(M=s),typeof N!="function"&&Y.pointRadius(N),se):M},se.pointRadius=function(s){return arguments.length?(N=typeof s=="function"?s:(Y.pointRadius(+s),+s),se):N},se.digits=function(s){if(!arguments.length)return k;if(s==null)k=null;else{const _e=Math.floor(s);if(!(_e>=0))throw new RangeError(`invalid digits: ${s}`);k=_e}return M===null&&(Y=new Uv(k)),se},se.projection(P).digits(k).context(M)}function Dy(P){return function(M){var k=new _y;for(var N in P)k[N]=P[N];return k.stream=M,k}}function _y(){}_y.prototype={constructor:_y,point:function(P,M){this.stream.point(P,M)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}};function Ly(P,M,k){var N=P.clipExtent&&P.clipExtent();return P.scale(150).translate([0,0]),N!=null&&P.clipExtent(null),Gu(k,P.stream(Mm)),M(Mm.result()),N!=null&&P.clipExtent(N),P}function Hb(P,M,k){return Ly(P,function(N){var $=M[1][0]-M[0][0],Y=M[1][1]-M[0][1],se=Math.min($/(N[1][0]-N[0][0]),Y/(N[1][1]-N[0][1])),s=+M[0][0]+($-se*(N[1][0]+N[0][0]))/2,_e=+M[0][1]+(Y-se*(N[1][1]+N[0][1]))/2;P.scale(150*se).translate([s,_e])},k)}function nS(P,M,k){return Hb(P,[[0,0],M],k)}function rS(P,M,k){return Ly(P,function(N){var $=+M,Y=$/(N[1][0]-N[0][0]),se=($-Y*(N[1][0]+N[0][0]))/2,s=-Y*N[0][1];P.scale(150*Y).translate([se,s])},k)}function sS(P,M,k){return Ly(P,function(N){var $=+M,Y=$/(N[1][1]-N[0][1]),se=-Y*N[0][0],s=($-Y*(N[1][1]+N[0][1]))/2;P.scale(150*Y).translate([se,s])},k)}var jv=16,oS=Dn(30*kr);function Gv(P,M){return+M?lS(P,M):aS(P)}function aS(P){return Dy({point:function(M,k){M=P(M,k),this.stream.point(M[0],M[1])}})}function lS(P,M){function k(N,$,Y,se,s,_e,ce,oe,Ie,Me,De,Ve,We,st){var ct=ce-N,gt=oe-$,At=ct*ct+gt*gt;if(At>4*M&&We--){var ot=se+Me,zt=s+De,Rt=_e+Ve,vt=ma(ot*ot+zt*zt+Rt*Rt),Nt=Ec(Rt/=vt),Jt=Sn(Sn(Rt)-1)<yn||Sn(Y-Ie)<yn?(Y+Ie)/2:Wu(zt,ot),It=P(Jt,Nt),xt=It[0],$i=It[1],ki=xt-N,Oi=$i-$,tt=gt*ki-ct*Oi;(tt*tt/At>M||Sn((ct*ki+gt*Oi)/At-.5)>.3||se*Me+s*De+_e*Ve<oS)&&(k(N,$,Y,se,s,_e,xt,$i,Jt,ot/=vt,zt/=vt,Rt,We,st),st.point(xt,$i),k(xt,$i,Jt,ot,zt,Rt,ce,oe,Ie,Me,De,Ve,We,st))}}return function(N){var $,Y,se,s,_e,ce,oe,Ie,Me,De,Ve,We,st={point:ct,lineStart:gt,lineEnd:ot,polygonStart:function(){N.polygonStart(),st.lineStart=zt},polygonEnd:function(){N.polygonEnd(),st.lineStart=gt}};function ct(Nt,Jt){Nt=P(Nt,Jt),N.point(Nt[0],Nt[1])}function gt(){Ie=NaN,st.point=At,N.lineStart()}function At(Nt,Jt){var It=Xu([Nt,Jt]),xt=P(Nt,Jt);k(Ie,Me,oe,De,Ve,We,Ie=xt[0],Me=xt[1],oe=Nt,De=It[0],Ve=It[1],We=It[2],jv,N),N.point(Ie,Me)}function ot(){st.point=ct,N.lineEnd()}function zt(){gt(),st.point=Rt,st.lineEnd=vt}function Rt(Nt,Jt){At($=Nt,Jt),Y=Ie,se=Me,s=De,_e=Ve,ce=We,st.point=At}function vt(){k(Ie,Me,oe,De,Ve,We,Y,se,$,s,_e,ce,jv,N),st.lineEnd=ot,ot()}return st}}var cS=Dy({point:function(P,M){this.stream.point(P*kr,M*kr)}});function uS(P){return Dy({point:function(M,k){var N=P(M,k);return this.stream.point(N[0],N[1])}})}function hS(P,M,k,N,$){function Y(se,s){return se*=N,s*=$,[M+P*se,k-P*s]}return Y.invert=function(se,s){return[(se-M)/P*N,(k-s)/P*$]},Y}function qv(P,M,k,N,$,Y){if(!Y)return hS(P,M,k,N,$);var se=Dn(Y),s=gn(Y),_e=se*P,ce=s*P,oe=se/P,Ie=s/P,Me=(s*k-se*M)/P,De=(s*M+se*k)/P;function Ve(We,st){return We*=N,st*=$,[_e*We-ce*st+M,k-ce*We-_e*st]}return Ve.invert=function(We,st){return[N*(oe*We-Ie*st+Me),$*(De-Ie*We-oe*st)]},Ve}function dS(P){var M,k=150,N=480,$=250,Y=0,se=0,s=0,_e=0,ce=0,oe,Ie=0,Me=1,De=1,Ve=null,We=kv,st=null,ct,gt,At,ot=ay,zt=.5,Rt,vt,Nt,Jt,It;function xt(tt){return Nt(tt[0]*kr,tt[1]*kr)}function $i(tt){return tt=Nt.invert(tt[0],tt[1]),tt&&[tt[0]*so,tt[1]*so]}xt.stream=function(tt){return Jt&&It===tt?Jt:Jt=cS(uS(oe)(We(Rt(ot(It=tt)))))},xt.preclip=function(tt){return arguments.length?(We=tt,Ve=void 0,Oi()):We},xt.postclip=function(tt){return arguments.length?(ot=tt,st=ct=gt=At=null,Oi()):ot},xt.clipAngle=function(tt){return arguments.length?(We=+tt?j4(Ve=tt*kr):(Ve=null,kv),Oi()):Ve*so},xt.clipExtent=function(tt){return arguments.length?(ot=tt==null?(st=ct=gt=At=null,ay):q4(st=+tt[0][0],ct=+tt[0][1],gt=+tt[1][0],At=+tt[1][1]),Oi()):st==null?null:[[st,ct],[gt,At]]},xt.scale=function(tt){return arguments.length?(k=+tt,ki()):k},xt.translate=function(tt){return arguments.length?(N=+tt[0],$=+tt[1],ki()):[N,$]},xt.center=function(tt){return arguments.length?(Y=tt[0]%360*kr,se=tt[1]%360*kr,ki()):[Y*so,se*so]},xt.rotate=function(tt){return arguments.length?(s=tt[0]%360*kr,_e=tt[1]%360*kr,ce=tt.length>2?tt[2]%360*kr:0,ki()):[s*so,_e*so,ce*so]},xt.angle=function(tt){return arguments.length?(Ie=tt%360*kr,ki()):Ie*so},xt.reflectX=function(tt){return arguments.length?(Me=tt?-1:1,ki()):Me<0},xt.reflectY=function(tt){return arguments.length?(De=tt?-1:1,ki()):De<0},xt.precision=function(tt){return arguments.length?(Rt=Gv(vt,zt=tt*tt),Oi()):ma(zt)},xt.fitExtent=function(tt,ai){return Hb(xt,tt,ai)},xt.fitSize=function(tt,ai){return nS(xt,tt,ai)},xt.fitWidth=function(tt,ai){return rS(xt,tt,ai)},xt.fitHeight=function(tt,ai){return sS(xt,tt,ai)};function ki(){var tt=qv(k,0,0,Me,De,Ie).apply(null,M(Y,se)),ai=qv(k,N-tt[0],$-tt[1],Me,De,Ie);return oe=L4(s,_e,ce),vt=sy(M,ai),Nt=sy(oe,vt),Rt=Gv(vt,zt),Oi()}function Oi(){return Jt=It=null,xt}return function(){return M=P.apply(this,arguments),xt.invert=M.invert&&$i,ki()}}function fS(P){var M=0,k=qi/3,N=dS(P),$=N(M,k);return $.parallels=function(Y){return arguments.length?N(M=Y[0]*kr,k=Y[1]*kr):[M*so,k*so]},$}function pS(P){var M=Dn(P);function k(N,$){return[N*M,gn($)/M]}return k.invert=function(N,$){return[N/M,Ec($*M)]},k}function mS(P,M){var k=gn(P),N=(k+gn(M))/2;if(Sn(N)<yn)return pS(P);var $=1+k*(2*N-k),Y=ma($)/N;function se(s,_e){var ce=ma($-2*N*gn(_e))/N;return[ce*gn(s*=N),Y-ce*Dn(s)]}return se.invert=function(s,_e){var ce=Y-_e,oe=Wu(s,Sn(ce))*hm(ce);return ce*N<0&&(oe-=qi*hm(s)*hm(ce)),[oe/N,Ec(($-(s*s+ce*ce)*N*N)/(2*N))]},se}function _S(){return fS(mS).scale(155.424).center([0,33.6442])}function gS(){return _S().parallels([29.5,45.5]).scale(1070).translate([480,250]).rotate([96,0]).center([-.6,38.7])}var yS=n4('<rect fill="rgba(0,0,0,0.2)" stroke="#000" stroke-width="1" id="viewport-rect"></rect>'),xS=ur('<div class="minimap svelte-1u0ojp7"><svg><path fill="#eee" stroke="#666" stroke-width="1"></path><!></svg></div>');function vS(P,M){hl(M,!0);let k=am(null),N=am(Cs({x1:0,y1:0,x2:0,y2:0})),$=am("");const Y=200,se=120,s=gS().scale(250).translate([Y/2,se/2]).rotate([98,0]).center([0,38]),_e=iS().projection(s);function ce(){Xi($,Cs(_e(P4.features[0])))}function oe(ct,gt){return s([ct,gt])}function Ie(){if(!M.map)return;Xi(k,Cs(M.map.getBounds()));const ct=St(k).getSouthWest(),gt=St(k).getNorthEast(),[At,ot]=oe(ct.lng,ct.lat),[zt,Rt]=oe(gt.lng,gt.lat),vt=zt-At,Nt=Rt-ot;Xi(N,Cs({x:Math.min(At,zt),y:Math.min(ot,Rt),width:Math.abs(vt),height:Math.abs(Nt)}))}Cb(()=>{if(M.map)return ce(),M.map.on("move",Ie),Ie(),()=>{M.map.off("move",Ie)}});var Me=xS(),De=On(Me);Xn(De,"width",Y),Xn(De,"height",se),Xn(De,"viewBox",`0 0 ${Y} ${se}`);var Ve=On(De),We=ul(Ve);{var st=ct=>{var gt=yS();as(()=>{Xn(gt,"x",St(N).x),Xn(gt,"y",St(N).y),Xn(gt,"width",St(N).width),Xn(gt,"height",St(N).height)}),_n(ct,gt)};os(We,ct=>{St(k)&&ct(st)})}as(()=>Xn(Ve,"d",St($))),_n(P,Me),dl()}const ky=1e3;function bS(P){if(typeof P!="string")return!1;const M=P.split(",").map(Number);return M.length===2&&!M.some(isNaN)}function wS(P){if(typeof P!="string")return!1;const M=P.split(",").map(Number);return M.length===4&&!M.some(isNaN)}function TS(P){const M=P.features[0].geometry.coordinates[0];return M.reduce((N,$)=>[[Math.min(N[0][0],$[0]),Math.min(N[0][1],$[1])],[Math.max(N[1][0],$[0]),Math.max(N[1][1],$[1])]],[[M[0][0],M[0][1]],[M[0][0],M[0][1]]])}function SS(P){let M;if(typeof P=="string"?M=P.split(",").map(N=>Number(N.replace(/[^\d.-]/g,""))):M=P,M.length!==4)throw new Error("Invalid bbox format");return[[M[0],M[1]],[M[2],M[3]]]}function ES({map:P,target:M,duration:k=ky,padding:N={top:100,bottom:100,left:100,right:100},zoom:$=16}){if(M){if(bS(M)){const Y=M.split(",").map(Number).reverse();k===0?P.jumpTo({center:Y,zoom:$,essential:!0}):P.flyTo({center:Y,zoom:$,essential:!0,duration:k})}else if(wS(M)){const Y=SS(M);P.fitBounds(Y,{padding:N,duration:k||0})}else if(P.getSource(M)){const se=P.getSource(M)._data,s=TS(se);P.fitBounds(s,{padding:N,duration:k||0})}}}function MS({map:P,layerId:M,duration:k=ky}){[`${M}-fill`,`${M}-line`].forEach($=>{P.getLayer($)&&P.setLayoutProperty($,"visibility","visible")}),P.getLayer(M)&&P.setLayoutProperty(M,"visibility","visible")}function IS({map:P,layerId:M,duration:k=ky}){[`${M}-fill`,`${M}-line`].forEach($=>{P.getLayer($)&&P.setLayoutProperty($,"visibility","none")}),P.getLayer(M)&&P.setLayoutProperty(M,"visibility","none")}const AS="FeatureCollection",CS=JSON.parse('[{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-87.49430198805636,41.17323445871471],[-87.47736119613869,41.172206086467604],[-87.45987392706235,41.16932655829543],[-87.46096688137965,41.160275788694015],[-87.466431652966,41.15780718003312],[-87.49812732816679,41.13640867704555],[-87.50085971395997,41.12899987596308],[-87.49976675964271,41.12282523592902],[-87.49320903373908,41.11294460337885],[-87.4871977849941,41.10882723418018],[-87.46315279001416,41.10017991839592],[-87.45823449558647,41.09153146395317],[-87.45714154126921,41.083293782100704],[-87.45167676968286,41.07134730906862],[-87.45058381536558,41.06393116480233],[-87.4478514295724,41.05898660394532],[-87.44839790673103,41.054041671355044],[-87.44402608946197,41.04085336715276],[-87.44621199809652,41.03425822383947],[-87.45386267831738,41.02642563291716],[-87.4620598356969,41.024364269913896],[-87.46807108444187,41.015705840681804],[-87.46752460728325,41.00910817825907],[-87.46315279001416,41.00292226968862],[-87.44074722651017,40.99549841291502],[-87.42927120617884,40.99343608208736],[-87.4194346173234,40.99261113169166],[-87.40850507415074,40.99343608208736],[-87.40413325688165,40.99508595191083],[-87.39156428223306,40.99508595191083],[-87.3626009928254,40.98972372401665],[-87.35385735828726,40.98642367469449],[-87.34402076943185,40.98394852931889],[-87.33309122625916,40.984773588099614],[-87.31505748002424,40.9959108713385],[-87.30686032264471,40.9959108713385],[-87.29647725663064,40.99426102216043],[-87.28882657640973,40.986836189891804],[-87.27461817028528,40.98559863655817],[-87.25057317530533,40.98023563706966],[-87.24019010929126,40.98147329104398],[-87.2352718148636,40.99673578044346],[-87.23363238338766,41.00745865941836],[-87.22543522600817,41.01158237909438],[-87.21286625135957,41.01364414214948],[-87.2008437538696,41.011994736867194],[-87.19210011933146,41.003747091048496],[-87.18663534774511,40.99632332718134],[-87.18827477922103,40.987661212544694],[-87.18827477922103,40.98023563706966],[-87.18608887058647,40.97817282883607],[-87.17734523604834,40.97776025944795],[-87.17133398730336,40.98147329104398],[-87.16532273855834,40.990548710541205],[-87.16149739844792,40.99219865262285],[-87.14619603800614,40.99261113169166],[-87.13635944915072,40.990961199932556],[-87.12652286029531,40.98724870250854],[-87.10794263690173,40.986836189891804],[-87.10411729679129,40.99219865262285],[-87.10521025110855,41.00622149318906],[-87.11395388564671,41.016118172645484],[-87.11941865723306,41.021065954894446],[-87.13690592630935,41.03013592371504],[-87.15712558117886,41.04456284487675],[-87.17789171320696,41.054865852601175],[-87.18718182490375,41.060634832201785],[-87.194286027966,41.070523334344635],[-87.20302966250412,41.077526790337174],[-87.21286625135957,41.09194332093633],[-87.21450568283548,41.1055331529099],[-87.21614511431136,41.11047421284511],[-87.21341272851818,41.11870848645472],[-87.19865784523506,41.1327043810912],[-87.19046068785553,41.137643395879984],[-87.1800776218415,41.142170499423024],[-87.16095092128928,41.14669729048263],[-87.15111433243388,41.14793181562897],[-87.13472001767484,41.148754819480324],[-87.12761581461257,41.14752030982943],[-87.12324399734351,41.13599709893586],[-87.11777922575716,41.127764994437975],[-87.11122149985353,41.1257068069162],[-87.10575672826718,41.118296797305014],[-87.10029195668083,41.105944922105955],[-87.09154832214271,41.101415318937136],[-87.0800723018114,41.09688540334543],[-87.07187514443187,41.09523808385318],[-87.05274844387965,41.08658897876957],[-87.03088935753429,41.08452950021504],[-87.00848379403027,41.07793873510157],[-86.9833458447331,41.07670289306324],[-86.96367266702224,41.075055067535004],[-86.94017414920097,41.071759292558156],[-86.89754893082747,41.07011134311022],[-86.86530677846804,41.07217127346606],[-86.84508712359856,41.07299522753692],[-86.82158860577725,41.07093532299745],[-86.81393792555639,41.067639341489816],[-86.80628724533548,41.066403305828096],[-86.78661406762465,41.066815320296925],[-86.77623100161061,41.07464310469872],[-86.76748736707243,41.07876261688523],[-86.75491839242385,41.082881870899016],[-86.73360578323711,41.08823651514037],[-86.69425942781542,41.09029587751236],[-86.6860622704359,41.0923551753376],[-86.68059749884955,41.096061748763184],[-86.67841159021503,41.10306248351061],[-86.68005102169093,41.11088595105606],[-86.68551579327728,41.11665001488401],[-86.6926199963395,41.119531857007516],[-86.70027067656041,41.1257068069162],[-86.71885089995398,41.13723182551762],[-86.7270480573335,41.14093586581017],[-86.73633816903029,41.14834331884594],[-86.74234941777527,41.15574993512479],[-86.75000009799615,41.16768105680305],[-86.75874373253431,41.17385147431432],[-86.77404509297607,41.1804326124351],[-86.78388168183147,41.18701308931487],[-86.792078839211,41.194826546743094],[-86.79426474784555,41.19852733268206],[-86.79371827068691,41.2046948442709],[-86.78879997625918,41.206339415864534],[-86.77185918434152,41.207161686161655],[-86.76858032138972,41.21003955082755],[-86.76475498127928,41.21743919300094],[-86.75491839242385,41.22483799814691],[-86.74672123504432,41.22730408051782],[-86.7286874888094,41.23018105906626],[-86.71611851416081,41.23387984546839],[-86.70518897098812,41.242098621553],[-86.6926199963395,41.25853307322822],[-86.68770170191182,41.26880250612015],[-86.68660874759455,41.27865964228825],[-86.68278340748411,41.28789935561606],[-86.6762256815805,41.29323726033681],[-86.66529613840781,41.29693247698905],[-86.662017275456,41.30021693827689],[-86.66092432113874,41.31827851874193],[-86.65819193534556,41.32525551655107],[-86.65272716375921,41.3301800064462],[-86.64616943785559,41.332642111817876],[-86.62922864593794,41.336745413988005],[-86.6161131941307,41.34289988258708],[-86.60026535653029,41.3519253844753],[-86.59261467630942,41.35766823426],[-86.58878933619896,41.363000426809755],[-86.58496399608853,41.37366350123896],[-86.5811386559781,41.381454642747265],[-86.55764013815678,41.40892121948519],[-86.54343173203232,41.42039635002966],[-86.52813037159054,41.43391800842921],[-86.52157264568693,41.440472950339895],[-86.51829378273513,41.44784646866909],[-86.5166543512592,41.464229065048116],[-86.51392196546604,41.47323772923386],[-86.50353889945197,41.49698184337991],[-86.49971355934154,41.51498881524963],[-86.49862060502429,41.52644518983588],[-86.49534174207248,41.53544520418308],[-86.48769106185159,41.544852971283326],[-86.46747140698211,41.56529991723298],[-86.45544890949215,41.575520964561065],[-86.44342641200217,41.58165281671093],[-86.41664903122908,41.59841024201155],[-86.40025471647004,41.60699162889945],[-86.39588289920098,41.61271191947198],[-86.38768574182147,41.617614621964115],[-86.38058153875922,41.619657304681375],[-86.37293085853834,41.6237424760168],[-86.37784915296605,41.62782738854979],[-86.39205755909052,41.62578496463388],[-86.40790539669095,41.61843170281493],[-86.4199278941809,41.61720607765678],[-86.44014754905037,41.60780884432137],[-86.44451936631947,41.60413129340585],[-86.45818129528533,41.59841024201155],[-86.4723897014098,41.587784086657294],[-86.47785447299614,41.58533164854413],[-86.49042344764476,41.57633857848559],[-86.51228253399015,41.56325551371061],[-86.51774730557646,41.55548619040968],[-86.53468809749414,41.53462707280123],[-86.54725707214276,41.523172146907264],[-86.5516288894118,41.51826227208314],[-86.5560007066809,41.5068044488551],[-86.56310490974313,41.50271187764281],[-86.57895274734356,41.49616322567005],[-86.58988229051624,41.48981858760928],[-86.59917240221303,41.48613431904945],[-86.61010194538572,41.47999340587732],[-86.61338080833752,41.476718014230784],[-86.6303216002552,41.466071848195114],[-86.63797228047606,41.45624306622742],[-86.64179762058652,41.43985845265834],[-86.64616943785559,41.43494226174092],[-86.66037784398007,41.429206235028545],[-86.67403977294595,41.42715753122971],[-86.68824817907046,41.426338031609106],[-86.69863124508448,41.42387947068705],[-86.71065374257446,41.41650322938701],[-86.72595510301623,41.41445412478915],[-86.74070998629935,41.40830642314038],[-86.74726771220296,41.404617522900274],[-86.76420850412066,41.39805896091023],[-86.77950986456241,41.39354956558972],[-86.78606759046602,41.387399885985594],[-86.79535770216279,41.380839586560356],[-86.8030083823837,41.37673906332507],[-86.80847315397004,41.37038274139494],[-86.8095661082873,41.363000426809755],[-86.81557735703227,41.353566250400064],[-86.82268156009454,41.347823038714004],[-86.83087871747404,41.33961757171031],[-86.84399416928126,41.32197231651187],[-86.85710962108851,41.316226318408184],[-86.87350393584755,41.31540542018255],[-86.8838870018616,41.31581587058765],[-86.89536302219291,41.318688951054874],[-86.89700245366883,41.33141107076347],[-86.89372359071703,41.347823038714004],[-86.89590949935157,41.35397646041873],[-86.90902495115878,41.35643766624501],[-86.92104744864874,41.35397646041873],[-86.93033756034555,41.34536150717919],[-86.93798824056641,41.340438164938746],[-86.93798824056641,41.33223176738451],[-86.94017414920097,41.32443473204932],[-86.94837130658048,41.30965884313272],[-86.95274312384957,41.30350123416321],[-86.9658585756568,41.296521907698406],[-86.98170641325719,41.29323726033681],[-86.98607823052627,41.29036305821869],[-86.99372891074715,41.277632926718496],[-87.00465845391984,41.27270446716541],[-87.02487810878931,41.27229374540606],[-87.03744708343791,41.27270446716541],[-87.05329492103832,41.27434732836205],[-87.0800723018114,41.29323726033681],[-87.08444411908046,41.29775360781728],[-87.09537366225315,41.30596434753172],[-87.1008384338395,41.30883786220171],[-87.1117679770122,41.31006932972145],[-87.13472001767485,41.30596434753172],[-87.14510308368891,41.30144856861738],[-87.15220728675115,41.29364785030217],[-87.1751593274138,41.2809183596904],[-87.18281000763469,41.27188302106262],[-87.19264659649009,41.264900311866235],[-87.20084375386962,41.26120328114063],[-87.20248318534554,41.24682394982924],[-87.20904091124915,41.24024948703953],[-87.21669159147004,41.23696200760915],[-87.2336323833877,41.23244145340132],[-87.25275908393992,41.22463248708445],[-87.26696749006439,41.22093317751602],[-87.28336180482344,41.22052213020216],[-87.29155896220296,41.21846685488116],[-87.30412793685154,41.216822588122554],[-87.32325463740376,41.216000439242784],[-87.33090531762464,41.21312283678672],[-87.33199827194191,41.20654498440755],[-87.33473065773508,41.204078119267294],[-87.35276440397003,41.195032151451144],[-87.35112497249412,41.1876299751201],[-87.34347429227324,41.185162397028044],[-87.34019542932143,41.18146085553575],[-87.34183486079733,41.17775910482167],[-87.34675315522503,41.17487982073252],[-87.35549678976321,41.17364580309351],[-87.38664598780537,41.17405714488942],[-87.40249382540577,41.17775910482167],[-87.4248993889098,41.179404353190876],[-87.43582893208249,41.18269472594689],[-87.44020074935155,41.185573666500986],[-87.44020074935155,41.18968621916273],[-87.42927120617885,41.199144109996034],[-87.4248993889098,41.20078882108472],[-87.4139698457371,41.20202232727747],[-87.40795859699212,41.205311563462146],[-87.40795859699212,41.21476719654763],[-87.41888814016481,41.22052213020216],[-87.438014840717,41.22093317751602],[-87.45113029252424,41.2225773409368],[-87.45768801842785,41.22463248708445],[-87.46916403875917,41.22339940714632],[-87.47790767329732,41.21928897275988],[-87.4915696022632,41.2176447266687],[-87.52053289167083,41.20983399326358],[-87.53419482063669,41.20860063431739],[-87.54894970391982,41.209011756549444],[-87.55605390698204,41.20695611955611],[-87.56261163288569,41.20284465182313],[-87.56534401867886,41.19256485233274],[-87.55823981561659,41.1818721482558],[-87.54184550085759,41.18104956023272],[-87.52927652620896,41.178993044973],[-87.51780050587764,41.17446848410241],[-87.49430198805636,41.17323445871471]]]},"properties":{"id":1}}]'),PS={type:AS,features:CS},zS="FeatureCollection",RS=[{type:"Feature",geometry:{type:"Polygon",coordinates:[[[-87.73221344091606,42.125837670315875],[-87.81189352896227,42.12052566444613],[-87.85970158179,42.136461682055376],[-87.90219762874798,42.16302171140411],[-87.92344565222697,42.2055177583621],[-87.93406966396648,42.21614177010159],[-87.9818777167942,42.22676578184109],[-88.0031257402732,42.24270179945033],[-88.00843774614295,42.253325811189825],[-88.0243737637522,42.322381887496554],[-88.06686981071017,42.3276938933663],[-88.10936585766815,42.285197846408316],[-88.15186190462614,42.24270179945033],[-88.19435795158412,42.18958174075285],[-88.21560597506311,42.16833371727386],[-88.24747801028161,42.16302171140411],[-88.2581020220211,42.13114967618563],[-88.24216600441186,42.07802961748815],[-88.19966995745388,42.030221564660415],[-88.17842193397487,41.99303752357218],[-88.14123789288665,41.9505414766142],[-88.10405385179841,41.902733423786465],[-88.05624579897068,41.86554938269823],[-88.0243737637522,41.849613365088985],[-87.98718972266396,41.83367734747974],[-87.95000568157572,41.8177413298705],[-87.91282164048748,41.81242932400075],[-87.89688562287824,41.807117318131],[-87.85438957592025,41.78055728878226],[-87.84376556418076,41.743373247694024],[-87.84907757005051,41.722125224215034],[-87.8703255935295,41.700877200736045],[-87.89688562287824,41.65306914790831],[-87.9712537050547,41.59994908921083],[-88.00843774614295,41.58401307160159],[-88.05093379310094,41.57870106573184],[-88.1146778635379,41.5627650481226],[-88.1359258870169,41.557453042252845],[-88.15186190462614,41.52558100703436],[-88.15717391049589,41.50433298355537],[-88.15717391049589,41.483084960076376],[-88.15717391049589,41.461836936597386],[-88.22091798093287,41.4405889131184],[-88.2687260337606,41.42465289550915],[-88.31122208071858,41.408716877899906],[-88.38559016289506,41.38215684855117],[-88.43871022159253,41.371532836811674],[-88.48651827442026,41.36622083094192],[-88.56619836246648,41.33966080159318],[-88.62463042703371,41.32372478398394],[-88.70962252094968,41.318412778114194],[-88.81055063247489,41.31310077224445],[-88.82648665008414,41.3077887663747],[-88.8902307205211,41.2971647546352],[-89.02834287313455,41.29185274876545],[-89.10802296118077,41.281228737025955],[-89.17707903748749,41.25466870767722],[-89.24082310792447,41.21217266071923],[-89.26738313727321,41.20154864897974],[-89.2992551724917,41.174988619630994],[-89.32050319597069,41.14842859028226],[-89.32581520184044,41.079372513975535],[-89.34175121944968,41.02094044940831],[-89.36831124879842,40.97844440245032],[-89.38424726640767,40.951884373101585],[-89.41611930162615,40.86689227918562],[-89.4214313074959,40.824396232227635],[-89.43205531923539,40.7765881793999],[-89.4426793309749,40.73940413831167],[-89.46392735445389,40.70222009722343],[-89.49048738380262,40.675660067874695],[-89.5436074425001,40.638476026786456],[-89.5648554659791,40.62785201504696],[-89.60203950706733,40.606603991567965],[-89.62859953641606,40.59597997982847],[-89.6764075892438,40.58004396221923],[-89.71359163033203,40.55348393287049],[-89.74015165968078,40.53754791526124],[-89.798583724248,40.548171927000745],[-89.819831747727,40.55348393287049],[-89.84107977120598,40.548171927000745],[-89.86763980055473,40.50567588004276],[-89.89951183577321,40.479115850694015],[-89.93669587686145,40.436619803736036],[-89.97919192381943,40.383499745038556],[-90.01637596490767,40.34100369808057],[-90.0748080294749,40.28788363938309],[-90.12792808817237,40.234763580685616],[-90.1757361410001,40.181643521988136],[-90.2076081762186,40.15508349263939],[-90.22885619969759,40.13914747503015],[-90.25541622904632,40.12321145742091],[-90.3191602994833,40.08602741633267],[-90.33509631709255,40.06477939285368],[-90.36165634644128,40.04353136937469],[-90.38290436992027,40.0116593341562],[-90.35634434057154,39.99041131067721],[-90.34040832296229,39.969163287198214],[-90.28197625839506,39.963851281328466],[-90.23948021143708,39.947915263719224],[-90.1863601527396,39.93729125197973],[-90.1757361410001,39.90541921676124],[-90.18104814686986,39.85761116393351],[-90.14917611165137,39.80449110523603],[-90.10136805882364,39.76730706414779],[-90.06949602360514,39.73543502892931],[-90.02168797077742,39.67700296436208],[-89.97919192381943,39.63981892327384],[-89.94200788273119,39.581386858706615],[-89.89419982990347,39.51764278826964],[-89.82514375359673,39.43796270022342],[-89.77733570076902,39.400778659135185],[-89.75077567142027,39.37421862978645],[-89.74546366555052,39.34234659456796],[-89.76671168902952,39.305162553479725],[-89.76671168902952,39.26797851239149],[-89.71359163033203,39.230794471303255],[-89.62328753054632,39.236106477173],[-89.59672750119758,39.25735450065199],[-89.55954346010934,39.28922653587048],[-89.52767142489085,39.305162553479725],[-89.45330334271439,39.326410576958715],[-89.33112720771018,39.31047455934947],[-89.27269514314295,39.31047455934947],[-89.20363906683623,39.31047455934947],[-89.145207002269,39.326410576958715],[-89.08677493770178,39.36359461804695],[-89.04959089661354,39.37421862978645],[-89.01240685552531,39.42202668261418],[-88.97522281443707,39.46983473544191],[-88.92210275573959,39.4910827589209],[-88.88491871465136,39.47514674131166],[-88.84773467356312,39.46983473544191],[-88.78399060312614,39.48045874718141],[-88.68306249160094,39.507018776530145],[-88.67243847986144,39.4910827589209],[-88.67243847986144,39.44858671196292],[-88.70962252094968,39.416714676744434],[-88.72024653268917,39.40609066500494],[-88.69368650334043,39.36359461804695],[-88.69899850921018,39.32109857108897],[-88.68306249160094,39.305162553479725],[-88.65119045638245,39.31047455934947],[-88.57682237420597,39.32109857108897],[-88.513078303769,39.3689066239167],[-88.46527025094127,39.42202668261418],[-88.40152618050429,39.46983473544191],[-88.35371812767656,39.49639476479065],[-88.24747801028161,39.53357880587889],[-88.15186190462614,39.55482682935788],[-88.1146778635379,39.55482682935788],[-88.01906175788244,39.57607485283687],[-87.91282164048748,39.58669886457636],[-87.84907757005051,39.60263488218561],[-87.80658152309253,39.6238829056646],[-87.77470948787403,39.66106694675284],[-87.7269014350463,39.69825098784107],[-87.67909338221858,39.73543502892931],[-87.6259733235211,39.80449110523603],[-87.6153493117816,39.84698715219401],[-87.59410128830261,39.889483199152],[-87.61003730591185,39.926667240240235],[-87.63659733526059,39.98509930480746],[-87.64722134700008,39.99572331654696],[-87.66846937047907,40.001035322416705],[-87.67909338221858,40.03290735763519],[-87.7269014350463,40.03290735763519],[-87.75346146439504,40.04353136937469],[-87.7693974820043,40.08071541046292],[-87.76408547613454,40.11789945155116],[-87.71096541743707,40.15508349263939],[-87.68971739395808,40.15508349263939],[-87.66315736460933,40.149771486769644],[-87.6259733235211,40.13914747503015],[-87.58878928243286,40.128523463290655],[-87.56754125895387,40.09133942220242],[-87.53566922373538,40.05946738698393],[-87.53566922373538,40.37287573329906],[-87.54098122960512,40.45255582134528],[-87.54629323547488,40.675660067874695],[-87.53035721786563,40.675660067874695],[-87.53035721786563,40.79252419700914],[-87.54098122960512,40.803148208748645],[-87.53566922373538,40.96250838484108],[-87.53035721786563,40.96782039071083],[-87.53035721786563,41.07406050810579],[-87.54098122960512,41.22279667245873],[-87.53566922373538,41.36622083094192],[-87.52504521199589,41.499020977685625],[-87.51973320612613,41.70618920660579],[-87.55160524134463,41.753997259433525],[-87.59941329417235,41.807117318131],[-87.6047253000421,41.87617339443773],[-87.6259733235211,41.9399174648747],[-87.64722134700008,41.96647749422344],[-87.67378137634883,42.04084557639991],[-87.68440538808832,42.05678159400915],[-87.7269014350463,42.10990165270663],[-87.73221344091606,42.125837670315875]]]},properties:{id:1}}],DS={type:zS,features:RS},LS="FeatureCollection",kS=[{type:"Feature",geometry:{type:"Polygon",coordinates:[[[-88.6142237002226,43.6183440292215],[-88.6168170619938,43.6183701810696],[-88.6167907438167,43.6256495292458],[-88.6093107305915,43.6255709076836],[-88.6119156598716,43.6300240462452],[-88.6152823863036,43.6338278936561],[-88.6118637333796,43.6346067389877],[-88.6135864941927,43.6372570023114],[-88.6135255734854,43.6399775287539],[-88.6228709796747,43.6436541957836],[-88.6314337672301,43.6438142892932],[-88.6315154070896,43.642373607056],[-88.636777566657,43.6424463617505],[-88.6364603961384,43.647478689581],[-88.6429421240604,43.6474932741924],[-88.6492726417001,43.6454324984784],[-88.6495433770943,43.6394339044951],[-88.6545058004567,43.6384937900442],[-88.6545465362691,43.6367475037602],[-88.6604869599184,43.6357840872466],[-88.6628620562967,43.6329404426449],[-88.6743005076862,43.6329578759577],[-88.6844391379572,43.6265646173154],[-88.6844300164095,43.6217968875472],[-88.6879124852322,43.6199751660434],[-88.69148909929,43.6199659588262],[-88.6916910605146,43.6126575046355],[-88.6884364825526,43.6126697118337],[-88.6886466247693,43.6052674816272],[-88.6895168486068,43.6015879269811],[-88.6919065293128,43.6015763598351],[-88.6920170029063,43.5977285632077],[-88.6945463266549,43.5977285630552],[-88.6946395328334,43.5902891198492],[-88.6969911583096,43.5883622873966],[-88.6996252570885,43.5883565872368],[-88.6996834261963,43.5716120565306],[-88.6949275327864,43.5715887548134],[-88.6947763215062,43.5607440790712],[-88.6895662969594,43.5606974763774],[-88.6898108801826,43.5532377491577],[-88.6847378156746,43.5531767294532],[-88.6841760596793,43.5458886633094],[-88.6837044915457,43.5283466775022],[-88.6886121608933,43.5274305570589],[-88.6936294624765,43.5283023148981],[-88.6986082318162,43.5271326914094],[-88.7058218259537,43.5271678459811],[-88.705837874669,43.5246211905684],[-88.6836969881193,43.524612980899],[-88.6253508367574,43.5237508832659],[-88.5899991442657,43.5235151863498],[-88.5912622970444,43.5270863808521],[-88.5859912524751,43.5270107761562],[-88.5860117048913,43.5306285737406],[-88.5796986210074,43.5305004980987],[-88.5796230164231,43.5343657297288],[-88.5763166904328,43.5342668239112],[-88.5763341100673,43.5398171528085],[-88.5810841504747,43.5398230205243],[-88.5849086467878,43.5414150785524],[-88.5860873105583,43.5451289330825],[-88.5834270617664,43.5450940642366],[-88.5834154951821,43.5487874668348],[-88.5860117071644,43.5506676959831],[-88.5922490180222,43.5507609016236],[-88.5952671751123,43.552489753722],[-88.5959395720317,43.5588318377072],[-88.6009631836583,43.5600542546031],[-88.6013153929585,43.5705758912828],[-88.6102275376502,43.5710358898215],[-88.6088391586396,43.5745576304741],[-88.6059519277868,43.574577915651],[-88.6059722130383,43.5855245154185],[-88.6085335557993,43.5855449662678],[-88.608574292209,43.5890375388296],[-88.6184934401654,43.5892006502592],[-88.6183973827263,43.5855944196824],[-88.6209645924883,43.5856090035304],[-88.620877252868,43.5803874126921],[-88.6258629773458,43.5803991463941],[-88.6259357329621,43.5856235882336],[-88.6283748676848,43.5856264380873],[-88.6282176249025,43.596724414889],[-88.6261191304774,43.5984473992935],[-88.6261424328476,43.6016345348067],[-88.6123406197518,43.6015674796266],[-88.6124308098522,43.6109860581418],[-88.6166016460937,43.6110385288992],[-88.6166482495321,43.6147611004972],[-88.6141829627974,43.6147232146395],[-88.6142237002226,43.6183440292215]]]},properties:{id:1}}],OS={type:LS,features:kS},gy=[{source:{id:"kankakee-marsh",data:PS},layers:[{type:"fill",paint:{"fill-color":"#B85450","fill-opacity":.6}},{type:"line",paint:{"line-color":"#B85450","line-width":2}}]},{source:{id:"grand-prairie-region",data:DS},layers:[{type:"fill",paint:{"fill-color":"#B85450","fill-opacity":.6}},{type:"line",paint:{"line-color":"#B85450","line-width":2}}]},{source:{id:"horicon-marsh",data:OS},layers:[{type:"fill",paint:{"fill-color":"#B85450","fill-opacity":.6}},{type:"line",paint:{"line-color":"#B85450","line-width":2}}]}];var $g=f4(()=>I4),FS=ur('<div class="map-container svelte-zr38m0" aria-hidden="true"><div class="map svelte-zr38m0" aria-hidden="true"></div> <!></div>');function BS(P,M){hl(M,!1);let k=yr(M,"mapId",8),N=yr(M,"style",8),$=yr(M,"controller",8),Y=Zr(),se=Zr();const s=2e3;function _e(We,{source:st,layers:ct}){if(!We.isStyleLoaded()){const At=()=>{gt(),We.off("style.load",At)};We.on("style.load",At);return}function gt(){We.getSource(st.id)||We.addSource(st.id,{type:"geojson",data:st.data}),ct.forEach(At=>{const ot=`${st.id}-${At.type}`;We.getLayer(ot)||We.addLayer({id:ot,type:At.type,source:st.id,paint:At.paint,layout:{visibility:"none",...At.layout}})})}return gt(),{update(At){},destroy(){}}}function ce(We){$g($g().accessToken="pk.eyJ1IjoiYWd3YXRlcmRlc2siLCJhIjoiY2x2dHBvcHZnMTJwajJsbGx4NDg1NzkzdiJ9.x-5N8xgT9tGsilVw5h5kjw"),Xi(Y,new($g()).Map({container:k(),interactive:!0,center:[-95.646,38.924],zoom:8,style:N()})),gy.forEach(st=>{_e(St(Y),st)})}async function oe({init:We=!1,activeController:st=$(),preloadTiles:ct=!1}){if(!St(Y).isStyleLoaded())return;const gt=gy.flatMap(At=>At.layers.map(ot=>`${At.source.id}-${ot.type}`));st.flyTo&&ES({map:St(Y),target:st.flyTo,duration:We?0:s}),gt.filter(At=>!At.startsWith(st.showLayer)).forEach(At=>{IS({map:St(Y),layerId:At,duration:We?0:s})}),st.showLayer&&MS({map:St(Y),layerId:st.showLayer,duration:We?0:s})}gc(()=>(St(Y),ua($())),()=>{St(Y)&&$()&&oe({})}),hb(),Ab();var Ie=FS(),Me=On(Ie);Sb(Me,We=>ce==null?void 0:ce()),cm(Me,We=>Xi(se,We),()=>St(se));var De=ul(Me,2);{var Ve=We=>{vS(We,{get map(){return St(Y)}})};os(De,We=>{St(Y)&&We(Ve)})}as(()=>Xn(Me,"id",k())),_n(P,Ie),dl()}var NS=ur('<img class="svelte-14dndqg">'),VS=ur("<video autoplay></video>",2),US=ur('<span class="caption svelte-14dndqg"> </span>'),jS=ur('<span class="credit svelte-14dndqg"> </span>'),GS=ur('<figcaption class="svelte-14dndqg"><!> <!></figcaption>'),qS=ur('<figure class="svelte-14dndqg"><!> <!></figure>');function $v(P,M){var k=qS(),N=On(k);{var $=_e=>{var ce=NS();as(()=>{Xn(ce,"src",`images/${M.src}`),Xn(ce,"alt",M.alt)}),_n(_e,ce)},Y=_e=>{var ce=vc(),oe=yc(ce);{var Ie=Me=>{var De=VS();De.muted=!0,as(()=>{Xn(De,"src",`videos/${M.src}`),Xn(De,"alt",M.alt)}),_n(Me,De)};os(oe,Me=>{M.type==="video"&&Me(Ie)},!0)}_n(_e,ce)};os(N,_e=>{M.type==="image"?_e($):_e(Y,!1)})}var se=ul(N,2);{var s=_e=>{var ce=GS(),oe=On(ce);{var Ie=Ve=>{var We=US(),st=On(We);as(()=>vm(st,M.caption)),_n(Ve,We)};os(oe,Ve=>{M.caption&&Ve(Ie)})}var Me=ul(oe,2);{var De=Ve=>{var We=jS(),st=On(We);as(()=>vm(st,M.credit)),_n(Ve,We)};os(Me,Ve=>{M.credit&&Ve(De)})}_n(_e,ce)};os(se,_e=>{(M.caption||M.credit)&&_e(s)})}_n(P,k)}function Oy(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}let Cc=Oy();function Wb(P){Cc=P}const cf={exec:()=>null};function tn(P,M=""){let k=typeof P=="string"?P:P.source;const N={replace:($,Y)=>{let se=typeof Y=="string"?Y:Y.source;return se=se.replace(Fr.caret,"$1"),k=k.replace($,se),N},getRegex:()=>new RegExp(k,M)};return N}const Fr={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] /,listReplaceTask:/^\[[ xX]\] +/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/ig,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:P=>new RegExp(`^( {0,3}${P})((?:[	 ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:P=>new RegExp(`^ {0,${Math.min(3,P-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ 	][^\\n]*)?(?:\\n|$))`),hrRegex:P=>new RegExp(`^ {0,${Math.min(3,P-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:P=>new RegExp(`^ {0,${Math.min(3,P-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:P=>new RegExp(`^ {0,${Math.min(3,P-1)}}#`),htmlBeginRegex:P=>new RegExp(`^ {0,${Math.min(3,P-1)}}<(?:[a-z].*>|!--)`,"i")},$S=/^(?:[ \t]*(?:\n|$))+/,ZS=/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,HS=/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,yf=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,WS=/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,Fy=/(?:[*+-]|\d{1,9}[.)])/,Xb=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,Yb=tn(Xb).replace(/bull/g,Fy).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),XS=tn(Xb).replace(/bull/g,Fy).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),By=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,YS=/^[^\n]+/,Ny=/(?!\s*\])(?:\\.|[^\[\]\\])+/,KS=tn(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",Ny).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),JS=tn(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,Fy).getRegex(),Um="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",Vy=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,QS=tn("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$))","i").replace("comment",Vy).replace("tag",Um).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),Kb=tn(By).replace("hr",yf).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Um).getRegex(),eE=tn(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",Kb).getRegex(),Uy={blockquote:eE,code:ZS,def:KS,fences:HS,heading:WS,hr:yf,html:QS,lheading:Yb,list:JS,newline:$S,paragraph:Kb,table:cf,text:YS},Zv=tn("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",yf).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}	)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Um).getRegex(),tE={...Uy,lheading:XS,table:Zv,paragraph:tn(By).replace("hr",yf).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",Zv).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Um).getRegex()},iE={...Uy,html:tn(`^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:"[^"]*"|'[^']*'|\\s[^'"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))`).replace("comment",Vy).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:cf,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:tn(By).replace("hr",yf).replace("heading",` *#{1,6} *[^
]`).replace("lheading",Yb).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},nE=/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,rE=/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,Jb=/^( {2,}|\\)\n(?!\s*$)/,sE=/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,jm=/[\p{P}\p{S}]/u,jy=/[\s\p{P}\p{S}]/u,Qb=/[^\s\p{P}\p{S}]/u,oE=tn(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,jy).getRegex(),ew=/(?!~)[\p{P}\p{S}]/u,aE=/(?!~)[\s\p{P}\p{S}]/u,lE=/(?:[^\s\p{P}\p{S}]|~)/u,cE=/\[[^[\]]*?\]\((?:\\.|[^\\\(\)]|\((?:\\.|[^\\\(\)])*\))*\)|`[^`]*?`|<[^<>]*?>/g,tw=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,uE=tn(tw,"u").replace(/punct/g,jm).getRegex(),hE=tn(tw,"u").replace(/punct/g,ew).getRegex(),iw="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",dE=tn(iw,"gu").replace(/notPunctSpace/g,Qb).replace(/punctSpace/g,jy).replace(/punct/g,jm).getRegex(),fE=tn(iw,"gu").replace(/notPunctSpace/g,lE).replace(/punctSpace/g,aE).replace(/punct/g,ew).getRegex(),pE=tn("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,Qb).replace(/punctSpace/g,jy).replace(/punct/g,jm).getRegex(),mE=tn(/\\(punct)/,"gu").replace(/punct/g,jm).getRegex(),_E=tn(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),gE=tn(Vy).replace("(?:-->|$)","-->").getRegex(),yE=tn("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",gE).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),Pm=/(?:\[(?:\\.|[^\[\]\\])*\]|\\.|`[^`]*`|[^\[\]\\`])*?/,xE=tn(/^!?\[(label)\]\(\s*(href)(?:\s+(title))?\s*\)/).replace("label",Pm).replace("href",/<(?:\\.|[^\n<>\\])+>|[^\s\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),nw=tn(/^!?\[(label)\]\[(ref)\]/).replace("label",Pm).replace("ref",Ny).getRegex(),rw=tn(/^!?\[(ref)\](?:\[\])?/).replace("ref",Ny).getRegex(),vE=tn("reflink|nolink(?!\\()","g").replace("reflink",nw).replace("nolink",rw).getRegex(),Gy={_backpedal:cf,anyPunctuation:mE,autolink:_E,blockSkip:cE,br:Jb,code:rE,del:cf,emStrongLDelim:uE,emStrongRDelimAst:dE,emStrongRDelimUnd:pE,escape:nE,link:xE,nolink:rw,punctuation:oE,reflink:nw,reflinkSearch:vE,tag:yE,text:sE,url:cf},bE={...Gy,link:tn(/^!?\[(label)\]\((.*?)\)/).replace("label",Pm).getRegex(),reflink:tn(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",Pm).getRegex()},yy={...Gy,emStrongRDelimAst:fE,emStrongLDelim:hE,url:tn(/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/,"i").replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\.|[^\\])*?(?:\\.|[^\s~\\]))\1(?=[^~]|$)/,text:/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|https?:\/\/|ftp:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/},wE={...yy,br:tn(Jb).replace("{2,}","*").getRegex(),text:tn(yy.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},om={normal:Uy,gfm:tE,pedantic:iE},tf={normal:Gy,gfm:yy,breaks:wE,pedantic:bE},TE={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Hv=P=>TE[P];function Io(P,M){if(M){if(Fr.escapeTest.test(P))return P.replace(Fr.escapeReplace,Hv)}else if(Fr.escapeTestNoEncode.test(P))return P.replace(Fr.escapeReplaceNoEncode,Hv);return P}function Wv(P){try{P=encodeURI(P).replace(Fr.percentDecode,"%")}catch{return null}return P}function Xv(P,M){var Y;const k=P.replace(Fr.findPipe,(se,s,_e)=>{let ce=!1,oe=s;for(;--oe>=0&&_e[oe]==="\\";)ce=!ce;return ce?"|":" |"}),N=k.split(Fr.splitPipe);let $=0;if(N[0].trim()||N.shift(),N.length>0&&!((Y=N.at(-1))!=null&&Y.trim())&&N.pop(),M)if(N.length>M)N.splice(M);else for(;N.length<M;)N.push("");for(;$<N.length;$++)N[$]=N[$].trim().replace(Fr.slashPipe,"|");return N}function nf(P,M,k){const N=P.length;if(N===0)return"";let $=0;for(;$<N&&P.charAt(N-$-1)===M;)$++;return P.slice(0,N-$)}function SE(P,M){if(P.indexOf(M[1])===-1)return-1;let k=0;for(let N=0;N<P.length;N++)if(P[N]==="\\")N++;else if(P[N]===M[0])k++;else if(P[N]===M[1]&&(k--,k<0))return N;return-1}function Yv(P,M,k,N,$){const Y=M.href,se=M.title||null,s=P[1].replace($.other.outputLinkReplace,"$1");if(P[0].charAt(0)!=="!"){N.state.inLink=!0;const _e={type:"link",raw:k,href:Y,title:se,text:s,tokens:N.inlineTokens(s)};return N.state.inLink=!1,_e}return{type:"image",raw:k,href:Y,title:se,text:s}}function EE(P,M,k){const N=P.match(k.other.indentCodeCompensation);if(N===null)return M;const $=N[1];return M.split(`
`).map(Y=>{const se=Y.match(k.other.beginningSpace);if(se===null)return Y;const[s]=se;return s.length>=$.length?Y.slice($.length):Y}).join(`
`)}class zm{constructor(M){dn(this,"options");dn(this,"rules");dn(this,"lexer");this.options=M||Cc}space(M){const k=this.rules.block.newline.exec(M);if(k&&k[0].length>0)return{type:"space",raw:k[0]}}code(M){const k=this.rules.block.code.exec(M);if(k){const N=k[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:k[0],codeBlockStyle:"indented",text:this.options.pedantic?N:nf(N,`
`)}}}fences(M){const k=this.rules.block.fences.exec(M);if(k){const N=k[0],$=EE(N,k[3]||"",this.rules);return{type:"code",raw:N,lang:k[2]?k[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):k[2],text:$}}}heading(M){const k=this.rules.block.heading.exec(M);if(k){let N=k[2].trim();if(this.rules.other.endingHash.test(N)){const $=nf(N,"#");(this.options.pedantic||!$||this.rules.other.endingSpaceChar.test($))&&(N=$.trim())}return{type:"heading",raw:k[0],depth:k[1].length,text:N,tokens:this.lexer.inline(N)}}}hr(M){const k=this.rules.block.hr.exec(M);if(k)return{type:"hr",raw:nf(k[0],`
`)}}blockquote(M){const k=this.rules.block.blockquote.exec(M);if(k){let N=nf(k[0],`
`).split(`
`),$="",Y="";const se=[];for(;N.length>0;){let s=!1;const _e=[];let ce;for(ce=0;ce<N.length;ce++)if(this.rules.other.blockquoteStart.test(N[ce]))_e.push(N[ce]),s=!0;else if(!s)_e.push(N[ce]);else break;N=N.slice(ce);const oe=_e.join(`
`),Ie=oe.replace(this.rules.other.blockquoteSetextReplace,`
    $1`).replace(this.rules.other.blockquoteSetextReplace2,"");$=$?`${$}
${oe}`:oe,Y=Y?`${Y}
${Ie}`:Ie;const Me=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(Ie,se,!0),this.lexer.state.top=Me,N.length===0)break;const De=se.at(-1);if((De==null?void 0:De.type)==="code")break;if((De==null?void 0:De.type)==="blockquote"){const Ve=De,We=Ve.raw+`
`+N.join(`
`),st=this.blockquote(We);se[se.length-1]=st,$=$.substring(0,$.length-Ve.raw.length)+st.raw,Y=Y.substring(0,Y.length-Ve.text.length)+st.text;break}else if((De==null?void 0:De.type)==="list"){const Ve=De,We=Ve.raw+`
`+N.join(`
`),st=this.list(We);se[se.length-1]=st,$=$.substring(0,$.length-De.raw.length)+st.raw,Y=Y.substring(0,Y.length-Ve.raw.length)+st.raw,N=We.substring(se.at(-1).raw.length).split(`
`);continue}}return{type:"blockquote",raw:$,tokens:se,text:Y}}}list(M){let k=this.rules.block.list.exec(M);if(k){let N=k[1].trim();const $=N.length>1,Y={type:"list",raw:"",ordered:$,start:$?+N.slice(0,-1):"",loose:!1,items:[]};N=$?`\\d{1,9}\\${N.slice(-1)}`:`\\${N}`,this.options.pedantic&&(N=$?N:"[*+-]");const se=this.rules.other.listItemRegex(N);let s=!1;for(;M;){let ce=!1,oe="",Ie="";if(!(k=se.exec(M))||this.rules.block.hr.test(M))break;oe=k[0],M=M.substring(oe.length);let Me=k[2].split(`
`,1)[0].replace(this.rules.other.listReplaceTabs,gt=>" ".repeat(3*gt.length)),De=M.split(`
`,1)[0],Ve=!Me.trim(),We=0;if(this.options.pedantic?(We=2,Ie=Me.trimStart()):Ve?We=k[1].length+1:(We=k[2].search(this.rules.other.nonSpaceChar),We=We>4?1:We,Ie=Me.slice(We),We+=k[1].length),Ve&&this.rules.other.blankLine.test(De)&&(oe+=De+`
`,M=M.substring(De.length+1),ce=!0),!ce){const gt=this.rules.other.nextBulletRegex(We),At=this.rules.other.hrRegex(We),ot=this.rules.other.fencesBeginRegex(We),zt=this.rules.other.headingBeginRegex(We),Rt=this.rules.other.htmlBeginRegex(We);for(;M;){const vt=M.split(`
`,1)[0];let Nt;if(De=vt,this.options.pedantic?(De=De.replace(this.rules.other.listReplaceNesting,"  "),Nt=De):Nt=De.replace(this.rules.other.tabCharGlobal,"    "),ot.test(De)||zt.test(De)||Rt.test(De)||gt.test(De)||At.test(De))break;if(Nt.search(this.rules.other.nonSpaceChar)>=We||!De.trim())Ie+=`
`+Nt.slice(We);else{if(Ve||Me.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4||ot.test(Me)||zt.test(Me)||At.test(Me))break;Ie+=`
`+De}!Ve&&!De.trim()&&(Ve=!0),oe+=vt+`
`,M=M.substring(vt.length+1),Me=Nt.slice(We)}}Y.loose||(s?Y.loose=!0:this.rules.other.doubleBlankLine.test(oe)&&(s=!0));let st=null,ct;this.options.gfm&&(st=this.rules.other.listIsTask.exec(Ie),st&&(ct=st[0]!=="[ ] ",Ie=Ie.replace(this.rules.other.listReplaceTask,""))),Y.items.push({type:"list_item",raw:oe,task:!!st,checked:ct,loose:!1,text:Ie,tokens:[]}),Y.raw+=oe}const _e=Y.items.at(-1);if(_e)_e.raw=_e.raw.trimEnd(),_e.text=_e.text.trimEnd();else return;Y.raw=Y.raw.trimEnd();for(let ce=0;ce<Y.items.length;ce++)if(this.lexer.state.top=!1,Y.items[ce].tokens=this.lexer.blockTokens(Y.items[ce].text,[]),!Y.loose){const oe=Y.items[ce].tokens.filter(Me=>Me.type==="space"),Ie=oe.length>0&&oe.some(Me=>this.rules.other.anyLine.test(Me.raw));Y.loose=Ie}if(Y.loose)for(let ce=0;ce<Y.items.length;ce++)Y.items[ce].loose=!0;return Y}}html(M){const k=this.rules.block.html.exec(M);if(k)return{type:"html",block:!0,raw:k[0],pre:k[1]==="pre"||k[1]==="script"||k[1]==="style",text:k[0]}}def(M){const k=this.rules.block.def.exec(M);if(k){const N=k[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),$=k[2]?k[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",Y=k[3]?k[3].substring(1,k[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):k[3];return{type:"def",tag:N,raw:k[0],href:$,title:Y}}}table(M){var s;const k=this.rules.block.table.exec(M);if(!k||!this.rules.other.tableDelimiter.test(k[2]))return;const N=Xv(k[1]),$=k[2].replace(this.rules.other.tableAlignChars,"").split("|"),Y=(s=k[3])!=null&&s.trim()?k[3].replace(this.rules.other.tableRowBlankLine,"").split(`
`):[],se={type:"table",raw:k[0],header:[],align:[],rows:[]};if(N.length===$.length){for(const _e of $)this.rules.other.tableAlignRight.test(_e)?se.align.push("right"):this.rules.other.tableAlignCenter.test(_e)?se.align.push("center"):this.rules.other.tableAlignLeft.test(_e)?se.align.push("left"):se.align.push(null);for(let _e=0;_e<N.length;_e++)se.header.push({text:N[_e],tokens:this.lexer.inline(N[_e]),header:!0,align:se.align[_e]});for(const _e of Y)se.rows.push(Xv(_e,se.header.length).map((ce,oe)=>({text:ce,tokens:this.lexer.inline(ce),header:!1,align:se.align[oe]})));return se}}lheading(M){const k=this.rules.block.lheading.exec(M);if(k)return{type:"heading",raw:k[0],depth:k[2].charAt(0)==="="?1:2,text:k[1],tokens:this.lexer.inline(k[1])}}paragraph(M){const k=this.rules.block.paragraph.exec(M);if(k){const N=k[1].charAt(k[1].length-1)===`
`?k[1].slice(0,-1):k[1];return{type:"paragraph",raw:k[0],text:N,tokens:this.lexer.inline(N)}}}text(M){const k=this.rules.block.text.exec(M);if(k)return{type:"text",raw:k[0],text:k[0],tokens:this.lexer.inline(k[0])}}escape(M){const k=this.rules.inline.escape.exec(M);if(k)return{type:"escape",raw:k[0],text:k[1]}}tag(M){const k=this.rules.inline.tag.exec(M);if(k)return!this.lexer.state.inLink&&this.rules.other.startATag.test(k[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(k[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(k[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(k[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:k[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:k[0]}}link(M){const k=this.rules.inline.link.exec(M);if(k){const N=k[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(N)){if(!this.rules.other.endAngleBracket.test(N))return;const se=nf(N.slice(0,-1),"\\");if((N.length-se.length)%2===0)return}else{const se=SE(k[2],"()");if(se>-1){const _e=(k[0].indexOf("!")===0?5:4)+k[1].length+se;k[2]=k[2].substring(0,se),k[0]=k[0].substring(0,_e).trim(),k[3]=""}}let $=k[2],Y="";if(this.options.pedantic){const se=this.rules.other.pedanticHrefTitle.exec($);se&&($=se[1],Y=se[3])}else Y=k[3]?k[3].slice(1,-1):"";return $=$.trim(),this.rules.other.startAngleBracket.test($)&&(this.options.pedantic&&!this.rules.other.endAngleBracket.test(N)?$=$.slice(1):$=$.slice(1,-1)),Yv(k,{href:$&&$.replace(this.rules.inline.anyPunctuation,"$1"),title:Y&&Y.replace(this.rules.inline.anyPunctuation,"$1")},k[0],this.lexer,this.rules)}}reflink(M,k){let N;if((N=this.rules.inline.reflink.exec(M))||(N=this.rules.inline.nolink.exec(M))){const $=(N[2]||N[1]).replace(this.rules.other.multipleSpaceGlobal," "),Y=k[$.toLowerCase()];if(!Y){const se=N[0].charAt(0);return{type:"text",raw:se,text:se}}return Yv(N,Y,N[0],this.lexer,this.rules)}}emStrong(M,k,N=""){let $=this.rules.inline.emStrongLDelim.exec(M);if(!$||$[3]&&N.match(this.rules.other.unicodeAlphaNumeric))return;if(!($[1]||$[2]||"")||!N||this.rules.inline.punctuation.exec(N)){const se=[...$[0]].length-1;let s,_e,ce=se,oe=0;const Ie=$[0][0]==="*"?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(Ie.lastIndex=0,k=k.slice(-1*M.length+se);($=Ie.exec(k))!=null;){if(s=$[1]||$[2]||$[3]||$[4]||$[5]||$[6],!s)continue;if(_e=[...s].length,$[3]||$[4]){ce+=_e;continue}else if(($[5]||$[6])&&se%3&&!((se+_e)%3)){oe+=_e;continue}if(ce-=_e,ce>0)continue;_e=Math.min(_e,_e+ce+oe);const Me=[...$[0]][0].length,De=M.slice(0,se+$.index+Me+_e);if(Math.min(se,_e)%2){const We=De.slice(1,-1);return{type:"em",raw:De,text:We,tokens:this.lexer.inlineTokens(We)}}const Ve=De.slice(2,-2);return{type:"strong",raw:De,text:Ve,tokens:this.lexer.inlineTokens(Ve)}}}}codespan(M){const k=this.rules.inline.code.exec(M);if(k){let N=k[2].replace(this.rules.other.newLineCharGlobal," ");const $=this.rules.other.nonSpaceChar.test(N),Y=this.rules.other.startingSpaceChar.test(N)&&this.rules.other.endingSpaceChar.test(N);return $&&Y&&(N=N.substring(1,N.length-1)),{type:"codespan",raw:k[0],text:N}}}br(M){const k=this.rules.inline.br.exec(M);if(k)return{type:"br",raw:k[0]}}del(M){const k=this.rules.inline.del.exec(M);if(k)return{type:"del",raw:k[0],text:k[2],tokens:this.lexer.inlineTokens(k[2])}}autolink(M){const k=this.rules.inline.autolink.exec(M);if(k){let N,$;return k[2]==="@"?(N=k[1],$="mailto:"+N):(N=k[1],$=N),{type:"link",raw:k[0],text:N,href:$,tokens:[{type:"text",raw:N,text:N}]}}}url(M){var N;let k;if(k=this.rules.inline.url.exec(M)){let $,Y;if(k[2]==="@")$=k[0],Y="mailto:"+$;else{let se;do se=k[0],k[0]=((N=this.rules.inline._backpedal.exec(k[0]))==null?void 0:N[0])??"";while(se!==k[0]);$=k[0],k[1]==="www."?Y="http://"+k[0]:Y=k[0]}return{type:"link",raw:k[0],text:$,href:Y,tokens:[{type:"text",raw:$,text:$}]}}}inlineText(M){const k=this.rules.inline.text.exec(M);if(k){const N=this.lexer.state.inRawBlock;return{type:"text",raw:k[0],text:k[0],escaped:N}}}}class Ds{constructor(M){dn(this,"tokens");dn(this,"options");dn(this,"state");dn(this,"tokenizer");dn(this,"inlineQueue");this.tokens=[],this.tokens.links=Object.create(null),this.options=M||Cc,this.options.tokenizer=this.options.tokenizer||new zm,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};const k={other:Fr,block:om.normal,inline:tf.normal};this.options.pedantic?(k.block=om.pedantic,k.inline=tf.pedantic):this.options.gfm&&(k.block=om.gfm,this.options.breaks?k.inline=tf.breaks:k.inline=tf.gfm),this.tokenizer.rules=k}static get rules(){return{block:om,inline:tf}}static lex(M,k){return new Ds(k).lex(M)}static lexInline(M,k){return new Ds(k).inlineTokens(M)}lex(M){M=M.replace(Fr.carriageReturn,`
`),this.blockTokens(M,this.tokens);for(let k=0;k<this.inlineQueue.length;k++){const N=this.inlineQueue[k];this.inlineTokens(N.src,N.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(M,k=[],N=!1){var $,Y,se;for(this.options.pedantic&&(M=M.replace(Fr.tabCharGlobal,"    ").replace(Fr.spaceLine,""));M;){let s;if((Y=($=this.options.extensions)==null?void 0:$.block)!=null&&Y.some(ce=>(s=ce.call({lexer:this},M,k))?(M=M.substring(s.raw.length),k.push(s),!0):!1))continue;if(s=this.tokenizer.space(M)){M=M.substring(s.raw.length);const ce=k.at(-1);s.raw.length===1&&ce!==void 0?ce.raw+=`
`:k.push(s);continue}if(s=this.tokenizer.code(M)){M=M.substring(s.raw.length);const ce=k.at(-1);(ce==null?void 0:ce.type)==="paragraph"||(ce==null?void 0:ce.type)==="text"?(ce.raw+=`
`+s.raw,ce.text+=`
`+s.text,this.inlineQueue.at(-1).src=ce.text):k.push(s);continue}if(s=this.tokenizer.fences(M)){M=M.substring(s.raw.length),k.push(s);continue}if(s=this.tokenizer.heading(M)){M=M.substring(s.raw.length),k.push(s);continue}if(s=this.tokenizer.hr(M)){M=M.substring(s.raw.length),k.push(s);continue}if(s=this.tokenizer.blockquote(M)){M=M.substring(s.raw.length),k.push(s);continue}if(s=this.tokenizer.list(M)){M=M.substring(s.raw.length),k.push(s);continue}if(s=this.tokenizer.html(M)){M=M.substring(s.raw.length),k.push(s);continue}if(s=this.tokenizer.def(M)){M=M.substring(s.raw.length);const ce=k.at(-1);(ce==null?void 0:ce.type)==="paragraph"||(ce==null?void 0:ce.type)==="text"?(ce.raw+=`
`+s.raw,ce.text+=`
`+s.raw,this.inlineQueue.at(-1).src=ce.text):this.tokens.links[s.tag]||(this.tokens.links[s.tag]={href:s.href,title:s.title});continue}if(s=this.tokenizer.table(M)){M=M.substring(s.raw.length),k.push(s);continue}if(s=this.tokenizer.lheading(M)){M=M.substring(s.raw.length),k.push(s);continue}let _e=M;if((se=this.options.extensions)!=null&&se.startBlock){let ce=1/0;const oe=M.slice(1);let Ie;this.options.extensions.startBlock.forEach(Me=>{Ie=Me.call({lexer:this},oe),typeof Ie=="number"&&Ie>=0&&(ce=Math.min(ce,Ie))}),ce<1/0&&ce>=0&&(_e=M.substring(0,ce+1))}if(this.state.top&&(s=this.tokenizer.paragraph(_e))){const ce=k.at(-1);N&&(ce==null?void 0:ce.type)==="paragraph"?(ce.raw+=`
`+s.raw,ce.text+=`
`+s.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=ce.text):k.push(s),N=_e.length!==M.length,M=M.substring(s.raw.length);continue}if(s=this.tokenizer.text(M)){M=M.substring(s.raw.length);const ce=k.at(-1);(ce==null?void 0:ce.type)==="text"?(ce.raw+=`
`+s.raw,ce.text+=`
`+s.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=ce.text):k.push(s);continue}if(M){const ce="Infinite loop on byte: "+M.charCodeAt(0);if(this.options.silent){console.error(ce);break}else throw new Error(ce)}}return this.state.top=!0,k}inline(M,k=[]){return this.inlineQueue.push({src:M,tokens:k}),k}inlineTokens(M,k=[]){var s,_e,ce;let N=M,$=null;if(this.tokens.links){const oe=Object.keys(this.tokens.links);if(oe.length>0)for(;($=this.tokenizer.rules.inline.reflinkSearch.exec(N))!=null;)oe.includes($[0].slice($[0].lastIndexOf("[")+1,-1))&&(N=N.slice(0,$.index)+"["+"a".repeat($[0].length-2)+"]"+N.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;($=this.tokenizer.rules.inline.blockSkip.exec(N))!=null;)N=N.slice(0,$.index)+"["+"a".repeat($[0].length-2)+"]"+N.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);for(;($=this.tokenizer.rules.inline.anyPunctuation.exec(N))!=null;)N=N.slice(0,$.index)+"++"+N.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);let Y=!1,se="";for(;M;){Y||(se=""),Y=!1;let oe;if((_e=(s=this.options.extensions)==null?void 0:s.inline)!=null&&_e.some(Me=>(oe=Me.call({lexer:this},M,k))?(M=M.substring(oe.raw.length),k.push(oe),!0):!1))continue;if(oe=this.tokenizer.escape(M)){M=M.substring(oe.raw.length),k.push(oe);continue}if(oe=this.tokenizer.tag(M)){M=M.substring(oe.raw.length),k.push(oe);continue}if(oe=this.tokenizer.link(M)){M=M.substring(oe.raw.length),k.push(oe);continue}if(oe=this.tokenizer.reflink(M,this.tokens.links)){M=M.substring(oe.raw.length);const Me=k.at(-1);oe.type==="text"&&(Me==null?void 0:Me.type)==="text"?(Me.raw+=oe.raw,Me.text+=oe.text):k.push(oe);continue}if(oe=this.tokenizer.emStrong(M,N,se)){M=M.substring(oe.raw.length),k.push(oe);continue}if(oe=this.tokenizer.codespan(M)){M=M.substring(oe.raw.length),k.push(oe);continue}if(oe=this.tokenizer.br(M)){M=M.substring(oe.raw.length),k.push(oe);continue}if(oe=this.tokenizer.del(M)){M=M.substring(oe.raw.length),k.push(oe);continue}if(oe=this.tokenizer.autolink(M)){M=M.substring(oe.raw.length),k.push(oe);continue}if(!this.state.inLink&&(oe=this.tokenizer.url(M))){M=M.substring(oe.raw.length),k.push(oe);continue}let Ie=M;if((ce=this.options.extensions)!=null&&ce.startInline){let Me=1/0;const De=M.slice(1);let Ve;this.options.extensions.startInline.forEach(We=>{Ve=We.call({lexer:this},De),typeof Ve=="number"&&Ve>=0&&(Me=Math.min(Me,Ve))}),Me<1/0&&Me>=0&&(Ie=M.substring(0,Me+1))}if(oe=this.tokenizer.inlineText(Ie)){M=M.substring(oe.raw.length),oe.raw.slice(-1)!=="_"&&(se=oe.raw.slice(-1)),Y=!0;const Me=k.at(-1);(Me==null?void 0:Me.type)==="text"?(Me.raw+=oe.raw,Me.text+=oe.text):k.push(oe);continue}if(M){const Me="Infinite loop on byte: "+M.charCodeAt(0);if(this.options.silent){console.error(Me);break}else throw new Error(Me)}}return k}}class Rm{constructor(M){dn(this,"options");dn(this,"parser");this.options=M||Cc}space(M){return""}code({text:M,lang:k,escaped:N}){var se;const $=(se=(k||"").match(Fr.notSpaceStart))==null?void 0:se[0],Y=M.replace(Fr.endingNewline,"")+`
`;return $?'<pre><code class="language-'+Io($)+'">'+(N?Y:Io(Y,!0))+`</code></pre>
`:"<pre><code>"+(N?Y:Io(Y,!0))+`</code></pre>
`}blockquote({tokens:M}){return`<blockquote>
${this.parser.parse(M)}</blockquote>
`}html({text:M}){return M}heading({tokens:M,depth:k}){return`<h${k}>${this.parser.parseInline(M)}</h${k}>
`}hr(M){return`<hr>
`}list(M){const k=M.ordered,N=M.start;let $="";for(let s=0;s<M.items.length;s++){const _e=M.items[s];$+=this.listitem(_e)}const Y=k?"ol":"ul",se=k&&N!==1?' start="'+N+'"':"";return"<"+Y+se+`>
`+$+"</"+Y+`>
`}listitem(M){var N;let k="";if(M.task){const $=this.checkbox({checked:!!M.checked});M.loose?((N=M.tokens[0])==null?void 0:N.type)==="paragraph"?(M.tokens[0].text=$+" "+M.tokens[0].text,M.tokens[0].tokens&&M.tokens[0].tokens.length>0&&M.tokens[0].tokens[0].type==="text"&&(M.tokens[0].tokens[0].text=$+" "+Io(M.tokens[0].tokens[0].text),M.tokens[0].tokens[0].escaped=!0)):M.tokens.unshift({type:"text",raw:$+" ",text:$+" ",escaped:!0}):k+=$+" "}return k+=this.parser.parse(M.tokens,!!M.loose),`<li>${k}</li>
`}checkbox({checked:M}){return"<input "+(M?'checked="" ':"")+'disabled="" type="checkbox">'}paragraph({tokens:M}){return`<p>${this.parser.parseInline(M)}</p>
`}table(M){let k="",N="";for(let Y=0;Y<M.header.length;Y++)N+=this.tablecell(M.header[Y]);k+=this.tablerow({text:N});let $="";for(let Y=0;Y<M.rows.length;Y++){const se=M.rows[Y];N="";for(let s=0;s<se.length;s++)N+=this.tablecell(se[s]);$+=this.tablerow({text:N})}return $&&($=`<tbody>${$}</tbody>`),`<table>
<thead>
`+k+`</thead>
`+$+`</table>
`}tablerow({text:M}){return`<tr>
${M}</tr>
`}tablecell(M){const k=this.parser.parseInline(M.tokens),N=M.header?"th":"td";return(M.align?`<${N} align="${M.align}">`:`<${N}>`)+k+`</${N}>
`}strong({tokens:M}){return`<strong>${this.parser.parseInline(M)}</strong>`}em({tokens:M}){return`<em>${this.parser.parseInline(M)}</em>`}codespan({text:M}){return`<code>${Io(M,!0)}</code>`}br(M){return"<br>"}del({tokens:M}){return`<del>${this.parser.parseInline(M)}</del>`}link({href:M,title:k,tokens:N}){const $=this.parser.parseInline(N),Y=Wv(M);if(Y===null)return $;M=Y;let se='<a href="'+M+'"';return k&&(se+=' title="'+Io(k)+'"'),se+=">"+$+"</a>",se}image({href:M,title:k,text:N}){const $=Wv(M);if($===null)return Io(N);M=$;let Y=`<img src="${M}" alt="${N}"`;return k&&(Y+=` title="${Io(k)}"`),Y+=">",Y}text(M){return"tokens"in M&&M.tokens?this.parser.parseInline(M.tokens):"escaped"in M&&M.escaped?M.text:Io(M.text)}}class qy{strong({text:M}){return M}em({text:M}){return M}codespan({text:M}){return M}del({text:M}){return M}html({text:M}){return M}text({text:M}){return M}link({text:M}){return""+M}image({text:M}){return""+M}br(){return""}}class Ls{constructor(M){dn(this,"options");dn(this,"renderer");dn(this,"textRenderer");this.options=M||Cc,this.options.renderer=this.options.renderer||new Rm,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new qy}static parse(M,k){return new Ls(k).parse(M)}static parseInline(M,k){return new Ls(k).parseInline(M)}parse(M,k=!0){var $,Y;let N="";for(let se=0;se<M.length;se++){const s=M[se];if((Y=($=this.options.extensions)==null?void 0:$.renderers)!=null&&Y[s.type]){const ce=s,oe=this.options.extensions.renderers[ce.type].call({parser:this},ce);if(oe!==!1||!["space","hr","heading","code","table","blockquote","list","html","paragraph","text"].includes(ce.type)){N+=oe||"";continue}}const _e=s;switch(_e.type){case"space":{N+=this.renderer.space(_e);continue}case"hr":{N+=this.renderer.hr(_e);continue}case"heading":{N+=this.renderer.heading(_e);continue}case"code":{N+=this.renderer.code(_e);continue}case"table":{N+=this.renderer.table(_e);continue}case"blockquote":{N+=this.renderer.blockquote(_e);continue}case"list":{N+=this.renderer.list(_e);continue}case"html":{N+=this.renderer.html(_e);continue}case"paragraph":{N+=this.renderer.paragraph(_e);continue}case"text":{let ce=_e,oe=this.renderer.text(ce);for(;se+1<M.length&&M[se+1].type==="text";)ce=M[++se],oe+=`
`+this.renderer.text(ce);k?N+=this.renderer.paragraph({type:"paragraph",raw:oe,text:oe,tokens:[{type:"text",raw:oe,text:oe,escaped:!0}]}):N+=oe;continue}default:{const ce='Token with "'+_e.type+'" type was not found.';if(this.options.silent)return console.error(ce),"";throw new Error(ce)}}}return N}parseInline(M,k=this.renderer){var $,Y;let N="";for(let se=0;se<M.length;se++){const s=M[se];if((Y=($=this.options.extensions)==null?void 0:$.renderers)!=null&&Y[s.type]){const ce=this.options.extensions.renderers[s.type].call({parser:this},s);if(ce!==!1||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(s.type)){N+=ce||"";continue}}const _e=s;switch(_e.type){case"escape":{N+=k.text(_e);break}case"html":{N+=k.html(_e);break}case"link":{N+=k.link(_e);break}case"image":{N+=k.image(_e);break}case"strong":{N+=k.strong(_e);break}case"em":{N+=k.em(_e);break}case"codespan":{N+=k.codespan(_e);break}case"br":{N+=k.br(_e);break}case"del":{N+=k.del(_e);break}case"text":{N+=k.text(_e);break}default:{const ce='Token with "'+_e.type+'" type was not found.';if(this.options.silent)return console.error(ce),"";throw new Error(ce)}}}return N}}class uf{constructor(M){dn(this,"options");dn(this,"block");this.options=M||Cc}preprocess(M){return M}postprocess(M){return M}processAllTokens(M){return M}provideLexer(){return this.block?Ds.lex:Ds.lexInline}provideParser(){return this.block?Ls.parse:Ls.parseInline}}dn(uf,"passThroughHooks",new Set(["preprocess","postprocess","processAllTokens"]));class ME{constructor(...M){dn(this,"defaults",Oy());dn(this,"options",this.setOptions);dn(this,"parse",this.parseMarkdown(!0));dn(this,"parseInline",this.parseMarkdown(!1));dn(this,"Parser",Ls);dn(this,"Renderer",Rm);dn(this,"TextRenderer",qy);dn(this,"Lexer",Ds);dn(this,"Tokenizer",zm);dn(this,"Hooks",uf);this.use(...M)}walkTokens(M,k){var $,Y;let N=[];for(const se of M)switch(N=N.concat(k.call(this,se)),se.type){case"table":{const s=se;for(const _e of s.header)N=N.concat(this.walkTokens(_e.tokens,k));for(const _e of s.rows)for(const ce of _e)N=N.concat(this.walkTokens(ce.tokens,k));break}case"list":{const s=se;N=N.concat(this.walkTokens(s.items,k));break}default:{const s=se;(Y=($=this.defaults.extensions)==null?void 0:$.childTokens)!=null&&Y[s.type]?this.defaults.extensions.childTokens[s.type].forEach(_e=>{const ce=s[_e].flat(1/0);N=N.concat(this.walkTokens(ce,k))}):s.tokens&&(N=N.concat(this.walkTokens(s.tokens,k)))}}return N}use(...M){const k=this.defaults.extensions||{renderers:{},childTokens:{}};return M.forEach(N=>{const $={...N};if($.async=this.defaults.async||$.async||!1,N.extensions&&(N.extensions.forEach(Y=>{if(!Y.name)throw new Error("extension name required");if("renderer"in Y){const se=k.renderers[Y.name];se?k.renderers[Y.name]=function(...s){let _e=Y.renderer.apply(this,s);return _e===!1&&(_e=se.apply(this,s)),_e}:k.renderers[Y.name]=Y.renderer}if("tokenizer"in Y){if(!Y.level||Y.level!=="block"&&Y.level!=="inline")throw new Error("extension level must be 'block' or 'inline'");const se=k[Y.level];se?se.unshift(Y.tokenizer):k[Y.level]=[Y.tokenizer],Y.start&&(Y.level==="block"?k.startBlock?k.startBlock.push(Y.start):k.startBlock=[Y.start]:Y.level==="inline"&&(k.startInline?k.startInline.push(Y.start):k.startInline=[Y.start]))}"childTokens"in Y&&Y.childTokens&&(k.childTokens[Y.name]=Y.childTokens)}),$.extensions=k),N.renderer){const Y=this.defaults.renderer||new Rm(this.defaults);for(const se in N.renderer){if(!(se in Y))throw new Error(`renderer '${se}' does not exist`);if(["options","parser"].includes(se))continue;const s=se,_e=N.renderer[s],ce=Y[s];Y[s]=(...oe)=>{let Ie=_e.apply(Y,oe);return Ie===!1&&(Ie=ce.apply(Y,oe)),Ie||""}}$.renderer=Y}if(N.tokenizer){const Y=this.defaults.tokenizer||new zm(this.defaults);for(const se in N.tokenizer){if(!(se in Y))throw new Error(`tokenizer '${se}' does not exist`);if(["options","rules","lexer"].includes(se))continue;const s=se,_e=N.tokenizer[s],ce=Y[s];Y[s]=(...oe)=>{let Ie=_e.apply(Y,oe);return Ie===!1&&(Ie=ce.apply(Y,oe)),Ie}}$.tokenizer=Y}if(N.hooks){const Y=this.defaults.hooks||new uf;for(const se in N.hooks){if(!(se in Y))throw new Error(`hook '${se}' does not exist`);if(["options","block"].includes(se))continue;const s=se,_e=N.hooks[s],ce=Y[s];uf.passThroughHooks.has(se)?Y[s]=oe=>{if(this.defaults.async)return Promise.resolve(_e.call(Y,oe)).then(Me=>ce.call(Y,Me));const Ie=_e.call(Y,oe);return ce.call(Y,Ie)}:Y[s]=(...oe)=>{let Ie=_e.apply(Y,oe);return Ie===!1&&(Ie=ce.apply(Y,oe)),Ie}}$.hooks=Y}if(N.walkTokens){const Y=this.defaults.walkTokens,se=N.walkTokens;$.walkTokens=function(s){let _e=[];return _e.push(se.call(this,s)),Y&&(_e=_e.concat(Y.call(this,s))),_e}}this.defaults={...this.defaults,...$}}),this}setOptions(M){return this.defaults={...this.defaults,...M},this}lexer(M,k){return Ds.lex(M,k??this.defaults)}parser(M,k){return Ls.parse(M,k??this.defaults)}parseMarkdown(M){return(N,$)=>{const Y={...$},se={...this.defaults,...Y},s=this.onError(!!se.silent,!!se.async);if(this.defaults.async===!0&&Y.async===!1)return s(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(typeof N>"u"||N===null)return s(new Error("marked(): input parameter is undefined or null"));if(typeof N!="string")return s(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(N)+", string expected"));se.hooks&&(se.hooks.options=se,se.hooks.block=M);const _e=se.hooks?se.hooks.provideLexer():M?Ds.lex:Ds.lexInline,ce=se.hooks?se.hooks.provideParser():M?Ls.parse:Ls.parseInline;if(se.async)return Promise.resolve(se.hooks?se.hooks.preprocess(N):N).then(oe=>_e(oe,se)).then(oe=>se.hooks?se.hooks.processAllTokens(oe):oe).then(oe=>se.walkTokens?Promise.all(this.walkTokens(oe,se.walkTokens)).then(()=>oe):oe).then(oe=>ce(oe,se)).then(oe=>se.hooks?se.hooks.postprocess(oe):oe).catch(s);try{se.hooks&&(N=se.hooks.preprocess(N));let oe=_e(N,se);se.hooks&&(oe=se.hooks.processAllTokens(oe)),se.walkTokens&&this.walkTokens(oe,se.walkTokens);let Ie=ce(oe,se);return se.hooks&&(Ie=se.hooks.postprocess(Ie)),Ie}catch(oe){return s(oe)}}}onError(M,k){return N=>{if(N.message+=`
Please report this to https://github.com/markedjs/marked.`,M){const $="<p>An error occurred:</p><pre>"+Io(N.message+"",!0)+"</pre>";return k?Promise.resolve($):$}if(k)return Promise.reject(N);throw N}}}const Ic=new ME;function sn(P,M){return Ic.parse(P,M)}sn.options=sn.setOptions=function(P){return Ic.setOptions(P),sn.defaults=Ic.defaults,Wb(sn.defaults),sn};sn.getDefaults=Oy;sn.defaults=Cc;sn.use=function(...P){return Ic.use(...P),sn.defaults=Ic.defaults,Wb(sn.defaults),sn};sn.walkTokens=function(P,M){return Ic.walkTokens(P,M)};sn.parseInline=Ic.parseInline;sn.Parser=Ls;sn.parser=Ls.parse;sn.Renderer=Rm;sn.TextRenderer=qy;sn.Lexer=Ds;sn.lexer=Ds.lex;sn.Tokenizer=zm;sn.Hooks=uf;sn.parse=sn;sn.options;sn.setOptions;sn.use;sn.walkTokens;sn.parseInline;Ls.parse;Ds.lex;var IE=ur('<div class="flex-wrapper svelte-112ic7z"></div>'),AE=ur('<div class="component-wrapper svelte-112ic7z"><!></div>'),CE=ur('<section class="svelte-112ic7z"><div><!> <!></div></section>');function PE(P,M){hl(M,!0);let k=Or(()=>{var _e,ce;return((ce=(_e=M.slide)==null?void 0:_e.text)==null?void 0:ce.split(`
`))||[]});var N=CE(),$=On(N),Y=On($);pf(Y,17,()=>St(k),ff,(_e,ce)=>{var oe=vc(),Ie=yc(oe);u4(Ie,()=>sn(St(ce))),_n(_e,oe)});var se=ul(Y,2);{var s=_e=>{var ce=AE(),oe=On(ce);{var Ie=De=>{const Ve=Or(()=>M.slide.component);$v(De,{get src(){return St(Ve).src},get alt(){return St(Ve).alt},get caption(){return St(Ve).caption},get credit(){return St(Ve).credit},get type(){return St(Ve).type}})},Me=De=>{var Ve=vc(),We=yc(Ve);{var st=ct=>{var gt=IE();pf(gt,21,()=>M.slide.component.images,ff,(At,ot)=>{$v(At,{get src(){return St(ot).src},get alt(){return St(ot).alt},get caption(){return St(ot).caption},get credit(){return St(ot).credit},get type(){return St(ot).type}})}),_n(ct,gt)};os(We,ct=>{M.slide.component.type==="array"&&ct(st)},!0)}_n(De,Ve)};os(oe,De=>{M.slide.component.type==="image"||M.slide.component.type==="video"?De(Ie):De(Me,!1)})}_n(_e,ce)};os(se,_e=>{M.slide.component&&_e(s)})}Sb($,_e=>{var ce;return(ce=M.hydrateInlineLegends)==null?void 0:ce.call(M,_e)}),as(()=>Mb($,`slide-content ${M.slide.layout||"default"} svelte-112ic7z`)),_n(P,N),dl()}var zE=ur('<span class="legend-wrapper svelte-50sgmc"><svg class="mini-map svelte-50sgmc"><path fill-opacity="0.3" stroke-width="1"></path></svg> <span class="text svelte-50sgmc"> </span></span>');function RE(P,M){hl(M,!0);const k=Or(()=>gy.find(st=>st.source.id===M.id)),N=Or(()=>{var st;return((st=St(k))==null?void 0:st.source.data.features[0].geometry.coordinates[0])||[]}),$=Or(()=>{var st,ct;return((ct=(st=St(k))==null?void 0:st.layers.find(gt=>gt.type==="fill"))==null?void 0:ct.paint["fill-color"])||"#ccc"}),Y=Or(()=>{var st,ct;return((ct=(st=St(k))==null?void 0:st.layers.find(gt=>gt.type==="line"))==null?void 0:ct.paint["line-color"])||"#666"}),se=40,s=40,_e=Or(()=>St(N).reduce((st,[ct,gt])=>({minX:Math.min(st.minX,ct),maxX:Math.max(st.maxX,ct),minY:Math.min(st.minY,gt),maxY:Math.max(st.maxY,gt)}),{minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0})),ce=Or(()=>St(N).map(([st,ct])=>{const gt=se/(St(_e).maxX-St(_e).minX),At=s/(St(_e).maxY-St(_e).minY),ot=Math.min(gt,At)*.8,zt=(se-(St(_e).maxX-St(_e).minX)*ot)/2,Rt=(s-(St(_e).maxY-St(_e).minY)*ot)/2,vt=(st-St(_e).minX)*ot+zt,Nt=s-((ct-St(_e).minY)*ot+Rt);return`${vt},${Nt}`})),oe=Or(()=>`M${St(ce).join("L")}Z`);var Ie=zE(),Me=On(Ie);Xn(Me,"width",se),Xn(Me,"height",s),Xn(Me,"viewBox",`0 0 ${se} ${s}`);var De=On(Me),Ve=ul(Me,2),We=On(Ve);as(()=>{Xn(De,"d",St(oe)),Xn(De,"fill",St($)),Xn(De,"stroke",St(Y)),vm(We,M.text)}),_n(P,Ie),dl()}var DE=ur('<div id="scroller-background" slot="background" class="svelte-51av9n"><!></div>'),LE=ur('<div id="scroller-foreground" slot="foreground"></div>');function kE(P,M){hl(M,!0);let k=yr(M,"index",7),N=yr(M,"offset",7),$=yr(M,"progress",7),Y=Or(()=>{var s;return(s=M.content.slides[k()])==null?void 0:s.controller});function se(s){const _e=s.querySelectorAll("span[data-inline-legend-id]"),ce=[];return _e.forEach(oe=>{const Ie=oe.getAttribute("data-inline-legend-id"),Me=oe.textContent;oe.textContent="";const De=Tb(RE,{target:oe,props:{id:Ie,text:Me}});ce.push(De)}),{destroy(){ce.forEach(oe=>{oe&&s4(oe)})}}}Pb(P,{cls:"full",children:(s,_e)=>{w4(s,{top:0,bottom:0,get index(){return k()},set index(ce){k(ce)},get offset(){return N()},set offset(ce){N(ce)},get progress(){return $()},set progress(ce){$(ce)},$$slots:{background:(ce,oe)=>{var Ie=DE(),Me=On(Ie);BS(Me,{style:"mapbox://styles/agwaterdesk/cm0fohozg00kr01qrc7pthcln",mapId:"wetlands",get controller(){return St(Y)}}),_n(ce,Ie)},foreground:(ce,oe)=>{var Ie=LE();pf(Ie,21,()=>M.content.slides,ff,(Me,De)=>{PE(Me,{get slide(){return St(De)},hydrateInlineLegends:se})}),_n(ce,Ie)}}})},$$slots:{default:!0}}),dl()}var OE=ur("<p> </p>"),FE=ur('<main class="px-4 lg:px-20 pt-8 svelte-hrbhdh"><h1 class="svelte-hrbhdh">TKTK</h1> <!></main>');function BE(P,M){hl(M,!0);let k,N,$,Y=am(Cs(typeof window<"u"?window.innerHeight:0));var se=vc(),s=yc(se);{var _e=ce=>{var oe=FE(),Ie=ul(On(oe),2);pf(Ie,17,()=>x4.content,ff,(Me,De)=>{var Ve=vc(),We=yc(Ve);{var st=gt=>{var At=vc(),ot=yc(At);pf(ot,17,()=>St(De).value.split(`
`),ff,(zt,Rt)=>{Pb(zt,{cls:"content",children:(vt,Nt)=>{var Jt=OE(),It=On(Jt);as(()=>vm(It,St(Rt))),_n(vt,Jt)},$$slots:{default:!0}})}),_n(gt,At)},ct=gt=>{var At=vc(),ot=yc(At);{var zt=Rt=>{kE(Rt,{get content(){return St(De)},index:k,offset:N,progress:$})};os(ot,Rt=>{St(De).type=="scrolly"&&Rt(zt)},!0)}_n(gt,At)};os(We,gt=>{St(De).type=="text"?gt(st):gt(ct,!1)})}_n(Me,Ve)}),as(()=>d4(oe,"--viewport-height",`${St(Y)??""}px`)),_n(ce,oe)};os(s,ce=>{St(Y)&&ce(_e)})}Ib("innerHeight",ce=>Xi(Y,Cs(ce))),_n(P,se),dl()}document.getElementById("proj-container").innerHTML="";Tb(BE,{target:document.getElementById("proj-container")});
